'use client';
import { useState, useEffect, useCallback } from 'react';
import { supabase } from '@/lib/supabase';

const T={fr:{login:'Connexion',logout:'D√©connexion',register:'Cr√©er un compte',email:'Email',password:'Mot de passe',confirmPassword:'Confirmer',noAccount:"Pas de compte?",dashboard:'Tableau de Bord',requests:'Demandes',rmaTracking:'Suivi RMA',clients:'Clients',equipment:'√âquipements',parts:'Pi√®ces',contracts:'Contrats',settings:'Param√®tres',newRequest:'Nouvelle Demande',myRequests:'Mes Demandes',myEquipment:'Mes √âquipements',submitted:'Soumise',quoted:'Devis',approved:'Approuv√©',received:'Re√ßu',inProgress:'En cours',completed:'Termin√©',shipped:'Exp√©di√©',rejected:'Refus√©',serialNumber:'N¬∞ S√©rie',model:'Mod√®le',type:'Type',location:'Emplacement',company:'Soci√©t√©',contact:'Contact',phone:'T√©l√©phone',address:'Adresse',city:'Ville',postalCode:'Code Postal',particle_counter:'Compteur',biocollector:'Biocollecteur',calibration:'√âtalonnage',repair:'R√©paration',diagnostic:'Diagnostic',calibration_repair:'√âtal + R√©paration',save:'Enregistrer',cancel:'Annuler',submit:'Soumettre',close:'Fermer',edit:'Modifier',delete:'Supprimer',search:'Rechercher...',add:'Ajouter',createQuote:'Cr√©er Devis',sendQuote:'Envoyer',subtotal:'Sous-total HT',vat:'TVA (20%)',total:'Total TTC',quantity:'Qt√©',markReceived:'Marquer Re√ßu',startWork:'D√©marrer',markComplete:'Terminer',shipDevice:'Exp√©dier',underContract:'Sous Contrat',applyContract:'Appliquer Contrat',contractPrice:'Prix Contrat',tokensRemaining:'Tokens',urgency:'Urgence',normal:'Normal',urgent:'Urgent',critical:'Critique',loading:'Chargement...',saving:'Enregistrement...',saved:'Enregistr√©!',newRequests:'Nouvelles',pendingQuotes:'Devis Attente',activeRmas:'RMAs Actifs',completedMonth:'Termin√©s',totalClients:'Clients',totalDevices:'Appareils',devices:'Appareils',all:'Tous',welcome:'Bienvenue',year:'Ann√©e',price:'Prix',status:'Statut',actions:'Actions',client:'Client',service:'Service',rmaNumber:'N¬∞ RMA',requestNumber:'N¬∞ Demande',acceptTerms:"J'accepte les CGU",acceptEmails:"Notifications email",readTerms:"Lire CGU",description:'Description',addLine:'Ajouter Ligne',internalNotes:'Notes',selectDevices:'S√©lectionner',problemDescription:'Description',shippingAddress:'Adresse retour',addDevice:'Ajouter',contractDevices:'Appareils Contrat',active:'Actif'},en:{login:'Login',logout:'Logout',register:'Register',email:'Email',password:'Password',confirmPassword:'Confirm',noAccount:"No account?",dashboard:'Dashboard',requests:'Requests',rmaTracking:'RMA Tracking',clients:'Clients',equipment:'Equipment',parts:'Parts',contracts:'Contracts',settings:'Settings',newRequest:'New Request',myRequests:'My Requests',myEquipment:'My Equipment',submitted:'Submitted',quoted:'Quoted',approved:'Approved',received:'Received',inProgress:'In Progress',completed:'Completed',shipped:'Shipped',rejected:'Rejected',serialNumber:'Serial #',model:'Model',type:'Type',location:'Location',company:'Company',contact:'Contact',phone:'Phone',address:'Address',city:'City',postalCode:'Postal Code',particle_counter:'Counter',biocollector:'Biocollector',calibration:'Calibration',repair:'Repair',diagnostic:'Diagnostic',calibration_repair:'Cal + Repair',save:'Save',cancel:'Cancel',submit:'Submit',close:'Close',edit:'Edit',delete:'Delete',search:'Search...',add:'Add',createQuote:'Create Quote',sendQuote:'Send',subtotal:'Subtotal',vat:'VAT (20%)',total:'Total',quantity:'Qty',markReceived:'Received',startWork:'Start',markComplete:'Complete',shipDevice:'Ship',underContract:'Contract',applyContract:'Apply Contract',contractPrice:'Contract Price',tokensRemaining:'Tokens',urgency:'Urgency',normal:'Normal',urgent:'Urgent',critical:'Critical',loading:'Loading...',saving:'Saving...',saved:'Saved!',newRequests:'New',pendingQuotes:'Pending',activeRmas:'Active',completedMonth:'Completed',totalClients:'Clients',totalDevices:'Devices',devices:'Devices',all:'All',welcome:'Welcome',year:'Year',price:'Price',status:'Status',actions:'Actions',client:'Client',service:'Service',rmaNumber:'RMA #',requestNumber:'Request #',acceptTerms:"Accept Terms",acceptEmails:"Email notifications",readTerms:"Read Terms",description:'Description',addLine:'Add Line',internalNotes:'Notes',selectDevices:'Select devices',problemDescription:'Problem',shippingAddress:'Return address',addDevice:'Add Device',contractDevices:'Contract Devices',active:'Active'}};
const ST={submitted:{bg:'bg-blue-50',text:'text-blue-700',dot:'bg-blue-500',label:'submitted'},quoted:{bg:'bg-amber-50',text:'text-amber-700',dot:'bg-amber-500',label:'quoted'},approved:{bg:'bg-green-50',text:'text-green-700',dot:'bg-green-500',label:'approved'},received:{bg:'bg-purple-50',text:'text-purple-700',dot:'bg-purple-500',label:'received'},in_progress:{bg:'bg-cyan-50',text:'text-cyan-700',dot:'bg-cyan-500',label:'inProgress'},completed:{bg:'bg-teal-50',text:'text-teal-700',dot:'bg-teal-500',label:'completed'},shipped:{bg:'bg-slate-50',text:'text-slate-700',dot:'bg-slate-500',label:'shipped'},rejected:{bg:'bg-red-50',text:'text-red-700',dot:'bg-red-500',label:'rejected'}};
const Badge=({status,t})=>{const c=ST[status]||ST.submitted;return <span className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${c.bg} ${c.text}`}><span className={`w-1.5 h-1.5 rounded-full ${c.dot}`}/>{t(c.label)}</span>};

export default function App(){
const[user,setUser]=useState(null);const[profile,setProfile]=useState(null);const[loading,setLoading]=useState(true);const[lang,setLang]=useState('fr');const[page,setPage]=useState('home');const[toast,setToast]=useState(null);
const[equipment,setEquipment]=useState([]);const[requests,setRequests]=useState([]);const[companies,setCompanies]=useState([]);const[addresses,setAddresses]=useState([]);const[parts,setParts]=useState([]);const[contracts,setContracts]=useState([]);
const[modal,setModal]=useState(null);const[quoteModal,setQuoteModal]=useState(null);
const t=k=>T[lang]?.[k]||k;const notify=(m,ty='success')=>{setToast({m,ty});setTimeout(()=>setToast(null),3000)};const isAdmin=profile?.role==='admin'||profile?.role==='technician';
useEffect(()=>{checkAuth()},[]);
const checkAuth=async()=>{try{const{data:{session}}=await supabase.auth.getSession();if(session?.user){setUser(session.user);const{data:p}=await supabase.from('profiles').select('*,companies(*)').eq('id',session.user.id).single();if(p){setProfile(p);setPage('dashboard');await loadData(p)}}}catch(e){console.error(e)}setLoading(false)};
const loadData=async(p)=>{if(!p)return;const{data:pts}=await supabase.from('parts').select('*').eq('is_active',true).order('name');setParts(pts||[]);if(p.role==='admin'||p.role==='technician'){const[r,c,e,ct]=await Promise.all([supabase.from('service_requests').select('*,companies(name),request_devices(*),quote_line_items(*)').order('created_at',{ascending:false}),supabase.from('companies').select('*').order('name'),supabase.from('equipment').select('*,companies(name)').order('serial_number'),supabase.from('contracts').select('*,companies(name),contract_devices(*)').order('year',{ascending:false})]);setRequests(r.data||[]);setCompanies(c.data||[]);setEquipment(e.data||[]);setContracts(ct.data||[])}else if(p.company_id){const[e,r,a]=await Promise.all([supabase.from('equipment').select('*').eq('company_id',p.company_id),supabase.from('service_requests').select('*,request_devices(*),quote_line_items(*)').eq('company_id',p.company_id).order('created_at',{ascending:false}),supabase.from('shipping_addresses').select('*').eq('company_id',p.company_id)]);setEquipment(e.data||[]);setRequests(r.data||[]);setAddresses(a.data||[])}};
const refresh=()=>loadData(profile);
const login=async(em,pw)=>{const{data:d,error}=await supabase.auth.signInWithPassword({email:em,password:pw});if(error)return error.message;setUser(d.user);const{data:p}=await supabase.from('profiles').select('*,companies(*)').eq('id',d.user.id).single();setProfile(p);setPage('dashboard');await loadData(p);return null};
const register=async(f)=>{const{data:a,error}=await supabase.auth.signUp({email:f.email,password:f.password});if(error)return error.message;const{data:co}=await supabase.from('companies').insert({name:f.companyName,billing_address:f.address,billing_city:f.city,billing_postal_code:f.postalCode,phone:f.phone,email:f.email}).select().single();if(co){await supabase.from('profiles').insert({id:a.user.id,email:f.email,full_name:f.contactName,role:'customer',company_id:co.id,phone:f.phone,terms_accepted_at:f.acceptTerms?new Date().toISOString():null,email_notifications:f.acceptEmails});await supabase.from('shipping_addresses').insert({company_id:co.id,label:'Principal',address_line1:f.address,city:f.city,postal_code:f.postalCode,country:'France',is_default:true})}notify(t('saved'));setPage('login');return null};
const logout=async()=>{await supabase.auth.signOut();setUser(null);setProfile(null);setPage('home');setEquipment([]);setRequests([]);setCompanies([]);setAddresses([]);setContracts([])};
if(loading)return<div className="min-h-screen bg-gray-50 flex items-center justify-center"><div className="w-10 h-10 border-4 border-[#0066b3] border-t-transparent rounded-full animate-spin"/></div>;
return(<div className="min-h-screen bg-gray-50">{toast&&<div className={`fixed top-4 right-4 z-[200] px-4 py-2 rounded-lg shadow-lg text-white font-medium ${toast.ty==='success'?'bg-green-500':'bg-red-500'}`}>{toast.m}</div>}<Header user={user} profile={profile} isAdmin={isAdmin} lang={lang} setLang={setLang} t={t} page={page} setPage={setPage} logout={logout}/><main className="pb-8">{!user?<>{page==='home'&&<Home t={t} setPage={setPage}/>}{page==='login'&&<Login t={t} login={login} setPage={setPage}/>}{page==='register'&&<Register t={t} register={register} setPage={setPage}/>}{page==='terms'&&<Terms t={t} setPage={setPage}/>}</>:isAdmin?<>{page==='dashboard'&&<AdminDash requests={requests} companies={companies} equipment={equipment} t={t} setPage={setPage}/>}{page==='requests'&&<AdminReqs requests={requests} contracts={contracts} t={t} refresh={refresh} notify={notify} setModal={setModal} setQuoteModal={setQuoteModal}/>}{page==='rma'&&<AdminRMA requests={requests} t={t} refresh={refresh} notify={notify} setModal={setModal}/>}{page==='clients'&&<AdminClients companies={companies} equipment={equipment} requests={requests} t={t}/>}{page==='equipment'&&<AdminEquip equipment={equipment} t={t}/>}{page==='parts'&&<AdminParts parts={parts} t={t} refresh={refresh} notify={notify}/>}{page==='contracts'&&<AdminContracts contracts={contracts} companies={companies} t={t} refresh={refresh} notify={notify}/>}</>:<>{page==='dashboard'&&<CustDash profile={profile} equipment={equipment} requests={requests} t={t} setPage={setPage}/>}{page==='equipment'&&<CustEquip equipment={equipment} t={t} profile={profile} refresh={refresh} notify={notify}/>}{page==='requests'&&<CustReqs requests={requests} t={t} setPage={setPage} setModal={setModal}/>}{page==='new-request'&&<NewReq equipment={equipment} addresses={addresses} t={t} profile={profile} refresh={refresh} notify={notify} setPage={setPage}/>}{page==='settings'&&<Settings profile={profile} addresses={addresses} t={t} refresh={refresh} notify={notify}/>}</>}</main>{modal&&<ReqModal req={modal} contracts={contracts} parts={parts} isAdmin={isAdmin} t={t} refresh={refresh} notify={notify} onClose={()=>setModal(null)}/>}{quoteModal&&<QuoteModal req={quoteModal} parts={parts} t={t} refresh={refresh} notify={notify} onClose={()=>setQuoteModal(null)}/>}<footer className="bg-[#1e3a5f] text-white py-6"><div className="max-w-7xl mx-auto px-6 text-center"><div className="font-bold">LIGHTHOUSE FRANCE</div><p className="text-white/60 text-sm mt-1">16 Rue Paul S√©journe, 94000 Cr√©teil ‚Ä¢ France@golighthouse.com</p></div></footer></div>)}

function Header({user,profile,isAdmin,lang,setLang,t,page,setPage,logout}){const an=[{id:'dashboard',l:'dashboard'},{id:'requests',l:'requests'},{id:'rma',l:'rmaTracking'},{id:'clients',l:'clients'},{id:'equipment',l:'equipment'},{id:'contracts',l:'contracts'},{id:'parts',l:'parts'}];const cn=[{id:'dashboard',l:'dashboard'},{id:'new-request',l:'newRequest'},{id:'requests',l:'myRequests'},{id:'equipment',l:'myEquipment'},{id:'settings',l:'settings'}];const nav=user?(isAdmin?an:cn):[];return<header className="bg-white border-b border-gray-200 sticky top-0 z-50"><div className="max-w-7xl mx-auto px-4 sm:px-6"><div className="flex justify-between items-center h-14"><div className="flex items-center gap-2 cursor-pointer" onClick={()=>setPage(user?'dashboard':'home')}><div className="w-9 h-9 bg-[#1e3a5f] rounded flex items-center justify-center"><svg viewBox="0 0 24 24" className="w-5 h-5 text-white" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg></div><div className="hidden sm:block"><div className="font-bold text-[#1e3a5f] text-sm leading-tight">LIGHTHOUSE</div><div className="text-[#0066b3] text-[10px] font-semibold tracking-wider">FRANCE</div></div></div><div className="flex items-center gap-2"><div className="flex border border-gray-300 rounded overflow-hidden"><button onClick={()=>setLang('fr')} className={`px-2 py-1 text-xs font-bold ${lang==='fr'?'bg-[#1e3a5f] text-white':'text-gray-600'}`}>FR</button><button onClick={()=>setLang('en')} className={`px-2 py-1 text-xs font-bold ${lang==='en'?'bg-[#1e3a5f] text-white':'text-gray-600'}`}>EN</button></div>{user?<div className="flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-[#1e3a5f] text-white flex items-center justify-center font-bold text-xs">{profile?.full_name?.charAt(0)||'U'}</div><button onClick={logout} className="text-gray-500 text-sm hidden sm:block">{t('logout')}</button></div>:<button onClick={()=>setPage('login')} className="px-3 py-1.5 bg-[#0066b3] text-white rounded text-sm font-medium">{t('login')}</button>}</div></div>{user&&<nav className="flex gap-1 pb-2 overflow-x-auto">{nav.map(i=><button key={i.id} onClick={()=>setPage(i.id)} className={`px-3 py-1.5 rounded text-sm font-medium whitespace-nowrap ${page===i.id?'bg-[#0066b3] text-white':'text-gray-600 hover:bg-gray-100'}`}>{t(i.l)}</button>)}</nav>}</div></header>}

function Home({t,setPage}){return<div className="bg-white"><section className="bg-gradient-to-br from-[#1e3a5f] to-[#0066b3] text-white py-16 px-6"><div className="max-w-3xl mx-auto text-center"><h1 className="text-3xl md:text-4xl font-bold mb-4">Service & Calibration Portal</h1><p className="text-lg text-white/80 mb-8">G√©rez vos demandes de calibration et r√©paration pour vos √©quipements Lighthouse</p><div className="flex gap-3 justify-center flex-wrap"><button onClick={()=>setPage('login')} className="px-6 py-2.5 bg-white text-[#1e3a5f] rounded-lg font-bold">{t('login')} ‚Üí</button><button onClick={()=>setPage('register')} className="px-6 py-2.5 border-2 border-white text-white rounded-lg font-bold">{t('register')}</button></div></div></section></div>}

function Login({t,login,setPage}){const[em,setEm]=useState('');const[pw,setPw]=useState('');const[err,setErr]=useState('');const[ld,setLd]=useState(false);const sub=async e=>{e.preventDefault();setLd(true);setErr('');const r=await login(em,pw);if(r)setErr(r);setLd(false)};return<div className="min-h-[70vh] flex items-center justify-center px-4 py-8"><div className="w-full max-w-sm bg-white rounded-xl shadow-lg overflow-hidden"><div className="bg-[#1e3a5f] px-6 py-6 text-center"><h1 className="text-xl font-bold text-white">LIGHTHOUSE FRANCE</h1></div><form onSubmit={sub} className="p-5 space-y-4"><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('email')}</label><input type="email" value={em} onChange={e=>setEm(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0066b3] outline-none" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('password')}</label><input type="password" value={pw} onChange={e=>setPw(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0066b3] outline-none" required/></div>{err&&<div className="p-2 bg-red-50 border border-red-200 rounded text-red-700 text-sm">{err}</div>}<button type="submit" disabled={ld} className="w-full py-2.5 bg-[#0066b3] text-white rounded-lg font-semibold disabled:opacity-50">{ld?t('loading'):t('login')}</button></form><div className="px-5 pb-5 text-center"><p className="text-gray-600 text-sm">{t('noAccount')} <button onClick={()=>setPage('register')} className="text-[#0066b3] font-semibold">{t('register')}</button></p></div></div></div>}

function Register({t,register,setPage}){const[f,setF]=useState({email:'',password:'',confirmPassword:'',companyName:'',contactName:'',phone:'',address:'',city:'',postalCode:'',acceptTerms:false,acceptEmails:true});const[err,setErr]=useState('');const[ld,setLd]=useState(false);const u=(k,v)=>setF(p=>({...p,[k]:v}));const sub=async e=>{e.preventDefault();if(f.password!==f.confirmPassword){setErr('Passwords do not match');return}if(!f.acceptTerms){setErr('Must accept terms');return}setLd(true);setErr('');const r=await register(f);if(r)setErr(r);setLd(false)};return<div className="py-8 px-4"><div className="max-w-xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden"><div className="bg-[#1e3a5f] px-6 py-4"><h1 className="text-xl font-bold text-white">{t('register')}</h1></div><form onSubmit={sub} className="p-5 space-y-3"><div className="grid md:grid-cols-2 gap-3"><div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">{t('company')} *</label><input type="text" value={f.companyName} onChange={e=>u('companyName',e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('contact')} *</label><input type="text" value={f.contactName} onChange={e=>u('contactName',e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('phone')}</label><input type="tel" value={f.phone} onChange={e=>u('phone',e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg"/></div><div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">{t('address')} *</label><input type="text" value={f.address} onChange={e=>u('address',e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('city')} *</label><input type="text" value={f.city} onChange={e=>u('city',e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('postalCode')} *</label><input type="text" value={f.postalCode} onChange={e=>u('postalCode',e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">{t('email')} *</label><input type="email" value={f.email} onChange={e=>u('email',e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('password')} *</label><input type="password" value={f.password} onChange={e=>u('password',e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required minLength={6}/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('confirmPassword')} *</label><input type="password" value={f.confirmPassword} onChange={e=>u('confirmPassword',e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div></div><div className="space-y-2 pt-2"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={f.acceptTerms} onChange={e=>u('acceptTerms',e.target.checked)} className="w-4 h-4"/><span className="text-sm">{t('acceptTerms')} * <button type="button" onClick={()=>setPage('terms')} className="text-[#0066b3] underline">{t('readTerms')}</button></span></label><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={f.acceptEmails} onChange={e=>u('acceptEmails',e.target.checked)} className="w-4 h-4"/><span className="text-sm">{t('acceptEmails')}</span></label></div>{err&&<div className="p-2 bg-red-50 border border-red-200 rounded text-red-700 text-sm">{err}</div>}<div className="flex gap-3 pt-2"><button type="button" onClick={()=>setPage('login')} className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg">{t('cancel')}</button><button type="submit" disabled={ld} className="flex-1 py-2 bg-[#0066b3] text-white rounded-lg font-semibold disabled:opacity-50">{ld?t('loading'):t('register')}</button></div></form></div></div>}

function Terms({t,setPage}){return<div className="py-8 px-4"><div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden"><div className="bg-[#1e3a5f] px-6 py-4 flex justify-between items-center"><h1 className="text-lg font-bold text-white">Conditions G√©n√©rales</h1><button onClick={()=>setPage('register')} className="text-white/70 hover:text-white text-xl">√ó</button></div><div className="p-5 text-sm text-gray-700 space-y-3 max-h-[60vh] overflow-y-auto"><p><strong>1. Objet</strong> - CGU du portail Lighthouse France.</p><p><strong>2. Services</strong> - Demandes de calibration/r√©paration, devis, suivi.</p><p><strong>3. Signature √©lectronique</strong> - Valeur juridique selon Code Civil art. 1367 et eIDAS.</p><p><strong>4. Donn√©es</strong> - RGPD, conservation 10 ans.</p><p><strong>5. Contact</strong> - 16 Rue Paul S√©journe, 94000 Cr√©teil - France@golighthouse.com</p></div><div className="px-5 pb-5"><button onClick={()=>setPage('register')} className="w-full py-2 bg-[#0066b3] text-white rounded-lg font-semibold">Retour</button></div></div></div>}

function AdminDash({requests,companies,equipment,t,setPage}){const st=[{l:t('newRequests'),v:requests.filter(r=>r.status==='submitted').length,c:'bg-blue-500',p:'requests'},{l:t('pendingQuotes'),v:requests.filter(r=>r.status==='quoted').length,c:'bg-amber-500',p:'requests'},{l:t('activeRmas'),v:requests.filter(r=>['approved','received','in_progress'].includes(r.status)).length,c:'bg-purple-500',p:'rma'},{l:t('completedMonth'),v:requests.filter(r=>r.status==='completed'||r.status==='shipped').length,c:'bg-green-500'},{l:t('totalClients'),v:companies.length,c:'bg-slate-500',p:'clients'},{l:t('totalDevices'),v:equipment.length,c:'bg-cyan-500',p:'equipment'}];return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><h1 className="text-xl font-bold text-[#1e3a5f] mb-4">{t('dashboard')}</h1><div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">{st.map((s,i)=><button key={i} onClick={()=>s.p&&setPage(s.p)} className="bg-white rounded-xl p-3 shadow-sm border border-gray-100 text-left hover:shadow-md"><div className={`w-2.5 h-2.5 rounded-full ${s.c} mb-1.5`}/><div className="text-xl font-bold text-gray-900">{s.v}</div><div className="text-xs text-gray-500">{s.l}</div></button>)}</div><div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"><div className="px-4 py-3 border-b border-gray-100 flex justify-between items-center"><h2 className="font-bold text-[#1e3a5f]">Demandes R√©centes</h2><button onClick={()=>setPage('requests')} className="text-[#0066b3] text-sm">Voir tout ‚Üí</button></div><div className="overflow-x-auto"><table className="w-full"><thead className="bg-gray-50"><tr><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">N¬∞</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('client')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('service')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('status')}</th></tr></thead><tbody className="divide-y divide-gray-100">{requests.slice(0,5).map(r=><tr key={r.id} className="hover:bg-gray-50"><td className="px-3 py-2 text-sm font-mono text-[#0066b3]">{r.request_number||'‚Äî'}</td><td className="px-3 py-2 text-sm">{r.companies?.name||'‚Äî'}</td><td className="px-3 py-2 text-sm text-gray-600 capitalize">{t(r.requested_service)}</td><td className="px-3 py-2"><Badge status={r.status} t={t}/></td></tr>)}</tbody></table></div></div></div>}

function AdminReqs({requests,contracts,t,refresh,notify,setModal,setQuoteModal}){const[flt,setFlt]=useState('all');const[src,setSrc]=useState('');const flts=['all','submitted','quoted','approved','rejected'];const fltd=requests.filter(r=>{if(flt!=='all'&&r.status!==flt)return false;if(src){const s=src.toLowerCase();return r.request_number?.toLowerCase().includes(s)||r.companies?.name?.toLowerCase().includes(s)}return true});const getContract=(sn,svc)=>{if(!svc?.includes('calibration')&&svc!=='calibration_repair')return null;const yr=new Date().getFullYear();for(const c of contracts){if(c.year!==yr||c.status!=='active')continue;const d=c.contract_devices?.find(x=>x.serial_number===sn);if(d&&d.calibrations_used<d.calibrations_allowed)return{contract:c,device:d,avail:d.calibrations_allowed-d.calibrations_used}}return null};const applyContract=async r=>{const dv=r.request_devices?.[0];if(!dv)return;const ci=getContract(dv.serial_number,r.requested_service);if(!ci){notify('No contract','error');return}const{data:st}=await supabase.from('system_settings').select('value').eq('key','rma_counter').single();const cnt=st?.value?.counter||340;const rma=`FR-${String(cnt+1).padStart(5,'0')}`;await supabase.from('service_requests').update({status:'approved',rma_number:rma,contract_id:ci.contract.id,contract_applied:true,approval_method:'contract',approved_at:new Date().toISOString(),quote_subtotal:ci.device.contract_price,quote_tax:ci.device.contract_price*0.2,quote_total:ci.device.contract_price*1.2}).eq('id',r.id);await supabase.from('system_settings').update({value:{prefix:'FR',counter:cnt+1}}).eq('key','rma_counter');await supabase.from('contract_devices').update({calibrations_used:ci.device.calibrations_used+1}).eq('id',ci.device.id);notify(`Contrat appliqu√© - RMA ${rma}`);refresh()};return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4"><h1 className="text-xl font-bold text-[#1e3a5f]">{t('requests')}</h1><input type="text" placeholder={t('search')} value={src} onChange={e=>setSrc(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-lg w-full sm:w-56 text-sm"/></div><div className="flex gap-2 mb-4 overflow-x-auto pb-1">{flts.map(f=><button key={f} onClick={()=>setFlt(f)} className={`px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap ${flt===f?'bg-[#0066b3] text-white':'bg-white text-gray-600 border border-gray-200'}`}>{t(f)} ({f==='all'?requests.length:requests.filter(r=>r.status===f).length})</button>)}</div><div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"><div className="overflow-x-auto"><table className="w-full"><thead className="bg-gray-50"><tr><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">N¬∞</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('client')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('devices')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('service')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('status')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('actions')}</th></tr></thead><tbody className="divide-y divide-gray-100">{fltd.map(r=>{const dc=r.request_devices?.length||0;const fd=r.request_devices?.[0];const ci=fd?getContract(fd.serial_number,r.requested_service):null;return<tr key={r.id} className="hover:bg-gray-50"><td className="px-3 py-2"><button onClick={()=>setModal(r)} className="font-mono text-[#0066b3] text-sm hover:underline">{r.request_number||'‚Äî'}</button>{r.rma_number&&<div className="text-xs text-gray-500">RMA:{r.rma_number}</div>}</td><td className="px-3 py-2 text-sm">{r.companies?.name||'‚Äî'}</td><td className="px-3 py-2 text-sm">{dc} {t('devices')}{ci&&<span className="ml-1 px-1.5 py-0.5 bg-green-100 text-green-700 text-xs rounded">{t('underContract')}</span>}</td><td className="px-3 py-2 text-sm capitalize">{t(r.requested_service)}</td><td className="px-3 py-2"><Badge status={r.status} t={t}/></td><td className="px-3 py-2"><div className="flex gap-1">{r.status==='submitted'&&<>{ci&&(r.requested_service==='calibration'||r.requested_service==='calibration_repair')&&<button onClick={()=>applyContract(r)} className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">{t('applyContract')}</button>}<button onClick={()=>setQuoteModal(r)} className="px-2 py-1 bg-[#0066b3] text-white rounded text-xs font-medium">{t('createQuote')}</button></>}<button onClick={()=>setModal(r)} className="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">{t('edit')}</button></div></td></tr>})}</tbody></table></div>{fltd.length===0&&<div className="p-8 text-center text-gray-500">Aucune demande</div>}</div></div>}

function AdminRMA({requests,t,refresh,notify,setModal}){const[flt,setFlt]=useState('all');const rmas=requests.filter(r=>r.rma_number||['approved','received','in_progress','completed','shipped'].includes(r.status));const flts=['all','approved','received','in_progress','completed','shipped'];const fltd=flt==='all'?rmas:rmas.filter(r=>r.status===flt);const upd=async(id,ns,ts)=>{const u={status:ns};if(ts)u[ts]=new Date().toISOString();await supabase.from('service_requests').update(u).eq('id',id);notify(t('saved'));refresh()};return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><h1 className="text-xl font-bold text-[#1e3a5f] mb-4">{t('rmaTracking')}</h1><div className="flex gap-2 mb-4 overflow-x-auto pb-1">{flts.map(f=><button key={f} onClick={()=>setFlt(f)} className={`px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap ${flt===f?'bg-[#0066b3] text-white':'bg-white text-gray-600 border border-gray-200'}`}>{t(f==='all'?'all':ST[f]?.label||f)} ({f==='all'?rmas.length:rmas.filter(r=>r.status===f).length})</button>)}</div><div className="grid gap-3">{fltd.map(r=>{const c=ST[r.status]||ST.submitted;return<div key={r.id} className="bg-white rounded-xl shadow-sm border border-gray-200 p-4"><div className="flex flex-wrap items-start justify-between gap-3"><div><div className="flex items-center gap-2 mb-1"><button onClick={()=>setModal(r)} className="font-mono text-[#0066b3] font-bold hover:underline">{r.rma_number||'Pending'}</button><Badge status={r.status} t={t}/>{r.contract_applied&&<span className="px-1.5 py-0.5 bg-green-100 text-green-700 text-xs rounded">{t('underContract')}</span>}</div><p className="text-gray-600 text-sm">{r.companies?.name}</p></div><div className="flex gap-2 flex-wrap">{r.status==='approved'&&<button onClick={()=>upd(r.id,'received','received_at')} className="px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium">üì• {t('markReceived')}</button>}{r.status==='received'&&<button onClick={()=>upd(r.id,'in_progress','started_at')} className="px-3 py-1.5 bg-cyan-100 text-cyan-700 rounded-lg text-sm font-medium">üîß {t('startWork')}</button>}{r.status==='in_progress'&&<button onClick={()=>upd(r.id,'completed','completed_at')} className="px-3 py-1.5 bg-teal-100 text-teal-700 rounded-lg text-sm font-medium">‚úÖ {t('markComplete')}</button>}{r.status==='completed'&&<button onClick={()=>upd(r.id,'shipped','shipped_at')} className="px-3 py-1.5 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium">üöö {t('shipDevice')}</button>}</div></div></div>})}{fltd.length===0&&<div className="bg-white rounded-xl p-8 text-center text-gray-500">Aucun RMA</div>}</div></div>}

function AdminClients({companies,equipment,requests,t}){const[src,setSrc]=useState('');const fltd=companies.filter(c=>c.name?.toLowerCase().includes(src.toLowerCase()));return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><div className="flex justify-between items-center mb-4"><h1 className="text-xl font-bold text-[#1e3a5f]">{t('clients')}</h1><input type="text" placeholder={t('search')} value={src} onChange={e=>setSrc(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-lg w-56 text-sm"/></div><div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">{fltd.map(c=>{const ec=equipment.filter(e=>e.company_id===c.id).length;const rc=requests.filter(r=>r.company_id===c.id).length;return<div key={c.id} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100"><h3 className="font-bold text-[#1e3a5f] mb-1">{c.name}</h3><div className="text-sm text-gray-600 space-y-0.5"><p>üìß {c.email||'‚Äî'}</p><p>üìû {c.phone||'‚Äî'}</p><p>üìç {c.billing_city||'‚Äî'}</p></div><div className="flex gap-3 mt-2 pt-2 border-t border-gray-100 text-sm"><span className="text-[#0066b3]">{ec} appareils</span><span className="text-gray-500">{rc} demandes</span></div></div>})}</div></div>}

function AdminEquip({equipment,t}){const[src,setSrc]=useState('');const fltd=equipment.filter(e=>e.serial_number?.toLowerCase().includes(src.toLowerCase())||e.model_name?.toLowerCase().includes(src.toLowerCase())||e.companies?.name?.toLowerCase().includes(src.toLowerCase()));return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><div className="flex justify-between items-center mb-4"><h1 className="text-xl font-bold text-[#1e3a5f]">{t('equipment')}</h1><input type="text" placeholder={t('search')} value={src} onChange={e=>setSrc(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-lg w-56 text-sm"/></div><div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"><div className="overflow-x-auto"><table className="w-full"><thead className="bg-gray-50"><tr><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('serialNumber')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('model')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('type')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('client')}</th></tr></thead><tbody className="divide-y divide-gray-100">{fltd.map(e=><tr key={e.id} className="hover:bg-gray-50"><td className="px-3 py-2 font-mono text-[#0066b3] text-sm">{e.serial_number}</td><td className="px-3 py-2 text-sm">{e.model_name||'‚Äî'}</td><td className="px-3 py-2"><span className={`px-2 py-0.5 rounded text-xs ${e.equipment_type==='biocollector'?'bg-amber-100 text-amber-700':'bg-blue-100 text-blue-700'}`}>{t(e.equipment_type)}</span></td><td className="px-3 py-2 text-sm">{e.companies?.name||'‚Äî'}</td></tr>)}</tbody></table></div></div></div>}

function AdminParts({parts,t,refresh,notify}){const[show,setShow]=useState(false);const[f,setF]=useState({reference:'',name:'',category:'part',price:''});const[sv,setSv]=useState(false);const[src,setSrc]=useState('');const fltd=parts.filter(p=>p.name?.toLowerCase().includes(src.toLowerCase())||p.reference?.toLowerCase().includes(src.toLowerCase()));const add=async e=>{e.preventDefault();setSv(true);await supabase.from('parts').insert({...f,price:parseFloat(f.price)||0,is_active:true});setSv(false);setShow(false);setF({reference:'',name:'',category:'part',price:''});notify(t('saved'));refresh()};const del=async id=>{if(!confirm('Delete?'))return;await supabase.from('parts').delete().eq('id',id);notify(t('saved'));refresh()};return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><div className="flex justify-between items-center mb-4"><h1 className="text-xl font-bold text-[#1e3a5f]">{t('parts')}</h1><div className="flex gap-2"><input type="text" placeholder={t('search')} value={src} onChange={e=>setSrc(e.target.value)} className="px-3 py-2 border border-gray-300 rounded-lg w-56 text-sm"/><button onClick={()=>setShow(true)} className="px-3 py-2 bg-[#0066b3] text-white rounded-lg text-sm font-medium">+ {t('add')}</button></div></div><div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"><table className="w-full"><thead className="bg-gray-50"><tr><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">R√©f</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">D√©signation</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cat.</th><th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">{t('price')}</th><th className="px-3 py-2"></th></tr></thead><tbody className="divide-y divide-gray-100">{fltd.map(p=><tr key={p.id} className="hover:bg-gray-50"><td className="px-3 py-2 font-mono text-sm">{p.reference}</td><td className="px-3 py-2 text-sm">{p.name}</td><td className="px-3 py-2"><span className={`px-1.5 py-0.5 rounded text-xs ${p.category==='calibration'?'bg-blue-100 text-blue-700':p.category==='service'?'bg-green-100 text-green-700':'bg-gray-100 text-gray-700'}`}>{p.category}</span></td><td className="px-3 py-2 text-right font-medium text-sm">{p.price?.toFixed(2)} ‚Ç¨</td><td className="px-3 py-2 text-right"><button onClick={()=>del(p.id)} className="text-red-500 text-xs">{t('delete')}</button></td></tr>)}</tbody></table></div>{show&&<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={()=>setShow(false)}><div className="bg-white rounded-xl w-full max-w-md" onClick={e=>e.stopPropagation()}><div className="px-5 py-3 border-b"><h2 className="font-bold">{t('add')}</h2></div><form onSubmit={add} className="p-5 space-y-3"><div><label className="block text-sm font-medium text-gray-700 mb-1">R√©f√©rence *</label><input type="text" value={f.reference} onChange={e=>setF({...f,reference:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">D√©signation *</label><input type="text" value={f.name} onChange={e=>setF({...f,name:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Cat√©gorie</label><select value={f.category} onChange={e=>setF({...f,category:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="part">Pi√®ce</option><option value="calibration">Calibration</option><option value="service">Service</option><option value="shipping">Transport</option></select></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Prix HT ‚Ç¨ *</label><input type="number" step="0.01" value={f.price} onChange={e=>setF({...f,price:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div className="flex gap-2 pt-2"><button type="button" onClick={()=>setShow(false)} className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg">{t('cancel')}</button><button type="submit" disabled={sv} className="flex-1 py-2 bg-[#0066b3] text-white rounded-lg font-medium disabled:opacity-50">{sv?t('saving'):t('save')}</button></div></form></div></div>}</div>}

function AdminContracts({contracts,companies,t,refresh,notify}){const[show,setShow]=useState(false);const[f,setF]=useState({company_id:'',year:new Date().getFullYear(),start_date:'',end_date:'',notes:''});const[devs,setDevs]=useState([]);const[sv,setSv]=useState(false);const add=async e=>{e.preventDefault();if(devs.length===0){notify('Add devices','error');return}setSv(true);const cn=`CTR-${f.year}-${String(contracts.length+1).padStart(3,'0')}`;const{data:ct}=await supabase.from('contracts').insert({contract_number:cn,company_id:f.company_id,year:f.year,start_date:f.start_date,end_date:f.end_date,notes:f.notes,status:'active'}).select().single();if(ct){for(const d of devs){await supabase.from('contract_devices').insert({contract_id:ct.id,serial_number:d.serial_number,model_name:d.model_name,contract_price:d.contract_price,calibrations_allowed:d.calibrations_allowed,calibrations_used:0})}}setSv(false);setShow(false);setF({company_id:'',year:new Date().getFullYear(),start_date:'',end_date:'',notes:''});setDevs([]);notify(t('saved'));refresh()};const addDev=()=>setDevs([...devs,{serial_number:'',model_name:'',contract_price:0,calibrations_allowed:1}]);const updDev=(i,k,v)=>{const u=[...devs];u[i][k]=v;setDevs(u)};const remDev=i=>setDevs(devs.filter((_,x)=>x!==i));return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><div className="flex justify-between items-center mb-4"><h1 className="text-xl font-bold text-[#1e3a5f]">{t('contracts')}</h1><button onClick={()=>setShow(true)} className="px-3 py-2 bg-[#0066b3] text-white rounded-lg text-sm font-medium">+ Nouveau</button></div><div className="grid gap-3">{contracts.map(c=>{const td=c.contract_devices?.length||0;const ut=c.contract_devices?.reduce((s,d)=>s+(d.calibrations_used||0),0)||0;const tt=c.contract_devices?.reduce((s,d)=>s+(d.calibrations_allowed||0),0)||0;return<div key={c.id} className="bg-white rounded-xl shadow-sm border border-gray-100 p-4"><div className="flex flex-wrap justify-between items-start gap-3"><div><div className="flex items-center gap-2"><span className="font-mono font-bold text-[#0066b3]">{c.contract_number}</span><span className={`px-1.5 py-0.5 rounded text-xs ${c.status==='active'?'bg-green-100 text-green-700':'bg-gray-100 text-gray-700'}`}>{t(c.status)}</span></div><p className="font-medium mt-1">{c.companies?.name}</p><p className="text-sm text-gray-500">{c.year} ‚Ä¢ {td} appareils</p></div><div className="text-right"><div className="text-sm text-gray-500">Utilis√©es</div><div className="text-xl font-bold text-[#1e3a5f]">{ut}/{tt}</div><div className="w-24 h-1.5 bg-gray-200 rounded-full mt-1"><div className="h-full bg-[#0066b3] rounded-full" style={{width:`${tt>0?(ut/tt)*100:0}%`}}/></div></div></div>{c.contract_devices&&c.contract_devices.length>0&&<div className="mt-3 pt-3 border-t border-gray-100"><table className="w-full text-sm"><thead><tr className="text-left text-gray-500 text-xs"><th className="pb-1">{t('serialNumber')}</th><th className="pb-1">{t('model')}</th><th className="pb-1">{t('price')}</th><th className="pb-1">{t('tokensRemaining')}</th></tr></thead><tbody>{c.contract_devices.map(d=><tr key={d.id}><td className="py-1 font-mono">{d.serial_number}</td><td className="py-1">{d.model_name||'‚Äî'}</td><td className="py-1">{d.contract_price?.toFixed(2)} ‚Ç¨</td><td className="py-1"><span className={`px-1.5 py-0.5 rounded text-xs ${d.calibrations_used>=d.calibrations_allowed?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}`}>{d.calibrations_allowed-d.calibrations_used}/{d.calibrations_allowed}</span></td></tr>)}</tbody></table></div>}</div>})}{contracts.length===0&&<div className="bg-white rounded-xl p-8 text-center text-gray-500">Aucun contrat</div>}</div>{show&&<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto" onClick={()=>setShow(false)}><div className="bg-white rounded-xl w-full max-w-xl my-8" onClick={e=>e.stopPropagation()}><div className="px-5 py-3 border-b flex justify-between items-center"><h2 className="font-bold">Nouveau Contrat</h2><button onClick={()=>setShow(false)} className="text-gray-400 hover:text-gray-600">√ó</button></div><form onSubmit={add} className="p-5 space-y-3 max-h-[70vh] overflow-y-auto"><div className="grid md:grid-cols-2 gap-3"><div className="md:col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">{t('client')} *</label><select value={f.company_id} onChange={e=>setF({...f,company_id:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required><option value="">S√©lectionner...</option>{companies.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('year')} *</label><input type="number" value={f.year} onChange={e=>setF({...f,year:parseInt(e.target.value)})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">D√©but *</label><input type="date" value={f.start_date} onChange={e=>setF({...f,start_date:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Fin *</label><input type="date" value={f.end_date} onChange={e=>setF({...f,end_date:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Notes</label><input type="text" value={f.notes} onChange={e=>setF({...f,notes:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg"/></div></div><div className="border-t pt-3"><div className="flex justify-between items-center mb-2"><h3 className="font-medium">{t('contractDevices')}</h3><button type="button" onClick={addDev} className="px-2 py-1 bg-[#0066b3] text-white rounded text-xs">{t('addDevice')}</button></div>{devs.map((d,i)=><div key={i} className="grid grid-cols-12 gap-2 mb-2"><div className="col-span-4"><input type="text" placeholder="N¬∞ S√©rie" value={d.serial_number} onChange={e=>updDev(i,'serial_number',e.target.value)} className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm" required/></div><div className="col-span-3"><input type="text" placeholder="Mod√®le" value={d.model_name} onChange={e=>updDev(i,'model_name',e.target.value)} className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm"/></div><div className="col-span-2"><input type="number" step="0.01" placeholder="Prix" value={d.contract_price} onChange={e=>updDev(i,'contract_price',parseFloat(e.target.value))} className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm" required/></div><div className="col-span-2"><input type="number" placeholder="Cal" value={d.calibrations_allowed} onChange={e=>updDev(i,'calibrations_allowed',parseInt(e.target.value))} className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm" min="1" required/></div><div className="col-span-1"><button type="button" onClick={()=>remDev(i)} className="text-red-500">√ó</button></div></div>)}{devs.length===0&&<p className="text-sm text-gray-500 text-center py-2">Ajoutez des appareils</p>}</div><div className="flex gap-2 pt-3 border-t"><button type="button" onClick={()=>setShow(false)} className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg">{t('cancel')}</button><button type="submit" disabled={sv} className="flex-1 py-2 bg-[#0066b3] text-white rounded-lg font-medium disabled:opacity-50">{sv?t('saving'):t('save')}</button></div></form></div></div>}</div>}

function CustDash({profile,equipment,requests,t,setPage}){const st=[{l:t('totalDevices'),v:equipment.length,c:'bg-blue-500'},{l:'En cours',v:requests.filter(r=>!['shipped','completed','rejected'].includes(r.status)).length,c:'bg-amber-500'},{l:'Termin√©s',v:requests.filter(r=>['shipped','completed'].includes(r.status)).length,c:'bg-green-500'}];return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><div className="flex justify-between items-start mb-4"><div><h1 className="text-xl font-bold text-[#1e3a5f]">{t('welcome')}, {profile?.full_name}!</h1><p className="text-gray-600 text-sm">{profile?.companies?.name}</p></div><button onClick={()=>setPage('new-request')} className="px-4 py-2 bg-[#0066b3] text-white rounded-lg text-sm font-medium">+ {t('newRequest')}</button></div><div className="grid grid-cols-3 gap-3 mb-6">{st.map((s,i)=><div key={i} className="bg-white rounded-xl p-3 shadow-sm border border-gray-100"><div className={`w-2.5 h-2.5 rounded-full ${s.c} mb-1.5`}/><div className="text-xl font-bold">{s.v}</div><div className="text-xs text-gray-500">{s.l}</div></div>)}</div><div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"><div className="px-4 py-3 border-b flex justify-between items-center"><h2 className="font-bold text-[#1e3a5f]">{t('myRequests')}</h2><button onClick={()=>setPage('requests')} className="text-[#0066b3] text-sm">Voir tout ‚Üí</button></div>{requests.length===0?<div className="p-8 text-center text-gray-500">Aucune demande</div>:<div className="overflow-x-auto"><table className="w-full"><thead className="bg-gray-50"><tr><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">N¬∞</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">RMA</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('devices')}</th><th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">{t('status')}</th></tr></thead><tbody className="divide-y divide-gray-100">{requests.slice(0,5).map(r=><tr key={r.id} className="hover:bg-gray-50"><td className="px-3 py-2 text-sm font-mono text-[#0066b3]">{r.request_number||'‚Äî'}</td><td className="px-3 py-2 text-sm font-mono text-green-600">{r.rma_number||'‚Äî'}</td><td className="px-3 py-2 text-sm">{r.request_devices?.length||0}</td><td className="px-3 py-2"><Badge status={r.status} t={t}/></td></tr>)}</tbody></table></div>}</div></div>}

function CustEquip({equipment,t,profile,refresh,notify}){const[show,setShow]=useState(false);const[f,setF]=useState({serial_number:'',model_name:'',equipment_type:'particle_counter',customer_location:''});const[sv,setSv]=useState(false);const add=async e=>{e.preventDefault();setSv(true);await supabase.from('equipment').insert({...f,company_id:profile.company_id,added_by:profile.id});setSv(false);setShow(false);setF({serial_number:'',model_name:'',equipment_type:'particle_counter',customer_location:''});notify(t('saved'));refresh()};return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><div className="flex justify-between items-center mb-4"><h1 className="text-xl font-bold text-[#1e3a5f]">{t('myEquipment')}</h1><button onClick={()=>setShow(true)} className="px-4 py-2 bg-[#0066b3] text-white rounded-lg text-sm font-medium">+ {t('add')}</button></div>{equipment.length===0?<div className="bg-white rounded-xl p-12 text-center"><p className="text-4xl mb-3">‚öôÔ∏è</p><p className="text-gray-500 mb-4">Aucun √©quipement</p><button onClick={()=>setShow(true)} className="px-4 py-2 bg-[#0066b3] text-white rounded-lg text-sm font-medium">{t('add')}</button></div>:<div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">{equipment.map(e=><div key={e.id} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100"><span className={`px-2 py-0.5 rounded text-xs ${e.equipment_type==='biocollector'?'bg-amber-100 text-amber-700':'bg-blue-100 text-blue-700'}`}>{t(e.equipment_type)}</span><h3 className="font-bold mt-2">{e.model_name||'Unknown'}</h3><p className="font-mono text-[#0066b3] text-sm">{e.serial_number}</p>{e.customer_location&&<p className="text-gray-500 text-sm mt-1">üìç {e.customer_location}</p>}</div>)}</div>}{show&&<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={()=>setShow(false)}><div className="bg-white rounded-xl w-full max-w-md" onClick={e=>e.stopPropagation()}><div className="px-5 py-3 border-b"><h2 className="font-bold">{t('add')}</h2></div><form onSubmit={add} className="p-5 space-y-3"><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('serialNumber')} *</label><input type="text" value={f.serial_number} onChange={e=>setF({...f,serial_number:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('model')}</label><input type="text" value={f.model_name} onChange={e=>setF({...f,model_name:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg"/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('type')}</label><select value={f.equipment_type} onChange={e=>setF({...f,equipment_type:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="particle_counter">{t('particleCounter')}</option><option value="biocollector">{t('biocollector')}</option></select></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('location')}</label><input type="text" value={f.customer_location} onChange={e=>setF({...f,customer_location:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg"/></div><div className="flex gap-2 pt-2"><button type="button" onClick={()=>setShow(false)} className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg">{t('cancel')}</button><button type="submit" disabled={sv} className="flex-1 py-2 bg-[#0066b3] text-white rounded-lg font-medium disabled:opacity-50">{sv?t('saving'):t('save')}</button></div></form></div></div>}</div>}

function CustReqs({requests,t,setPage,setModal}){return<div className="max-w-7xl mx-auto px-4 sm:px-6 py-6"><div className="flex justify-between items-center mb-4"><h1 className="text-xl font-bold text-[#1e3a5f]">{t('myRequests')}</h1><button onClick={()=>setPage('new-request')} className="px-4 py-2 bg-[#0066b3] text-white rounded-lg text-sm font-medium">+ {t('newRequest')}</button></div>{requests.length===0?<div className="bg-white rounded-xl p-12 text-center"><p className="text-4xl mb-3">üìã</p><p className="text-gray-500 mb-4">Aucune demande</p><button onClick={()=>setPage('new-request')} className="px-4 py-2 bg-[#0066b3] text-white rounded-lg text-sm font-medium">{t('newRequest')}</button></div>:<div className="space-y-3">{requests.map(r=>{const c=ST[r.status]||ST.submitted;return<div key={r.id} className="bg-white rounded-xl p-4 shadow-sm border border-gray-200 cursor-pointer hover:shadow-md" onClick={()=>setModal(r)}><div className="flex flex-wrap items-center justify-between gap-2"><div className="flex items-center gap-2"><span className="font-mono text-[#0066b3] font-bold">{r.request_number||'‚Äî'}</span>{r.rma_number&&<span className="font-mono text-green-600 text-sm">RMA: {r.rma_number}</span>}<Badge status={r.status} t={t}/></div>{r.quote_total&&<div className="font-bold text-lg text-[#1e3a5f]">{r.quote_total?.toFixed(2)} ‚Ç¨</div>}</div><div className="text-sm text-gray-600 mt-2">{r.request_devices?.length||0} {t('devices')} ‚Ä¢ {t(r.requested_service)}</div></div>})}</div>}</div>}

function Settings({profile,addresses,t,refresh,notify}){const[show,setShow]=useState(false);const[f,setF]=useState({label:'',address_line1:'',city:'',postal_code:'',is_default:false});const[sv,setSv]=useState(false);const add=async e=>{e.preventDefault();setSv(true);if(f.is_default)await supabase.from('shipping_addresses').update({is_default:false}).eq('company_id',profile.company_id);await supabase.from('shipping_addresses').insert({...f,company_id:profile.company_id,country:'France'});setSv(false);setShow(false);setF({label:'',address_line1:'',city:'',postal_code:'',is_default:false});notify(t('saved'));refresh()};const del=async id=>{await supabase.from('shipping_addresses').delete().eq('id',id);notify(t('saved'));refresh()};return<div className="max-w-3xl mx-auto px-4 py-6 space-y-4"><h1 className="text-xl font-bold text-[#1e3a5f]">{t('settings')}</h1><div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100"><h2 className="font-bold text-[#1e3a5f] mb-3">Compte</h2><div className="grid md:grid-cols-2 gap-3 text-sm"><div><span className="text-gray-500">{t('contact')}:</span> {profile?.full_name}</div><div><span className="text-gray-500">{t('email')}:</span> {profile?.email}</div><div><span className="text-gray-500">{t('company')}:</span> {profile?.companies?.name}</div></div></div><div className="bg-white rounded-xl shadow-sm border border-gray-100"><div className="px-4 py-3 border-b flex justify-between items-center"><h2 className="font-bold text-[#1e3a5f]">Adresses</h2><button onClick={()=>setShow(true)} className="px-3 py-1 bg-[#0066b3] text-white rounded text-sm">+ {t('add')}</button></div><div className="p-4 space-y-3">{addresses.length===0?<p className="text-center text-gray-500 py-4">Aucune adresse</p>:addresses.map(a=><div key={a.id} className={`p-3 rounded-lg border ${a.is_default?'border-green-300 bg-green-50':'border-gray-200'}`}><div className="flex justify-between items-start"><div><h3 className="font-medium">{a.label} {a.is_default&&<span className="text-green-600 text-xs">D√©faut</span>}</h3><p className="text-sm text-gray-600">{a.address_line1}</p><p className="text-sm text-gray-600">{a.postal_code} {a.city}</p></div><button onClick={()=>del(a.id)} className="text-red-500 text-sm">{t('delete')}</button></div></div>)}</div></div>{show&&<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={()=>setShow(false)}><div className="bg-white rounded-xl w-full max-w-md" onClick={e=>e.stopPropagation()}><div className="px-5 py-3 border-b"><h2 className="font-bold">Ajouter Adresse</h2></div><form onSubmit={add} className="p-5 space-y-3"><div><label className="block text-sm font-medium text-gray-700 mb-1">Nom *</label><input type="text" value={f.label} onChange={e=>setF({...f,label:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('address')} *</label><input type="text" value={f.address_line1} onChange={e=>setF({...f,address_line1:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div className="grid grid-cols-2 gap-3"><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('city')} *</label><input type="text" value={f.city} onChange={e=>setF({...f,city:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('postalCode')} *</label><input type="text" value={f.postal_code} onChange={e=>setF({...f,postal_code:e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" required/></div></div><label className="flex items-center gap-2"><input type="checkbox" checked={f.is_default} onChange={e=>setF({...f,is_default:e.target.checked})} className="w-4 h-4"/><span className="text-sm">Par d√©faut</span></label><div className="flex gap-2 pt-2"><button type="button" onClick={()=>setShow(false)} className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg">{t('cancel')}</button><button type="submit" disabled={sv} className="flex-1 py-2 bg-[#0066b3] text-white rounded-lg font-medium disabled:opacity-50">{sv?t('saving'):t('save')}</button></div></form></div></div>}</div>}

function ReqModal({req,contracts,parts,isAdmin,t,refresh,notify,onClose}){const[notes,setNotes]=useState(req.internal_notes||'');const[sv,setSv]=useState(false);const saveNotes=async()=>{setSv(true);await supabase.from('service_requests').update({internal_notes:notes}).eq('id',req.id);setSv(false);notify(t('saved'));refresh()};const approveRma=async()=>{const{data:st}=await supabase.from('system_settings').select('value').eq('key','rma_counter').single();const cnt=st?.value?.counter||340;const rma=`FR-${String(cnt+1).padStart(5,'0')}`;await supabase.from('service_requests').update({status:'approved',rma_number:rma,approval_method:'manual_override',approved_at:new Date().toISOString()}).eq('id',req.id);await supabase.from('system_settings').update({value:{prefix:'FR',counter:cnt+1}}).eq('key','rma_counter');notify(`RMA ${rma} cr√©√©`);refresh();onClose()};return<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto" onClick={onClose}><div className="bg-white rounded-xl w-full max-w-2xl my-8 max-h-[90vh] overflow-y-auto" onClick={e=>e.stopPropagation()}><div className="px-5 py-4 border-b flex justify-between items-center sticky top-0 bg-white"><div><h2 className="font-bold text-lg">{req.request_number}</h2>{req.rma_number&&<span className="text-green-600 font-mono">RMA: {req.rma_number}</span>}</div><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">√ó</button></div><div className="p-5 space-y-4"><div className="flex flex-wrap gap-2 items-center"><Badge status={req.status} t={t}/>{req.contract_applied&&<span className="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">{t('underContract')}</span>}<span className={`px-2 py-0.5 rounded text-xs ${req.urgency==='critical'?'bg-red-100 text-red-700':req.urgency==='urgent'?'bg-amber-100 text-amber-700':'bg-gray-100 text-gray-700'}`}>{t(req.urgency)}</span></div><div className="grid md:grid-cols-2 gap-4"><div className="bg-gray-50 rounded-lg p-3"><h3 className="text-xs font-medium text-gray-500 uppercase mb-2">{t('client')}</h3><p className="font-medium">{req.companies?.name||'‚Äî'}</p></div><div className="bg-gray-50 rounded-lg p-3"><h3 className="text-xs font-medium text-gray-500 uppercase mb-2">{t('service')}</h3><p className="font-medium capitalize">{t(req.requested_service)}</p></div></div><div><h3 className="text-sm font-medium text-gray-700 mb-2">{t('devices')} ({req.request_devices?.length||0})</h3><div className="space-y-2">{req.request_devices?.map(d=><div key={d.id} className="flex justify-between items-center p-2 bg-gray-50 rounded"><div><span className="font-mono text-[#0066b3]">{d.serial_number}</span><span className="text-gray-500 ml-2">{d.model_name||''}</span></div></div>)}</div></div>{req.problem_description&&<div><h3 className="text-sm font-medium text-gray-700 mb-1">{t('problemDescription')}</h3><p className="text-gray-600 text-sm bg-gray-50 p-2 rounded">{req.problem_description}</p></div>}{req.quote_total&&<div className="bg-blue-50 rounded-lg p-3"><h3 className="text-xs font-medium text-gray-500 uppercase mb-2">Devis</h3><div className="space-y-1 text-sm"><div className="flex justify-between"><span>{t('subtotal')}</span><span>{req.quote_subtotal?.toFixed(2)} ‚Ç¨</span></div><div className="flex justify-between"><span>{t('vat')}</span><span>{req.quote_tax?.toFixed(2)} ‚Ç¨</span></div><div className="flex justify-between font-bold text-lg border-t pt-1 mt-1"><span>{t('total')}</span><span>{req.quote_total?.toFixed(2)} ‚Ç¨</span></div></div></div>}{isAdmin&&<div><h3 className="text-sm font-medium text-gray-700 mb-1">{t('internalNotes')}</h3><textarea value={notes} onChange={e=>setNotes(e.target.value)} rows={3} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-none"/><button onClick={saveNotes} disabled={sv} className="mt-2 px-3 py-1.5 bg-gray-100 text-gray-700 rounded text-sm">{sv?t('saving'):t('save')}</button></div>}{isAdmin&&req.status==='quoted'&&<button onClick={approveRma} className="w-full py-2.5 bg-green-500 text-white rounded-lg font-semibold">‚úì Approuver + G√©n√©rer RMA</button>}</div></div></div>}

function QuoteModal({req,parts,t,refresh,notify,onClose}){const[lines,setLines]=useState(req.quote_line_items||[]);const[sv,setSv]=useState(false);const addLine=()=>setLines([...lines,{description:'',quantity:1,unit_price:0,total_price:0}]);const updLine=(i,k,v)=>{const u=[...lines];u[i][k]=v;if(k==='quantity'||k==='unit_price')u[i].total_price=u[i].quantity*u[i].unit_price;setLines(u)};const remLine=i=>setLines(lines.filter((_,x)=>x!==i));const addPart=p=>{const nl={description:p.name,quantity:1,unit_price:p.price,total_price:p.price,part_id:p.id};setLines([...lines,nl])};const sub=lines.reduce((s,l)=>s+(l.total_price||0),0);const tax=sub*0.2;const tot=sub+tax;const save=async()=>{setSv(true);await supabase.from('quote_line_items').delete().eq('request_id',req.id);for(const l of lines){await supabase.from('quote_line_items').insert({request_id:req.id,description:l.description,quantity:l.quantity,unit_price:l.unit_price,total_price:l.total_price,part_id:l.part_id||null})}await supabase.from('service_requests').update({status:'quoted',quote_subtotal:sub,quote_tax:tax,quote_total:tot,quoted_at:new Date().toISOString()}).eq('id',req.id);setSv(false);notify(t('saved'));refresh();onClose()};return<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 overflow-y-auto" onClick={onClose}><div className="bg-white rounded-xl w-full max-w-3xl my-8" onClick={e=>e.stopPropagation()}><div className="px-5 py-4 border-b flex justify-between items-center"><div><h2 className="font-bold text-lg">{t('createQuote')}</h2><p className="text-sm text-gray-500">{req.request_number} - {req.companies?.name}</p></div><button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">√ó</button></div><div className="p-5 space-y-4 max-h-[70vh] overflow-y-auto"><div><h3 className="text-sm font-medium text-gray-700 mb-2">{t('devices')}</h3><div className="flex flex-wrap gap-2">{req.request_devices?.map(d=><span key={d.id} className="px-2 py-1 bg-gray-100 rounded text-sm font-mono">{d.serial_number}</span>)}</div></div><div><h3 className="text-sm font-medium text-gray-700 mb-2">Catalogue</h3><div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto">{parts.map(p=><button key={p.id} onClick={()=>addPart(p)} className="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs hover:bg-blue-100">{p.name} ({p.price}‚Ç¨)</button>)}</div></div><div><div className="flex justify-between items-center mb-2"><h3 className="text-sm font-medium text-gray-700">Lignes</h3><button onClick={addLine} className="px-2 py-1 bg-[#0066b3] text-white rounded text-xs">{t('addLine')}</button></div><div className="space-y-2">{lines.map((l,i)=><div key={i} className="grid grid-cols-12 gap-2 items-center"><div className="col-span-5"><input type="text" placeholder={t('description')} value={l.description} onChange={e=>updLine(i,'description',e.target.value)} className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm"/></div><div className="col-span-2"><input type="number" placeholder="Qt√©" value={l.quantity} onChange={e=>updLine(i,'quantity',parseFloat(e.target.value)||0)} className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm"/></div><div className="col-span-2"><input type="number" step="0.01" placeholder="Prix" value={l.unit_price} onChange={e=>updLine(i,'unit_price',parseFloat(e.target.value)||0)} className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm"/></div><div className="col-span-2 text-right font-medium text-sm">{l.total_price?.toFixed(2)} ‚Ç¨</div><div className="col-span-1"><button onClick={()=>remLine(i)} className="text-red-500">√ó</button></div></div>)}</div>{lines.length===0&&<p className="text-center text-gray-500 py-4 text-sm">Ajoutez des lignes</p>}</div><div className="bg-gray-50 rounded-lg p-4"><div className="space-y-2 text-sm"><div className="flex justify-between"><span>{t('subtotal')}</span><span>{sub.toFixed(2)} ‚Ç¨</span></div><div className="flex justify-between"><span>{t('vat')}</span><span>{tax.toFixed(2)} ‚Ç¨</span></div><div className="flex justify-between font-bold text-lg border-t pt-2 mt-2"><span>{t('total')}</span><span>{tot.toFixed(2)} ‚Ç¨</span></div></div></div></div><div className="px-5 py-4 border-t flex gap-3"><button onClick={onClose} className="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg">{t('cancel')}</button><button onClick={save} disabled={sv||lines.length===0} className="flex-1 py-2.5 bg-[#0066b3] text-white rounded-lg font-semibold disabled:opacity-50">{sv?t('saving'):t('sendQuote')}</button></div></div></div>}

function NewReq({equipment,addresses,t,profile,refresh,notify,setPage}){const[sel,setSel]=useState([]);const[f,setF]=useState({requested_service:'calibration',problem_description:'',urgency:'normal',shipping_address_id:addresses[0]?.id||''});const[sv,setSv]=useState(false);const toggle=id=>setSel(sel.includes(id)?sel.filter(x=>x!==id):[...sel,id]);const sub=async e=>{e.preventDefault();if(sel.length===0){notify('Select devices','error');return}setSv(true);const{data:st}=await supabase.from('system_settings').select('value').eq('key','request_counter').single();const cnt=st?.value?.counter||0;const rn=`SR-${new Date().getFullYear()}-${String(cnt+1).padStart(4,'0')}`;const{data:req}=await supabase.from('service_requests').insert({request_number:rn,company_id:profile.company_id,submitted_by:profile.id,requested_service:f.requested_service,problem_description:f.problem_description,urgency:f.urgency,shipping_address_id:f.shipping_address_id||null,status:'submitted',submitted_at:new Date().toISOString()}).select().single();if(req){for(const id of sel){const eq=equipment.find(x=>x.id===id);if(eq){await supabase.from('request_devices').insert({request_id:req.id,equipment_id:eq.id,serial_number:eq.serial_number,model_name:eq.model_name,equipment_type:eq.equipment_type,service_type:f.requested_service})}}}await supabase.from('system_settings').update({value:{prefix:'SR',counter:cnt+1}}).eq('key','request_counter');setSv(false);notify(t('saved'));refresh();setPage('requests')};if(equipment.length===0)return<div className="max-w-xl mx-auto px-4 py-12"><div className="bg-white rounded-xl p-12 text-center shadow-sm"><p className="text-4xl mb-3">‚öôÔ∏è</p><h2 className="font-bold text-lg mb-2">Aucun √©quipement</h2><p className="text-gray-500 mb-4">Ajoutez vos √©quipements</p><button onClick={()=>setPage('equipment')} className="px-4 py-2 bg-[#0066b3] text-white rounded-lg font-medium">{t('add')}</button></div></div>;return<div className="max-w-2xl mx-auto px-4 py-6"><h1 className="text-xl font-bold text-[#1e3a5f] mb-4">{t('newRequest')}</h1><div className="bg-white rounded-xl shadow-sm border border-gray-100"><form onSubmit={sub} className="p-5 space-y-4"><div><label className="block text-sm font-medium text-gray-700 mb-2">{t('selectDevices')} *</label><div className="grid gap-2 max-h-48 overflow-y-auto">{equipment.map(eq=><label key={eq.id} className={`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer ${sel.includes(eq.id)?'border-[#0066b3] bg-blue-50':'border-gray-200'}`}><input type="checkbox" checked={sel.includes(eq.id)} onChange={()=>toggle(eq.id)} className="w-4 h-4"/><div><div className="font-medium">{eq.model_name||'Unknown'}</div><div className="text-sm text-gray-500 font-mono">{eq.serial_number}</div></div></label>)}</div><p className="text-sm text-gray-500 mt-1">{sel.length} s√©lectionn√©(s)</p></div><div><label className="block text-sm font-medium text-gray-700 mb-2">{t('service')} *</label><div className="grid grid-cols-2 gap-2">{[{v:'calibration',l:t('calibration')},{v:'repair',l:t('repair')},{v:'calibration_repair',l:t('calibrationRepair')},{v:'diagnostic',l:t('diagnostic')}].map(o=><label key={o.v} className={`flex items-center gap-2 p-3 rounded-lg border-2 cursor-pointer ${f.requested_service===o.v?'border-[#0066b3] bg-blue-50':'border-gray-200'}`}><input type="radio" name="svc" value={o.v} checked={f.requested_service===o.v} onChange={ev=>setF({...f,requested_service:ev.target.value})} className="hidden"/><span>{o.l}</span></label>)}</div></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('problemDescription')}</label><textarea value={f.problem_description} onChange={ev=>setF({...f,problem_description:ev.target.value})} rows={3} className="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none"/></div><div><label className="block text-sm font-medium text-gray-700 mb-2">{t('urgency')}</label><div className="flex gap-3">{['normal','urgent','critical'].map(u=><label key={u} className="flex items-center gap-2 cursor-pointer"><input type="radio" name="urg" value={u} checked={f.urgency===u} onChange={ev=>setF({...f,urgency:ev.target.value})} className="w-4 h-4"/><span className={u==='critical'?'text-red-600':u==='urgent'?'text-amber-600':''}>{t(u)}</span></label>)}</div></div>{addresses.length>0&&<div><label className="block text-sm font-medium text-gray-700 mb-1">{t('shippingAddress')}</label><select value={f.shipping_address_id} onChange={ev=>setF({...f,shipping_address_id:ev.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg">{addresses.map(a=><option key={a.id} value={a.id}>{a.label} - {a.city}</option>)}</select></div>}<div className="flex gap-3 pt-2"><button type="button" onClick={()=>setPage('dashboard')} className="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-lg">{t('cancel')}</button><button type="submit" disabled={sv||sel.length===0} className="flex-1 py-2.5 bg-[#0066b3] text-white rounded-lg font-semibold disabled:opacity-50">{sv?t('saving'):t('submit')}</button></div></form></div></div>}
