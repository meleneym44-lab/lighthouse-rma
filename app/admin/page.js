'use client';
import { useState, useEffect, useCallback, useMemo, Fragment } from 'react';
import { supabase } from '@/lib/supabase';

// Expose supabase to window for debugging
if (typeof window !== 'undefined') {
  window.supabase = supabase;
}

// Product emoji image mapping ‚Äî maps model names to custom product images
const getDeviceImageUrl = (modelName) => {
  if (!modelName) return null;
  const m = modelName.toLowerCase();
  if (m.startsWith('apexp') || m === 'apex p3' || m === 'apex p5') return '/images/products/ApexP-Emoji.png';
  if (m.startsWith('apexr') || m.startsWith('apex r') || m === 'apexbcrp') return '/images/products/ApexR-Emoji.png';
  if (m.startsWith('apexz') || m === 'apex z' || m === 'apex 1100') return '/images/products/ApexZ-Emoji.png';
  if (m.startsWith('solair')) return '/images/products/Solair-Emoji.png';
  if (m.startsWith('ls-') || m === 'ls20' || m === 'ls60') return '/images/products/LS-Emoji.png';
  if (m.startsWith('vertex')) return '/images/products/Vertex-Emoji.png';
  if (m.startsWith('handheld') || m.startsWith('iaq handheld')) return '/images/products/HandHeld-Emoji.png';
  if (m.startsWith('activecount') || m.includes('active count')) return '/images/products/ActiveCount-Emoji.png';
  return null;
};

// ============================================
// PDF GENERATION UTILITIES - PROFESSIONAL STYLE
// Matches the customer portal quote PDF format exactly
// ============================================

// Load jsPDF dynamically from CDN
const loadJsPDF = async () => {
  if (window.jspdf) return window.jspdf.jsPDF;
  
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    script.onload = () => resolve(window.jspdf.jsPDF);
    script.onerror = reject;
    document.head.appendChild(script);
  });
};

// Load image as base64 for PDF
const loadImageAsBase64 = async (url) => {
  try {
    const response = await fetch(url);
    if (!response.ok) return null;
    const blob = await response.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = () => resolve(null);
      reader.readAsDataURL(blob);
    });
  } catch (e) {
    return null;
  }
};

// Color palette (matching customer portal)
const PDF_COLORS = {
  green: [0, 166, 81],
  darkBlue: [26, 26, 46],
  navy: [45, 90, 123],
  gray: [80, 80, 80],
  lightGray: [130, 130, 130],
  white: [255, 255, 255]
};

// Generate Quote/Devis PDF - PROFESSIONAL FORMAT
const generateQuotePDF = async (rma, devices, options = {}) => {
  const jsPDF = await loadJsPDF();
  const pdf = new jsPDF('p', 'mm', 'a4');
  const company = rma.companies || {};
  const biz = options.businessSettings || {};
  const shippingInfo = options.shipping || { parcels: 1, unitPrice: 45, total: 45 };
  const discountInfo = options.discount && options.discount.enabled ? options.discount : null;
  const quoteNumber = options.quoteNumber || rma.quote_number || null; // DEV-0226-001 format
  const revisionNumber = options.revisionNumber || 0;
  const quoteNumberDisplay = quoteNumber ? (revisionNumber > 0 ? `${quoteNumber} Rev-${revisionNumber}` : quoteNumber) : null;
  
  const pageWidth = 210, pageHeight = 297, margin = 15;
  const contentWidth = pageWidth - (margin * 2);
  const footerHeight = 16;
  const { navy, darkBlue, gray, lightGray, white } = PDF_COLORS;
  
  let y = margin;
  
  // Load logos - use color logo for quotes
  let lighthouseLogo = await loadImageAsBase64('/images/logos/Lighthouse-color-logo.jpg');
  let capcertLogo = await loadImageAsBase64('/images/logos/capcert-logo.png');
  
  const addFooter = () => {
    pdf.setFillColor(...darkBlue);
    pdf.rect(0, pageHeight - footerHeight, pageWidth, footerHeight, 'F');
    pdf.setTextColor(...white);
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.text(biz.company_name || 'Lighthouse France SAS', pageWidth / 2, pageHeight - footerHeight + 6, { align: 'center' });
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(180, 180, 180);
    pdf.setFontSize(8);
    pdf.text(`${biz.address || '16, rue Paul Sejourne'} - ${biz.postal_code || '94000'} ${biz.city || 'CRETEIL'} - Tel. ${biz.phone || '01 43 77 28 07'}`, pageWidth / 2, pageHeight - footerHeight + 11, { align: 'center' });
  };
  
  const getUsableHeight = () => pageHeight - footerHeight - margin;
  
  const checkPageBreak = (needed) => {
    if (y + needed > getUsableHeight()) {
      addFooter();
      pdf.addPage();
      y = margin;
      return true;
    }
    return false;
  };

  // ===== HEADER =====
  if (lighthouseLogo) {
    try {
      const format = lighthouseLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(lighthouseLogo, format, margin, y - 2, 85, 22);
    } catch (e) {
      pdf.setFontSize(26);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...darkBlue);
      pdf.text('LIGHTHOUSE', margin, y + 8);
    }
  } else {
    pdf.setFontSize(26);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text('LIGHTHOUSE', margin, y + 8);
  }
  
  pdf.setFontSize(18);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...navy);
  pdf.text('OFFRE DE PRIX', pageWidth - margin, y + 5, { align: 'right' });
  
  // Document number (DEV-0226-001) - primary identifier
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('N¬∞ ' + (quoteNumberDisplay || '‚Äî'), pageWidth - margin, y + 11, { align: 'right' });
  
  // RMA reference (FR-00327) - secondary reference
  if (rma.request_number) {
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...gray);
    pdf.text('RMA: ' + rma.request_number, pageWidth - margin, y + 16, { align: 'right' });
  }
  
  y += 20;
  pdf.setDrawColor(...navy);
  pdf.setLineWidth(1);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 7;

  // ===== INFO BAR =====
  pdf.setFillColor(245, 245, 245);
  pdf.rect(margin, y, contentWidth, 16, 'F');
  pdf.setFontSize(8);
  pdf.setTextColor(...lightGray);
  pdf.text('DATE', margin + 5, y + 5);
  pdf.text('VALIDITE', margin + 60, y + 5);
  pdf.text('CONDITIONS', margin + 115, y + 5);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  const qDate = rma.quoted_at ? new Date(rma.quoted_at).toLocaleDateString('fr-FR') : new Date().toLocaleDateString('fr-FR');
  pdf.text(qDate, margin + 5, y + 12);
  pdf.text('30 jours', margin + 60, y + 12);
  pdf.text('A reception de facture', margin + 115, y + 12);
  y += 20;

  // ===== CLIENT =====
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...lightGray);
  pdf.text('CLIENT', margin, y);
  y += 5;
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(company.name || 'Client', margin, y);
  y += 6;
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  if (company.billing_address || company.address) {
    pdf.text(company.billing_address || company.address, margin, y);
    y += 5;
  }
  const city = [company.billing_postal_code || company.postal_code, company.billing_city || company.city].filter(Boolean).join(' ');
  if (city) {
    pdf.text(city, margin, y);
    y += 5;
  }
  y += 8;

  // ===== SERVICE DESCRIPTION BLOCKS =====
  // Determine what service types are needed based on devices
  const calibrationTypes = new Set();
  let hasRepair = false;
  devices.forEach(d => {
    const svcType = d.service_type || d.serviceType || 'calibration';
    const devType = d.device_type || d.deviceType || 'particle_counter';
    if (svcType.includes('calibration') || svcType === 'cal_repair') {
      calibrationTypes.add(devType);
    }
    if (svcType.includes('repair') || svcType === 'cal_repair') {
      hasRepair = true;
    }
  });
  if (calibrationTypes.size === 0) calibrationTypes.add('particle_counter');

  // Service descriptions - use settings if available, else defaults
  const qs = options.quoteSettings || biz.quote_settings || {};

  const DEFAULT_CAL_DATA = {
    particle_counter: {
      title: "Etalonnage Compteur de Particules Aeroportees",
      prestations: [
        "Verification des fonctionnalites du compteur",
        "Verification et reglage du debit",
        "Verification de la cellule de mesure",
        "Controle et reglage des seuils de mesures granulometrique a l'aide de spheres de latex calibrees et certifiees",
        "Verification en nombre par comparaison a un etalon etalonne selon la norme ISO 17025, conformement a la norme ISO 21501-4",
        "Fourniture d'un rapport de test et de calibration"
      ]
    },
    bio_collector: {
      title: "Etalonnage Bio Collecteur",
      prestations: [
        "Verification des fonctionnalites de l'appareil",
        "Verification et reglage du debit",
        "Verification de la cellule d'impaction",
        "Controle des parametres de collecte",
        "Fourniture d'un rapport de test et de calibration"
      ]
    },
    liquid_counter: {
      title: "Etalonnage Compteur de Particules en Milieu Liquide",
      prestations: [
        "Verification des fonctionnalites du compteur",
        "Verification et reglage du debit",
        "Verification de la cellule de mesure optique",
        "Controle et reglage des seuils de mesures granulometrique",
        "Verification en nombre par comparaison a un etalon",
        "Fourniture d'un rapport de test et de calibration"
      ]
    },
    temp_humidity: {
      title: "Etalonnage Capteur Temperature/Humidite",
      prestations: [
        "Verification des fonctionnalites du capteur",
        "Etalonnage temperature sur points de reference certifies",
        "Etalonnage humidite relative",
        "Verification de la stabilite des mesures",
        "Fourniture d'un certificat d'etalonnage"
      ]
    },
    other: {
      title: "Etalonnage Equipement",
      prestations: [
        "Verification des fonctionnalites de l'appareil",
        "Etalonnage selon les specifications du fabricant",
        "Tests de fonctionnement",
        "Fourniture d'un rapport de test"
      ]
    }
  };

  const DEFAULT_REPAIR_DATA = {
    title: "Reparation",
    prestations: [
      "Diagnostic complet de l'appareil",
      "Identification des composants defectueux",
      "Remplacement des pieces defectueuses (pieces facturees en sus)",
      "Tests de fonctionnement complets",
      "Verification d'etalonnage post-reparation si applicable"
    ]
  };

  const DEFAULT_DISCLAIMERS = [
    "Cette offre n'inclut pas la reparation ou l'echange de pieces non consommables.",
    "Un devis complementaire sera etabli si des pieces sont trouvees defectueuses et necessitent un remplacement.",
    "Les mesures stockees dans les appareils seront eventuellement perdues lors des operations de maintenance.",
    "Les equipements envoyes devront etre decontamines de toutes substances chimiques, bacteriennes ou radioactives."
  ];

  // Merge settings with defaults - settings override defaults when present
  const CAL_DATA = {};
  for (const key of Object.keys(DEFAULT_CAL_DATA)) {
    const settingsBlock = qs.calibration?.[key];
    if (settingsBlock && settingsBlock.title && settingsBlock.prestations?.length) {
      CAL_DATA[key] = settingsBlock;
    } else {
      CAL_DATA[key] = DEFAULT_CAL_DATA[key];
    }
  }

  const REPAIR_DATA = (qs.repair?.title && qs.repair?.prestations?.length)
    ? qs.repair
    : DEFAULT_REPAIR_DATA;

  const DISCLAIMERS = (qs.disclaimers?.length)
    ? qs.disclaimers
    : DEFAULT_DISCLAIMERS;

  // Draw service blocks - PAGE-BREAK AWARE (line by line)
  const drawServiceBlock = (data, color) => {
    const lineH = 5;
    const titleH = 10;

    // Pre-calculate all wrapped lines to know which belong to which prestation
    const allLines = [];
    data.prestations.forEach(p => {
      const wrapped = pdf.splitTextToSize(p, contentWidth - 14);
      wrapped.forEach((l, i) => allLines.push({ text: l, isFirst: i === 0 }));
    });

    // Check if we need at least title + first 2 lines of space, else new page
    checkPageBreak(titleH + lineH * 2);

    // Track the vertical line start on the current page
    let vLineStartY = y;
    
    // Draw title
    pdf.setDrawColor(...color);
    pdf.setLineWidth(1);
    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text(data.title, margin + 5, y + 6);
    y += titleH;

    // Draw lines one by one with page break checks
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...gray);
    allLines.forEach((lineObj) => {
      if (y + lineH > getUsableHeight()) {
        // Draw vertical line segment for this page before breaking
        pdf.setDrawColor(...color);
        pdf.setLineWidth(1);
        pdf.line(margin, vLineStartY, margin, y - 2);
        addFooter();
        pdf.addPage();
        y = margin;
        vLineStartY = y;
        // Reset font after page break
        pdf.setFontSize(9);
        pdf.setFont('helvetica', 'normal');
        pdf.setTextColor(...gray);
      }
      if (lineObj.isFirst) pdf.text('-', margin + 5, y);
      pdf.text(lineObj.text, margin + 9, y);
      y += lineH;
    });

    // Draw final vertical line segment
    pdf.setDrawColor(...color);
    pdf.setLineWidth(1);
    const lineEndY = Math.max(vLineStartY + 5, y - 7);
    pdf.line(margin, vLineStartY, margin, lineEndY);
    y += 5; // Space after block
  };

  // Draw calibration blocks (blue)
  calibrationTypes.forEach(type => {
    const data = CAL_DATA[type] || CAL_DATA.particle_counter;
    drawServiceBlock(data, [59, 130, 246]);
  });
  
  // Draw repair block (orange) if needed
  if (hasRepair) {
    drawServiceBlock(REPAIR_DATA, [249, 115, 22]);
  }

  // ===== DETAILED PRICING TABLE (Qt√© | D√©signation | Prix Unit. | Total HT) =====
  y += 5; // Extra space before pricing table
  
  const rowH = 7;
  const colQty = margin;
  const colDesc = margin + 12;
  const colUnit = pageWidth - margin - 45;
  const colTotal = pageWidth - margin - 3;
  
  // Get devicePricing from options for detailed breakdown
  const devicePricing = options.devicePricing || devices.map(d => ({
    model: d.model_name || d.model || '',
    serial: d.serial_number || d.serial || '',
    needsCalibration: (d.service_type || '').includes('calibration'),
    needsRepair: (d.service_type || '').includes('repair'),
    calibrationPrice: d.quoted_price || 0,
    repairPrice: 0,
    nettoyagePrice: 0,
    additionalParts: [],
    isContractCovered: false
  }));
  
  // Helper: draw table header row
  const drawTableHeader = () => {
    pdf.setFillColor(...darkBlue);
    pdf.rect(margin, y, contentWidth, 9, 'F');
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...white);
    pdf.text('Qte', colQty + 3, y + 6);
    pdf.text('Designation', colDesc, y + 6);
    pdf.text('Prix Unit.', colUnit, y + 6, { align: 'right' });
    pdf.text('Total HT', colTotal, y + 6, { align: 'right' });
    y += 9;
  };
  
  // Helper: check page break for table rows and redraw header if needed
  const checkTablePageBreak = (needed) => {
    if (y + needed > getUsableHeight()) {
      addFooter();
      pdf.addPage();
      y = margin;
      drawTableHeader();
      return true;
    }
    return false;
  };
  
  // Helper: draw a single table row with page break awareness
  const drawTableRow = (qty, desc, unitDisplay, totalDisplay, bgIndex) => {
    checkTablePageBreak(rowH);
    pdf.setFillColor(bgIndex % 2 === 0 ? 255 : 250, bgIndex % 2 === 0 ? 255 : 250, bgIndex % 2 === 0 ? 255 : 250);
    pdf.rect(margin, y, contentWidth, rowH, 'F');
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...darkBlue);
    pdf.text(String(qty), colQty + 3, y + 5);
    pdf.text(desc.substring(0, 60), colDesc, y + 5);
    pdf.text(unitDisplay, colUnit, y + 5, { align: 'right' });
    pdf.setFont('helvetica', 'bold');
    pdf.text(totalDisplay, colTotal, y + 5, { align: 'right' });
    y += rowH;
  };
  
  // Pre-calculate total row count to decide if we should keep the table together
  let totalRowCount = 0;
  devicePricing.forEach(device => {
    if (device.needsCalibration) totalRowCount++;
    if (device.needsNettoyage && !device.isContractCovered && device.nettoyagePrice > 0) totalRowCount++;
    if (device.needsRepair) totalRowCount++;
    totalRowCount += (device.additionalParts || []).length;
  });
  totalRowCount += 1; // shipping row
  if (discountInfo) totalRowCount += 1; // discount row
  
  // Total table height: title(7) + header(9) + data rows + shipping row + discount row + total bar(11) + padding(4)
  const totalTableHeight = 7 + 9 + (totalRowCount * rowH) + 11 + 4;
  const spaceRemaining = getUsableHeight() - y;
  const freshPageSpace = getUsableHeight() - margin;
  
  // KEEP TOGETHER LOGIC: If table doesn't fit here but WOULD fit on a fresh page, push to next page
  if (totalTableHeight > spaceRemaining && totalTableHeight <= freshPageSpace) {
    addFooter();
    pdf.addPage();
    y = margin;
  }
  
  pdf.setFontSize(13);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('Recapitulatif des Prix', margin, y);
  y += 7;

  // Header row
  drawTableHeader();

  let rowIndex = 0;
  let hasNettoyage = false;
  let servicesSubtotal = options.servicesSubtotal || 0;

  // Build line items from devicePricing
  devicePricing.forEach((device) => {
    // Calibration row
    if (device.needsCalibration) {
      const qty = device.calibrationQty || 1;
      const unitPrice = parseFloat(device.calibrationPrice) || 0;
      const lineTotal = qty * unitPrice;
      const isContract = device.isContractCovered;
      const calDesc = `Etalonnage ${device.model || ''} (SN: ${device.serial || ''})${isContract ? ' [CONTRAT]' : ''}`;
      drawTableRow(qty, calDesc, isContract ? 'Contrat' : unitPrice.toFixed(2) + ' EUR', isContract ? 'Contrat' : lineTotal.toFixed(2) + ' EUR', rowIndex);
      rowIndex++;
    }
    
    // Nettoyage row
    if (device.needsNettoyage && !device.isContractCovered && device.nettoyagePrice > 0) {
      hasNettoyage = true;
      const qty = device.nettoyageQty || 1;
      const unitPrice = parseFloat(device.nettoyagePrice) || 0;
      const lineTotal = qty * unitPrice;
      drawTableRow(qty, 'Nettoyage cellule - si requis selon etat du capteur', unitPrice.toFixed(2) + ' EUR', lineTotal.toFixed(2) + ' EUR', rowIndex);
      rowIndex++;
    }
    
    // Repair row
    if (device.needsRepair) {
      const qty = device.repairQty || 1;
      const unitPrice = parseFloat(device.repairPrice) || 0;
      const lineTotal = qty * unitPrice;
      const repDesc = `Reparation ${device.model || ''} (SN: ${device.serial || ''})`;
      drawTableRow(qty, repDesc, unitPrice.toFixed(2) + ' EUR', lineTotal.toFixed(2) + ' EUR', rowIndex);
      rowIndex++;
    }
    
    // Additional parts
    (device.additionalParts || []).forEach(part => {
      const qty = parseInt(part.quantity) || 1;
      const unitPrice = parseFloat(part.price) || 0;
      const lineTotal = qty * unitPrice;
      const partDesc = part.partNumber ? `[${part.partNumber}] ${part.description || 'Piece'}` : (part.description || 'Piece/Service');
      drawTableRow(qty, partDesc, unitPrice.toFixed(2) + ' EUR', lineTotal.toFixed(2) + ' EUR', rowIndex);
      rowIndex++;
    });
  });
  
  // Check if fully contract covered (passed from options)
  const isFullyContractCovered = options.isFullyContractCovered || 
    (options.isContractRMA && devicePricing.length > 0 && devicePricing.every(d => d.isContractCovered));
  
  console.log('PDF Gen - isContractRMA:', options.isContractRMA, 'isFullyContractCovered:', isFullyContractCovered);
  console.log('PDF Gen - devicePricing coverage:', devicePricing.map(d => ({ model: d.model, isContractCovered: d.isContractCovered })));
  
  // Shipping row - keep with total (check for shipping + discount? + total row together)
  const extraRows = (discountInfo && discountInfo.amount > 0) ? rowH : 0;
  checkTablePageBreak(rowH + extraRows + 11 + 4); // shipping row + optional discount + total row + padding
  pdf.setFillColor(245, 245, 245);
  pdf.rect(margin, y, contentWidth, rowH, 'F');
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...darkBlue);
  pdf.text(String(shippingInfo.parcels || 1), colQty + 3, y + 5);
  const shipDesc = shippingInfo.parcels > 1 ? `Frais de port (${shippingInfo.parcels} colis)` : 'Frais de port';
  pdf.text(shipDesc, colDesc, y + 5);
  
  const shippingUnitDisplay = isFullyContractCovered ? 'Contrat' : (shippingInfo.unitPrice || 45).toFixed(2) + ' EUR';
  pdf.text(shippingUnitDisplay, colUnit, y + 5, { align: 'right' });
  pdf.setFont('helvetica', 'bold');
  const shippingTotal = isFullyContractCovered ? 0 : (options.shippingTotal || shippingInfo.total || 0);
  const shippingTotalDisplay = isFullyContractCovered ? 'Contrat' : shippingTotal.toFixed(2) + ' EUR';
  pdf.text(shippingTotalDisplay, colTotal, y + 5, { align: 'right' });
  y += rowH;

  // Discount row (if applicable)
  if (discountInfo && discountInfo.amount > 0) {
    checkTablePageBreak(rowH);
    pdf.setFillColor(255, 251, 235); // amber-50
    pdf.rect(margin, y, contentWidth, rowH, 'F');
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(180, 30, 30);
    pdf.text('1', colQty + 3, y + 5);
    let discDesc = 'Remise';
    if (discountInfo.type === 'percentage') discDesc += ` (${discountInfo.value}%)`;
    if (discountInfo.note) discDesc += ` ‚Äî ${discountInfo.note}`;
    pdf.text(discDesc, colDesc, y + 5);
    pdf.text('', colUnit, y + 5, { align: 'right' });
    pdf.setFont('helvetica', 'bold');
    pdf.text('-' + discountInfo.amount.toFixed(2) + ' EUR', colTotal, y + 5, { align: 'right' });
    y += rowH;
  }

  // Total row
  const grandTotal = isFullyContractCovered ? 0 : (options.grandTotal || (servicesSubtotal + shippingTotal));
  pdf.setFillColor(...navy);
  pdf.rect(margin, y, contentWidth, 11, 'F');
  pdf.setTextColor(...white);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.text('TOTAL HT', colUnit - 30, y + 7.5);
  pdf.setFontSize(16);
  const grandTotalDisplay = isFullyContractCovered ? 'Contrat' : grandTotal.toFixed(2) + ' EUR';
  pdf.text(grandTotalDisplay, colTotal, y + 8, { align: 'right' });
  y += 15;
  
  // Nettoyage disclaimer
  if (hasNettoyage) {
    checkPageBreak(8);
    pdf.setFontSize(7);
    pdf.setFont('helvetica', 'italic');
    pdf.setTextColor(...lightGray);
    pdf.text('* Le nettoyage cellule sera facture uniquement si necessaire selon l\'etat du capteur a reception.', margin, y);
    y += 5;
  }

  // ===== CONDITIONS/DISCLAIMERS (after pricing) =====
  const disclaimerBlockH = 8 + DISCLAIMERS.length * 4;
  y += 3;
  checkPageBreak(disclaimerBlockH);
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...lightGray);
  pdf.text('CONDITIONS', margin, y);
  y += 4;
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  DISCLAIMERS.forEach(d => {
    checkPageBreak(5);
    const wrapped = pdf.splitTextToSize('- ' + d, contentWidth);
    wrapped.forEach(line => {
      checkPageBreak(4);
      pdf.text(line, margin, y);
      y += 4;
    });
  });
  y += 1;

  // ===== SIGNATURE SECTION - ALWAYS ON LAST PAGE =====
  // Signature content: line at sigY, text to sigY+35, total ~38mm from y
  const signatureHeight = 38;
  const signatoryName = qs.signatory_name || biz.quote_signatory || 'M. Meleney';
  const signatoryCompany = qs.signatory_company || biz.company_name || 'Lighthouse France';

  // Check if there's enough room on this page for the signature block
  // Use actual footer position (pageHeight - footerHeight) rather than conservative getUsableHeight
  const signatureLimit = pageHeight - footerHeight - 2;
  if (y + signatureHeight > signatureLimit) {
    addFooter();
    pdf.addPage();
    y = margin;
  }

  // Position signature: push to bottom only if there's lots of space
  const sigY = Math.max(y + 3, signatureLimit - signatureHeight);
  
  pdf.setDrawColor(200, 200, 200);
  pdf.setLineWidth(0.3);
  pdf.line(margin, sigY, pageWidth - margin, sigY);
  
  pdf.setFontSize(8);
  pdf.setTextColor(...lightGray);
  pdf.text('ETABLI PAR', margin, sigY + 7);
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(signatoryName, margin, sigY + 14);
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text(signatoryCompany, margin, sigY + 20);

  // Capcert logo
  if (capcertLogo) {
    try {
      const format = capcertLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(capcertLogo, format, margin + 52, sigY + 3, 30, 30);
    } catch (e) {}
  }

  // Signature box
  const sigBoxX = pageWidth - margin - 62;
  pdf.setFontSize(8);
  pdf.setTextColor(...lightGray);
  pdf.text('Signature client', sigBoxX + 16, sigY + 7);
  pdf.setDrawColor(180, 180, 180);
  pdf.setLineWidth(0.3);
  pdf.setLineDashPattern([2, 2], 0);
  pdf.roundedRect(sigBoxX + 5, sigY + 10, 52, 20, 2, 2, 'D');
  pdf.setLineDashPattern([], 0);
  pdf.text('Lu et approuve', sigBoxX + 18, sigY + 34);

  addFooter();
  
  // Add page numbers to all pages (Page X / Y) for multi-page quotes
  const totalPages = pdf.internal.getNumberOfPages();
  if (totalPages > 1) {
    for (let i = 1; i <= totalPages; i++) {
      pdf.setPage(i);
      pdf.setFontSize(7);
      pdf.setTextColor(180, 180, 180);
      pdf.text(`Page ${i} / ${totalPages}`, pageWidth - margin, pageHeight - 2, { align: 'right' });
    }
  }
  
  return pdf.output('blob');
};

// Generate Parts Order Quote PDF
const generatePartsQuotePDF = async (order, quoteData) => {
  const jsPDF = await loadJsPDF();
  const pdf = new jsPDF('p', 'mm', 'a4');
  const company = order.companies || {};
  
  const parts = quoteData.parts || [];
  const shipping = quoteData.shipping || { parcels: 1, unitPrice: 45, total: 45 };
  const grandTotal = quoteData.grandTotal || 0;
  const quoteRef = quoteData.quoteRef || order.request_number;
  const createdBy = quoteData.createdBy || 'Lighthouse France';
  
  const pageWidth = 210, pageHeight = 297, margin = 15;
  const contentWidth = pageWidth - (margin * 2);
  const footerHeight = 16;
  
  const { navy, darkBlue, gray, lightGray, white } = PDF_COLORS;
  
  let y = margin;
  
  let lighthouseLogo = await loadImageAsBase64('/images/logos/Lighthouse-color-logo.jpg');
  
  const addFooter = () => {
    pdf.setFillColor(...darkBlue);
    pdf.rect(0, pageHeight - footerHeight, pageWidth, footerHeight, 'F');
    pdf.setTextColor(...white);
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Lighthouse France SAS', pageWidth / 2, pageHeight - footerHeight + 6, { align: 'center' });
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(180, 180, 180);
    pdf.setFontSize(8);
    pdf.text('16, rue Paul Sejourne - 94000 CRETEIL - Tel. 01 43 77 28 07', pageWidth / 2, pageHeight - footerHeight + 11, { align: 'center' });
  };

  // Header with logo
  if (lighthouseLogo) {
    try {
      const format = lighthouseLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(lighthouseLogo, format, margin, y, 80, 20);
    } catch (e) {
      pdf.setFontSize(16);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...darkBlue);
      pdf.text('LIGHTHOUSE', margin, y + 8);
    }
  } else {
    pdf.setFontSize(16);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text('LIGHTHOUSE', margin, y + 8);
  }
  
  // Title
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...navy);
  pdf.text('DEVIS PIECES', pageWidth - margin, y + 3, { align: 'right' });
  
  // Document number (DEV-0226-001)
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('N¬∞ ' + (quoteRef || '‚Äî'), pageWidth - margin, y + 9, { align: 'right' });
  
  // PO reference if exists
  if (order.request_number) {
    pdf.setFontSize(8);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...gray);
    pdf.text('R√©f: ' + order.request_number, pageWidth - margin, y + 14, { align: 'right' });
  }
  
  y += 18;
  
  // Amber line
  pdf.setFillColor(...navy);
  pdf.rect(0, y, pageWidth, 1.5, 'F');
  y += 6;
  
  // Date bar
  pdf.setFillColor(249, 250, 251);
  pdf.rect(margin, y, contentWidth, 8, 'F');
  pdf.setFontSize(8);
  pdf.setTextColor(...gray);
  const quoteDate = quoteData.createdAt ? new Date(quoteData.createdAt).toLocaleDateString('fr-FR') : new Date().toLocaleDateString('fr-FR');
  pdf.text(`Date: ${quoteDate}`, margin + 3, y + 5);
  pdf.text('Validite: 30 jours', pageWidth - margin - 3, y + 5, { align: 'right' });
  y += 12;
  
  // Client info
  pdf.setFontSize(7);
  pdf.setTextColor(...lightGray);
  pdf.text('CLIENT', margin, y);
  y += 4;
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(company.name || 'Client', margin, y);
  y += 5;
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  if (company.billing_address) {
    pdf.text(company.billing_address, margin, y);
    y += 4;
  }
  if (company.billing_postal_code || company.billing_city) {
    pdf.text(`${company.billing_postal_code || ''} ${company.billing_city || ''}`.trim(), margin, y);
    y += 4;
  }
  y += 6;
  
  // Parts table header
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('Pieces Commandees', margin, y);
  y += 5;
  
  const colQty = margin;
  const colRef = margin + 12;
  const colDesc = margin + 45;
  const colUnit = pageWidth - margin - 35;
  const colTotal = pageWidth - margin - 3;
  
  // Table header
  pdf.setFillColor(...darkBlue);
  pdf.rect(margin, y, contentWidth, 7, 'F');
  pdf.setFontSize(7);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...white);
  pdf.text('Qte', colQty + 2, y + 5);
  pdf.text('Reference', colRef, y + 5);
  pdf.text('Designation', colDesc, y + 5);
  pdf.text('P.U. HT', colUnit, y + 5, { align: 'right' });
  pdf.text('Total', colTotal, y + 5, { align: 'right' });
  y += 8;
  
  // Table rows
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(8);
  
  parts.forEach((part, idx) => {
    const rowHeight = 7;
    if (idx % 2 === 0) {
      pdf.setFillColor(255, 255, 255);
    } else {
      pdf.setFillColor(249, 250, 251);
    }
    pdf.rect(margin, y, contentWidth, rowHeight, 'F');
    
    pdf.setTextColor(...darkBlue);
    pdf.text(String(part.quantity || 1), colQty + 4, y + 5);
    pdf.setFontSize(7);
    pdf.text(part.partNumber || '-', colRef, y + 5);
    pdf.setFontSize(8);
    
    let desc = part.description || '';
    if (desc.length > 40) desc = desc.substring(0, 37) + '...';
    pdf.text(desc, colDesc, y + 5);
    
    pdf.text((part.unitPrice || 0).toFixed(2) + ' EUR', colUnit, y + 5, { align: 'right' });
    pdf.setFont('helvetica', 'bold');
    pdf.text((part.lineTotal || 0).toFixed(2) + ' EUR', colTotal, y + 5, { align: 'right' });
    pdf.setFont('helvetica', 'normal');
    
    y += rowHeight;
  });
  
  // Shipping row
  if (shipping.total > 0) {
    pdf.setFillColor(239, 246, 255);
    pdf.rect(margin, y, contentWidth, 7, 'F');
    pdf.setTextColor(30, 64, 175);
    pdf.text(String(shipping.parcels || 1), colQty + 4, y + 5);
    pdf.setFontSize(7);
    pdf.text('PORT', colRef, y + 5);
    pdf.setFontSize(8);
    pdf.text(`Frais de port (${shipping.parcels || 1} colis)`, colDesc, y + 5);
    pdf.text((shipping.unitPrice || 45).toFixed(2) + ' EUR', colUnit, y + 5, { align: 'right' });
    pdf.setFont('helvetica', 'bold');
    pdf.text((shipping.total || 0).toFixed(2) + ' EUR', colTotal, y + 5, { align: 'right' });
    y += 7;
  }
  
  // Total row
  pdf.setFillColor(...navy);
  pdf.rect(margin, y, contentWidth, 8, 'F');
  pdf.setTextColor(...white);
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(9);
  pdf.text('TOTAL HT', colUnit - 15, y + 6, { align: 'right' });
  pdf.text(grandTotal.toFixed(2) + ' EUR', colTotal, y + 6, { align: 'right' });
  y += 14;
  
  // Conditions
  pdf.setFillColor(249, 250, 251);
  pdf.rect(margin, y, contentWidth, 22, 'F');
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('Conditions:', margin + 3, y + 5);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text('- Devis valable 30 jours', margin + 5, y + 10);
  pdf.text('- Paiement: 30 jours fin de mois', margin + 5, y + 14);
  pdf.text('- Livraison: Sous reserve de disponibilite', margin + 5, y + 18);
  y += 28;
  
  // Signature section
  pdf.setFontSize(7);
  pdf.setTextColor(...lightGray);
  pdf.text('ETABLI PAR', margin, y);
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(createdBy, margin, y + 5);
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text('Lighthouse France', margin, y + 9);
  
  // Signature box
  const sigBoxX = pageWidth - margin - 55;
  pdf.setFontSize(7);
  pdf.setTextColor(...lightGray);
  pdf.text('Bon pour accord', sigBoxX + 12, y);
  pdf.setDrawColor(180, 180, 180);
  pdf.setLineWidth(0.3);
  pdf.setLineDashPattern([2, 2], 0);
  pdf.roundedRect(sigBoxX + 3, y + 3, 48, 18, 2, 2, 'D');
  pdf.setLineDashPattern([], 0);
  pdf.text('Signature et cachet', sigBoxX + 9, y + 26);

  addFooter();
  return pdf.output('blob');
};

// ============================================
// TECH TRANSLATE MODAL - English‚ÜíCorrected English‚ÜíTechnical French
// For calibration/particle counter service reports
// ============================================
function TechTranslateModal({ isOpen, onClose, onInsert }) {
  const [input, setInput] = useState('');
  const [correctedEnglish, setCorrectedEnglish] = useState('');
  const [technicalFrench, setTechnicalFrench] = useState('');
  const [loading, setLoading] = useState(false);
  const [step, setStep] = useState(1); // 1=input, 2=review, 3=done
  const [mode, setMode] = useState('english'); // 'english' or 'french'

  const resetModal = () => {
    setInput('');
    setCorrectedEnglish('');
    setTechnicalFrench('');
    setStep(1);
    setLoading(false);
  };

  const handleClose = () => {
    resetModal();
    onClose();
  };

  const processEnglish = async () => {
    if (!input.trim()) return;
    setLoading(true);
    
    try {
      const response = await fetch('/api/tech-translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: input.trim(),
          mode: 'english-to-french'
        })
      });
      
      if (!response.ok) throw new Error('Translation failed');
      
      const data = await response.json();
      setCorrectedEnglish(data.correctedEnglish || input);
      setTechnicalFrench(data.technicalFrench || '');
      setStep(2);
    } catch (error) {
      console.error('Translation error:', error);
      alert('Erreur de traduction. Veuillez r√©essayer.');
    }
    setLoading(false);
  };

  const processFrench = async () => {
    if (!input.trim()) return;
    setLoading(true);
    
    try {
      const response = await fetch('/api/tech-translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: input.trim(),
          mode: 'french-correct'
        })
      });
      
      if (!response.ok) throw new Error('Correction failed');
      
      const data = await response.json();
      setTechnicalFrench(data.correctedFrench || input);
      setStep(3);
    } catch (error) {
      console.error('Correction error:', error);
      alert('Erreur de correction. Veuillez r√©essayer.');
    }
    setLoading(false);
  };

  const handleInsert = () => {
    if (technicalFrench.trim()) {
      onInsert(technicalFrench.trim());
      handleClose();
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 px-6 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                <span className="text-xl">üî¨</span>
              </div>
              <div>
                <h3 className="text-white font-bold text-lg">Traduction Technique</h3>
                <p className="text-purple-200 text-xs">Service Calibration & R√©paration</p>
              </div>
            </div>
            <button onClick={handleClose} className="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
          </div>
        </div>

        {/* Mode Toggle */}
        <div className="px-6 py-3 bg-gray-50 border-b flex gap-2">
          <button
            onClick={() => { setMode('english'); resetModal(); }}
            className={`flex-1 px-4 py-2.5 rounded-xl font-medium text-sm transition-all ${
              mode === 'english' 
                ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' 
                : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-100'
            }`}
          >
            üá¨üáß English ‚Üí French
          </button>
          <button
            onClick={() => { setMode('french'); resetModal(); }}
            className={`flex-1 px-4 py-2.5 rounded-xl font-medium text-sm transition-all ${
              mode === 'french' 
                ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' 
                : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-100'
            }`}
          >
            üá´üá∑ Corriger le fran√ßais
          </button>
        </div>

        <div className="p-6">
          {mode === 'english' ? (
            <>
              {/* ENGLISH MODE - 3 Step Process */}
              
              {/* Step 1: Input */}
              <div className="mb-4">
                <div className="flex items-center gap-2 mb-2">
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${step >= 1 ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500'}`}>1</div>
                  <label className="text-sm font-medium text-gray-700">Your English (rough is OK)</label>
                </div>
                <textarea
                  value={input}
                  onChange={e => setInput(e.target.value)}
                  placeholder="Type what you want to say in English... e.g. 'checked the laser, it was dirty so i cleaned it and recalibrated'"
                  className="w-full px-4 py-3 border border-gray-300 rounded-xl h-24 resize-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  disabled={step > 1}
                />
              </div>

              {/* Step 2: Corrected English */}
              {step >= 2 && (
                <div className="mb-4">
                  <div className="flex items-center gap-2 mb-2">
                    <div className="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold">2</div>
                    <label className="text-sm font-medium text-gray-700">Corrected English</label>
                    <span className="text-xs text-green-600 bg-green-100 px-2 py-0.5 rounded-full">‚úì Verified</span>
                  </div>
                  <div className="bg-green-50 border border-green-200 rounded-xl p-4">
                    <p className="text-gray-800 whitespace-pre-wrap">{correctedEnglish}</p>
                  </div>
                </div>
              )}

              {/* Step 3: Technical French */}
              {step >= 2 && technicalFrench && (
                <div className="mb-4">
                  <div className="flex items-center gap-2 mb-2">
                    <div className="w-6 h-6 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs font-bold">3</div>
                    <label className="text-sm font-medium text-gray-700">Technical French</label>
                    <span className="text-xs text-indigo-600 bg-indigo-100 px-2 py-0.5 rounded-full">üî¨ Vocabulaire technique</span>
                  </div>
                  <textarea
                    value={technicalFrench}
                    onChange={e => setTechnicalFrench(e.target.value)}
                    className="w-full px-4 py-3 bg-indigo-50 border border-indigo-200 rounded-xl h-24 resize-none focus:ring-2 focus:ring-indigo-500"
                  />
                  <p className="text-xs text-gray-500 mt-1">Vous pouvez modifier le texte si n√©cessaire</p>
                </div>
              )}

              {/* Actions */}
              <div className="flex gap-3 mt-6">
                {step === 1 && (
                  <button
                    onClick={processEnglish}
                    disabled={loading || !input.trim()}
                    className="flex-1 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {loading ? (
                      <><span className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span> Traitement...</>
                    ) : (
                      <>‚ú® Traduire</>
                    )}
                  </button>
                )}
                {step >= 2 && (
                  <>
                    <button
                      onClick={resetModal}
                      className="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-medium"
                    >
                      ‚Üê Recommencer
                    </button>
                    <button
                      onClick={handleInsert}
                      className="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-medium flex items-center justify-center gap-2"
                    >
                      ‚úì Ins√©rer le fran√ßais
                    </button>
                  </>
                )}
              </div>
            </>
          ) : (
            <>
              {/* FRENCH MODE - Simple correction */}
              
              {/* Input */}
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Votre texte en fran√ßais (√† corriger)
                </label>
                <textarea
                  value={input}
                  onChange={e => setInput(e.target.value)}
                  placeholder="Tapez votre texte en fran√ßais..."
                  className="w-full px-4 py-3 border border-gray-300 rounded-xl h-28 resize-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  disabled={step === 3}
                />
              </div>

              {/* Result */}
              {step === 3 && technicalFrench && (
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Texte corrig√©
                  </label>
                  <textarea
                    value={technicalFrench}
                    onChange={e => setTechnicalFrench(e.target.value)}
                    className="w-full px-4 py-3 bg-green-50 border border-green-200 rounded-xl h-28 resize-none focus:ring-2 focus:ring-green-500"
                  />
                </div>
              )}

              {/* Actions */}
              <div className="flex gap-3 mt-6">
                {step === 1 && (
                  <button
                    onClick={processFrench}
                    disabled={loading || !input.trim()}
                    className="flex-1 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {loading ? (
                      <><span className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span> Correction...</>
                    ) : (
                      <>‚ú® Corriger le texte</>
                    )}
                  </button>
                )}
                {step === 3 && (
                  <>
                    <button
                      onClick={resetModal}
                      className="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-medium"
                    >
                      ‚Üê Recommencer
                    </button>
                    <button
                      onClick={handleInsert}
                      className="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-medium flex items-center justify-center gap-2"
                    >
                      ‚úì Ins√©rer le texte
                    </button>
                  </>
                )}
              </div>
            </>
          )}
        </div>

        {/* Footer tip */}
        <div className="px-6 py-3 bg-gray-50 border-t text-xs text-gray-500 flex items-center gap-2">
          <span>üí°</span>
          <span>Le vocabulaire technique pour compteurs de particules, √©talonnage et r√©paration est automatiquement utilis√©.</span>
        </div>
      </div>
    </div>
  );
}

// Tech Translate Button - Opens the modal
function TechTranslateButton({ onInsert, lang = 'fr' }) {
  const t = k => k;
  const [isOpen, setIsOpen] = useState(false);
  
  return (
    <>
      <button
        type="button"
        onClick={() => setIsOpen(true)}
        className="p-2 text-indigo-500 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg transition-colors flex items-center gap-1.5"
        title="Traduction Technique"
      >
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
        </svg>
        <span className="text-xs font-medium">AI</span>
      </button>
      <TechTranslateModal 
        isOpen={isOpen} 
        onClose={() => setIsOpen(false)} 
        onInsert={onInsert} 
      />
    </>
  );
}

// Generate Service Report PDF - PROFESSIONAL FORMAT
const generateServiceReportPDF = async (device, rma, technicianName, calType, receptionResult, findings, workCompleted, checklist, businessSettings) => {
  const jsPDF = await loadJsPDF();
  const pdf = new jsPDF('p', 'mm', 'a4');
  const company = rma.companies || {};
  const biz = businessSettings || {};
  
  const pageWidth = 210, pageHeight = 297, margin = 15;
  const contentWidth = pageWidth - (margin * 2);
  const footerHeight = 16;
  const { navy, darkBlue, gray, lightGray, white } = PDF_COLORS;
  
  let y = margin;
  
  let lighthouseLogo = await loadImageAsBase64('/images/logos/Lighthouse-color-logo.jpg');
  let capcertLogo = await loadImageAsBase64('/images/logos/capcert-logo.png');
  
  const addFooter = () => {
    pdf.setFillColor(...darkBlue);
    pdf.rect(0, pageHeight - footerHeight, pageWidth, footerHeight, 'F');
    pdf.setTextColor(...white);
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.text(biz.company_name || 'Lighthouse France SAS', pageWidth / 2, pageHeight - footerHeight + 6, { align: 'center' });
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(180, 180, 180);
    pdf.setFontSize(8);
    pdf.text(`${biz.address || '16, rue Paul Sejourne'} - ${biz.postal_code || '94000'} ${biz.city || 'CRETEIL'} - Tel. ${biz.phone || '01 43 77 28 07'}`, pageWidth / 2, pageHeight - footerHeight + 11, { align: 'center' });
  };

  // ===== HEADER =====
  if (lighthouseLogo) {
    try {
      const format = lighthouseLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(lighthouseLogo, format, margin, y - 2, 85, 22);
    } catch (e) {
      pdf.setFontSize(26);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...darkBlue);
      pdf.text('LIGHTHOUSE', margin, y + 8);
    }
  } else {
    pdf.setFontSize(26);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text('LIGHTHOUSE', margin, y + 8);
  }
  
  pdf.setFontSize(18);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...navy);
  pdf.text('RAPPORT DE SERVICE', pageWidth - margin, y + 8, { align: 'right' });
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text('RMA ' + (rma.request_number || 'FR-XXXXX'), pageWidth - margin, y + 14, { align: 'right' });
  
  y += 18;
  pdf.setDrawColor(...navy);
  pdf.setLineWidth(1);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 10;

  // ===== INFO BAR =====
  pdf.setFillColor(245, 245, 245);
  pdf.rect(margin, y, contentWidth, 16, 'F');
  pdf.setFontSize(8);
  pdf.setTextColor(...lightGray);
  pdf.text('DATE', margin + 5, y + 5);
  pdf.text('TECHNICIEN', margin + 50, y + 5);
  pdf.text('TYPE', margin + 110, y + 5);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(new Date().toLocaleDateString('fr-FR'), margin + 5, y + 12);
  pdf.text(technicianName || 'N/A', margin + 50, y + 12);
  pdf.text(calType || 'Standard', margin + 110, y + 12);
  y += 22;

  // ===== DEVICE INFO =====
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...lightGray);
  pdf.text('APPAREIL', margin, y);
  y += 5;
  
  pdf.setFillColor(240, 249, 255);
  pdf.rect(margin, y, contentWidth / 2 - 5, 28, 'F');
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(device.model_name || 'N/A', margin + 5, y + 8);
  pdf.setFontSize(10);
  pdf.setFont('courier', 'normal');
  pdf.setTextColor(...gray);
  pdf.text('SN: ' + (device.serial_number || 'N/A'), margin + 5, y + 16);
  pdf.setFont('helvetica', 'normal');
  pdf.text(device.service_type === 'calibration' ? t('calibration') : t('repair'), margin + 5, y + 23);
  
  // Client box
  pdf.setFillColor(245, 245, 245);
  pdf.rect(margin + contentWidth / 2 + 5, y, contentWidth / 2 - 5, 28, 'F');
  pdf.setFontSize(8);
  pdf.setTextColor(...lightGray);
  pdf.text('CLIENT', margin + contentWidth / 2 + 10, y + 5);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(company.name || 'N/A', margin + contentWidth / 2 + 10, y + 13);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  const addr = [company.billing_address || company.address, company.billing_city || company.city].filter(Boolean).join(', ');
  pdf.text(addr.substring(0, 40), margin + contentWidth / 2 + 10, y + 20);
  
  y += 35;

  // ===== RECEPTION RESULT =====
  if (receptionResult && receptionResult !== 'none') {
    const isConform = receptionResult === 'Conforme';
    pdf.setFillColor(isConform ? 220 : 254, isConform ? 252 : 243, isConform ? 231 : 199);
    pdf.rect(margin, y, contentWidth, 12, 'F');
    pdf.setFontSize(11);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(isConform ? 22 : 161, isConform ? 163 : 98, isConform ? 74 : 7);
    pdf.text((isConform ? '‚úì ' : '‚ö† ') + 'R√©sultat √† la r√©ception: ' + receptionResult, margin + 5, y + 8);
    y += 17;
  }

  // ===== FINDINGS =====
  pdf.setDrawColor(...[59, 130, 246]); // Blue
  pdf.setLineWidth(1);
  pdf.line(margin, y, margin, y + 30);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('CONSTATATIONS', margin + 5, y + 6);
  y += 10;
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  const findingsLines = pdf.splitTextToSize(findings || 'Aucune constatation particuli√®re', contentWidth - 10);
  findingsLines.forEach(line => {
    pdf.text(line, margin + 5, y);
    y += 5;
  });
  y += 8;

  // ===== WORK COMPLETED =====
  pdf.setDrawColor(...navy);
  pdf.setLineWidth(1);
  pdf.line(margin, y, margin, y + 30);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('TRAVAUX EFFECTU√âS', margin + 5, y + 6);
  y += 10;
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  const workLines = pdf.splitTextToSize(workCompleted || 'Service effectu√© selon proc√©dure standard', contentWidth - 10);
  workLines.forEach(line => {
    pdf.text(line, margin + 5, y);
    y += 5;
  });
  y += 8;

  // ===== CHECKLIST =====
  if (checklist && checklist.length > 0) {
    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text('V√âRIFICATIONS', margin, y);
    y += 6;
    
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'normal');
    checklist.forEach(item => {
      const checked = item.checked;
      pdf.setTextColor(checked ? 22 : 161, checked ? 163 : 98, checked ? 74 : 7);
      pdf.text(checked ? '‚úì' : '‚óã', margin + 3, y);
      pdf.setTextColor(...gray);
      pdf.text(item.label, margin + 10, y);
      y += 5;
    });
    y += 5;
  }

  // ===== SIGNATURE SECTION =====
  const sigY = Math.max(y + 10, pageHeight - footerHeight - 40);
  
  pdf.setDrawColor(200, 200, 200);
  pdf.setLineWidth(0.3);
  pdf.line(margin, sigY, pageWidth - margin, sigY);
  
  pdf.setFontSize(8);
  pdf.setTextColor(...lightGray);
  pdf.text('TECHNICIEN', margin, sigY + 7);
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(technicianName || 'N/A', margin, sigY + 14);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text('Date: ' + new Date().toLocaleDateString('fr-FR'), margin, sigY + 20);

  if (capcertLogo) {
    try {
      const format = capcertLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(capcertLogo, format, pageWidth - margin - 35, sigY + 3, 32, 32);
    } catch (e) {}
  }

  addFooter();
  return pdf.output('blob');
};

// ============================================
// INVOICE / FACTURE PDF GENERATION - v6
// ============================================
const generateInvoicePDF = async (invoiceData, businessSettings) => {
  const jsPDF = await loadJsPDF();
  const pdf = new jsPDF('p', 'mm', 'a4');
  const biz = businessSettings || {};
  const pageWidth = 210;
  const pageHeight = 297;
  const margin = 15;
  const contentWidth = pageWidth - margin * 2;
  
  const navy = [30, 58, 95];
  const darkGray = [51, 51, 51];
  const medGray = [130, 130, 130];
  const lightLine = [210, 215, 220];
  
  const {
    invoiceNumber, invoiceDate, dueDate,
    company, clientRef, rmaNumber, quoteNumber, bcNumber,
    supplementNumber, supplementBCNumber,
    lines, subtotalHT, tvaRate, tvaAmount, totalTTC,
    isExonerated, paymentTermsDays, notes
  } = invoiceData;

  const frenchMonths = ['janvier', 'f\u00E9vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao\u00FBt', 'septembre', 'octobre', 'novembre', 'd\u00E9cembre'];
  const formatDateFull = (dateStr) => {
    if (!dateStr) return '\u2014';
    const d = new Date(dateStr);
    return d.getDate() + ' ' + frenchMonths[d.getMonth()] + ' ' + d.getFullYear();
  };

  // ---- LOGO ----
  let y = 10;
  try {
    const logoImg = new Image();
    logoImg.crossOrigin = 'anonymous';
    logoImg.src = '/images/logos/Lighthouse-color-logo.jpg';
    await new Promise((res, rej) => { logoImg.onload = res; logoImg.onerror = rej; setTimeout(rej, 2000); });
    pdf.addImage(logoImg, 'JPEG', 10, 8, 95, 21);
  } catch(e) {
    pdf.setFontSize(18);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...navy);
    pdf.text('LIGHTHOUSE', 10, 18);
    pdf.setFontSize(8);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...medGray);
    pdf.text('WORLDWIDE SOLUTIONS \u2014 FRANCE', 10, 23);
  }

  y = 30;

  // ---- FACTURE TITLE BAR ----
  pdf.setFillColor(...navy);
  pdf.roundedRect(margin, y, contentWidth, 14, 2, 2, 'F');
  pdf.setFontSize(18);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(255, 255, 255);
  pdf.text('FACTURE', margin + 8, y + 10);
  pdf.setFontSize(14);
  pdf.text('N\u00B0 ' + (invoiceNumber || ''), pageWidth - margin - 8, y + 10, { align: 'right' });
  y += 20;

  // ---- REFERENCES (left) | CLIENT BOX (right) ----
  const blockY = y;
  const labelX = margin;
  const valueX = margin + 36;
  let refY = blockY;
  
  const addRefLine = (label, value, bold) => {
    if (!value) return;
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...medGray);
    pdf.text(label, labelX, refY);
    pdf.setFont('helvetica', bold ? 'bold' : 'normal');
    pdf.setTextColor(...darkGray);
    pdf.text(String(value), valueX, refY);
    refY += 6;
  };
  
  addRefLine('Date :', formatDateFull(invoiceDate), false);
  addRefLine('\u00C9ch\u00E9ance :', formatDateFull(dueDate), true);
  refY += 2;
  if (rmaNumber) addRefLine('RMA :', rmaNumber, true);
  if (quoteNumber) addRefLine('Devis :', quoteNumber, false);
  if (bcNumber) addRefLine('BC :', bcNumber, false);
  if (supplementNumber) addRefLine('Suppl\u00E9ment :', supplementNumber, false);
  if (supplementBCNumber && supplementBCNumber !== bcNumber) addRefLine('BC Suppl. :', supplementBCNumber, false);
  if (clientRef) addRefLine('Vos r\u00E9f. :', clientRef, false);
  
  // Client box ‚Äî clean border, no thick accent bar
  const clientBoxX = pageWidth / 2 + 8;
  const clientBoxW = pageWidth / 2 - margin - 8;
  const clientBoxH = 36;
  
  pdf.setFillColor(248, 250, 252);
  pdf.setDrawColor(...lightLine);
  pdf.setLineWidth(0.4);
  pdf.roundedRect(clientBoxX, blockY - 3, clientBoxW, clientBoxH, 2, 2, 'FD');
  
  pdf.setFontSize(7.5);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...medGray);
  pdf.text('FACTURER \u00C0', clientBoxX + 5, blockY + 3);
  
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...navy);
  pdf.text(company?.name || 'Client', clientBoxX + 5, blockY + 10);
  
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...darkGray);
  let clientY = blockY + 16;
  if (company?.attention) { pdf.text(company.attention, clientBoxX + 5, clientY); clientY += 4.5; }
  if (company?.address) { pdf.text(company.address, clientBoxX + 5, clientY); clientY += 4.5; }
  const cityLine = [company?.postal_code, company?.city].filter(Boolean).join(' ');
  if (cityLine) { pdf.text(cityLine, clientBoxX + 5, clientY); clientY += 4.5; }
  if (company?.country && company.country !== 'France') { pdf.text(company.country.toUpperCase(), clientBoxX + 5, clientY); clientY += 4.5; }
  if (company?.tva_number) {
    pdf.setFontSize(8);
    pdf.setTextColor(...medGray);
    pdf.text('TVA: ' + company.tva_number, clientBoxX + 5, clientY);
  }
  
  y = Math.max(refY, blockY + clientBoxH) + 6;

  // ---- LINE ITEMS TABLE ----
  const colQty = margin + 1;
  const colDesc = margin + 14;
  const colPU = pageWidth - margin - 48;
  const colTotal = pageWidth - margin - 2;

  pdf.setFillColor(...navy);
  pdf.roundedRect(margin, y, contentWidth, 9, 1.5, 1.5, 'F');
  pdf.setFontSize(8.5);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(255, 255, 255);
  pdf.text('Qt\u00E9', colQty + 2, y + 6.5);
  pdf.text('D\u00E9signation', colDesc, y + 6.5);
  pdf.text('P.U. HT', colPU, y + 6.5, { align: 'right' });
  pdf.text('TOTAL HT', colTotal, y + 6.5, { align: 'right' });
  y += 12;

  const footerReserved = 90;
  let rowAlt = false;

  (lines || []).forEach((line) => {
    if (y > pageHeight - footerReserved - 10) {
      pdf.addPage();
      y = margin + 10;
    }
    if (line.isDevice) {
      // Device sub-header ‚Äî light bg, no vertical accent bar
      pdf.setFillColor(240, 243, 250);
      pdf.rect(margin, y - 4, contentWidth, 7.5, 'F');
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...navy);
      pdf.text(line.description, colDesc - 2, y);
      y += 7;
      rowAlt = false;
    } else {
      if (rowAlt) {
        pdf.setFillColor(252, 253, 255);
        pdf.rect(margin, y - 4, contentWidth, 7, 'F');
      }
      rowAlt = !rowAlt;
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...darkGray);
      if (line.quantity != null) pdf.text(String(line.quantity), colQty + 5, y, { align: 'center' });
      pdf.text(line.description || '', colDesc, y);
      if (line.unitPrice != null) pdf.text(parseFloat(line.unitPrice).toFixed(2) + ' \u20AC', colPU, y, { align: 'right' });
      if (line.total != null) {
        pdf.setFont('helvetica', 'bold');
        pdf.text(parseFloat(line.total).toFixed(2) + ' \u20AC', colTotal, y, { align: 'right' });
      }
      pdf.setDrawColor(235, 238, 242);
      pdf.setLineWidth(0.15);
      pdf.line(colDesc, y + 2.5, pageWidth - margin, y + 2.5);
      y += 7;
    }
  });

  y += 6;

  // ---- TOTALS ----
  const totalsW = 72;
  const totalsX = pageWidth - margin - totalsW;
  const totalsValX = pageWidth - margin - 4;

  pdf.setDrawColor(...lightLine);
  pdf.setLineWidth(0.3);
  pdf.line(totalsX, y, pageWidth - margin, y);
  y += 6;

  pdf.setFontSize(9.5);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...darkGray);
  pdf.text('Total HT', totalsX + 3, y);
  pdf.setFont('helvetica', 'bold');
  pdf.text((subtotalHT || 0).toFixed(2) + ' \u20AC', totalsValX, y, { align: 'right' });
  y += 7;

  if (isExonerated) {
    pdf.setFont('helvetica', 'normal');
    pdf.text('TVA 20%', totalsX + 3, y);
    pdf.setFontSize(8);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...medGray);
    pdf.text('EXON\u00C9R\u00C9', totalsValX, y, { align: 'right' });
    y += 4;
    pdf.setFontSize(7);
    pdf.setFont('helvetica', 'normal');
    pdf.text('Exon\u00E9ration TVA \u2014 Art. 262-I du CGI', totalsValX, y, { align: 'right' });
    y += 7;
  } else {
    pdf.setFontSize(9.5);
    pdf.setFont('helvetica', 'normal');
    pdf.text('TVA ' + (tvaRate || 20) + '%', totalsX + 3, y);
    pdf.setFont('helvetica', 'bold');
    pdf.text((tvaAmount || 0).toFixed(2) + ' \u20AC', totalsValX, y, { align: 'right' });
    y += 7;
  }

  pdf.setFillColor(...navy);
  pdf.roundedRect(totalsX, y - 1.5, totalsW, 11, 2, 2, 'F');
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(255, 255, 255);
  pdf.text('TOTAL TTC', totalsX + 4, y + 6);
  pdf.text((totalTTC || 0).toFixed(2) + ' \u20AC', totalsValX - 3, y + 6, { align: 'right' });
  y += 16;

  // ---- PAYMENT REFERENCE DISCLAIMER ----
  pdf.setFillColor(245, 247, 252);
  pdf.setDrawColor(...navy);
  pdf.setLineWidth(0.4);
  pdf.roundedRect(margin, y, contentWidth, 10, 2, 2, 'FD');
  pdf.setFontSize(8.5);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...navy);
  pdf.text('Merci de mentionner la r\u00E9f\u00E9rence ' + (invoiceNumber || 'FACTURE') + ' lors de votre r\u00E8glement.', margin + 4, y + 6.5);
  y += 14;

  // ---- BANK DETAILS (no vertical accent bar) ----
  if (biz.iban && biz.iban.trim()) {
    const hasRIB = biz.rib && biz.rib.trim();
    const bankH = (biz.bank_name ? 5 : 0) + (hasRIB ? 5 : 0) + 16;
    
    pdf.setFillColor(248, 250, 252);
    pdf.setDrawColor(...lightLine);
    pdf.setLineWidth(0.3);
    pdf.roundedRect(margin, y - 2, contentWidth, bankH, 2, 2, 'FD');
    
    let bkX = margin + 5;
    let bkVX = margin + 38;
    let bkY = y + 3;
    
    pdf.setFontSize(8.5);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...navy);
    pdf.text('COORDONN\u00C9ES BANCAIRES', bkX, bkY);
    bkY += 5.5;
    
    pdf.setFontSize(9);
    pdf.setTextColor(...darkGray);
    if (biz.bank_name) {
      pdf.setFont('helvetica', 'normal');
      pdf.text('Banque :', bkX, bkY);
      pdf.setFont('helvetica', 'bold');
      pdf.text(biz.bank_name + (biz.bank_branch ? ' \u2014 ' + biz.bank_branch : ''), bkVX, bkY);
      bkY += 5;
    }
    
    if (hasRIB) {
      pdf.setFont('helvetica', 'normal');
      pdf.text('RIB :', bkX, bkY);
      pdf.setFont('helvetica', 'bold');
      pdf.text(biz.rib, bkVX, bkY);
      bkY += 5;
    }
    
    pdf.setFont('helvetica', 'normal');
    pdf.text('IBAN :', bkX, bkY);
    pdf.setFont('helvetica', 'bold');
    pdf.text(biz.iban, bkVX, bkY);
    
    if (biz.bic) {
      pdf.setFont('helvetica', 'normal');
      const bicLabelX = bkVX + pdf.getTextWidth(biz.iban) + 8;
      pdf.text('BIC :', bicLabelX, bkY);
      pdf.setFont('helvetica', 'bold');
      pdf.text(biz.bic, bicLabelX + 12, bkY);
    }
    
    y += bankH + 4;
  }

  // ---- CONDITIONS DE PAIEMENT (now after bank details) ----
  pdf.setFontSize(8.5);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...darkGray);
  pdf.text('Conditions de paiement : ' + (paymentTermsDays || 30) + ' jours date de facture, soit le ' + formatDateFull(dueDate), margin, y);
  y += 5;

  // ---- LEGAL TEXT (same size as conditions, readable) ----
  const legalText = biz.invoice_legal_text ||
    "En application des articles L441-6 et L441-3 du Code de commerce, en cas de retard de r\u00E8glement : Indemnit\u00E9 forfaitaire pour frais de recouvrement de 40\u20AC \u2022 P\u00E9nalit\u00E9 de retard \u00E0 compter du 31\u00E8me jour au taux de 12% l'an. Aucun escompte ne sera accord\u00E9 en cas de paiement anticip\u00E9. Tous nos prix sont exprim\u00E9s en euro.";
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...medGray);
  pdf.text(pdf.splitTextToSize(legalText, contentWidth), margin, y);

  // ---- FOOTER (centered layout) ----
  const footerTopY = pageHeight - 36;
  const fcx = pageWidth / 2;
  
  // CAPCERT logo ‚Äî centered above text
  try {
    const capcertImg = new Image();
    capcertImg.crossOrigin = 'anonymous';
    capcertImg.src = '/images/logos/capcert-logo.png';
    await new Promise((res, rej) => { capcertImg.onload = res; capcertImg.onerror = rej; setTimeout(rej, 1500); });
    pdf.addImage(capcertImg, 'PNG', margin, footerTopY - 5, 30, 28);
  } catch(e) {}
  
  // Short centered line ‚Äî starts after capcert, ends before right margin
  pdf.setDrawColor(...lightLine);
  pdf.setLineWidth(0.4);
  pdf.line(margin + 36, footerTopY + 1, pageWidth - margin, footerTopY + 1);
  
  const textCx = pageWidth / 2 - 2;
  
  pdf.setFontSize(9.5);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...navy);
  pdf.text(biz.company_name || 'Lighthouse France SAS', textCx, footerTopY + 7, { align: 'center' });
  
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(8);
  pdf.setTextColor(...darkGray);
  pdf.text(
    (biz.address || '16 rue Paul S\u00E9journ\u00E9') + ', ' + (biz.postal_code || '94000') + ' ' + (biz.city || 'CR\u00C9TEIL') + ' | T\u00E9l. ' + (biz.phone || '01 43 77 28 07'),
    textCx, footerTopY + 13, { align: 'center' }
  );
  pdf.setFontSize(8);
  pdf.text(
    'SIRET ' + (biz.siret || '50178134800013') + ' | TVA ' + (biz.tva || 'FR 86501781348') + ' | Capital ' + (biz.capital || '10 000') + ' \u20AC',
    textCx, footerTopY + 19, { align: 'center' }
  );
  pdf.setFontSize(8);
  pdf.setTextColor(...medGray);
  pdf.text(
    (biz.email || 'France@golighthouse.com') + ' | ' + (biz.website || 'www.golighthouse.fr'),
    textCx, footerTopY + 25, { align: 'center' }
  );

  return pdf.output('blob');
};


// Generate Bon de Livraison PDF - PROFESSIONAL FORMAT
const generateBLPDF = async (rma, devices, shipment, blNumber, businessSettings, bcNumbers) => {
  const jsPDF = await loadJsPDF();
  const pdf = new jsPDF('p', 'mm', 'a4');
  const company = rma.companies || {};
  const address = shipment.address || {};
  const biz = businessSettings || {};
  
  const pageWidth = 210, pageHeight = 297, margin = 15;
  const contentWidth = pageWidth - (margin * 2);
  const footerHeight = 12; // Smaller footer, positioned at very bottom
  const { darkBlue, gray, lightGray, white } = PDF_COLORS;
  
  let y = margin;
  
  // Normalize bcNumbers to array
  const bcList = Array.isArray(bcNumbers) ? bcNumbers.filter(Boolean) : (bcNumbers ? [bcNumbers] : []);
  
  let lighthouseLogo = await loadImageAsBase64('/images/logos/lighthouse-logo.png');
  let capcertLogo = await loadImageAsBase64('/images/logos/capcert-logo.png');
  
  const addFooter = () => {
    // Footer section at the ABSOLUTE bottom of A4 page (297mm)
    // A4 = 297mm height, we want footer to end at 297mm with small margin
    const footerBottomMargin = 8; // 8mm from absolute bottom
    const footerHeight = 30; // Total footer section height
    const footerTopY = pageHeight - footerBottomMargin - footerHeight; // ~259mm
    
    // Separator line
    pdf.setDrawColor(51, 51, 51);
    pdf.setLineWidth(0.5);
    pdf.line(margin, footerTopY, pageWidth - margin, footerTopY);
    
    // Capcert logo on left
    if (capcertLogo) {
      try {
        const format = capcertLogo.includes('image/png') ? 'PNG' : 'JPEG';
        pdf.addImage(capcertLogo, format, margin + 5, footerTopY + 2, 25, 25);
      } catch (e) {}
    }
    
    // Company info centered
    const infoX = pageWidth / 2 + 10; // Offset slightly right to account for logo
    const infoStartY = footerTopY + 6;
    
    pdf.setFontSize(8);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text(`${biz.company_name || 'Lighthouse France SAS'} au capital de ${biz.capital || '10 000'} ‚Ç¨`, infoX, infoStartY, { align: 'center' });
    
    pdf.setFontSize(7);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...gray);
    pdf.text(`${biz.address || '16 rue Paul S√©journ√©'}, ${biz.postal_code || '94000'} ${biz.city || 'CR√âTEIL'} | T√©l. ${biz.phone || '01 43 77 28 07'}`, infoX, infoStartY + 5, { align: 'center' });
    pdf.text(`SIRET ${biz.siret || '50178134800013'} | TVA FR ${biz.tva || '86501781348'}`, infoX, infoStartY + 10, { align: 'center' });
    pdf.text(`${biz.email || 'France@golighthouse.com'} | ${biz.website || 'www.golighthouse.fr'}`, infoX, infoStartY + 15, { align: 'center' });
  };

  // ===== HEADER =====
  if (lighthouseLogo) {
    try {
      const format = lighthouseLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(lighthouseLogo, format, margin, y - 2, 85, 22);
    } catch (e) {
      pdf.setFontSize(26);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...darkBlue);
      pdf.text('LIGHTHOUSE', margin, y + 8);
    }
  } else {
    pdf.setFontSize(26);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text('LIGHTHOUSE', margin, y + 8);
  }
  
  // Title - BLACK instead of green
  pdf.setFontSize(18);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('BON DE LIVRAISON', pageWidth - margin, y + 5, { align: 'right' });
  
  // Document number (BL-0226-001)
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('N¬∞ ' + (blNumber || '‚Äî'), pageWidth - margin, y + 11, { align: 'right' });
  
  // RMA reference
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  if (rma.request_number) {
    pdf.text('RMA: ' + rma.request_number, pageWidth - margin, y + 16, { align: 'right' });
  }
  
  y += 20;
  pdf.setDrawColor(...darkBlue);
  pdf.setLineWidth(0.5);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 8;

  // ===== DATE LINE =====
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text('CR√âTEIL, le ' + new Date().toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }), margin, y);
  y += 10;

  // ===== TWO COLUMN LAYOUT: DESTINATAIRE + R√âF√âRENCES =====
  const boxHeight = 42;
  const leftBoxWidth = contentWidth * 0.6 - 5;
  const rightBoxWidth = contentWidth * 0.4 - 5;
  const rightBoxX = margin + leftBoxWidth + 10;
  
  // DESTINATAIRE box (left)
  pdf.setFillColor(248, 248, 248);
  pdf.setDrawColor(220, 220, 220);
  pdf.setLineWidth(0.3);
  pdf.rect(margin, y, leftBoxWidth, boxHeight, 'FD');
  pdf.setFontSize(8);
  pdf.setTextColor(...darkBlue);
  pdf.setFont('helvetica', 'bold');
  pdf.text('DESTINATAIRE', margin + 5, y + 6);
  pdf.setFontSize(11);
  pdf.text(address.company_name || company.name || 'N/A', margin + 5, y + 14);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  let addrY = y + 20;
  if (address.attention) { pdf.text("√Ä l'attention de: " + address.attention, margin + 5, addrY); addrY += 5; }
  pdf.text(address.address_line1 || '', margin + 5, addrY); addrY += 5;
  pdf.text((address.postal_code || '') + ' ' + (address.city || '').toUpperCase(), margin + 5, addrY); addrY += 5;
  pdf.text(address.country || 'France', margin + 5, addrY);
  
  // R√âF√âRENCES COMMANDE box (right)
  pdf.setFillColor(248, 248, 248);
  pdf.setDrawColor(220, 220, 220);
  pdf.rect(rightBoxX, y, rightBoxWidth, boxHeight, 'FD');
  pdf.setFontSize(8);
  pdf.setTextColor(...darkBlue);
  pdf.setFont('helvetica', 'bold');
  pdf.text('R√âF√âRENCES COMMANDE', rightBoxX + 5, y + 6);
  
  let refY = y + 14;
  if (bcList.length > 0) {
    bcList.forEach((bc, i) => {
      pdf.setFontSize(10);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...darkBlue);
      pdf.text(bc, rightBoxX + 5, refY);
      refY += 6;
    });
  } else {
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...gray);
    pdf.text('‚Äî', rightBoxX + 5, refY);
  }
  
  y += boxHeight + 10;

  // ===== DEVICES TABLE =====
  const rowH = 10;
  
  // Header
  pdf.setFillColor(...darkBlue);
  pdf.rect(margin, y, contentWidth, 9, 'F');
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...white);
  pdf.text('Qt√©', margin + 5, y + 6);
  pdf.text('D√©signation', margin + 20, y + 6);
  pdf.text('N¬∞ S√©rie', margin + 115, y + 6);
  pdf.text('Service', margin + 155, y + 6);
  y += 9;

  const devicesToList = shipment.devices || devices;
  devicesToList.forEach((d, idx) => {
    pdf.setFillColor(idx % 2 === 0 ? 255 : 250, idx % 2 === 0 ? 255 : 250, idx % 2 === 0 ? 255 : 250);
    pdf.rect(margin, y, contentWidth, rowH, 'F');
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text('1', margin + 7, y + 7);
    pdf.setFont('helvetica', 'normal');
    const deviceName = 'Compteur de particules LIGHTHOUSE ' + (d.model_name || d.model || '');
    pdf.text(deviceName.substring(0, 50), margin + 20, y + 7);
    pdf.setFont('courier', 'normal');
    pdf.text(d.serial_number || d.serial || '', margin + 115, y + 7);
    pdf.setFont('helvetica', 'normal');
    const svc = d.calibration_type || (d.service_type === 'calibration' ? t('calibration') : d.service_type === 'repair' ? t('repair') : d.service_type || t('calibration'));
    pdf.text(svc, margin + 155, y + 7);
    y += rowH;
  });
  
  y += 8;

  // ===== SHIPPING INFO =====
  pdf.setDrawColor(...darkBlue);
  pdf.setLineWidth(0.3);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 8;
  
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text("Informations d'exp√©dition", margin, y);
  y += 8;
  
  // Shipping details in two columns
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  
  pdf.text('Transporteur:', margin, y);
  pdf.setFont('helvetica', 'bold');
  pdf.text(shipment.carrier || 'UPS', margin + 30, y);
  
  pdf.setFont('helvetica', 'normal');
  if (shipment.carrier === 'Client') {
    pdf.text('Mode:', margin + 60, y);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Enlevement client', margin + 75, y);
  } else {
    pdf.text('N¬∞ de suivi:', margin + 60, y);
    pdf.setFont('courier', 'bold');
    pdf.text(shipment.trackingNumber || 'N/A', margin + 85, y);
  }
  
  y += 8;
  
  pdf.setFont('helvetica', 'normal');
  pdf.text('Nombre de colis:', margin, y);
  pdf.setFont('helvetica', 'bold');
  pdf.text(String(shipment.parcels || 1), margin + 35, y);
  
  pdf.setFont('helvetica', 'normal');
  pdf.text('Poids:', margin + 60, y);
  pdf.setFont('helvetica', 'bold');
  pdf.text((shipment.weight || '1.0') + ' kg', margin + 75, y);
  
  y += 8;
  
  pdf.setFont('helvetica', 'normal');
  pdf.text('Pr√©par√© par:', margin, y);
  pdf.setFont('helvetica', 'bold');
  pdf.text(biz.prepared_by || 'M. Meleney', margin + 30, y);

  // ===== WATERMARK - faded lighthouse text =====
  pdf.setTextColor(240, 240, 240);
  pdf.setFontSize(50);
  pdf.setFont('helvetica', 'bold');
  pdf.text('LIGHTHOUSE', pageWidth / 2, pageHeight / 2 + 30, { align: 'center' });
  pdf.setFontSize(20);
  pdf.text('WORLDWIDE SOLUTIONS', pageWidth / 2, pageHeight / 2 + 45, { align: 'center' });

  addFooter();
  return pdf.output('blob');
};

// Generate Parts Order Bon de Livraison PDF - PROFESSIONAL FORMAT (matches RMA BL)
const generatePartsBLPDF = async (order, parts, shipment, blNumber, businessSettings) => {
  const jsPDF = await loadJsPDF();
  const pdf = new jsPDF('p', 'mm', 'a4');
  const company = order.companies || {};
  const address = shipment.address || {};
  const biz = businessSettings || {};
  
  const pageWidth = 210, pageHeight = 297, margin = 15;
  const contentWidth = pageWidth - (margin * 2);
  const footerHeight = 12;
  const { darkBlue, gray, lightGray, white } = PDF_COLORS;
  
  let y = margin;
  
  let lighthouseLogo = await loadImageAsBase64('/images/logos/lighthouse-logo.png');
  let capcertLogo = await loadImageAsBase64('/images/logos/capcert-logo.png');
  
  const addFooter = () => {
    // Footer section at the ABSOLUTE bottom of A4 page (297mm)
    const footerBottomMargin = 8;
    const footerHeight = 30;
    const footerTopY = pageHeight - footerBottomMargin - footerHeight; // ~259mm
    
    // Separator line
    pdf.setDrawColor(51, 51, 51);
    pdf.setLineWidth(0.5);
    pdf.line(margin, footerTopY, pageWidth - margin, footerTopY);
    
    // Capcert logo on left
    if (capcertLogo) {
      try {
        const format = capcertLogo.includes('image/png') ? 'PNG' : 'JPEG';
        pdf.addImage(capcertLogo, format, margin + 5, footerTopY + 2, 25, 25);
      } catch (e) {}
    }
    
    // Company info centered
    const infoX = pageWidth / 2 + 10;
    const infoStartY = footerTopY + 6;
    
    pdf.setFontSize(8);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text(`${biz.company_name || 'Lighthouse France SAS'} au capital de ${biz.capital || '10 000'} ‚Ç¨`, infoX, infoStartY, { align: 'center' });
    
    pdf.setFontSize(7);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...gray);
    pdf.text(`${biz.address || '16 rue Paul S√©journ√©'}, ${biz.postal_code || '94000'} ${biz.city || 'CR√âTEIL'} | T√©l. ${biz.phone || '01 43 77 28 07'}`, infoX, infoStartY + 5, { align: 'center' });
    pdf.text(`SIRET ${biz.siret || '50178134800013'} | TVA FR ${biz.tva || '86501781348'}`, infoX, infoStartY + 10, { align: 'center' });
    pdf.text(`${biz.email || 'France@golighthouse.com'} | ${biz.website || 'www.golighthouse.fr'}`, infoX, infoStartY + 15, { align: 'center' });
  };

  // ===== HEADER =====
  if (lighthouseLogo) {
    try {
      const format = lighthouseLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(lighthouseLogo, format, margin, y - 2, 85, 22);
    } catch (e) {
      pdf.setFontSize(26);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...darkBlue);
      pdf.text('LIGHTHOUSE', margin, y + 8);
    }
  } else {
    pdf.setFontSize(26);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text('LIGHTHOUSE', margin, y + 8);
  }
  
  // Title - BLACK
  pdf.setFontSize(18);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('BON DE LIVRAISON', pageWidth - margin, y + 5, { align: 'right' });
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.text('N¬∞ ' + blNumber, pageWidth - margin, y + 11, { align: 'right' });
  pdf.setFontSize(9);
  pdf.setTextColor(...gray);
  pdf.text('Pi√®ces D√©tach√©es', pageWidth - margin, y + 17, { align: 'right' });
  
  y += 20;
  pdf.setDrawColor(...darkBlue);
  pdf.setLineWidth(0.5);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 8;

  // ===== DATE LINE =====
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text('CR√âTEIL, le ' + new Date().toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }), margin, y);
  y += 10;

  // ===== TWO COLUMN LAYOUT: DESTINATAIRE + R√âF√âRENCES =====
  const boxHeight = 42;
  const leftBoxWidth = contentWidth * 0.6 - 5;
  const rightBoxWidth = contentWidth * 0.4 - 5;
  const rightBoxX = margin + leftBoxWidth + 10;
  
  // DESTINATAIRE box (left)
  pdf.setFillColor(248, 248, 248);
  pdf.setDrawColor(220, 220, 220);
  pdf.setLineWidth(0.3);
  pdf.rect(margin, y, leftBoxWidth, boxHeight, 'FD');
  pdf.setFontSize(8);
  pdf.setTextColor(...darkBlue);
  pdf.setFont('helvetica', 'bold');
  pdf.text('DESTINATAIRE', margin + 5, y + 6);
  pdf.setFontSize(11);
  pdf.text(address.company_name || company.name || 'N/A', margin + 5, y + 14);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  let addrY = y + 20;
  if (address.attention) { pdf.text("√Ä l'attention de: " + address.attention, margin + 5, addrY); addrY += 5; }
  pdf.text(address.address_line1 || '', margin + 5, addrY); addrY += 5;
  pdf.text((address.postal_code || '') + ' ' + (address.city || '').toUpperCase(), margin + 5, addrY); addrY += 5;
  pdf.text(address.country || 'France', margin + 5, addrY);
  
  // R√âF√âRENCES COMMANDE box (right)
  pdf.setFillColor(248, 248, 248);
  pdf.setDrawColor(220, 220, 220);
  pdf.rect(rightBoxX, y, rightBoxWidth, boxHeight, 'FD');
  pdf.setFontSize(8);
  pdf.setTextColor(...darkBlue);
  pdf.setFont('helvetica', 'bold');
  pdf.text('R√âF√âRENCES COMMANDE', rightBoxX + 5, y + 6);
  pdf.setFontSize(10);
  pdf.text(order.bc_number || order.request_number || '‚Äî', rightBoxX + 5, y + 14);
  
  y += boxHeight + 10;

  // ===== PARTS TABLE =====
  const rowH = 10;
  
  // Header
  pdf.setFillColor(...darkBlue);
  pdf.rect(margin, y, contentWidth, 9, 'F');
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...white);
  pdf.text('Qt√©', margin + 5, y + 6);
  pdf.text('R√©f√©rence', margin + 20, y + 6);
  pdf.text('D√©signation', margin + 70, y + 6);
  y += 9;

  // Part rows
  parts.forEach((p, idx) => {
    pdf.setFillColor(idx % 2 === 0 ? 255 : 250, idx % 2 === 0 ? 255 : 250, idx % 2 === 0 ? 255 : 250);
    pdf.rect(margin, y, contentWidth, rowH, 'F');
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text(String(p.quantity || 1), margin + 7, y + 7);
    pdf.setFont('courier', 'normal');
    pdf.setTextColor(...gray);
    pdf.text(p.partNumber || '‚Äî', margin + 20, y + 7);
    pdf.setFont('helvetica', 'normal');
    const desc = (p.description || '').substring(0, 60);
    pdf.text(desc, margin + 70, y + 7);
    y += rowH;
  });
  
  y += 8;

  // ===== SHIPPING INFO =====
  pdf.setDrawColor(...darkBlue);
  pdf.setLineWidth(0.3);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 8;
  
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text("Informations d'exp√©dition", margin, y);
  y += 8;
  
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  
  pdf.text('Transporteur:', margin, y);
  pdf.setFont('helvetica', 'bold');
  pdf.text('UPS', margin + 30, y);
  
  pdf.setFont('helvetica', 'normal');
  pdf.text('N¬∞ de suivi:', margin + 60, y);
  pdf.setFont('courier', 'bold');
  pdf.text(shipment.trackingNumber || 'N/A', margin + 85, y);
  
  y += 8;
  
  pdf.setFont('helvetica', 'normal');
  pdf.text('Nombre de colis:', margin, y);
  pdf.setFont('helvetica', 'bold');
  pdf.text(String(shipment.parcels || 1), margin + 35, y);
  
  pdf.setFont('helvetica', 'normal');
  pdf.text('Poids:', margin + 60, y);
  pdf.setFont('helvetica', 'bold');
  pdf.text((shipment.weight || '1.0') + ' kg', margin + 75, y);

  // ===== WATERMARK =====
  pdf.setTextColor(240, 240, 240);
  pdf.setFontSize(50);
  pdf.setFont('helvetica', 'bold');
  pdf.text('LIGHTHOUSE', pageWidth / 2, pageHeight / 2 + 30, { align: 'center' });
  pdf.setFontSize(20);
  pdf.text('WORLDWIDE SOLUTIONS', pageWidth / 2, pageHeight / 2 + 45, { align: 'center' });

  addFooter();
  return pdf.output('blob');
};

// Generate UPS Label PDF - PROFESSIONAL FORMAT
const generateUPSLabelPDF = async (rma, shipment) => {
  const jsPDF = await loadJsPDF();
  const pdf = new jsPDF('p', 'mm', 'a4');
  const address = shipment.address || {};
  
  const pageWidth = 210;
  const { darkBlue, gray, white } = PDF_COLORS;
  
  // UPS Brown color
  const upsBrown = [53, 28, 21];
  
  let y = 30;
  
  // UPS Header
  pdf.setFillColor(...upsBrown);
  pdf.rect(30, y, 150, 25, 'F');
  pdf.setTextColor(...white);
  pdf.setFontSize(36);
  pdf.setFont('helvetica', 'bold');
  pdf.text('UPS', 105, y + 17, { align: 'center' });
  y += 30;
  
  // Tracking number box
  pdf.setFillColor(245, 245, 245);
  pdf.rect(30, y, 150, 20, 'F');
  pdf.setDrawColor(...upsBrown);
  pdf.setLineWidth(2);
  pdf.rect(30, y, 150, 20, 'D');
  pdf.setTextColor(...darkBlue);
  pdf.setFontSize(18);
  pdf.setFont('courier', 'bold');
  pdf.text(shipment.trackingNumber || 'TRACKING NUMBER', 105, y + 13, { align: 'center' });
  y += 28;
  
  // Barcode representation
  pdf.setFillColor(0, 0, 0);
  for (let i = 0; i < 50; i++) {
    const x = 40 + i * 2.5;
    const height = 15 + Math.random() * 10;
    const width = Math.random() > 0.5 ? 1.5 : 0.8;
    pdf.rect(x, y, width, height, 'F');
  }
  y += 35;
  
  // TO Address
  pdf.setDrawColor(...darkBlue);
  pdf.setLineWidth(1);
  pdf.rect(30, y, 150, 55, 'D');
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...gray);
  pdf.text('DESTINATAIRE / TO:', 35, y + 8);
  
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(address.company_name || '', 35, y + 18);
  
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'normal');
  if (address.attention) {
    pdf.text("√Ä l'att.: " + address.attention, 35, y + 26);
  }
  pdf.text(address.address_line1 || '', 35, y + 34);
  pdf.setFont('helvetica', 'bold');
  pdf.text((address.postal_code || '') + ' ' + (address.city || ''), 35, y + 42);
  pdf.text(address.country || 'France', 35, y + 50);
  y += 62;
  
  // FROM Address
  pdf.setDrawColor(...gray);
  pdf.setLineWidth(0.5);
  pdf.rect(30, y, 150, 45, 'D');
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...gray);
  pdf.text('EXP√âDITEUR / FROM:', 35, y + 8);
  
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('LIGHTHOUSE FRANCE', 35, y + 18);
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.text('16 rue Paul S√©journ√©', 35, y + 26);
  pdf.text('94000 Cr√©teil, France', 35, y + 34);
  y += 52;
  
  // Package info
  pdf.setFillColor(...upsBrown);
  pdf.rect(30, y, 150, 20, 'F');
  pdf.setTextColor(...white);
  pdf.setFontSize(16);
  pdf.setFont('helvetica', 'bold');
  pdf.text((shipment.parcels || 1) + ' COLIS', 65, y + 13);
  pdf.text((shipment.weight || '1') + ' KG', 145, y + 13);
  y += 28;
  
  // Reference
  pdf.setFontSize(10);
  pdf.setTextColor(...gray);
  pdf.setFont('helvetica', 'normal');
  pdf.text('R√©f: ' + (rma.request_number || ''), 105, y, { align: 'center' });
  
  return pdf.output('blob');
};

// Upload PDF to Supabase Storage
const uploadPDFToStorage = async (blob, folder, filename) => {
  try {
    const file = new File([blob], filename, { type: 'application/pdf' });
    const filePath = `${folder}/${filename}`;
    
    const { error: uploadError } = await supabase.storage
      .from('documents')
      .upload(filePath, file, { upsert: true });
    
    if (uploadError) throw uploadError;
    
    const { data: { publicUrl } } = supabase.storage
      .from('documents')
      .getPublicUrl(filePath);
    
    return publicUrl;
  } catch (err) {
    console.error('PDF upload error:', err);
    throw err;
  }
};

// ============================================
// RENTAL QUOTE PDF GENERATOR
// ============================================
const generateRentalQuotePDF = async (rental, quoteData, businessSettings = {}) => {
  const jsPDF = await loadJsPDF();
  const pdf = new jsPDF('p', 'mm', 'a4');
  const biz = businessSettings || {};
  const qd = quoteData || {};
  const company = rental.companies || {};
  const items = qd.quoteItems || qd.items || [];
  const period = qd.rentalPeriod || { start: rental.start_date, end: rental.end_date, days: Math.ceil((new Date(rental.end_date) - new Date(rental.start_date)) / (1000*60*60*24)) + 1 };

  // French date formatter: "19 f√©vrier 2026"
  const formatDateFR = (d) => {
    const date = new Date(d);
    const months = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
    return date.getDate() + ' ' + months[date.getMonth()] + ' ' + date.getFullYear();
  };

  const pageWidth = 210, pageHeight = 297, margin = 15;
  const contentWidth = pageWidth - (margin * 2);
  const footerHeight = 16;
  const { navy, darkBlue, gray, lightGray, white } = PDF_COLORS;
  
  let y = 8;

  let lighthouseLogo = await loadImageAsBase64('/images/logos/Lighthouse-color-logo.jpg');
  let capcertLogo = await loadImageAsBase64('/images/logos/capcert-logo.png');

  const addFooter = () => {
    pdf.setFillColor(...darkBlue);
    pdf.rect(0, pageHeight - footerHeight, pageWidth, footerHeight, 'F');
    pdf.setTextColor(...white);
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.text(biz.company_name || 'Lighthouse France SAS', pageWidth / 2, pageHeight - footerHeight + 6, { align: 'center' });
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(180, 180, 180);
    pdf.setFontSize(8);
    pdf.text(`${biz.address || '16, rue Paul Sejourne'} - ${biz.postal_code || '94000'} ${biz.city || 'CRETEIL'} - Tel. ${biz.phone || '01 43 77 28 07'}`, pageWidth / 2, pageHeight - footerHeight + 11, { align: 'center' });
  };

  const getUsableHeight = () => pageHeight - footerHeight - margin;

  const checkPageBreak = (needed) => {
    if (y + needed > getUsableHeight()) { addFooter(); pdf.addPage(); y = margin; return true; }
    return false;
  };

  // ===== HEADER =====
  if (lighthouseLogo) {
    try {
      const format = lighthouseLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(lighthouseLogo, format, margin, y - 5, 80, 20);
    } catch (e) {
      pdf.setFontSize(24); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(...darkBlue);
      pdf.text('LIGHTHOUSE', margin, y + 8);
    }
  } else {
    pdf.setFontSize(24); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(...darkBlue);
    pdf.text('LIGHTHOUSE', margin, y + 8);
  }

  pdf.setFontSize(18);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...navy);
  pdf.text('DEVIS LOCATION', pageWidth - margin, y + 5, { align: 'right' });

  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('N\u00B0 ' + (rental.quote_number || rental.rental_number || '\u2014'), pageWidth - margin, y + 11, { align: 'right' });
  if (rental.quote_number && rental.rental_number) {
    pdf.setFontSize(8);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...lightGray);
    pdf.text('R√©f: ' + rental.rental_number, pageWidth - margin, y + 15, { align: 'right' });
  }

  y += 17;
  pdf.setDrawColor(...navy);
  pdf.setLineWidth(1);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 3;

  // ===== INFO BAR =====
  pdf.setFillColor(245, 245, 245);
  pdf.rect(margin, y, contentWidth, 16, 'F');
  pdf.setFontSize(7);
  pdf.setTextColor(...lightGray);
  pdf.text('DATE', margin + 5, y + 4);
  pdf.text('VALIDITE', margin + 65, y + 4);
  pdf.text('CONDITIONS', margin + 120, y + 4);
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(formatDateFR(new Date()), margin + 5, y + 11);
  pdf.text('30 jours', margin + 65, y + 11);
  pdf.setFontSize(9);
  pdf.text(qd.paymentTerms || 'A reception de facture', margin + 120, y + 11);
  y += 20;

  // ===== CLIENT =====
  pdf.setFontSize(7);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...lightGray);
  pdf.text('CLIENT', margin, y);
  y += 5;
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(qd.clientName || company.name || 'Client', margin, y);
  y += 6;
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  const addr = qd.clientAddress || company.billing_address || company.address || '';
  if (addr) { pdf.text(addr, margin, y); y += 5; }
  const cityLine = [qd.clientPostalCode || company.billing_postal_code || company.postal_code, qd.clientCity || company.billing_city || company.city].filter(Boolean).join(' ');
  if (cityLine) { pdf.text(cityLine, margin, y); y += 5; }
  y += 5;

  // ===== RENTAL PERIOD BLOCK =====
  checkPageBreak(16);
  const periodStartY = y;
  pdf.setDrawColor(139, 92, 246);
  pdf.setLineWidth(1);
  
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('Location de Materiel', margin + 5, y + 4);
  y += 11;
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text('- Periode: du ' + formatDateFR(period.start) + ' au ' + formatDateFR(period.end) + ' (' + period.days + ' jours)', margin + 9, y);
  y += 5;
  if (qd.deliveryTerms) {
    pdf.text('- Delai de livraison: ' + qd.deliveryTerms, margin + 9, y);
    y += 5;
  }
  pdf.text('- Assurance \u00AB Bien Confie \u00BB obligatoire (vol, incendie, degats des eaux, bris accidentel)', margin + 9, y);
  y += 3;
  // Draw purple border line to match actual height
  pdf.line(margin, periodStartY, margin, y);
  y += 8;

  // ===== PRICING TABLE =====
  const rowH = 7;
  const colQty = margin;
  const colDesc = margin + 12;
  const colRate = pageWidth - margin - 68;
  const colDuration = pageWidth - margin - 38;
  const colTotal = pageWidth - margin - 3;

  const drawTableHeader = () => {
    pdf.setFillColor(...darkBlue);
    pdf.rect(margin, y, contentWidth, 9, 'F');
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...white);
    pdf.text('Qte', colQty + 3, y + 6);
    pdf.text('Designation', colDesc, y + 6);
    pdf.text('Tarif', colRate, y + 6, { align: 'right' });
    pdf.text('Duree', colDuration, y + 6, { align: 'right' });
    pdf.text('Total HT', colTotal, y + 6, { align: 'right' });
    y += 9;
  };

  const checkTablePageBreak = (needed) => {
    if (y + needed > getUsableHeight()) { addFooter(); pdf.addPage(); y = margin; drawTableHeader(); return true; }
    return false;
  };

  pdf.setFontSize(13);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('Recapitulatif des Prix', margin, y);
  y += 6;

  drawTableHeader();

  let rowIndex = 0;

  // Equipment rows
  items.forEach((item) => {
    const rateLabel = item.rate_type === 'semaine' ? '/sem' : item.rate_type === 'mois' ? '/mois' : item.rate_type === 'forfait' ? '' : '/jour';
    const appliedRate = parseFloat(item.applied_rate) || 0;
    const lineTotal = parseFloat(item.line_total) || 0;
    const retailVal = parseFloat(item.retail_value) || 0;
    const daysDisplay = (item.rental_days || period.days) + 'j';
    
    // Build device name - avoid duplicate serial
    const rawName = item.item_name || 'Equipement';
    const serial = item.serial_number || '';
    const nameHasSerial = serial && rawName.includes(serial);
    const deviceName = nameHasSerial ? rawName : (serial ? rawName + ' (SN: ' + serial + ')' : rawName);
    
    // Specs/description
    const specs = item.specs || item.description || '';
    const hasSpecs = specs.length > 0;
    
    // Calculate row height: main line + specs line + insurance line
    const mainLineH = 7;
    const specsLineH = hasSpecs ? 5 : 0;
    const insuranceLineH = retailVal > 0 ? 5 : 0;
    const totalRowH = mainLineH + specsLineH + insuranceLineH + 2;
    
    checkTablePageBreak(totalRowH);
    
    // Row background
    pdf.setFillColor(rowIndex % 2 === 0 ? 255 : 248, rowIndex % 2 === 0 ? 255 : 248, rowIndex % 2 === 0 ? 255 : 248);
    pdf.rect(margin, y, contentWidth, totalRowH, 'F');
    
    // Main line: Qty, Name, Rate, Duration, Total
    const textY = y + 5;
    pdf.setFontSize(10);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...darkBlue);
    pdf.text('1', colQty + 3, textY);
    pdf.setFont('helvetica', 'bold');
    pdf.text(deviceName.substring(0, 52), colDesc, textY);
    
    pdf.setFont('helvetica', 'normal');
    if (appliedRate > 0) {
      pdf.text(appliedRate.toFixed(2) + ' EUR' + rateLabel, colRate, textY, { align: 'right' });
    }
    pdf.text(daysDisplay, colDuration, textY, { align: 'right' });
    pdf.setFont('helvetica', 'bold');
    pdf.text(lineTotal.toFixed(2) + ' EUR', colTotal, textY, { align: 'right' });
    
    let subY = textY + mainLineH;
    
    // Specs line (clean, spaced)
    if (hasSpecs) {
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(8);
      pdf.setTextColor(...lightGray);
      pdf.text(specs.substring(0, 80), colDesc, subY - 1);
      subY += specsLineH;
    }
    
    // Insurance value per device
    if (retailVal > 0) {
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'italic');
      pdf.setTextColor(...lightGray);
      pdf.text('Valeur neuf (assurance): ' + retailVal.toFixed(2) + ' EUR', colDesc, subY - 1);
    }
    
    y += totalRowH;
    rowIndex++;
  });

  // Shipping row
  const shippingVal = parseFloat(qd.shipping) || 0;
  if (shippingVal > 0) {
    checkTablePageBreak(rowH);
    pdf.setFillColor(245, 245, 245);
    pdf.rect(margin, y, contentWidth, rowH, 'F');
    pdf.setFontSize(9); pdf.setFont('helvetica', 'normal'); pdf.setTextColor(...darkBlue);
    pdf.text('1', colQty + 3, y + 5);
    pdf.text('Frais de port', colDesc, y + 5);
    pdf.text(shippingVal.toFixed(2) + ' EUR', colRate, y + 5, { align: 'right' });
    pdf.setFont('helvetica', 'bold');
    pdf.text(shippingVal.toFixed(2) + ' EUR', colTotal, y + 5, { align: 'right' });
    y += rowH;
  }

  // Discount row
  const discountAmount = parseFloat(qd.discountAmount) || 0;
  if (discountAmount > 0) {
    checkTablePageBreak(rowH);
    pdf.setFillColor(255, 251, 235);
    pdf.rect(margin, y, contentWidth, rowH, 'F');
    pdf.setFontSize(9); pdf.setFont('helvetica', 'normal'); pdf.setTextColor(180, 30, 30);
    pdf.text('1', colQty + 3, y + 5);
    pdf.text(qd.discountType === 'percent' ? 'Remise (' + qd.discount + '%)' : 'Remise', colDesc, y + 5);
    pdf.setFont('helvetica', 'bold');
    pdf.text('-' + discountAmount.toFixed(2) + ' EUR', colTotal, y + 5, { align: 'right' });
    y += rowH;
  }

  // ===== TOTAL ROW =====
  checkPageBreak(14);
  pdf.setFillColor(...navy);
  pdf.rect(margin, y, contentWidth, 12, 'F');
  pdf.setTextColor(...white);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.text('TOTAL HT', colDuration - 20, y + 8);
  pdf.setFontSize(16);
  pdf.text((qd.totalHT || 0).toFixed(2) + ' EUR', colTotal, y + 8, { align: 'right' });
  y += 16;

  // ===== CONDITIONS =====
  const RENTAL_CONDITIONS = [
    'Le materiel reste la propriete de Lighthouse France. La garde est transferee au client des reception jusqu\'a restitution.',
    'Utilisation conforme par personnel qualifie. Sous-location interdite sans accord ecrit. Tout incident doit etre signale sous 48h par ecrit.',
    'Le client doit souscrire une assurance \u00AB Bien Confie \u00BB couvrant: vol, incendie, degats des eaux, bris accidentel.',
    'Le materiel doit etre restitue en bon etat a la date convenue. Les dommages ou pieces manquantes seront factures au cout de remise en etat.',
    'Les jours de retard seront factures au tarif journalier majore de 50%. Lighthouse France pourra recuperer le materiel a tout moment.',
    'Le non-respect des conditions peut entrainer la resiliation immediate du contrat de location.'
  ];

  y += 5;
  checkPageBreak(8 + RENTAL_CONDITIONS.length * 5);
  pdf.setFontSize(8.5);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...lightGray);
  pdf.text('CONDITIONS GENERALES DE LOCATION', margin, y);
  y += 5;
  pdf.setFontSize(8.5);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  RENTAL_CONDITIONS.forEach((d, i) => {
    checkPageBreak(5);
    const wrapped = pdf.splitTextToSize((i + 1) + '. ' + d, contentWidth);
    wrapped.forEach(line => { checkPageBreak(4.5); pdf.text(line, margin, y); y += 4.5; });
  });

  // Notes
  if (qd.notes) {
    y += 2;
    checkPageBreak(10);
    pdf.setFontSize(7.5);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...lightGray);
    pdf.text('NOTES', margin, y);
    y += 3;
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...gray);
    const noteLines = pdf.splitTextToSize(qd.notes, contentWidth);
    noteLines.forEach(line => { checkPageBreak(3.5); pdf.text(line, margin, y); y += 3.5; });
  }

  // ===== SIGNATURE SECTION =====
  const signatureHeight = 36;
  const qs = biz.quote_settings || {};
  const signatoryName = qs.signatory_name || biz.quote_signatory || 'M. Meleney';
  const signatoryCompany = qs.signatory_company || biz.company_name || 'Lighthouse France';

  const signatureLimit = pageHeight - footerHeight - 2;
  if (y + signatureHeight > signatureLimit) { addFooter(); pdf.addPage(); y = margin; }

  const sigY = Math.max(y + 3, signatureLimit - signatureHeight);

  pdf.setDrawColor(200, 200, 200);
  pdf.setLineWidth(0.3);
  pdf.line(margin, sigY, pageWidth - margin, sigY);

  pdf.setFontSize(7);
  pdf.setTextColor(...lightGray);
  pdf.text('ETABLI PAR', margin, sigY + 6);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(signatoryName, margin, sigY + 12);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text(signatoryCompany, margin, sigY + 17);

  if (capcertLogo) {
    try {
      const format = capcertLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(capcertLogo, format, margin + 50, sigY + 2, 28, 28);
    } catch (e) {}
  }

  const sigBoxX = pageWidth - margin - 60;
  pdf.setFontSize(7);
  pdf.setTextColor(...lightGray);
  pdf.text('Signature client', sigBoxX + 16, sigY + 6);
  pdf.setDrawColor(180, 180, 180);
  pdf.setLineWidth(0.3);
  pdf.setLineDashPattern([2, 2], 0);
  pdf.roundedRect(sigBoxX + 5, sigY + 9, 50, 18, 2, 2, 'D');
  pdf.setLineDashPattern([], 0);
  pdf.text('Lu et approuve', sigBoxX + 17, sigY + 30);

  addFooter();

  const totalPages = pdf.internal.getNumberOfPages();
  if (totalPages > 1) {
    for (let i = 1; i <= totalPages; i++) {
      pdf.setPage(i);
      pdf.setFontSize(7);
      pdf.setTextColor(180, 180, 180);
      pdf.text('Page ' + i + ' / ' + totalPages, pageWidth - margin, pageHeight - 2, { align: 'right' });
    }
  }

  return pdf.output('blob');
};

// ============================================
// QUOTE REVIEW SYSTEM - Submit for review helper
// ============================================
const submitForQuoteReview = async ({
  serviceRequestId,
  quoteType, // 'initial', 'revision', 'supplement', 'parts', 'contract', 'rental'
  quoteData,
  quoteNumber,
  rmaNumber,
  clientName,
  totalAmount,
  deviceSummary,
  previousStatus,
  serviceRequestUpdate, // partial update for service_request (quote_data, totals, etc. but NOT status)
  profile,
  skipStatusChange // If true, don't change main RMA status (used for supplements)
}) => {
  // 1. Insert review record
  const { data: review, error: reviewError } = await supabase
    .from('quote_reviews')
    .insert({
      service_request_id: serviceRequestId,
      quote_type: quoteType,
      quote_data: quoteData,
      quote_number: quoteNumber,
      rma_number: rmaNumber,
      client_name: clientName,
      total_amount: totalAmount,
      device_summary: deviceSummary || '',
      submitted_by: profile?.id,
      submitted_by_name: profile?.full_name || profile?.email || 'Unknown',
      previous_status: previousStatus
    })
    .select()
    .single();
  
  if (reviewError) throw reviewError;
  
  // 2. Update service_request with quote data + pending review status
  const srUpdate = {
    ...serviceRequestUpdate,
    quote_review_id: review.id,
    quote_rejection_notes: null // Clear any previous rejection notes
  };
  
  // Only change main status for non-supplement reviews
  if (!skipStatusChange) {
    srUpdate.status = 'pending_quote_review';
  }
  
  const { error: updateError } = await supabase
    .from('service_requests')
    .update(srUpdate)
    .eq('id', serviceRequestId);
  
  if (updateError) throw updateError;
  
  return review;
};
// BL and REPORT PDF GENERATION - Using same jsPDF approach as Quote
// ============================================

// Generate BL PDF - Uses html2canvas to capture actual rendered HTML
const generateBLPDFFromHTML = async (bl, employeeName, businessSettings) => {
  // Load html2canvas if needed
  if (!window.html2canvas) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }
  
  const jsPDF = await loadJsPDF();
  const biz = businessSettings || {};

  // Create a temporary container with the exact BL HTML
  const container = document.createElement('div');
  container.style.position = 'absolute';
  container.style.left = '-9999px';
  container.style.top = '0';
  container.style.width = '210mm';
  container.style.minHeight = '297mm';
  container.style.background = 'white';
  container.style.fontFamily = 'Arial, sans-serif';
  container.style.fontSize = '11pt';
  container.style.color = '#333';
  container.style.padding = '15px 25px';
  container.style.boxSizing = 'border-box';
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  
  container.innerHTML = `
    <div style="flex: 1 0 auto;">
      <!-- Header -->
      <div style="margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #333;">
        <div style="font-size: 24px; font-weight: bold; color: #333;">LIGHTHOUSE<div style="font-size: 10px; color: #666;">FRANCE</div></div>
      </div>

      <!-- Title -->
      <div style="text-align: center; margin: 20px 0;">
        <h1 style="font-size: 20pt; font-weight: bold; color: #333; margin: 0;">BON DE LIVRAISON</h1>
        <div style="font-size: 14pt; color: #333; font-weight: bold; margin-top: 8px;">${bl.blNumber}</div>
      </div>

      <!-- Date & RMA Row -->
      <div style="display: flex; justify-content: space-between; margin: 12px 0;">
        <div><span style="color: #666;">${biz.city || 'Cr√©teil'}, le</span> <strong>${bl.date}</strong></div>
        <div><span style="color: #666;">RMA:</span> <strong>${bl.rmaNumber}</strong></div>
      </div>

      <!-- Client Box -->
      <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin: 12px 0;">
        <div style="font-size: 9pt; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 5px;">Destinataire</div>
        <div style="font-size: 12pt; font-weight: bold; margin-bottom: 5px;">${bl.client.name}</div>
        ${bl.client.attention ? `<div>√Ä l'attention de: <strong>${bl.client.attention}</strong></div>` : ''}
        <div>${bl.client.street}</div>
        <div>${bl.client.city}</div>
        <div>${bl.client.country}</div>
      </div>

      <!-- Devices Table -->
      <table style="width: 100%; border-collapse: collapse; margin: 12px 0;">
        <thead>
          <tr>
            <th style="background: rgba(51,51,51,0.35); color: #333; padding: 10px 12px; text-align: left; font-size: 10pt; font-weight: bold; border-bottom: 2px solid #333; width: 50px;">Qt√©</th>
            <th style="background: rgba(51,51,51,0.35); color: #333; padding: 10px 12px; text-align: left; font-size: 10pt; font-weight: bold; border-bottom: 2px solid #333;">D√©signation</th>
            <th style="background: rgba(51,51,51,0.35); color: #333; padding: 10px 12px; text-align: left; font-size: 10pt; font-weight: bold; border-bottom: 2px solid #333; width: 120px;">N¬∞ S√©rie</th>
            <th style="background: rgba(51,51,51,0.35); color: #333; padding: 10px 12px; text-align: left; font-size: 10pt; font-weight: bold; border-bottom: 2px solid #333; width: 100px;">Service</th>
          </tr>
        </thead>
        <tbody>
          ${bl.devices.map((d, idx) => `
            <tr>
              <td style="padding: 10px 12px; border-bottom: 1px solid #ddd; font-size: 10pt; ${idx % 2 === 1 ? 'background: #f9f9f9;' : ''} text-align: center; font-weight: 600;">1</td>
              <td style="padding: 10px 12px; border-bottom: 1px solid #ddd; font-size: 10pt; ${idx % 2 === 1 ? 'background: #f9f9f9;' : ''}">Compteur de particules LIGHTHOUSE ${d.model}</td>
              <td style="padding: 10px 12px; border-bottom: 1px solid #ddd; font-size: 10pt; ${idx % 2 === 1 ? 'background: #f9f9f9;' : ''} font-family: monospace;">${d.serial}</td>
              <td style="padding: 10px 12px; border-bottom: 1px solid #ddd; font-size: 10pt; ${idx % 2 === 1 ? 'background: #f9f9f9;' : ''}">${d.service}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <!-- Shipping Info -->
      <div style="margin: 15px 0;">
        <div style="font-weight: bold; font-size: 11pt; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">Informations d'exp√©dition</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div style="display: flex; padding: 6px 0;"><span style="color: #666; width: 130px;">Transporteur:</span><span style="font-weight: 600;">${bl.shipping.carrier}</span></div>
          <div style="display: flex; padding: 6px 0;"><span style="color: #666; width: 130px;">N¬∞ de suivi:</span><span style="font-weight: 600; font-family: monospace;">${bl.shipping.tracking}</span></div>
          <div style="display: flex; padding: 6px 0;"><span style="color: #666; width: 130px;">Nombre de colis:</span><span style="font-weight: 600;">${bl.shipping.parcels}</span></div>
          <div style="display: flex; padding: 6px 0;"><span style="color: #666; width: 130px;">Poids:</span><span style="font-weight: 600;">${bl.shipping.weight} kg</span></div>
        </div>
      </div>

      <!-- Prepared By -->
      <div style="font-size: 10pt; margin-top: 12px; color: #666;">
        Pr√©par√© par: <strong style="color: #333;">${employeeName}</strong>
      </div>
    </div>

    <!-- Footer -->
    <div style="flex-shrink: 0; margin-top: auto; padding-top: 15px; border-top: 2px solid #333;">
      <div style="display: flex; align-items: center; justify-content: center; gap: 30px;">
        <div style="font-size: 18px; color: #333; border: 2px solid #333; padding: 18px 24px; border-radius: 6px; text-align: center;"><strong>CAPCERT</strong><br>ISO 9001</div>
        <div style="font-size: 8pt; color: #555; text-align: center; line-height: 1.8;">
          <strong style="color: #333; font-size: 9pt;">${biz.company_name || 'Lighthouse France SAS'}</strong> au capital de ${biz.capital || '10 000'} ‚Ç¨<br>
          ${biz.address || '16 rue Paul S√©journ√©'}, ${biz.postal_code || '94000'} ${biz.city || 'CR√âTEIL'} | T√©l. ${biz.phone || '01 43 77 28 07'}<br>
          SIRET ${biz.siret || '50178134800013'} | TVA ${biz.tva || 'FR 86501781348'}<br>
          ${biz.email || 'France@golighthouse.com'} | ${biz.website || 'www.golighthouse.fr'}
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(container);

  try {
    const canvas = await window.html2canvas(container, { 
      scale: 2, 
      useCORS: true, 
      backgroundColor: '#ffffff',
      logging: false,
      width: container.offsetWidth,
      height: Math.max(container.offsetHeight, 1122)
    });
    
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgData = canvas.toDataURL('image/png');
    const pdfWidth = 210;
    const pdfHeight = 297;
    const imgRatio = canvas.height / canvas.width;
    let imgHeight = pdfWidth * imgRatio;
    
    if (imgHeight > pdfHeight) {
      imgHeight = pdfHeight;
    }
    
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
    
    return pdf.output('blob');
  } finally {
    document.body.removeChild(container);
  }
};

// Generate Service Report PDF - Uses html2canvas to capture actual rendered HTML
const generateReportPDFFromHTML = async (device, rma, technicianName, calType, receptionResult, findings, workCompleted, checklist) => {
  // Load html2canvas if needed
  if (!window.html2canvas) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }
  
  const jsPDF = await loadJsPDF();
  
  const today = new Date().toLocaleDateString('fr-FR');
  const serviceTypeText = device.service_type === 'calibration' ? '√âtalonnage' : device.service_type === 'repair' ? t('repair') : '√âtalonnage et R√©paration';
  const motifText = device.notes ? `${serviceTypeText} - ${device.notes}` : serviceTypeText;
  const showCalType = calType && calType !== 'none';
  const showReceptionResult = receptionResult && receptionResult !== 'none';
  const checkedItems = (checklist || []).filter(item => item.checked);

  // Create a temporary container with the exact report HTML
  const container = document.createElement('div');
  container.style.position = 'absolute';
  container.style.left = '-9999px';
  container.style.top = '0';
  container.style.width = '210mm';
  container.style.minHeight = '297mm';
  container.style.background = 'white';
  container.style.fontFamily = 'Arial, sans-serif';
  container.style.padding = '40px 50px';
  container.style.boxSizing = 'border-box';
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  
  container.innerHTML = `
    <!-- Logo Header -->
    <div style="margin-bottom: 40px; display: flex; align-items: center; gap: 8px;">
      <div style="display: flex; flex-direction: column; gap: 2px; margin-right: 8px;">
        <div style="width: 48px; height: 8px; background: #FFD200;"></div>
        <div style="width: 48px; height: 8px; background: #003366;"></div>
      </div>
      <div>
        <div style="font-size: 24px; font-weight: bold; letter-spacing: 2px; color: #003366;">LIGHTHOUSE</div>
        <div style="font-size: 10px; letter-spacing: 3px; color: #666; margin-top: -4px;">WORLDWIDE SOLUTIONS</div>
      </div>
    </div>

    <!-- Info Table -->
    <table style="width: 100%; font-size: 12px; margin-bottom: 24px; border-collapse: collapse;">
      <tr>
        <td style="padding: 4px 0; font-weight: bold; color: #003366; width: 150px;">Date d'ach√®vement</td>
        <td style="padding: 4px 0; color: #333; width: 200px;">${today}</td>
        <td style="padding: 4px 0;"><span style="font-weight: bold; color: #003366;">RMA # </span><span style="color: #333;">${rma.request_number}</span></td>
      </tr>
      <tr>
        <td style="padding: 4px 0; font-weight: bold; color: #003366;">Client</td>
        <td style="padding: 4px 0; color: #333;" colspan="2">${rma.companies?.name || ''}</td>
      </tr>
      <tr>
        <td style="padding: 4px 0; font-weight: bold; color: #003366;">Adresse</td>
        <td style="padding: 4px 0; color: #333;" colspan="2">${rma.companies?.billing_address || '‚Äî'}</td>
      </tr>
      <tr>
        <td style="padding: 4px 0; font-weight: bold; color: #003366;">Code postal / Ville</td>
        <td style="padding: 4px 0; color: #333;">${rma.companies?.billing_postal_code || ''} ${rma.companies?.billing_city || ''}</td>
        <td style="padding: 4px 0;"><span style="font-weight: bold; color: #003366;">Contact </span><span style="color: #333;">${rma.companies?.contact_name || '‚Äî'}</span></td>
      </tr>
      <tr>
        <td style="padding: 4px 0; font-weight: bold; color: #003366;">T√©l√©phone</td>
        <td style="padding: 4px 0; color: #333;">${rma.companies?.phone || '‚Äî'}</td>
        <td style="padding: 4px 0; font-weight: bold; color: #003366;">Technicien(ne) de service</td>
      </tr>
      <tr>
        <td style="padding: 4px 0; font-weight: bold; color: #003366;">Mod√®le#</td>
        <td style="padding: 4px 0; color: #333;">${device.model_name}</td>
        <td style="padding: 4px 0; color: #333;">${technicianName || 'Lighthouse France'}</td>
      </tr>
      <tr>
        <td style="padding: 4px 0; font-weight: bold; color: #003366;">Num√©ro de s√©rie</td>
        <td style="padding: 4px 0; color: #333;" colspan="2">${device.serial_number}</td>
      </tr>
    </table>

    <!-- Content Sections -->
    <div style="flex-grow: 1;">
      <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
        <tr>
          <td style="padding: 20px 0 8px; font-weight: bold; color: #003366; width: 170px; vertical-align: top;">Motif de retour</td>
          <td style="padding: 20px 0 8px; color: #333;">${motifText}</td>
        </tr>
        ${showCalType ? `
        <tr>
          <td style="padding: 8px 0; font-weight: bold; color: #003366; vertical-align: top;">√âtalonnage effectu√©</td>
          <td style="padding: 8px 0; color: #333;">${calType}</td>
        </tr>
        ` : ''}
        ${showReceptionResult ? `
        <tr>
          <td style="padding: 8px 0; font-weight: bold; color: #003366; vertical-align: top;">R√©sultats √† la r√©ception</td>
          <td style="padding: 8px 0; color: #333;">${receptionResult}</td>
        </tr>
        ` : ''}
        <tr>
          <td style="padding: 20px 0 8px; font-weight: bold; color: #003366; vertical-align: top;">Constatations</td>
          <td style="padding: 20px 0 8px; color: #333; white-space: pre-wrap;">${findings || '‚Äî'}</td>
        </tr>
        <tr>
          <td style="padding: 8px 0; font-weight: bold; color: #003366; vertical-align: top;">Actions effectu√©es</td>
          <td style="padding: 8px 0; color: #333; white-space: pre-wrap;">${workCompleted || '‚Äî'}</td>
        </tr>
        <tr>
          <td style="padding: 30px 0 8px; font-weight: bold; color: #003366; vertical-align: top;">Travaux r√©alis√©s</td>
          <td style="padding: 30px 0 8px;">
            ${checkedItems.map(item => `
              <div style="margin-bottom: 4px;">
                <span style="color: #003366;">‚òë</span>
                <span style="color: #333; margin-left: 8px;">${item.label}</span>
              </div>
            `).join('')}
          </td>
        </tr>
      </table>
    </div>

    <!-- Footer - positioned at bottom -->
    <div style="text-align: center; font-size: 12px; color: #666; padding-top: 32px; margin-top: auto;">
      <div style="font-weight: bold; color: #003366;">Lighthouse Worldwide Solutions France</div>
      <div>16 Rue Paul S√©journ√© 94000 Cr√©teil France</div>
      <div>01 43 77 28 07</div>
    </div>
  `;

  document.body.appendChild(container);

  try {
    // Capture the container
    const canvas = await window.html2canvas(container, { 
      scale: 2, 
      useCORS: true, 
      backgroundColor: '#ffffff',
      logging: false,
      width: container.offsetWidth,
      height: Math.max(container.offsetHeight, 1122) // 297mm at 96dpi ‚âà 1122px - ensure minimum A4 height
    });
    
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgData = canvas.toDataURL('image/png');
    const pdfWidth = 210;
    const pdfHeight = 297;
    const imgRatio = canvas.height / canvas.width;
    let imgHeight = pdfWidth * imgRatio;
    
    // If content is shorter than A4, just add it at top (footer will be at bottom of content)
    // If content is taller, scale to fit
    if (imgHeight > pdfHeight) {
      imgHeight = pdfHeight;
    }
    
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
    
    return pdf.output('blob');
  } finally {
    document.body.removeChild(container);
  }
};


// ============ RMA LABEL PRINTING (Brady M611 - PTL-37-351 1.9" x 3") ============
const printDeviceLabels = (devicesToPrint, rma, lang = 'fr', totalDeviceCount = null) => {
  const printWindow = window.open('', '_blank', 'width=500,height=700');
  if (!printWindow) {
    alert(lang === 'en' ? 'Please allow popups for label printing' : 'Veuillez autoriser les popups pour imprimer les √©tiquettes');
    return;
  }

  const labels = devicesToPrint.map((device, idx) => {
    const rmaNum = rma.request_number || 'N/A';
    const client = rma.companies?.name || '';
    const model = device.model_name || '';
    const serial = device.serial_number || '';
    const serviceType = device.service_type === 'repair' 
      ? (lang === 'en' ? 'Repair' : 'R√©paration')
      : device.service_type === 'calibration_repair' 
        ? (lang === 'en' ? 'Cal. + Repair' : '√âtal. + R√©p.')
        : (lang === 'en' ? 'Calibration' : '√âtalonnage');
    const arrivalDate = new Date(device.received_at || rma.received_at || new Date())
      .toLocaleDateString(lang === 'en' ? 'en-GB' : 'fr-FR');
    const totalDevices = totalDeviceCount || rma.request_devices?.length || rma.device_count || devicesToPrint.length;

    return `
      <div class="label">
        <div class="rma-number">RMA# ${rmaNum}</div>
        <div class="divider"></div>
        <div class="client">${client}</div>
        <div class="model">${model}</div>
        <div class="divider"></div>
        <div class="serial-label">${lang === 'en' ? 'S/N' : 'N¬∞ S√©rie'}</div>
        <div class="serial">${serial}</div>
        <div class="barcode-container">
          <canvas id="barcode-${idx}"></canvas>
        </div>
        <div class="divider"></div>
        <div class="service">${serviceType}</div>
        <div class="date-qty">
          <span>${lang === 'en' ? 'Received' : 'Arriv√©e'}: ${arrivalDate}</span>
          <span>${lang === 'en' ? 'Devices' : 'Appareils'}: ${totalDevices}</span>
        </div>
      </div>
    `;
  }).join('');

  printWindow.document.write(`<!DOCTYPE html>
<html>
<head>
  <title>RMA Labels</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"><\/script>
  <style>
    @page {
      size: 1.9in 3in;
      margin: 0;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, Helvetica, sans-serif; }
    .label {
      width: 1.9in;
      height: 3in;
      padding: 0.1in 0.12in;
      page-break-after: always;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      overflow: hidden;
    }
    .label:last-child { page-break-after: auto; }
    .rma-number {
      font-size: 14pt;
      font-weight: bold;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
    }
    .divider {
      width: 80%;
      height: 1px;
      background: #999;
      margin: 3px 0;
    }
    .client {
      font-size: 9pt;
      font-weight: bold;
      margin-top: 1px;
    }
    .model {
      font-size: 8pt;
      color: #444;
      margin-bottom: 1px;
    }
    .serial-label {
      font-size: 6pt;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 2px;
    }
    .serial {
      font-size: 10pt;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      letter-spacing: 0.5px;
    }
    .barcode-container {
      margin: 3px 0;
      width: 100%;
      display: flex;
      justify-content: center;
    }
    .barcode-container canvas {
      max-width: 1.6in;
      height: 35px;
    }
    .service {
      font-size: 9pt;
      font-weight: bold;
      margin-top: 1px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .date-qty {
      font-size: 7pt;
      color: #555;
      margin-top: 2px;
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    @media screen {
      body { background: #eee; display: flex; flex-wrap: wrap; gap: 20px; padding: 20px; justify-content: center; }
      .label { background: white; border: 1px dashed #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    }
  </style>
</head>
<body>
  ${labels}
  <script>
    window.onload = function() {
      ${devicesToPrint.map((device, idx) => `
        try {
          JsBarcode("#barcode-${idx}", "${(device.serial_number || '').replace(/"/g, '')}", {
            format: "CODE128",
            width: 1.5,
            height: 30,
            displayValue: false,
            margin: 0
          });
        } catch(e) { console.error('Barcode error:', e); }
      `).join('\n')}
      
      // Auto-print after short delay
      setTimeout(function() {
        window.print();
      }, 500);
    };
  <\/script>
</body>
</html>`);
  printWindow.document.close();
};


// ============ ADMIN TRANSLATIONS ============
const AT = {
  fr: {
    // Nav tabs
    dashboard: 'Tableau de Bord', messages: 'Messages', requests: 'Demandes',
    parts: 'Pi√®ces D√©tach√©es', rentals: 'Locations', contracts: 'Contrats',
    pendingArrivals: 'R√©ceptions',
    invoices: 'Factures', clients: 'Clients', pricing: 'Tarifs & Pi√®ces',
    usaOrders: 'Commandes USA',
    kpis: 'KPIs', settings: 'Param√®tres', admin: 'Admin',
    
    // Header
    adminPortal: 'France ‚Ä¢ Admin Portal', administrator: 'Administrateur',
    employee: 'Employ√©', logout: 'D√©connexion',
    
    // Common actions
    save: 'Enregistrer', cancel: 'Annuler', close: 'Fermer', delete: 'Supprimer',
    edit: 'Modifier', add: 'Ajouter', create: 'Cr√©er', search: 'Rechercher',
    filter: 'Filtrer', refresh: 'Actualiser', back: 'Retour', confirm: 'Confirmer',
    submit: 'Soumettre', send: 'Envoyer', download: 'T√©l√©charger', upload: 'Importer',
    view: 'Voir', open: 'Ouvrir', reset: 'R√©initialiser', apply: 'Appliquer',
    loading: 'Chargement...', saving: 'Enregistrement...', saved: 'Enregistr√©!',
    noResults: 'Aucun r√©sultat', yes: 'Oui', no: 'Non', all: 'Tous', none: 'Aucun',
    actions: 'Actions', status: 'Statut', date: 'Date', total: 'Total', notes: 'Notes',
    details: 'D√©tails', history: 'Historique', documents: 'Documents', type: 'Type',
    
    // Status labels
    stSubmitted: 'Soumis', stRmaCreated: 'RMA/Devis Cr√©√©', stQuoteSent: 'Devis envoy√©',
    stWaitingBc: 'Attente BC', stBcReview: '‚ö†Ô∏è BC √† v√©rifier', stBcRejected: '‚ùå BC Rejet√©',
    stQuoteApproved: 'Devis Approuv√©', stWaitingReception: 'En attente r√©ception',
    stReceived: 'Re√ßu', stInQueue: "File d'attente", stInspection: 'Inspection',
    stApprobation: 'Approbation', stCalibration: '√âtalonnage', stRepair: 'R√©paration',
    stQc: 'Contr√¥le QC', stQcRejected: '‚ùå QC Rejet√©', stReady: 'Pr√™t',
    stShipped: 'Exp√©di√©', stCompleted: 'Termin√©', stCancelled: 'Annul√©',
    stArchived: 'üì¶ Archiv√©', stRevisionRequested: 'üî¥ Modification demand√©e',
    stRevisionDeclined: '‚ùå Modification refus√©e',

    // Dashboard
    openRequests: 'Demandes ouvertes', devicesInService: 'Appareils en service',
    awaitingReception: 'En attente r√©ception', readyToShip: 'Pr√™ts √† exp√©dier',
    pendingActions: 'Actions en attente', recentRequests: 'Demandes r√©centes',
    quickFilters: 'Filtres rapides', allRequests: 'Toutes les demandes',
    serviceRequests: 'Demandes de service', partsOrders: 'Commandes pi√®ces',
    viewRma: 'Voir RMA', noRequestsFound: 'Aucune demande trouv√©e',
    searchPlaceholder: 'Rechercher RMA, client, N¬∞ s√©rie...',
    deviceView: 'Vue Appareils', requestView: 'Vue Demandes',
    
    // RMA / Request
    rmaNumber: 'N¬∞ RMA', client: 'Client', company: 'Soci√©t√©', devices: 'Appareils',
    device: 'Appareil', serialNumber: 'N¬∞ S√©rie', model: 'Mod√®le', brand: 'Marque',
    serviceType: 'Type de Service', calibration: '√âtalonnage', repair: 'R√©paration',
    calibrationRepair: '√âtal. + R√©p.', partsOrder: 'Commande Pi√®ces',
    requestDate: 'Date demande', createdAt: 'Cr√©√© le', updatedAt: 'Mis √† jour le',
    
    // Quote
    quote: 'Devis', quoteNumber: 'N¬∞ Devis', generateQuote: 'G√©n√©rer Devis',
    sendQuote: 'Envoyer Devis', approveQuote: 'Approuver Devis',
    quoteAmount: 'Montant devis', subtotal: 'Sous-total', tva: 'TVA',
    totalTTC: 'Total TTC', totalHT: 'Total HT', discount: 'Remise',
    unitPrice: 'Prix unitaire', quantity: 'Quantit√©', description: 'Description',
    
    // BC / PO
    purchaseOrder: 'Bon de Commande', bcNumber: 'N¬∞ BC', bcFile: 'Fichier BC',
    bcSubmitted: 'BC Soumis', bcApproved: 'BC Approuv√©', bcRejected: 'BC Rejet√©',
    approveBc: 'Approuver BC', rejectBc: 'Rejeter BC', rejectionReason: 'Motif de rejet',
    
    // Shipping
    shipping: 'Exp√©dition', shippingAddress: "Adresse d'exp√©dition", 
    trackingNumber: 'N¬∞ Suivi', carrier: 'Transporteur',
    shipDevice: 'Exp√©dier', createShipment: 'Cr√©er Exp√©dition',
    returnAddress: 'Adresse de retour',
    
    // Device / Service
    reception: 'R√©ception', receptionDate: 'Date de r√©ception',
    markReceived: 'Marquer re√ßu', startService: 'D√©marrer service',
    serviceReport: 'Rapport de Service', calCertificate: 'Certificat d\'√âtalonnage',
    generateReport: 'G√©n√©rer Rapport', generateCertificate: 'G√©n√©rer Certificat',
    techNotes: 'Notes techniques', findings: 'Constatations', workCompleted: 'Travaux effectu√©s',
    accessories: 'Accessoires', charger: 'Chargeur', battery: 'Batterie',
    powerCable: "C√¢ble d'alimentation", carryingCase: 'Mallette',
    
    // QC
    qualityCheck: 'Contr√¥le Qualit√©', qcPass: 'QC Valid√©', qcFail: 'QC Rejet√©',
    qcNotes: 'Notes QC',
    
    // Clients
    clientList: 'Liste Clients', addClient: 'Ajouter Client', 
    contactName: 'Nom du contact', email: 'Email', phone: 'T√©l√©phone',
    address: 'Adresse', city: 'Ville', postalCode: 'Code Postal', country: 'Pays',
    
    // Contracts
    contract: 'Contrat', contractNumber: 'N¬∞ Contrat', activeContracts: 'Contrats actifs',
    tokensUsed: 'Jetons utilis√©s', tokensRemaining: 'Jetons restants',
    
    // Invoices
    invoice: 'Facture', invoiceNumber: 'N¬∞ Facture', generateInvoice: 'G√©n√©rer Facture',
    paymentStatus: 'Statut paiement', paid: 'Pay√©', unpaid: 'Impay√©', overdue: 'En retard',
    dueDate: 'Date √©ch√©ance', paymentTerms: 'Conditions de paiement',
    
    // Messages
    message: 'Message', newMessage: 'Nouveau message', sendMessage: 'Envoyer',
    typeMessage: 'Tapez votre message...', noMessages: 'Aucun message',
    unread: 'Non lu', markRead: 'Marquer comme lu',
    internalNote: 'Note interne', translateTo: 'Traduire en',
    
    // Settings
    team: '√âquipe', docNumbering: 'Num√©rotation Documents',
    language: 'Langue', languagePreference: 'Pr√©f√©rence de langue',
    languageDesc: "Choisissez la langue d'affichage du portail. Ceci n'affecte que l'interface, pas les documents.",
    langUpdatedFr: 'Langue mise √† jour ‚Äî Fran√ßais',
    langUpdatedEn: 'Language updated ‚Äî English',
    displayInFrench: 'Afficher le portail en fran√ßais',
    displayInEnglish: 'Display portal in English',
    
    // BL
    deliveryNote: 'Bon de Livraison', blNumber: 'N¬∞ BL', generateBL: 'G√©n√©rer BL',
    
    // Pricing
    pricingParts: 'Tarifs & Pi√®ces', priceList: 'Grille tarifaire',
    
    // KPI
    kpiTitle: 'Indicateurs de Performance',
    
    // Rentals
    rental: 'Location', rentalsList: 'Locations',
    
    // Misc
    equipmentList: 'Liste √âquipements', photo: 'Photo', photos: 'Photos',
    attachment: 'Pi√®ce jointe', attachments: 'Pi√®ces jointes',
    comment: 'Commentaire', comments: 'Commentaires',
    timeline: 'Chronologie', progress: 'Progression',
    customerNotes: 'Notes client', adminNotes: 'Notes admin',
    noData: 'Aucune donn√©e', exportCsv: 'Exporter CSV',
    selectAll: 'Tout s√©lectionner', deselectAll: 'Tout d√©s√©lectionner',
    perPage: 'par page', page: 'Page', of: 'sur',
    today: "Aujourd'hui", yesterday: 'Hier', thisWeek: 'Cette semaine',
    thisMonth: 'Ce mois', lastMonth: 'Mois dernier',
    from: 'Du', to: 'Au', dateRange: 'P√©riode',
  },
  en: {
    // Nav tabs
    dashboard: 'Dashboard', messages: 'Messages', requests: 'Requests',
    parts: 'Parts Orders', rentals: 'Rentals', contracts: 'Contracts',
    pendingArrivals: 'Pending Arrivals',
    invoices: 'Invoices', clients: 'Clients', pricing: 'Pricing & Parts',
    usaOrders: 'USA Orders',
    kpis: 'KPIs', settings: 'Settings', admin: 'Admin',
    
    // Header
    adminPortal: 'France ‚Ä¢ Admin Portal', administrator: 'Administrator',
    employee: 'Employee', logout: 'Logout',
    
    // Common actions
    save: 'Save', cancel: 'Cancel', close: 'Close', delete: 'Delete',
    edit: 'Edit', add: 'Add', create: 'Create', search: 'Search',
    filter: 'Filter', refresh: 'Refresh', back: 'Back', confirm: 'Confirm',
    submit: 'Submit', send: 'Send', download: 'Download', upload: 'Import',
    view: 'View', open: 'Open', reset: 'Reset', apply: 'Apply',
    loading: 'Loading...', saving: 'Saving...', saved: 'Saved!',
    noResults: 'No results', yes: 'Yes', no: 'No', all: 'All', none: 'None',
    actions: 'Actions', status: 'Status', date: 'Date', total: 'Total', notes: 'Notes',
    details: 'Details', history: 'History', documents: 'Documents', type: 'Type',
    
    // Status labels
    stSubmitted: 'Submitted', stRmaCreated: 'RMA/Quote Created', stQuoteSent: 'Quote Sent',
    stWaitingBc: 'Awaiting PO', stBcReview: '‚ö†Ô∏è PO Under Review', stBcRejected: '‚ùå PO Rejected',
    stQuoteApproved: 'Quote Approved', stWaitingReception: 'Awaiting Reception',
    stReceived: 'Received', stInQueue: 'In Queue', stInspection: 'Inspection',
    stApprobation: 'Approval', stCalibration: 'Calibration', stRepair: 'Repair',
    stQc: 'QC Check', stQcRejected: '‚ùå QC Rejected', stReady: 'Ready',
    stShipped: 'Shipped', stCompleted: 'Completed', stCancelled: 'Cancelled',
    stArchived: 'üì¶ Archived', stRevisionRequested: 'üî¥ Revision Requested',
    stRevisionDeclined: '‚ùå Revision Declined',

    // Dashboard
    openRequests: 'Open Requests', devicesInService: 'Devices in Service',
    awaitingReception: 'Awaiting Reception', readyToShip: 'Ready to Ship',
    pendingActions: 'Pending Actions', recentRequests: 'Recent Requests',
    quickFilters: 'Quick Filters', allRequests: 'All Requests',
    serviceRequests: 'Service Requests', partsOrders: 'Parts Orders',
    viewRma: 'View RMA', noRequestsFound: 'No requests found',
    searchPlaceholder: 'Search RMA, client, serial #...',
    deviceView: 'Device View', requestView: 'Request View',
    
    // RMA / Request
    rmaNumber: 'RMA #', client: 'Client', company: 'Company', devices: 'Devices',
    device: 'Device', serialNumber: 'Serial #', model: 'Model', brand: 'Brand',
    serviceType: 'Service Type', calibration: 'Calibration', repair: 'Repair',
    calibrationRepair: 'Cal. + Rep.', partsOrder: 'Parts Order',
    requestDate: 'Request Date', createdAt: 'Created', updatedAt: 'Updated',
    
    // Quote
    quote: 'Quote', quoteNumber: 'Quote #', generateQuote: 'Generate Quote',
    sendQuote: 'Send Quote', approveQuote: 'Approve Quote',
    quoteAmount: 'Quote Amount', subtotal: 'Subtotal', tva: 'VAT',
    totalTTC: 'Total incl. VAT', totalHT: 'Total excl. VAT', discount: 'Discount',
    unitPrice: 'Unit Price', quantity: 'Quantity', description: 'Description',
    
    // BC / PO
    purchaseOrder: 'Purchase Order', bcNumber: 'PO #', bcFile: 'PO File',
    bcSubmitted: 'PO Submitted', bcApproved: 'PO Approved', bcRejected: 'PO Rejected',
    approveBc: 'Approve PO', rejectBc: 'Reject PO', rejectionReason: 'Rejection Reason',
    
    // Shipping
    shipping: 'Shipping', shippingAddress: 'Shipping Address',
    trackingNumber: 'Tracking #', carrier: 'Carrier',
    shipDevice: 'Ship', createShipment: 'Create Shipment',
    returnAddress: 'Return Address',
    
    // Device / Service
    reception: 'Reception', receptionDate: 'Reception Date',
    markReceived: 'Mark Received', startService: 'Start Service',
    serviceReport: 'Service Report', calCertificate: 'Calibration Certificate',
    generateReport: 'Generate Report', generateCertificate: 'Generate Certificate',
    techNotes: 'Tech Notes', findings: 'Findings', workCompleted: 'Work Completed',
    accessories: 'Accessories', charger: 'Charger', battery: 'Battery',
    powerCable: 'Power Cable', carryingCase: 'Carrying Case',
    
    // QC
    qualityCheck: 'Quality Check', qcPass: 'QC Passed', qcFail: 'QC Failed',
    qcNotes: 'QC Notes',
    
    // Clients
    clientList: 'Client List', addClient: 'Add Client',
    contactName: 'Contact Name', email: 'Email', phone: 'Phone',
    address: 'Address', city: 'City', postalCode: 'Postal Code', country: 'Country',
    
    // Contracts
    contract: 'Contract', contractNumber: 'Contract #', activeContracts: 'Active Contracts',
    tokensUsed: 'Tokens Used', tokensRemaining: 'Tokens Remaining',
    
    // Invoices
    invoice: 'Invoice', invoiceNumber: 'Invoice #', generateInvoice: 'Generate Invoice',
    paymentStatus: 'Payment Status', paid: 'Paid', unpaid: 'Unpaid', overdue: 'Overdue',
    dueDate: 'Due Date', paymentTerms: 'Payment Terms',
    
    // Messages
    message: 'Message', newMessage: 'New Message', sendMessage: 'Send',
    typeMessage: 'Type your message...', noMessages: 'No messages',
    unread: 'Unread', markRead: 'Mark as read',
    internalNote: 'Internal Note', translateTo: 'Translate to',
    
    // Settings
    team: 'Team', docNumbering: 'Document Numbering',
    language: 'Language', languagePreference: 'Language Preference',
    languageDesc: 'Choose the display language for your portal. This only affects the interface, not documents.',
    langUpdatedFr: 'Langue mise √† jour ‚Äî Fran√ßais',
    langUpdatedEn: 'Language updated ‚Äî English',
    displayInFrench: 'Afficher le portail en fran√ßais',
    displayInEnglish: 'Display portal in English',
    
    // BL
    deliveryNote: 'Delivery Note', blNumber: 'DN #', generateBL: 'Generate DN',
    
    // Pricing
    pricingParts: 'Pricing & Parts', priceList: 'Price List',
    
    // KPI
    kpiTitle: 'Key Performance Indicators',
    
    // Rentals
    rental: 'Rental', rentalsList: 'Rentals',
    
    // Misc
    equipmentList: 'Equipment List', photo: 'Photo', photos: 'Photos',
    attachment: 'Attachment', attachments: 'Attachments',
    comment: 'Comment', comments: 'Comments',
    timeline: 'Timeline', progress: 'Progress',
    customerNotes: 'Customer Notes', adminNotes: 'Admin Notes',
    noData: 'No data', exportCsv: 'Export CSV',
    selectAll: 'Select All', deselectAll: 'Deselect All',
    perPage: 'per page', page: 'Page', of: 'of',
    today: 'Today', yesterday: 'Yesterday', thisWeek: 'This Week',
    thisMonth: 'This Month', lastMonth: 'Last Month',
    from: 'From', to: 'To', dateRange: 'Date Range',
  }
};

// Status label lookup by language
const STATUS_LABELS = {
  fr: {
    submitted: 'Soumis', rma_created: 'RMA/Devis Cr√©√©', quote_sent: 'Devis envoy√©', pending_quote_review: 'Devis en v√©rification',
    waiting_bc: 'Attente BC', bc_review: '‚ö†Ô∏è BC √† v√©rifier', bc_rejected: '‚ùå BC Rejet√©',
    quote_approved: 'Devis Approuv√©', waiting_reception: 'En attente r√©ception',
    received: 'Re√ßu', in_queue: "File d'attente", inspection: 'Inspection',
    approbation: 'Approbation', calibration: '√âtalonnage', repair: 'R√©paration',
    qc: 'Contr√¥le QC', qc_rejected: '‚ùå QC Rejet√©', ready: 'Pr√™t',
    shipped: 'Exp√©di√©', completed: 'Termin√©', cancelled: 'Annul√©',
    archived: 'üì¶ Archiv√©', approved: 'RMA/Devis Cr√©√©',
    waiting_device: 'En attente r√©ception', calibration_in_progress: '√âtalonnage',
    repair_in_progress: 'R√©paration', final_qc: 'Contr√¥le QC',
    ready_to_ship: 'Pr√™t', quote_revision_requested: 'üî¥ Modification demand√©e',
    quote_revision_declined: '‚ùå Modification refus√©e',
    pending: 'En attente', in_progress: 'En cours', waiting_approval: "En attente d'approbation",
    quote_declined: 'Devis refus√©', waiting_customer: 'Action client requise'
  },
  en: {
    submitted: 'Submitted', rma_created: 'RMA/Quote Created', quote_sent: 'Quote Sent', pending_quote_review: 'Quote Under Review',
    waiting_bc: 'Awaiting PO', bc_review: '‚ö†Ô∏è PO Under Review', bc_rejected: '‚ùå PO Rejected',
    quote_approved: 'Quote Approved', waiting_reception: 'Awaiting Reception',
    received: 'Received', in_queue: 'In Queue', inspection: 'Inspection',
    approbation: 'Approval', calibration: 'Calibration', repair: 'Repair',
    qc: 'QC Check', qc_rejected: '‚ùå QC Rejected', ready: 'Ready',
    shipped: 'Shipped', completed: 'Completed', cancelled: 'Cancelled',
    archived: 'üì¶ Archived', approved: 'RMA/Quote Created',
    waiting_device: 'Awaiting Reception', calibration_in_progress: 'Calibration',
    repair_in_progress: 'Repair', final_qc: 'QC Check',
    ready_to_ship: 'Ready', quote_revision_requested: 'üî¥ Revision Requested',
    quote_revision_declined: '‚ùå Revision Declined',
    pending: 'Pending', in_progress: 'In Progress', waiting_approval: 'Awaiting Approval',
    quote_declined: 'Quote Declined', waiting_customer: 'Customer Action Required'
  }
};

const getStatusLabel = (status, lang = 'fr') => {
  return STATUS_LABELS[lang]?.[status] || STATUS_LABELS.fr?.[status] || status;
};

const STATUS_STYLES = {
  // Admin steps (Soumis ‚Üí Re√ßu)
  submitted: { bg: 'bg-amber-100', text: 'text-amber-700', label: 'Soumis', en: 'Submitted' },
  rma_created: { bg: 'bg-blue-100', text: 'text-blue-700', label: 'RMA/Devis Cr√©√©', en: 'RMA/Quote Created' },
  quote_sent: { bg: 'bg-purple-100', text: 'text-purple-700', label: 'Devis envoy√©', en: 'Quote Sent' },
  pending_quote_review: { bg: 'bg-amber-100', text: 'text-amber-700', label: 'Devis en v√©rification', en: 'Quote Under Review' },
  waiting_bc: { bg: 'bg-purple-100', text: 'text-purple-700', label: 'Attente BC', en: 'Awaiting PO' },
  bc_review: { bg: 'bg-orange-100', text: 'text-orange-700', label: '‚ö†Ô∏è BC √† v√©rifier', en: '‚ö†Ô∏è PO to Review' },
  bc_rejected: { bg: 'bg-red-100', text: 'text-red-700', label: '‚ùå BC Rejet√©', en: '‚ùå PO Rejected' },
  quote_approved: { bg: 'bg-green-100', text: 'text-green-700', label: 'Devis Approuv√©', en: 'Quote Approved' },
  waiting_reception: { bg: 'bg-orange-100', text: 'text-orange-700', label: 'En attente r√©ception', en: 'Awaiting Reception' },
  received: { bg: 'bg-cyan-100', text: 'text-cyan-700', label: 'Re√ßu', en: 'Received' },
  
  // Service steps
  in_queue: { bg: 'bg-indigo-100', text: 'text-indigo-700', label: 'File d\'attente', en: 'Queue' },
  inspection: { bg: 'bg-violet-100', text: 'text-violet-700', label: 'Inspection', en: 'Inspection' },
  approbation: { bg: 'bg-pink-100', text: 'text-pink-700', label: 'Approbation', en: 'Approval' },
  calibration: { bg: 'bg-blue-100', text: 'text-blue-700', label: '√âtalonnage', en: 'Calibration' },
  repair: { bg: 'bg-blue-100', text: 'text-blue-700', label: 'R√©paration', en: 'Repair' },
  
  // QC step
  qc: { bg: 'bg-purple-100', text: 'text-purple-700', label: 'Contr√¥le QC', en: 'QC Check' },
  qc_rejected: { bg: 'bg-red-100', text: 'text-red-700', label: '‚ùå QC Rejet√©', en: '‚ùå QC Rejected' },
  
  // Final Admin steps
  ready: { bg: 'bg-emerald-100', text: 'text-emerald-700', label: 'Pr√™t', en: 'Ready' },
  shipped: { bg: 'bg-green-100', text: 'text-green-700', label: 'Exp√©di√©', en: 'Shipped' },
  
  // Other
  completed: { bg: 'bg-gray-100', text: 'text-gray-600', label: 'Termin√©', en: 'Completed' },
  cancelled: { bg: 'bg-red-100', text: 'text-red-700', label: 'Annul√©', en: 'Cancelled' },
  archived: { bg: 'bg-slate-100', text: 'text-slate-500', label: 'üì¶ Archiv√©', en: 'üì¶ Archived' },
  
  // Legacy mappings
  approved: { bg: 'bg-blue-100', text: 'text-blue-700', label: 'RMA/Devis Cr√©√©', en: 'RMA/Quote Created' },
  waiting_device: { bg: 'bg-orange-100', text: 'text-orange-700', label: 'En attente r√©ception', en: 'Awaiting Reception' },
  calibration_in_progress: { bg: 'bg-blue-100', text: 'text-blue-700', label: '√âtalonnage', en: 'Calibration' },
  repair_in_progress: { bg: 'bg-blue-100', text: 'text-blue-700', label: 'R√©paration', en: 'Repair' },
  final_qc: { bg: 'bg-purple-100', text: 'text-purple-700', label: 'Contr√¥le QC', en: 'QC Check' },
  ready_to_ship: { bg: 'bg-emerald-100', text: 'text-emerald-700', label: 'Pr√™t', en: 'Ready' },
  quote_revision_requested: { bg: 'bg-red-100', text: 'text-red-700', label: 'üî¥ Modification demand√©e', en: 'üî¥ Revision Requested' },
  quote_revision_declined: { bg: 'bg-orange-100', text: 'text-orange-700', label: '‚ùå Modification refus√©e', en: '‚ùå Revision Declined' }
};

export default function AdminPortal() {
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeSheet, setActiveSheet] = useState('dashboard');
  const [toast, setToast] = useState(null);
  const [requests, setRequests] = useState([]);
  const [clients, setClients] = useState([]);
  const [staffMembers, setStaffMembers] = useState([]);
  const [equipment, setEquipment] = useState([]);
  const [contracts, setContracts] = useState([]);
  const [pendingArrivalsCount, setPendingArrivalsCount] = useState(0);
  const [pendingQuoteReviewCount, setPendingQuoteReviewCount] = useState(0);
  const [selectedRMA, setSelectedRMA] = useState(null); // Full-page RMA view
  const [lang, setLang] = useState('fr');
  const t = useCallback((k) => AT[lang]?.[k] || AT.fr?.[k] || k, [lang]);
  const [selectedDeviceFromDashboard, setSelectedDeviceFromDashboard] = useState(null); // Direct device selection from device view
  
  // Business settings - used across all documents (BL, quotes, invoices)
  const [businessSettings, setBusinessSettings] = useState({
    company_name: 'Lighthouse France SAS',
    address: '16 rue Paul S√©journ√©',
    city: 'CR√âTEIL',
    postal_code: '94000',
    phone: '01 43 77 28 07',
    email: 'France@golighthouse.com',
    website: 'www.golighthouse.fr',
    siret: '50178134800013',
    tva: 'FR 86501781348',
    capital: '10 000',
    bank_name: '',
    bank_branch: '',
    iban: '',
    bic: '',
    rib: '',
    payment_terms_days: 30,
    invoice_legal_text: '',
    quote_signatory: 'M. Meleney',
    quote_settings: null
  });

  const notify = useCallback((msg, type = 'success') => {
    setToast({ msg, type });
    setTimeout(() => setToast(null), 3000);
  }, []);

  const loadData = useCallback(async (refreshSelectedRMAId = null) => {
    const { data: reqs } = await supabase.from('service_requests')
      .select('*, companies(*), request_devices(*)')
      .order('created_at', { ascending: false });
    if (reqs) setRequests(reqs);

    const { data: companies } = await supabase.from('companies')
      .select('*, profiles(id, full_name, email, phone, role, invitation_status, gdpr_erased_at, can_view, can_request, can_invoice), shipping_addresses(*)')
      .order('name', { ascending: true });
    if (companies) setClients(companies);

    const { data: equip } = await supabase.from('equipment').select('*, companies(name)').order('created_at', { ascending: false });
    if (equip) setEquipment(equip);

    const { data: staff } = await supabase.from('profiles').select('*').in('role', ['lh_admin', 'lh_employee']).order('full_name');
    if (staff) setStaffMembers(staff);

    const { data: contractsData } = await supabase.from('contracts').select('id, status').order('created_at', { ascending: false });
    if (contractsData) setContracts(contractsData);
    
    // Load pending arrivals count (unresolved)
    const { count: paCount } = await supabase.from('pending_arrivals').select('id', { count: 'exact', head: true }).not('status', 'eq', 'resolved');
    setPendingArrivalsCount(paCount || 0);
    
    // Load pending quote reviews count
    try {
      const { count: qrCount } = await supabase.from('quote_reviews').select('id', { count: 'exact', head: true }).eq('status', 'pending');
      setPendingQuoteReviewCount(qrCount || 0);
    } catch { setPendingQuoteReviewCount(0); }
    
    // Load rental requests
    const { data: rentalsData, error: rentalsError } = await supabase.from('rental_requests')
      .select('*, companies(*), rental_request_items(*), shipping_address:shipping_addresses!shipping_address_id(*)')
      .order('created_at', { ascending: false });
    console.log('Main loadData - rental_requests:', { rentalsData, rentalsError });
    if (rentalsData) setRentalRequests(rentalsData);
    
    // Load business settings
    const { data: settings } = await supabase.from('business_settings').select('*').eq('id', 1).single();
    if (settings) {
      setBusinessSettings(settings);
    }
    
    // Only refresh selected RMA if ID is provided
    if (refreshSelectedRMAId) {
      const { data: updatedRMA } = await supabase
        .from('service_requests')
        .select('*, companies(*), request_devices(*)')
        .eq('id', refreshSelectedRMAId)
        .single();
      if (updatedRMA) setSelectedRMA(updatedRMA);
    }
  }, []); // No dependencies - stable function

  useEffect(() => {
    const checkAuth = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        const { data: p } = await supabase.from('profiles').select('*, companies(*)').eq('id', session.user.id).single();
        if (p) {
          if (p.role !== 'lh_admin' && p.role !== 'lh_employee') { window.location.href = '/'; return; }
          setUser(session.user);
          setProfile(p);
          if (p.preferred_language) setLang(p.preferred_language);
          await loadData();
        } else {
          // No profile found - redirect to customer portal
          window.location.href = '/';
        }
      }
      setLoading(false);
    };
    checkAuth();
  }, [loadData]);

  const logout = async () => { 
    const { error } = await supabase.auth.signOut({ scope: 'local' }); 
    if (error) { 
      console.warn('Sign out error, clearing manually:', error); 
      localStorage.clear(); 
      sessionStorage.clear(); 
    } 
    window.location.href = '/'; 
  };
  const isAdmin = profile?.role === 'lh_admin';
  
  // Count pending requests and modification requests - EXCLUDE parts orders
  const rmaRequests = requests.filter(r => r.request_type !== 'parts');
  const pendingCount = rmaRequests.filter(r => r.status === 'submitted' && !r.request_number).length;
  const modificationCount = rmaRequests.filter(r => r.status === 'quote_revision_requested').length;
  const quoteRejectionCount = rmaRequests.filter(r => r.quote_rejection_notes && r.status === 'rma_created').length;
  const totalBadge = pendingCount + modificationCount + quoteRejectionCount;
  // Contract badge: new requests, BC pending review, OR quote revision requested
  const contractActionCount = contracts.filter(c => 
    c.status === 'requested' || 
    c.status === 'bc_pending' || 
    c.status === 'quote_revision_requested'
  ).length;
  // Open chats count - includes unread messages
  const openChatsCount = requests.filter(r => r.chat_status === 'open' || (r.unread_admin_count || 0) > 0).length;
  const totalUnreadMessages = requests.reduce((sum, r) => sum + (r.unread_admin_count || 0), 0);
  
  // Dashboard filter state
  const [dashboardFilter, setDashboardFilter] = useState(null);
  
  // Rental requests count
  const [rentalRequests, setRentalRequests] = useState([]);
  const rentalActionCount = rentalRequests.filter(r => 
    r.status === 'requested' || 
    r.status === 'bc_review'
  ).length;
  
  // Parts Orders count - pending parts requests AND BC to review
  const partsOrders = requests.filter(r => r.request_type === 'parts');
  const partsOrdersActionCount = partsOrders.filter(r => 
    r.status === 'submitted' || 
    r.status === 'quote_revision_requested' ||
    r.status === 'bc_review'
  ).length;
  
  // Quote review count - RMAs pending quote review
  const quoteReviewCount = pendingQuoteReviewCount || requests.filter(r => r.status === 'pending_quote_review').length;
  
  const sheets = [
    { id: 'dashboard', label: t('dashboard'), icon: 'üìä' },
    { id: 'messages', label: t('messages'), icon: 'üí¨', badge: totalUnreadMessages > 0 ? totalUnreadMessages : (openChatsCount > 0 ? openChatsCount : null) },
    { id: 'quote_review', label: lang === 'en' ? 'Quote Review' : 'V√©rif. Devis', icon: '‚úÖ', badge: quoteReviewCount > 0 ? quoteReviewCount : null },
    { id: 'requests', label: t('requests'), icon: 'üìã', badge: totalBadge > 0 ? totalBadge : null },
    { id: 'parts', label: t('parts'), icon: 'üî©', badge: partsOrdersActionCount > 0 ? partsOrdersActionCount : null },
    { id: 'rentals', label: t('rentals'), icon: 'üìÖ', badge: rentalActionCount > 0 ? rentalActionCount : null },
    { id: 'contracts', label: t('contracts'), icon: 'üìÑ', badge: contractActionCount > 0 ? contractActionCount : null },
    { id: 'pending_arrivals', label: t('pendingArrivals'), icon: '‚ö†Ô∏è', badge: pendingArrivalsCount > 0 ? pendingArrivalsCount : null },
    { id: 'invoices', label: t('invoices'), icon: 'üìã' },
    { id: 'usa_orders', label: t('usaOrders'), icon: 'üá∫üá∏' },
    { id: 'clients', label: t('clients'), icon: 'üë•' },
    { id: 'pricing', label: t('pricing'), icon: 'üí∞' },
    { id: 'kpi', label: t('kpis'), icon: 'üìà' },
    { id: 'settings', label: t('settings'), icon: '‚öôÔ∏è' },
    ...(isAdmin ? [{ id: 'admin', label: t('admin'), icon: 'üîê' }] : [])
  ];

  if (loading) return <div className="min-h-screen bg-gray-100 flex items-center justify-center"><div className="w-12 h-12 border-4 border-[#00A651] border-t-transparent rounded-full animate-spin" /></div>;
  if (!user || !profile) return <LoginPage />;

  return (
    <div className="min-h-screen bg-gray-100">
      {toast && <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white ${toast.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>{toast.msg}</div>}
      <header className="bg-white text-[#1a1a2e] shadow-lg border-b-4 border-[#00A651]">
        <div className="max-w-full mx-auto px-6 py-3 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <img 
              src="/images/logos/lighthouse-logo.png" 
              alt="Lighthouse France" 
              className="h-10 w-auto"
              onError={(e) => {
                e.target.style.display = 'none';
                e.target.nextSibling.style.display = 'flex';
              }}
            />
            <div className="items-center gap-2 hidden">
              <span className="text-2xl font-bold text-[#00A651]">LIGHTHOUSE</span>
            </div>
            <div className="text-sm text-gray-500">{lang === 'en' ? 'France ‚Ä¢ Admin Portal' : 'France ‚Ä¢ Admin Portal'}</div>
          </div>
          <div className="flex items-center gap-4">
            <div className="text-right">
              <p className="font-medium">{profile?.full_name}</p>
              <p className="text-xs text-gray-500">{isAdmin ? t('administrator') : t('employee')}</p>
            </div>
            <button onClick={logout} className="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm text-white">{t('logout')}</button>
          </div>
        </div>
      </header>
      <nav className="bg-[#1a1a2e] border-t border-gray-700">
        <div className="max-w-full mx-auto px-6 flex gap-1 overflow-x-auto">
          {sheets.map(sheet => (
            <button key={sheet.id} onClick={() => { 
              setActiveSheet(sheet.id); 
              setSelectedRMA(null); 
              setSelectedDeviceFromDashboard(null); 
            }}
              className={`px-6 py-3 font-medium flex items-center gap-2 whitespace-nowrap relative ${activeSheet === sheet.id ? 'bg-[#00A651] text-white' : 'text-gray-400 hover:text-white hover:bg-gray-700'}`}>
              <span>{sheet.icon}</span>{sheet.label}
              {sheet.badge > 0 && (
                <span className="absolute -top-1 -right-1 min-w-[20px] h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center px-1 animate-pulse">
                  {sheet.badge}
                </span>
              )}
            </button>
          ))}
        </div>
      </nav>
      <main className="max-w-full mx-auto p-6">
        {/* Full-page RMA/PO View */}
        {selectedRMA ? (
          selectedRMA.request_type === 'parts' ? (
            <PartsOrderFullPage
              key={`po-${selectedRMA.id}`}
              order={selectedRMA}
              onBack={() => { setSelectedRMA(null); setSelectedDeviceFromDashboard(null); }}
              notify={notify}
              reload={() => loadData(selectedRMA?.id)}
              profile={profile}
              businessSettings={businessSettings}
              onOpenQuoteEditor={(o) => { setSelectedRMA(null); }}
              t={t} lang={lang}
            />
          ) : (
          <RMAFullPage 
            key={`rma-${selectedRMA.id}-${selectedDeviceFromDashboard?.device?.id || 'none'}`}
            rma={selectedRMA} 
            onBack={() => { setSelectedRMA(null); setSelectedDeviceFromDashboard(null); }} 
            notify={notify} 
            reload={() => loadData(selectedRMA?.id)}
            profile={profile}
            initialDevice={selectedDeviceFromDashboard?.device}
            businessSettings={businessSettings}
            t={t} lang={lang}
          />
          )
        ) : (
          <>
            {activeSheet === 'dashboard' && <DashboardSheet 
              t={t} lang={lang}
              requests={requests} 
              notify={notify} 
              reload={loadData} 
              isAdmin={isAdmin} 
              onSelectRMA={setSelectedRMA} 
              onSelectDevice={(device, rma) => {
                setSelectedDeviceFromDashboard({ device, rma });
                setSelectedRMA(rma);
              }}
              filter={dashboardFilter} 
              setFilter={setDashboardFilter} 
            />}
            {activeSheet === 'quote_review' && <QuoteReviewSheet requests={requests} clients={clients} notify={notify} reload={loadData} profile={profile} businessSettings={businessSettings} t={t} lang={lang} />}
            {activeSheet === 'kpi' && <KPISheet requests={requests} clients={clients} t={t} lang={lang} />}
            {activeSheet === 'requests' && <RequestsSheet requests={requests.filter(r => r.request_type !== 'parts')} notify={notify} reload={loadData} profile={profile} businessSettings={businessSettings} t={t} lang={lang} />}
            {activeSheet === 'parts' && <PartsOrdersSheet requests={partsOrders} notify={notify} reload={loadData} profile={profile} t={t} lang={lang} />}
            {activeSheet === 'clients' && <ClientsSheet
              t={t} lang={lang} 
              clients={clients} 
              requests={requests} 
              equipment={equipment} 
              notify={notify} 
              reload={loadData} 
              isAdmin={isAdmin} 
              businessSettings={businessSettings}
              profile={profile}
              onSelectRMA={setSelectedRMA}
              onSelectDevice={(device, rma) => {
                setSelectedDeviceFromDashboard({ device, rma });
                setSelectedRMA(rma);
              }}
            />}
            {activeSheet === 'messages' && <MessagesSheet
              t={t} lang={lang} 
              requests={requests} 
              notify={notify} 
              reload={loadData}
              onSelectRMA={setSelectedRMA}
            />}
            {activeSheet === 'pricing' && <PricingSheet notify={notify} isAdmin={isAdmin} t={t} lang={lang} />}
            {activeSheet === 'contracts' && <ContractsSheet clients={clients} notify={notify} profile={profile} t={t} lang={lang} reloadMain={loadData} />}
            {activeSheet === 'pending_arrivals' && <PendingArrivalsSheet clients={clients} requests={requests} notify={notify} reload={loadData} profile={profile} t={t} lang={lang} />}
            {activeSheet === 'invoices' && <InvoicesSheet requests={requests} clients={clients} notify={notify} reload={loadData} profile={profile} businessSettings={businessSettings} t={t} lang={lang} />}
            {activeSheet === 'usa_orders' && <USAOrdersSheet clients={clients} notify={notify} reload={loadData} profile={profile} t={t} lang={lang} />}
            {activeSheet === 'rentals' && <RentalsSheet
              t={t} lang={lang} 
              rentals={rentalRequests} 
              clients={clients}
              notify={notify} 
              reload={loadData}
              profile={profile}
              businessSettings={businessSettings}
            />}
            {activeSheet === 'settings' && <SettingsSheet profile={profile} staffMembers={staffMembers} notify={notify} reload={loadData} t={t} lang={lang} setLang={setLang} />}
            {activeSheet === 'admin' && isAdmin && <AdminSheet profile={profile} staffMembers={staffMembers} notify={notify} reload={loadData} businessSettings={businessSettings} setBusinessSettings={setBusinessSettings} t={t} lang={lang} />}
          </>
        )}
      </main>
    </div>
  );
}

function LoginPage() {
  const t = k => k;
  const lang = 'fr';
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    const { data, error: authError } = await supabase.auth.signInWithPassword({ email, password });
    if (authError) { setError(authError.message); setLoading(false); return; }
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', data.user.id).single();
    if (profile?.role !== 'lh_admin' && profile?.role !== 'lh_employee') {
      setError('Acc√®s non autoris√©. Ce portail est r√©serv√© au personnel Lighthouse.');
      await supabase.auth.signOut({ scope: 'local' });
      setLoading(false);
      return;
    }
    window.location.reload();
  };

  return (
    <div className="min-h-screen bg-[#1a1a2e] flex items-center justify-center p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-8">
        <div className="text-center mb-8">
          <img 
            src="/images/logos/lighthouse-logo.png" 
            alt="Lighthouse France" 
            className="h-14 w-auto mx-auto mb-3"
            onError={(e) => {
              e.target.style.display = 'none';
              e.target.nextSibling.style.display = 'block';
            }}
          />
          <h1 className="text-3xl font-bold text-[#00A651] hidden">LIGHTHOUSE</h1>
          <p className="text-gray-500 mt-2">{lang === 'en' ? 'France - Admin Portal' : 'France - Portail Administrateur'}</p>
        </div>
        {error && <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">{error}</div>}
        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{t('email')}</label>
            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg" required />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Password' : 'Mot de passe'}</label>
            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-lg" required />
          </div>
          <button type="submit" disabled={loading} className="w-full py-3 bg-[#00A651] text-white rounded-lg font-bold hover:bg-[#008f45] disabled:opacity-50">
            {loading ? 'Connexion...' : 'Se connecter'}
          </button>
        </form>
        <p className="text-center text-sm text-gray-400 mt-6">{lang === 'en' ? 'Access restricted to Lighthouse France staff' : 'Acc√®s r√©serv√© au personnel Lighthouse France'}</p>
      </div>
    </div>
  );
}

// ============================================
// ============================================
// QUOTE REVIEW SHEET
// ============================================
function QuoteReviewSheet({ requests = [], clients = [], notify, reload, profile, businessSettings = {}, t = k=>k, lang = 'fr' }) {
  const [reviews, setReviews] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('pending');
  const [selectedReview, setSelectedReview] = useState(null);
  const [rejecting, setRejecting] = useState(null);
  const [rejectionNotes, setRejectionNotes] = useState('');
  const [supplementDeviceNotes, setSupplementDeviceNotes] = useState({}); // { deviceId: notes }
  const [processing, setProcessing] = useState(false);

  const loadReviews = useCallback(async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from('quote_reviews')
        .select('*, service_requests:service_request_id(id, request_number, status, companies(name, email)), contracts:contract_id(id, contract_number, status, companies(name, email)), rental_requests:rental_request_id(id, rental_number, status, companies(name, email))')
        .neq('status', 'rejected')
        .order('submitted_at', { ascending: false });
      
      if (error) throw error;
      setReviews(data || []);
    } catch (err) {
      console.error('Load reviews error:', err);
      // If table doesn't exist yet, show empty
      setReviews([]);
    }
    setLoading(false);
  }, []);

  useEffect(() => { loadReviews(); }, [loadReviews]);

  const filtered = reviews.filter(r => r.status === filter);
  const pendingCount = reviews.filter(r => r.status === 'pending').length;

  const getTypeLabel = (type) => {
    const labels = {
      initial: lang === 'en' ? 'üìã Initial Quote' : 'üìã Devis Initial',
      revision: lang === 'en' ? 'üîÑ Revised Quote' : 'üîÑ Devis R√©vis√©',
      supplement: lang === 'en' ? 'üìÑ Supplement' : 'üìÑ Suppl√©ment',
      parts: lang === 'en' ? 'üî© Parts Quote' : 'üî© Devis Pi√®ces',
      contract: lang === 'en' ? 'üìÑ Contract Quote' : 'üìÑ Devis Contrat',
      rental: lang === 'en' ? 'üìÖ Rental Quote' : 'üìÖ Devis Location'
    };
    return labels[type] || type;
  };

  const getTypeColor = (type) => {
    const colors = {
      initial: 'bg-blue-100 text-blue-700',
      revision: 'bg-amber-100 text-amber-700',
      supplement: 'bg-purple-100 text-purple-700',
      parts: 'bg-orange-100 text-orange-700',
      contract: 'bg-green-100 text-green-700',
      rental: 'bg-cyan-100 text-cyan-700'
    };
    return colors[type] || 'bg-gray-100 text-gray-700';
  };

  // ========================
  // APPROVE QUOTE
  // ========================
  const approveQuote = async (review) => {
    if (review.submitted_by === profile?.id && profile?.role !== 'lh_admin') {
      notify(lang === 'en' ? 'You cannot approve your own quote' : 'Vous ne pouvez pas approuver votre propre devis', 'error');
      return;
    }
    setProcessing(true);
    try {
      // Load the full service_request (only for types that need it)
      let sr = null;
      if (review.service_request_id) {
        const { data: srData, error: srError } = await supabase
          .from('service_requests')
          .select('*, companies(*), request_devices(*)')
          .eq('id', review.service_request_id)
          .single();
        
        if (srError) throw srError;
        sr = srData;
      }
      
      const qd = review.quote_data;

      if (review.quote_type === 'initial' || review.quote_type === 'revision') {
        // === INITIAL/REVISION QUOTE: Generate PDF and send ===
        let quoteUrl = null;
        try {
          const rmaForPDF = { ...sr, request_number: qd.rmaNumber, companies: sr.companies };
          const pdfBlob = await generateQuotePDF(rmaForPDF, qd.devices, {
            shipping: qd.shipping,
            devicePricing: qd.devices,
            servicesSubtotal: qd.servicesSubtotal,
            shippingTotal: qd.shippingTotal,
            discount: qd.discount?.enabled ? qd.discount : null,
            grandTotal: qd.grandTotal,
            isContractRMA: qd.isContractRMA,
            isFullyContractCovered: false,
            quoteNumber: qd.quoteNumber,
            revisionNumber: qd.newRevisionCount || 0,
            businessSettings: qd.businessSettings || {},
            quoteSettings: qd.businessSettings?.quote_settings || null
          });
          const revSuffix = qd.newRevisionCount > 0 ? `_rev${qd.newRevisionCount}` : '';
          const fileName = `${qd.rmaNumber}_devis${revSuffix}_${Date.now()}.pdf`;
          quoteUrl = await uploadPDFToStorage(pdfBlob, `quotes/${qd.rmaNumber}`, fileName);
        } catch (pdfErr) {
          console.error('PDF generation error:', pdfErr);
        }
        
        // Archive old quote if revision
        if (review.quote_type === 'revision' && sr.quote_url) {
          try {
            const revLabel = (qd.newRevisionCount || 1) > 1 ? `Rev-${(qd.newRevisionCount || 1) - 1}` : 'Original';
            await supabase.from('request_attachments').insert({
              request_id: sr.id,
              file_url: sr.quote_url,
              file_name: `${qd.rmaNumber}_devis_${revLabel}.pdf`,
              category: 'internal_devis_revision',
              notes: `Devis ${revLabel} - archiv√©`
            });
          } catch (e) { console.error('Archive error:', e); }
        }
        
        const updateData = {
          status: 'quote_sent',
          quote_sent_at: new Date().toISOString(),
          quote_review_id: null,
          quote_rejection_notes: null
        };
        if (quoteUrl) updateData.quote_url = quoteUrl;
        
        await supabase.from('service_requests').update(updateData).eq('id', sr.id);
        
        // Update contract device flags if applicable
        if (qd.devices) {
          for (const d of qd.devices) {
            if (d.id && d.isContractCovered) {
              await supabase.from('request_devices').update({
                contract_device_id: d.contractDeviceId,
                contract_covered: true
              }).eq('id', d.id);
            }
          }
        }

      } else if (review.quote_type === 'parts') {
        // === PARTS QUOTE: Generate PDF and send ===
        let quoteUrl = null;
        try {
          const pdfBlob = await generatePartsQuotePDF(sr, { ...qd, quoteRef: qd.quoteNumber || qd.quoteRef });
          const fileName = `quotes/parts/${sr.request_number}/devis_pieces_${qd.poNumber || sr.request_number}_${Date.now()}.pdf`;
          
          const { error: uploadError } = await supabase.storage
            .from('documents')
            .upload(fileName, pdfBlob, { contentType: 'application/pdf' });
          
          if (!uploadError) {
            const { data: urlData } = supabase.storage.from('documents').getPublicUrl(fileName);
            quoteUrl = urlData?.publicUrl;
          }
        } catch (pdfErr) {
          console.error('Parts PDF error:', pdfErr);
        }
        
        const updateData = {
          status: 'quote_sent',
          quote_sent_at: new Date().toISOString(),
          quote_url: quoteUrl,
          quote_review_id: null,
          quote_rejection_notes: null
        };
        await supabase.from('service_requests').update(updateData).eq('id', sr.id);

      } else if (review.quote_type === 'supplement') {
        // === SUPPLEMENT: Generate PDF and send ===
        try {
          notify(lang === 'en' ? 'üìÑ Generating supplement PDF...' : 'üìÑ G√©n√©ration du PDF suppl√©ment...');
          const { blob, total } = await generateAvenantPDF(sr, qd.devices, { 
            businessSettings: qd.businessSettings, 
            supNumber: qd.supNumber 
          });
          
          const fileName = `supplement_${qd.supNumber || sr.request_number}_${Date.now()}.pdf`;
          const filePath = `supplements/${sr.request_number}/${fileName}`;
          const { error: uploadError } = await supabase.storage
            .from('documents')
            .upload(filePath, blob, { contentType: 'application/pdf' });
          
          if (uploadError) throw uploadError;
          
          const { data: urlData } = supabase.storage.from('documents').getPublicUrl(filePath);
          const avenantQuoteUrl = urlData?.publicUrl;
          
          await supabase.from('service_requests').update({
            avenant_total: total,
            avenant_sent_at: new Date().toISOString(),
            supplement_number: qd.supNumber,
            supplement_review_status: null,
            quote_review_id: null,
            bc_submitted_at: null,
            bc_file_url: null,
            bc_signature_url: null,
            bc_signed_by: null,
            bc_signature_date: null
          }).eq('id', sr.id);
          
          await supabase.from('request_attachments').insert({
            request_id: sr.id,
            file_name: `Suppl√©ment_${qd.supNumber || sr.request_number}.pdf`,
            file_url: avenantQuoteUrl,
            file_type: 'application/pdf',
            category: 'avenant_quote',
            device_serial: (qd.devices || []).map(d => d.serial_number).join(', ')
          });
        } catch (pdfErr) {
          throw pdfErr;
        }
      } else if (review.quote_type === 'contract') {
        // === CONTRACT QUOTE: Set status to quote_sent ===
        const qd = review.quote_data;
        const contractId = review.contract_id || qd.contractId;
        if (contractId) {
          await supabase.from('contracts').update({
            status: 'quote_sent',
            quote_sent_at: new Date().toISOString(),
            quote_review_id: null,
            quote_rejection_notes: null
          }).eq('id', contractId);
        }
      } else if (review.quote_type === 'rental') {
        // === RENTAL QUOTE: Generate PDF and set status to quote_sent ===
        const rentalId = review.rental_request_id || review.quote_data?.rentalId;
        console.log('üìÑ Rental quote approval - rentalId:', rentalId);
        if (rentalId) {
          // Generate quote number
          let quoteNumber = null;
          try {
            const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'DEV' });
            if (!docNumError && docNumData) quoteNumber = docNumData;
          } catch (e) { console.error('Could not generate quote number:', e); }
          if (!quoteNumber) {
            const mm = String(new Date().getMonth() + 1).padStart(2, '0');
            const yy = String(new Date().getFullYear()).slice(-2);
            quoteNumber = `DEV-${mm}${yy}-LOC`;
          }

          // Generate rental quote PDF
          let quoteUrl = null;
          try {
            const { data: rentalData, error: fetchErr } = await supabase.from('rental_requests')
              .select('*, companies(*)')
              .eq('id', rentalId).single();
            console.log('üìÑ Rental data fetched:', !!rentalData, 'error:', fetchErr);
            if (rentalData) {
              console.log('üìÑ Generating PDF with businessSettings:', !!businessSettings);
              const pdfBlob = await generateRentalQuotePDF({ ...rentalData, quote_number: quoteNumber }, review.quote_data, businessSettings);
              console.log('üìÑ PDF blob generated, size:', pdfBlob?.size);
              const fileName = `${quoteNumber}_${review.quote_data?.rentalNumber || 'LOC'}.pdf`;
              quoteUrl = await uploadPDFToStorage(pdfBlob, `quotes/${review.quote_data?.rentalNumber || rentalId}`, fileName);
              console.log('üìÑ PDF uploaded, URL:', quoteUrl);
            }
          } catch (pdfErr) {
            console.error('‚ùå Rental PDF generation error:', pdfErr);
          }

          const existingQD = review.quote_data || {};
          const approvalQuoteData = {
            ...existingQD,
            quote_sent_at: new Date().toISOString(),
            quote_number: quoteNumber,
            quote_review_id: null,
            quote_rejection_notes: null
          };
          if (quoteUrl) approvalQuoteData.quote_url = quoteUrl;
          console.log('üìÑ Updating rental with quote_data keys:', Object.keys(approvalQuoteData));
          
          const { error: updateErr } = await supabase.from('rental_requests').update({ 
            status: 'quote_sent', 
            quote_data: approvalQuoteData,
            quote_url: quoteUrl,
            quote_sent_at: new Date().toISOString()
          }).eq('id', rentalId);
          if (updateErr) console.error('‚ùå Rental update error:', updateErr);
          
          // Save PDF as attachment
          if (quoteUrl) {
            await supabase.from('request_attachments').insert({
              rental_request_id: rentalId,
              file_name: `${quoteNumber}_Devis_Location.pdf`,
              file_url: quoteUrl,
              file_type: 'application/pdf',
              uploaded_by: profile?.id,
              category: 'devis'
            });
          }
        }
      }
      
      // Mark review as approved
      await supabase.from('quote_reviews').update({
        status: 'approved',
        reviewed_by: profile?.id,
        reviewed_by_name: profile?.full_name || profile?.email || 'Admin',
        reviewed_at: new Date().toISOString()
      }).eq('id', review.id);
      
      notify(lang === 'en' ? '‚úÖ Quote approved and sent!' : '‚úÖ Devis approuv√© et envoy√© !');
      setSelectedReview(null);
      loadReviews();
      reload();
    } catch (err) {
      console.error('Approve error:', err);
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setProcessing(false);
  };

  // ========================
  // REJECT QUOTE
  // ========================
  const rejectQuote = async (review) => {
    // For supplements, validate per-device notes
    if (review.quote_type === 'supplement') {
      const hasAnyNotes = Object.values(supplementDeviceNotes).some(n => n && n.trim());
      if (!hasAnyNotes && !rejectionNotes.trim()) {
        notify(lang === 'en' ? 'Please add correction notes for at least one device' : 'Veuillez ajouter des notes de correction pour au moins un appareil', 'error');
        return;
      }
    } else if (!rejectionNotes.trim()) {
      notify(lang === 'en' ? 'Please describe what needs to be changed' : 'Veuillez d√©crire ce qui doit √™tre modifi√©', 'error');
      return;
    }
    setProcessing(true);
    try {
      if (review.quote_type === 'supplement') {
        // === SUPPLEMENT REJECTION: Keep main status, flag supplement for corrections ===
        await supabase.from('service_requests').update({
          supplement_review_status: 'corrections_needed',
          quote_review_id: null
        }).eq('id', review.service_request_id);
        
        // Store per-device supplement rejection notes
        const qd = review.quote_data || {};
        const reviewerName = profile?.full_name || profile?.email || 'Admin';
        for (const device of (qd.devices || [])) {
          const deviceNotes = supplementDeviceNotes[device.id];
          if (deviceNotes && deviceNotes.trim()) {
            await supabase.from('request_devices').update({
              supplement_rejection_notes: deviceNotes.trim(),
              supplement_rejection_by: reviewerName,
              supplement_rejection_at: new Date().toISOString()
            }).eq('id', device.id);
          }
        }
        // Also store general notes if any
        if (rejectionNotes.trim()) {
          for (const device of (qd.devices || [])) {
            if (!supplementDeviceNotes[device.id]?.trim()) {
              // Apply general note to devices without specific notes
              await supabase.from('request_devices').update({
                supplement_rejection_notes: rejectionNotes.trim(),
                supplement_rejection_by: reviewerName,
                supplement_rejection_at: new Date().toISOString()
              }).eq('id', device.id);
            }
          }
        }
      } else if (review.contract_id) {
        await supabase.from('contracts').update({
          status: 'requested',
          quote_review_id: null,
          quote_rejection_notes: rejectionNotes.trim()
        }).eq('id', review.contract_id);
      } else if (review.rental_request_id) {
        const rejQD = { ...(review.quote_data || {}), quote_review_id: null, quote_rejection_notes: rejectionNotes.trim() };
        await supabase.from('rental_requests').update({
          status: 'requested',
          quote_data: rejQD
        }).eq('id', review.rental_request_id);
      } else {
        // Initial/revision/parts quotes
        await supabase.from('service_requests').update({
          status: 'rma_created',
          quote_review_id: null,
          quote_rejection_notes: rejectionNotes.trim()
        }).eq('id', review.service_request_id);
      }
      
      // Mark review as rejected
      const allNotes = review.quote_type === 'supplement'
        ? [rejectionNotes.trim(), ...Object.entries(supplementDeviceNotes).filter(([,n]) => n?.trim()).map(([id, n]) => {
            const dev = (review.quote_data?.devices || []).find(d => d.id === id);
            return `[${dev?.model_name || ''} ${dev?.serial_number || ''}] ${n.trim()}`;
          })].filter(Boolean).join(' | ')
        : rejectionNotes.trim();
      
      await supabase.from('quote_reviews').update({
        status: 'rejected',
        rejection_notes: allNotes,
        reviewed_by: profile?.id,
        reviewed_by_name: profile?.full_name || profile?.email || 'Admin',
        reviewed_at: new Date().toISOString()
      }).eq('id', review.id);
      
      notify(lang === 'en' ? '‚úèÔ∏è Modification requested ‚Äî sent back for correction' : '‚úèÔ∏è Modification demand√©e ‚Äî renvoy√© pour correction');
      setRejecting(null);
      setRejectionNotes('');
      setSupplementDeviceNotes({});
      setSelectedReview(null);
      loadReviews();
      reload();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setProcessing(false);
  };

  // ========================
  // QUOTE PREVIEW RENDERER
  // ========================
const renderQuotePreview = (review) => {
    const qd = review.quote_data || {};
    
    // ============================================
    // INITIAL / REVISION QUOTE - Full document view
    // ============================================
    if (review.quote_type === 'initial' || review.quote_type === 'revision') {
      const devices = qd.devices || [];
      const bs = qd.businessSettings || {};
      
      return (
        <div className="border rounded-xl overflow-hidden">
          {/* Quote Header */}
          <div className="px-6 pt-6 pb-3 border-b-4 border-[#2D5A7B]">
            <div className="flex justify-between items-start">
              <div>
                <img src="/images/logos/Lighthouse-color-logo.jpg" alt="Lighthouse" className="h-10 object-contain" />
              </div>
              <div className="text-right">
                <p className="text-xl font-bold text-[#2D5A7B]">{review.quote_type === 'revision' ? 'DEVIS R√âVIS√â' : 'DEVIS'}</p>
                <p className="text-sm font-bold text-[#2D5A7B]">N¬∞ {qd.quoteNumber || review.quote_number || '‚Äî'}</p>
                {qd.newRevisionCount > 0 && <p className="text-xs text-amber-600 font-medium">R√©vision {qd.newRevisionCount}</p>}
                <p className="text-xs text-gray-500">RMA: {qd.rmaNumber || review.rma_number}</p>
              </div>
            </div>
          </div>
          
          {/* Info Bar */}
          <div className="bg-gray-100 px-6 py-2 flex justify-between text-xs border-b">
            <div><span className="text-gray-500">Date: </span><span className="font-medium">{new Date(qd.createdAt || review.submitted_at).toLocaleDateString('fr-FR')}</span></div>
            <div><span className="text-gray-500">Validit√©: </span><span className="font-medium">30 jours</span></div>
            <div><span className="text-gray-500">Cr√©√© par: </span><span className="font-medium">{qd.signatory || qd.createdBy || review.submitted_by_name}</span></div>
          </div>
          
          {/* Client */}
          <div className="px-6 py-3 border-b">
            <p className="text-xs text-gray-500 uppercase">Client</p>
            <p className="font-bold text-[#1a1a2e]">{review.client_name}</p>
          </div>
          
          {/* Contract info if applicable */}
          {qd.hasContractCoveredDevices && qd.contractInfo?.primaryContract && (
            <div className="px-6 py-2 bg-green-50 border-b border-green-200">
              <p className="text-sm text-green-700">üìÑ {lang === 'en' ? 'Contract' : 'Contrat'}: {qd.contractInfo.primaryContract.contract_number}</p>
            </div>
          )}
          
          {/* Per-Device Breakdown */}
          <div className="px-6 py-4 space-y-4">
            <h4 className="font-bold text-gray-800 text-sm uppercase tracking-wider">{lang === 'en' ? 'Services & Pricing' : 'Services & Tarification'}</h4>
            
            {devices.map((d, i) => {
              const lines = [];
              if (d.needsCalibration) lines.push({ desc: lang === 'en' ? 'Calibration' : '√âtalonnage', pn: d.calPartNumber, qty: d.calibrationQty || 1, price: d.calibrationPrice || 0 });
              if (d.needsRepair) lines.push({ desc: lang === 'en' ? 'Repair' : 'R√©paration', pn: d.repairPartNumber, qty: 1, price: d.repairPrice || 0 });
              if (d.needsNettoyage) lines.push({ desc: lang === 'en' ? 'Cleaning' : 'Nettoyage', pn: d.nettoyagePartNumber, qty: 1, price: d.nettoyagePrice || 0 });
              if (d.additionalParts) {
                (Array.isArray(d.additionalParts) ? d.additionalParts : []).forEach(p => {
                  lines.push({ desc: p.description || p.partNumber, pn: p.partNumber, qty: p.quantity || 1, price: p.unitPrice || p.price || 0 });
                });
              }
              
              return (
                <div key={i} className="border rounded-lg overflow-hidden">
                  {/* Device header */}
                  <div className="bg-gray-50 px-4 py-2 flex justify-between items-center border-b">
                    <div className="flex items-center gap-2">
                      {getDeviceImageUrl(d.model) && <img src={getDeviceImageUrl(d.model)} alt="" className="w-5 h-5 object-contain" />}
                      <span className="font-bold text-[#1a1a2e]">{d.model}</span>
                      <span className="font-mono text-xs text-gray-500">SN: {d.serial}</span>
                      {d.isContractCovered && <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">üìÑ Contrat</span>}
                    </div>
                    <span className="font-bold text-[#2D5A7B]">{(d.serviceTotal || 0).toFixed(2)} ‚Ç¨</span>
                  </div>
                  {/* Service line items */}
                  {lines.length > 0 && (
                    <table className="w-full text-sm">
                      <thead className="text-xs text-gray-500">
                        <tr className="border-b bg-gray-50/50">
                          <th className="text-left px-4 py-1.5">Description</th>
                          <th className="text-left px-2 py-1.5">{lang === 'en' ? 'Part #' : 'R√©f.'}</th>
                          <th className="text-center px-2 py-1.5">Qt√©</th>
                          <th className="text-right px-2 py-1.5">{lang === 'en' ? 'Unit' : 'P.U.'}</th>
                          <th className="text-right px-4 py-1.5">Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        {lines.map((line, j) => (
                          <tr key={j} className="border-b border-gray-50">
                            <td className="px-4 py-1.5">{line.desc}</td>
                            <td className="px-2 py-1.5 font-mono text-xs text-gray-500">{line.pn || '‚Äî'}</td>
                            <td className="px-2 py-1.5 text-center">{line.qty}</td>
                            <td className="px-2 py-1.5 text-right">{(parseFloat(line.price) || 0).toFixed(2)} ‚Ç¨</td>
                            <td className="px-4 py-1.5 text-right font-medium">{((parseFloat(line.price) || 0) * (line.qty || 1)).toFixed(2)} ‚Ç¨</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )}
                  {lines.length === 0 && d.isContractCovered && (
                    <div className="px-4 py-2 text-sm text-green-600 italic">{lang === 'en' ? 'Covered under contract' : 'Couvert par contrat'}</div>
                  )}
                </div>
              );
            })}
          </div>
          
          {/* Totals Section */}
          <div className="border-t bg-gray-50 px-6 py-4 space-y-1.5">
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">{lang === 'en' ? 'Services Subtotal' : 'Sous-total Services'}</span>
              <span className="font-medium">{(qd.servicesSubtotal || 0).toFixed(2)} ‚Ç¨</span>
            </div>
            {qd.shipping && (
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">
                  {lang === 'en' ? 'Shipping' : 'Transport'}
                  {qd.shipping.parcels > 0 && ` (${qd.shipping.parcels} ${lang === 'en' ? 'parcels' : 'colis'} √ó ${(qd.shipping.unitPrice || 0).toFixed(2)} ‚Ç¨)`}
                  {qd.shipping.partNumber && <span className="text-xs text-gray-400 ml-1">[{qd.shipping.partNumber}]</span>}
                </span>
                <span className="font-medium">{(qd.shippingTotal || qd.shipping.total || 0).toFixed(2)} ‚Ç¨</span>
              </div>
            )}
            {qd.discount?.enabled && (
              <div className="flex justify-between text-sm text-green-600">
                <span>
                  {lang === 'en' ? 'Discount' : 'Remise'}
                  {qd.discount.type === 'percentage' && ` (${qd.discount.value}%)`}
                  {qd.discount.note && ` ‚Äî ${qd.discount.note}`}
                </span>
                <span className="font-medium">-{(qd.discountAmount || qd.discount.amount || 0).toFixed(2)} ‚Ç¨</span>
              </div>
            )}
            <div className="flex justify-between font-bold text-xl pt-2 border-t-2 border-[#2D5A7B]">
              <span>TOTAL HT</span>
              <span className="text-[#00A651]">{(qd.grandTotal || review.total_amount || 0).toFixed(2)} ‚Ç¨</span>
            </div>
          </div>
        </div>
      );
    }
    
    // ============================================
    // PARTS QUOTE - Full breakdown
    // ============================================
    if (review.quote_type === 'parts') {
      const parts = qd.parts || [];
      return (
        <div className="border rounded-xl overflow-hidden">
          <div className="px-6 pt-6 pb-3 border-b-4 border-[#2D5A7B]">
            <div className="flex justify-between items-start">
              <div>
                <img src="/images/logos/Lighthouse-color-logo.jpg" alt="Lighthouse" className="h-10 object-contain" />
              </div>
              <div className="text-right">
                <p className="text-xl font-bold text-[#2D5A7B]">DEVIS PI√àCES</p>
                <p className="text-sm font-bold text-[#2D5A7B]">N¬∞ {qd.quoteNumber || qd.quoteRef || review.quote_number || '‚Äî'}</p>
                <p className="text-xs text-gray-500">PO: {qd.poNumber || review.rma_number}</p>
              </div>
            </div>
          </div>
          
          <div className="bg-gray-100 px-6 py-2 flex justify-between text-xs border-b">
            <div><span className="text-gray-500">Date: </span><span className="font-medium">{new Date(qd.createdAt || review.submitted_at).toLocaleDateString('fr-FR')}</span></div>
            <div><span className="text-gray-500">Cr√©√© par: </span><span className="font-medium">{qd.signatory || qd.createdBy || review.submitted_by_name}</span></div>
          </div>
          
          <div className="px-6 py-3 border-b">
            <p className="text-xs text-gray-500 uppercase">Client</p>
            <p className="font-bold text-[#1a1a2e]">{review.client_name}</p>
          </div>
          
          {/* Parts Table */}
          <div className="px-6 py-4">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b-2 border-gray-200 text-xs text-gray-500">
                  <th className="text-left py-2">{lang === 'en' ? 'Part #' : 'R√©f.'}</th>
                  <th className="text-left py-2">Description</th>
                  <th className="text-center py-2">Qt√©</th>
                  <th className="text-right py-2">{lang === 'en' ? 'Unit Price' : 'P.U. HT'}</th>
                  <th className="text-right py-2">Total HT</th>
                </tr>
              </thead>
              <tbody>
                {parts.map((p, i) => (
                  <tr key={i} className="border-b border-gray-100">
                    <td className="py-2 font-mono text-xs text-gray-600">{p.partNumber || '‚Äî'}</td>
                    <td className="py-2">{p.description}</td>
                    <td className="py-2 text-center">{p.quantity}</td>
                    <td className="py-2 text-right">{(p.unitPrice || 0).toFixed(2)} ‚Ç¨</td>
                    <td className="py-2 text-right font-medium">{(p.lineTotal || (p.quantity * p.unitPrice) || 0).toFixed(2)} ‚Ç¨</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          
          {/* Totals */}
          <div className="border-t bg-gray-50 px-6 py-4 space-y-1.5">
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">{lang === 'en' ? 'Parts Subtotal' : 'Sous-total Pi√®ces'}</span>
              <span className="font-medium">{(qd.partsTotal || 0).toFixed(2)} ‚Ç¨</span>
            </div>
            {qd.shipping && (
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">
                  {lang === 'en' ? 'Shipping' : 'Transport'}
                  {qd.shipping.parcels > 0 && ` (${qd.shipping.parcels} colis √ó ${(qd.shipping.unitPrice || 0).toFixed(2)} ‚Ç¨)`}
                </span>
                <span className="font-medium">{(qd.shipping.total || 0).toFixed(2)} ‚Ç¨</span>
              </div>
            )}
            <div className="flex justify-between font-bold text-xl pt-2 border-t-2 border-[#2D5A7B]">
              <span>TOTAL HT</span>
              <span className="text-[#00A651]">{(qd.grandTotal || review.total_amount || 0).toFixed(2)} ‚Ç¨</span>
            </div>
          </div>
        </div>
      );
    }
    
    // ============================================
    // SUPPLEMENT / AVENANT - Full breakdown
    // ============================================
    if (review.quote_type === 'supplement') {
      const devices = qd.devices || [];
      return (
        <div className="border rounded-xl overflow-hidden">
          <div className="px-6 pt-6 pb-3 border-b-4 border-[#2D5A7B]">
            <div className="flex justify-between items-start">
              <div>
                <img src="/images/logos/Lighthouse-color-logo.jpg" alt="Lighthouse" className="h-10 object-contain" />
              </div>
              <div className="text-right">
                <p className="text-xl font-bold text-[#2D5A7B]">SUPPL√âMENT AU DEVIS</p>
                <p className="text-sm font-bold text-[#2D5A7B]">N¬∞ {qd.supNumber || review.quote_number || '‚Äî'}</p>
                <p className="text-xs text-gray-500">RMA: {qd.rmaNumber || review.rma_number}</p>
              </div>
            </div>
          </div>
          
          <div className="px-6 py-3 border-b">
            <p className="text-xs text-gray-500 uppercase">Client</p>
            <p className="font-bold text-[#1a1a2e]">{review.client_name}</p>
          </div>
          
          <div className="px-6 py-2 bg-amber-50 border-b border-amber-200">
            <p className="text-sm text-amber-800">‚ö† {lang === 'en' ? 'Additional work identified during service' : 'Travaux suppl√©mentaires identifi√©s lors de l\'intervention'}</p>
          </div>
          
          {/* Per-device breakdown */}
          <div className="px-6 py-4 space-y-4">
            {devices.map((d, i) => {
              // Support both new format (additional_work_items array) and old format (additional_work_pricing object)
              let items = (d.additional_work_items || []).filter(item => !item.warranty);
              
              // Fallback: convert old additional_work_pricing format if new format is empty
              if (items.length === 0 && d.additional_work_pricing && typeof d.additional_work_pricing === 'object') {
                items = Object.entries(d.additional_work_pricing).map(([key, val]) => ({
                  description: val.description || key,
                  partNumber: val.partNumber || val.part_number || '',
                  part_number: val.partNumber || val.part_number || '',
                  quantity: val.quantity || 1,
                  price: val.price || 0
                }));
              }
              
              const deviceTotal = items.reduce((sum, item) => sum + (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1), 0);
              
              return (
                <div key={i} className="border rounded-lg overflow-hidden">
                  <div className="bg-gray-50 px-4 py-2 flex justify-between items-center border-b">
                    <div className="flex items-center gap-2">
                      {getDeviceImageUrl(d.model_name) && <img src={getDeviceImageUrl(d.model_name)} alt="" className="w-5 h-5 object-contain" />}
                      <span className="font-bold text-[#1a1a2e]">{d.model_name}</span>
                      <span className="font-mono text-xs text-gray-500">SN: {d.serial_number}</span>
                    </div>
                    <span className="font-bold text-[#2D5A7B]">{deviceTotal.toFixed(2)} ‚Ç¨</span>
                  </div>
                  
                  {d.service_findings && (
                    <div className="px-4 py-2 bg-blue-50 border-b text-sm">
                      <span className="text-xs text-gray-500 uppercase font-medium">{lang === 'en' ? 'Findings' : 'Constatations'}:</span>
                      <p className="text-gray-700 italic">{d.service_findings}</p>
                    </div>
                  )}
                  
                  {items.length > 0 && (
                    <table className="w-full text-sm">
                      <thead className="text-xs text-gray-500">
                        <tr className="border-b bg-gray-50/50">
                          <th className="text-left px-4 py-1.5">Description</th>
                          <th className="text-left px-2 py-1.5">{lang === 'en' ? 'Part #' : 'R√©f.'}</th>
                          <th className="text-center px-2 py-1.5">Qt√©</th>
                          <th className="text-right px-4 py-1.5">{lang === 'en' ? 'Price' : 'Prix'} HT</th>
                        </tr>
                      </thead>
                      <tbody>
                        {items.map((item, idx) => (
                          <tr key={idx} className="border-b border-gray-50">
                            <td className="px-4 py-1.5">{item.description || item.type || '‚Äî'}</td>
                            <td className="px-2 py-1.5 font-mono text-xs text-gray-500">{item.partNumber || item.part_number || '‚Äî'}</td>
                            <td className="px-2 py-1.5 text-center">{item.quantity || 1}</td>
                            <td className="px-4 py-1.5 text-right font-medium">{((parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1)).toFixed(2)} ‚Ç¨</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )}
                  
                  {/* Warranty items shown separately */}
                  {(d.additional_work_items || []).filter(item => item.warranty).length > 0 && (
                    <div className="px-4 py-2 bg-green-50 border-t">
                      <p className="text-xs text-green-700 font-medium mb-1">{lang === 'en' ? 'Under Warranty' : 'Sous Garantie'}</p>
                      {(d.additional_work_items || []).filter(item => item.warranty).map((item, idx) => (
                        <p key={idx} className="text-sm text-green-600">‚úì {item.description || item.type}</p>
                      ))}
                    </div>
                  )}
                  
                  {/* Debug: show raw data if no items found */}
                  {items.length === 0 && (
                    <div className="px-4 py-2 bg-yellow-50 border-t text-xs">
                      <p className="font-medium text-yellow-800 mb-1">‚ö† {lang === 'en' ? 'No pricing items found' : 'Aucun √©l√©ment tarifaire trouv√©'}</p>
                      <details>
                        <summary className="cursor-pointer text-yellow-600">Debug data</summary>
                        <pre className="text-xs text-gray-500 mt-1 whitespace-pre-wrap">{JSON.stringify({
                          additional_work_items: d.additional_work_items,
                          additional_work_pricing: d.additional_work_pricing,
                          keys: Object.keys(d)
                        }, null, 2)}</pre>
                      </details>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
          
          {/* Total */}
          <div className="border-t bg-[#2D5A7B] px-6 py-4">
            <div className="flex justify-between items-center text-white">
              <span className="text-lg font-bold">TOTAL SUPPL√âMENT HT</span>
              <span className="text-2xl font-bold">{(qd.avenantTotal || review.total_amount || 0).toFixed(2)} ‚Ç¨</span>
            </div>
          </div>
        </div>
      );
    }
    
    // ============================================
    // CONTRACT QUOTE
    // ============================================
    if (review.quote_type === 'contract') {
      const devices = qd.devices || [];
      return (
        <div className="border rounded-xl overflow-hidden">
          <div className="px-6 pt-6 pb-3 border-b-4 border-[#2D5A7B]">
            <div className="flex justify-between items-start">
              <div>
                <img src="/images/logos/Lighthouse-color-logo.jpg" alt="Lighthouse" className="h-10 object-contain" />
              </div>
              <div className="text-right">
                <p className="text-xl font-bold text-[#2D5A7B]">DEVIS CONTRAT</p>
                <p className="text-sm font-bold text-[#2D5A7B]">N¬∞ {qd.contractNumber || review.quote_number || '‚Äî'}</p>
              </div>
            </div>
          </div>
          
          <div className="px-6 py-3 border-b">
            <p className="text-xs text-gray-500 uppercase">Client</p>
            <p className="font-bold text-[#1a1a2e]">{review.client_name}</p>
          </div>
          
          {qd.contractDates && (
            <div className="px-6 py-2 bg-blue-50 border-b text-sm flex gap-6">
              <div><span className="text-gray-500">{lang === 'en' ? 'Start' : 'D√©but'}: </span><span className="font-medium">{qd.contractDates.start_date}</span></div>
              <div><span className="text-gray-500">{lang === 'en' ? 'End' : 'Fin'}: </span><span className="font-medium">{qd.contractDates.end_date}</span></div>
              {qd.totalTokens > 0 && <div><span className="text-gray-500">Tokens: </span><span className="font-medium">{qd.totalTokens}</span></div>}
            </div>
          )}
          
          {/* Devices */}
          <div className="px-6 py-4">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b-2 border-gray-200 text-xs text-gray-500">
                  <th className="text-left py-2">{lang === 'en' ? 'Device' : 'Appareil'}</th>
                  <th className="text-left py-2">SN</th>
                  <th className="text-center py-2">Tokens</th>
                  <th className="text-left py-2">Services</th>
                  <th className="text-right py-2">{lang === 'en' ? 'Price' : 'Prix'} HT</th>
                </tr>
              </thead>
              <tbody>
                {devices.map((d, i) => (
                  <tr key={i} className="border-b border-gray-100">
                    <td className="py-2 flex items-center gap-2">
                      {getDeviceImageUrl(d.model) && <img src={getDeviceImageUrl(d.model)} alt="" className="w-4 h-4 object-contain" />}
                      {d.model}
                    </td>
                    <td className="py-2 font-mono text-xs text-gray-500">{d.serial}</td>
                    <td className="py-2 text-center">{d.tokens_total || '‚Äî'}</td>
                    <td className="py-2 text-xs text-gray-600">
                      {d.needsCalibration && <span className="mr-1">üî¨ {(d.calibrationPrice || 0).toFixed(0)}‚Ç¨</span>}
                      {d.needsNettoyage && <span>üßπ {(d.nettoyagePrice || 0).toFixed(0)}‚Ç¨</span>}
                    </td>
                    <td className="py-2 text-right font-medium">{(d.calibrationPrice || 0).toFixed(2)} ‚Ç¨</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          
          <div className="border-t bg-gray-50 px-6 py-4 space-y-1.5">
            <div className="flex justify-between text-sm"><span className="text-gray-600">{lang === 'en' ? 'Services' : 'Services'}</span><span className="font-medium">{(qd.servicesSubtotal || 0).toFixed(2)} ‚Ç¨</span></div>
            <div className="flex justify-between text-sm"><span className="text-gray-600">{lang === 'en' ? 'Shipping' : 'Transport'}</span><span className="font-medium">{(qd.shippingTotal || 0).toFixed(2)} ‚Ç¨</span></div>
            <div className="flex justify-between font-bold text-xl pt-2 border-t-2 border-[#2D5A7B]"><span>TOTAL HT</span><span className="text-[#00A651]">{(qd.grandTotal || review.total_amount || 0).toFixed(2)} ‚Ç¨</span></div>
          </div>
        </div>
      );
    }
    
    // ============================================
    // RENTAL QUOTE
    // ============================================
    if (review.quote_type === 'rental') {
      const items = qd.quoteItems || qd.items || [];
      const period = qd.rentalPeriod || {};
      const rentalDays = period.days || items[0]?.rental_days || '‚Äî';
      return (
        <div className="border rounded-xl overflow-hidden">
          <div className="px-6 pt-6 pb-3 border-b-4 border-[#2D5A7B]">
            <div className="flex justify-between items-start">
              <img src="/images/logos/Lighthouse-color-logo.jpg" alt="Lighthouse" className="h-12 object-contain" />
              <div className="text-right">
                <p className="text-xl font-bold text-[#2D5A7B]">DEVIS LOCATION</p>
                <p className="text-sm font-bold text-[#2D5A7B]">N¬∞ {qd.rentalNumber || review.quote_number || '‚Äî'}</p>
              </div>
            </div>
          </div>
          
          <div className="px-6 py-3 border-b bg-gray-50 flex justify-between">
            <div><p className="text-xs text-gray-500 uppercase">Client</p><p className="font-bold text-[#1a1a2e]">{review.client_name}</p></div>
            <div className="text-right"><p className="text-xs text-gray-500 uppercase">Validit√©</p><p className="font-medium">30 jours</p></div>
          </div>
          
          {(period.start || period.end) && (
            <div className="px-6 py-2 bg-blue-50 border-b text-sm">
              <span className="font-medium text-blue-800">üìÖ P√©riode :</span> {period.start ? new Date(period.start).toLocaleDateString('fr-FR') : '‚Äî'} au {period.end ? new Date(period.end).toLocaleDateString('fr-FR') : '‚Äî'} ({rentalDays} jours)
            </div>
          )}
          
          {/* Equipment details */}
          {items.map((item, i) => (
            <div key={i} className="px-6 py-4 border-b">
              <p className="font-bold text-[#1a1a2e]">Location {item.item_name || '‚Äî'}</p>
              {item.specs && <p className="text-sm text-gray-600 mt-1 whitespace-pre-line">{item.specs}</p>}
              <div className="flex justify-between mt-2 pt-2 border-t border-dashed text-sm">
                <span className="text-gray-600">Prix de location ({rentalDays} jours)</span>
                <span className="font-bold">{(parseFloat(item.line_total) || 0).toFixed(2)} ‚Ç¨ HT</span>
              </div>
              {(item.retail_value || 0) > 0 && (
                <div className="flex justify-between text-xs text-gray-400"><span>Valeur neuf</span><span>{parseFloat(item.retail_value).toFixed(2)} ‚Ç¨ HT</span></div>
              )}
            </div>
          ))}

          {/* Totals */}
          <div className="px-6 py-4 bg-gray-50 space-y-1.5">
            {(qd.discount || 0) > 0 && <>
              <div className="flex justify-between text-sm"><span>Sous-total</span><span>{(qd.subtotalBeforeDiscount || 0).toFixed(2)} ‚Ç¨</span></div>
              <div className="flex justify-between text-sm text-green-600"><span>Remise {qd.discountType === 'percent' ? `(${qd.discount}%)` : '(forfait)'}</span><span>-{(qd.discountAmount || 0).toFixed(2)} ‚Ç¨</span></div>
            </>}
            {(qd.shipping || 0) > 0 && <div className="flex justify-between text-sm"><span>Transport</span><span>{(qd.shipping || 0).toFixed(2)} ‚Ç¨</span></div>}
            <div className="flex justify-between font-bold text-lg pt-2 border-t"><span>TOTAL HT</span><span className="text-[#00A651]">{(qd.totalHT || review.total_amount || 0).toFixed(2)} ‚Ç¨</span></div>
            <div className="flex justify-between text-sm text-gray-500"><span>TTC ({qd.taxRate || 20}%)</span><span>{(qd.totalTTC || 0).toFixed(2)} ‚Ç¨</span></div>
          </div>

          {/* Insurance conditions */}
          <div className="px-6 py-4 border-t">
            <p className="font-bold text-xs text-gray-800 mb-1">Conditions d'assurance</p>
            <p className="text-xs text-gray-600 leading-relaxed">
              Pendant la dur√©e de la location, l'appareil reste la propri√©t√© de Lighthouse France et devient sous la responsabilit√© du client. 
              L'appareil doit √™tre entrepos√© dans ses conditions normales d'exploitation et restitu√© en parfait √©tat. 
              Tout incident doit nous √™tre communiqu√© sous 48h. Le client s'engage √† souscrire une assurance prenant en compte le "Bien Confi√©".
            </p>
            {(qd.totalRetailValue || 0) > 0 && <p className="text-xs font-medium text-gray-700 mt-1">Valeur √† assurer : {(qd.totalRetailValue).toFixed(2)} ‚Ç¨ HT</p>}
          </div>

          {/* Terms */}
          <div className="px-6 py-3 border-t text-xs text-gray-500 flex justify-between">
            <span>Livraison : {qd.deliveryTerms || '‚Äî'}</span>
            <span>Paiement : {qd.paymentTerms || '‚Äî'}</span>
          </div>

          {qd.notes && <div className="px-6 py-3 bg-amber-50 border-t text-sm"><span className="font-medium">Notes :</span> {qd.notes}</div>}
        </div>
      );
    }
    
    // Generic fallback - show raw data
    return (
      <div className="bg-gray-50 rounded-lg p-4">
        <pre className="text-xs text-gray-600 whitespace-pre-wrap">{JSON.stringify(qd, null, 2)}</pre>
      </div>
    );
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? 'üìã Quote Review' : 'üìã V√©rification des Devis'}</h1>
        <div className="flex gap-2">
          <button onClick={loadReviews} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">
            üîÑ {lang === 'en' ? 'Refresh' : 'Actualiser'}
          </button>
        </div>
      </div>

      {/* Filter tabs */}
      <div className="flex gap-2">
        {[
          { id: 'pending', label: lang === 'en' ? 'Pending Review' : 'En attente', icon: '‚è≥', count: reviews.filter(r => r.status === 'pending').length, color: 'amber' },
          { id: 'approved', label: lang === 'en' ? 'Approved' : 'Approuv√©s', icon: '‚úÖ', count: reviews.filter(r => r.status === 'approved').length, color: 'green' }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setFilter(tab.id)}
            className={`px-4 py-2.5 rounded-lg font-medium flex items-center gap-2 transition-colors ${
              filter === tab.id 
                ? `bg-${tab.color}-500 text-white` 
                : 'bg-white text-gray-600 hover:bg-gray-50 border'
            }`}
          >
            {tab.icon} {tab.label}
            {tab.count > 0 && (
              <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                filter === tab.id ? 'bg-white/20' : `bg-${tab.color}-100 text-${tab.color}-700`
              }`}>{tab.count}</span>
            )}
          </button>
        ))}
      </div>

      {/* Reviews list */}
      {loading ? (
        <div className="bg-white rounded-xl p-12 text-center">
          <div className="w-10 h-10 border-4 border-[#00A651] border-t-transparent rounded-full animate-spin mx-auto" />
        </div>
      ) : filtered.length === 0 ? (
        <div className="bg-white rounded-xl p-12 text-center text-gray-400">
          {filter === 'pending' 
            ? (lang === 'en' ? 'No quotes pending review' : 'Aucun devis en attente de v√©rification') 
            : (lang === 'en' ? 'No approved quotes yet' : 'Aucun devis approuv√©')}
        </div>
      ) : (
        <div className="bg-white rounded-xl shadow-sm overflow-hidden">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">RMA</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">{t('client')}</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">Type</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">{lang === 'en' ? 'Devices' : 'Appareils'}</th>
                <th className="px-4 py-3 text-right text-xs font-bold text-gray-600">Total</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">{lang === 'en' ? 'Submitted by' : 'Soumis par'}</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">Date</th>
                <th className="px-4 py-3 text-right text-xs font-bold text-gray-600">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {filtered.map(review => (
                <tr key={review.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3">
                    <span className="font-mono font-bold text-[#00A651]">{review.rma_number || '‚Äî'}</span>
                    {review.quote_number && <p className="text-xs text-gray-400">{review.quote_number}</p>}
                  </td>
                  <td className="px-4 py-3 font-medium">{review.client_name || '‚Äî'}</td>
                  <td className="px-4 py-3">
                    <span className={`px-2 py-1 rounded text-xs font-medium ${getTypeColor(review.quote_type)}`}>
                      {getTypeLabel(review.quote_type)}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-600 max-w-[200px] truncate">{review.device_summary || '‚Äî'}</td>
                  <td className="px-4 py-3 text-right font-bold">{(review.total_amount || 0).toFixed(2)} ‚Ç¨</td>
                  <td className="px-4 py-3 text-sm text-gray-600">{review.submitted_by_name || '‚Äî'}</td>
                  <td className="px-4 py-3 text-sm text-gray-500">{review.submitted_at ? new Date(review.submitted_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : '‚Äî'}</td>
                  <td className="px-4 py-3 text-right">
                    <button
                      onClick={() => setSelectedReview(review)}
                      className="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm font-medium"
                    >
                      {lang === 'en' ? 'Review' : 'V√©rifier'} ‚Üí
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Review Detail Modal */}
      {selectedReview && (
        <div className="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4" onClick={() => { setSelectedReview(null); setRejecting(null); setRejectionNotes(''); }}>
          <div className="bg-white rounded-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div className="px-6 py-4 border-b bg-[#1a1a2e] text-white flex justify-between items-center">
              <div>
                <h2 className="text-lg font-bold">{lang === 'en' ? 'Quote Review' : 'V√©rification du Devis'}</h2>
                <p className="text-sm text-gray-300">
                  {selectedReview.rma_number} ‚Ä¢ {selectedReview.client_name} ‚Ä¢ <span className={`px-2 py-0.5 rounded text-xs ${getTypeColor(selectedReview.quote_type)}`}>{getTypeLabel(selectedReview.quote_type)}</span>
                </p>
              </div>
              <button onClick={() => { setSelectedReview(null); setRejecting(null); setRejectionNotes(''); }} className="text-white/60 hover:text-white text-2xl">√ó</button>
            </div>
            
            {/* Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {/* Submitter info */}
              <div className="flex items-center gap-3 mb-4 p-3 bg-blue-50 rounded-lg">
                <span className="w-8 h-8 bg-blue-200 rounded-full flex items-center justify-center text-sm">üë§</span>
                <div>
                  <p className="font-medium text-blue-800">{lang === 'en' ? 'Submitted by' : 'Soumis par'}: {selectedReview.submitted_by_name}</p>
                  <p className="text-xs text-blue-600">{selectedReview.submitted_at ? new Date(selectedReview.submitted_at).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') : ''}</p>
                </div>
              </div>

              {/* Rejection notes if already rejected */}
              {selectedReview.status === 'rejected' && selectedReview.rejection_notes && (
                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                  <p className="font-medium text-red-800">‚ùå {lang === 'en' ? 'Rejected' : 'Rejet√©'}: {selectedReview.rejection_notes}</p>
                  <p className="text-xs text-red-600">{lang === 'en' ? 'By' : 'Par'}: {selectedReview.reviewed_by_name} ‚Äî {selectedReview.reviewed_at ? new Date(selectedReview.reviewed_at).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') : ''}</p>
                </div>
              )}

              {/* Approved info */}
              {selectedReview.status === 'approved' && (
                <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                  <p className="font-medium text-green-800">‚úÖ {lang === 'en' ? 'Approved' : 'Approuv√©'}</p>
                  <p className="text-xs text-green-600">{lang === 'en' ? 'By' : 'Par'}: {selectedReview.reviewed_by_name} ‚Äî {selectedReview.reviewed_at ? new Date(selectedReview.reviewed_at).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') : ''}</p>
                </div>
              )}

              {/* Quote preview */}
              {renderQuotePreview(selectedReview)}
              
              {/* Modification request input */}
              {rejecting === selectedReview.id && selectedReview.quote_type === 'supplement' ? (
                <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg space-y-3">
                  <p className="font-medium text-amber-800">‚úèÔ∏è {lang === 'en' ? 'Select devices that need correction:' : 'S√©lectionnez les appareils √† corriger :'}</p>
                  
                  {/* Per-device notes */}
                  {(selectedReview.quote_data?.devices || []).map(d => (
                    <div key={d.id} className="bg-white rounded-lg border border-amber-200 p-3 space-y-2">
                      <div className="flex items-center gap-2">
                        {getDeviceImageUrl(d.model_name) && <img src={getDeviceImageUrl(d.model_name)} alt="" className="w-5 h-5 object-contain" />}
                        <span className="font-bold text-sm">{d.model_name}</span>
                        <span className="font-mono text-xs text-gray-500">SN: {d.serial_number}</span>
                      </div>
                      <textarea
                        value={supplementDeviceNotes[d.id] || ''}
                        onChange={e => setSupplementDeviceNotes(prev => ({ ...prev, [d.id]: e.target.value }))}
                        rows={2}
                        className="w-full px-3 py-2 border border-amber-200 rounded-lg text-sm focus:ring-2 focus:ring-amber-400"
                        placeholder={lang === 'en' ? 'What needs to change on this device? (leave blank to skip)' : 'Que faut-il modifier sur cet appareil ? (laisser vide pour ignorer)'}
                      />
                    </div>
                  ))}
                  
                  {/* General note */}
                  <div>
                    <p className="text-xs text-amber-600 mb-1">{lang === 'en' ? 'General note (optional):' : 'Note g√©n√©rale (optionnel) :'}</p>
                    <textarea
                      value={rejectionNotes}
                      onChange={e => setRejectionNotes(e.target.value)}
                      rows={2}
                      className="w-full px-3 py-2 border border-amber-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-400"
                      placeholder={lang === 'en' ? 'General correction notes...' : 'Notes de correction g√©n√©rales...'}
                    />
                  </div>
                  
                  <div className="flex gap-2">
                    <button
                      onClick={() => rejectQuote(selectedReview)}
                      disabled={processing || (!rejectionNotes.trim() && !Object.values(supplementDeviceNotes).some(n => n?.trim()))}
                      className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium disabled:opacity-50"
                    >
                      {processing ? '...' : (lang === 'en' ? '‚úèÔ∏è Send Back to Technician' : '‚úèÔ∏è Renvoyer au Technicien')}
                    </button>
                    <button onClick={() => { setRejecting(null); setRejectionNotes(''); setSupplementDeviceNotes({}); }} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                      {lang === 'en' ? 'Cancel' : 'Annuler'}
                    </button>
                  </div>
                </div>
              ) : rejecting === selectedReview.id && (
                <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg space-y-3">
                  <p className="font-medium text-amber-800">‚úèÔ∏è {lang === 'en' ? 'What needs to be changed?' : 'Que faut-il modifier ?'}</p>
                  <textarea
                    value={rejectionNotes}
                    onChange={e => setRejectionNotes(e.target.value)}
                    rows={3}
                    className="w-full px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-400"
                    placeholder={lang === 'en' ? 'Describe what needs to be corrected...' : 'D√©crivez ce qui doit √™tre corrig√©...'}
                    autoFocus
                  />
                  <div className="flex gap-2">
                    <button
                      onClick={() => rejectQuote(selectedReview)}
                      disabled={processing || !rejectionNotes.trim()}
                      className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium disabled:opacity-50"
                    >
                      {processing ? '...' : (lang === 'en' ? '‚úèÔ∏è Send Back for Correction' : '‚úèÔ∏è Renvoyer pour Correction')}
                    </button>
                    <button onClick={() => { setRejecting(null); setRejectionNotes(''); }} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                      {lang === 'en' ? 'Cancel' : 'Annuler'}
                    </button>
                  </div>
                </div>
              )}
            </div>
            
            {/* Footer actions - only for pending */}
            {selectedReview.status === 'pending' && rejecting !== selectedReview.id && (
              <div className="px-6 py-4 border-t bg-gray-50 flex justify-between items-center">
                <button
                  onClick={() => setRejecting(selectedReview.id)}
                  disabled={processing}
                  className="px-5 py-2.5 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium disabled:opacity-50"
                >
                  ‚úèÔ∏è {lang === 'en' ? 'Request Modification' : 'Demander Modification'}
                </button>
                <button
                  onClick={() => approveQuote(selectedReview)}
                  disabled={processing}
                  className="px-6 py-2.5 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-bold disabled:opacity-50"
                >
                  {processing ? (lang === 'en' ? 'Processing...' : 'En cours...') : (lang === 'en' ? '‚úÖ Approve & Send' : '‚úÖ Approuver & Envoyer')}
                </button>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// KPI SHEET - Business Analytics Dashboard
// ============================================
function KPISheet({ requests = [], clients = [], t = k=>k, lang = 'fr' }) {
  // Date range state
  const [dateFrom, setDateFrom] = useState(() => {
    const d = new Date();
    d.setDate(d.getDate() - 30);
    return d.toISOString().split('T')[0];
  });
  const [dateTo, setDateTo] = useState(() => new Date().toISOString().split('T')[0]);
  
  // Filters
  const [serviceFilter, setServiceFilter] = useState('all'); // 'all', 'calibration', 'repair'
  const [statusFilter, setStatusFilter] = useState('shipped'); // 'all', 'shipped'
  const [selectedTech, setSelectedTech] = useState(null);
  
  // Stage-to-stage analysis
  const [stageFrom, setStageFrom] = useState('file_attente');
  const [stageTo, setStageTo] = useState('qc_complete');
  
  // Quick date presets
  const setPreset = (days) => {
    const to = new Date();
    const from = new Date();
    if (days === 'ytd') {
      from.setMonth(0, 1);
    } else {
      from.setDate(from.getDate() - days);
    }
    setDateFrom(from.toISOString().split('T')[0]);
    setDateTo(to.toISOString().split('T')[0]);
  };
  
  // Stage options - full labels for dropdowns, short for display
  const stageOptions = [
    { value: 'created', label: lang === 'en' ? 'Created (RMA submitted)' : 'Cr√©√© (RMA soumis)', short: lang === 'en' ? 'Created' : 'Cr√©√©' },
    { value: 'received', label: lang === 'en' ? 'Received' : 'Re√ßu', short: t('stReceived') },
    { value: 'file_attente', label: lang === 'en' ? 'Queue (awaiting PO)' : 'File d\'attente (en attente BC)', short: 'File' },
    { value: 'bc_approved', label: lang === 'en' ? 'PO approved' : 'BC approuv√©', short: 'BC' },
    { value: 'calibration_start', label: lang === 'en' ? 'Start calibration' : 'D√©but √©talonnage', short: lang === 'en' ? 'Cal.' : '√âtal.' },
    { value: 'report_complete', label: lang === 'en' ? 'Report completed' : 'Rapport termin√©', short: lang === 'en' ? 'Report' : 'Rapport' },
    { value: 'qc_complete', label: lang === 'en' ? 'QC completed' : 'QC termin√©', short: 'QC' },
    { value: 'shipped', label: lang === 'en' ? 'Shipped' : 'Exp√©di√©', short: t('stShipped') }
  ];
  
  // Helper to get short label
  const getShortLabel = (value) => stageOptions.find(s => s.value === value)?.short || value;
  
  // Get stage timestamp
  const getStageDate = (device, stage) => {
    const rma = device.rma;
    switch(stage) {
      case 'created': return rma?.created_at;
      case 'received': return device.received_at || rma?.received_at;
      case 'file_attente': return device.received_at || rma?.received_at; // Same as received - when they enter queue
      case 'bc_approved': return rma?.bc_approved_at;
      case 'calibration_start': return device.calibration_started_at;
      case 'report_complete': return device.report_complete ? (device.report_completed_at || device.updated_at) : null;
      case 'qc_complete': return device.qc_complete ? (device.qc_completed_at || device.updated_at) : null;
      case 'shipped': return device.shipped_at || rma?.shipped_at;
      default: return null;
    }
  };
  
  // Calculate days between stages
  const calculateDays = (device, from, to) => {
    const fromDate = getStageDate(device, from);
    const toDate = getStageDate(device, to);
    if (!fromDate || !toDate) return null;
    const diff = (new Date(toDate) - new Date(fromDate)) / (1000 * 60 * 60 * 24);
    return diff >= 0 && diff < 365 ? diff : null;
  };
  
  // Safe data
  const safeRequests = Array.isArray(requests) ? requests : [];
  const rmaRequests = safeRequests.filter(r => r && r.request_type !== 'parts' && r.request_number);
  
  // Parse dates
  const fromDate = new Date(dateFrom);
  const toDate = new Date(dateTo);
  toDate.setHours(23, 59, 59, 999);
  
  // Get all devices with RMA reference
  const allDevices = [];
  rmaRequests.forEach(r => {
    if (r && Array.isArray(r.request_devices)) {
      r.request_devices.forEach(d => {
        if (d) allDevices.push({ ...d, rma: r });
      });
    }
  });
  
  // Filter by service type
  const filteredByService = allDevices.filter(d => {
    if (serviceFilter === 'all') return true;
    const service = d.rma?.requested_service || '';
    if (serviceFilter === 'calibration') return service === 'calibration';
    if (serviceFilter === 'repair') return service === 'repair';
    return true;
  });
  
  // Filter by status (shipped or all)
  const filteredByStatus = filteredByService.filter(d => {
    if (statusFilter === 'all') return true;
    return d.shipped_at || d.rma?.shipped_at;
  });
  
  // Filter by date range (based on the "from" stage date)
  const filteredByDate = filteredByStatus.filter(d => {
    const stageDate = getStageDate(d, stageFrom);
    if (!stageDate) return false;
    const date = new Date(stageDate);
    return date >= fromDate && date <= toDate;
  });
  
  // Get unique technicians from filtered devices
  const technicianSet = new Set();
  filteredByDate.forEach(d => {
    const tech = d.technician_name;
    if (tech) technicianSet.add(tech);
  });
  const technicians = Array.from(technicianSet).sort();
  
  // Filter by selected technician
  const filteredByTech = selectedTech 
    ? filteredByDate.filter(d => d.technician_name === selectedTech)
    : filteredByDate;
  
  // Calculate duration for each device
  const devicesWithDuration = filteredByTech.map(d => ({
    ...d,
    duration: calculateDays(d, stageFrom, stageTo)
  }));
  
  // Devices that have valid duration (both stages completed)
  const devicesWithValidDuration = devicesWithDuration.filter(d => d.duration !== null);
  
  // Calculate totals
  const totalDevices = devicesWithDuration.length;
  const devicesWithData = devicesWithValidDuration.length;
  const totalDays = devicesWithValidDuration.reduce((sum, d) => sum + d.duration, 0);
  const avgDays = devicesWithData > 0 ? totalDays / devicesWithData : 0;
  
  // Revenue calculation
  const rmaRevenueMap = {};
  rmaRequests.forEach(r => {
    const quoteData = r.quote_data || {};
    const total = parseFloat(quoteData.grandTotal || quoteData.total || 0) || 0;
    const deviceCount = (r.request_devices || []).length || 1;
    rmaRevenueMap[r.id] = total / deviceCount;
  });
  
  const totalRevenue = devicesWithDuration.reduce((sum, d) => sum + (rmaRevenueMap[d.rma?.id] || 0), 0);
  
  // Technician summary stats (for the sidebar)
  const techStats = {};
  filteredByDate.forEach(d => {
    const tech = d.technician_name || (lang === 'en' ? 'Unassigned' : 'Non assign√©');
    if (!techStats[tech]) {
      techStats[tech] = { count: 0, revenue: 0 };
    }
    techStats[tech].count++;
    techStats[tech].revenue += rmaRevenueMap[d.rma?.id] || 0;
  });
  
  const techArray = Object.entries(techStats)
    .map(([name, s]) => ({ name, count: s.count, revenue: s.revenue }))
    .sort((a, b) => b.count - a.count);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? 'üìà KPI Analysis' : 'üìà Analyse KPI'}</h1>
      </div>
      
      {/* Filters Row */}
      <div className="bg-white rounded-xl shadow-sm p-4">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {/* Date Range */}
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-1">{lang === 'en' ? 'Period' : 'P√©riode'}</label>
            <div className="flex items-center gap-2">
              <input type="date" value={dateFrom} onChange={(e) => setDateFrom(e.target.value)}
                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
              <span className="text-gray-400">‚Üí</span>
              <input type="date" value={dateTo} onChange={(e) => setDateTo(e.target.value)}
                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" />
            </div>
            <div className="flex gap-1 mt-2">
              <button onClick={() => setPreset(7)} className="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs">{lang === 'en' ? '7d' : '7j'}</button>
              <button onClick={() => setPreset(30)} className="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs">{lang === 'en' ? '30d' : '30j'}</button>
              <button onClick={() => setPreset(90)} className="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs">{lang === 'en' ? '3m' : '3m'}</button>
              <button onClick={() => setPreset(365)} className="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs">{lang === 'en' ? '1yr' : '1an'}</button>
            </div>
          </div>
          
          {/* Service Type + Status (Combined - smaller) */}
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">{lang === 'en' ? 'Service' : 'Service'}</label>
              <select value={serviceFilter} onChange={(e) => setServiceFilter(e.target.value)}
                className="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm">
                <option value="all">{lang === 'en' ? 'All' : 'Tous'}</option>
                <option value="calibration">{t('calibration')}</option>
                <option value="repair">{t('repair')}</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">{t('status')}</label>
              <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)}
                className="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm">
                <option value="shipped">{lang === 'en' ? 'Closed' : 'Cl√¥tur√©s'}</option>
                <option value="all">{lang === 'en' ? 'All' : 'Tous'}</option>
              </select>
            </div>
          </div>
          
          {/* Stage Analysis */}
          <div>
            <label className="block text-sm font-medium text-gray-600 mb-1">{lang === 'en' ? 'Step Analysis' : 'Analyse √©tapes'}</label>
            <div className="flex items-center gap-2">
              <select value={stageFrom} onChange={(e) => setStageFrom(e.target.value)}
                className="flex-1 px-2 py-2 border border-gray-300 rounded-lg text-sm">
                {stageOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
              </select>
              <span className="text-gray-400">‚Üí</span>
              <select value={stageTo} onChange={(e) => setStageTo(e.target.value)}
                className="flex-1 px-2 py-2 border border-gray-300 rounded-lg text-sm">
                {stageOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
              </select>
            </div>
          </div>
        </div>
      </div>
      
      {/* Main Content - Two Columns */}
      <div className="grid lg:grid-cols-4 gap-6">
        {/* Left Sidebar - Technician List */}
        <div className="lg:col-span-1">
          <div className="bg-white rounded-xl shadow-sm p-4">
            <h2 className="text-lg font-bold text-gray-800 mb-3">{lang === 'en' ? 'üë®‚Äçüîß Technicians' : 'üë®‚Äçüîß Techniciens'}</h2>
            
            {/* All Technicians option */}
            <button
              onClick={() => setSelectedTech(null)}
              className={`w-full text-left p-3 rounded-lg mb-2 transition ${
                selectedTech === null ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50 hover:bg-gray-100'
              }`}
            >
              <p className="font-medium text-gray-800">{lang === 'en' ? 'All technicians' : 'Tous les techniciens'}</p>
              <p className="text-sm text-gray-500">{filteredByDate.length} appareils</p>
            </button>
            
            <div className="space-y-2 max-h-96 overflow-y-auto">
              {techArray.map((tech, i) => (
                <button
                  key={tech.name}
                  onClick={() => setSelectedTech(tech.name)}
                  className={`w-full text-left p-3 rounded-lg transition ${
                    selectedTech === tech.name ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50 hover:bg-gray-100'
                  }`}
                >
                  <div className="flex items-center gap-2">
                    <div className={`w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold ${
                      i === 0 ? 'bg-amber-500' : i === 1 ? 'bg-gray-400' : i === 2 ? 'bg-amber-700' : 'bg-gray-300'
                    }`}>
                      {i + 1}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-gray-800 truncate">{tech.name}</p>
                      <p className="text-xs text-gray-500">{tech.count} {lang === 'en' ? 'devices' : 'appareils'} ‚Ä¢ {tech.revenue.toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR')} ‚Ç¨</p>
                    </div>
                  </div>
                </button>
              ))}
              {techArray.length === 0 && (
                <p className="text-gray-400 text-center py-4 text-sm">{lang === 'en' ? 'No technicians' : 'Aucun technicien'}</p>
              )}
            </div>
          </div>
        </div>
        
        {/* Right Side - Data Table */}
        <div className="lg:col-span-3">
          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div className="bg-white rounded-xl p-4 shadow-sm border-l-4 border-blue-500">
              <p className="text-2xl font-bold text-gray-800">{totalDevices}</p>
              <p className="text-sm text-gray-500">{lang === 'en' ? 'Total devices' : 'Appareils total'}</p>
            </div>
            <div className="bg-white rounded-xl p-4 shadow-sm border-l-4 border-green-500">
              <p className="text-2xl font-bold text-gray-800">{devicesWithData}</p>
              <p className="text-sm text-gray-500">{lang === 'en' ? 'With timing data' : 'Avec donn√©es timing'}</p>
            </div>
            <div className="bg-white rounded-xl p-4 shadow-sm border-l-4 border-purple-500">
              <p className="text-2xl font-bold text-gray-800">{avgDays.toFixed(1)}j</p>
              <p className="text-sm text-gray-500">Moyenne {getShortLabel(stageFrom)} ‚Üí {getShortLabel(stageTo)}</p>
            </div>
            <div className="bg-white rounded-xl p-4 shadow-sm border-l-4 border-amber-500">
              <p className="text-2xl font-bold text-gray-800">{totalRevenue.toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR')} ‚Ç¨</p>
              <p className="text-sm text-gray-500">{lang === 'en' ? 'Total Revenue' : 'CA Total'}</p>
            </div>
          </div>
          
          {/* Selected Technician Header */}
          {selectedTech && (
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4 flex items-center justify-between">
              <div>
                <p className="text-sm text-blue-600">{lang === 'en' ? 'Selected technician' : 'Technicien s√©lectionn√©'}</p>
                <p className="text-xl font-bold text-blue-800">{selectedTech}</p>
              </div>
              <button onClick={() => setSelectedTech(null)} className="text-blue-600 hover:text-blue-800 text-sm">
                ‚úï Effacer la s√©lection
              </button>
            </div>
          )}
          
          {/* Data Table */}
          <div className="bg-white rounded-xl shadow-sm overflow-hidden">
            <div className="p-4 border-b border-gray-200">
              <h2 className="text-lg font-bold text-gray-800">
                üìã D√©tail des appareils
                <span className="text-sm font-normal text-gray-500 ml-2">
                  ({getShortLabel(stageFrom)} ‚Üí {getShortLabel(stageTo)})
                </span>
              </h2>
            </div>
            
            <div className="max-h-96 overflow-y-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50 sticky top-0">
                  <tr>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">RMA</th>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">{t('client')}</th>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">{t('device')}</th>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">{t('serialNumber')}</th>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">{lang === 'en' ? 'Technician' : 'Technicien'}</th>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">{lang === 'en' ? 'Service' : 'Service'}</th>
                    <th className="px-4 py-3 text-right font-medium text-gray-600">{lang === 'en' ? 'Duration' : 'Dur√©e'}</th>
                    <th className="px-4 py-3 text-right font-medium text-gray-600">{lang === 'en' ? 'Revenue' : 'CA'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {devicesWithDuration.length === 0 ? (
                    <tr>
                      <td colSpan={8} className="px-4 py-8 text-center text-gray-400">
                        {lang === 'en' ? 'No devices found for these criteria' : 'Aucun appareil trouv√© pour ces crit√®res'}
                      </td>
                    </tr>
                  ) : (
                    devicesWithDuration.slice(0, 100).map((d, i) => (
                      <tr key={i} className="hover:bg-gray-50">
                        <td className="px-4 py-2 font-mono text-green-600 text-xs">{d.rma?.request_number || '‚Äî'}</td>
                        <td className="px-4 py-2 truncate max-w-32">{d.rma?.companies?.name || '‚Äî'}</td>
                        <td className="px-4 py-2"><div className="flex items-center gap-1.5">{getDeviceImageUrl(d.model_name || d.model) && <img src={getDeviceImageUrl(d.model_name || d.model)} alt="" className="w-4 h-4 object-contain" />}{d.model_name || d.model || '‚Äî'}</div></td>
                        <td className="px-4 py-2 font-mono text-gray-500 text-xs">{d.serial_number || '‚Äî'}</td>
                        <td className="px-4 py-2">{d.technician_name || '‚Äî'}</td>
                        <td className="px-4 py-2">
                          <span className={`px-2 py-0.5 rounded text-xs ${
                            d.rma?.requested_service === 'calibration' ? 'bg-blue-100 text-blue-700' :
                            d.rma?.requested_service === 'repair' ? 'bg-orange-100 text-orange-700' :
                            'bg-gray-100 text-gray-700'
                          }`}>
                            {d.rma?.requested_service === 'calibration' ? 'Cal' : 
                             d.rma?.requested_service === 'repair' ? (lang === 'en' ? 'Rep' : 'R√©p') : '‚Äî'}
                          </span>
                        </td>
                        <td className="px-4 py-2 text-right">
                          {d.duration !== null ? (
                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                              d.duration <= 3 ? 'bg-green-100 text-green-700' :
                              d.duration <= 7 ? 'bg-amber-100 text-amber-700' :
                              'bg-red-100 text-red-700'
                            }`}>
                              {d.duration.toFixed(1)}j
                            </span>
                          ) : (
                            <span className="text-gray-300">‚Äî</span>
                          )}
                        </td>
                        <td className="px-4 py-2 text-right font-medium">
                          {(rmaRevenueMap[d.rma?.id] || 0).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR')} ‚Ç¨
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
                {devicesWithDuration.length > 0 && (
                  <tfoot className="bg-gray-100 border-t-2 border-gray-300">
                    <tr className="font-bold">
                      <td colSpan={6} className="px-4 py-3 text-right text-gray-700">
                        {lang === 'en' ? `TOTAL (${totalDevices} devices, ${devicesWithData} with timing)` : `TOTAL (${totalDevices} appareils, ${devicesWithData} avec timing)`}
                      </td>
                      <td className="px-4 py-3 text-right text-purple-700">
                        Moy: {avgDays.toFixed(1)}j
                        <br />
                        <span className="font-normal text-xs text-gray-500">Total: {totalDays.toFixed(1)}j</span>
                      </td>
                      <td className="px-4 py-3 text-right text-green-700">
                        {totalRevenue.toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR')} ‚Ç¨
                      </td>
                    </tr>
                  </tfoot>
                )}
              </table>
            </div>
            
            {devicesWithDuration.length > 100 && (
              <div className="p-3 bg-amber-50 text-amber-700 text-sm text-center border-t">
                {lang === 'en' ? `Display limited to first 100 results of ${devicesWithDuration.length}` : `Affichage limit√© aux 100 premiers r√©sultats sur ${devicesWithDuration.length}`}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function DashboardSheet({ requests, notify, reload, isAdmin, onSelectRMA, onSelectDevice, filter, setFilter, t = k=>k, lang = 'fr' }) {
  const [reviewingBC, setReviewingBC] = useState(null);
  const [showArchived, setShowArchived] = useState(false);
  const [viewMode, setViewMode] = useState('rma'); // 'rma' or 'device'
  const [searchQuery, setSearchQuery] = useState('');
  
  const archivedRMAs = requests.filter(r => r.status === 'archived');
  const activeRMAs = requests.filter(r => r.request_number && !['completed', 'cancelled', 'archived', 'shipped'].includes(r.status) && r.request_type !== 'parts');
  
  // BC needs review - EXCLUDE parts orders (they have their own section)
  // Include both regular BC reviews AND avenant BC reviews
  const needsReview = requests.filter(r => 
    r.request_type !== 'parts' && (
      r.status === 'bc_review' || 
      ((r.bc_file_url || r.bc_signature_url) && r.status === 'waiting_bc') ||
      // Avenant BC: avenant sent, BC submitted (check both old and new field), not yet approved
      (r.avenant_sent_at && !r.avenant_approved_at && (r.avenant_bc_submitted_at || r.bc_submitted_at))
    )
  );
  
  // Waiting for device - EXCLUDE parts orders
  const waitingDevice = activeRMAs.filter(r => r.status === 'waiting_device' && r.request_type !== 'parts');
  
  // Waiting for BC (quote sent but not signed yet) - EXCLUDE parts orders
  const waitingBC = activeRMAs.filter(r => ['quote_sent', 'waiting_bc'].includes(r.status) && !r.bc_submitted_at && r.request_type !== 'parts');
  
  // Service statuses: File d'attente, Inspection, Approbation, √âtalonnage, R√©paration
  const serviceStatuses = ['in_queue', 'queue', 'inspection', 'approbation', 'calibration', 'repair', 'calibration_in_progress', 'repair_in_progress'];
  // QC statuses
  const qcStatuses = ['qc', 'final_qc'];
  // Ready statuses
  const readyStatuses = ['ready', 'ready_to_ship'];
  
  // Filter by job type - check both RMA status AND device statuses
  const getJobType = (rma) => {
    const devices = rma.request_devices || [];
    
    // Check device statuses first (more accurate for multi-device RMAs)
    if (devices.length > 0) {
      // A device is "in service" only if it's in queue, calibration, repair, etc. ‚Äî NOT just received
      const anyInService = devices.some(d => 
        serviceStatuses.includes(d.status)
      );
      const anyInQC = devices.some(d => qcStatuses.includes(d.status) || (d.report_complete && !d.qc_complete));
      const allReady = devices.every(d => readyStatuses.includes(d.status) || d.qc_complete);
      const allWaiting = devices.every(d => !serviceStatuses.includes(d.status) && !qcStatuses.includes(d.status) && !readyStatuses.includes(d.status) && !d.qc_complete);
      
      if (allReady && devices.some(d => d.qc_complete)) return 'ready';
      if (anyInQC) return 'qc';
      if (anyInService) return 'service';
      if (allWaiting) return 'other'; // Don't fall through to RMA status
    }
    
    // Fall back to RMA status only if no devices exist
    if (serviceStatuses.includes(rma.status)) return 'service';
    if (qcStatuses.includes(rma.status)) return 'qc';
    if (readyStatuses.includes(rma.status)) return 'ready';
    
    return 'other';
  };
  
  const byJob = {
    service: activeRMAs.filter(r => getJobType(r) === 'service'),
    qc: activeRMAs.filter(r => getJobType(r) === 'qc'),
    ready: activeRMAs.filter(r => getJobType(r) === 'ready')
  };
  
  // Avenant pending - sent but customer hasn't submitted BC yet (check both old and new field)
  const avenantPending = activeRMAs.filter(r => r.avenant_sent_at && !r.avenant_approved_at && !r.avenant_bc_submitted_at && !r.bc_submitted_at);
  
  // Stats for the cards
  const stats = [
    { id: 'all', label: lang === 'en' ? 'Active RMAs' : 'RMAs Actifs', value: activeRMAs.length, color: 'bg-blue-500', icon: 'üìã' },
    { id: 'bc', label: lang === 'en' ? 'PO to Review' : 'BC √† v√©rifier', value: needsReview.length, color: 'bg-red-500', icon: '‚ö†Ô∏è' },
    { id: 'avenant', label: lang === 'en' ? 'Supplement pending' : 'Suppl√©ment en attente', value: avenantPending.length, color: 'bg-amber-500', icon: 'üìÑ' },
    { id: 'waiting_bc', label: lang === 'en' ? 'Awaiting PO' : 'Attente BC', value: waitingBC.length, color: 'bg-orange-500', icon: 'üìù' },
    { id: 'waiting_device', label: lang === 'en' ? 'Awaiting Device' : 'Attente Appareil', value: waitingDevice.length, color: 'bg-cyan-500', icon: 'üì¶' },
  ];
  
  // Job filter buttons
  const jobFilters = [
    { id: 'service', label: 'Service', value: byJob.service.length, color: 'bg-indigo-500', icon: 'üîß' },
    { id: 'qc', label: 'QC', value: byJob.qc.length, color: 'bg-purple-500', icon: '‚úÖ' },
    { id: 'ready', label: lang === 'en' ? 'Ready' : 'Pr√™t', value: byJob.ready.length, color: 'bg-green-500', icon: 'üì§' }
  ];
  
  // Search helper - matches across client name, serial numbers, and RMA number
  const matchesSearch = (rma, query) => {
    if (!query.trim()) return true;
    const q = query.toLowerCase().trim();
    // RMA number
    if (rma.request_number?.toLowerCase().includes(q)) return true;
    // Client name
    if (rma.companies?.name?.toLowerCase().includes(q)) return true;
    // Device serial numbers and models
    const devices = rma.request_devices || [];
    if (devices.some(d => 
      d.serial_number?.toLowerCase().includes(q) || 
      d.model_name?.toLowerCase().includes(q)
    )) return true;
    return false;
  };

  // Filter RMAs based on selected filter
  const getFilteredRMAs = () => {
    let rmas;
    if (searchQuery.trim()) {
      // Search across ALL requests (active + completed + archived), not just active
      rmas = requests.filter(r => r.request_number && r.request_type !== 'parts' && matchesSearch(r, searchQuery));
    } else if (!filter) {
      rmas = activeRMAs;
    } else if (filter === 'all') {
      rmas = activeRMAs;
    } else if (filter === 'bc') {
      rmas = needsReview;
    } else if (filter === 'avenant') {
      rmas = avenantPending;
    } else if (filter === 'waiting_bc') {
      rmas = waitingBC;
    } else if (filter === 'waiting_device') {
      rmas = waitingDevice;
    } else if (byJob[filter]) {
      rmas = byJob[filter];
    } else {
      rmas = activeRMAs;
    }
    return rmas;
  };
  
  const filteredRMAs = getFilteredRMAs();
  const allFilters = [...stats, ...jobFilters];
  const filterLabel = filter ? allFilters.find(s => s.id === filter)?.label : null;

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">{t('dashboard')}</h1>
        <div className="flex gap-2">
          {archivedRMAs.length > 0 && (
            <button 
              onClick={() => setShowArchived(!showArchived)} 
              className={`px-4 py-2 rounded-lg text-sm ${showArchived ? 'bg-slate-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'}`}
            >
              üì¶ Archives ({archivedRMAs.length})
            </button>
          )}
          <button onClick={reload} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">{lang === 'en' ? 'üîÑ Refresh' : 'üîÑ Actualiser'}</button>
        </div>
      </div>
      
      {/* Search Bar */}
      <div className="relative">
        <input
          type="text"
          value={searchQuery}
          onChange={e => { setSearchQuery(e.target.value); if (e.target.value.trim()) setFilter(null); }}
          placeholder={lang === 'en' ? 'üîç Search by client, serial number, or RMA number...' : 'üîç Rechercher par client, N¬∞ s√©rie ou N¬∞ RMA...'}
          className="w-full px-4 py-3 pl-5 pr-10 border-2 border-gray-200 rounded-xl text-sm focus:border-[#00A651] focus:ring-1 focus:ring-[#00A651] focus:outline-none transition-colors"
        />
        {searchQuery && (
          <button 
            onClick={() => setSearchQuery('')}
            className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-lg"
          >‚úï</button>
        )}
      </div>
      
      {/* Archived RMAs Section */}
      {showArchived && archivedRMAs.length > 0 && (
        <div className="bg-slate-50 border border-slate-200 rounded-xl">
          <div className="px-6 py-4 border-b border-slate-200">
            <h2 className="font-bold text-slate-700">{lang === 'en' ? 'üì¶ Archived RMAs' : 'üì¶ RMAs Archiv√©s'} ({archivedRMAs.length})</h2>
          </div>
          <div className="p-4 space-y-2 max-h-64 overflow-y-auto">
            {archivedRMAs.map(rma => (
              <div key={rma.id} onClick={() => onSelectRMA(rma)} className="bg-white rounded-lg p-3 flex items-center justify-between cursor-pointer hover:bg-slate-100 border border-slate-200">
                <div className="flex items-center gap-3">
                  <span className="font-mono text-sm text-slate-500">{rma.request_number}</span>
                  <span className="text-sm text-slate-600">{rma.companies?.name}</span>
                </div>
                <div className="text-right">
                  <span className="text-xs text-slate-400">{lang === 'en' ? 'Archived on' : 'Archiv√© le'} {rma.archived_at ? new Date(rma.archived_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : '‚Äî'}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
      
      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
        {stats.map((stat) => (
          <button 
            key={stat.id} 
            onClick={() => setFilter(filter === stat.id ? null : stat.id)}
            className={`bg-white rounded-xl p-4 shadow-sm text-left transition-all ${
              filter === stat.id ? 'ring-2 ring-offset-2 ring-blue-500' : 'hover:shadow-md'
            } ${stat.value > 0 && stat.id === 'bc' ? 'ring-2 ring-red-500 animate-pulse' : ''} ${stat.value > 0 && stat.id === 'avenant' ? 'ring-2 ring-amber-500 animate-pulse' : ''}`}
          >
            <div className="flex items-center gap-3">
              <div className={`w-12 h-12 ${stat.color} rounded-lg flex items-center justify-center text-2xl text-white`}>{stat.icon}</div>
              <div>
                <p className="text-2xl font-bold text-gray-800">{stat.value}</p>
                <p className="text-sm text-gray-500">{stat.label}</p>
              </div>
            </div>
          </button>
        ))}
        {jobFilters.map((job) => (
          <button 
            key={job.id} 
            onClick={() => setFilter(filter === job.id ? null : job.id)}
            className={`bg-white rounded-xl p-4 shadow-sm text-left transition-all ${
              filter === job.id ? 'ring-2 ring-offset-2 ring-blue-500' : 'hover:shadow-md'
            }`}
          >
            <div className="flex items-center gap-3">
              <div className={`w-12 h-12 ${job.color} rounded-lg flex items-center justify-center text-2xl text-white`}>{job.icon}</div>
              <div>
                <p className="text-2xl font-bold text-gray-800">{job.value}</p>
                <p className="text-sm text-gray-500">{job.label}</p>
              </div>
            </div>
          </button>
        ))}
      </div>
      
      {/* Active Filter Indicator - only show when filtering (not for 'all') */}
      {filter && filter !== 'all' && !searchQuery.trim() && (
        <div className="flex items-center gap-3 bg-blue-50 border border-blue-200 rounded-lg px-4 py-2">
          <span className="text-blue-700 font-medium">Filtre: {filterLabel}</span>
          <span className="text-blue-600">({filteredRMAs.length} RMAs)</span>
          <button onClick={() => setFilter(null)} className="ml-auto text-blue-600 hover:text-blue-800 font-medium">{lang === 'en' ? '‚úï Clear' : '‚úï Effacer'}</button>
        </div>
      )}
      
      {/* Search Results Indicator */}
      {searchQuery.trim() && (
        <div className="flex items-center gap-3 bg-green-50 border border-green-200 rounded-lg px-4 py-2">
          <span className="text-green-700 font-medium">üîç {lang === 'en' ? 'Search results for' : 'R√©sultats pour'} "{searchQuery}"</span>
          <span className="text-green-600">({filteredRMAs.length} {lang === 'en' ? 'found' : 'trouv√©(s)'})</span>
          <button onClick={() => setSearchQuery('')} className="ml-auto text-green-600 hover:text-green-800 font-medium">{lang === 'en' ? '‚úï Clear' : '‚úï Effacer'}</button>
        </div>
      )}
      
      {/* BC Review Section - Always show when there are BCs to review */}
      {needsReview.length > 0 && (!filter || filter === 'bc') && !searchQuery.trim() && (
        <div className="bg-red-50 border-2 border-red-300 rounded-xl shadow-lg">
          <div className="px-6 py-4 border-b border-red-200 bg-red-100 rounded-t-xl">
            <h2 className="font-bold text-red-800 text-lg">{lang === 'en' ? '‚ö†Ô∏è Purchase Orders to Review' : '‚ö†Ô∏è Bons de Commande √† V√©rifier'} ({needsReview.length})</h2>
            <p className="text-sm text-red-600">{lang === 'en' ? 'Click "Review" to verify the document and approve' : 'Cliquez sur "Examiner" pour v√©rifier le document et approuver'}</p>
          </div>
          <div className="p-4 space-y-3">
            {needsReview.map(rma => (
              <div key={rma.id} className="bg-white rounded-lg p-4 flex items-center justify-between shadow-sm border border-red-100">
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">üìÑ</div>
                  <div>
                    <span className="font-mono font-bold text-[#00A651] text-lg">{rma.request_number}</span>
                    <p className="font-medium text-gray-800">{rma.companies?.name}</p>
                    <p className="text-sm text-gray-500">
                      BC soumis le {rma.bc_submitted_at ? new Date(rma.bc_submitted_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : new Date(rma.updated_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                      {rma.bc_signed_by && <span className="ml-2">‚Ä¢ {lang === 'en' ? 'Signed by' : 'Sign√© par'}: {rma.bc_signed_by}</span>}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => setReviewingBC(rma)}
                  className="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium flex items-center gap-2"
                >
                  üîç Examiner
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
      
      {/* View Toggle & Table */}
      {(filter !== 'bc' || searchQuery.trim()) && (
        <div className="bg-white rounded-xl shadow-sm">
          <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
            <h2 className="font-bold text-gray-800">
              {searchQuery.trim() ? `${lang === 'en' ? 'Results' : 'R√©sultats'} (${filteredRMAs.length})` : filterLabel ? `${filterLabel} (${filteredRMAs.length})` : `RMAs Actifs (${activeRMAs.length})`}
            </h2>
            {/* View Toggle */}
            <div className="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
              <button
                onClick={() => setViewMode('rma')}
                className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
                  viewMode === 'rma' ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                üìã Vue RMA
              </button>
              <button
                onClick={() => setViewMode('device')}
                className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
                  viewMode === 'device' ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                üîß Vue Appareil
              </button>
            </div>
          </div>
          
          {/* RMA View Table */}
          {viewMode === 'rma' && (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">RMA</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('client')}</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Device(s)' : 'Appareil(s)'}</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Service' : 'Service'}</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Step' : '√âtape'}</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('date')}</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('actions')}</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {filteredRMAs.length === 0 ? (
                    <tr><td colSpan={7} className="px-4 py-8 text-center text-gray-400">{searchQuery.trim() ? (lang === 'en' ? `No results for "${searchQuery}"` : `Aucun r√©sultat pour "${searchQuery}"`) : (lang === 'en' ? 'No RMAs' : 'Aucun RMA')}</td></tr>
                  ) : filteredRMAs.map(rma => {
                    const jobType = getJobType(rma);
                    const jobStyles = {
                      service: { bg: 'bg-indigo-100', text: 'text-indigo-700', label: 'Service' },
                      qc: { bg: 'bg-purple-100', text: 'text-purple-700', label: 'QC' },
                      ready: { bg: 'bg-green-100', text: 'text-green-700', label: lang === 'en' ? 'Ready' : 'Pr√™t' },
                      other: { bg: 'bg-gray-100', text: 'text-gray-700', label: 'Admin' }
                    };
                    const jobStyle = jobStyles[jobType] || jobStyles.other;
                    const devices = rma.request_devices || [];
                    const hasBCToReview = needsReview.find(n => n.id === rma.id);
                    
                    // Compute effective status based on device states (more accurate than rma.status)
                    const getEffectiveStatus = () => {
                      if (devices.length === 0) return rma.status;
                      const allQCComplete = devices.every(d => d.qc_complete);
                      const anyInQC = devices.some(d => d.report_complete && !d.qc_complete);
                      const allReportsComplete = devices.every(d => d.report_complete);
                      
                      if (allQCComplete) return 'ready_to_ship';
                      if (anyInQC || allReportsComplete) return 'final_qc';
                      return rma.status;
                    };
                    const effectiveStatus = getEffectiveStatus();
                    const style = STATUS_STYLES[effectiveStatus] || STATUS_STYLES.submitted;
                    
                    return (
                      <tr key={rma.id} className={`hover:bg-gray-50 cursor-pointer ${hasBCToReview ? 'bg-red-50' : ''}`} onClick={() => !hasBCToReview && onSelectRMA(rma)}>
                        <td className="px-4 py-3"><span className="font-mono font-bold text-[#00A651]">{rma.request_number}</span></td>
                        <td className="px-4 py-3"><p className="font-medium text-gray-800">{rma.companies?.name || '‚Äî'}</p></td>
                        <td className="px-4 py-3">
                          {devices.length > 0 ? <div className="text-sm">{devices.slice(0, 2).map((d, i) => <p key={i}>{d.model_name} <span className="text-gray-400">({d.serial_number})</span></p>)}{devices.length > 2 && <p className="text-gray-400">+{devices.length - 2} {lang === 'en' ? 'more' : 'autres'}</p>}</div> : <span className="text-gray-400">{rma.serial_number || '‚Äî'}</span>}
                        </td>
                        <td className="px-4 py-3"><span className="text-sm">{rma.requested_service === 'calibration' ? 'üî¨ ' + t('calibration') : rma.requested_service === 'repair' ? 'üîß ' + t('repair') : rma.requested_service}</span></td>
                        <td className="px-4 py-3">
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${style.bg} ${style.text}`}>{lang === 'en' && style.en ? style.en : style.label}</span>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-500">{new Date(rma.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</td>
                        <td className="px-4 py-3">
                          {hasBCToReview ? (
                            <button onClick={(e) => { e.stopPropagation(); setReviewingBC(rma); }} className="px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded">{lang === 'en' ? 'üîç Review PO' : 'üîç Examiner BC'}</button>
                          ) : (
                            <button onClick={(e) => { e.stopPropagation(); onSelectRMA(rma); }} className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded">{lang === 'en' ? 'View ‚Üí' : 'Voir ‚Üí'}</button>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
          
          {/* Device View Table */}
          {viewMode === 'device' && (() => {
            // Flatten all devices from active RMAs (or search results)
            const sourceRMAs = searchQuery.trim() ? filteredRMAs : activeRMAs;
            const allDevicesRaw = sourceRMAs.flatMap(rma => 
              (rma.request_devices || []).map(device => ({
                ...device,
                rma: rma
              }))
            );
            
            // Define status categories for filtering
            const waitingStatuses = ['waiting_device', 'bc_approved', 'received'];
            const serviceStatuses = ['in_queue', 'queue', 'calibration', 'calibration_in_progress', 
                                     'inspection', 'inspection_complete', 'customer_approval', 'repair', 'repair_in_progress'];
            const qcStatuses = ['final_qc', 'qc', 'quality_check'];
            const readyStatuses = ['ready_to_ship', 'ready'];
            
            // Early stages = before device physically arrives (use RMA status)
            const earlyStatuses = ['submitted', 'pending', 'quote_sent', 'quote_revision_requested', 'quote_revision_declined', 
                                   'approved', 'bc_pending', 'bc_review', 'waiting_bc', 'waiting_po', 'waiting_device', 'bc_approved', 'pending_quote_review'];
            
            // Helper to get device's effective status
            // Before devices arrive: use RMA status
            // After devices arrive: use device.status individually
            const getDeviceStatus = (device) => {
              const rmaStatus = device.rma?.status;
              const rmaIsEarly = earlyStatuses.includes(rmaStatus);
              
              // Priority overrides based on device flags
              if (device.shipped_at) return 'shipped';
              if (device.qc_complete) return 'ready_to_ship';
              if (device.report_complete && !device.qc_complete) return 'final_qc';
              
              // If RMA is in early stages, all devices show RMA status
              // Once RMA moves past waiting_device (i.e. received), each device tracks independently
              return rmaIsEarly ? rmaStatus : (device.status || rmaStatus);
            };
            
            // Helper to determine device category
            const getDeviceCategory = (device) => {
              const status = getDeviceStatus(device);
              // Check for QC based on report_complete flag too
              if (device.report_complete && !device.qc_complete) return 'qc';
              if (device.qc_complete) return 'ready';
              if (qcStatuses.includes(status)) return 'qc';
              if (readyStatuses.includes(status)) return 'ready';
              if (serviceStatuses.includes(status)) return 'service';
              if (waitingStatuses.includes(status)) return 'waiting_device';
              return 'other';
            };
            
            // Filter devices based on selected filter
            const allDevices = (() => {
              if (!filter || filter === 'all') return allDevicesRaw;
              if (filter === 'service') return allDevicesRaw.filter(d => getDeviceCategory(d) === 'service');
              if (filter === 'qc') return allDevicesRaw.filter(d => getDeviceCategory(d) === 'qc');
              if (filter === 'ready') return allDevicesRaw.filter(d => getDeviceCategory(d) === 'ready');
              if (filter === 'waiting_device') return allDevicesRaw.filter(d => getDeviceCategory(d) === 'waiting_device');
              // For other filters (bc, waiting_bc), filter by RMA
              return filteredRMAs.flatMap(rma => 
                (rma.request_devices || []).map(device => ({ ...device, rma }))
              );
            })();
            
            // Progress bar component for device view
            const DeviceProgressBar = ({ device, rma }) => {
              const serviceType = device.service_type || rma.requested_service || 'calibration';
              const isRepair = serviceType === 'repair';
              
              const calibrationSteps = [
                { id: 'submitted', label: t('stSubmitted') },
                { id: 'rma_created', label: lang === 'en' ? 'Quote Created' : 'Devis Cr√©√©' },
                { id: 'bc_approved', label: t('stQuoteApproved') },
                { id: 'waiting_device', label: lang === 'en' ? 'Pending' : 'Attente' },
                { id: 'received', label: t('stReceived') },
                { id: 'queue', label: lang === 'en' ? 'Queue' : 'File' },
                { id: 'calibration', label: lang === 'en' ? 'Calibration' : '√âtalonnage' },
                { id: 'final_qc', label: lang === 'en' ? 'QC Check' : 'Contr√¥le QC' },
                { id: 'ready_to_ship', label: lang === 'en' ? 'Ready' : 'Pr√™t' },
                { id: 'shipped', label: t('stShipped') }
              ];
              
              const repairSteps = [
                { id: 'submitted', label: t('stSubmitted') },
                { id: 'rma_created', label: lang === 'en' ? 'Quote Created' : 'Devis Cr√©√©' },
                { id: 'bc_approved', label: t('stQuoteApproved') },
                { id: 'waiting_device', label: lang === 'en' ? 'Pending' : 'Attente' },
                { id: 'received', label: t('stReceived') },
                { id: 'queue', label: lang === 'en' ? 'Queue' : 'File' },
                { id: 'inspection', label: lang === 'en' ? 'Inspection' : 'Inspection' },
                { id: 'customer_approval', label: lang === 'en' ? 'Client Appr.' : 'Appr. Client' },
                { id: 'repair', label: lang === 'en' ? 'Repair' : 'R√©paration' },
                { id: 'final_qc', label: lang === 'en' ? 'QC Check' : 'Contr√¥le QC' },
                { id: 'ready_to_ship', label: lang === 'en' ? 'Ready' : 'Pr√™t' },
                { id: 'shipped', label: t('stShipped') }
              ];
              
              const steps = isRepair ? repairSteps : calibrationSteps;
              
              // Get step index - map all possible statuses to progress steps
              const getStepIndex = (status) => {
                // If no status, check if RMA has request_number (means it's at least created)
                if (!status && rma.request_number) {
                  return 1; // At least RMA created
                }
                
                if (isRepair) {
                  // Repair: 12 steps (0-11) - includes File d'attente
                  const map = {
                    'submitted': 0, 'pending': 0, 'waiting_approval': 0,
                    'approved': 1, 'rma_created': 1, 'quote_sent': 1, 'pending_quote_review': 1,
                    'waiting_bc': 2, 'bc_review': 2, 'waiting_po': 2,
                    'waiting_device': 3, 'bc_approved': 3,
                    'received': 4,
                    'in_queue': 5, 'queue': 5, 'queued': 5,
                    'inspection': 6, 'inspection_complete': 6,
                    'customer_approval': 7, 'quote_approved': 7, 'waiting_parts': 7,
                    'repair': 8, 'repair_in_progress': 8, 'in_progress': 8,
                    'final_qc': 9, 'qc': 9, 'quality_check': 9,
                    'ready_to_ship': 10, 'ready': 10,
                    'shipped': 11, 'delivered': 11, 'completed': 11
                  };
                  return map[status] ?? 1;
                } else {
                  // Calibration: 10 steps (0-9)
                  const map = {
                    'submitted': 0, 'pending': 0, 'waiting_approval': 0,
                    'approved': 1, 'rma_created': 1, 'quote_sent': 1, 'pending_quote_review': 1,
                    'waiting_bc': 2, 'bc_review': 2, 'waiting_po': 2,
                    'waiting_device': 3, 'bc_approved': 3,
                    'received': 4,
                    'in_queue': 5, 'queue': 5, 'queued': 5,
                    'calibration': 6, 'calibration_in_progress': 6, 'in_progress': 6,
                    'final_qc': 7, 'qc': 7, 'quality_check': 7,
                    'ready_to_ship': 8, 'ready': 8,
                    'shipped': 9, 'delivered': 9, 'completed': 9
                  };
                  return map[status] ?? 1;
                }
              };
              
              // Get the actual status to use
              // Before devices arrive: use RMA status
              // After devices arrive: use device.status individually
              const earlyStatuses = ['submitted', 'pending', 'quote_sent', 'quote_revision_requested', 'quote_revision_declined', 
                                     'approved', 'bc_pending', 'bc_review', 'waiting_bc', 'waiting_po', 'waiting_device', 'bc_approved', 'pending_quote_review'];
              const rmaIsEarly = earlyStatuses.includes(rma.status);
              
              const effectiveStatus = (() => {
                // Priority overrides based on device flags
                if (device.shipped_at) return 'shipped';
                if (device.qc_complete) return 'ready_to_ship';
                if (device.report_complete && !device.qc_complete) return 'final_qc';
                
                // If RMA is in early stages, all devices show RMA status
                // Once RMA moves past early stages, each device tracks independently
                return rmaIsEarly ? rma.status : (device.status || rma.status);
              })();
              const currentIndex = getStepIndex(effectiveStatus);
              const isShipped = effectiveStatus === 'shipped' || effectiveStatus === 'delivered' || effectiveStatus === 'completed';
              
              // Detect: device received but quote not approved
              const quotePhaseStatuses = ['quote_sent', 'pending_quote_review', 'waiting_bc', 'bc_review', 'bc_submitted', 'rma_created', 'approved'];
              const initialQuoteDone = rma.quote_sent_at || rma.avenant_sent_at || rma.bc_submitted_at;
              const deviceReceivedEarly = (rma.received_at || device.status === 'received') && quotePhaseStatuses.includes(rma.status) && !initialQuoteDone;
              
              return (
                <div className="flex w-full">
                  {steps.map((step, index) => {
                    const isCompleted = index < currentIndex;
                    const isCurrent = index === currentIndex;
                    const isLast = index === steps.length - 1;
                    const isQuoteStepRed = deviceReceivedEarly && index === 1;
                    
                    return (
                      <div key={step.id} className="flex-1" style={{ minWidth: '50px' }}>
                        <div 
                          className={`
                            flex items-center justify-center h-9 px-2 text-[10px] font-medium text-center leading-tight
                            ${isQuoteStepRed ? 'bg-red-500 text-white animate-pulse' : isShipped && isLast ? 'bg-[#00A651] text-white' : isCompleted ? 'bg-[#00A651] text-white' : isCurrent ? 'bg-[#003366] text-white' : 'bg-gray-200 text-gray-500'}
                            ${index === 0 ? 'rounded-l-sm' : ''}
                            ${isLast ? 'rounded-r-sm' : ''}
                          `}
                          style={{
                            clipPath: isLast 
                              ? 'polygon(0 0, 100% 0, 100% 100%, 0 100%, 6px 50%)' 
                              : index === 0 
                                ? 'polygon(0 0, calc(100% - 6px) 0, 100% 50%, calc(100% - 6px) 100%, 0 100%)'
                                : 'polygon(0 0, calc(100% - 6px) 0, 100% 50%, calc(100% - 6px) 100%, 0 100%, 6px 50%)'
                          }}
                        >
                          <span className="break-words hyphens-auto">{isQuoteStepRed ? (lang === 'en' ? '‚ö†Ô∏è Quote!' : '‚ö†Ô∏è Devis!') : isShipped && isLast ? (lang === 'en' ? '‚úì Shipped' : '‚úì Exp√©di√©') : step.label}</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              );
            };
            
            return (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">RMA</th>
                      <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('device')}</th>
                      <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('serialNumber')}</th>
                      <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Service' : 'Service'}</th>
                      <th className="px-4 py-3 text-left text-sm font-bold text-gray-600 min-w-[640px]">{lang === 'en' ? 'Progress' : 'Progression'}</th>
                      <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('actions')}</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {allDevices.length === 0 ? (
                      <tr><td colSpan={6} className="px-4 py-8 text-center text-gray-400">{lang === 'en' ? 'No devices' : 'Aucun appareil'}</td></tr>
                    ) : allDevices.map((device, idx) => {
                      // Get effective status using same logic as getDeviceStatus
                      const effectiveDeviceStatus = getDeviceStatus(device);
                      const deviceStyle = STATUS_STYLES[effectiveDeviceStatus] || STATUS_STYLES.submitted;
                      const serviceType = device.service_type || device.rma.requested_service || 'calibration';
                      
                      return (
                        <tr 
                          key={`${device.rma.id}-${device.id || idx}`} 
                          className="hover:bg-gray-50 cursor-pointer"
                          onClick={() => onSelectDevice(device, device.rma)}
                        >
                          <td className="px-4 py-3">
                            <span className="font-mono font-bold text-[#00A651]">{device.rma.request_number}</span>
                            <p className="text-xs text-gray-400">{device.rma.companies?.name}</p>
                          </td>
                          <td className="px-4 py-3">
                            <span className="font-medium text-gray-800 flex items-center gap-1.5">{getDeviceImageUrl(device.model_name) && <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-4 h-4 object-contain" />}{device.model_name || '‚Äî'}</span>
                          </td>
                          <td className="px-4 py-3">
                            <span className="font-mono text-sm text-gray-600">{device.serial_number || '‚Äî'}</span>
                          </td>
                          <td className="px-4 py-3">
                            <span className={`px-2 py-1 rounded text-xs font-medium ${serviceType === 'repair' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                              {serviceType === 'repair' ? (lang === 'en' ? 'üîß Rep.' : 'üîß R√©p.') : (lang === 'en' ? 'üî¨ Cal.' : 'üî¨ √âtal.')}
                            </span>
                          </td>
                          <td className="px-4 py-3">
                            <DeviceProgressBar device={device} rma={device.rma} />
                          </td>
                          <td className="px-4 py-3" onClick={(e) => e.stopPropagation()}>
                            {(() => {
                              const category = getDeviceCategory(device);
                              if (category === 'qc') {
                                return (
                                  <button 
                                    onClick={() => onSelectDevice(device, device.rma)}
                                    className="px-3 py-1.5 text-sm bg-purple-500 hover:bg-purple-600 text-white rounded font-medium"
                                  >
                                    ‚úÖ Contr√¥ler
                                  </button>
                                );
                              }
                              if (category === 'ready') {
                                return (
                                  <span className="px-3 py-1.5 text-sm bg-green-100 text-green-700 rounded font-medium">
                                    ‚úì Pr√™t
                                  </span>
                                );
                              }
                              if (category === 'waiting_device') {
                                return (
                                  <span className="px-3 py-1.5 text-sm bg-cyan-100 text-cyan-700 rounded font-medium">
                                    üì¶ Attente
                                  </span>
                                );
                              }
                              return (
                                <button 
                                  onClick={() => onSelectDevice(device, device.rma)}
                                  className="px-3 py-1.5 text-sm bg-indigo-500 hover:bg-indigo-600 text-white rounded font-medium"
                                >
                                  üîß Traiter
                                </button>
                              );
                            })()}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            );
          })()}
        </div>
      )}
      
      {/* BC Review Modal */}
      {reviewingBC && <BCReviewModal rma={reviewingBC} onClose={() => setReviewingBC(null)} notify={notify} reload={reload} lang={lang} />}
    </div>
  );
}

// BC Review Modal - Full screen document review
function BCReviewModal({ rma, onClose, notify, reload, lang = 'fr' }) {
  const t = k => k;
  const [approving, setApproving] = useState(false);
  const [rejecting, setRejecting] = useState(false);
  const [rejectReason, setRejectReason] = useState('');
  const [attachments, setAttachments] = useState([]);
  const [bcNumber, setBcNumber] = useState('');
  const [useAutoNumber, setUseAutoNumber] = useState(false); // Will update after attachments load
  const [generatingNumber, setGeneratingNumber] = useState(false);
  
  // Detect if this is an avenant BC (avenant was sent and we're reviewing its BC)
  const isAvenantBC = !!rma.avenant_sent_at && !rma.avenant_approved_at;
  
  // Fetch attachments to get avenant documents
  useEffect(() => {
    const fetchAttachments = async () => {
      const { data } = await supabase
        .from('request_attachments')
        .select('*')
        .eq('request_id', rma.id)
        .order('created_at', { ascending: false });
      if (data) {
        setAttachments(data);
        // Now check if customer uploaded their own BC file
        const hasAvenantBc = data.some(a => a.category === 'avenant_bc' && a.file_url);
        const hasRegularBc = !!rma.bc_file_url && rma.bc_file_url !== rma.signed_quote_url;
        // Auto-generate if no file uploaded
        if (isAvenantBC) {
          setUseAutoNumber(!hasAvenantBc);
        } else {
          setUseAutoNumber(!hasRegularBc && !rma.bc_file_url);
        }
      }
    };
    fetchAttachments();
  }, [rma.id, isAvenantBC]);
  
  // Auto-generate BC number on mount if needed
  useEffect(() => {
    if (useAutoNumber && !bcNumber && attachments.length >= 0) {
      generateBCNumber();
    }
  }, [useAutoNumber, attachments]);
  
  const generateBCNumber = async () => {
    setGeneratingNumber(true);
    try {
      const { data, error } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'BC' });
      if (!error && data) {
        setBcNumber(data);
      }
    } catch (e) {
      console.error('Could not generate BC number:', e);
    }
    setGeneratingNumber(false);
  };
  
  // Get the correct documents for display
  const avenantSigneUrl = attachments.find(a => a.category === 'avenant_signe' && a.file_url)?.file_url;
  const avenantQuoteUrl = attachments.find(a => a.category === 'avenant_quote' && a.file_url)?.file_url;
  const avenantBcUrl = attachments.find(a => a.category === 'avenant_bc' && a.file_url)?.file_url;
  
  // Detect if customer uploaded their own BC file (vs just signing our quote)
  // For avenant, check attachments; for regular, check bc_file_url
  const hasCustomerBCFile = isAvenantBC 
    ? !!avenantBcUrl
    : (!!rma.bc_file_url && rma.bc_file_url !== rma.signed_quote_url);
  
  const approveBC = async () => {
    // Validate BC number
    if (!bcNumber.trim()) {
      notify(lang === 'en' ? 'Please enter a PO number' : 'Veuillez entrer un num√©ro de BC', 'error');
      return;
    }
    
    setApproving(true);
    
    // Different update depending on whether this is avenant BC or regular BC
    if (isAvenantBC) {
      // Avenant BC approved - DON'T change RMA status, just mark avenant as approved
      // The device continues from wherever it was (in_progress, calibration_in_progress, etc.)
      // Use supplement-specific fields to preserve original BC data
      const { error } = await supabase
        .from('service_requests')
        .update({
          avenant_approved_at: new Date().toISOString(),
          supplement_bc_number: bcNumber, // Customer's BC/PO number for supplement
          // These may have been set by customer portal, but update them if admin has different values
          supplement_bc_approved_at: new Date().toISOString()
        })
        .eq('id', rma.id);
      
      if (error) {
        notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
      } else {
        // Don't change device statuses - they stay where they were
        notify(lang === 'en' ? `‚úÖ Supplement approved! PO #${bcNumber}` : `‚úÖ Suppl√©ment approuv√©! BC N¬∞ ${bcNumber}`);
        reload();
        onClose();
      }
    } else {
      // Regular BC approved - waiting for device
      const { error } = await supabase
        .from('service_requests')
        .update({
          status: 'waiting_device', 
          bc_approved_at: new Date().toISOString(),
          bc_number: bcNumber
        })
        .eq('id', rma.id);
      
      if (error) {
        notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
      } else {
        notify(lang === 'en' ? `‚úÖ PO # ${bcNumber} approved! Awaiting device.` : `‚úÖ BC N¬∞ ${bcNumber} approuv√©! En attente de l'appareil.`);
        reload();
        onClose();
      }
    }
    setApproving(false);
  };
  
  const rejectBC = async () => {
    if (!rejectReason.trim()) {
      notify(lang === 'en' ? 'Please indicate the rejection reason' : 'Veuillez indiquer la raison du refus', 'error');
      return;
    }
    setRejecting(true);
    const { error } = await supabase
      .from('service_requests')
      .update({ 
        status: 'bc_rejected', // Show rejection to customer
        bc_rejected_at: new Date().toISOString(),
        bc_rejection_reason: rejectReason,
        // Clear old BC data
        bc_file_url: null,
        bc_signature_url: null,
        bc_submitted_at: null
      })
      .eq('id', rma.id);
    
    if (error) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
    } else {
      notify(lang === 'en' ? 'PO rejected. Client must submit a new PO.' : 'BC refus√©. Le client devra soumettre un nouveau BC.');
      reload();
      onClose();
    }
    setRejecting(false);
  };
  
  const devices = rma.request_devices || [];
  
  return (
    <div className="fixed inset-0 z-50 bg-black/80 flex" onClick={onClose}>
      <div className="bg-white w-full h-full max-w-[98vw] max-h-[98vh] m-auto rounded-xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className={`px-6 py-3 ${isAvenantBC ? 'bg-gradient-to-r from-amber-500 to-amber-600' : 'bg-gradient-to-r from-red-500 to-red-600'} text-white flex justify-between items-center flex-shrink-0`}>
          <div>
            <h2 className="text-xl font-bold">
              {isAvenantBC ? 'üìÑ V√©rification BC Suppl√©ment' : (lang === 'en' ? 'Purchase Order Verification' : 'V√©rification du Bon de Commande')}
            </h2>
            <p className={isAvenantBC ? 'text-amber-100' : 'text-red-100'}>
              {rma.request_number} ‚Ä¢ {rma.companies?.name}
              {isAvenantBC && ` ‚Ä¢ ${lang === 'en' ? 'Supplement' : 'Suppl√©ment'}: ‚Ç¨${rma.avenant_total?.toFixed(2) || '0.00'}`}
            </p>
          </div>
          <button onClick={onClose} className="text-white/70 hover:text-white text-3xl">&times;</button>
        </div>
        
        {/* Content */}
        <div className="flex-1 overflow-hidden flex">
          {/* Left: Document Preview - Takes most of the space */}
          <div className="flex-1 flex flex-col bg-gray-800 p-4">
            <div className="flex justify-between items-center mb-3">
              <h3 className="font-bold text-white text-lg">{lang === 'en' ? `üìÑ PO Document ${isAvenantBC ? '(Supplement)' : ''}` : `üìÑ Document BC ${isAvenantBC ? '(Suppl√©ment)' : ''}`}</h3>
              <div className="flex gap-2">
                {isAvenantBC ? (
                  <>
                    {/* Avenant documents */}
                    {avenantSigneUrl && (
                      <a href={avenantSigneUrl} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium">
                        {lang === 'en' ? '‚úÖ Signed Supplement ‚Üó' : '‚úÖ Suppl√©ment Sign√© ‚Üó'}
                      </a>
                    )}
                    {avenantQuoteUrl && (
                      <a href={avenantQuoteUrl} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm font-medium">
                        üìÑ Suppl√©ment ‚Üó
                      </a>
                    )}
                    {(rma.bc_file_url || avenantBcUrl) && (
                      <a href={avenantBcUrl || rma.bc_file_url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium">
                        üìã BC Avenant ‚Üó
                      </a>
                    )}
                  </>
                ) : (
                  <>
                    {/* Regular BC documents */}
                    {rma.signed_quote_url && (
                      <a href={rma.signed_quote_url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-medium">
                        üìÑ Devis Sign√© ‚Üó
                      </a>
                    )}
                    {rma.bc_file_url && (
                      <a href={rma.bc_file_url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium">
                        üìã BC Upload√© ‚Üó
                      </a>
                    )}
                  </>
                )}
              </div>
            </div>
            
            {/* BC File or Signed Quote - Full height PDF viewer */}
            {(() => {
              // Determine which document to display based on whether it's avenant or regular BC
              let displayUrl;
              if (isAvenantBC) {
                // For avenant: prefer signed avenant > avenant BC > avenant quote
                displayUrl = avenantSigneUrl || avenantBcUrl || rma.bc_file_url || avenantQuoteUrl;
              } else {
                // For regular BC: prefer signed quote > BC file
                displayUrl = rma.signed_quote_url || rma.bc_file_url;
              }
              
              if (displayUrl) {
                return (
                  <div className="flex-1 rounded-lg overflow-hidden bg-white">
                    {displayUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? (
                      <img src={displayUrl} alt="BC Document" className="w-full h-full object-contain" />
                    ) : displayUrl.match(/\.pdf$/i) || displayUrl.includes('pdf') ? (
                      <object
                        data={`${displayUrl}#view=Fit`}
                        type="application/pdf"
                        className="w-full h-full"
                        style={{ minHeight: '100%' }}
                      >
                        <iframe 
                          src={`${displayUrl}#view=Fit`} 
                          className="w-full h-full" 
                          title="BC PDF"
                        />
                      </object>
                    ) : (
                      <div className="h-full flex items-center justify-center">
                        <a href={displayUrl} target="_blank" rel="noopener noreferrer" className="px-8 py-4 bg-blue-500 text-white rounded-lg text-lg font-medium">
                          üì• T√©l√©charger le fichier
                        </a>
                      </div>
                    )}
                  </div>
                );
              } else {
                return (
                  <div className="flex-1 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center text-gray-400 text-lg">
                    {isAvenantBC ? (lang === 'en' ? 'Loading supplement documents...' : 'Chargement des documents suppl√©ment...') : (lang === 'en' ? 'No PO file uploaded' : 'Aucun fichier BC upload√©')}
                  </div>
                );
              }
            })()}
          </div>
          
          {/* Right: Order Details - Sidebar */}
          <div className="w-96 flex-shrink-0 bg-gray-50 overflow-y-auto p-4 space-y-4">
            <h3 className="font-bold text-gray-800 text-lg">{lang === 'en' ? 'üìã Order Details' : 'üìã D√©tails de la Commande'}</h3>
            
            {/* RMA Info */}
            <div className="bg-white rounded-lg p-4 border">
              <div className="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <p className="text-gray-500">{t('rmaNumber')}</p>
                  <p className="font-mono font-bold text-[#00A651]">{rma.request_number}</p>
                </div>
                <div>
                  <p className="text-gray-500">{lang === 'en' ? 'Service' : 'Service'}</p>
                  <p className="font-medium">{rma.requested_service}</p>
                </div>
                <div>
                  <p className="text-gray-500">{lang === 'en' ? 'PO Submission' : 'Soumission BC'}</p>
                  <p className="font-medium">{rma.bc_submitted_at ? new Date(rma.bc_submitted_at).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') : '‚Äî'}</p>
                </div>
                <div>
                  <p className="text-gray-500">{t('client')}</p>
                  <p className="font-medium">{rma.companies?.name}</p>
                </div>
              </div>
            </div>
            
            {/* Signature */}
            {rma.bc_signature_url && (
              <div className="bg-white rounded-lg p-4 border">
                <h4 className="font-medium text-gray-700 mb-2">{lang === 'en' ? '‚úçÔ∏è Signature' : '‚úçÔ∏è Signature'}</h4>
                <img src={rma.bc_signature_url} alt="Signature" className="max-h-20 mx-auto bg-gray-50 rounded p-2" />
                <p className="text-center text-xs text-gray-500 mt-1">
                  {rma.bc_signed_by || '‚Äî'} {rma.bc_signature_date && `‚Ä¢ ${new Date(rma.bc_signature_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}`}
                </p>
              </div>
            )}
            
            {/* Devices */}
            <div className="bg-white rounded-lg p-4 border">
              <h4 className="font-medium text-gray-700 mb-2">üì¶ Appareils ({devices.length})</h4>
              <div className="space-y-2 max-h-40 overflow-y-auto">
                {devices.map((d, i) => (
                  <div key={i} className="bg-gray-50 rounded p-2 text-sm">
                    <p className="font-medium flex items-center gap-2">{getDeviceImageUrl(d.model_name) && <img src={getDeviceImageUrl(d.model_name)} alt="" className="w-4 h-4 object-contain" />}{d.model_name}</p>
                    <p className="text-gray-500">SN: {d.serial_number}</p>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Quote/Avenant Info */}
            {isAvenantBC ? (
              <div className="bg-orange-50 rounded-lg p-4 border border-orange-200">
                <h4 className="font-medium text-orange-800 mb-1">{lang === 'en' ? 'üìÑ Supplement' : 'üìÑ Suppl√©ment'}</h4>
                {rma.avenant_total && <p className="text-xl font-bold text-orange-700">{rma.avenant_total.toFixed(2)} ‚Ç¨</p>}
                {avenantQuoteUrl && (
                  <a href={avenantQuoteUrl} target="_blank" rel="noopener noreferrer" className="text-orange-600 hover:underline text-sm">
                    Voir l'avenant ‚Üó
                  </a>
                )}
                <p className="text-xs text-orange-500 mt-1">
                  {lang === 'en' ? 'Sent on' : 'Envoy√© le'} {rma.avenant_sent_at ? new Date(rma.avenant_sent_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : '‚Äî'}
                </p>
              </div>
            ) : (rma.quote_total || rma.quote_url) && (
              <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <h4 className="font-medium text-blue-800 mb-1">{lang === 'en' ? 'üí∞ Quote' : 'üí∞ Devis'}</h4>
                {rma.quote_number && <p className="text-sm font-mono text-blue-600">N¬∞ {rma.quote_number}</p>}
                {rma.quote_total && <p className="text-xl font-bold text-blue-700">{rma.quote_total.toFixed(2)} ‚Ç¨</p>}
                {rma.quote_url && (
                  <a href={rma.quote_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline text-sm">
                    Voir le devis ‚Üó
                  </a>
                )}
              </div>
            )}
            
            {/* BC Number Input - Critical for BL reference */}
            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
              <h4 className="font-medium text-green-800 mb-2">{lang === 'en' ? "üìã Purchase Order Number" : "üìã Num√©ro de Bon de Commande"}</h4>
              <p className="text-xs text-green-600 mb-3">
                {hasCustomerBCFile 
                  ? (lang === 'en' ? 'Client provided their own PO. Enter the client number.' : 'Le client a fourni son propre BC. Entrez le num√©ro du client.')
                  : (lang === 'en' ? 'Quote signed by client. Auto-generate or enter a number.' : 'Devis sign√© par le client. Auto-g√©n√©rer ou entrer un num√©ro.')}
              </p>
              
              {/* Toggle for auto-generate vs manual */}
              {!hasCustomerBCFile && (
                <div className="flex items-center gap-2 mb-3">
                  <button
                    onClick={() => { setUseAutoNumber(true); generateBCNumber(); }}
                    className={`flex-1 px-3 py-1.5 rounded text-sm font-medium transition-colors ${
                      useAutoNumber ? 'bg-green-600 text-white' : 'bg-white border border-green-300 text-green-700'
                    }`}
                  >
                    Auto
                  </button>
                  <button
                    onClick={() => { setUseAutoNumber(false); setBcNumber(''); }}
                    className={`flex-1 px-3 py-1.5 rounded text-sm font-medium transition-colors ${
                      !useAutoNumber ? 'bg-green-600 text-white' : 'bg-white border border-green-300 text-green-700'
                    }`}
                  >
                    Manuel
                  </button>
                </div>
              )}
              
              <div className="relative">
                <input
                  type="text"
                  value={bcNumber}
                  onChange={e => setBcNumber(e.target.value)}
                  placeholder={hasCustomerBCFile ? "N¬∞ BC du client (requis)" : "BC-0226-001"}
                  className={`w-full px-3 py-2 border rounded-lg font-mono text-center text-lg ${
                    hasCustomerBCFile && !bcNumber ? 'border-red-300 bg-red-50' : 'border-green-300'
                  }`}
                  disabled={generatingNumber}
                />
                {generatingNumber && (
                  <div className="absolute right-3 top-1/2 -translate-y-1/2">
                    <div className="w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                  </div>
                )}
              </div>
              
              {hasCustomerBCFile && !bcNumber && (
                <p className="text-xs text-red-600 mt-1">{lang === 'en' ? '‚ö†Ô∏è PO number required for Delivery Note' : '‚ö†Ô∏è Num√©ro BC requis pour le Bon de Livraison'}</p>
              )}
              
              {useAutoNumber && bcNumber && !hasCustomerBCFile && (
                <p className="text-xs text-green-600 mt-1">{lang === 'en' ? '‚úì This number will be used for the DN' : '‚úì Ce num√©ro sera utilis√© pour le BL'}</p>
              )}
            </div>
            
            {/* Reject Reason */}
            <div className="bg-red-50 rounded-lg p-4 border border-red-200">
              <h4 className="font-medium text-red-800 mb-2">{lang === 'en' ? 'Reject the PO?' : 'Refuser le BC?'}</h4>
              <textarea
                value={rejectReason}
                onChange={e => setRejectReason(e.target.value)}
                placeholder={lang === 'en' ? 'Rejection reason...' : 'Raison du refus...'}
                className="w-full px-3 py-2 border border-red-300 rounded-lg text-sm h-20 resize-none"
              />
            </div>
            
            {/* Actions */}
            <div className="space-y-2 pt-2">
              <button
                onClick={approveBC}
                disabled={approving}
                className={`w-full px-6 py-3 ${isAvenantBC ? 'bg-amber-500 hover:bg-amber-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-lg font-bold disabled:opacity-50`}
              >
                {approving ? (lang === 'en' ? 'Approving...' : 'Approbation...') : isAvenantBC ? (lang === 'en' ? '‚úÖ Approve Supplement' : '‚úÖ Approuver Suppl√©ment') : (lang === 'en' ? '‚úÖ Approve PO' : '‚úÖ Approuver BC')}
              </button>
              <button
                onClick={rejectBC}
                disabled={rejecting}
                className="w-full px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium disabled:opacity-50"
              >
                {rejecting ? 'Refus...' : '‚ùå Refuser BC'}
              </button>
              <button onClick={onClose} className="w-full px-6 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
                Annuler
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// CONTRACT BC REVIEW MODAL - Copied from RMA BCReviewModal
// ============================================
function ContractBCReviewModal({ contract, onClose, notify, reload, lang = 'fr' }) {
  const t = k => k;
  const [approving, setApproving] = useState(false);
  const [rejecting, setRejecting] = useState(false);
  const [rejectReason, setRejectReason] = useState('');
  
  const approveBC = async () => {
    setApproving(true);
    const { error } = await supabase
      .from('contracts')
      .update({ 
        status: 'active', 
        bc_approved_at: new Date().toISOString()
      })
      .eq('id', contract.id);
    
    if (error) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
    } else {
      notify(lang === 'en' ? '‚úÖ Contract activated! Client can now use their tokens.' : '‚úÖ Contrat activ√©! Le client peut maintenant utiliser ses tokens.');
      reload();
      onClose();
    }
    setApproving(false);
  };
  
  const rejectBC = async () => {
    if (!rejectReason.trim()) {
      notify(lang === 'en' ? 'Please indicate the rejection reason' : 'Veuillez indiquer la raison du refus', 'error');
      return;
    }
    setRejecting(true);
    const { error } = await supabase
      .from('contracts')
      .update({ 
        status: 'bc_rejected',
        bc_rejection_reason: rejectReason,
        // Clear old BC data so customer can resubmit
        bc_file_url: null,
        signed_quote_url: null,
        bc_submitted_at: null
      })
      .eq('id', contract.id);
    
    if (error) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
    } else {
      notify(lang === 'en' ? 'PO rejected. Client must submit a new PO.' : 'BC refus√©. Le client devra soumettre un nouveau BC.');
      reload();
      onClose();
    }
    setRejecting(false);
  };
  
  const devices = contract.contract_devices || [];
  const totalPrice = devices.reduce((sum, d) => sum + (d.unit_price || 0), 0);
  const totalTokens = devices.reduce((sum, d) => sum + (d.tokens_total || 0), 0);
  
  return (
    <div className="fixed inset-0 z-50 bg-black/80 flex" onClick={onClose}>
      <div className="bg-white w-full h-full max-w-[98vw] max-h-[98vh] m-auto rounded-xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white flex justify-between items-center flex-shrink-0">
          <div>
            <h2 className="text-xl font-bold">{lang === 'en' ? 'Purchase Order Verification' : 'V√©rification du Bon de Commande'} - Contrat</h2>
            <p className="text-orange-100">{contract.contract_number} ‚Ä¢ {contract.companies?.name}</p>
          </div>
          <button onClick={onClose} className="text-white/70 hover:text-white text-3xl">&times;</button>
        </div>
        
        {/* Content - Split Layout */}
        <div className="flex-1 overflow-hidden flex">
          {/* Left: Document Preview - Takes most of the space */}
          <div className="flex-1 flex flex-col bg-gray-800 p-4">
            <div className="flex justify-between items-center mb-3">
              <h3 className="font-bold text-white text-lg">{lang === 'en' ? 'üìÑ PO Documents' : 'üìÑ Documents BC'}</h3>
              <div className="flex gap-2">
                {contract.signed_quote_url && (
                  <a href={contract.signed_quote_url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium">
                    Devis Sign√© ‚Üó
                  </a>
                )}
                {contract.bc_file_url && (
                  <a href={contract.bc_file_url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-medium">
                    BC Client ‚Üó
                  </a>
                )}
              </div>
            </div>
            
            <div className="flex-1 bg-gray-900 rounded-lg overflow-hidden">
              {contract.signed_quote_url ? (
                <iframe 
                  src={contract.signed_quote_url} 
                  className="w-full h-full" 
                  title={lang === 'en' ? 'Signed Quote PDF' : 'Devis Sign√© PDF'}
                />
              ) : contract.bc_file_url ? (
                contract.bc_file_url.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? (
                  <div className="w-full h-full overflow-auto flex items-center justify-center">
                    <img src={contract.bc_file_url} alt="BC Document" className="max-w-full max-h-full object-contain" />
                  </div>
                ) : (
                  <iframe 
                    src={contract.bc_file_url} 
                    className="w-full h-full" 
                    title="BC Document"
                  />
                )
              ) : (
                <div className="w-full h-full flex items-center justify-center text-gray-400">
                  <div className="text-center">
                    <p className="text-4xl mb-4">üìÑ</p>
                    <p>{lang === 'en' ? 'No documents available' : 'Aucun document disponible'}</p>
                    <p className="text-sm">{lang === 'en' ? '(Electronic signature only)' : '(Signature √©lectronique uniquement)'}</p>
                  </div>
                </div>
              )}
            </div>
          </div>
          
          {/* Right: Contract Details Panel */}
          <div className="w-96 flex-shrink-0 bg-gray-50 border-l overflow-y-auto p-4 space-y-4">
            <h3 className="font-bold text-gray-800 text-lg">{lang === 'en' ? 'üìã Contract Details' : 'üìã D√©tails du Contrat'}</h3>
            
            {/* Contract Info */}
            <div className="bg-white rounded-lg p-4 border shadow-sm">
              <div className="space-y-3">
                <div className="flex justify-between">
                  <span className="text-sm text-gray-500">{lang === 'en' ? 'Contract #' : 'N¬∞ Contrat'}</span>
                  <span className="font-mono font-bold text-[#00A651]">{contract.contract_number}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-sm text-gray-500">{lang === 'en' ? 'Period' : 'P√©riode'}</span>
                  <span className="font-medium text-sm">
                    {new Date(contract.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} - {new Date(contract.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-sm text-gray-500">{lang === 'en' ? 'Submitted on' : 'Soumis le'}</span>
                  <span className="font-medium text-sm">{contract.bc_submitted_at ? new Date(contract.bc_submitted_at).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') : '‚Äî'}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-sm text-gray-500">{lang === 'en' ? 'Signed by' : 'Sign√© par'}</span>
                  <span className="font-medium">{contract.bc_signed_by || '‚Äî'}</span>
                </div>
              </div>
            </div>
            
            {/* Pricing Summary */}
            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
              <h4 className="font-medium text-green-800 mb-2">{lang === 'en' ? 'üí∞ Summary' : 'üí∞ R√©capitulatif'}</h4>
              <div className="space-y-2">
                <div className="flex justify-between">
                  <span className="text-green-700">{devices.length} {lang === 'en' ? 'devices' : 'appareils'}</span>
                  <span className="text-green-700">{totalTokens} {lang === 'en' ? 'calibrations/yr' : '√©talonnages/an'}</span>
                </div>
                <div className="flex justify-between items-center pt-2 border-t border-green-200">
                  <span className="font-medium text-green-800">{t('totalHT')}</span>
                  <span className="text-2xl font-bold text-green-700">{totalPrice.toFixed(2)} ‚Ç¨</span>
                </div>
              </div>
            </div>
            
            {/* Devices */}
            <div className="bg-white rounded-lg p-4 border">
              <h4 className="font-medium text-gray-700 mb-3">{lang === 'en' ? `Devices (${devices.length})` : `Appareils (${devices.length})`}</h4>
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {devices.map((d, i) => (
                  <div key={i} className="bg-gray-50 rounded p-3 border text-sm">
                    <p className="font-medium flex items-center gap-2">{getDeviceImageUrl(d.model_name) && <img src={getDeviceImageUrl(d.model_name)} alt="" className="w-4 h-4 object-contain" />}{d.model_name || (lang === 'en' ? 'Device' : 'Appareil')}</p>
                    <p className="text-gray-500">SN: {d.serial_number}</p>
                    <p className="text-gray-500">{d.tokens_total || 1} {lang === 'en' ? 'cal./yr' : '√©tal./an'} ‚Ä¢ {(d.unit_price || 0).toFixed(2)} ‚Ç¨</p>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Reject Reason Input */}
            <div className="bg-red-50 rounded-lg p-4 border border-red-200">
              <h4 className="font-medium text-red-800 mb-2">{lang === 'en' ? '‚ùå Reject PO?' : '‚ùå Refuser le BC?'}</h4>
              <textarea
                value={rejectReason}
                onChange={e => setRejectReason(e.target.value)}
                placeholder={lang === 'en' ? 'Rejection reason (illegible document, incorrect amount, etc.)...' : 'Raison du refus (document illisible, montant incorrect, etc.)...'}
                className="w-full px-3 py-2 border border-red-300 rounded-lg text-sm h-20 resize-none"
              />
            </div>
          </div>
        </div>
        
        {/* Footer Actions */}
        <div className="px-6 py-4 bg-gray-100 border-t flex justify-between items-center flex-shrink-0">
          <button onClick={onClose} className="px-6 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
            Annuler
          </button>
          <div className="flex gap-3">
            <button
              onClick={rejectBC}
              disabled={rejecting || !rejectReason.trim()}
              className="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium disabled:opacity-50"
            >
              {rejecting ? 'Refus...' : '‚ùå Refuser BC'}
            </button>
            <button
              onClick={approveBC}
              disabled={approving}
              className="px-8 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold disabled:opacity-50"
            >
              {approving ? (lang === 'en' ? 'Activating...' : 'Activation...') : (lang === 'en' ? '‚úÖ Approve & Activate Contract' : '‚úÖ Approuver & Activer Contrat')}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// RMA ACTIONS COMPONENT - RMA-level action buttons
// ============================================
function RMAActions({ rma, devices, notify, reload, onOpenShipping, onOpenAvenant, onStartService, saving, setSaving, lang = 'fr' }) {
  const [showReceiveModal, setShowReceiveModal] = useState(false);
  const [selectedToReceive, setSelectedToReceive] = useState(new Set());
  const [showQueueModal, setShowQueueModal] = useState(false);
  const [selectedToQueue, setSelectedToQueue] = useState(new Set());
  
  // Devices that haven't been received yet
  const unreceiveDevices = devices.filter(d => !d.received_at && d.status !== 'received' && !['in_queue', 'calibration_in_progress', 'repair_in_progress', 'final_qc', 'ready_to_ship', 'shipped'].includes(d.status));
  const receivedDevices = devices.filter(d => d.received_at || d.status === 'received' || ['in_queue', 'calibration_in_progress', 'repair_in_progress', 'final_qc', 'ready_to_ship', 'shipped'].includes(d.status));
  const receivedNotQueued = devices.filter(d => d.status === 'received');
  const queuedDevices = devices.filter(d => ['in_queue', 'calibration_in_progress', 'repair_in_progress', 'final_qc', 'ready_to_ship', 'shipped'].includes(d.status));
  
  // Determine what actions are available based on RMA/device state
  const isWaitingForDevice = ['approved', 'waiting_bc', 'waiting_device', 'waiting_po', 'bc_review', 'bc_approved'].includes(rma.status) && 
    unreceiveDevices.length > 0;
  
  const hasReceivedDevices = receivedDevices.length > 0;
  const hasQueuedDevices = queuedDevices.length > 0;
  
  const allQCComplete = devices.length > 0 && devices.every(d => d.qc_complete);
  const allReadyToShip = devices.length > 0 && devices.every(d => d.status === 'ready_to_ship' || d.qc_complete);
  const isReadyToShip = allQCComplete && allReadyToShip;
  
  const hasAdditionalWork = devices.some(d => d.additional_work_needed) && !rma.avenant_sent_at && !rma.supplement_review_status;
  const totalAdditionalWork = devices.reduce((sum, d) => {
    if (!d.additional_work_needed || !d.additional_work_items) return sum;
    return sum + d.additional_work_items.reduce((s, item) => s + (parseFloat(item.price) || 0), 0);
  }, 0);
  
  // Mark selected devices as received
  const markSelectedAsReceived = async () => {
    if (selectedToReceive.size === 0) {
      notify(lang === 'en' ? 'Select at least one device' : 'S√©lectionnez au moins un appareil', 'error');
      return;
    }
    
    setSaving(true);
    try {
      const now = new Date().toISOString();
      
      // Update selected devices
      for (const deviceId of selectedToReceive) {
        await supabase.from('request_devices').update({ 
          status: 'received',
          received_at: now
        }).eq('id', deviceId);
      }
      
      // If this is the first device(s) being received, update RMA status
      if (!rma.received_at) {
        await supabase.from('service_requests').update({ 
          status: 'received', 
          received_at: now,
          updated_at: now
        }).eq('id', rma.id);
      } else {
        // Just update the timestamp
        await supabase.from('service_requests').update({ 
          updated_at: now
        }).eq('id', rma.id);
      }
      
      notify(lang === 'en' ? `‚úÖ ${selectedToReceive.size} device(s) marked as received!` : `‚úÖ ${selectedToReceive.size} appareil(s) marqu√©(s) comme re√ßu(s)!`);
      
      // Prompt to print labels for received devices
      const receivedDevicesList = devices.filter(d => selectedToReceive.has(d.id));
      if (receivedDevicesList.length > 0) {
        const shouldPrint = confirm(
          lang === 'en' 
            ? `Print labels for ${receivedDevicesList.length} received device(s)?` 
            : `Imprimer les √©tiquettes pour ${receivedDevicesList.length} appareil(s) re√ßu(s) ?`
        );
        if (shouldPrint) {
          printDeviceLabels(receivedDevicesList, rma, lang);
        }
      }
      
      setShowReceiveModal(false);
      setSelectedToReceive(new Set());
      reload();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setSaving(false);
  };
  
  // Mark selected devices as queued
  const markSelectedAsQueued = async () => {
    if (selectedToQueue.size === 0) {
      notify(lang === 'en' ? 'Select at least one device' : 'S√©lectionnez au moins un appareil', 'error');
      return;
    }
    
    setSaving(true);
    try {
      for (const deviceId of selectedToQueue) {
        await supabase.from('request_devices').update({ 
          status: 'in_queue'
        }).eq('id', deviceId);
      }
      
      notify(lang === 'en' ? `‚úÖ ${selectedToQueue.size} device(s) moved to queue!` : `‚úÖ ${selectedToQueue.size} appareil(s) mis en file d'attente !`);
      setShowQueueModal(false);
      setSelectedToQueue(new Set());
      reload();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setSaving(false);
  };
  
  // Start service on RMA - update status and open first device
  const startService = async () => {
    // Open service modal for first queued device ‚Äî status change happens inside modal
    const firstQueued = devices.find(d => ['in_queue', 'received'].includes(d.status));
    if (firstQueued && onStartService) {
      onStartService(firstQueued);
    } else {
      notify(lang === 'en' ? 'No devices in queue' : "Aucun appareil en file d'attente", 'error');
    }
  };
  
  // No actions needed if RMA is closed
  if (['shipped', 'completed', 'delivered'].includes(rma.status)) {
    return null;
  }
  
  return (
    <>
      <div className="bg-white rounded-xl shadow-sm border p-4">
        <div className="flex flex-wrap items-center gap-3">
          {/* Waiting for device - show receive button */}
          {isWaitingForDevice && (
            <button
              onClick={() => {
                setSelectedToReceive(new Set());
                setShowReceiveModal(true);
              }}
              disabled={saving}
              className="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
            >
              {saving ? '‚è≥' : 'üì¶'} {lang === 'en' ? 'Receive Devices' : 'R√©ceptionner Appareils'} ({unreceiveDevices.length})
            </button>
          )}
          
          {/* Some devices received - show receive more + start service */}
          {hasReceivedDevices && unreceiveDevices.length > 0 && (
            <button
              onClick={() => {
                setSelectedToReceive(new Set());
                setShowReceiveModal(true);
              }}
              disabled={saving}
              className="px-4 py-2 bg-cyan-400 hover:bg-cyan-500 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
            >
              {lang === 'en' ? `üì¶ + Receive (${unreceiveDevices.length} remaining)` : `üì¶ + R√©ceptionner (${unreceiveDevices.length} restant)`}
            </button>
          )}
          
          {/* Received but not queued - show queue button */}
          {receivedNotQueued.length > 0 && (
            <button
              onClick={() => setShowQueueModal(true)}
              disabled={saving}
              className="px-4 py-2 bg-indigo-400 hover:bg-indigo-500 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
            >
              {saving ? '‚è≥' : 'üìã'} {lang === 'en' ? `Queue (${receivedNotQueued.length})` : `File d'attente (${receivedNotQueued.length})`}
            </button>
          )}
          
          {/* Received & queued - show start service button */}
          {hasQueuedDevices && !devices.some(d => d.service_findings || d.report_complete) && (
            <button
              onClick={startService}
              disabled={saving}
              className="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
            >
              {saving ? '‚è≥' : 'üîß'} {lang === 'en' ? 'Start Service' : 'D√©marrer Service'}
            </button>
          )}
          
          {/* Additional work found - show avenant button */}
          {hasAdditionalWork && (
            <button
              onClick={onOpenAvenant}
              className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium flex items-center gap-2"
            >
              {lang === 'en' ? `üìÑ Create Supplement (‚Ç¨${totalAdditionalWork.toFixed(2)})` : `üìÑ Cr√©er Suppl√©ment (‚Ç¨${totalAdditionalWork.toFixed(2)})`}
            </button>
          )}
          
          {/* Supplement pending review */}
          {rma.supplement_review_status === 'pending' && (
            <span className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">
              üìã {lang === 'en' ? 'Supplement under review' : 'Suppl√©ment en v√©rification'}
            </span>
          )}
          
          {/* Supplement needs correction */}
          {rma.supplement_review_status === 'corrections_needed' && (() => {
            const deviceToFix = devices.find(d => d.supplement_rejection_notes);
            return deviceToFix ? (
              <button
                onClick={() => onStartService(deviceToFix)}
                className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium flex items-center gap-2 animate-pulse"
              >
                ‚úèÔ∏è {lang === 'en' ? 'Correct Supplement' : 'Corriger Suppl√©ment'} ‚Äî {deviceToFix.model_name}
              </button>
            ) : (
              <button
                onClick={onOpenAvenant}
                className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium flex items-center gap-2 animate-pulse"
              >
                ‚úèÔ∏è {lang === 'en' ? 'Correct Supplement' : 'Corriger Suppl√©ment'}
              </button>
            );
          })()}
          
          {/* Avenant sent indicator */}
          {rma.avenant_sent_at && (
            <span className="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium">
              {lang === 'en' ? `üìÑ Supplement sent ${rma.avenant_approved_at ? '‚úì Approved' : '‚è≥ Pending'}` : `üìÑ Suppl√©ment envoy√© ${rma.avenant_approved_at ? '‚úì Approuv√©' : '‚è≥ En attente'}`}
            </span>
          )}
          
          {/* Ready to ship - show shipping button */}
          {isReadyToShip && (
            <div className="flex items-center gap-3">
              <button
                onClick={onOpenShipping}
                className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium flex items-center gap-2"
              >
                {lang === 'en' ? 'üöö Prepare Shipment' : 'üöö Pr√©parer Exp√©dition'}
              </button>
              <button
                onClick={async () => {
                  if (!confirm(lang === 'en' ? 'Mark all devices as shipped and close the RMA?' : 'Marquer tous les appareils comme exp√©di√©s et fermer le RMA?')) return;
                  setSaving(true);
                  try {
                    console.log('Marking devices as shipped...');
                    for (const device of devices) {
                      const { error: deviceError } = await supabase.from('request_devices').update({ 
                        status: 'shipped', 
                        shipped_at: new Date().toISOString()
                      }).eq('id', device.id);
                      if (deviceError) {
                        console.error('Device update error:', deviceError);
                        throw deviceError;
                      }
                      console.log('Device', device.id, 'marked as shipped');
                    }
                    
                    console.log('Marking RMA as shipped...');
                    const { error: rmaError } = await supabase.from('service_requests').update({ 
                      status: 'shipped', 
                      shipped_at: new Date().toISOString(), 
                      updated_at: new Date().toISOString() 
                    }).eq('id', rma.id);
                    if (rmaError) {
                      console.error('RMA update error:', rmaError);
                      throw rmaError;
                    }
                    console.log('RMA', rma.id, 'marked as shipped');
                    
                    notify(lang === 'en' ? 'üöö RMA marked as shipped!' : 'üöö RMA marqu√© comme exp√©di√©!');
                    reload();
                  } catch (err) {
                    console.error('Mark shipped error:', err);
                    notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + (err.message || JSON.stringify(err)), 'error');
                  }
                  setSaving(false);
                }}
                disabled={saving}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium flex items-center gap-2 disabled:opacity-50"
              >
                {saving ? '‚è≥...' : lang === 'en' ? 'üì¶ Mark Shipped' : 'üì¶ Marquer Exp√©di√©'}
              </button>
            </div>
          )}
          
          {/* Status indicator */}
          {receivedDevices.length > 0 && unreceiveDevices.length > 0 && (
            <span className="text-sm text-amber-600 bg-amber-50 px-3 py-1 rounded-lg">
              ‚ö†Ô∏è {receivedDevices.length}/{devices.length} {lang === 'en' ? 'devices received' : 'appareils re√ßus'}
            </span>
          )}
          
          {/* Status indicator when no actions available */}
          {!isWaitingForDevice && !hasReceivedDevices && !isReadyToShip && !hasAdditionalWork && devices.length > 0 && (
            <span className="text-sm text-gray-500">
              {lang === 'en' ? 'Service in progress... Click on a device to view/edit details.' : 'Service en cours... Cliquez sur un appareil pour voir/modifier les d√©tails.'}
            </span>
          )}
        </div>
      </div>
      
      {/* Device Receiving Modal */}
      {showReceiveModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-hidden">
            <div className="p-4 border-b bg-cyan-50">
              <h3 className="text-lg font-bold text-gray-800">{lang === 'en' ? 'üì¶ Receive Devices' : 'üì¶ R√©ceptionner les appareils'}</h3>
              <p className="text-sm text-gray-600 mt-1">{lang === 'en' ? 'Select the devices that have arrived' : 'S√©lectionnez les appareils qui sont arriv√©s'}</p>
            </div>
            
            <div className="p-4 max-h-[50vh] overflow-y-auto">
              {unreceiveDevices.length === 0 ? (
                <p className="text-gray-500 text-center py-4">{lang === 'en' ? 'All devices have been received' : 'Tous les appareils ont √©t√© re√ßus'}</p>
              ) : (
                <div className="space-y-2">
                  {/* Select all button */}
                  <button
                    onClick={() => {
                      if (selectedToReceive.size === unreceiveDevices.length) {
                        setSelectedToReceive(new Set());
                      } else {
                        setSelectedToReceive(new Set(unreceiveDevices.map(d => d.id)));
                      }
                    }}
                    className="w-full px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg text-left font-medium"
                  >
                    {selectedToReceive.size === unreceiveDevices.length ? (lang === 'en' ? '‚òëÔ∏è Deselect all' : '‚òëÔ∏è Tout d√©s√©lectionner') : (lang === 'en' ? '‚òê Select all' : '‚òê Tout s√©lectionner')}
                  </button>
                  
                  {unreceiveDevices.map(device => (
                    <label 
                      key={device.id}
                      className={`flex items-center gap-3 p-3 border rounded-lg cursor-pointer transition-colors ${
                        selectedToReceive.has(device.id) ? 'bg-cyan-50 border-cyan-300' : 'hover:bg-gray-50'
                      }`}
                    >
                      <input
                        type="checkbox"
                        checked={selectedToReceive.has(device.id)}
                        onChange={(e) => {
                          const newSet = new Set(selectedToReceive);
                          if (e.target.checked) {
                            newSet.add(device.id);
                          } else {
                            newSet.delete(device.id);
                          }
                          setSelectedToReceive(newSet);
                        }}
                        className="w-5 h-5 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500"
                      />
                      <div className="flex-1">
                        <p className="font-medium text-gray-800 flex items-center gap-2">{getDeviceImageUrl(device.model_name) && <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-5 h-5 object-contain" />}{device.model_name || (lang === 'en' ? 'Device' : 'Appareil')}</p>
                        <p className="text-sm text-gray-500 font-mono">SN: {device.serial_number || '‚Äî'}</p>
                      </div>
                      <span className={`px-2 py-1 rounded text-xs font-medium ${
                        device.service_type === 'repair' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'
                      }`}>
                        {device.service_type === 'repair' ? (lang === 'en' ? 'üîß Rep.' : 'üîß R√©p.') : (lang === 'en' ? 'üî¨ Cal.' : 'üî¨ √âtal.')}
                      </span>
                    </label>
                  ))}
                </div>
              )}
              
              {/* Already received devices */}
              {receivedDevices.length > 0 && (
                <div className="mt-4 pt-4 border-t">
                  <p className="text-sm text-gray-500 mb-2">{lang === 'en' ? 'Already received:' : 'D√©j√† re√ßus:'}</p>
                  <div className="space-y-1">
                    {receivedDevices.map(device => (
                      <div key={device.id} className="flex items-center gap-2 text-sm text-gray-400 bg-gray-50 p-2 rounded">
                        <span>‚úì</span>
                        <span>{device.model_name || (lang === 'en' ? 'Device' : 'Appareil')}</span>
                        <span className="font-mono text-xs">SN: {device.serial_number}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
            
            <div className="p-4 border-t bg-gray-50 flex items-center justify-between">
              <button
                onClick={() => setShowReceiveModal(false)}
                className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium"
              >
                Annuler
              </button>
              <button
                onClick={markSelectedAsReceived}
                disabled={saving || selectedToReceive.size === 0}
                className="px-6 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg font-bold disabled:opacity-50 flex items-center gap-2"
              >
                {saving ? (lang === 'en' ? '‚è≥ Saving...' : '‚è≥ Enregistrement...') : (lang === 'en' ? `üì¶ Receive (${selectedToReceive.size})` : `üì¶ R√©ceptionner (${selectedToReceive.size})`)}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Queue Modal */}
      {showQueueModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-hidden">
            <div className="p-4 border-b bg-indigo-50">
              <h3 className="text-lg font-bold text-gray-800">{lang === 'en' ? "üìã Move to Queue" : "üìã Mettre en file d'attente"}</h3>
              <p className="text-sm text-gray-600 mt-1">{lang === 'en' ? 'Select the devices to move to the service queue' : "S√©lectionnez les appareils √† mettre en file d'attente"}</p>
            </div>
            
            <div className="p-4 max-h-[50vh] overflow-y-auto">
              <div className="space-y-2">
                {/* Select all button */}
                <button
                  onClick={() => {
                    if (selectedToQueue.size === receivedNotQueued.length) {
                      setSelectedToQueue(new Set());
                    } else {
                      setSelectedToQueue(new Set(receivedNotQueued.map(d => d.id)));
                    }
                  }}
                  className="w-full px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg text-left font-medium"
                >
                  {selectedToQueue.size === receivedNotQueued.length ? (lang === 'en' ? '‚òëÔ∏è Deselect all' : '‚òëÔ∏è Tout d√©s√©lectionner') : (lang === 'en' ? '‚òê Select all' : '‚òê Tout s√©lectionner')}
                </button>
                
                {receivedNotQueued.map(device => (
                  <label 
                    key={device.id}
                    className={`flex items-center gap-3 p-3 border rounded-lg cursor-pointer transition-colors ${
                      selectedToQueue.has(device.id) ? 'bg-indigo-50 border-indigo-300' : 'hover:bg-gray-50'
                    }`}
                  >
                    <input
                      type="checkbox"
                      checked={selectedToQueue.has(device.id)}
                      onChange={(e) => {
                        const newSet = new Set(selectedToQueue);
                        if (e.target.checked) {
                          newSet.add(device.id);
                        } else {
                          newSet.delete(device.id);
                        }
                        setSelectedToQueue(newSet);
                      }}
                      className="w-5 h-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                    />
                    <div className="flex-1">
                      <p className="font-medium text-gray-800 flex items-center gap-2">{getDeviceImageUrl(device.model_name) && <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-5 h-5 object-contain" />}{device.model_name || (lang === 'en' ? 'Device' : 'Appareil')}</p>
                      <p className="text-sm text-gray-500 font-mono">SN: {device.serial_number || '‚Äî'}</p>
                    </div>
                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                      device.service_type === 'repair' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'
                    }`}>
                      {device.service_type === 'repair' ? (lang === 'en' ? 'üîß Rep.' : 'üîß R√©p.') : (lang === 'en' ? 'üî¨ Cal.' : 'üî¨ √âtal.')}
                    </span>
                  </label>
                ))}
              </div>
              
              {/* Already queued devices */}
              {queuedDevices.length > 0 && (
                <div className="mt-4 pt-4 border-t">
                  <p className="text-sm text-gray-500 mb-2">{lang === 'en' ? 'Already in queue:' : 'D√©j√† en file :'}</p>
                  <div className="space-y-1">
                    {queuedDevices.map(device => (
                      <div key={device.id} className="flex items-center gap-2 text-sm text-gray-400 bg-gray-50 p-2 rounded">
                        <span>‚úì</span>
                        <span>{device.model_name || (lang === 'en' ? 'Device' : 'Appareil')}</span>
                        <span className="font-mono text-xs">SN: {device.serial_number}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
            
            <div className="p-4 border-t bg-gray-50 flex items-center justify-between">
              <button
                onClick={() => { setShowQueueModal(false); setSelectedToQueue(new Set()); }}
                className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium"
              >
                {lang === 'en' ? 'Cancel' : 'Annuler'}
              </button>
              <button
                onClick={markSelectedAsQueued}
                disabled={saving || selectedToQueue.size === 0}
                className="px-6 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-bold disabled:opacity-50 flex items-center gap-2"
              >
                {saving ? '‚è≥...' : (lang === 'en' ? `üìã Queue (${selectedToQueue.size})` : `üìã File d'attente (${selectedToQueue.size})`)}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

// ============================================
// RMA FULL PAGE VIEW - Adaptive workflow interface
// ============================================
function RMAFullPage({ rma, onBack, notify, reload, profile, initialDevice, businessSettings, t = k=>k, lang = 'fr' }) {
  // State
  const [selectedDevice, setSelectedDevice] = useState(initialDevice || null);
  const [viewMode, setViewMode] = useState(initialDevice ? 'device' : 'overview'); // 'overview' or 'device'
  const [deviceTab, setDeviceTab] = useState('details'); // For device detail view tabs
  const [saving, setSaving] = useState(false);
  const [attachments, setAttachments] = useState([]);
  
  // Shipping address state - resolved per device
  const [deviceAddresses, setDeviceAddresses] = useState({}); // { deviceId: addressObj }
  const [rmaAddress, setRmaAddress] = useState(null); // RMA-level fallback address
  
  // Modal state
  const [showAvenantPreview, setShowAvenantPreview] = useState(false);
  const [showQCReview, setShowQCReview] = useState(null);
  const [showShippingModal, setShowShippingModal] = useState(false);
  const [showInternalShipping, setShowInternalShipping] = useState(false);
  const [showServiceModal, setShowServiceModal] = useState(null); // Device to show service modal for
  
  // Keep service modal device in sync with fresh data after reload
  useEffect(() => {
    if (showServiceModal && rma.request_devices) {
      const fresh = rma.request_devices.find(d => d.id === showServiceModal.id);
      if (fresh && JSON.stringify(fresh) !== JSON.stringify(showServiceModal)) {
        setShowServiceModal(fresh);
      }
    }
  }, [rma.request_devices]);
  
  // Document management state
  const [showDocUploadModal, setShowDocUploadModal] = useState(false);
  const [showArchivedDocs, setShowArchivedDocs] = useState(false);
  const [docUploadFile, setDocUploadFile] = useState(null);
  const [docUploadName, setDocUploadName] = useState('');
  const [docUploadCategory, setDocUploadCategory] = useState('general');
  const [docUploadShared, setDocUploadShared] = useState(true);
  const [docUploading, setDocUploading] = useState(false);
  const [docToDelete, setDocToDelete] = useState(null);
  
  // Fetch attachments for this RMA
  useEffect(() => {
    const fetchAttachments = async () => {
      if (!rma?.id) return;
      const { data } = await supabase
        .from('request_attachments')
        .select('*')
        .eq('request_id', rma.id)
        .order('created_at', { ascending: false });
      if (data) setAttachments(data);
    };
    fetchAttachments();
  }, [rma?.id]);
  
  // Fetch shipping addresses for devices and RMA
  useEffect(() => {
    const fetchAddresses = async () => {
      if (!rma?.id) return;
      const devices = rma.request_devices || [];
      const addressMap = {};
      
      // 1. Fetch RMA-level address (fallback for all devices)
      let rmaAddr = null;
      if (rma.shipping_address_id) {
        try {
          const { data } = await supabase.from('shipping_addresses').select('*').eq('id', rma.shipping_address_id).single();
          if (data) rmaAddr = data;
        } catch (e) {}
      }
      setRmaAddress(rmaAddr);
      
      // 2. Collect unique device-level shipping_address_ids
      const deviceAddrIds = [...new Set(devices.filter(d => d.shipping_address_id).map(d => d.shipping_address_id))];
      
      // 3. Batch fetch all device-specific addresses
      let deviceAddrMap = {};
      if (deviceAddrIds.length > 0) {
        try {
          const { data } = await supabase.from('shipping_addresses').select('*').in('id', deviceAddrIds);
          if (data) data.forEach(a => { deviceAddrMap[a.id] = a; });
        } catch (e) {}
      }
      
      // 4. Build resolved address per device: device-level > RMA-level > company billing
      const company = rma.companies || {};
      devices.forEach(d => {
        if (d.shipping_address_id && deviceAddrMap[d.shipping_address_id]) {
          addressMap[d.id] = deviceAddrMap[d.shipping_address_id];
        } else if (rmaAddr) {
          addressMap[d.id] = rmaAddr;
        } else {
          // Fallback to company billing
          addressMap[d.id] = {
            company_name: company.name || '‚Äî',
            address_line1: company.billing_address || '',
            city: company.billing_city || '',
            postal_code: company.billing_postal_code || '',
            country: company.country || 'France',
            attention: '',
            phone: company.phone || '',
            _isBillingFallback: true
          };
        }
      });
      setDeviceAddresses(addressMap);
    };
    fetchAddresses();
  }, [rma?.id, rma?.shipping_address_id, rma?.request_devices]);
  
  // Refresh attachments helper
  const refreshAttachments = async () => {
    if (!rma?.id) return;
    const { data } = await supabase
      .from('request_attachments')
      .select('*')
      .eq('request_id', rma.id)
      .order('created_at', { ascending: false });
    if (data) setAttachments(data);
  };
  
  // Upload document
  const handleDocUpload = async () => {
    if (!docUploadFile || !rma?.id) return;
    setDocUploading(true);
    try {
      const ext = docUploadFile.name.split('.').pop();
      const fileName = `doc_${rma.request_number}_${Date.now()}.${ext}`;
      const filePath = `attachments/${rma.request_number}/${fileName}`;
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('documents')
        .upload(filePath, docUploadFile, { contentType: docUploadFile.type });
      if (uploadError) throw uploadError;
      
      const { data: urlData } = supabase.storage.from('documents').getPublicUrl(filePath);
      const fileUrl = urlData?.publicUrl;
      
      const displayName = docUploadName.trim() || docUploadFile.name;
      const { error: insertError } = await supabase.from('request_attachments').insert({
        request_id: rma.id,
        file_name: displayName,
        file_url: fileUrl,
        file_type: docUploadFile.type,
        file_size: docUploadFile.size,
        uploaded_by: profile?.id,
        category: docUploadShared ? docUploadCategory : `internal_${docUploadCategory}`,
        device_serial: selectedDevice?.serial_number || null
      });
      if (insertError) throw insertError;
      
      notify(lang === 'en' ? 'üìÑ Document added!' : 'üìÑ Document ajout√©!');
      setShowDocUploadModal(false);
      setDocUploadFile(null);
      setDocUploadName('');
      setDocUploadCategory('general');
      setDocUploadShared(true);
      await refreshAttachments();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setDocUploading(false);
  };
  
  // Delete document
  const handleDocDelete = async (docId) => {
    try {
      const { error } = await supabase.from('request_attachments').update({
        archived_at: new Date().toISOString()
      }).eq('id', docId);
      if (error) throw error;
      notify(lang === 'en' ? 'üì¶ Document archived' : 'üì¶ Document archiv√©');
      setDocToDelete(null);
      await refreshAttachments();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
  };
  
  // Archive a main document (report, BL, UPS, cert, etc.) ‚Äî soft delete + clear URL
  const [mainDocToArchive, setMainDocToArchive] = useState(null);
  const archiveMainDoc = async (docInfo) => {
    // docInfo = { label, url, table, field, id }
    try {
      // Save old URL as archived attachment
      await supabase.from('request_attachments').insert({
        request_id: rma.id,
        file_name: `[Archiv√©] ${docInfo.label}`,
        file_url: docInfo.url,
        file_type: 'archived',
        category: 'internal_archived',
        uploaded_by: profile?.id || null,
        archived_at: new Date().toISOString(),
        notes: `Archived on ${new Date().toLocaleDateString('fr-FR')} by ${profile?.full_name || 'Admin'}`
      });
      
      // Clear URL field on device/rma
      const { error } = await supabase.from(docInfo.table).update({
        [docInfo.field]: null
      }).eq('id', docInfo.id);
      if (error) throw error;
      
      notify(lang === 'en' ? `üì¶ ${docInfo.label} archived` : `üì¶ ${docInfo.label} archiv√©`);
      setMainDocToArchive(null);
      reload();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
  };
  
  // Unarchive a document (restore it)
  const unarchiveDoc = async (doc) => {
    try {
      if (doc.category === 'internal_archived' && doc.file_url) {
        // Main doc archive ‚Äî restore URL to original field
        const label = (doc.file_name || '').replace('[Archiv√©] ', '');
        const fieldMap = {
          'Rapport de Service': { table: 'request_devices', field: 'report_url', id: selectedDevice?.id },
          'Bon de Livraison': { table: 'request_devices', field: 'bl_url', id: selectedDevice?.id },
          '√âtiquette UPS': { table: 'request_devices', field: 'ups_label_url', id: selectedDevice?.id },
          "Certificat d'√âtalonnage": { table: 'request_devices', field: 'calibration_certificate_url', id: selectedDevice?.id },
          'Devis': { table: 'service_requests', field: 'quote_url', id: rma.id },
          'Devis Sign√© / BC': { table: 'service_requests', field: 'signed_quote_url', id: rma.id },
          'Bon de Commande': { table: 'service_requests', field: 'bc_file_url', id: rma.id },
          'Suppl√©ment Sign√© / BC': { table: 'service_requests', field: 'supplement_signed_quote_url', id: rma.id },
          'BC Suppl√©ment': { table: 'service_requests', field: 'supplement_bc_file_url', id: rma.id },
        };
        const mapping = fieldMap[label];
        if (mapping && mapping.id) {
          await supabase.from(mapping.table).update({ [mapping.field]: doc.file_url }).eq('id', mapping.id);
        }
        await supabase.from('request_attachments').delete().eq('id', doc.id);
      } else {
        // Regular attachment ‚Äî clear archived_at
        await supabase.from('request_attachments').update({ archived_at: null }).eq('id', doc.id);
      }
      notify(lang === 'en' ? '‚úÖ Document restored' : '‚úÖ Document restaur√©');
      await refreshAttachments();
      reload();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
  };
  
  // Toggle document visibility
  const handleToggleDocVisibility = async (doc) => {
    try {
      const isInternal = doc.category?.startsWith('internal_');
      const newCategory = isInternal 
        ? doc.category.replace('internal_', '') 
        : `internal_${doc.category || 'general'}`;
      const { error } = await supabase.from('request_attachments')
        .update({ category: newCategory })
        .eq('id', doc.id);
      if (error) throw error;
      notify(isInternal ? (lang === 'en' ? 'üëÅÔ∏è Document visible to client' : 'üëÅÔ∏è Document visible au client') : (lang === 'en' ? 'üîí Document hidden from client' : 'üîí Document masqu√© au client'));
      await refreshAttachments();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
  };
  
  // Effect to handle initialDevice changes (when coming from dashboard)
  useEffect(() => {
    if (initialDevice) {
      setSelectedDevice(initialDevice);
      setViewMode('device');
    }
  }, [initialDevice?.id]); // Only trigger when device ID changes
  
  // Safe back to overview handler
  const handleBackToOverview = () => {
    setSelectedDevice(null);
    setViewMode('overview');
    setDeviceTab('details');
  };
  
  // Safety check
  if (!rma) {
    return (
      <div className="p-8 text-center">
        <p className="text-red-500">{lang === 'en' ? 'Error: RMA not found' : 'Erreur: RMA non trouv√©'}</p>
        <button onClick={onBack} className="mt-4 px-4 py-2 bg-gray-200 rounded-lg">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
      </div>
    );
  }
  
  const devices = rma.request_devices || [];
  const company = rma.companies || {};
  const isRMAClosed = ['shipped', 'completed', 'delivered'].includes(rma.status);
  const isContractRMA = rma.is_contract_rma || rma.contract_id;
  
  // Progress steps for devices
  const calibrationSteps = [
    { id: 'submitted', label: t('stSubmitted') },
    { id: 'rma_created', label: lang === 'en' ? 'Quote Created' : 'Devis Cr√©√©' },
    { id: 'bc_approved', label: t('stQuoteApproved') },
    { id: 'waiting_device', label: lang === 'en' ? 'Pending' : 'Attente' },
    { id: 'received', label: t('stReceived') },
    { id: 'queue', label: lang === 'en' ? 'Queue' : 'File' },
    { id: 'calibration', label: lang === 'en' ? 'Calibration' : '√âtalonnage' },
    { id: 'final_qc', label: lang === 'en' ? 'QC Check' : 'Contr√¥le QC' },
    { id: 'ready_to_ship', label: lang === 'en' ? 'Ready' : 'Pr√™t' },
    { id: 'shipped', label: t('stShipped') }
  ];

  const repairSteps = [
    { id: 'submitted', label: t('stSubmitted') },
    { id: 'rma_created', label: lang === 'en' ? 'Quote Created' : 'Devis Cr√©√©' },
    { id: 'bc_approved', label: t('stQuoteApproved') },
    { id: 'waiting_device', label: lang === 'en' ? 'Pending' : 'Attente' },
    { id: 'received', label: t('stReceived') },
    { id: 'queue', label: lang === 'en' ? 'Queue' : 'File' },
    { id: 'inspection', label: lang === 'en' ? 'Inspection' : 'Inspection' },
    { id: 'customer_approval', label: lang === 'en' ? 'Client Appr.' : 'Appr. Client' },
    { id: 'repair', label: lang === 'en' ? 'Repair' : 'R√©paration' },
    { id: 'final_qc', label: lang === 'en' ? 'QC Check' : 'Contr√¥le QC' },
    { id: 'ready_to_ship', label: lang === 'en' ? 'Ready' : 'Pr√™t' },
    { id: 'shipped', label: t('stShipped') }
  ];
  
  // Get step index for a device status
  const getStepIndex = (status, isRepair) => {
    if (!status && rma.request_number) return 1;
    
    if (isRepair) {
      const repairMap = {
        'submitted': 0, 'pending': 0, 'waiting_approval': 0,
        'approved': 1, 'rma_created': 1, 'quote_sent': 1, 'pending_quote_review': 1,
        'waiting_bc': 2, 'bc_submitted': 2, 'bc_review': 2,
        'bc_approved': 3, 'waiting_device': 3, 'waiting_po': 3, 'waiting_reception': 3,
        'received': 4,
        'in_queue': 5, 'queue': 5, 'queued': 5,
        'inspection': 6, 'inspection_complete': 6,
        'customer_approval': 7, 'waiting_customer': 7,
        'repair_in_progress': 8, 'repair': 8,
        'final_qc': 9, 'qc_complete': 9, 'qc_rejected': 8,
        'ready_to_ship': 10,
        'shipped': 11, 'delivered': 11, 'completed': 11
      };
      return repairMap[status] ?? 0;
    } else {
      const calMap = {
        'submitted': 0, 'pending': 0, 'waiting_approval': 0,
        'approved': 1, 'rma_created': 1, 'quote_sent': 1, 'pending_quote_review': 1,
        'waiting_bc': 2, 'bc_submitted': 2, 'bc_review': 2,
        'bc_approved': 3, 'waiting_device': 3, 'waiting_po': 3, 'waiting_reception': 3,
        'received': 4, 'in_queue': 5,
        'calibration_in_progress': 6, 'calibration': 6,
        'final_qc': 7, 'qc_complete': 7, 'qc_rejected': 6,
        'ready_to_ship': 8,
        'shipped': 9, 'delivered': 9, 'completed': 9
      };
      return calMap[status] ?? 0;
    }
  };
  
  // Device Progress Bar Component
  const DeviceProgressBar = ({ device }) => {
    const deviceServiceType = device.service_type || rma.requested_service || 'calibration';
    const isRepair = deviceServiceType === 'repair';
    const steps = isRepair ? repairSteps : calibrationSteps;
    
    const isShipped = device.status === 'shipped' || !!device.shipped_at;
    
    // Detect: device physically received but quote not yet approved
    // RMA has received_at OR device status is 'received' BUT RMA is still in quote/BC phase
    const quotePhaseStatuses = ['quote_sent', 'pending_quote_review', 'waiting_bc', 'bc_review', 'bc_submitted', 'rma_created', 'approved'];
    const initialQuoteDone = rma.quote_sent_at || rma.avenant_sent_at || rma.bc_submitted_at;
    const deviceReceivedEarly = (rma.received_at || device.status === 'received') && quotePhaseStatuses.includes(rma.status) && !initialQuoteDone;
    
    // Smart status: use device.status only if it's a "real" device status (received onwards)
    const deviceSpecificStatuses = ['received', 'in_queue', 'inspection', 'calibration', 'calibration_in_progress', 
      'repair', 'repair_in_progress', 'final_qc', 'qc_complete', 'qc_rejected', 'ready_to_ship', 'shipped', 'completed'];
    const effectiveStatus = deviceSpecificStatuses.includes(device.status) ? device.status : rma.status;
    const currentIndex = getStepIndex(effectiveStatus, isRepair);
    
    return (
      <div className="flex w-full">
        {steps.map((step, index) => {
          const isCompleted = index < currentIndex;
          const isCurrent = index === currentIndex;
          const isLast = index === steps.length - 1;
          
          // Red highlight on quote step (index 1) when device received but quote not approved
          const isQuoteStepRed = deviceReceivedEarly && index === 1;
          
          return (
            <div key={step.id} className="flex-1" style={{ minWidth: '50px' }}>
              <div 
                className={`
                  flex items-center justify-center h-9 px-2 text-[10px] font-medium text-center leading-tight
                  ${isQuoteStepRed ? 'bg-red-500 text-white animate-pulse' : isShipped && isLast ? 'bg-green-500 text-white' : isCompleted ? 'bg-[#3B7AB4] text-white' : isCurrent ? 'bg-[#2D5A7B] text-white' : 'bg-gray-200 text-gray-500'}
                  ${index === 0 ? 'rounded-l-md' : ''}
                  ${isLast ? 'rounded-r-md' : ''}
                `}
                style={{
                  clipPath: isLast 
                    ? 'polygon(0 0, 100% 0, 100% 100%, 0 100%, 6px 50%)' 
                    : index === 0 
                      ? 'polygon(0 0, calc(100% - 6px) 0, 100% 50%, calc(100% - 6px) 100%, 0 100%)'
                      : 'polygon(0 0, calc(100% - 6px) 0, 100% 50%, calc(100% - 6px) 100%, 0 100%, 6px 50%)'
                }}
              >
                <span className="break-words hyphens-auto">{isQuoteStepRed ? (lang === 'en' ? '‚ö†Ô∏è Quote!' : '‚ö†Ô∏è Devis!') : isShipped && isLast ? (lang === 'en' ? '‚úì Shipped' : '‚úì Exp√©di√©') : step.label}</span>
              </div>
            </div>
          );
        })}
      </div>
    );
  };

  // Get device status label
  const getDeviceStatusLabel = (device) => {
    // Early stages = before device physically arrives
    const earlyStatuses = ['submitted', 'pending', 'quote_sent', 'quote_revision_requested', 'quote_revision_declined', 
                           'approved', 'bc_pending', 'bc_review', 'waiting_bc', 'waiting_po', 'waiting_device', 'bc_approved', 'pending_quote_review'];
    const rmaIsEarly = earlyStatuses.includes(rma.status);
    
    // Priority overrides
    if (device.shipped_at) return lang === 'en' ? 'Shipped' : 'Exp√©di√©';
    if (device.qc_complete) return lang === 'en' ? 'Ready' : 'Pr√™t';
    if (device.report_complete && !device.qc_complete) return lang === 'en' ? 'QC Check' : 'Contr√¥le QC';
    
    // If RMA is early, use RMA status; otherwise use device status
    const status = rmaIsEarly ? rma.status : (device.status || rma.status);
    
    const labels = {
      'submitted': (lang === 'en' ? 'Submitted' : 'Soumis'),
      'approved': (lang === 'en' ? 'Approved' : 'Approuv√©'),
      'waiting_bc': lang === 'en' ? 'Awaiting PO' : 'Attente BC',
      'bc_review': lang === 'en' ? 'PO in review' : 'BC en revue',
      'bc_approved': lang === 'en' ? 'PO Approved' : 'BC Approuv√©',
      'waiting_device': lang === 'en' ? 'Awaiting device' : 'Attente appareil',
      'received': lang === 'en' ? 'Received' : 'Re√ßu',
      'in_queue': lang === 'en' ? 'In queue' : 'En file',
      'calibration_in_progress': lang === 'en' ? 'Calibration' : '√âtalonnage',
      'repair_in_progress': lang === 'en' ? 'Repair' : 'R√©paration',
      'final_qc': lang === 'en' ? 'QC Check' : 'Contr√¥le QC',
      'ready_to_ship': lang === 'en' ? 'Ready' : 'Pr√™t',
      'shipped': lang === 'en' ? 'Shipped' : 'Exp√©di√©'
    };
    return labels[status] || status;
  };

  // ========== SERVICE MODAL (Full Page) ==========
  if (showServiceModal) {
    return (
      <DeviceServiceModal
        key={showServiceModal.id}
        device={showServiceModal}
        rma={rma}
        onBack={() => { setShowServiceModal(null); reload(); }}
        notify={notify}
        reload={reload}
        profile={profile}
        businessSettings={businessSettings}
        allDevices={devices}
        onNextDevice={(nextDev) => { setShowServiceModal(nextDev); }}
        onOpenSupplement={() => { setShowServiceModal(null); setShowAvenantPreview(true); reload(); }}
      />
    );
  }
  
  // ========== QC REVIEW MODAL (Full Page) ==========
  if (showQCReview) {
    return (
      <QCReviewModal
        device={showQCReview}
        rma={rma}
        onBack={() => { setShowQCReview(null); reload(); }}
        notify={notify}
        profile={profile}
      />
    );
  }

  // ========== DEVICE DETAIL VIEW ==========
  if (viewMode === 'device' && selectedDevice) {
    const device = devices.find(d => d.id === selectedDevice.id) || selectedDevice;
    
    // Device action conditions
    const isDeviceShipped = device.status === 'shipped';
    const isDeviceReadyToShip = device.status === 'ready_to_ship' || device.qc_complete;
    const needsQC = device.report_complete && !device.qc_complete;
    // Device must be received (have received_at or be in service status) before starting service
    const isDeviceReceived = device.received_at || ['received', 'in_queue', 'calibration_in_progress', 'repair_in_progress', 'final_qc', 'ready_to_ship'].includes(device.status);
    const isDeviceInQueue = ['in_queue', 'calibration_in_progress', 'repair_in_progress', 'final_qc', 'ready_to_ship'].includes(device.status);
    const isReceivedNotQueued = isDeviceReceived && device.status === 'received';
    const canStartService = (isDeviceReceived || isDeviceInQueue) && !device.report_complete && !isDeviceShipped;
    
    return (
      <div className="space-y-6">
        {/* Back to RMA Overview */}
        <div className="flex items-center gap-4">
          <button 
            onClick={handleBackToOverview}
            className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 font-medium"
          >
            ‚Üê Retour au RMA
          </button>
          <button 
            onClick={() => printDeviceLabels([device], rma, lang, devices.length)}
            className="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-600 font-medium text-sm flex items-center gap-1"
          >
            üè∑Ô∏è {lang === 'en' ? 'Print Label' : '√âtiquette'}
          </button>
        </div>
        
        {/* Device Header */}
        <div className="bg-white rounded-xl shadow-sm border p-6">
          <div className="flex items-start justify-between mb-4">
            <div>
              <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-3">{getDeviceImageUrl(device.model_name) && <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-8 h-8 object-contain" />}{device.model_name}</h1>
              <p className="text-lg text-gray-500 font-mono">SN: {device.serial_number}</p>
            </div>
            <div className="text-right">
              <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                device.status === 'shipped' ? 'bg-green-100 text-green-700' :
                device.status === 'ready_to_ship' ? 'bg-blue-100 text-blue-700' :
                'bg-amber-100 text-amber-700'
              }`}>
                {getDeviceStatusLabel(device)}
              </span>
              <p className="text-sm text-gray-500 mt-2">
                {device.service_type === 'calibration' ? (lang === 'en' ? 'üî¨ Calibration' : 'üî¨ √âtalonnage') : 
                 device.service_type === 'repair' ? (lang === 'en' ? 'üîß Repair' : 'üîß R√©paration') : 
                 (lang === 'en' ? 'üî¨üîß Cal. + Rep.' : 'üî¨üîß √âtal. + R√©p.')}
              </p>
            </div>
          </div>
          
          {/* Progress Bar */}
          <DeviceProgressBar device={device} />
          
          {/* Return Shipping Address */}
          <div className="mt-4 pt-4 border-t">
            <div className="flex items-center justify-between mb-1">
              <p className="text-xs text-gray-500 uppercase tracking-wide">{t('returnAddress')}</p>
              {!isDeviceShipped && (
                <button 
                  onClick={async () => {
                    // Fetch client's saved addresses for override
                    const { data: addrs } = await supabase.from('shipping_addresses').select('*').eq('company_id', rma.company_id).order('label');
                    if (!addrs || addrs.length === 0) { notify(lang === 'en' ? 'No address registered for this client' : 'Aucune adresse enregistr√©e pour ce client', 'error'); return; }
                    const labels = addrs.map((a, i) => `${i + 1}. ${a.label || a.company_name || '‚Äî'} ‚Äî ${a.address_line1}, ${a.postal_code} ${a.city}`).join('\n');
                    const choice = prompt(lang === 'en' ? `Choose return address (number):\n\n${labels}\n\n0 = Use default RMA address` : `Choisir l'adresse de retour (num√©ro):\n\n${labels}\n\n0 = Utiliser l'adresse RMA par d√©faut`);
                    if (choice === null) return;
                    const idx = parseInt(choice);
                    if (idx === 0) {
                      // Reset to RMA default
                      await supabase.from('request_devices').update({ shipping_address_id: null }).eq('id', device.id);
                      notify(lang === 'en' ? 'Address reset (RMA default)' : 'Adresse r√©initialis√©e (d√©faut RMA)');
                      reload();
                    } else if (idx >= 1 && idx <= addrs.length) {
                      await supabase.from('request_devices').update({ shipping_address_id: addrs[idx - 1].id }).eq('id', device.id);
                      notify(lang === 'en' ? 'Return address updated!' : 'Adresse de retour mise √† jour!');
                      reload();
                    }
                  }}
                  className="text-xs text-blue-500 hover:text-blue-700 hover:underline"
                >{lang === 'en' ? '‚úèÔ∏è Edit' : '‚úèÔ∏è Modifier'}</button>
              )}
            </div>
            {(() => {
              const addr = deviceAddresses[device.id];
              if (!addr) return <p className="text-sm text-gray-400 italic">{t('loading')}</p>;
              const isDifferent = device.shipping_address_id && device.shipping_address_id !== rma.shipping_address_id;
              return (
                <div className="flex items-start gap-2">
                  <div className="text-sm text-gray-700">
                    <p className="font-medium">{addr.company_name || addr.label || '‚Äî'}</p>
                    {addr.attention && <p className="text-gray-500">Att: {addr.attention}</p>}
                    <p>{addr.address_line1 || '‚Äî'}</p>
                    <p>{addr.postal_code} {addr.city}{addr.country && addr.country !== 'France' ? ', ' + addr.country : ''}</p>
                  </div>
                  {isDifferent && (
                    <span className="px-2 py-0.5 bg-amber-100 text-amber-700 rounded-full text-xs font-medium whitespace-nowrap">{lang === 'en' ? 'Specific address' : 'Adresse sp√©cifique'}</span>
                  )}
                </div>
              );
            })()}
          </div>
        </div>
        
        {/* Device-Level Actions */}
        {!isDeviceShipped && (
          <div className="bg-white rounded-xl shadow-sm border p-4">
            <div className="flex flex-wrap items-center gap-3">
              {/* Not received message */}
              {!isDeviceReceived && !device.report_complete && (
                <span className="px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium flex items-center gap-2">
                  {lang === 'en' ? 'üì¶ Device not received - Mark as received to start service' : 'üì¶ Appareil non r√©ceptionn√© - Marquer comme re√ßu pour d√©marrer le service'}
                </span>
              )}
              
              {/* Queue button - received but not yet in queue */}
              {isReceivedNotQueued && !device.report_complete && (
                <button
                  onClick={async () => {
                    setSaving(true);
                    try {
                      await supabase.from('request_devices').update({ 
                        status: 'in_queue'
                      }).eq('id', device.id);
                      notify(lang === 'en' ? "‚úÖ Device moved to queue!" : "‚úÖ Appareil mis en file d'attente !");
                      reload();
                    } catch (err) {
                      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
                    }
                    setSaving(false);
                  }}
                  disabled={saving}
                  className="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-medium flex items-center gap-2"
                >
                  üìã {saving ? '‚è≥...' : (lang === 'en' ? "Move to Queue" : "Mettre en file d'attente")}
                </button>
              )}
              
              {/* Service button - Edit or Start */}
              {canStartService && (
                <button
                  onClick={() => setShowServiceModal(device)}
                  className="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-medium flex items-center gap-2"
                >
                  üîß {device.report_complete ? (lang === 'en' ? 'Edit Service' : 'Modifier Service') : device.service_findings ? (lang === 'en' ? 'Continue Service' : 'Continuer Service') : (lang === 'en' ? 'Process Device' : 'Traiter Appareil')}
                </button>
              )}
              
              {/* QC button */}
              {needsQC && (
                <button
                  onClick={() => setShowQCReview(device)}
                  className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium flex items-center gap-2"
                >
                  ‚úÖ Contr√¥le Qualit√©
                </button>
              )}
              
              {/* QC Complete indicator */}
              {device.qc_complete && !isDeviceShipped && (
                <span className="px-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-medium">
                  ‚úÖ QC Valid√© - Pr√™t pour exp√©dition
                </span>
              )}
              
              {/* Report complete but no QC yet */}
              {device.report_complete && !device.qc_complete && (
                <span className="px-3 py-2 bg-amber-100 text-amber-700 rounded-lg text-sm font-medium">
                  üìã Rapport termin√© - En attente QC
                </span>
              )}
            </div>
          </div>
        )}
        
        {/* Device Tabs */}
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <div className="flex border-b">
            {[
              { id: 'details', label: lang === 'en' ? 'Details' : 'D√©tails', icon: 'üìã' },
              { id: 'history', label: lang === 'en' ? 'History' : 'Historique', icon: 'üìú' },
              { id: 'documents', label: lang === 'en' ? 'Documents' : 'Documents', icon: 'üìÑ' }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setDeviceTab(tab.id)}
                className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                  deviceTab === tab.id 
                    ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-500' 
                    : 'text-gray-500 hover:bg-gray-50'
                }`}
              >
                <span>{tab.icon}</span> {tab.label}
              </button>
            ))}
          </div>
          
          <div className="p-6">
            {/* Details Tab */}
            {deviceTab === 'details' && (
              <div className="space-y-6">
                {/* Service Info */}
                <div>
                  <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'Service information' : 'Informations du service'}</h3>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div className="bg-gray-50 rounded-lg p-3">
                      <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Service type' : 'Type de service'}</p>
                      <p className="font-medium">{device.service_type === 'calibration' ? t('calibration') : device.service_type === 'repair' ? t('repair') : device.service_type}</p>
                    </div>
                    <div className="bg-gray-50 rounded-lg p-3">
                      <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Technician' : 'Technicien'}</p>
                      <p className="font-medium">{device.technician_name || '‚Äî'}</p>
                    </div>
                    {device.cal_type && (
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Calibration Type' : "Type d'√©talonnage"}</p>
                        <p className="font-medium">{device.cal_type}</p>
                      </div>
                    )}
                    {device.reception_result && (
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Reception Result' : 'R√©sultat r√©ception'}</p>
                        <p className="font-medium">{device.reception_result}</p>
                      </div>
                    )}
                    {device.bl_number && (
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-xs text-gray-500 uppercase">{t('blNumber')}</p>
                        <p className="font-medium font-mono">{device.bl_number}</p>
                      </div>
                    )}
                    {device.tracking_number && (
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-xs text-gray-500 uppercase">{t('trackingNumber')}</p>
                        <a href={`https://www.ups.com/track?tracknum=${device.tracking_number}`} target="_blank" rel="noopener noreferrer" className="font-mono text-blue-600 hover:underline">{device.tracking_number}</a>
                      </div>
                    )}
                  </div>
                </div>
                
                {/* Findings & Work */}
                {(device.service_findings || device.work_completed) && (
                  <div>
                    <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'Service report' : 'Rapport de service'}</h3>
                    {device.service_findings && (
                      <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-3">
                        <p className="text-xs text-amber-600 uppercase mb-1">{t('findings')}</p>
                        <p className="text-gray-700 whitespace-pre-wrap">{device.service_findings}</p>
                      </div>
                    )}
                    {device.work_completed && (
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p className="text-xs text-blue-600 uppercase mb-1">{t('workCompleted')}</p>
                        <p className="text-gray-700 whitespace-pre-wrap">{device.work_completed}</p>
                      </div>
                    )}
                  </div>
                )}
                
                {/* Customer Notes */}
                {device.notes && (
                  <div>
                    <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'Client notes' : 'Notes du client'}</h3>
                    <div className="bg-gray-50 rounded-lg p-4">
                      <p className="text-gray-700 whitespace-pre-wrap">{device.notes}</p>
                    </div>
                  </div>
                )}
                
                {/* Internal Notes */}
                {device.internal_notes && (
                  <div>
                    <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'Internal notes' : 'Notes internes'}</h3>
                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                      <p className="text-gray-700 whitespace-pre-wrap">{device.internal_notes}</p>
                    </div>
                  </div>
                )}
                
                {/* QC Rejection Warning */}
                {device.qc_rejected && device.qc_rejection_reason && (
                  <div className="bg-red-50 border-2 border-red-300 rounded-xl p-4">
                    <div className="flex items-start gap-3">
                      <span className="text-2xl">‚ùå</span>
                      <div>
                        <h3 className="font-bold text-red-800 mb-1">{lang === 'en' ? 'QC Rejected - Corrections Required' : 'QC Rejet√© - Corrections Requises'}</h3>
                        <p className="text-red-700 whitespace-pre-wrap">{device.qc_rejection_reason}</p>
                        {device.qc_rejected_at && (
                          <p className="text-red-500 text-sm mt-2">
                            {lang === 'en' ? 'Rejected on' : 'Rejet√© le'} {new Date(device.qc_rejected_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} {lang === 'en' ? 'at' : '√†'} {new Date(device.qc_rejected_at).toLocaleTimeString(lang === 'en' ? 'en-US' : 'fr-FR', {hour: '2-digit', minute: '2-digit'})}
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* QC Notes */}
                {device.qc_notes && (
                  <div>
                    <h3 className="font-bold text-gray-800 mb-3">{t('qcNotes')}</h3>
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                      <p className="text-gray-700 whitespace-pre-wrap">{device.qc_notes}</p>
                    </div>
                  </div>
                )}
              </div>
            )}
            
            {/* History Tab */}
            {deviceTab === 'history' && (
              <div className="space-y-4">
                <h3 className="font-bold text-gray-800">{lang === 'en' ? 'History of this device' : 'Historique de cet appareil'}</h3>
                <div className="relative">
                  <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                  <div className="space-y-4">
                    {[
                      { date: rma.created_at, label: t('stSubmitted'), icon: 'üìù', color: 'gray' },
                      rma.request_number && { date: rma.created_at, label: lang === 'en' ? 'RMA Created' : 'RMA cr√©√©', icon: 'üìã', color: 'blue' },
                      rma.quote_sent_at && { date: rma.quote_sent_at, label: lang === 'en' ? 'Quote Sent' : 'Devis envoy√©', icon: 'üí∞', color: 'amber' },
                      rma.bc_submitted_at && { date: rma.bc_submitted_at, label: lang === 'en' ? 'PO submitted' : 'BC soumis', icon: 'üìÑ', color: 'purple' },
                      rma.bc_approved_at && { date: rma.bc_approved_at, label: lang === 'en' ? 'PO approved - Awaiting device' : 'BC approuv√© - Attente appareil', icon: '‚úÖ', color: 'green' },
                      rma.received_at && { date: rma.received_at, label: lang === 'en' ? 'Device Received' : 'Appareil re√ßu', icon: 'üì¶', color: 'cyan' },
                      device.service_started_at && { date: device.service_started_at, label: device.service_type === 'repair' ? (lang === 'en' ? 'Repair started' : 'R√©paration d√©marr√©e') : (lang === 'en' ? 'Calibration started' : '√âtalonnage d√©marr√©'), icon: 'üîß', color: 'indigo' },
                      device.report_completed_at && { date: device.report_completed_at, label: lang === 'en' ? 'Report completed' : 'Rapport compl√©t√©', icon: 'üìã', color: 'blue' },
                      device.qc_completed_at && { date: device.qc_completed_at, label: lang === 'en' ? 'QC passed - Ready to ship' : 'QC valid√© - Pr√™t √† exp√©dier', icon: '‚úÖ', color: 'purple' },
                      device.qc_rejected_at && { date: device.qc_rejected_at, label: (lang === 'en' ? 'QC rejected' : 'QC rejet√©'), icon: '‚ùå', color: 'red' },
                      device.shipped_at && { date: device.shipped_at, label: lang === 'en' ? 'Shipped' : 'Exp√©di√©', icon: 'üöö', color: 'green' }
                    ].filter(Boolean).sort((a, b) => new Date(a.date) - new Date(b.date)).map((event, idx) => (
                      <div key={idx} className="relative pl-10">
                        <div className={`absolute left-2 w-5 h-5 rounded-full border-2 border-white shadow flex items-center justify-center text-xs ${
                          event.color === 'green' ? 'bg-green-500' :
                          event.color === 'blue' ? 'bg-blue-500' :
                          event.color === 'indigo' ? 'bg-indigo-500' :
                          event.color === 'purple' ? 'bg-purple-500' :
                          event.color === 'cyan' ? 'bg-cyan-500' :
                          event.color === 'amber' ? 'bg-amber-500' :
                          event.color === 'red' ? 'bg-red-500' :
                          'bg-gray-400'
                        }`}>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="font-medium text-gray-800">{event.icon} {event.label}</p>
                          <p className="text-sm text-gray-500">
                            {new Date(event.date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
            
            {/* Documents Tab */}
            {deviceTab === 'documents' && (
              <div className="space-y-4">
                <h3 className="font-bold text-gray-800">{lang === 'en' ? 'üìÅ Documents' : 'üìÅ Documents'}</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  {/* === 1. DEVIS (QUOTE) === */}
                  {rma.quote_url && (
                    <div className="flex items-center gap-2 p-4 border rounded-lg hover:bg-blue-50 transition-colors">
                      <a href={rma.quote_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üí∞</div>
                        <div>
                          <p className="font-medium text-gray-800">
                            Devis{rma.quote_revision_count > 0 ? ` Rev-${rma.quote_revision_count}` : ''} (actuel)
                          </p>
                          <p className="text-sm text-blue-600">{rma.quote_number ? `N¬∞ ${rma.quote_number}` : rma.request_number}</p>
                        </div>
                      </a>
                      <button onClick={() => setMainDocToArchive({ label: 'Devis', url: rma.quote_url, table: 'service_requests', field: 'quote_url', id: rma.id })} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive & replace' : 'Archiver & remplacer'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  )}
                  
                  {/* === 1b. ARCHIVED QUOTE REVISIONS (admin-only) === */}
                  {attachments.filter(a => a.category === 'internal_devis_revision' && a.file_url && !a.archived_at).map(att => (
                    <a key={att.id} href={att.file_url} target="_blank" rel="noopener noreferrer"
                       className="flex items-center gap-4 p-4 border rounded-lg hover:bg-gray-50 transition-colors border-gray-200 opacity-75">
                      <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-2xl">üìÇ</div>
                      <div>
                        <p className="font-medium text-gray-600">{att.file_name || (lang === 'en' ? 'Previous Quote' : 'Ancien Devis')}</p>
                        <p className="text-xs text-gray-400">{att.notes || (lang === 'en' ? 'Archived' : 'Archiv√©')} ‚Ä¢ üîí Admin uniquement</p>
                      </div>
                    </a>
                  ))}
                  
                  {/* === 2. DEVIS SIGN√â / BON DE COMMANDE (signed quote = BC) === */}
                  {rma.signed_quote_url && (
                    <div className="flex items-center gap-2 p-4 border rounded-lg hover:bg-green-50 transition-colors border-green-200">
                      <a href={rma.signed_quote_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl shrink-0">‚úÖ</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Signed Quote / PO' : 'Devis Sign√© / BC'}</p>
                          <p className="text-sm text-green-600">{rma.bc_number ? `N¬∞ ${rma.bc_number}` : (lang === 'en' ? 'Signed' : 'Sign√©')}</p>
                        </div>
                      </a>
                      <button onClick={() => setMainDocToArchive({ label: 'Devis Sign√© / BC', url: rma.signed_quote_url, table: 'service_requests', field: 'signed_quote_url', id: rma.id })} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive & replace' : 'Archiver & remplacer'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  )}
                  {/* Also show devis_signe from attachments if no signed_quote_url */}
                  {!rma.signed_quote_url && attachments.filter(a => a.category === 'devis_signe' && a.file_url && !a.archived_at).map(att => (
                    <a key={att.id} href={att.file_url} target="_blank" rel="noopener noreferrer"
                       className="flex items-center gap-4 p-4 border rounded-lg hover:bg-green-50 transition-colors border-green-200">
                      <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">‚úÖ</div>
                      <div>
                        <p className="font-medium text-gray-800">{lang === 'en' ? 'Signed Quote / PO' : 'Devis Sign√© / BC'}</p>
                        <p className="text-sm text-green-600">{rma.bc_number ? `N¬∞ ${rma.bc_number}` : (lang === 'en' ? 'Signed' : 'Sign√©')}</p>
                      </div>
                    </a>
                  ))}
                  
                  {/* === 3. BON DE COMMANDE (BC file uploaded separately by customer) === */}
                  {/* Show from bc_file_url if different from signed_quote_url */}
                  {rma.bc_file_url && rma.bc_file_url !== rma.signed_quote_url && (
                    <div className="flex items-center gap-2 p-4 border rounded-lg hover:bg-purple-50 transition-colors border-purple-200">
                      <a href={rma.bc_file_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìù</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Client Purchase Order' : 'Bon de Commande Client'}</p>
                          <p className="text-sm text-purple-600">{rma.bc_number ? `N¬∞ ${rma.bc_number}` : 'BC client'}</p>
                        </div>
                      </a>
                      <button onClick={() => setMainDocToArchive({ label: 'Bon de Commande', url: rma.bc_file_url, table: 'service_requests', field: 'bc_file_url', id: rma.id })} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive & replace' : 'Archiver & remplacer'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  )}
                  {/* Also show bon_commande from attachments if no bc_file_url or it was overwritten */}
                  {(!rma.bc_file_url || rma.bc_file_url === rma.signed_quote_url) && attachments.filter(a => a.category === 'bon_commande' && a.file_url && !a.archived_at).map(att => (
                    <a key={att.id} href={att.file_url} target="_blank" rel="noopener noreferrer"
                       className="flex items-center gap-4 p-4 border rounded-lg hover:bg-purple-50 transition-colors border-purple-200">
                      <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl">üìù</div>
                      <div>
                        <p className="font-medium text-gray-800">{lang === 'en' ? 'Client Purchase Order' : 'Bon de Commande Client'}</p>
                        <p className="text-sm text-purple-600">{rma.bc_number ? `N¬∞ ${rma.bc_number}` : att.file_name}</p>
                      </div>
                    </a>
                  ))}
                  
                  {/* === 4. RAPPORT DE SERVICE === */}
                  {device.report_url && (
                    <div className="flex items-center gap-2 p-4 border rounded-lg hover:bg-blue-50 transition-colors group">
                      <a href={device.report_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìã</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Service Report' : 'Rapport de Service'}</p>
                          <p className="text-sm text-blue-600">{device.serial_number}</p>
                        </div>
                      </a>
                      <button onClick={() => setMainDocToArchive({ label: 'Rapport de Service', url: device.report_url, table: 'request_devices', field: 'report_url', id: device.id })} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive & replace' : 'Archiver & remplacer'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  )}
                  
                  {/* === 5. BON DE LIVRAISON === */}
                  {device.bl_url && (
                    <div className="flex items-center gap-2 p-4 border rounded-lg hover:bg-cyan-50 transition-colors group">
                      <a href={device.bl_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìÑ</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Delivery Note' : 'Bon de Livraison'}</p>
                          <p className="text-sm text-cyan-600">{device.bl_number ? `N¬∞ ${device.bl_number}` : 'BL'}</p>
                        </div>
                      </a>
                      <button onClick={() => setMainDocToArchive({ label: 'Bon de Livraison', url: device.bl_url, table: 'request_devices', field: 'bl_url', id: device.id })} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive & replace' : 'Archiver & remplacer'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  )}
                  
                  {/* === 6. UPS LABEL === */}
                  {device.ups_label_url && (
                    <div className="flex items-center gap-2 p-4 border rounded-lg hover:bg-amber-50 transition-colors group">
                      <a href={device.ups_label_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üè∑Ô∏è</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'UPS Label' : '√âtiquette UPS'}</p>
                          <p className="text-sm text-amber-600">{device.tracking_number || (lang === 'en' ? 'Shipping label' : "Label d'exp√©dition")}</p>
                        </div>
                      </a>
                      <button onClick={() => setMainDocToArchive({ label: '√âtiquette UPS', url: device.ups_label_url, table: 'request_devices', field: 'ups_label_url', id: device.id })} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive & replace' : 'Archiver & remplacer'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  )}
                  
                  {/* === 7. CALIBRATION CERTIFICATE === */}
                  {device.calibration_certificate_url && (
                    <div className="flex items-center gap-2 p-4 border rounded-lg hover:bg-green-50 transition-colors border-green-300 group">
                      <a href={device.calibration_certificate_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üèÜ</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Calibration Certificate' : "Certificat d'√âtalonnage"}</p>
                          <p className="text-sm text-green-600">{device.certificate_number || device.serial_number}</p>
                        </div>
                      </a>
                      <button onClick={() => setMainDocToArchive({ label: "Certificat d'√âtalonnage", url: device.calibration_certificate_url, table: 'request_devices', field: 'calibration_certificate_url', id: device.id })} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive & replace' : 'Archiver & remplacer'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  )}
                  
                  {/* === 8. SUPPL√âMENT (not signed yet) === */}
                  {attachments.filter(a => a.category === 'avenant_quote' && a.file_url && !a.archived_at).map(att => (
                    <div key={att.id} className="flex items-center gap-2 p-4 border rounded-lg hover:bg-green-50 transition-colors border-green-300">
                      <a href={att.file_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìÑ</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Supplement' : 'Suppl√©ment'}</p>
                          <p className="text-sm text-green-600">{rma.supplement_number ? `N¬∞ ${rma.supplement_number}` : `‚Ç¨${(rma.avenant_total || 0).toFixed(2)}`}</p>
                        </div>
                      </a>
                      <button onClick={() => setDocToDelete(att)} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive' : 'Archiver'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  ))}
                  
                  {/* === 9. SUPPL√âMENT SIGN√â (from supplement_signed_quote_url or avenant_signe attachment) === */}
                  {rma.supplement_signed_quote_url && (
                    <div className="flex items-center gap-2 p-4 border rounded-lg hover:bg-green-50 transition-colors border-green-300">
                      <a href={rma.supplement_signed_quote_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl shrink-0">‚úÖ</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Signed Supplement / PO' : 'Suppl√©ment Sign√© / BC'}</p>
                          <p className="text-sm text-green-600">{rma.supplement_bc_number ? `N¬∞ ${rma.supplement_bc_number}` : (rma.supplement_number ? `N¬∞ ${rma.supplement_number}` : (lang === 'en' ? 'Approved' : 'Approuv√©'))}</p>
                        </div>
                      </a>
                      <button onClick={() => setMainDocToArchive({ label: 'Suppl√©ment Sign√© / BC', url: rma.supplement_signed_quote_url, table: 'service_requests', field: 'supplement_signed_quote_url', id: rma.id })} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive & replace' : 'Archiver & remplacer'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  )}
                  {/* Fallback to attachment if no URL field */}
                  {!rma.supplement_signed_quote_url && attachments.filter(a => a.category === 'avenant_signe' && a.file_url && !a.archived_at).map(att => (
                    <div key={att.id} className="flex items-center gap-2 p-4 border rounded-lg hover:bg-green-50 transition-colors border-green-300">
                      <a href={att.file_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl shrink-0">‚úÖ</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Signed Supplement / PO' : 'Suppl√©ment Sign√© / BC'}</p>
                          <p className="text-sm text-green-600">{rma.supplement_bc_number ? `N¬∞ ${rma.supplement_bc_number}` : (rma.supplement_number ? `N¬∞ ${rma.supplement_number}` : (lang === 'en' ? 'Approved' : 'Approuv√©'))}</p>
                        </div>
                      </a>
                      <button onClick={() => setDocToDelete(att)} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive' : 'Archiver'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  ))}
                  
                  {/* === 10. BC SUPPL√âMENT (customer uploaded BC for supplement, different from signed supplement) === */}
                  {rma.supplement_bc_file_url && rma.supplement_bc_file_url !== rma.supplement_signed_quote_url && (
                    <div className="flex items-center gap-2 p-4 border rounded-lg hover:bg-purple-50 transition-colors border-purple-200">
                      <a href={rma.supplement_bc_file_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìù</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Supplementary PO (Client)' : 'BC Suppl√©ment (Client)'}</p>
                          <p className="text-sm text-purple-600">{rma.supplement_bc_number ? `N¬∞ ${rma.supplement_bc_number}` : 'BC client'}</p>
                        </div>
                      </a>
                      <button onClick={() => setMainDocToArchive({ label: 'BC Suppl√©ment', url: rma.supplement_bc_file_url, table: 'service_requests', field: 'supplement_bc_file_url', id: rma.id })} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive & replace' : 'Archiver & remplacer'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  )}
                  {/* Fallback to attachment */}
                  {!rma.supplement_bc_file_url && attachments.filter(a => a.category === 'avenant_bc' && a.file_url && !a.archived_at).map(att => (
                    <div key={att.id} className="flex items-center gap-2 p-4 border rounded-lg hover:bg-purple-50 transition-colors border-purple-200">
                      <a href={att.file_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 flex-1 min-w-0">
                        <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìù</div>
                        <div>
                          <p className="font-medium text-gray-800">{lang === 'en' ? 'Supplementary PO (Client)' : 'BC Suppl√©ment (Client)'}</p>
                          <p className="text-sm text-purple-600">{rma.supplement_bc_number ? `N¬∞ ${rma.supplement_bc_number}` : att.file_name}</p>
                        </div>
                      </a>
                      <button onClick={() => setDocToDelete(att)} className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-all shrink-0" title={lang === 'en' ? 'Archive' : 'Archiver'}>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                      </button>
                    </div>
                  ))}
                </div>
                
                {/* === ADDITIONAL ATTACHMENTS (uploaded manually by admin) === */}
                {attachments.filter(a => 
                  !['avenant_quote', 'avenant_signe', 'avenant_bc', 'bon_commande', 'devis_signe'].includes(a.category) &&
                  !['avenant_quote', 'avenant_signe', 'avenant_bc', 'bon_commande', 'devis_signe'].includes(a.category?.replace('internal_', '')) &&
                  a.category !== 'internal_devis_revision' &&
                  a.category !== 'internal_archived' &&
                  !['ups_label', 'bl', 'archived'].includes(a.file_type) &&
                  !a.archived_at &&
                  a.file_url
                ).length > 0 && (
                  <div className="mt-4">
                    <h4 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2">{lang === 'en' ? 'Additional Documents' : 'Documents suppl√©mentaires'}</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      {attachments.filter(a => 
                        !['avenant_quote', 'avenant_signe', 'avenant_bc', 'bon_commande', 'devis_signe'].includes(a.category) &&
                        !['avenant_quote', 'avenant_signe', 'avenant_bc', 'bon_commande', 'devis_signe'].includes(a.category?.replace('internal_', '')) &&
                        a.category !== 'internal_devis_revision' &&
                        a.category !== 'internal_archived' &&
                        !['ups_label', 'bl', 'archived'].includes(a.file_type) &&
                        !a.archived_at &&
                        a.file_url
                      ).map(doc => {
                        const isInternal = doc.category?.startsWith('internal_');
                        const isImage = doc.file_type?.startsWith('image/');
                        return (
                          <div key={doc.id} className={`flex items-center gap-3 p-3 border rounded-lg ${isInternal ? 'bg-gray-50 border-gray-300 border-dashed' : 'bg-white'}`}>
                            <a href={doc.file_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 flex-1 min-w-0 hover:opacity-80">
                              {isImage ? (
                                <img src={doc.file_url} alt={doc.file_name} className="w-10 h-10 rounded-lg object-cover border border-gray-200" />
                              ) : (
                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-lg ${isInternal ? 'bg-gray-200' : 'bg-blue-100'}`}>
                                  {isInternal ? 'üîí' : 'üìÑ'}
                                </div>
                              )}
                              <div className="flex-1 min-w-0">
                                <p className="font-medium text-gray-800 truncate text-sm">{(doc.file_name || 'Document').replace(/Avenant/gi, (lang === 'en' ? 'Supplement' : 'Suppl√©ment'))}</p>
                                <p className="text-xs text-gray-400">
                                  {isInternal ? (lang === 'en' ? 'üîí Internal' : 'üîí Interne') : (lang === 'en' ? 'üëÅÔ∏è Visible to client' : 'üëÅÔ∏è Visible client')} ‚Ä¢ {new Date(doc.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                                </p>
                              </div>
                            </a>
                            <div className="flex items-center gap-1 shrink-0">
                              <button 
                                onClick={() => handleToggleDocVisibility(doc)} 
                                className={`p-1.5 rounded-lg transition-colors ${isInternal ? 'text-gray-400 hover:bg-blue-50 hover:text-blue-600' : 'text-blue-500 hover:bg-gray-100 hover:text-gray-600'}`}
                                title={isInternal ? (lang === 'en' ? 'Make visible to client' : 'Rendre visible au client') : (lang === 'en' ? 'Hide from client' : 'Masquer au client')}
                              >
                                {isInternal ? (
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" /></svg>
                                ) : (
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                )}
                              </button>
                              <button 
                                onClick={() => setDocToDelete(doc)} 
                                className="p-1.5 rounded-lg text-gray-400 hover:bg-amber-50 hover:text-amber-600 transition-colors"
                                title={lang === "en" ? "Archive & remove" : "Archiver & retirer"}
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
                
                {/* === ARCHIVED DOCUMENTS === */}
                {(() => {
                  const archivedDocs = attachments.filter(a => a.archived_at || a.category === 'internal_archived');
                  if (archivedDocs.length === 0) return null;
                  return (
                    <div className="mt-4">
                      <button 
                        onClick={() => setShowArchivedDocs(!showArchivedDocs)}
                        className="flex items-center gap-2 text-sm text-gray-400 hover:text-gray-600 transition-colors"
                      >
                        <svg className={`w-3 h-3 transition-transform ${showArchivedDocs ? 'rotate-90' : ''}`} fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
                        </svg>
                        üì¶ {lang === 'en' ? `Archives (${archivedDocs.length})` : `Archives (${archivedDocs.length})`}
                      </button>
                      {showArchivedDocs && (
                        <div className="mt-2 space-y-2">
                          {archivedDocs.map(doc => (
                            <div key={doc.id} className="flex items-center gap-3 p-3 border border-dashed border-gray-300 rounded-lg bg-gray-50/50">
                              <div className="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center text-sm">üì¶</div>
                              <a href={doc.file_url} target="_blank" rel="noopener noreferrer" className="flex-1 min-w-0 hover:opacity-80">
                                <p className="text-sm font-medium text-gray-500 truncate">{(doc.file_name || 'Document').replace('[Archiv√©] ', '')}</p>
                                <p className="text-xs text-gray-400">
                                  {lang === 'en' ? 'Archived' : 'Archiv√©'} {doc.archived_at ? new Date(doc.archived_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : ''}
                                  {doc.notes ? ` ‚Ä¢ ${doc.notes}` : ''}
                                </p>
                              </a>
                              <button 
                                onClick={() => unarchiveDoc(doc)}
                                className="px-3 py-1.5 text-xs font-medium text-amber-700 bg-amber-50 border border-amber-200 rounded-lg hover:bg-amber-100 transition-colors shrink-0"
                              >
                                ‚Ü© {lang === 'en' ? 'Restore' : 'Restaurer'}
                              </button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })()}
                
                {/* Add Document Button */}
                <div className="mt-4 pt-4 border-t border-gray-200">
                  <button 
                    onClick={() => setShowDocUploadModal(true)}
                    className="flex items-center gap-2 px-4 py-2.5 bg-[#2D5A7B] text-white rounded-lg hover:bg-[#2a4f7f] transition-colors font-medium text-sm"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                    </svg>
                    Ajouter un document
                  </button>
                </div>
                
                {/* Archive Confirmation Modal */}
                {docToDelete && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl max-w-sm w-full p-6">
                      <h3 className="text-lg font-bold text-gray-800 mb-2">{lang === 'en' ? 'Archive this document?' : 'Archiver ce document ?'}</h3>
                      <p className="text-gray-600 text-sm mb-1">{docToDelete.file_name}</p>
                      <p className="text-amber-600 text-xs mb-4">{lang === 'en' ? 'The document will be hidden but preserved in the archive.' : 'Le document sera masqu√© mais conserv√© dans les archives.'}</p>
                      <div className="flex gap-3">
                        <button onClick={() => setDocToDelete(null)} className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                          {lang === 'en' ? 'Cancel' : 'Annuler'}
                        </button>
                        <button onClick={() => handleDocDelete(docToDelete.id)} className="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                          üì¶ {lang === 'en' ? 'Archive' : 'Archiver'}
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Main Document Archive Confirmation Modal */}
                {mainDocToArchive && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl max-w-sm w-full p-6">
                      <h3 className="text-lg font-bold text-gray-800 mb-2">{lang === 'en' ? 'Archive this document?' : 'Archiver ce document ?'}</h3>
                      <p className="text-gray-600 text-sm mb-1 font-medium">{mainDocToArchive.label}</p>
                      <p className="text-amber-600 text-xs mb-4">{lang === 'en' ? 'The document will be archived (preserved but removed from the client view). You can then upload a replacement.' : 'Le document sera archiv√© (conserv√© mais retir√© de la vue client). Vous pourrez ensuite t√©l√©charger un remplacement.'}</p>
                      <div className="flex gap-3">
                        <button onClick={() => setMainDocToArchive(null)} className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                          {lang === 'en' ? 'Cancel' : 'Annuler'}
                        </button>
                        <button onClick={() => archiveMainDoc(mainDocToArchive)} className="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                          üì¶ {lang === 'en' ? 'Archive & Remove' : 'Archiver & Retirer'}
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Upload Document Modal */}
                {showDocUploadModal && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl max-w-md w-full">
                      <div className="p-6 border-b border-gray-200">
                        <div className="flex justify-between items-center">
                          <h2 className="text-lg font-bold text-[#2D5A7B]">{lang === 'en' ? 'üìÑ Add a document' : 'üìÑ Ajouter un document'}</h2>
                          <button onClick={() => { setShowDocUploadModal(false); setDocUploadFile(null); setDocUploadName(''); }} className="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                        </div>
                      </div>
                      <div className="p-6 space-y-4">
                        {/* File selector */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'File' : 'Fichier'}</label>
                          <input 
                            type="file" 
                            onChange={(e) => {
                              const f = e.target.files?.[0];
                              if (f) {
                                setDocUploadFile(f);
                                if (!docUploadName) setDocUploadName(f.name);
                              }
                            }}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                          />
                        </div>
                        
                        {/* Display name */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Display name' : 'Nom affich√©'}</label>
                          <input 
                            type="text"
                            value={docUploadName}
                            onChange={(e) => setDocUploadName(e.target.value)}
                            placeholder={lang === 'en' ? 'Document name...' : 'Nom du document...'}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          />
                        </div>
                        
                        {/* Category */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">{t('type')}</label>
                          <select 
                            value={docUploadCategory}
                            onChange={(e) => setDocUploadCategory(e.target.value)}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          >
                            <option value="general">{lang === 'en' ? 'üìÑ General Document' : 'üìÑ Document g√©n√©ral'}</option>
                            <option value="rapport">{lang === 'en' ? 'üìã Report' : 'üìã Rapport'}</option>
                            <option value="certificat">{lang === 'en' ? 'üèÜ Certificate' : 'üèÜ Certificat'}</option>
                            <option value="bon_livraison">{lang === 'en' ? 'üì¶ Delivery Note' : 'üì¶ Bon de livraison'}</option>
                            <option value="facture">{lang === 'en' ? 'üìã Invoice' : 'üìã Facture'}</option>
                            <option value="note_technique">{lang === 'en' ? 'üîß Technical Note' : 'üîß Note technique'}</option>
                            <option value="correspondance">{lang === 'en' ? '‚úâÔ∏è Correspondence' : '‚úâÔ∏è Correspondance'}</option>
                          </select>
                        </div>
                        
                        {/* Visibility toggle */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                          <div>
                            <p className="font-medium text-sm text-gray-800">
                              {docUploadShared ? (lang === 'en' ? 'üëÅÔ∏è Visible to client' : 'üëÅÔ∏è Visible au client') : (lang === 'en' ? 'üîí Internal document' : 'üîí Document interne')}
                            </p>
                            <p className="text-xs text-gray-500">
                              {docUploadShared ? (lang === 'en' ? 'Client will be able to see this document' : 'Le client pourra voir ce document') : (lang === 'en' ? 'Only admins will see this document' : 'Seuls les admins verront ce document')}
                            </p>
                          </div>
                          <button 
                            onClick={() => setDocUploadShared(!docUploadShared)}
                            className={`relative w-12 h-6 rounded-full transition-colors ${docUploadShared ? 'bg-blue-500' : 'bg-gray-300'}`}
                          >
                            <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${docUploadShared ? 'translate-x-6' : 'translate-x-0.5'}`} />
                          </button>
                        </div>
                      </div>
                      <div className="p-6 border-t border-gray-200 flex gap-3">
                        <button 
                          onClick={() => { setShowDocUploadModal(false); setDocUploadFile(null); setDocUploadName(''); }}
                          className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium"
                        >
                          Annuler
                        </button>
                        <button 
                          onClick={handleDocUpload}
                          disabled={!docUploadFile || docUploading}
                          className="flex-1 px-4 py-2 bg-[#2D5A7B] text-white rounded-lg hover:bg-[#2a4f7f] font-medium disabled:opacity-50"
                        >
                          {docUploading ? (lang === 'en' ? '‚è≥ Uploading...' : '‚è≥ Envoi...') : (lang === 'en' ? 'üì§ Add' : 'üì§ Ajouter')}
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* No documents message */}
                {!device.calibration_certificate_url && !device.report_url && !rma.quote_url && !rma.bc_file_url && !rma.signed_quote_url && !device.bl_url && !device.ups_label_url && attachments.filter(a => a.file_url).length === 0 && (
                  <p className="text-gray-400 text-center py-8">{lang === 'en' ? 'No documents available' : 'Aucun document disponible'}</p>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // ========== RMA OVERVIEW VIEW (Default) ==========
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={onBack} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 font-medium">
            ‚Üê Tableau de Bord
          </button>
          <div>
            <div className="flex items-center gap-3">
              <h1 className="text-2xl font-bold text-gray-800">{rma.request_number}</h1>
              <span className={`px-3 py-1.5 rounded-full text-sm font-bold ${
                isRMAClosed ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'
              }`}>
                {isRMAClosed ? (lang === 'en' ? '‚úÖ COMPLETED' : '‚úÖ TERMIN√â') : (lang === 'en' ? 'üîÑ OPEN' : 'üîÑ OUVERT')}
              </span>
              {isContractRMA && (
                <span className="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold">{lang === 'en' ? 'üìã CONTRACT' : 'üìã CONTRAT'}</span>
              )}
            </div>
            <p className="text-gray-500">{lang === 'en' ? 'Created on' : 'Cr√©√© le'} {new Date(rma.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
          </div>
        </div>
        
        {/* Hidden shipping options - top right */}
        {!isRMAClosed && devices.some(d => d.status !== 'shipped') && (
          <div className="relative group">
            <button className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" title={lang === 'en' ? 'Advanced options' : 'Options avanc√©es'}>
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </button>
            <div className="absolute right-0 top-full mt-1 w-56 bg-white rounded-lg shadow-lg border opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
              <button
                onClick={() => setShowShippingModal(true)}
                className="w-full px-4 py-2.5 text-left text-sm text-gray-700 hover:bg-gray-50 rounded-t-lg flex items-center gap-2"
              >
                üì¶ Exp√©dition partielle
              </button>
              <button
                onClick={() => setShowInternalShipping(true)}
                className="w-full px-4 py-2.5 text-left text-sm text-gray-700 hover:bg-gray-50 rounded-b-lg flex items-center gap-2 border-t"
              >
                üåç Exp√©dition inter-site
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Client Info - Full Details */}
      <div className="bg-white rounded-xl shadow-sm border p-6">
        <h2 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
          <span className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">üè¢</span>
          Informations Client
        </h2>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <p className="text-xs text-gray-500 uppercase tracking-wide">{t('company')}</p>
            <p className="font-bold text-gray-800">{company.name || '‚Äî'}</p>
          </div>
          <div>
            <p className="text-xs text-gray-500 uppercase tracking-wide">{lang === 'en' ? 'Contact' : 'Contact'}</p>
            <p className="font-medium text-gray-700">{company.contact_name || '‚Äî'}</p>
          </div>
          <div>
            <p className="text-xs text-gray-500 uppercase tracking-wide">{t('phone')}</p>
            <p className="font-medium text-gray-700">{company.phone || '‚Äî'}</p>
          </div>
          <div>
            <p className="text-xs text-gray-500 uppercase tracking-wide">{t('email')}</p>
            <p className="font-medium text-gray-700 truncate">{company.email || '‚Äî'}</p>
          </div>
        </div>
        <div className="mt-4 pt-4 border-t">
          <p className="text-xs text-gray-500 uppercase tracking-wide mb-1">{t('address')}</p>
          <p className="text-gray-700">
            {company.address || company.billing_address || '‚Äî'}
            {(company.postal_code || company.billing_postal_code) && `, ${company.postal_code || company.billing_postal_code}`}
            {(company.city || company.billing_city) && ` ${company.city || company.billing_city}`}
            {company.country && `, ${company.country}`}
          </p>
        </div>
      </div>

      {/* RMA-Level Actions */}
      {!isRMAClosed && (
        <RMAActions lang={lang} 
          rma={rma} 
          devices={devices} 
          notify={notify} 
          reload={reload}
          onOpenShipping={() => setShowShippingModal(true)}
          onOpenAvenant={() => setShowAvenantPreview(true)}
          onStartService={(device) => setShowServiceModal(device)}
          saving={saving}
          setSaving={setSaving}
        />
      )}

      {/* Quote Review Status */}
      {rma.status === 'pending_quote_review' && (
        <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="w-3 h-3 bg-amber-500 rounded-full animate-pulse"></span>
            <span className="font-medium text-amber-800">{lang === 'en' ? 'üìã Quote pending review' : 'üìã Devis en attente de v√©rification'}</span>
          </div>
          <span className="text-sm text-amber-600">{lang === 'en' ? 'Awaiting approval from reviewer' : 'En attente d\'approbation'}</span>
        </div>
      )}
      {rma.quote_rejection_notes && rma.status === 'rma_created' && (
        <div className="bg-red-50 border-2 border-red-300 rounded-xl p-4">
          <div className="flex items-center gap-3 mb-2">
            <span className="text-lg">‚úèÔ∏è</span>
            <span className="font-bold text-red-800">{lang === 'en' ? 'Admin requested modification ‚Äî correct and resubmit' : 'Modification demand√©e par l\'admin ‚Äî corriger et resoumettre'}</span>
          </div>
          <div className="ml-9 bg-white rounded-lg p-3 border border-red-200">
            <p className="text-red-700">{rma.quote_rejection_notes}</p>
          </div>
        </div>
      )}

      {/* Supplement Correction Alert */}
      {rma.supplement_review_status === 'corrections_needed' && (
        <div className="bg-amber-50 border-2 border-amber-400 rounded-xl p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-3">
              <span className="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center text-xl">‚úèÔ∏è</span>
              <div>
                <span className="font-bold text-amber-900 text-lg">{lang === 'en' ? 'Supplement needs correction' : 'Le suppl√©ment n√©cessite une correction'}</span>
                <p className="text-sm text-amber-700">{lang === 'en' ? 'The reviewer has requested changes ‚Äî click a device below to fix' : 'Le v√©rificateur a demand√© des modifications ‚Äî cliquez sur un appareil ci-dessous pour corriger'}</p>
              </div>
            </div>
          </div>
          <div className="space-y-2 ml-13">
            {devices.filter(d => d.supplement_rejection_notes).map(d => (
              <div key={d.id} className="bg-white rounded-lg p-3 border border-amber-300 flex items-center justify-between">
                <div className="flex items-center gap-3 flex-1 min-w-0">
                  {getDeviceImageUrl(d.model_name) && <img src={getDeviceImageUrl(d.model_name)} alt="" className="w-6 h-6 object-contain" />}
                  <div className="min-w-0">
                    <span className="font-bold text-sm text-[#1a1a2e]">{d.model_name}</span>
                    <span className="font-mono text-xs text-gray-500 ml-2">({d.serial_number})</span>
                    <p className="text-sm text-amber-800 truncate">{d.supplement_rejection_notes}</p>
                    {d.supplement_rejection_by && <p className="text-xs text-amber-500">‚Äî {d.supplement_rejection_by}</p>}
                  </div>
                </div>
                <button
                  onClick={() => setShowServiceModal(d)}
                  className="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-medium whitespace-nowrap ml-3"
                >
                  üîß {lang === 'en' ? 'Fix' : 'Corriger'}
                </button>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Chat Status Indicator - Link to Messages Sheet */}
      {rma.chat_status === 'open' && (
        <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="w-3 h-3 bg-amber-500 rounded-full animate-pulse"></span>
            <span className="font-medium text-amber-800">{lang === 'en' ? 'üí¨ Open chat with client' : 'üí¨ Chat ouvert avec le client'}</span>
          </div>
          <span className="text-sm text-amber-600">{lang === 'en' ? "See Messages tab to reply" : "Voir l'onglet Messages pour r√©pondre"}</span>
        </div>
      )}

      {/* Devices List */}
      <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
        <div className="px-6 py-4 border-b bg-gray-50">
          <div className="flex items-center gap-3">
            <span className="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">üîß</span>
            <div>
              <h2 className="font-bold text-gray-800">{t('devices')}</h2>
              <p className="text-sm text-gray-500">{devices.length} {lang === 'en' ? 'device(s) ‚Ä¢ Click to view details' : 'appareil(s) ‚Ä¢ Cliquez pour voir les d√©tails'}</p>
            </div>
            <div className="ml-auto flex gap-2">
              <button
                onClick={(e) => { e.stopPropagation(); printDeviceLabels(devices, rma, lang); }}
                className="px-3 py-1.5 text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium flex items-center gap-1"
                title={lang === 'en' ? 'Print all labels' : 'Imprimer toutes les √©tiquettes'}
              >
                üè∑Ô∏è {lang === 'en' ? 'Print Labels' : '√âtiquettes'} ({devices.length})
              </button>
            </div>
          </div>
        </div>
        
        {/* Inspection Progress & Supplement Readiness Banner */}
        {(() => {
          const withWork = devices.filter(d => d.additional_work_needed);
          const inspectedWork = withWork.filter(d => d.inspection_completed_at || d.report_complete).length;
          const totalWithWork = withWork.length;
          const allWorkInspected = totalWithWork > 0 && inspectedWork >= totalWithWork;
          const supplementPendingReview = rma.supplement_review_status === 'pending';
          const supplementNeedsCorrection = rma.supplement_review_status === 'corrections_needed' || withWork.some(d => d.supplement_rejection_notes);
          const supplementNeeded = totalWithWork > 0 && !rma.avenant_sent_at && !supplementPendingReview && !supplementNeedsCorrection;
          const supplementSent = !!rma.avenant_sent_at && !rma.avenant_approved_at;
          const supplementApproved = !!rma.avenant_approved_at;
          
          if (totalWithWork === 0 && !supplementSent && !supplementApproved && !supplementPendingReview) return null;
          
          return (
            <>
            <div className={`mx-4 mt-2 rounded-lg p-3 flex items-center justify-between ${
              supplementApproved ? 'bg-green-50 border border-green-200' :
              supplementSent ? 'bg-purple-50 border border-purple-200' :
              supplementPendingReview ? 'bg-blue-50 border border-blue-200' :
              supplementNeedsCorrection ? 'bg-amber-50 border-2 border-amber-300' :
              allWorkInspected && supplementNeeded ? 'bg-amber-50 border border-amber-300' :
              'bg-blue-50 border border-blue-200'
            }`}>
              <div className="flex items-center gap-3">
                <div className="flex items-center gap-1">
                  {devices.map(d => (
                    <span key={d.id} className={`w-2.5 h-2.5 rounded-full ${
                      d.report_complete ? 'bg-green-500' :
                      d.inspection_completed_at ? (d.additional_work_needed ? 'bg-amber-400' : 'bg-green-400') :
                      d.additional_work_needed ? 'bg-red-300' :
                      'bg-gray-300'
                    }`} title={`${d.serial_number}`} />
                  ))}
                </div>
                <span className="text-sm font-medium">
                  {totalWithWork > 0 && (
                    <span className="text-amber-600">
                      {lang === 'en' 
                        ? `${totalWithWork} device${totalWithWork > 1 ? 's' : ''} need additional work`
                        : `${totalWithWork} appareil${totalWithWork > 1 ? 's' : ''} ‚Äî travaux supp.`}
                      {!allWorkInspected && ` (${inspectedWork}/${totalWithWork} ${lang === 'en' ? 'inspected' : 'inspect√©s'})`}
                    </span>
                  )}
                </span>
              </div>
              <div>
                {supplementApproved && (
                  <span className="text-sm font-medium text-green-700">‚úÖ {lang === 'en' ? 'Supplement approved' : 'Suppl√©ment approuv√©'}</span>
                )}
                {supplementSent && (
                  <span className="text-sm font-medium text-purple-700">‚è≥ {lang === 'en' ? 'Supplement sent ‚Äî awaiting approval' : 'Suppl√©ment envoy√© ‚Äî attente approbation'}</span>
                )}
                {supplementPendingReview && (
                  <span className="text-sm font-medium text-blue-700">üìã {lang === 'en' ? 'Supplement under review' : 'Suppl√©ment en v√©rification'}</span>
                )}
                {supplementNeedsCorrection && !supplementPendingReview && (() => {
                  const deviceToFix = devices.find(d => d.supplement_rejection_notes);
                  return deviceToFix ? (
                    <button
                      onClick={() => setShowServiceModal(deviceToFix)}
                      className="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-medium animate-pulse"
                    >
                      ‚úèÔ∏è {lang === 'en' ? 'Correct Supplement' : 'Corriger Suppl√©ment'} ‚Äî {deviceToFix.model_name} ({deviceToFix.serial_number})
                    </button>
                  ) : (
                    <button
                      onClick={() => setShowAvenantPreview(true)}
                      className="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-medium animate-pulse"
                    >
                      ‚úèÔ∏è {lang === 'en' ? 'Correct Supplement' : 'Corriger Suppl√©ment'}
                    </button>
                  );
                })()}
                {allWorkInspected && supplementNeeded && !supplementNeedsCorrection && !supplementPendingReview && (
                  <button
                    onClick={() => setShowAvenantPreview(true)}
                    className="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-medium"
                  >
                    üìÑ {lang === 'en' ? 'Create Supplement' : 'Cr√©er Suppl√©ment'}
                  </button>
                )}
                {!allWorkInspected && supplementNeeded && (
                  <span className="text-sm text-amber-600">{lang === 'en' ? '‚è≥ Finish inspections to create supplement' : '‚è≥ Terminez les inspections pour cr√©er suppl√©ment'}</span>
                )}
              </div>
            </div>
            
            {/* Per-device supplement correction notes */}
            {devices.some(d => d.supplement_rejection_notes) && (
              <div className="mt-3 space-y-2">
                {devices.filter(d => d.supplement_rejection_notes).map(d => (
                  <div key={d.id} className="bg-white rounded-lg p-2 border border-amber-200 flex items-start gap-2">
                    <span className="text-amber-500">‚úèÔ∏è</span>
                    <div className="flex-1">
                      <span className="font-medium text-sm text-amber-800">{d.model_name} <span className="font-mono text-xs text-gray-500">({d.serial_number})</span></span>
                      <p className="text-sm text-amber-700">{d.supplement_rejection_notes}</p>
                      {d.supplement_rejection_by && <p className="text-xs text-amber-500">‚Äî {d.supplement_rejection_by}</p>}
                    </div>
                  </div>
                ))}
              </div>
            )}
            </>
          );
        })()}
        
        <div className="divide-y">
          {devices.length === 0 ? (
            <p className="text-gray-400 text-center py-8">{lang === 'en' ? 'No devices registered' : 'Aucun appareil enregistr√©'}</p>
          ) : (
            devices.map((device, idx) => (
              <div 
                key={device.id}
                onClick={() => { setSelectedDevice(device); setViewMode('device'); setDeviceTab('details'); }}
                className="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
              >
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-4">
                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-lg font-bold ${
                      device.report_complete ? 'bg-green-100 text-green-600' :
                      device.inspection_completed_at ? (device.additional_work_needed ? 'bg-amber-100 text-amber-600' : 'bg-green-100 text-green-500') :
                      'bg-gray-100 text-gray-400'
                    }`}>
                      {device.report_complete ? '‚úì' : device.inspection_completed_at ? (device.additional_work_needed ? '‚ö†' : '‚úì') : getDeviceImageUrl(device.model_name) ? <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-7 h-7 object-contain" /> : idx + 1}
                    </div>
                    <div>
                      <p className="font-bold text-gray-800">{device.model_name}</p>
                      <p className="text-sm text-gray-500 font-mono">SN: {device.serial_number}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                      device.service_type === 'calibration' ? 'bg-blue-100 text-blue-700' : 
                      device.service_type === 'repair' ? 'bg-orange-100 text-orange-700' :
                      'bg-purple-100 text-purple-700'
                    }`}>
                      {device.service_type === 'calibration' ? (lang === 'en' ? 'üî¨ Calibration' : 'üî¨ √âtalonnage') : 
                       device.service_type === 'repair' ? (lang === 'en' ? 'üîß Repair' : 'üîß R√©paration') : 
                       (lang === 'en' ? 'üî¨üîß Cal. + Rep.' : 'üî¨üîß √âtal. + R√©p.')}
                    </span>
                    <button
                      onClick={(e) => { e.stopPropagation(); printDeviceLabels([device], rma, lang, devices.length); }}
                      className="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded"
                      title={lang === 'en' ? 'Print label' : 'Imprimer √©tiquette'}
                    >üè∑Ô∏è</button>
                    <span className="text-gray-400 text-xl">‚Üí</span>
                  </div>
                </div>
                
                {/* Progress Bar */}
                <DeviceProgressBar device={device} />
                
                {/* Return address line */}
                {deviceAddresses[device.id] && (
                  <div className="mt-2 flex items-center gap-2">
                    <span className="text-xs text-gray-400">{lang === 'en' ? 'üìç Return:' : 'üìç Retour:'}</span>
                    <span className="text-xs text-gray-500">
                      {deviceAddresses[device.id].company_name || deviceAddresses[device.id].label || '‚Äî'}, {deviceAddresses[device.id].postal_code} {deviceAddresses[device.id].city}
                    </span>
                    {device.shipping_address_id && device.shipping_address_id !== rma.shipping_address_id && (
                      <span className="px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-[10px] font-medium">{lang === 'en' ? 'Specific address' : 'Adresse sp√©cifique'}</span>
                    )}
                  </div>
                )}
                
                {/* Supplement correction needed badge */}
                {device.supplement_rejection_notes && (
                  <div className="mt-2 p-2 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2" onClick={e => e.stopPropagation()}>
                    <span className="text-amber-500">‚úèÔ∏è</span>
                    <div className="flex-1 min-w-0">
                      <span className="text-xs font-bold text-amber-800">{lang === 'en' ? 'Correction needed' : 'Correction n√©cessaire'}</span>
                      <p className="text-xs text-amber-700 truncate">{device.supplement_rejection_notes}</p>
                      {device.supplement_rejection_by && <p className="text-[10px] text-amber-400">‚Äî {device.supplement_rejection_by}</p>}
                    </div>
                    <button
                      onClick={(e) => { e.stopPropagation(); setShowServiceModal(device); }}
                      className="px-2 py-1 bg-amber-500 hover:bg-amber-600 text-white rounded text-xs font-medium whitespace-nowrap"
                    >
                      üîß {lang === 'en' ? 'Fix' : 'Corriger'}
                    </button>
                  </div>
                )}
              </div>
            ))
          )}
        </div>
      </div>

      {/* Modals */}
      {showShippingModal && (
        <ShippingModal
          rma={rma}
          devices={devices}
          onClose={() => setShowShippingModal(false)}
          notify={notify}
          reload={reload}
          profile={profile}
          businessSettings={businessSettings}
        />
      )}

      {showInternalShipping && (
        <InternalShippingModal
          rma={rma}
          devices={devices}
          onClose={() => setShowInternalShipping(false)}
          notify={notify}
          reload={reload}
          profile={profile}
          businessSettings={businessSettings}
        />
      )}

      {showAvenantPreview && (
        <AvenantPreviewModal
          rma={rma}
          devices={devices.filter(d => d.additional_work_needed)}
          onClose={() => setShowAvenantPreview(false)}
          notify={notify}
          reload={reload}
          alreadySent={!!rma.avenant_sent_at}
          businessSettings={businessSettings}
          lang={lang}
        />
      )}
    </div>
  );
}

// Device Service Modal - For filling inspection/findings
function DeviceServiceModal({ device, rma, onBack, notify, reload, profile, businessSettings, lang = 'fr', allDevices = [], onNextDevice, onOpenSupplement }) {
  const t = k => k;
  const [findings, setFindings] = useState(device.service_findings || '');
  const [additionalWorkNeeded, setAdditionalWorkNeeded] = useState(device.additional_work_needed || false);
  const [workItems, setWorkItems] = useState(device.additional_work_items || []);
  const [workCompleted, setWorkCompleted] = useState(device.work_completed || '');
  const [saving, setSaving] = useState(false);
  const [showReportPreview, setShowReportPreview] = useState(false);
  const [partsLoading, setPartsLoading] = useState({});
  const [technicianName, setTechnicianName] = useState(device.technician_name || '');
  const [staffMembers, setStaffMembers] = useState([]);
  
  // Lock work items if they were previously saved (have items in DB)
  const [workItemsLocked, setWorkItemsLocked] = useState((device.additional_work_items || []).length > 0);
  
  // Pre-approved quote items - pull from quote_data and allow toggling
  const getQuotedItems = () => {
    const quotedDevices = rma.quote_data?.devices || [];
    const match = quotedDevices.find(qd => 
      (qd.serial || '').trim().toLowerCase() === (device.serial_number || '').trim().toLowerCase()
    );
    if (!match) return [];
    
    const items = [];
    if (match.needsCalibration && match.calibrationPrice > 0) {
      items.push({
        id: 'calibration',
        type: 'calibration',
        description: `√âtalonnage ${match.model || device.model_name || ''} (SN: ${match.serial || device.serial_number})`,
        part_number: match.calPartNumber || '',
        quantity: 1,
        unit_price: parseFloat(match.calibrationPrice) || 0,
        included: true
      });
    }
    if (match.needsNettoyage && match.nettoyagePrice > 0) {
      items.push({
        id: 'nettoyage',
        type: 'nettoyage',
        description: `Nettoyage cellule${match.nettoyageCellType ? ' - ' + match.nettoyageCellType : ''}`,
        part_number: match.nettoyagePartNumber || '',
        quantity: 1,
        unit_price: parseFloat(match.nettoyagePrice) || 0,
        included: true
      });
    }
    if (match.needsRepair && match.repairPrice > 0) {
      items.push({
        id: 'repair',
        type: 'repair',
        description: `R√©paration ${match.model || device.model_name || ''} (SN: ${match.serial || device.serial_number})`,
        part_number: match.repairPartNumber || '',
        quantity: 1,
        unit_price: parseFloat(match.repairPrice) || 0,
        included: true
      });
    }
    if (match.additionalParts && match.additionalParts.length > 0) {
      match.additionalParts.forEach((part, i) => {
        items.push({
          id: `part_${i}`,
          type: 'part',
          description: part.description || part.name || '',
          part_number: part.partNumber || part.part_number || '',
          quantity: parseInt(part.quantity) || 1,
          unit_price: parseFloat(part.price || part.unit_price) || 0,
          included: true
        });
      });
    }
    // Contract-covered: mark as included but zero price
    if (match.isContractCovered) {
      items.forEach(item => { item.contract_covered = true; });
    }
    return items;
  };
  
  const [approvedItems, setApprovedItems] = useState(() => {
    // Restore from device if previously saved, otherwise build from quote
    const saved = device.approved_quote_items;
    if (saved && Array.isArray(saved) && saved.length > 0) return saved;
    return getQuotedItems();
  });
  
  const toggleApprovedItem = (itemId) => {
    setApprovedItems(prev => prev.map(item => 
      item.id === itemId ? { ...item, included: !item.included } : item
    ));
  };
  
  const [editingApproved, setEditingApproved] = useState(false);
  
  const updateApprovedItem = (itemId, field, value) => {
    setApprovedItems(prev => prev.map(item => 
      item.id === itemId ? { ...item, [field]: value } : item
    ));
  };
  
  const approvedTotal = approvedItems.filter(i => i.included && !i.contract_covered).reduce((sum, i) => sum + (i.unit_price * i.quantity), 0);
  const removedItems = approvedItems.filter(i => !i.included);
  
  // Report options - initialize from device data, empty string means not selected yet, 'none' means don't show
  const [calType, setCalType] = useState(device.cal_type || '');
  const [receptionResult, setReceptionResult] = useState(device.reception_result || '');
  
  // Certificate upload for calibrations
  const [certificateUrl, setCertificateUrl] = useState(device.calibration_certificate_url || '');
  const [uploadingCert, setUploadingCert] = useState(false);
  
  const isCalibration = device.service_type === 'calibration' || device.service_type === 'both';
  const needsCertificate = isCalibration && !certificateUrl;
  
  const calTypeOptions = [
    { value: 'none', label: lang === 'en' ? 'Do not show' : 'Ne pas afficher' },
    { value: 'ISO 21501-4', label: 'ISO 21501-4' },
    { value: 'Non-ISO', label: 'Non-ISO' },
    { value: 'Bio Collecteur', label: lang === 'en' ? 'Bio Collector' : 'Bio Collecteur' },
    { value: 'Compteur Liquide', label: lang === 'en' ? 'Liquid Counter' : 'Compteur Liquide' },
    { value: 'Sonde de Temp√©rature', label: lang === 'en' ? 'Temperature Probe' : 'Sonde de Temp√©rature' },
    { value: 'Diluteur', label: lang === 'en' ? 'Diluter' : 'Diluteur' }
  ];
  
  const receptionOptions = [
    { value: 'none', label: lang === 'en' ? 'Do not show' : 'Ne pas afficher' },
    { value: 'Conforme', label: lang === 'en' ? 'Compliant' : 'Conforme' },
    { value: 'Non conforme', label: lang === 'en' ? 'Non-compliant' : 'Non conforme' },
    { value: '√Ä v√©rifier', label: lang === 'en' ? 'To Review' : '√Ä v√©rifier' }
  ];
  
  // Load staff members for technician dropdown
  useEffect(() => {
    const loadStaff = async () => {
      const { data } = await supabase.from('profiles').select('id, full_name').order('full_name');
      if (data) setStaffMembers(data.filter(s => s.full_name)); // Only show profiles with names
    };
    loadStaff();
  }, []);
  
  // Upload certificate handler
  const handleCertificateUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    if (file.type !== 'application/pdf') {
      notify(lang === 'en' ? 'Please upload a PDF file' : 'Veuillez t√©l√©charger un fichier PDF', 'error');
      return;
    }
    
    setUploadingCert(true);
    try {
      const fileName = `certificates/${rma.request_number}/${device.serial_number}_${Date.now()}.pdf`;
      const { error: uploadError } = await supabase.storage.from('documents').upload(fileName, file);
      if (uploadError) throw uploadError;
      
      const { data: { publicUrl } } = supabase.storage.from('documents').getPublicUrl(fileName);
      
      // Save to device record
      const { error: updateError } = await supabase.from('request_devices').update({
        calibration_certificate_url: publicUrl,
        calibration_certificate_uploaded_at: new Date().toISOString()
      }).eq('id', device.id);
      
      if (updateError) throw updateError;
      
      setCertificateUrl(publicUrl);
      notify(lang === 'en' ? '‚úì Certificate uploaded' : '‚úì Certificat t√©l√©charg√©');
      reload();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setUploadingCert(false);
  };
  
  const avenantSent = rma.avenant_sent_at;
  const avenantApproved = rma.avenant_approved_at;
  const reportComplete = device.report_complete;
  
  // Service started gate - must click "D√©marrer Service" before editing
  const deviceStarted = !['received', 'in_queue', 'inspection'].includes(device.status);
  const [serviceStarted, setServiceStarted] = useState(deviceStarted);
  
  // Inspection lock ‚Äî after completing inspection, form is locked UNTIL supplement is approved
  const isInspectionDone = !!device.inspection_completed_at;
  const [inspectionLocked, setInspectionLocked] = useState(isInspectionDone && additionalWorkNeeded && !rma.avenant_approved_at);
  
  // Whether the form is editable
  const formLocked = !serviceStarted || inspectionLocked;
  
  const inspectionStats = useMemo(() => {
    const total = allDevices.length;
    const withWork = allDevices.filter(d => d.additional_work_needed);
    const inspectedWithWork = withWork.filter(d => d.inspection_completed_at || d.report_complete).length;
    const totalWithWork = withWork.length;
    const allWorkInspected = totalWithWork > 0 && inspectedWithWork >= totalWithWork;
    return { total, totalWithWork, inspectedWithWork, allWorkInspected };
  }, [allDevices]);
  
  const getDefaultChecklist = () => {
    if (device.service_type === 'calibration') {
      return [
        { id: 'visual_inspection', label: lang === 'en' ? 'Visual inspection performed' : 'Inspection visuelle effectu√©e', checked: false },
        { id: 'cleaning', label: lang === 'en' ? 'Cleaning performed' : 'Nettoyage effectu√©', checked: false },
        { id: 'calibration_performed', label: lang === 'en' ? 'Calibration performed per procedure' : '√âtalonnage r√©alis√© selon proc√©dure', checked: false },
        { id: 'results_within_spec', label: lang === 'en' ? 'Results within specifications' : 'R√©sultats dans les sp√©cifications', checked: false },
        { id: 'certificate_generated', label: lang === 'en' ? 'Calibration certificate generated' : 'Certificat d\'√©talonnage g√©n√©r√©', checked: false },
      ];
    } else {
      return [
        { id: 'visual_inspection', label: lang === 'en' ? 'Visual inspection performed' : 'Inspection visuelle effectu√©e', checked: false },
        { id: 'diagnostic', label: lang === 'en' ? 'Full diagnostic completed' : 'Diagnostic complet r√©alis√©', checked: false },
        { id: 'repair_performed', label: lang === 'en' ? 'Repair performed' : 'R√©paration effectu√©e', checked: false },
        { id: 'parts_replaced', label: lang === 'en' ? 'Parts replaced (if applicable)' : 'Pi√®ces remplac√©es (si applicable)', checked: false },
        { id: 'functional_test', label: lang === 'en' ? 'Functional test OK' : 'Test fonctionnel OK', checked: false },
      ];
    }
  };
  
  const [checklist, setChecklist] = useState(() => {
    const saved = device.work_checklist;
    if (saved && Object.keys(saved).length > 0) {
      return getDefaultChecklist().map(item => ({ ...item, checked: saved[item.id] || false }));
    }
    return getDefaultChecklist();
  });
  
  const toggleChecklistItem = (id) => setChecklist(checklist.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
  
  // Add work item with part number field
  const addWorkItem = () => setWorkItems([...workItems, { id: Date.now(), part_number: '', description: '', quantity: 1, price: 0 }]);
  
  const updateWorkItem = (id, field, value) => setWorkItems(workItems.map(item => item.id === id ? { ...item, [field]: value } : item));
  
  const removeWorkItem = (id) => setWorkItems(workItems.filter(item => item.id !== id));
  
  // Lookup part by part number from existing parts_pricing table
  const lookupPart = async (itemId, partNumber) => {
    if (!partNumber || partNumber.length < 2) return;
    
    setPartsLoading(prev => ({ ...prev, [itemId]: true }));
    try {
      const { data, error } = await supabase
        .from('parts_pricing')
        .select('part_number, description, description_fr, unit_price')
        .ilike('part_number', `%${partNumber}%`)
        .limit(1)
        .single();
      
      if (data && !error) {
        // Use French description if available, otherwise English
        const desc = data.description_fr || data.description || '';
        setWorkItems(prev => prev.map(item => 
          item.id === itemId ? { ...item, description: desc, price: data.unit_price || 0, part_number: data.part_number } : item
        ));
        notify(`‚úì ${data.part_number}: ${desc}`);
      }
    } catch (err) {
      // Part not found - that's okay, user can enter manually
    }
    setPartsLoading(prev => ({ ...prev, [itemId]: false }));
  };
  
  const totalAdditional = workItems.filter(i => !i.warranty).reduce((sum, item) => sum + (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1), 0);
  const canPreviewReport = findings.trim() && workCompleted.trim() && technicianName && calType && receptionResult && (!isCalibration || certificateUrl);
  
  const getValidationMessage = () => {
    const missing = [];
    if (!technicianName) missing.push('Technicien');
    if (!calType) missing.push((lang === 'en' ? 'Calibration performed' : '√âtalonnage effectu√©'));
    if (!receptionResult) missing.push((lang === 'en' ? 'Reception results' : 'R√©sultats √† la r√©ception'));
    if (!findings.trim()) missing.push('Constatations');
    if (!workCompleted.trim()) missing.push((lang === 'en' ? 'Actions performed' : 'Actions effectu√©es'));
    if (isCalibration && !certificateUrl) missing.push(lang === 'en' ? 'Calibration certificate' : 'Certificat d\'√©talonnage');
    return missing.length > 0 ? `Veuillez remplir: ${missing.join(', ')}` : null;
  };
  
  const handlePreviewClick = () => {
    if (canPreviewReport) {
      setShowReportPreview(true);
    } else {
      notify(getValidationMessage(), 'error');
    }
  };
  
  const saveProgress = async () => {
    setSaving(true);
    const checklistObj = {};
    checklist.forEach(item => { checklistObj[item.id] = item.checked; });
    try {
      const updateData = {
        service_findings: findings, additional_work_needed: additionalWorkNeeded,
        additional_work_items: additionalWorkNeeded ? workItems : [],
        approved_quote_items: approvedItems,
        work_completed: workCompleted, work_checklist: checklistObj,
        technician_name: technicianName,
        cal_type: calType,
        reception_result: receptionResult
        // NOTE: supplement_rejection_notes are NOT cleared here ‚Äî they persist until re-submission
      };
      
      const { error } = await supabase.from('request_devices').update(updateData).eq('id', device.id);
      if (error) throw error;
      
      notify(lang === 'en' ? '‚úì Saved' : '‚úì Enregistr√©');
      if (additionalWorkNeeded && workItems.length > 0) {
        setWorkItemsLocked(true);
      }
      await reload();
    } catch (err) { notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error'); }
    setSaving(false);
  };
  
  // Start service ‚Äî gate that must be clicked before editing
  const startService = async () => {
    setSaving(true);
    try {
      const svcType = device.service_type || 'calibration';
      const newStatus = (svcType === 'repair') ? 'repair_in_progress' : 'calibration_in_progress';
      
      const { error } = await supabase.from('request_devices').update({
        status: newStatus,
        service_started_at: new Date().toISOString()
      }).eq('id', device.id);
      if (error) throw error;
      
      // Also update RMA status if needed
      if (['received', 'in_queue'].includes(rma.status)) {
        await supabase.from('service_requests').update({
          status: 'calibration_in_progress',
          updated_at: new Date().toISOString()
        }).eq('id', rma.id);
      }
      
      setServiceStarted(true);
      notify(lang === 'en' ? '‚ñ∂Ô∏è Service started' : '‚ñ∂Ô∏è Service d√©marr√©');
      reload();
    } catch (err) { notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error'); }
    setSaving(false);
  };
  
  const completeInspection = async () => {
    if (!findings) {
      notify(lang === 'en' ? 'Findings are required to complete inspection' : 'Les constats sont requis pour terminer l\'inspection', 'error');
      return;
    }
    setSaving(true);
    const checklistObj = {};
    checklist.forEach(item => { checklistObj[item.id] = item.checked; });
    try {
      const updateData = {
        service_findings: findings, additional_work_needed: additionalWorkNeeded,
        additional_work_items: additionalWorkNeeded ? workItems : [],
        approved_quote_items: approvedItems,
        work_completed: workCompleted, work_checklist: checklistObj,
        technician_name: technicianName,
        cal_type: calType,
        reception_result: receptionResult,
        inspection_completed_at: new Date().toISOString()
      };
      
      const { error } = await supabase.from('request_devices').update(updateData).eq('id', device.id);
      if (error) throw error;
      
      if (additionalWorkNeeded && workItems.length > 0) {
        setWorkItemsLocked(true);
      }
      
      await reload();
      notify(lang === 'en' ? '‚úÖ Inspection complete' : '‚úÖ Inspection termin√©e');
      setInspectionLocked(true);
    } catch (err) { notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error'); }
    setSaving(false);
  };
  
  const unlockInspection = async () => {
    // Clear inspection timestamp so it can be re-done with updated data
    try {
      await supabase.from('request_devices').update({
        inspection_completed_at: null
      }).eq('id', device.id);
      setInspectionLocked(false);
      setWorkItemsLocked(false);
      notify(lang === 'en' ? '‚úèÔ∏è Editing unlocked' : '‚úèÔ∏è √âdition d√©verrouill√©e');
      reload();
    } catch (err) { notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error'); }
  };
  
  const completeReport = async () => {
    setSaving(true);
    const checklistObj = {};
    checklist.forEach(item => { checklistObj[item.id] = item.checked; });
    try {
      // Note: Report PDF is generated when QC approves, not here
      // This allows QC to review before the final PDF is saved

      // Update device status
      const updateData = {
        service_findings: findings, additional_work_needed: additionalWorkNeeded,
        additional_work_items: additionalWorkNeeded ? workItems : [],
        approved_quote_items: approvedItems,
        work_completed: workCompleted, work_checklist: checklistObj,
        technician_name: technicianName,
        cal_type: calType,
        reception_result: receptionResult,
        report_complete: true, report_completed_at: new Date().toISOString(), status: 'final_qc'
      };
      
      const { error } = await supabase.from('request_devices').update(updateData).eq('id', device.id);
      if (error) throw error;
      
      // Check if all devices in this RMA are now in QC or beyond
      const allDevices = rma.request_devices || [];
      const otherDevices = allDevices.filter(d => d.id !== device.id);
      const allOthersInQCOrBeyond = otherDevices.every(d => 
        d.report_complete || d.status === 'final_qc' || d.qc_complete || d.status === 'ready_to_ship'
      );
      
      // If all devices are in QC (including this one we just updated), update RMA status
      if (allOthersInQCOrBeyond) {
        await supabase.from('service_requests').update({
          status: 'final_qc',
          updated_at: new Date().toISOString()
        }).eq('id', rma.id);
      }
      
      notify(lang === 'en' ? '‚úì Report completed ‚Üí QC!' : '‚úì Rapport termin√© ‚Üí QC!');
      reload();
      onBack();
    } catch (err) { notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error'); }
    setSaving(false);
  };

  if (showReportPreview) {
    const allWarranty = workItems.length > 0 && workItems.every(i => i.warranty);
    return <ReportPreviewModal device={device} rma={rma} findings={findings} workCompleted={workCompleted} checklist={checklist} additionalWorkNeeded={additionalWorkNeeded} workItems={workItems} onClose={() => setShowReportPreview(false)} onComplete={completeReport} canComplete={!additionalWorkNeeded || avenantApproved || allWarranty} saving={saving} technicianName={technicianName} calType={calType} receptionResult={receptionResult} lang={lang} />;
  }

  const renderActionButtons = () => {
    // Not started ‚Äî just show start button in header
    if (!serviceStarted) return (
      <button onClick={startService} disabled={saving} className="px-5 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-bold disabled:opacity-50">
        {saving ? '‚è≥...' : (lang === 'en' ? '‚ñ∂Ô∏è Start Service' : '‚ñ∂Ô∏è D√©marrer Service')}
      </button>
    );
    
    const allWarranty = additionalWorkNeeded && workItems.length > 0 && workItems.every(i => i.warranty);
    
    if (reportComplete) return <span className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-medium">{lang === 'en' ? '‚úì Report completed' : '‚úì Rapport termin√©'}</span>;
    
    // Inspection locked ‚Äî show unlock button
    if (inspectionLocked) return (<>
      <span className="px-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-medium">{lang === 'en' ? '‚úÖ Inspection done' : '‚úÖ Inspection termin√©e'}</span>
      <button onClick={unlockInspection} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium">{lang === 'en' ? '‚úèÔ∏è Edit' : '‚úèÔ∏è Modifier'}</button>
      {inspectionStats.allWorkInspected && onOpenSupplement && !avenantSent && !rma.supplement_review_status
        ? <button onClick={onOpenSupplement} className="px-5 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium">{lang === 'en' ? 'üìÑ Create Supplement' : 'üìÑ Cr√©er Suppl√©ment'}</button>
        : !avenantSent && !rma.supplement_review_status && <span className="px-3 py-2 bg-amber-100 text-amber-700 rounded-lg text-sm">{lang === 'en' ? `‚è≥ ${inspectionStats.inspectedWithWork}/${inspectionStats.totalWithWork} inspected` : `‚è≥ ${inspectionStats.inspectedWithWork}/${inspectionStats.totalWithWork} inspect√©s`}</span>
      }
      {rma.supplement_review_status === 'pending' && <span className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium">üìã {lang === 'en' ? 'Supplement under review' : 'Suppl√©ment en v√©rification'}</span>}
      {rma.supplement_review_status === 'corrections_needed' && <span className="px-3 py-2 bg-amber-100 text-amber-700 rounded-lg text-sm font-medium animate-pulse">‚úèÔ∏è {lang === 'en' ? 'Correction needed ‚Äî edit work items below' : 'Correction n√©cessaire ‚Äî modifier les travaux ci-dessous'}</span>}
      {avenantSent && !avenantApproved && <span className="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm">{lang === 'en' ? '‚è≥ Supplement sent' : '‚è≥ Suppl√©ment envoy√©'}</span>}
      {avenantApproved && <button onClick={handlePreviewClick} disabled={!canPreviewReport} className={`px-5 py-2 rounded-lg font-medium ${canPreviewReport ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-200 text-blue-400 cursor-not-allowed'}`}>{lang === 'en' ? 'üìÑ Report ‚Üí' : 'üìÑ Rapport ‚Üí'}</button>}
    </>);
    
    // No additional work ‚Üí normal flow: Save + Report Preview
    if (!additionalWorkNeeded || allWarranty) return (<>
      <button onClick={saveProgress} disabled={saving} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg disabled:opacity-50">{saving ? '...' : lang === 'en' ? 'Save' : 'Enregistrer'}</button>
      <button onClick={handlePreviewClick} disabled={!canPreviewReport} className={`px-6 py-2 rounded-lg font-medium ${canPreviewReport ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-200 text-blue-400 cursor-not-allowed'}`}>{lang === 'en' ? 'üìÑ Report Preview ‚Üí' : 'üìÑ Aper√ßu Rapport ‚Üí'}</button>
    </>);
    
    // Additional work needed, NOT yet inspected ‚Üí Save + Complete Inspection
    if (additionalWorkNeeded && !isInspectionDone) return (<>
      <button onClick={saveProgress} disabled={saving} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg disabled:opacity-50">{saving ? '...' : lang === 'en' ? 'Save' : 'Enregistrer'}</button>
      <button onClick={completeInspection} disabled={saving || !findings} className="px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium disabled:opacity-50">
        {saving ? '...' : (lang === 'en' ? '‚úÖ Complete Inspection' : '‚úÖ Terminer Inspection')}
      </button>
    </>);
    
    // Supplement sent, waiting approval
    if (additionalWorkNeeded && avenantSent && !avenantApproved) return (<>
      <button onClick={saveProgress} disabled={saving} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg disabled:opacity-50">{saving ? '...' : lang === 'en' ? 'Save' : 'Enregistrer'}</button>
      <span className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg">{lang === 'en' ? '‚è≥ Awaiting supplement approval' : '‚è≥ Attente approbation suppl√©ment'}</span>
    </>);
    
    // Supplement under review
    if (additionalWorkNeeded && rma.supplement_review_status === 'pending') return (<>
      <button onClick={saveProgress} disabled={saving} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg disabled:opacity-50">{saving ? '...' : lang === 'en' ? 'Save' : 'Enregistrer'}</button>
      <span className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-medium">üìã {lang === 'en' ? 'Supplement under review' : 'Suppl√©ment en v√©rification'}</span>
    </>);
    
    // Supplement needs correction
    if (additionalWorkNeeded && rma.supplement_review_status === 'corrections_needed') return (<>
      <button onClick={saveProgress} disabled={saving} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg disabled:opacity-50">{saving ? '...' : lang === 'en' ? 'Save' : 'Enregistrer'}</button>
      <span className="px-4 py-2 bg-amber-100 text-amber-700 rounded-lg font-medium animate-pulse">‚úèÔ∏è {lang === 'en' ? 'Correction needed ‚Äî edit work items and re-submit' : 'Correction n√©cessaire ‚Äî modifier et re-soumettre'}</span>
    </>);
    
    // Supplement approved ‚Üí can complete report
    if (additionalWorkNeeded && avenantApproved) return (<>
      <button onClick={saveProgress} disabled={saving} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg disabled:opacity-50">{saving ? '...' : lang === 'en' ? 'Save' : 'Enregistrer'}</button>
      <button onClick={handlePreviewClick} disabled={!canPreviewReport} className={`px-6 py-2 rounded-lg font-medium ${canPreviewReport ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-200 text-blue-400 cursor-not-allowed'}`}>{lang === 'en' ? 'üìÑ Report Preview ‚Üí' : 'üìÑ Aper√ßu Rapport ‚Üí'}</button>
    </>);
    
    return null;
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg text-gray-600">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
          <div><h1 className="text-2xl font-bold text-gray-800 flex items-center gap-3">{getDeviceImageUrl(device.model_name) && <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-8 h-8 object-contain" />}SERVICE - {device.model_name}</h1><p className="text-gray-500">SN: {device.serial_number} ‚Ä¢ RMA: {rma.request_number}</p></div>
        </div>
        <div className="flex items-center gap-3">{renderActionButtons()}</div>
      </div>
      
      {/* Device Progress Strip */}
      {allDevices.length > 1 && (
        <div className="flex items-center gap-1.5 bg-white rounded-lg border p-3">
          <span className="text-xs text-gray-500 mr-2 font-medium">{lang === 'en' ? 'Devices:' : 'Appareils:'}</span>
          {allDevices.map(d => {
            const isCurrent = d.id === device.id;
            const isDone = d.report_complete;
            const isInsp = d.inspection_completed_at;
            const hasWork = d.additional_work_needed;
            return (
              <button
                key={d.id}
                onClick={() => { if (!isCurrent && onNextDevice) onNextDevice(d); }}
                className={`px-2.5 py-1 rounded-md text-xs font-medium transition-colors ${
                  isCurrent ? 'bg-indigo-500 text-white ring-2 ring-indigo-300' :
                  isDone ? 'bg-green-100 text-green-700 hover:bg-green-200' :
                  isInsp ? (hasWork ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' : 'bg-green-100 text-green-500 hover:bg-green-200') :
                  'bg-gray-100 text-gray-500 hover:bg-gray-200'
                }`}
                title={`${d.model_name} (${d.serial_number})`}
              >
                {isDone ? '‚úÖ' : isInsp ? (hasWork ? '‚ö†Ô∏è' : '‚úì') : '‚¨ú'} {d.serial_number?.slice(-6) || d.model_name}
              </button>
            );
          })}
        </div>
      )}

      {additionalWorkNeeded && (() => {
        const allW = workItems.length > 0 && workItems.every(i => i.warranty);
        if (allW) return (
          <div className="rounded-lg p-3 bg-blue-100 border border-blue-300">
            <span className="font-medium text-blue-800">
              üõ°Ô∏è {lang === 'en' ? 'All additional work covered under warranty ‚Äî no supplement needed' : 'Tous les travaux suppl√©mentaires sous garantie ‚Äî pas de suppl√©ment requis'}
            </span>
          </div>
        );
        return (
          <div className={`rounded-lg p-3 ${avenantApproved ? 'bg-green-100 border border-green-300' : avenantSent ? 'bg-purple-100 border border-purple-300' : 'bg-amber-100 border border-amber-300'}`}>
            <span className={`font-medium ${avenantApproved ? 'text-green-800' : avenantSent ? 'text-purple-800' : 'text-amber-800'}`}>
              {avenantApproved ? (lang === 'en' ? '‚úì Supplement approved by client' : '‚úì Suppl√©ment approuv√© par le client') : avenantSent ? (lang === 'en' ? 'üì§ Supplement sent - Awaiting approval' : 'üì§ Suppl√©ment envoy√© - En attente approbation') : (lang === 'en' ? '‚ö†Ô∏è Additional work detected - Supplement required' : '‚ö†Ô∏è Travaux suppl√©mentaires d√©tect√©s - Suppl√©ment requis')}
            </span>
          </div>
        );
      })()}

      {/* Supplement correction notes from reviewer */}
      {device.supplement_rejection_notes && (
        <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4">
          <div className="flex items-center gap-3 mb-2">
            <span className="text-lg">‚úèÔ∏è</span>
            <span className="font-bold text-amber-800">{lang === 'en' ? 'Reviewer requested correction' : 'Le v√©rificateur demande une correction'}</span>
          </div>
          <div className="ml-9 bg-white rounded-lg p-3 border border-amber-200">
            <p className="text-amber-900">{device.supplement_rejection_notes}</p>
          </div>
          {device.supplement_rejection_by && (
            <p className="ml-9 mt-1 text-xs text-amber-500">‚Äî {device.supplement_rejection_by}</p>
          )}
        </div>
      )}

      <div className="grid lg:grid-cols-3 gap-6">
        <div className="space-y-4">
          <div className="bg-white rounded-xl shadow-sm border p-4">
            <h3 className="font-bold text-gray-700 mb-3">{lang === 'en' ? 'Device' : 'Appareil'}</h3>
            <div className="space-y-2">
              <div><p className="text-xs text-gray-500">{lang === 'en' ? 'Model' : 'Mod√®le'}</p><p className="font-bold text-gray-800 flex items-center gap-2">{getDeviceImageUrl(device.model_name) && <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-5 h-5 object-contain" />}{device.model_name}</p></div>
              <div><p className="text-xs text-gray-500">{lang === 'en' ? 'Serial #' : 'N¬∞ s√©rie'}</p><p className="font-medium text-gray-800">{device.serial_number}</p></div>
              <div><p className="text-xs text-gray-500">{lang === 'en' ? 'Service' : 'Service'}</p><p className="font-medium">{device.service_type === 'calibration' ? (lang === 'en' ? 'üî¨ Calibration' : 'üî¨ √âtalonnage') : 'üîß R√©paration'}</p></div>
            </div>
          </div>
          {device.notes && (
            <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4">
              <h3 className="font-bold text-amber-800 mb-2">{lang === 'en' ? 'üìù Client Notes' : 'üìù Notes Client'}</h3>
              <p className="text-amber-900">"{device.notes}"</p>
            </div>
          )}
          <div className="bg-gray-50 rounded-xl border p-4">
            <h3 className="font-bold text-gray-700 mb-2">Client</h3>
            <p className="font-medium text-gray-800">{rma.companies?.name}</p>
          </div>
          
          {/* Report Options Section */}
          <div className={`rounded-xl border p-4 space-y-3 ${serviceStarted && (!technicianName || !calType || !receptionResult) ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200'}`}>
            <h3 className={`font-bold ${serviceStarted && (!technicianName || !calType || !receptionResult) ? 'text-red-800' : 'text-blue-800'}`}>{lang === 'en' ? 'Report Options' : 'Options du Rapport'} {serviceStarted && (!technicianName || !calType || !receptionResult) ? '*' : '‚úì'}</h3>
            
            {/* Technician */}
            <div>
              <label className="text-sm text-gray-600 block mb-1">{lang === 'en' ? 'Service technician *' : 'Technicien(ne) de service *'}</label>
              <select 
                value={technicianName} 
                onChange={e => setTechnicianName(e.target.value)}
                className={`w-full px-3 py-2 border rounded-lg text-sm ${serviceStarted && !technicianName ? 'border-red-300 bg-red-50' : ''}`}
              >
                <option value="">{lang === 'en' ? '‚Äî Select ‚Äî' : '‚Äî S√©lectionner ‚Äî'}</option>
                {staffMembers.map(s => (
                  <option key={s.id} value={s.full_name}>{s.full_name}</option>
                ))}
              </select>
            </div>
            
            {/* Calibration Type */}
            <div>
              <label className="text-sm text-gray-600 block mb-1">{lang === 'en' ? 'Calibration performed *' : '√âtalonnage effectu√© *'}</label>
              <select value={calType} onChange={e => setCalType(e.target.value)} className={`w-full px-3 py-2 border rounded-lg text-sm ${serviceStarted && !calType ? 'border-red-300 bg-red-50' : ''}`}>
                <option value="">{lang === 'en' ? '‚Äî Select ‚Äî' : '‚Äî S√©lectionner ‚Äî'}</option>
                {calTypeOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
              </select>
            </div>
            
            {/* Reception Result */}
            <div>
              <label className="text-sm text-gray-600 block mb-1">{lang === 'en' ? 'Reception results *' : 'R√©sultats √† la r√©ception *'}</label>
              <select value={receptionResult} onChange={e => setReceptionResult(e.target.value)} className={`w-full px-3 py-2 border rounded-lg text-sm ${serviceStarted && !receptionResult ? 'border-red-300 bg-red-50' : ''}`}>
                <option value="">{lang === 'en' ? '‚Äî Select ‚Äî' : '‚Äî S√©lectionner ‚Äî'}</option>
                {receptionOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
              </select>
            </div>
          </div>
          
          {/* Certificate Upload - Only for calibrations */}
          {isCalibration && (
            <div className={`rounded-xl border p-4 ${certificateUrl ? 'bg-green-50 border-green-200' : serviceStarted ? 'bg-red-50 border-red-300' : 'bg-amber-50 border-amber-200'}`}>
              <h3 className={`font-bold mb-2 ${certificateUrl ? 'text-green-800' : serviceStarted ? 'text-red-800' : 'text-amber-800'}`}>
                {lang === 'en' ? 'üìú Calibration Certificate' : "üìú Certificat d'√âtalonnage"} {certificateUrl ? '‚úì' : '*'}
              </h3>
              
              {certificateUrl ? (
                <div className="space-y-2">
                  <p className="text-sm text-green-700">{lang === 'en' ? "Certificate uploaded" : "Certificat t√©l√©charg√©"}</p>
                  <div className="flex gap-2">
                    <a href={certificateUrl} target="_blank" rel="noopener noreferrer" className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
                      üìÑ Voir PDF
                    </a>
                    <label className="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm cursor-pointer">
                      Remplacer
                      <input type="file" accept=".pdf" onChange={handleCertificateUpload} className="hidden" />
                    </label>
                  </div>
                </div>
              ) : (
                <div>
                  <p className="text-sm text-amber-700 mb-2">{lang === 'en' ? 'Required to send to QC' : 'Requis pour envoyer au QC'}</p>
                  <label className={`inline-flex items-center gap-2 px-4 py-2 rounded-lg cursor-pointer ${uploadingCert ? 'bg-gray-300' : 'bg-amber-500 hover:bg-amber-600 text-white'}`}>
                    {uploadingCert ? (lang === 'en' ? '‚è≥ Uploading...' : '‚è≥ T√©l√©chargement...') : (lang === 'en' ? 'üì§ Upload PDF' : 'üì§ T√©l√©charger PDF')}
                    <input type="file" accept=".pdf" onChange={handleCertificateUpload} disabled={uploadingCert} className="hidden" />
                  </label>
                </div>
              )}
            </div>
          )}
        </div>

        <div className="lg:col-span-2 space-y-4 relative">
          {/* Blur overlay on report area when locked */}
          {formLocked && (
            <div className="absolute inset-0 z-10 rounded-xl flex items-start justify-center pt-16" style={{background: 'rgba(255,255,255,0.4)', backdropFilter: 'blur(2px)'}}>
              <div className="bg-white rounded-xl shadow-lg border-2 border-indigo-200 p-5 text-center max-w-sm">
                {!serviceStarted ? (<>
                  <p className="text-lg font-bold text-gray-800 mb-1">{lang === 'en' ? '‚ñ∂Ô∏è Start Service to begin' : '‚ñ∂Ô∏è D√©marrer Service pour commencer'}</p>
                  <p className="text-sm text-gray-500">{lang === 'en' ? 'Click the button above to unlock' : 'Cliquez le bouton ci-dessus pour d√©bloquer'}</p>
                </>) : (<>
                  <p className="text-lg font-bold text-green-700 mb-1">{lang === 'en' ? '‚úÖ Inspection Complete' : '‚úÖ Inspection Termin√©e'}</p>
                  <p className="text-sm text-gray-500">{lang === 'en' ? 'Click Edit above to make changes' : 'Cliquez Modifier ci-dessus pour modifier'}</p>
                </>)}
              </div>
            </div>
          )}
          <div className={formLocked ? 'pointer-events-none select-none' : ''}>
          <div className="bg-white rounded-xl shadow-sm border p-4">
            <div className="flex items-center justify-between mb-2">
              <h3 className="font-bold text-gray-700">{lang === 'en' ? '1. FINDINGS *' : '1. CONSTATATIONS *'}</h3>
              <TechTranslateButton onInsert={(text) => setFindings(prev => prev ? prev + '\n' + text : text)} lang={lang} />
            </div>
            <p className="text-sm text-gray-500 mb-3">{lang === 'en' ? "What you observed (appears on report and supplement)" : "Ce que vous avez observ√© (appara√Æt sur rapport et avenant)"}</p>
            <textarea value={findings} onChange={e => setFindings(e.target.value)} placeholder={lang === 'en' ? 'Ex: Calibration performed per specifications...' : 'Ex: Calibration effectu√©e selon les sp√©cifications...'} className={`w-full px-4 py-3 border rounded-xl h-28 resize-none focus:ring-2 focus:ring-blue-500 ${serviceStarted && !findings ? 'border-red-300 bg-red-50' : ''}`} />
          </div>

          {/* Pre-Approved Quoted Services */}
          {approvedItems.length > 0 && (
            <div className="bg-white rounded-xl shadow-sm border p-4">
              <div className="flex items-center justify-between mb-3">
                <div>
                  <h3 className="font-bold text-gray-800">{lang === 'en' ? '2. Pre-Approved Services' : '2. Services pr√©-approuv√©s'}</h3>
                  <p className="text-sm text-gray-500">{lang === 'en' ? 'Items from the approved quote ‚Äî uncheck if not performed' : 'Articles du devis approuv√© ‚Äî d√©cochez si non r√©alis√©'}</p>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-sm font-bold text-[#00A651]">
                    {approvedItems.filter(i => i.included).length}/{approvedItems.length} {lang === 'en' ? 'active' : 'actifs'}
                  </span>
                  <button
                    onClick={() => setEditingApproved(!editingApproved)}
                    className={`px-3 py-1 rounded-lg text-sm font-medium ${editingApproved ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}
                  >
                    {editingApproved ? (lang === 'en' ? '‚úì Done' : '‚úì Termin√©') : (lang === 'en' ? '‚úèÔ∏è Edit' : '‚úèÔ∏è Modifier')}
                  </button>
                </div>
              </div>
              <div className="space-y-2">
                {approvedItems.map(item => (
                  <div key={item.id} className={`flex items-center gap-3 p-3 rounded-lg border transition-all ${item.included ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200 opacity-60'}`}>
                    <input
                      type="checkbox"
                      checked={item.included}
                      onChange={() => toggleApprovedItem(item.id)}
                      className="w-5 h-5 rounded text-green-600 flex-shrink-0"
                    />
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                          item.type === 'calibration' ? 'bg-blue-100 text-blue-700' :
                          item.type === 'nettoyage' ? 'bg-cyan-100 text-cyan-700' :
                          item.type === 'repair' ? 'bg-orange-100 text-orange-700' :
                          'bg-gray-100 text-gray-700'
                        }`}>
                          {item.type === 'calibration' ? 'üî¨ √âtal.' : item.type === 'nettoyage' ? 'üßπ Nett.' : item.type === 'repair' ? 'üîß R√©p.' : 'üì¶ Pi√®ce'}
                        </span>
                        {editingApproved ? (
                          <input
                            type="text"
                            value={item.description}
                            onChange={e => updateApprovedItem(item.id, 'description', e.target.value)}
                            className="flex-1 px-2 py-1 border rounded text-sm font-medium"
                          />
                        ) : (
                          <span className={`font-medium ${item.included ? 'text-gray-800' : 'text-gray-400 line-through'}`}>{item.description}</span>
                        )}
                      </div>
                      {editingApproved ? (
                        <input
                          type="text"
                          value={item.part_number || ''}
                          onChange={e => updateApprovedItem(item.id, 'part_number', e.target.value)}
                          placeholder={lang === 'en' ? 'Part #' : 'N¬∞ Pi√®ce'}
                          className="text-xs text-gray-400 font-mono mt-1 px-2 py-0.5 border rounded w-40"
                        />
                      ) : (
                        item.part_number && <span className="text-xs text-gray-400 font-mono">{item.part_number}</span>
                      )}
                    </div>
                    <div className="text-right flex-shrink-0">
                      {item.contract_covered ? (
                        <span className="text-sm font-medium text-blue-600">{lang === 'en' ? 'Contract' : 'Contrat'}</span>
                      ) : editingApproved ? (
                        <div className="flex items-center gap-1">
                          {item.quantity > 1 && (
                            <input
                              type="number"
                              value={item.quantity}
                              onChange={e => updateApprovedItem(item.id, 'quantity', parseInt(e.target.value) || 1)}
                              className="w-14 px-1 py-1 border rounded text-sm text-center"
                              min="1"
                            />
                          )}
                          <span className="text-gray-400 text-sm">‚Ç¨</span>
                          <input
                            type="number"
                            value={item.unit_price}
                            onChange={e => updateApprovedItem(item.id, 'unit_price', parseFloat(e.target.value) || 0)}
                            className="w-24 px-2 py-1 border rounded text-sm text-right font-bold"
                            step="0.01"
                          />
                        </div>
                      ) : (
                        <span className={`text-sm font-bold ${item.included ? 'text-green-700' : 'text-gray-400 line-through'}`}>
                          {item.quantity > 1 ? `${item.quantity} √ó ` : ''}‚Ç¨{item.unit_price.toFixed(2)}
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
              {/* Totals */}
              <div className="mt-3 pt-3 border-t flex items-center justify-between">
                <div className="text-sm text-gray-500">
                  {removedItems.length > 0 && (
                    <span className="text-amber-600">
                      ‚ö†Ô∏è {removedItems.length} {lang === 'en' ? 'item(s) removed from quote' : 'article(s) retir√©(s) du devis'}
                    </span>
                  )}
                </div>
                <div className="text-right">
                  <span className="text-sm text-gray-500 mr-2">{lang === 'en' ? 'Quoted total:' : 'Total devis :'}</span>
                  <span className="text-lg font-bold text-[#00A651]">‚Ç¨{approvedTotal.toFixed(2)}</span>
                </div>
              </div>
            </div>
          )}

          <div className="bg-white rounded-xl shadow-sm border p-4">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h3 className="font-bold text-gray-800">{lang === 'en' ? (approvedItems.length > 0 ? '3. Additional work needed?' : '2. Additional work needed?') : (approvedItems.length > 0 ? '3. Travaux suppl√©mentaires ?' : '2. Travaux suppl√©mentaires ?')}</h3>
                <p className="text-sm text-gray-500">{lang === 'en' ? "Additional parts or labor" : "Pi√®ces ou main d'≈ìuvre en plus"}</p>
              </div>
              <div className="flex gap-3">
                <button onClick={() => { setAdditionalWorkNeeded(false); setWorkItemsLocked(false); }} className={`px-4 py-2 rounded-lg font-medium ${!additionalWorkNeeded ? 'bg-green-500 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}>{lang === 'en' ? 'No (N/A)' : 'Non (RAS)'}</button>
                <button onClick={() => setAdditionalWorkNeeded(true)} className={`px-4 py-2 rounded-lg font-medium ${additionalWorkNeeded ? 'bg-amber-500 text-white' : 'bg-gray-200 hover:bg-gray-300'}`}>{lang === 'en' ? 'Yes' : 'Oui'}</button>
              </div>
            </div>
            {additionalWorkNeeded && (
              <div className="border-t pt-4">
                {/* Warranty info banner */}
                {workItems.some(i => i.warranty) && (
                  <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded-lg flex items-center gap-2">
                    <span className="text-blue-700 text-sm font-medium">üõ°Ô∏è {lang === 'en' ? 'Warranty items bypass supplement approval' : 'Articles sous garantie ‚Äî pas de suppl√©ment requis'}</span>
                  </div>
                )}
                {/* Locked state - show read-only with edit button */}
                {workItemsLocked ? (
                  <div>
                    <div className="flex items-center justify-between mb-3">
                      <span className="text-sm text-gray-500 flex items-center gap-2">{lang === 'en' ? 'üîí Saved parts' : 'üîí Pi√®ces enregistr√©es'}</span>
                      <button onClick={() => setWorkItemsLocked(false)} className="px-3 py-1 text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg">{lang === 'en' ? '‚úèÔ∏è Edit' : '‚úèÔ∏è Modifier'}</button>
                    </div>
                    <div className="space-y-2">
                      {workItems.map((item, idx) => (
                        <div key={item.id} className={`flex items-center gap-2 rounded-lg p-3 ${item.warranty ? 'bg-blue-50 border border-blue-200' : 'bg-gray-100'}`}>
                          <span className="text-gray-400 w-6">{idx + 1}.</span>
                          {item.warranty && <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">üõ°Ô∏è Garantie</span>}
                          <span className="text-gray-500 text-sm w-24">{item.part_number || '‚Äî'}</span>
                          <span className="flex-1 font-medium">{item.description}</span>
                          <span className="text-gray-600">√ó{item.quantity}</span>
                          <span className={`font-bold w-24 text-right ${item.warranty ? 'text-blue-600' : 'text-amber-700'}`}>
                            {item.warranty ? (lang === 'en' ? 'Warranty' : 'Garantie') : `‚Ç¨${(parseFloat(item.price) || 0).toFixed(2)}`}
                          </span>
                        </div>
                      ))}
                    </div>
                    {workItems.length > 0 && (
                      <div className="mt-4 pt-4 border-t flex justify-between">
                        <span className="font-medium">{lang === 'en' ? 'Subtotal:' : 'Sous-total:'}</span>
                        <span className="text-xl font-bold text-amber-700">‚Ç¨{totalAdditional.toFixed(2)}</span>
                      </div>
                    )}
                  </div>
                ) : (
                  /* Editable state */
                  <div>
                    <div className="space-y-2">
                      {workItems.map((item, idx) => (
                        <div key={item.id} className={`rounded-lg p-2 ${item.warranty ? 'bg-blue-50 border border-blue-200' : 'bg-gray-50'}`}>
                          <div className="flex items-center gap-2">
                            <span className="text-gray-400 w-6">{idx + 1}.</span>
                            <div className="relative">
                              <input 
                                type="text" 
                                value={item.part_number || ''} 
                                onChange={e => updateWorkItem(item.id, 'part_number', e.target.value)}
                                onBlur={e => lookupPart(item.id, e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && lookupPart(item.id, e.target.value)}
                                placeholder={lang === 'en' ? 'Part #' : 'N¬∞ Pi√®ce'} 
                                className="w-28 px-3 py-2 border rounded-lg text-sm"
                              />
                              {partsLoading[item.id] && <span className="absolute right-2 top-2 text-blue-500 text-sm">...</span>}
                            </div>
                            <input type="text" value={item.description} onChange={e => updateWorkItem(item.id, 'description', e.target.value)} placeholder="Description" className="flex-1 px-3 py-2 border rounded-lg" />
                            <input type="number" value={item.quantity} onChange={e => updateWorkItem(item.id, 'quantity', e.target.value)} className="w-16 px-3 py-2 border rounded-lg text-center" min="1" />
                            <span className="text-gray-400">‚Ç¨</span>
                            <input type="number" value={item.price} onChange={e => updateWorkItem(item.id, 'price', e.target.value)} className={`w-24 px-3 py-2 border rounded-lg text-right ${item.warranty ? 'opacity-50' : ''}`} step="0.01" disabled={item.warranty} />
                            <button onClick={() => removeWorkItem(item.id)} className="p-2 text-red-500 hover:bg-red-100 rounded">‚úï</button>
                          </div>
                          <div className="flex items-center gap-2 mt-2 ml-8">
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={item.warranty || false}
                                onChange={e => updateWorkItem(item.id, 'warranty', e.target.checked)}
                                className="w-4 h-4 rounded text-blue-600"
                              />
                              <span className={`text-sm font-medium ${item.warranty ? 'text-blue-700' : 'text-gray-500'}`}>
                                üõ°Ô∏è {lang === 'en' ? 'Under warranty (no supplement needed)' : 'Sous garantie (pas de suppl√©ment requis)'}
                              </span>
                            </label>
                          </div>
                        </div>
                      ))}
                    </div>
                    <button onClick={addWorkItem} className="mt-3 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">{lang === 'en' ? '+ Add part' : '+ Ajouter pi√®ce'}</button>
                    {workItems.length > 0 && (
                      <div className="mt-4 pt-4 border-t flex justify-between">
                        <span className="font-medium">{lang === 'en' ? 'Subtotal:' : 'Sous-total:'}</span>
                        <span className="text-xl font-bold text-amber-700">‚Ç¨{totalAdditional.toFixed(2)}</span>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

          <div className="bg-white rounded-xl shadow-sm border p-4">
            <div className="flex items-center justify-between mb-2">
              <h3 className="font-bold text-gray-700">{approvedItems.length > 0 ? (lang === 'en' ? '4. WORK COMPLETED *' : '4. TRAVAUX R√âALIS√âS *') : (lang === 'en' ? '3. WORK COMPLETED *' : '3. TRAVAUX R√âALIS√âS *')}</h3>
              <TechTranslateButton onInsert={(text) => setWorkCompleted(prev => prev ? prev + '\n' + text : text)} lang={lang} />
            </div>
            <p className="text-sm text-gray-500 mb-4">{lang === 'en' ? 'Check and describe work performed' : 'Cochez et d√©crivez le travail effectu√©'}</p>
            <div className="bg-gray-50 rounded-lg p-4 mb-4">
              <p className="text-xs text-gray-500 uppercase mb-3">{lang === 'en' ? 'Checklist' : 'Checklist'}</p>
              <div className="space-y-2">
                {checklist.map(item => (
                  <label key={item.id} className="flex items-center gap-3 cursor-pointer hover:bg-gray-100 p-2 rounded-lg">
                    <input type="checkbox" checked={item.checked} onChange={() => toggleChecklistItem(item.id)} className="w-5 h-5 rounded text-green-600" />
                    <span className={item.checked ? 'text-green-700' : 'text-gray-700'}>{item.label}</span>
                  </label>
                ))}
              </div>
            </div>
            <textarea value={workCompleted} onChange={e => setWorkCompleted(e.target.value)} placeholder={lang === 'en' ? 'Describe the work performed...' : 'D√©crivez les travaux r√©alis√©s...'} className={`w-full px-4 py-3 border rounded-xl h-28 resize-none focus:ring-2 focus:ring-blue-500 ${serviceStarted && !workCompleted.trim() ? 'border-red-300 bg-red-50' : ''}`} />
          </div>
        </div>
        </div>
      </div>
    </div>
  );
}

// Report Preview Modal - Exact replica of official Lighthouse France Rapport PDF
function ReportPreviewModal({ device, rma, findings, workCompleted, checklist, additionalWorkNeeded, workItems, onClose, onComplete, canComplete, saving, technicianName, calType, receptionResult, lang = 'fr' }) {
  // Document content is ALWAYS in French regardless of admin language
  const today = new Date().toLocaleDateString('fr-FR');
  const serviceTypeText = device.service_type === 'calibration' ? '√âtalonnage' : device.service_type === 'repair' ? 'R√©paration' : '√âtalonnage et R√©paration';
  const motifText = device.notes ? `${serviceTypeText} - ${device.notes}` : serviceTypeText;
  
  const showCalType = calType && calType !== 'none';
  const showReceptionResult = receptionResult && receptionResult !== 'none';
  
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg text-gray-600">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
          <div><h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? 'üìÑ Service Report Preview' : 'üìÑ Aper√ßu Rapport de Service'}</h1><p className="text-gray-500">{device.model_name} ‚Ä¢ SN: {device.serial_number}</p></div>
        </div>
        <div className="flex items-center gap-3">
          {canComplete ? (
            <button onClick={onComplete} disabled={saving} className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium disabled:opacity-50">{saving ? (lang === 'en' ? 'Sending...' : 'Envoi...') : (lang === 'en' ? '‚úì Complete Report ‚Üí QC' : '‚úì Terminer Rapport ‚Üí QC')}</button>
          ) : (
            <span className="px-4 py-2 bg-amber-100 text-amber-700 rounded-lg">{lang === 'en' ? '‚è≥ Client approval required' : '‚è≥ Approbation client requise'}</span>
          )}
        </div>
      </div>

      {/* Report Document - Exact replica of PDF */}
      <div className="bg-gray-400 p-8 min-h-full flex justify-center">
        <div className="bg-white shadow-2xl w-full max-w-3xl relative" style={{ fontFamily: 'Arial, sans-serif', padding: '40px 50px', minHeight: '297mm', display: 'flex', flexDirection: 'column' }}>
          
          {/* Logo Header - Using actual logo image */}
          <div className="mb-6">
            <img 
              src="/images/logos/Lighthouse-color-logo.jpg" 
              alt="Lighthouse Worldwide Solutions" 
              className="h-24 w-auto"
              onError={(e) => {
                e.target.style.display = 'none';
                e.target.nextSibling.style.display = 'flex';
              }}
            />
            <div className="items-center gap-2 hidden">
              <div className="flex flex-col gap-0.5 mr-2">
                <div className="w-12 h-2 bg-[#FFD200]"></div>
                <div className="w-12 h-2 bg-[#003366]"></div>
              </div>
              <div>
                <span className="text-2xl font-bold tracking-wide" style={{ color: '#003366' }}>LIGHTHOUSE</span>
                <p className="text-xs tracking-widest text-gray-500 -mt-1">WORLDWIDE SOLUTIONS</p>
              </div>
            </div>
          </div>

          {/* Main Content - Grows to fill space */}
          <div className="flex-grow">
            {/* Info Table - Client/Device info */}
            <table className="w-full text-sm mb-6" style={{ borderCollapse: 'collapse', tableLayout: 'fixed' }}>
              <colgroup>
                <col style={{ width: '150px' }} />
                <col style={{ width: '200px' }} />
                <col />
              </colgroup>
              <tbody>
                {/* Row 1: Date + RMA */}
                <tr>
                  <td className="py-1 font-bold text-[#003366] align-top whitespace-nowrap">Date d'ach√®vement</td>
                  <td className="py-1 text-gray-800">{today}</td>
                  <td className="py-1 text-gray-800">
                    <span className="font-bold text-[#003366]">RMA # </span>{rma.request_number}
                  </td>
                </tr>
                
                {/* Row 2: Client */}
                <tr>
                  <td className="py-1 font-bold text-[#003366] align-top whitespace-nowrap">Client</td>
                  <td className="py-1 text-gray-800" colSpan="2">{rma.companies?.name}</td>
                </tr>
                
                {/* Row 3: Adresse */}
                <tr>
                  <td className="py-1 font-bold text-[#003366] align-top whitespace-nowrap">Adresse</td>
                  <td className="py-1 text-gray-800" colSpan="2">{rma.companies?.billing_address || '‚Äî'}</td>
                </tr>
                
                {/* Row 4: Code postal + Contact */}
                <tr>
                  <td className="py-1 font-bold text-[#003366] align-top whitespace-nowrap">Code postal / Ville</td>
                  <td className="py-1 text-gray-800">{rma.companies?.billing_postal_code} {rma.companies?.billing_city}</td>
                  <td className="py-1 text-gray-800">
                    <span className="font-bold text-[#003366]">Contact </span>{rma.companies?.contact_name || '‚Äî'}
                  </td>
                </tr>
                
                {/* Row 5: T√©l√©phone + Technicien label */}
                <tr>
                  <td className="py-1 font-bold text-[#003366] align-top whitespace-nowrap">T√©l√©phone</td>
                  <td className="py-1 text-gray-800">{rma.companies?.phone || '‚Äî'}</td>
                  <td className="py-1 text-gray-800 align-top">
                    <span className="font-bold text-[#003366]">Technicien(ne) de service</span>
                  </td>
                </tr>
                
                {/* Row 6: Mod√®le + Technicien name */}
                <tr>
                  <td className="py-1 font-bold text-[#003366] align-top whitespace-nowrap">Mod√®le#</td>
                  <td className="py-1 text-gray-800">{device.model_name}</td>
                  <td className="py-1 text-gray-800">{technicianName || 'Lighthouse France'}</td>
                </tr>
                
                {/* Row 7: Num√©ro de s√©rie */}
                <tr>
                  <td className="py-1 font-bold text-[#003366] align-top whitespace-nowrap">Num√©ro de s√©rie</td>
                  <td className="py-1 text-gray-800" colSpan="2">{device.serial_number}</td>
                </tr>
              </tbody>
            </table>

            {/* Content Sections */}
            <table className="w-full text-sm" style={{ borderCollapse: 'collapse', tableLayout: 'fixed' }}>
              <colgroup>
                <col style={{ width: '170px' }} />
                <col />
              </colgroup>
              <tbody>
                {/* Motif de retour = Service type + Customer notes */}
                <tr>
                  <td className="pt-6 pb-2 font-bold text-[#003366] align-top whitespace-nowrap">Motif de retour</td>
                  <td className="pt-6 pb-2 text-gray-800" style={{ wordWrap: 'break-word', overflowWrap: 'break-word' }}>{motifText}</td>
                </tr>
                
                {/* √âtalonnage effectu√© - only if not 'none' */}
                {showCalType && (
                  <tr>
                    <td className="py-2 font-bold text-[#003366] align-top whitespace-nowrap">√âtalonnage effectu√©</td>
                    <td className="py-2 text-gray-800">{calType}</td>
                  </tr>
                )}
                
                {/* R√©sultats √† la r√©ception - only if not 'none' */}
                {showReceptionResult && (
                  <tr>
                    <td className="py-2 font-bold text-[#003366] align-top whitespace-nowrap">R√©sultats √† la r√©ception</td>
                    <td className="py-2 text-gray-800">{receptionResult}</td>
                  </tr>
                )}
                
                {/* Constatations (Tech findings) */}
                <tr>
                  <td className="pt-6 pb-2 font-bold text-[#003366] align-top whitespace-nowrap">Constatations</td>
                  <td className="pt-6 pb-2 text-gray-800" style={{ wordWrap: 'break-word', overflowWrap: 'break-word', whiteSpace: 'pre-wrap' }}>{findings || '‚Äî'}</td>
                </tr>
                
                {/* Actions effectu√©es (Work description) */}
                <tr>
                  <td className="py-2 font-bold text-[#003366] align-top whitespace-nowrap">Actions effectu√©es</td>
                  <td className="py-2 text-gray-800" style={{ wordWrap: 'break-word', overflowWrap: 'break-word', whiteSpace: 'pre-wrap' }}>{workCompleted || '‚Äî'}</td>
                </tr>
                
                {/* Travaux r√©alis√©s (Checklist) - more space above */}
                <tr>
                  <td className="pt-10 pb-2 font-bold text-[#003366] align-top whitespace-nowrap">Travaux r√©alis√©s</td>
                  <td className="pt-10 pb-2">
                    <div className="space-y-1">
                      {checklist.filter(item => item.checked).map(item => (
                        <div key={item.id} className="flex items-center gap-2">
                          <span className="text-[#003366]">‚òë</span>
                          <span className="text-gray-800">{item.label}</span>
                        </div>
                      ))}
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          {/* Footer - Always at bottom */}
          <div className="text-center text-sm text-gray-600 mt-auto pt-8">
            <p className="font-bold text-[#003366]">Lighthouse Worldwide Solutions France</p>
            <p>16 Rue Paul S√©journ√© 94000 Cr√©teil France</p>
            <p>01 43 77 28 07</p>
          </div>
        </div>
      </div>
    </div>
  );
}

// Generate Suppl√©ment PDF - PROFESSIONAL FORMAT (styled like RMA quote)
const generateAvenantPDF = async (rma, devicesWithWork, options = {}) => {
  const jsPDF = await loadJsPDF();
  const pdf = new jsPDF('p', 'mm', 'a4');
  const company = rma.companies || {};
  const biz = options.businessSettings || {};
  const supNumber = options.supNumber || null; // SUP-0226-001 format
  
  const pageWidth = 210, pageHeight = 297, margin = 15;
  const contentWidth = pageWidth - (margin * 2);
  const footerHeight = 16;
  
  // Colors - using navy blue theme to match quotes and invoices
  const { navy, darkBlue, gray, lightGray, white } = PDF_COLORS;
  
  let y = margin;
  
  // Load logos - use color logo for supplements
  let lighthouseLogo = await loadImageAsBase64('/images/logos/Lighthouse-color-logo.jpg');
  let capcertLogo = await loadImageAsBase64('/images/logos/capcert-logo.png');
  
  const addFooter = () => {
    pdf.setFillColor(...darkBlue);
    pdf.rect(0, pageHeight - footerHeight, pageWidth, footerHeight, 'F');
    pdf.setTextColor(...white);
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.text(biz.company_name || 'Lighthouse France SAS', pageWidth / 2, pageHeight - footerHeight + 6, { align: 'center' });
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(180, 180, 180);
    pdf.setFontSize(8);
    pdf.text(`${biz.address || '16, rue Paul Sejourne'} - ${biz.postal_code || '94000'} ${biz.city || 'CRETEIL'} - Tel. ${biz.phone || '01 43 77 28 07'}`, pageWidth / 2, pageHeight - footerHeight + 11, { align: 'center' });
  };
  
  const getUsableHeight = () => pageHeight - footerHeight - margin;
  
  const checkPageBreak = (needed) => {
    if (y + needed > getUsableHeight()) {
      addFooter();
      pdf.addPage();
      y = margin;
      return true;
    }
    return false;
  };

  // ===== HEADER =====
  if (lighthouseLogo) {
    try {
      const format = lighthouseLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(lighthouseLogo, format, margin, y - 2, 85, 22);
    } catch (e) {
      pdf.setFontSize(26);
      pdf.setFont('helvetica', 'bold');
      pdf.setTextColor(...darkBlue);
      pdf.text('LIGHTHOUSE', margin, y + 8);
    }
  } else {
    pdf.setFontSize(26);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    pdf.text('LIGHTHOUSE', margin, y + 8);
  }
  
  // Title - SUPPL√âMENT in green
  pdf.setFontSize(18);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...navy);
  pdf.text('SUPPL√âMENT AU DEVIS', pageWidth - margin, y + 5, { align: 'right' });
  
  // Document number (SUP-0226-001) - primary
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('N¬∞ ' + (supNumber || '‚Äî'), pageWidth - margin, y + 11, { align: 'right' });
  
  // RMA reference only (no Devis reference)
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  if (rma.request_number) {
    pdf.text('RMA: ' + rma.request_number, pageWidth - margin, y + 16, { align: 'right' });
  }
  
  y += 20;
  pdf.setDrawColor(...navy);
  pdf.setLineWidth(1);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 7;

  // ===== INFO BAR =====
  pdf.setFillColor(245, 245, 245); // Light gray background
  pdf.rect(margin, y, contentWidth, 16, 'F');
  pdf.setFontSize(8);
  pdf.setTextColor(...lightGray);
  pdf.text('DATE', margin + 5, y + 5);
  pdf.text('VALIDITE', margin + 60, y + 5);
  pdf.text('CONDITIONS', margin + 115, y + 5);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  const qDate = new Date().toLocaleDateString('fr-FR');
  pdf.text(qDate, margin + 5, y + 12);
  pdf.text('30 jours', margin + 60, y + 12);
  pdf.text('A reception de facture', margin + 115, y + 12);
  y += 20;

  // ===== CLIENT =====
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...lightGray);
  pdf.text('CLIENT', margin, y);
  y += 5;
  pdf.setFontSize(14);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(company.name || 'Client', margin, y);
  y += 6;
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  if (company.billing_address || company.address) {
    pdf.text(company.billing_address || company.address, margin, y);
    y += 5;
  }
  const city = [company.billing_postal_code || company.postal_code, company.billing_city || company.city].filter(Boolean).join(' ');
  if (city) {
    pdf.text(city, margin, y);
    y += 5;
  }
  y += 5;

  // ===== INTRODUCTION =====
  pdf.setFillColor(240, 253, 244); // Light green background
  pdf.setDrawColor(...navy);
  pdf.setLineWidth(0.5);
  pdf.rect(margin, y, contentWidth, 14, 'FD');
  pdf.setFontSize(9);
  pdf.setTextColor(22, 101, 52); // Dark green text
  const introText = "Suite a l'inspection de vos appareils, nous avons constate des travaux supplementaires necessaires.";
  pdf.text(introText, margin + 5, y + 5);
  pdf.text("Veuillez trouver ci-dessous le detail des interventions recommandees.", margin + 5, y + 10);
  y += 18;

  // ===== DETAILED PRICING TABLE =====
  const rowH = 7;
  const colQty = margin;
  const colDesc = margin + 12;
  const colUnit = pageWidth - margin - 45;
  const colTotal = pageWidth - margin - 3;
  
  pdf.setFontSize(13);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text('Travaux Supplementaires', margin, y);
  y += 7;

  // Header row
  pdf.setFillColor(...darkBlue);
  pdf.rect(margin, y, contentWidth, 9, 'F');
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...white);
  pdf.text('Qte', colQty + 3, y + 6);
  pdf.text('Designation', colDesc, y + 6);
  pdf.text('Prix Unit.', colUnit, y + 6, { align: 'right' });
  pdf.text('Total HT', colTotal, y + 6, { align: 'right' });
  y += 9;

  let rowIndex = 0;
  let grandTotal = 0;

  // Build line items from devices with additional work
  devicesWithWork.forEach((device) => {
    // Device header row
    checkPageBreak(15);
    pdf.setFillColor(245, 245, 245);
    pdf.rect(margin, y, contentWidth, 8, 'F');
    pdf.setFontSize(9);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...darkBlue);
    const deviceHeader = `${device.model_name || 'Appareil'} (SN: ${device.serial_number || 'N/A'})`;
    pdf.text(deviceHeader, colDesc, y + 5.5);
    y += 8;
    
    // Findings (if any)
    if (device.service_findings) {
      checkPageBreak(10);
      pdf.setFontSize(8);
      pdf.setFont('helvetica', 'italic');
      pdf.setTextColor(...lightGray);
      const findingsText = `Constat: ${device.service_findings}`.substring(0, 90);
      pdf.text(findingsText, colDesc, y + 4);
      y += 6;
    }
    
    // Additional work items
    (device.additional_work_items || []).forEach((item) => {
      checkPageBreak(rowH + 2);
      const qty = parseInt(item.quantity) || 1;
      const unitPrice = parseFloat(item.price) || 0;
      const isWarranty = item.warranty;
      const lineTotal = isWarranty ? 0 : qty * unitPrice;
      grandTotal += lineTotal;
      
      pdf.setFillColor(rowIndex % 2 === 0 ? 255 : 250, rowIndex % 2 === 0 ? 255 : 250, rowIndex % 2 === 0 ? 255 : 250);
      pdf.rect(margin, y, contentWidth, rowH, 'F');
      pdf.setFontSize(9);
      pdf.setFont('helvetica', 'normal');
      pdf.setTextColor(...darkBlue);
      pdf.text(String(qty), colQty + 3, y + 5);
      
      // Description with part number if available
      const desc = item.partNumber ? `[${item.partNumber}] ${item.description || 'Piece'}` : (item.description || 'Service');
      pdf.text(desc.substring(0, 55), colDesc, y + 5);
      
      if (isWarranty) {
        pdf.setFont('helvetica', 'bold');
        pdf.setTextColor(41, 98, 255);
        pdf.text('Sous garantie', colTotal, y + 5, { align: 'right' });
      } else {
        pdf.text(unitPrice.toFixed(2) + ' EUR', colUnit, y + 5, { align: 'right' });
        pdf.setFont('helvetica', 'bold');
        pdf.text(lineTotal.toFixed(2) + ' EUR', colTotal, y + 5, { align: 'right' });
      }
      y += rowH;
      rowIndex++;
    });
    
    y += 3; // Space between devices
  });

  // Add some space before total
  y += 5;

  // Total row - taller box with better spacing
  checkPageBreak(20);
  pdf.setFillColor(...navy);
  pdf.rect(margin, y, contentWidth, 14, 'F');
  pdf.setTextColor(...white);
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'bold');
  pdf.text('TOTAL SUPPL√âMENT HT', margin + 10, y + 9);
  pdf.setFontSize(18);
  pdf.text(grandTotal.toFixed(2) + ' EUR', colTotal, y + 10, { align: 'right' });
  y += 18;

  // ===== CONDITIONS =====
  checkPageBreak(25);
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...lightGray);
  pdf.text('CONDITIONS:', margin, y);
  y += 5;
  pdf.setFont('helvetica', 'normal');
  pdf.text('‚Ä¢ Ce devis complementaire est valable 30 jours a compter de sa date d\'emission.', margin + 3, y);
  y += 4;
  pdf.text('‚Ä¢ Les travaux seront effectues apres reception de votre accord ecrit (signature ou bon de commande).', margin + 3, y);
  y += 4;
  pdf.text('‚Ä¢ Conditions de reglement: 30 jours fin de mois.', margin + 3, y);
  y += 8;

  // ===== SIGNATURE SECTION =====
  const sigY = Math.max(y + 5, pageHeight - footerHeight - 45);
  
  pdf.setDrawColor(200, 200, 200);
  pdf.setLineWidth(0.3);
  pdf.line(margin, sigY, pageWidth - margin, sigY);
  
  pdf.setFontSize(8);
  pdf.setTextColor(...lightGray);
  pdf.text('ETABLI PAR', margin, sigY + 7);
  pdf.setFontSize(12);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...darkBlue);
  pdf.text(options.createdBy || 'Service Technique', margin, sigY + 14);
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...gray);
  pdf.text('Lighthouse France', margin, sigY + 20);

  // Capcert logo
  if (capcertLogo) {
    try {
      const format = capcertLogo.includes('image/png') ? 'PNG' : 'JPEG';
      pdf.addImage(capcertLogo, format, margin + 52, sigY + 3, 32, 32);
    } catch (e) {}
  }

  // Signature box
  const sigBoxX = pageWidth - margin - 62;
  pdf.setFontSize(8);
  pdf.setTextColor(...lightGray);
  pdf.text('Signature client', sigBoxX + 16, sigY + 7);
  pdf.setDrawColor(180, 180, 180);
  pdf.setLineWidth(0.3);
  pdf.setLineDashPattern([2, 2], 0);
  pdf.roundedRect(sigBoxX + 5, sigY + 10, 52, 22, 2, 2, 'D');
  pdf.setLineDashPattern([], 0);
  pdf.text('Lu et approuve', sigBoxX + 18, sigY + 37);

  addFooter();
  return { blob: pdf.output('blob'), total: grandTotal };
};
function AvenantPreviewModal({ rma, devices, onClose, notify, reload, alreadySent, businessSettings, lang = 'fr' }) {
  const [sending, setSending] = useState(false);
  const [downloading, setDownloading] = useState(false);
  const devicesWithWork = devices.filter(d => d.additional_work_needed && (d.additional_work_items?.length > 0 || (d.additional_work_pricing && Object.keys(d.additional_work_pricing).length > 0)));
  const devicesRAS = devices.filter(d => !d.additional_work_needed || (!d.additional_work_items?.length && !(d.additional_work_pricing && Object.keys(d.additional_work_pricing).length > 0)));
  
  console.log('üîç AvenantPreview devices:', devices.map(d => ({
    model: d.model_name, serial: d.serial_number,
    additional_work_needed: d.additional_work_needed,
    items_count: d.additional_work_items?.length || 0,
    items: d.additional_work_items,
    pricing: d.additional_work_pricing
  })));
  console.log('üîç devicesWithWork:', devicesWithWork.length, 'devicesRAS:', devicesRAS.length);
  
  // Helper to get work items from device (supports both formats)
  const getWorkItems = (device) => {
    if (device.additional_work_items?.length > 0) return device.additional_work_items;
    if (device.additional_work_pricing && typeof device.additional_work_pricing === 'object') {
      return Object.entries(device.additional_work_pricing).map(([key, val]) => ({
        description: val.description || key,
        part_number: val.partNumber || val.part_number || '',
        quantity: val.quantity || 1,
        price: val.price || 0,
        warranty: false
      }));
    }
    return [];
  };
  
  const totalAvenant = devicesWithWork.reduce((sum, device) => {
    const deviceTotal = getWorkItems(device).filter(i => !i.warranty).reduce((dSum, item) => 
      dSum + (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1), 0
    );
    return sum + deviceTotal;
  }, 0);
  
  // Download PDF without sending
  const downloadPDF = async () => {
    setDownloading(true);
    try {
      const { blob } = await generateAvenantPDF(rma, devicesWithWork, { businessSettings });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Supplement_${rma.supplement_number || rma.request_number}_${Date.now()}.pdf`;
      a.click();
      URL.revokeObjectURL(url);
      notify('üì• PDF t√©l√©charg√©!');
    } catch (err) {
      notify('Erreur g√©n√©ration PDF: ' + err.message, 'error');
    }
    setDownloading(false);
  };
  
  // Generate PDF, upload, and send to client
  const sendAvenant = async () => {
    setSending(true);
    try {
      // 0. Get SUP document number
      let supNumber = null;
      try {
        const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'SUP' });
        if (!docNumError && docNumData) {
          supNumber = docNumData;
        }
      } catch (e) {
        console.error('Could not generate SUP number:', e);
      }
      
      // Calculate total for the supplement
      let avenantTotal = 0;
      devicesWithWork.forEach(d => {
        const items = getWorkItems(d);
        avenantTotal += items.filter(i => !i.warranty).reduce((sum, item) => sum + (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1), 0);
      });
      
      // === QUOTE REVIEW: Submit supplement for review ===
      const deviceSummary = devicesWithWork.map(d => `${d.model_name || 'Device'} (${d.serial_number})`).join(', ');
      
      await submitForQuoteReview({
        serviceRequestId: rma.id,
        quoteType: 'supplement',
        quoteData: {
          supNumber,
          rmaNumber: rma.request_number,
          devices: devicesWithWork.map(d => ({
            id: d.id,
            model_name: d.model_name,
            serial_number: d.serial_number,
            additional_work_needed: d.additional_work_needed,
            additional_work_items: getWorkItems(d),
            service_findings: d.service_findings
          })),
          businessSettings: businessSettings || {},
          avenantTotal
        },
        quoteNumber: supNumber,
        rmaNumber: rma.request_number,
        clientName: rma.companies?.name || 'Client inconnu',
        totalAmount: avenantTotal,
        deviceSummary,
        previousStatus: rma.status,
        serviceRequestUpdate: {
          supplement_number: supNumber,
          supplement_review_status: 'pending'
        },
        skipStatusChange: true, // Don't change main RMA status for supplements
        profile: { id: null, full_name: 'System', email: 'system' }
      });
      
      // Clear per-device rejection notes on re-submission
      for (const d of devicesWithWork) {
        if (d.supplement_rejection_notes) {
          await supabase.from('request_devices').update({
            supplement_rejection_notes: null,
            supplement_rejection_by: null,
            supplement_rejection_at: null
          }).eq('id', d.id);
        }
      }
      
      notify(lang === 'en' 
        ? `üìã Supplement submitted for review! ${supNumber || rma.request_number}` 
        : `üìã Suppl√©ment soumis pour v√©rification ! ${supNumber || rma.request_number}`);
      reload();
      onClose();
    } catch (err) {
      console.error('Avenant review submit error:', err);
      notify('Erreur: ' + err.message, 'error');
    }
    setSending(false);
  };
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70" onClick={onClose}>
      <div className="bg-white rounded-xl w-full max-w-4xl max-h-[95vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
        {/* Modal Header - Like RMA Quote */}
        <div className="sticky top-0 bg-[#1a1a2e] text-white px-6 py-4 flex justify-between items-center z-10">
          <div>
            <h2 className="text-xl font-bold">Avenant au Devis</h2>
            <p className="text-gray-400">{rma.request_number} ‚Ä¢ {rma.companies?.name}</p>
          </div>
          <div className="flex items-center gap-3">
            {alreadySent && (
              <span className="px-3 py-1 bg-green-500 rounded-full text-xs font-bold">
                ‚úì Envoy√© le {new Date(rma.avenant_sent_at).toLocaleDateString('fr-FR')}
              </span>
            )}
            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">‚úï</button>
          </div>
        </div>

        {/* Quote Document - Like RMA Quote PDF */}
        <div id="avenant-preview-content">
          {/* Quote Header */}
          <div className="px-8 pt-8 pb-4 border-b-4 border-[#2D5A7B]">
            <div className="flex justify-between items-start">
              <div>
                <img 
                  src="/images/logos/Lighthouse-color-logo.jpg" 
                  alt="Lighthouse France" 
                  className="h-24 w-auto mb-1"
                  onError={(e) => {
                    e.target.style.display = 'none';
                    e.target.nextSibling.style.display = 'block';
                  }}
                />
                <div className="hidden">
                  <h1 className="text-3xl font-bold tracking-tight text-[#1a1a2e]">LIGHTHOUSE</h1>
                  <p className="text-gray-500">Worldwide Solutions</p>
                </div>
              </div>
              <div className="text-right">
                <p className="text-2xl font-bold text-[#2D5A7B]">SUPPL√âMENT AU DEVIS</p>
                <p className="text-sm font-bold text-[#2D5A7B]">N¬∞ {rma.supplement_number || '(G√©n√©r√© √† l\'envoi)'}</p>
                <p className="text-xs text-gray-500">RMA: {rma.request_number}</p>
              </div>
            </div>
          </div>

          {/* Correction notes banner */}
          {rma.supplement_review_status === 'corrections_needed' && devices.some(d => d.supplement_rejection_notes) && (
            <div className="mx-6 mt-4 p-4 bg-amber-50 border-2 border-amber-300 rounded-xl">
              <div className="flex items-center gap-3 mb-3">
                <span className="text-lg">‚úèÔ∏è</span>
                <span className="font-bold text-amber-800">{lang === 'en' ? 'Reviewer requested corrections' : 'Le v√©rificateur demande des corrections'}</span>
              </div>
              <div className="space-y-2 ml-9">
                {devices.filter(d => d.supplement_rejection_notes).map(d => (
                  <div key={d.id} className="bg-white rounded-lg p-3 border border-amber-200">
                    <div className="flex items-center gap-2 mb-1">
                      {getDeviceImageUrl(d.model_name) && <img src={getDeviceImageUrl(d.model_name)} alt="" className="w-4 h-4 object-contain" />}
                      <span className="font-bold text-sm text-[#1a1a2e]">{d.model_name}</span>
                      <span className="font-mono text-xs text-gray-500">({d.serial_number})</span>
                    </div>
                    <p className="text-amber-900 text-sm">{d.supplement_rejection_notes}</p>
                    {d.supplement_rejection_by && <p className="text-xs text-amber-500 mt-1">‚Äî {d.supplement_rejection_by}</p>}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Info Bar */}
          <div className="bg-gray-100 px-8 py-3 flex justify-between text-sm border-b">
            <div>
              <p className="text-xs text-gray-500 uppercase">Date</p>
              <p className="font-medium">{alreadySent ? new Date(rma.avenant_sent_at).toLocaleDateString('fr-FR') : new Date().toLocaleDateString('fr-FR')}</p>
            </div>
            <div>
              <p className="text-xs text-gray-500 uppercase">Validit√©</p>
              <p className="font-medium">30 jours</p>
            </div>
            <div>
              <p className="text-xs text-gray-500 uppercase">Conditions</p>
              <p className="font-medium">√Ä r√©ception de facture</p>
            </div>
          </div>

          {/* Client Info */}
          <div className="px-8 py-4 border-b">
            <p className="text-xs text-gray-500 uppercase">Client</p>
            <p className="font-bold text-xl text-[#1a1a2e]">{rma.companies?.name}</p>
            {rma.companies?.billing_address && <p className="text-gray-600">{rma.companies?.billing_address}</p>}
            <p className="text-gray-600">{rma.companies?.billing_postal_code} {rma.companies?.billing_city}</p>
          </div>

          {/* Introduction */}
          <div className="px-8 py-4 bg-green-50 border-b border-green-200">
            <p className="text-green-800">
              <strong>Objet :</strong> Suite √† l'inspection de vos appareils, notre √©quipe technique a identifi√© des travaux suppl√©mentaires n√©cessaires. 
              Veuillez trouver ci-dessous le d√©tail des interventions recommand√©es.
            </p>
          </div>

          {/* Devices with additional work */}
          <div className="px-8 py-6 space-y-6">
            {devicesWithWork.map(device => {
              const deviceItems = getWorkItems(device);
              const billableItems = deviceItems.filter(i => !i.warranty);
              const warrantyItems = deviceItems.filter(i => i.warranty);
              const deviceTotal = billableItems.reduce((sum, item) => 
                sum + (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1), 0
              );
              
              return (
                <div key={device.id} className="border-l-4 border-blue-500 pl-4">
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <h3 className="font-bold text-lg text-[#1a1a2e] flex items-center gap-2">{getDeviceImageUrl(device.model_name) && <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-6 h-6 object-contain" />}{device.model_name}</h3>
                      <p className="text-gray-500 text-sm">N¬∞ de s√©rie: {device.serial_number}</p>
                    </div>
                    <span className="text-xl font-bold text-[#2D5A7B] whitespace-nowrap">{deviceTotal.toFixed(2)} ‚Ç¨</span>
                  </div>
                  
                  {device.service_findings && (
                    <div className="bg-gray-100 rounded-lg p-3 mb-3">
                      <p className="text-xs text-gray-500 uppercase font-medium mb-1">Constatations du technicien</p>
                      <p className="text-gray-700">{device.service_findings}</p>
                    </div>
                  )}
                  
                  {billableItems.length > 0 && (
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b-2 border-gray-200">
                          <th className="text-left py-2 text-gray-600 font-medium">Description</th>
                          <th className="text-center py-2 text-gray-600 font-medium w-16">Qt√©</th>
                          <th className="text-right py-2 text-gray-600 font-medium w-24">Prix Unit.</th>
                          <th className="text-right py-2 text-gray-600 font-medium w-24">Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        {billableItems.map((item, idx) => (
                          <tr key={idx} className="border-b border-gray-100">
                            <td className="py-2">{item.description}</td>
                            <td className="py-2 text-center">{item.quantity}</td>
                            <td className="py-2 text-right whitespace-nowrap">{(parseFloat(item.price) || 0).toFixed(2)} ‚Ç¨</td>
                            <td className="py-2 text-right font-medium whitespace-nowrap">{((parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1)).toFixed(2)} ‚Ç¨</td>
                          </tr>
                        ))}
                        {warrantyItems.map((item, idx) => (
                          <tr key={`w-${idx}`} className="border-b border-gray-100 bg-blue-50">
                            <td className="py-2">
                              {item.description}
                              <span className="ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">üõ°Ô∏è Garantie</span>
                            </td>
                            <td className="py-2 text-center">{item.quantity}</td>
                            <td className="py-2 text-right whitespace-nowrap">‚Äî</td>
                            <td className="py-2 text-right font-medium whitespace-nowrap"><span className="text-blue-600">Sous garantie</span></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )}
                </div>
              );
            })}
          </div>

          {/* Devices without additional work (RAS) */}
          {devicesRAS.length > 0 && (
            <div className="px-8 py-4 bg-green-50 border-t border-b">
              <p className="text-sm text-green-800 font-medium mb-2">‚úì Appareils sans travaux suppl√©mentaires:</p>
              <div className="space-y-1">
                {devicesRAS.map(device => (
                  <p key={device.id} className="text-sm text-green-700">
                    {device.model_name} (SN: {device.serial_number}) - {device.service_findings || 'RAS'}
                  </p>
                ))}
              </div>
            </div>
          )}

          {/* Total Section */}
          <div className="px-8 py-4 bg-[#2D5A7B]">
            <div className="flex justify-between items-center text-white">
              <span className="text-lg font-bold">TOTAL SUPPL√âMENT HT</span>
              <span className="text-3xl font-bold whitespace-nowrap">{totalAvenant.toFixed(2)} ‚Ç¨</span>
            </div>
          </div>

          {/* Conditions */}
          <div className="px-8 py-4 border-b">
            <p className="font-bold text-[#1a1a2e] text-sm mb-2">Conditions:</p>
            <ul className="text-sm text-gray-600 space-y-1">
              <li>‚Ä¢ Ce devis compl√©mentaire est valable 30 jours</li>
              <li>‚Ä¢ Les travaux seront effectu√©s apr√®s r√©ception de votre accord</li>
              <li>‚Ä¢ Conditions de r√®glement: 30 jours fin de mois</li>
            </ul>
          </div>

          {/* Signature Section */}
          <div className="px-8 py-6 flex justify-between items-end">
            <div>
              <p className="text-xs text-gray-400 uppercase tracking-wider mb-1">√âtabli par</p>
              <p className="font-bold text-lg text-[#1a1a2e]">Service Technique</p>
              <p className="text-gray-500">Lighthouse France</p>
            </div>
            <div className="text-center">
              <p className="text-xs text-gray-400 uppercase tracking-wider mb-2">Bon pour accord</p>
              <div className="w-44 h-16 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                <span className="text-gray-300 text-xs">Signature et cachet</span>
              </div>
            </div>
          </div>

          {/* Footer */}
          <div className="bg-[#1a1a2e] text-white px-8 py-3 text-center">
            <p className="font-medium text-sm">Lighthouse France SAS</p>
            <p className="text-gray-400 text-xs">16, rue Paul S√©journ√© ‚Ä¢ 94000 CR√âTEIL ‚Ä¢ T√©l. 01 43 77 28 07</p>
          </div>
        </div>

        {/* Actions */}
        <div className="sticky bottom-0 bg-gray-100 px-6 py-4 border-t flex justify-between items-center">
          <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
            ‚Üê Fermer
          </button>
          <div className="flex gap-3">
            <button 
              onClick={downloadPDF}
              disabled={downloading}
              className="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50"
            >
              {downloading ? '...' : 'üì• T√©l√©charger PDF'}
            </button>
            {!alreadySent && rma.supplement_review_status !== 'pending' && (
              <button 
                onClick={sendAvenant}
                disabled={sending}
                className="px-6 py-2 bg-[#00A651] hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50"
              >
                {sending ? 'Soumission...' : (rma.supplement_review_status === 'corrections_needed' ? 'üìã Re-soumettre pour V√©rification' : 'üìã Soumettre pour V√©rification')}
              </button>
            )}
            {rma.supplement_review_status === 'pending' && (
              <span className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-medium">
                üìã {lang === 'en' ? 'Under review' : 'En cours de v√©rification'}
              </span>
            )}
            {alreadySent && (
              <span className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-medium">
                ‚úì Envoy√©
              </span>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function RequestsSheet({ requests, notify, reload, profile, businessSettings, t = k=>k, lang = 'fr' }) {
  const [selectedRequest, setSelectedRequest] = useState(null);
  const [quoteRequest, setQuoteRequest] = useState(null);
  const [filter, setFilter] = useState('pending');
  
  const pendingRequests = requests.filter(r => r.status === 'submitted' && !r.request_number);
  const modificationRequests = requests.filter(r => r.status === 'quote_revision_requested');
  const quoteModificationRequests = requests.filter(r => r.quote_rejection_notes && r.status === 'rma_created');
  const allPending = [...quoteModificationRequests, ...modificationRequests, ...pendingRequests];
  const displayRequests = filter === 'pending' ? allPending : requests;

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? 'Requests' : 'Demandes'}</h1>
        <div className="flex gap-2">
          <button onClick={() => setFilter('pending')} className={`px-4 py-2 rounded-lg text-sm font-medium ${filter === 'pending' ? 'bg-amber-500 text-white' : 'bg-gray-200'}`}>
            En attente ({allPending.length})
          </button>
          <button onClick={() => setFilter('all')} className={`px-4 py-2 rounded-lg text-sm font-medium ${filter === 'all' ? 'bg-gray-700 text-white' : 'bg-gray-200'}`}>
            Toutes ({requests.length})
          </button>
        </div>
      </div>
      
      {/* Modification Requests Alert */}
      {modificationRequests.length > 0 && filter === 'pending' && (
        <div className="bg-red-50 border-2 border-red-300 p-4 rounded-xl">
          <p className="font-bold text-red-800">üî¥ {modificationRequests.length} {lang === 'en' ? 'quote modification request(s)' : 'demande(s) de modification de devis'}</p>
          <p className="text-sm text-red-600">{lang === 'en' ? 'Client requested modifications - please revise and resend' : 'Le client a demand√© des modifications - veuillez r√©viser et renvoyer'}</p>
        </div>
      )}
      
      {pendingRequests.length > 0 && filter === 'pending' && (
        <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg">
          <p className="font-medium text-amber-800">‚ö†Ô∏è {pendingRequests.length} {lang === 'en' ? 'new request(s) - Create a quote to process' : 'nouvelle(s) demande(s) - Cr√©ez un devis pour traiter'}</p>
        </div>
      )}
      
      <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'ID / RMA' : 'ID / RMA'}</th>
              <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('client')}</th>
              <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('type')}</th>
              <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('devices')}</th>
              <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('status')}</th>
              <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Submitted' : 'Soumis'}</th>
              <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('actions')}</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {displayRequests.length === 0 ? (
              <tr><td colSpan={7} className="px-4 py-8 text-center text-gray-400">{filter === 'pending' ? (lang === 'en' ? 'No pending requests' : 'Aucune demande en attente') : (lang === 'en' ? 'No requests' : 'Aucune demande')}</td></tr>
            ) : displayRequests.map(req => {
              const style = STATUS_STYLES[req.status] || STATUS_STYLES.submitted;
              const devices = req.request_devices || [];
              const isPending = req.status === 'submitted' && !req.request_number;
              const needsRevision = req.status === 'quote_revision_requested';
              const needsQuoteCorrection = req.quote_rejection_notes && req.status === 'rma_created';
              const isContractRMA = req.is_contract_rma || req.contract_id;
              
              return (
                <tr key={req.id} className={`hover:bg-gray-50 ${needsQuoteCorrection ? 'bg-amber-50' : needsRevision ? 'bg-red-50' : isPending ? 'bg-amber-50/50' : ''}`}>
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      {req.request_number ? (
                        <span className="font-mono font-bold text-[#00A651]">{req.request_number}</span>
                      ) : (
                        <span className="text-amber-600 font-medium">{lang === 'en' ? 'New' : 'Nouvelle'}</span>
                      )}
                      {isContractRMA && (
                        <span className="px-1.5 py-0.5 text-xs font-bold rounded bg-emerald-100 text-emerald-700">
                          üìã
                        </span>
                      )}
                      {needsQuoteCorrection && (
                        <span className="px-1.5 py-0.5 text-xs font-bold rounded bg-amber-100 text-amber-700">
                          ‚úèÔ∏è
                        </span>
                      )}
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      <p className="font-medium text-gray-800">{req.companies?.name || '‚Äî'}</p>
                    </div>
                  </td>
                  <td className="px-4 py-3"><span className="text-sm">{req.request_type === 'service' ? 'üîß Service' : (lang === 'en' ? 'üì¶ Parts' : 'üì¶ Pi√®ces')}</span></td>
                  <td className="px-4 py-3"><span className="text-sm text-gray-600">{devices.length > 0 ? devices.length + ' appareil(s)' : '1 appareil'}</span></td>
                  <td className="px-4 py-3">
                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${style.bg} ${style.text}`}>{lang === 'en' && style.en ? style.en : style.label}</span>
                    {needsQuoteCorrection && (
                      <p className="text-xs text-amber-600 mt-1 max-w-[200px] truncate" title={req.quote_rejection_notes}>‚úèÔ∏è {req.quote_rejection_notes}</p>
                    )}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-500">{new Date(req.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</td>
                  <td className="px-4 py-3">
                    <div className="flex gap-2">
                      {(isPending || needsRevision || needsQuoteCorrection) && (
                        <button onClick={() => setQuoteRequest(req)} className={`px-3 py-1 text-sm text-white rounded font-medium ${needsQuoteCorrection ? 'bg-amber-500 hover:bg-amber-600' : needsRevision ? 'bg-red-500 hover:bg-red-600' : 'bg-[#00A651] hover:bg-[#008f45]'}`}>
                          {needsQuoteCorrection ? (lang === 'en' ? '‚úèÔ∏è Correct Quote' : '‚úèÔ∏è Corriger Devis') : needsRevision ? (lang === 'en' ? 'üî¥ Revise Quote' : 'üî¥ R√©viser Devis') : (lang === 'en' ? 'üí∞ Create Quote' : 'üí∞ Cr√©er Devis')}
                        </button>
                      )}
                      <button onClick={() => setSelectedRequest(req)} className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded">{t('view')}</button>
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
      {selectedRequest && <RequestDetailModal request={selectedRequest} onClose={() => setSelectedRequest(null)} onCreateQuote={() => { setSelectedRequest(null); setQuoteRequest(selectedRequest); }} lang={lang} />}
      {quoteRequest && <QuoteEditorModal request={quoteRequest} onClose={() => setQuoteRequest(null)} notify={notify} reload={reload} profile={profile} businessSettings={businessSettings} lang={lang} />}
    </div>
  );
}

function RequestDetailModal({ request, onClose, onCreateQuote, lang = 'fr' }) {
  const t = k => k;
  const style = STATUS_STYLES[request.status] || STATUS_STYLES.submitted;
  const devices = request.request_devices || [];
  const isPending = request.status === 'submitted' && !request.request_number;
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={onClose}>
      <div className="bg-white rounded-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
        <div className="px-6 py-4 border-b sticky top-0 bg-white flex justify-between items-center">
          <div>
            <h2 className="text-xl font-bold text-gray-800">{request.request_number || 'Nouvelle Demande'}</h2>
            <p className="text-sm text-gray-500">{request.companies?.name}</p>
          </div>
          <span className={`px-3 py-1 rounded-full text-sm font-medium ${style.bg} ${style.text}`}>{lang === 'en' && style.en ? style.en : style.label}</span>
        </div>
        
        <div className="p-6 space-y-6">
          <div className="grid md:grid-cols-2 gap-4">
            <div className="bg-gray-50 rounded-lg p-4"><h3 className="font-bold text-gray-700 mb-2">{t('client')}</h3><p className="font-medium">{request.companies?.name}</p></div>
            <div className="bg-gray-50 rounded-lg p-4"><h3 className="font-bold text-gray-700 mb-2">{lang === 'en' ? 'Service' : 'Service'}</h3><p className="font-medium">{request.requested_service}</p><p className="text-sm text-gray-500">Soumis le {new Date(request.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p></div>
          </div>
          
          {/* Devices */}
          <div>
            <h3 className="font-bold text-gray-700 mb-3">{lang === 'en' ? `Devices (${devices.length || 1})` : `Appareils (${devices.length || 1})`}</h3>
            {devices.length > 0 ? (
              <div className="space-y-2">
                {devices.map((d, i) => (
                  <div key={i} className="bg-gray-50 rounded-lg p-3 flex justify-between items-center">
                    <div>
                      <p className="font-medium flex items-center gap-2">{getDeviceImageUrl(d.model_name) && <img src={getDeviceImageUrl(d.model_name)} alt="" className="w-4 h-4 object-contain" />}{d.model_name}</p>
                      <p className="text-sm text-gray-500">SN: {d.serial_number}</p>
                      {d.service_type && <p className="text-xs text-gray-400">{d.service_type}</p>}
                    </div>
                    <span className="text-sm text-gray-400">{d.equipment_type}</span>
                  </div>
                ))}
              </div>
            ) : (
              <div className="bg-gray-50 rounded-lg p-3"><p className="font-medium">{request.serial_number}</p></div>
            )}
          </div>
          
          {request.problem_description && <div><h3 className="font-bold text-gray-700 mb-2">{lang === 'en' ? 'Client notes' : 'Notes du client'}</h3><div className="bg-gray-50 rounded-lg p-4"><p className="text-sm whitespace-pre-wrap">{request.problem_description}</p></div></div>}
        </div>
        
        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between">
          <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{t('close')}</button>
          {isPending && (
            <button onClick={onCreateQuote} className="px-6 py-2 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-medium">
              üí∞ Cr√©er Devis
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
// ============================================
// PARTS ORDER FULL PAGE - Like RMAFullPage but for parts
// ============================================
function PartsOrderFullPage({ order, onBack, notify, reload, profile, businessSettings, onOpenQuoteEditor, t = k=>k, lang = 'fr' }) {
  const [activeTab, setActiveTab] = useState('details');
  const [saving, setSaving] = useState(false);
  const [showShipping, setShowShipping] = useState(false);
  const [messages, setMessages] = useState([]);
  const [attachments, setAttachments] = useState([]);
  const [orderInvoices, setOrderInvoices] = useState([]);
  const [newMessage, setNewMessage] = useState('');
  const [sendingMessage, setSendingMessage] = useState(false);
  const [showDocUploadModal, setShowDocUploadModal] = useState(false);
  const [docUploadFile, setDocUploadFile] = useState(null);
  const [docUploadName, setDocUploadName] = useState('');
  const [docUploadCategory, setDocUploadCategory] = useState('general');
  const [docUploadShared, setDocUploadShared] = useState(true);
  const [docUploading, setDocUploading] = useState(false);
  
  // Safety check
  if (!order) {
    return (
      <div className="p-8 text-center">
        <p className="text-red-500">{lang === 'en' ? 'Error: Order not found' : 'Erreur: Commande non trouv√©e'}</p>
        <button onClick={onBack} className="mt-4 px-4 py-2 bg-gray-200 rounded-lg">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
      </div>
    );
  }
  
  const company = order.companies || {};
  const quoteData = order.quote_data || {};
  const parts = quoteData.parts || [];
  const shippingData = quoteData.shipping || {};
  
  // Fetch messages, attachments, and invoices
  useEffect(() => {
    const fetchData = async () => {
      // Fetch messages
      const { data: msgs } = await supabase
        .from('request_messages')
        .select('*')
        .eq('request_id', order.id)
        .order('created_at', { ascending: true });
      setMessages(msgs || []);
      
      // Fetch attachments
      const { data: atts } = await supabase
        .from('request_attachments')
        .select('*')
        .eq('request_id', order.id)
        .order('created_at', { ascending: false });
      setAttachments(atts || []);

      // Fetch invoices (only sent/paid visible to customer)
      const { data: invs } = await supabase
        .from('invoices')
        .select('*')
        .eq('request_id', order.id)
        .in('status', ['sent', 'paid', 'overdue', 'partially_paid'])
        .order('created_at', { ascending: false });
      setOrderInvoices(invs || []);
    };
    fetchData();
  }, [order.id]);
  
  // Refresh attachments
  const refreshAttachments = async () => {
    const { data } = await supabase
      .from('request_attachments')
      .select('*')
      .eq('request_id', order.id)
      .order('created_at', { ascending: false });
    if (data) setAttachments(data);
  };
  
  // Upload document
  const handleDocUpload = async () => {
    if (!docUploadFile || !order?.id) return;
    setDocUploading(true);
    try {
      const ext = docUploadFile.name.split('.').pop();
      const fileName = `doc_${order.request_number}_${Date.now()}.${ext}`;
      const filePath = `attachments/${order.request_number}/${fileName}`;
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('documents')
        .upload(filePath, docUploadFile, { contentType: docUploadFile.type });
      if (uploadError) throw uploadError;
      
      const { data: urlData } = supabase.storage.from('documents').getPublicUrl(filePath);
      const fileUrl = urlData?.publicUrl;
      
      const displayName = docUploadName.trim() || docUploadFile.name;
      const { error: insertError } = await supabase.from('request_attachments').insert({
        request_id: order.id,
        file_name: displayName,
        file_url: fileUrl,
        file_type: docUploadFile.type,
        file_size: docUploadFile.size,
        uploaded_by: profile?.id,
        category: docUploadShared ? docUploadCategory : `internal_${docUploadCategory}`
      });
      if (insertError) throw insertError;
      
      notify(lang === 'en' ? 'üìÑ Document added!' : 'üìÑ Document ajout√©!');
      setShowDocUploadModal(false);
      setDocUploadFile(null);
      setDocUploadName('');
      setDocUploadCategory('general');
      setDocUploadShared(true);
      await refreshAttachments();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setDocUploading(false);
  };
  
  // Archive document (soft delete)
  const handleDocDelete = async (docId) => {
    try {
      const { error } = await supabase.from('request_attachments').update({
        archived_at: new Date().toISOString()
      }).eq('id', docId);
      if (error) throw error;
      notify(lang === 'en' ? 'üì¶ Document archived' : 'üì¶ Document archiv√©');
      await refreshAttachments();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
  };
  
  // Toggle document visibility
  const handleToggleDocVisibility = async (doc) => {
    try {
      const isInternal = doc.category?.startsWith('internal_');
      const newCategory = isInternal 
        ? doc.category.replace('internal_', '') 
        : `internal_${doc.category || 'general'}`;
      const { error } = await supabase.from('request_attachments')
        .update({ category: newCategory })
        .eq('id', doc.id);
      if (error) throw error;
      notify(isInternal ? (lang === 'en' ? 'üëÅÔ∏è Document visible to client' : 'üëÅÔ∏è Document visible au client') : (lang === 'en' ? 'üîí Document hidden from client' : 'üîí Document masqu√© au client'));
      await refreshAttachments();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
  };
  
  // Parts order progress steps
  const progressSteps = [
    { id: 'submitted', label: t('stSubmitted'), icon: 'üìã' },
    { id: 'quote_sent', label: lang === 'en' ? 'Quote' : 'Devis', icon: 'üí∞' },
    { id: 'bc_review', label: 'BC', icon: '‚úçÔ∏è' },
    { id: 'in_progress', label: lang === 'en' ? 'In progress' : 'En cours', icon: 'üì¶' },
    { id: 'ready_to_ship', label: lang === 'en' ? 'Ready' : 'Pr√™t', icon: 'üöö' },
    { id: 'shipped', label: lang === 'en' ? 'Shipped' : 'Exp√©di√©', icon: '‚úÖ' }
  ];
  
  const getStepIndex = (status) => {
    const statusMap = {
      'submitted': 0,
      'quote_revision_requested': 0,
      'quote_sent': 1,
      'waiting_bc': 1,
      'bc_review': 2,
      'bc_submitted': 2,
      'in_progress': 3,
      'ready_to_ship': 4,
      'shipped': 5,
      'delivered': 5,
      'completed': 5
    };
    return statusMap[status] ?? 0;
  };
  
  const currentStepIndex = getStepIndex(order.status);
  
  // Progress Bar Component
  const ProgressBar = () => (
    <div className="flex items-center w-full">
      {progressSteps.map((step, index) => {
        const isCompleted = index < currentStepIndex;
        const isCurrent = index === currentStepIndex;
        const isLast = index === progressSteps.length - 1;
        
        return (
          <div key={step.id} className="flex items-center flex-1">
            <div 
              className={`
                relative flex items-center justify-center flex-1 py-2 px-1 text-xs font-medium
                ${isCompleted ? 'bg-[#00A651] text-white' : isCurrent ? 'bg-[#007A3D] text-white' : 'bg-gray-200 text-gray-500'}
                ${index === 0 ? 'rounded-l-md' : ''}
                ${isLast ? 'rounded-r-md' : ''}
              `}
              style={{
                clipPath: isLast 
                  ? 'polygon(0 0, 100% 0, 100% 100%, 0 100%, 8px 50%)' 
                  : index === 0 
                    ? 'polygon(0 0, calc(100% - 8px) 0, 100% 50%, calc(100% - 8px) 100%, 0 100%)'
                    : 'polygon(0 0, calc(100% - 8px) 0, 100% 50%, calc(100% - 8px) 100%, 0 100%, 8px 50%)'
              }}
            >
              <span className="mr-1">{step.icon}</span>
              <span className="hidden sm:inline">{step.label}</span>
            </div>
          </div>
        );
      })}
    </div>
  );
  
  // Update status helper
  const updateStatus = async (newStatus) => {
    setSaving(true);
    const { error } = await supabase
      .from('service_requests')
      .update({ status: newStatus })
      .eq('id', order.id);
    
    if (error) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
    } else {
      notify(lang === 'en' ? 'Status updated!' : 'Statut mis √† jour!');
      reload();
    }
    setSaving(false);
  };
  
  // Send message
  const sendMessage = async () => {
    if (!newMessage.trim()) return;
    setSendingMessage(true);
    
    const { error } = await supabase.from('request_messages').insert({
      request_id: order.id,
      sender_type: 'admin',
      sender_name: profile?.full_name || 'Admin',
      message: newMessage.trim()
    });
    
    if (error) {
      notify(lang === 'en' ? 'Error sending message' : 'Erreur envoi message', 'error');
    } else {
      setNewMessage('');
      // Refresh messages
      const { data: msgs } = await supabase
        .from('request_messages')
        .select('*')
        .eq('request_id', order.id)
        .order('created_at', { ascending: true });
      setMessages(msgs || []);
      notify(lang === 'en' ? 'Message sent!' : 'Message envoy√©!');
    }
    setSendingMessage(false);
  };
  
  // Status styles
  
const STATUS_STYLES = {
    submitted: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'New Order' : 'Nouvelle demande' },
    quote_revision_requested: { bg: 'bg-red-100', text: 'text-red-700', label: lang === 'en' ? 'Revision Requested' : 'R√©vision demand√©e' },
    quote_sent: { bg: 'bg-purple-100', text: 'text-purple-700', label: lang === 'en' ? 'Quote Sent' : 'Devis envoy√©' },
    pending_quote_review: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'Quote Under Review' : 'Devis en v√©rification' },
    bc_review: { bg: 'bg-blue-100', text: 'text-blue-700', label: lang === 'en' ? 'PO Under Review' : 'BC √† v√©rifier' },
    in_progress: { bg: 'bg-orange-100', text: 'text-orange-700', label: lang === 'en' ? 'In Progress' : 'En cours' },
    ready_to_ship: { bg: 'bg-indigo-100', text: 'text-indigo-700', label: lang === 'en' ? 'Ready to Ship' : 'Pr√™t √† exp√©dier' },
    shipped: { bg: 'bg-green-100', text: 'text-green-700', label: t('stShipped') }
  };
  const statusStyle = STATUS_STYLES[order.status] || STATUS_STYLES.submitted;
  
  // Render shipping modal
  if (showShipping) {
    return (
      <PartsShippingModal
        order={order}
        onClose={() => { setShowShipping(false); reload(); }}
        notify={notify}
        reload={reload}
        profile={profile}
        businessSettings={businessSettings}
      />
    );
  }
  
  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <div className="bg-white border-b shadow-sm sticky top-0 z-10">
        <div className="px-6 py-4">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg">
                <span className="text-xl">‚Üê</span>
              </button>
              <div>
                <div className="flex items-center gap-3">
                  <h1 className="text-2xl font-bold text-gray-800">{order.request_number || (lang === 'en' ? 'New Order' : 'Nouvelle Commande')}</h1>
                  <span className={`px-3 py-1 rounded-full text-sm font-medium ${statusStyle.bg} ${statusStyle.text}`}>
                    {lang === 'en' && statusStyle.en ? statusStyle.en : statusStyle.label}
                  </span>
                </div>
                <p className="text-gray-500">{company.name} ‚Ä¢ {lang === 'en' ? 'Parts order' : 'Commande de pi√®ces d√©tach√©es'}</p>
              </div>
            </div>
            
            {/* Actions */}
            <div className="flex items-center gap-3">
              {(order.status === 'submitted' || order.status === 'quote_revision_requested' || (order.quote_rejection_notes && order.status === 'rma_created')) && (
                <button
                  onClick={() => onOpenQuoteEditor(order)}
                  className={`px-4 py-2 ${order.status === 'quote_revision_requested' ? 'bg-red-500 hover:bg-red-600' : 'bg-[#00A651] hover:bg-[#008f45]'} text-white rounded-lg font-medium`}
                >
                  üí∞ {order.status === 'quote_revision_requested' ? (lang === 'en' ? 'Revise Quote' : 'R√©viser Devis') : (lang === 'en' ? 'Create Quote' : 'Cr√©er Devis')}
                </button>
              )}
              {order.status === 'in_progress' && (
                <button
                  onClick={() => updateStatus('ready_to_ship')}
                  disabled={saving}
                  className="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-medium disabled:opacity-50"
                >
                  üöö Marquer Pr√™t
                </button>
              )}
              {order.status === 'ready_to_ship' && (
                <button
                  onClick={() => setShowShipping(true)}
                  className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium"
                >
                  üì¶ Cr√©er Exp√©dition
                </button>
              )}
            </div>
          </div>
          
          {/* Progress Bar */}
          <ProgressBar />
        </div>
      </div>
      
      {/* Main Content */}
      <div className="p-6">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column - Main Content */}
          <div className="lg:col-span-2 space-y-6">
            {/* Tabs */}
            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <div className="flex border-b">
                {[
                  { id: 'details', label: lang === 'en' ? 'Details' : 'D√©tails', icon: 'üìã' },
                  { id: 'messages', label: lang === 'en' ? 'Messages' : 'Messages', icon: 'üí¨', badge: messages.filter(m => m.sender_type === 'client' && !m.read_at).length },
                  { id: 'documents', label: lang === 'en' ? 'Documents' : 'Documents', icon: 'üìÑ' },
                  { id: 'history', label: lang === 'en' ? 'History' : 'Historique', icon: 'üìú' }
                ].map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                      activeTab === tab.id 
                        ? 'bg-amber-50 text-amber-700 border-b-2 border-amber-500' 
                        : 'text-gray-500 hover:bg-gray-50'
                    }`}
                  >
                    <span>{tab.icon}</span> {tab.label}
                    {tab.badge > 0 && (
                      <span className="px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full">{tab.badge}</span>
                    )}
                  </button>
                ))}
              </div>
              
              <div className="p-6">
                {/* Details Tab */}
                {activeTab === 'details' && (
                  <div className="space-y-6">
                    {/* Revision Notes */}
                    {order.revision_notes && (
                      <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                        <h3 className="font-bold text-red-800 mb-2">{lang === 'en' ? 'üî¥ Client revision request' : 'üî¥ Demande de modification du client'}</h3>
                        <p className="text-red-700 whitespace-pre-wrap">{order.revision_notes}</p>
                      </div>
                    )}
                    
                    {/* Parts List */}
                    <div>
                      <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? `üì¶ Parts ordered (${parts.length})` : `üì¶ Pi√®ces command√©es (${parts.length})`}</h3>
                      <div className="space-y-2">
                        {parts.length > 0 ? parts.map((part, idx) => (
                          <div key={idx} className="bg-gray-50 rounded-lg p-4 border">
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <p className="font-medium text-gray-800">{part.description}</p>
                                <p className="text-sm text-gray-500 font-mono">{part.partNumber || '‚Äî'}</p>
                              </div>
                              <div className="text-right">
                                <p className="font-bold text-amber-600">x{part.quantity}</p>
                                {part.unitPrice && (
                                  <p className="text-sm text-gray-500">{(part.unitPrice * part.quantity).toFixed(2)} ‚Ç¨</p>
                                )}
                              </div>
                            </div>
                          </div>
                        )) : (
                          <div className="bg-amber-50 rounded-lg p-4">
                            <p className="text-amber-700 whitespace-pre-wrap">{order.problem_description || (lang === 'en' ? 'No parts specified' : 'Pas de pi√®ces sp√©cifi√©es')}</p>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    {/* Quote Summary */}
                    {quoteData.grandTotal && (
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 className="font-bold text-blue-800 mb-2">{lang === 'en' ? 'üí∞ Quote' : 'üí∞ Devis'}</h3>
                        <div className="grid grid-cols-3 gap-4 text-sm">
                          <div>
                            <p className="text-blue-600">{lang === 'en' ? 'Subtotal excl. VAT' : 'Sous-total HT'}</p>
                            <p className="font-bold text-blue-800">{(quoteData.subtotal || 0).toFixed(2)} ‚Ç¨</p>
                          </div>
                          <div>
                            <p className="text-blue-600">{t('tva')}</p>
                            <p className="font-bold text-blue-800">{(quoteData.tvaAmount || 0).toFixed(2)} ‚Ç¨</p>
                          </div>
                          <div>
                            <p className="text-blue-600">{t('totalTTC')}</p>
                            <p className="font-bold text-xl text-blue-800">{quoteData.grandTotal.toFixed(2)} ‚Ç¨</p>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* Shipping Info (if shipped) */}
                    {shippingData.trackingNumber && (
                      <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 className="font-bold text-green-800 mb-2">{lang === 'en' ? "üöö Shipping Information" : "üöö Informations d'exp√©dition"}</h3>
                        <div className="grid grid-cols-2 gap-4 text-sm">
                          <div>
                            <p className="text-green-600">{lang === 'en' ? 'UPS Tracking #' : 'N¬∞ Suivi UPS'}</p>
                            <a 
                              href={`https://www.ups.com/track?tracknum=${shippingData.trackingNumber}`} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="font-mono font-bold text-green-800 hover:underline"
                            >
                              {shippingData.trackingNumber} ‚Üí
                            </a>
                          </div>
                          <div>
                            <p className="text-green-600">{t('blNumber')}</p>
                            <p className="font-mono font-bold text-green-800">{shippingData.blNumber}</p>
                          </div>
                          <div>
                            <p className="text-green-600">{lang === 'en' ? 'Parcels' : 'Colis'}</p>
                            <p className="font-bold text-green-800">{shippingData.parcels}</p>
                          </div>
                          <div>
                            <p className="text-green-600">{lang === 'en' ? 'Weight' : 'Poids'}</p>
                            <p className="font-bold text-green-800">{shippingData.weight} kg</p>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* Order Info */}
                    <div className="grid grid-cols-2 gap-4">
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Submitted on' : 'Soumis le'}</p>
                        <p className="font-medium">{new Date(order.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR', { dateStyle: 'full' })}</p>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Urgent' : 'Urgence'}</p>
                        <p className="font-medium">{order.urgency || 'Normal'}</p>
                      </div>
                      {order.quote_number && (
                        <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                          <p className="text-xs text-blue-500 uppercase">{t('quoteNumber')}</p>
                          <p className="font-mono font-bold text-blue-700">{order.quote_number}</p>
                        </div>
                      )}
                      {order.bc_number && (
                        <div className="bg-green-50 rounded-lg p-3 border border-green-200">
                          <p className="text-xs text-green-500 uppercase">{lang === 'en' ? 'PO Number' : 'N¬∞ Bon de Commande'}</p>
                          <p className="font-mono font-bold text-green-700">{order.bc_number}</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}
                
                {/* Messages Tab */}
                {activeTab === 'messages' && (
                  <div className="space-y-4">
                    <h3 className="font-bold text-gray-800">{lang === 'en' ? 'üí¨ Messages with client' : 'üí¨ Messages avec le client'}</h3>
                    
                    {/* Messages List */}
                    <div className="space-y-3 max-h-96 overflow-y-auto">
                      {messages.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">{t('noMessages')}</p>
                      ) : messages.map(msg => (
                        <div 
                          key={msg.id}
                          className={`p-3 rounded-lg ${msg.sender_type === 'admin' ? 'bg-blue-50 ml-8' : 'bg-gray-100 mr-8'}`}
                        >
                          <div className="flex justify-between items-start mb-1">
                            <span className={`text-xs font-medium ${msg.sender_type === 'admin' ? 'text-blue-600' : 'text-gray-600'}`}>
                              {msg.sender_name || (msg.sender_type === 'admin' ? 'Admin' : 'Client')}
                            </span>
                            <span className="text-xs text-gray-400">
                              {new Date(msg.created_at).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR')}
                            </span>
                          </div>
                          <p className="text-gray-800 whitespace-pre-wrap">{msg.message}</p>
                        </div>
                      ))}
                    </div>
                    
                    {/* New Message */}
                    <div className="pt-4 border-t">
                      <textarea
                        value={newMessage}
                        onChange={e => setNewMessage(e.target.value)}
                        placeholder={t("typeMessage")}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none h-20"
                      />
                      <div className="flex justify-between items-center mt-2">
                        <TechTranslateButton onInsert={(text) => setNewMessage(prev => prev ? prev + '\n' + text : text)} lang={lang} />
                        <button
                          onClick={sendMessage}
                          disabled={sendingMessage || !newMessage.trim()}
                          className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium disabled:opacity-50"
                        >
                          {sendingMessage ? '...' : (lang === 'en' ? 'üì§ Send' : 'üì§ Envoyer')}
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Documents Tab */}
                {activeTab === 'documents' && (
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <h3 className="font-bold text-gray-800">{lang === 'en' ? 'üìÑ Documents' : 'üìÑ Documents'}</h3>
                      <button
                        onClick={() => setShowDocUploadModal(true)}
                        className="px-4 py-2 bg-[#2D5A7B] hover:bg-[#2a5490] text-white rounded-lg text-sm font-medium flex items-center gap-2"
                      >
                        ‚ûï Ajouter
                      </button>
                    </div>
                    
                    {/* System Documents */}
                    <div className="space-y-2">
                      {/* Devis */}
                      {order.quote_url && (
                        <a href={order.quote_url} target="_blank" rel="noopener noreferrer" 
                          className="flex items-center gap-4 p-4 border rounded-lg hover:bg-blue-50 transition-colors">
                          <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üí∞</div>
                          <div>
                            <p className="font-medium text-gray-800">{t('quote')}</p>
                            <p className="text-sm text-blue-600">{order.quote_number ? `N¬∞ ${order.quote_number}` : order.request_number}</p>
                          </div>
                        </a>
                      )}
                      
                      {/* Devis Sign√© / BC */}
                      {order.signed_quote_url && order.signed_quote_url !== order.quote_url && (
                        <a href={order.signed_quote_url} target="_blank" rel="noopener noreferrer" 
                          className="flex items-center gap-4 p-4 border rounded-lg hover:bg-green-50 transition-colors border-green-200">
                          <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl shrink-0">‚úÖ</div>
                          <div>
                            <p className="font-medium text-gray-800">{lang === 'en' ? 'Signed Quote / PO' : 'Devis Sign√© / BC'}</p>
                            <p className="text-sm text-green-600">{order.bc_number ? `N¬∞ ${order.bc_number}` : (lang === 'en' ? 'Signed' : 'Sign√©')}</p>
                          </div>
                        </a>
                      )}
                      
                      {/* BC Upload√© (separate file from client) */}
                      {order.bc_file_url && order.bc_file_url !== order.signed_quote_url && (
                        <a href={order.bc_file_url} target="_blank" rel="noopener noreferrer" 
                          className="flex items-center gap-4 p-4 border rounded-lg hover:bg-purple-50 transition-colors border-purple-200">
                          <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìù</div>
                          <div>
                            <p className="font-medium text-gray-800">{lang === 'en' ? 'Client Purchase Order' : 'Bon de Commande Client'}</p>
                            <p className="text-sm text-purple-600">{order.bc_number ? `N¬∞ ${order.bc_number}` : 'BC client'}</p>
                          </div>
                        </a>
                      )}
                      
                      {/* UPS Label */}
                      {shippingData.upsLabelUrl && (
                        <a href={shippingData.upsLabelUrl} target="_blank" rel="noopener noreferrer" 
                          className="flex items-center gap-4 p-4 border rounded-lg hover:bg-amber-50 transition-colors border-amber-200">
                          <div className="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üè∑Ô∏è</div>
                          <div>
                            <p className="font-medium text-gray-800">{lang === 'en' ? 'UPS Label' : '√âtiquette UPS'}</p>
                            <p className="text-sm text-amber-600">{shippingData.trackingNumber}</p>
                          </div>
                        </a>
                      )}
                      
                      {/* Bon de Livraison */}
                      {shippingData.blUrl && (
                        <a href={shippingData.blUrl} target="_blank" rel="noopener noreferrer" 
                          className="flex items-center gap-4 p-4 border rounded-lg hover:bg-indigo-50 transition-colors border-indigo-200">
                          <div className="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìã</div>
                          <div>
                            <p className="font-medium text-gray-800">{t('deliveryNote')}</p>
                            <p className="text-sm text-indigo-600">{shippingData.blNumber ? `N¬∞ ${shippingData.blNumber}` : 'BL'}</p>
                          </div>
                        </a>
                      )}

                      {/* Invoices */}
                      {orderInvoices.map(inv => (
                        <a key={inv.id} href={inv.pdf_url} target="_blank" rel="noopener noreferrer"
                          className={`flex items-center gap-4 p-4 border rounded-lg transition-colors ${
                            inv.status === 'paid' ? 'hover:bg-green-50 border-green-200' :
                            new Date(inv.due_date) < new Date() ? 'hover:bg-red-50 border-red-200' :
                            'hover:bg-amber-50 border-amber-200'
                          }`}>
                          <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-2xl shrink-0 ${
                            inv.status === 'paid' ? 'bg-green-100' :
                            new Date(inv.due_date) < new Date() ? 'bg-red-100' : 'bg-amber-100'
                          }`}>üìã</div>
                          <div className="flex-1">
                            <p className="font-medium text-gray-800">{lang === 'en' ? 'Invoice' : 'Facture'}</p>
                            <p className={`text-sm ${
                              inv.status === 'paid' ? 'text-green-600' :
                              new Date(inv.due_date) < new Date() ? 'text-red-600' : 'text-amber-600'
                            }`}>
                              N¬∞ {inv.invoice_number} ‚Äî {parseFloat(inv.total_ttc || 0).toFixed(2)} ‚Ç¨ TTC
                              {inv.status === 'paid' ? ' ‚úÖ' : 
                               new Date(inv.due_date) < new Date() ? (lang === 'en' ? ' ‚ö†Ô∏è Overdue' : ' ‚ö†Ô∏è En retard') : ''}
                            </p>
                          </div>
                        </a>
                      ))}
                    </div>
                    
                    {/* Uploaded Documents with manage controls */}
                    {(() => {
                      const shownUrls = [order.quote_url, order.signed_quote_url, order.bc_file_url, shippingData.upsLabelUrl, shippingData.blUrl].filter(Boolean);
                      const customDocs = attachments.filter(att => !shownUrls.includes(att.file_url));
                      if (customDocs.length === 0) return null;
                      
                      return (
                        <div className="mt-4">
                          <h4 className="text-sm font-medium text-gray-600 mb-2">{lang === 'en' ? 'Files added' : 'Fichiers ajout√©s'}</h4>
                          <div className="space-y-2">
                            {customDocs.map(doc => {
                              const isInternal = doc.category?.startsWith('internal_');
                              return (
                                <div key={doc.id} className={`flex items-center gap-3 p-3 rounded-lg border ${isInternal ? 'bg-amber-50 border-amber-200' : 'bg-white'}`}>
                                  <a href={doc.file_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 flex-1 min-w-0 hover:text-blue-600">
                                    <span className="text-xl shrink-0">
                                      {doc.file_type?.includes('pdf') ? 'üìÑ' : doc.file_type?.includes('image') ? 'üñºÔ∏è' : 'üìé'}
                                    </span>
                                    <div className="min-w-0">
                                      <p className="font-medium text-sm truncate">{doc.file_name}</p>
                                      <p className="text-xs text-gray-500">
                                        {new Date(doc.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                                        {isInternal && <span className="ml-2 text-amber-600 font-medium">{lang === 'en' ? 'üîí Internal' : 'üîí Interne'}</span>}
                                        {!isInternal && <span className="ml-2 text-green-600">{lang === 'en' ? 'üëÅÔ∏è Visible to client' : 'üëÅÔ∏è Visible client'}</span>}
                                      </p>
                                    </div>
                                  </a>
                                  <div className="flex items-center gap-1 shrink-0">
                                    <button
                                      onClick={() => handleToggleDocVisibility(doc)}
                                      className={`p-1.5 rounded-lg text-xs ${isInternal ? 'bg-green-100 hover:bg-green-200 text-green-700' : 'bg-amber-100 hover:bg-amber-200 text-amber-700'}`}
                                      title={isInternal ? (lang === 'en' ? 'Make visible' : 'Rendre visible') : (lang === 'en' ? 'Hide' : 'Masquer')}
                                    >
                                      {isInternal ? 'üëÅÔ∏è' : 'üîí'}
                                    </button>
                                    <button
                                      onClick={() => handleDocDelete(doc.id)}
                                      className="p-1.5 rounded-lg bg-red-100 hover:bg-red-200 text-red-600 text-xs"
                                      title={lang === "en" ? "Delete" : "Supprimer"}
                                    >
                                      üóëÔ∏è
                                    </button>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })()}
                    
                    {!order.quote_url && !order.signed_quote_url && !order.bc_file_url && attachments.length === 0 && (
                      <p className="text-gray-500 text-center py-8">{lang === 'en' ? 'No documents available' : 'Aucun document disponible'}</p>
                    )}
                    
                    {/* Document Upload Modal */}
                    {showDocUploadModal && (
                      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl max-w-md w-full">
                          <div className="p-6 border-b border-gray-200">
                            <div className="flex justify-between items-center">
                              <h2 className="text-lg font-bold text-[#2D5A7B]">{lang === 'en' ? 'üìÑ Add a document' : 'üìÑ Ajouter un document'}</h2>
                              <button onClick={() => { setShowDocUploadModal(false); setDocUploadFile(null); setDocUploadName(''); }} className="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                            </div>
                          </div>
                          <div className="p-6 space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'File' : 'Fichier'}</label>
                              <input 
                                type="file" 
                                onChange={(e) => {
                                  const f = e.target.files?.[0];
                                  if (f) { setDocUploadFile(f); if (!docUploadName) setDocUploadName(f.name); }
                                }}
                                className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Display name' : 'Nom affich√©'}</label>
                              <input 
                                type="text"
                                value={docUploadName}
                                onChange={(e) => setDocUploadName(e.target.value)}
                                placeholder={lang === 'en' ? 'Document name...' : 'Nom du document...'}
                                className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">{t('type')}</label>
                              <select 
                                value={docUploadCategory}
                                onChange={(e) => setDocUploadCategory(e.target.value)}
                                className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                              >
                                <option value="general">{lang === 'en' ? 'üìÑ General Document' : 'üìÑ Document g√©n√©ral'}</option>
                                <option value="rapport">{lang === 'en' ? 'üìã Report' : 'üìã Rapport'}</option>
                                <option value="bon_livraison">{lang === 'en' ? 'üì¶ Delivery Note' : 'üì¶ Bon de livraison'}</option>
                                <option value="facture">{lang === 'en' ? 'üìã Invoice' : 'üìã Facture'}</option>
                                <option value="note_technique">{lang === 'en' ? 'üîß Technical Note' : 'üîß Note technique'}</option>
                                <option value="correspondance">{lang === 'en' ? '‚úâÔ∏è Correspondence' : '‚úâÔ∏è Correspondance'}</option>
                              </select>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                              <div>
                                <p className="font-medium text-sm text-gray-800">
                                  {docUploadShared ? (lang === 'en' ? 'üëÅÔ∏è Visible to client' : 'üëÅÔ∏è Visible au client') : (lang === 'en' ? 'üîí Internal document' : 'üîí Document interne')}
                                </p>
                                <p className="text-xs text-gray-500">
                                  {docUploadShared ? (lang === 'en' ? 'Client will be able to see this document' : 'Le client pourra voir ce document') : (lang === 'en' ? 'Only admins will see this document' : 'Seuls les admins verront ce document')}
                                </p>
                              </div>
                              <button 
                                onClick={() => setDocUploadShared(!docUploadShared)}
                                className={`relative w-12 h-6 rounded-full transition-colors ${docUploadShared ? 'bg-blue-500' : 'bg-gray-300'}`}
                              >
                                <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${docUploadShared ? 'translate-x-6' : 'translate-x-0.5'}`} />
                              </button>
                            </div>
                          </div>
                          <div className="p-6 border-t border-gray-200 flex gap-3">
                            <button 
                              onClick={() => { setShowDocUploadModal(false); setDocUploadFile(null); setDocUploadName(''); }}
                              className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium"
                            >
                              Annuler
                            </button>
                            <button 
                              onClick={handleDocUpload}
                              disabled={!docUploadFile || docUploading}
                              className="flex-1 px-4 py-2 bg-[#2D5A7B] hover:bg-[#2a5490] text-white rounded-lg font-medium disabled:opacity-50"
                            >
                              {docUploading ? (lang === 'en' ? '‚è≥ Uploading...' : '‚è≥ Envoi...') : (lang === 'en' ? 'üì§ Upload' : 'üì§ Envoyer')}
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}
                
                {/* History Tab */}
                {activeTab === 'history' && (
                  <div className="space-y-4">
                    <h3 className="font-bold text-gray-800">{lang === 'en' ? 'üìú History' : 'üìú Historique'}</h3>
                    
                    <div className="space-y-3">
                      {/* Build history from timestamps */}
                      {[
                        order.shipped_at && { date: order.shipped_at, label: lang === 'en' ? 'Shipped' : 'Exp√©di√©', icon: 'üöö', color: 'green' },
                        order.bc_approved_at && { date: order.bc_approved_at, label: lang === 'en' ? 'PO Approved' : 'BC Approuv√©', icon: '‚úÖ', color: 'green' },
                        order.bc_submitted_at && { date: order.bc_submitted_at, label: lang === 'en' ? 'PO Submitted' : 'BC Soumis', icon: '‚úçÔ∏è', color: 'blue' },
                        order.quote_sent_at && { date: order.quote_sent_at, label: lang === 'en' ? 'Quote Sent' : 'Devis envoy√©', icon: 'üí∞', color: 'purple' },
                        order.created_at && { date: order.created_at, label: lang === 'en' ? 'Request Created' : 'Demande cr√©√©e', icon: 'üìã', color: 'gray' }
                      ].filter(Boolean).sort((a, b) => new Date(b.date) - new Date(a.date)).map((event, idx) => (
                        <div key={idx} className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border">
                          <span className="text-xl">{event.icon}</span>
                          <div>
                            <p className="font-medium text-gray-800">{event.label}</p>
                            <p className="text-sm text-gray-500">
                              {new Date(event.date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR', { dateStyle: 'full' })} √† {new Date(event.date).toLocaleTimeString(lang === 'en' ? 'en-US' : 'fr-FR', { hour: '2-digit', minute: '2-digit' })}
                            </p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
          
          {/* Right Column - Client Info & Actions */}
          <div className="space-y-6">
            {/* Client Info Card */}
            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <div className="bg-gradient-to-r from-[#2D5A7B] to-[#2d4a6f] px-4 py-3">
                <h3 className="font-bold text-white">{lang === 'en' ? 'üè¢ Client' : 'üè¢ Client'}</h3>
              </div>
              <div className="p-4 space-y-3">
                <div>
                  <p className="text-xs text-gray-500 uppercase tracking-wide">{t('company')}</p>
                  <p className="font-bold text-gray-800">{company.name || '‚Äî'}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500 uppercase tracking-wide">{lang === 'en' ? 'Contact' : 'Contact'}</p>
                  <p className="font-medium text-gray-700">{company.contact_name || '‚Äî'}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500 uppercase tracking-wide">{t('phone')}</p>
                  <p className="font-medium text-gray-700">{company.phone || '‚Äî'}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500 uppercase tracking-wide">{t('email')}</p>
                  <p className="font-medium text-gray-700 truncate">{company.email || '‚Äî'}</p>
                </div>
                <div className="pt-2 border-t">
                  <p className="text-xs text-gray-500 uppercase tracking-wide mb-1">{t('address')}</p>
                  <p className="text-sm text-gray-700">
                    {company.address || company.billing_address || '‚Äî'}
                    {(company.postal_code || company.billing_postal_code) && `, ${company.postal_code || company.billing_postal_code}`}
                    {(company.city || company.billing_city) && ` ${company.city || company.billing_city}`}
                    {company.country && `, ${company.country}`}
                  </p>
                </div>
              </div>
            </div>
            
            {/* Quick Actions Card */}
            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <div className="bg-amber-500 px-4 py-3">
                <h3 className="font-bold text-white">{lang === 'en' ? '‚ö° Quick actions' : '‚ö° Actions rapides'}</h3>
              </div>
              <div className="p-4 space-y-2">
                {(order.status === 'submitted' || order.status === 'quote_revision_requested' || (order.quote_rejection_notes && order.status === 'rma_created')) && (
                  <button
                    onClick={() => onOpenQuoteEditor(order)}
                    className="w-full px-4 py-2 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-medium"
                  >
                    {lang === 'en' ? 'üí∞ Create/Revise Quote' : 'üí∞ Cr√©er/R√©viser Devis'}
                  </button>
                )}
                
                {order.status === 'bc_review' && (
                  <button
                    onClick={() => {
                      notify(lang === 'en' ? 'Use the PO to review tab in the list' : "Utilisez l'onglet BC √† v√©rifier dans la liste");
                    }}
                    className="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium"
                  >
                    üîç Examiner BC
                  </button>
                )}
                
                {order.status === 'in_progress' && (
                  <button
                    onClick={() => updateStatus('ready_to_ship')}
                    disabled={saving}
                    className="w-full px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-medium disabled:opacity-50"
                  >
                    {lang === 'en' ? 'üöö Mark Ready to Ship' : 'üöö Marquer Pr√™t √† Exp√©dier'}
                  </button>
                )}
                
                {order.status === 'ready_to_ship' && (
                  <button
                    onClick={() => setShowShipping(true)}
                    className="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium"
                  >
                    {lang === 'en' ? 'üì¶ Create Shipment & DN' : 'üì¶ Cr√©er Exp√©dition & BL'}
                  </button>
                )}
                
                {shippingData.trackingNumber && (
                  <a
                    href={`https://www.ups.com/track?tracknum=${shippingData.trackingNumber}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="block w-full px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium text-center"
                  >
                    üìç Suivre colis UPS
                  </a>
                )}
              </div>
            </div>
            
            {/* Signature Card (if BC signed) */}
            {order.bc_signature_url && (
              <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div className="bg-green-500 px-4 py-3">
                  <h3 className="font-bold text-white">{lang === 'en' ? '‚úçÔ∏è Signature' : '‚úçÔ∏è Signature'}</h3>
                </div>
                <div className="p-4">
                  <img src={order.bc_signature_url} alt="Signature" className="max-h-20 mx-auto bg-gray-50 rounded p-2 border" />
                  <p className="text-center text-sm text-gray-500 mt-2">
                    {order.bc_signed_by || '‚Äî'} {order.bc_signature_date && `‚Ä¢ ${new Date(order.bc_signature_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}`}
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


// ============================================
// PARTS ORDERS SHEET - Manage spare parts orders
// ============================================
function PartsOrdersSheet({ requests, notify, reload, profile, businessSettings, t = k=>k, lang = 'fr' }) {
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [quoteOrder, setQuoteOrder] = useState(null);
  const [bcReviewOrder, setBcReviewOrder] = useState(null);
  const [processOrder, setProcessOrder] = useState(null);
  const [fullPageOrder, setFullPageOrder] = useState(null);
  const [filter, setFilter] = useState(null);
  
  // Categorize orders
  const pendingOrders = requests.filter(r => r.status === 'submitted' && !r.request_number);
  const revisionOrders = requests.filter(r => r.status === 'quote_revision_requested');
  const quoteSentOrders = requests.filter(r => r.status === 'quote_sent');
  const bcReviewOrders = requests.filter(r => r.status === 'bc_review');
  const inProgressOrders = requests.filter(r => r.status === 'in_progress');
  const readyToShipOrders = requests.filter(r => r.status === 'ready_to_ship');
  const shippedOrders = requests.filter(r => ['shipped', 'delivered', 'completed'].includes(r.status));
  
  const allPending = [...revisionOrders, ...pendingOrders];
  const activeOrders = requests.filter(r => !['shipped', 'delivered', 'completed'].includes(r.status));

  // Parts order status styles
  const PARTS_STATUS = {
    submitted: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'New' : 'Nouvelle' },
    quote_sent: { bg: 'bg-purple-100', text: 'text-purple-700', label: lang === 'en' ? 'Quote Sent' : 'Devis envoy√©' },
    pending_quote_review: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'Quote Under Review' : 'Devis en v√©rification' },
    quote_revision_requested: { bg: 'bg-red-100', text: 'text-red-700', label: lang === 'en' ? 'Revision' : 'R√©vision' },
    bc_review: { bg: 'bg-blue-100', text: 'text-blue-700', label: lang === 'en' ? 'PO to Review' : 'BC √† v√©rifier' },
    in_progress: { bg: 'bg-orange-100', text: 'text-orange-700', label: lang === 'en' ? 'In progress' : 'En cours' },
    ready_to_ship: { bg: 'bg-indigo-100', text: 'text-indigo-700', label: lang === 'en' ? 'Ready' : 'Pr√™t' },
    shipped: { bg: 'bg-green-100', text: 'text-green-700', label: t('stShipped') },
    delivered: { bg: 'bg-green-100', text: 'text-green-700', label: lang === 'en' ? 'Delivered' : 'Livr√©' },
    completed: { bg: 'bg-green-100', text: 'text-green-700', label: lang === 'en' ? 'Completed' : 'Termin√©' }
  };
  
  // Stats cards for filtering
  const stats = [
    { id: 'pending', label: lang === 'en' ? 'To Process' : '√Ä traiter', value: allPending.length, color: 'bg-amber-500', icon: 'üìã' },
    { id: 'bc', label: lang === 'en' ? 'PO to Review' : 'BC √† v√©rifier', value: bcReviewOrders.length, color: 'bg-red-500', icon: 'üìÑ' },
    { id: 'quote_sent', label: lang === 'en' ? 'Quotes Sent' : 'Devis envoy√©s', value: quoteSentOrders.length, color: 'bg-purple-500', icon: 'üí∞' },
    { id: 'in_progress', label: lang === 'en' ? 'In progress' : 'En cours', value: inProgressOrders.length, color: 'bg-orange-500', icon: 'üì¶' },
    { id: 'ready', label: lang === 'en' ? 'Ready' : 'Pr√™t', value: readyToShipOrders.length, color: 'bg-indigo-500', icon: 'üöö' },
    { id: 'shipped', label: lang === 'en' ? 'Shipped' : 'Exp√©di√©es', value: shippedOrders.length, color: 'bg-green-500', icon: '‚úÖ' }
  ];
  
  // Orders for the table (excluding pending and bc_review which have their own sections)
  const tableOrders = activeOrders.filter(r => 
    r.status !== 'submitted' && 
    r.status !== 'quote_revision_requested' && 
    r.status !== 'bc_review'
  );
  
  // Filter orders
  const getFilteredOrders = () => {
    if (!filter) return tableOrders; // Default shows table orders only
    if (filter === 'pending') return allPending;
    if (filter === 'bc') return bcReviewOrders;
    if (filter === 'quote_sent') return quoteSentOrders;
    if (filter === 'in_progress') return inProgressOrders;
    if (filter === 'ready') return readyToShipOrders;
    if (filter === 'shipped') return shippedOrders;
    return tableOrders;
  };
  
  const filteredOrders = getFilteredOrders();
  const filterLabel = filter ? stats.find(s => s.id === filter)?.label : null;
  
  // For the table, we show different orders based on filter
  const showTable = !filter || (filter !== 'bc' && filter !== 'pending');

  // If a full page order is selected, show the full page view
  if (fullPageOrder) {
    return (
      <PartsOrderFullPage
        order={fullPageOrder}
        onBack={() => setFullPageOrder(null)}
        notify={notify}
        reload={reload}
        profile={profile}
        businessSettings={businessSettings}
        onOpenQuoteEditor={(o) => { setFullPageOrder(null); setQuoteOrder(o); }}
        t={t} lang={lang}
      />
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? 'üî© Parts Orders' : 'üî© Commandes de Pi√®ces'}</h1>
        <button onClick={reload} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">{lang === 'en' ? 'üîÑ Refresh' : 'üîÑ Actualiser'}</button>
      </div>
      
      {/* Stats Grid - Like RMA Dashboard */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        {stats.map((stat) => (
          <button 
            key={stat.id} 
            onClick={() => setFilter(filter === stat.id ? null : stat.id)}
            className={`bg-white rounded-xl p-4 shadow-sm text-left transition-all ${
              filter === stat.id ? 'ring-2 ring-offset-2 ring-blue-500' : 'hover:shadow-md'
            } ${stat.value > 0 && stat.id === 'bc' ? 'ring-2 ring-red-500 animate-pulse' : ''}`}
          >
            <div className="flex items-center gap-3">
              <div className={`w-12 h-12 ${stat.color} rounded-lg flex items-center justify-center text-2xl text-white`}>{stat.icon}</div>
              <div>
                <p className="text-2xl font-bold text-gray-800">{stat.value}</p>
                <p className="text-sm text-gray-500">{stat.label}</p>
              </div>
            </div>
          </button>
        ))}
      </div>
      
      {/* Active Filter Indicator */}
      {filter && (
        <div className="flex items-center gap-3 bg-blue-50 border border-blue-200 rounded-lg px-4 py-2">
          <span className="text-blue-700 font-medium">Filtre: {filterLabel}</span>
          <span className="text-blue-600">({filteredOrders.length} {lang === 'en' ? 'orders' : 'commandes'})</span>
          <button onClick={() => setFilter(null)} className="ml-auto text-blue-600 hover:text-blue-800 font-medium">{lang === 'en' ? '‚úï Clear' : '‚úï Effacer'}</button>
        </div>
      )}
      
      {/* BC Review Section - Keep the same as before */}
      {bcReviewOrders.length > 0 && (!filter || filter === 'bc') && (
        <div className="bg-red-50 border-2 border-red-300 rounded-xl shadow-lg">
          <div className="px-6 py-4 border-b border-red-200 bg-red-100 rounded-t-xl">
            <h2 className="font-bold text-red-800 text-lg">{lang === 'en' ? '‚ö†Ô∏è Purchase Orders to Review' : '‚ö†Ô∏è Bons de Commande √† V√©rifier'} ({bcReviewOrders.length})</h2>
            <p className="text-sm text-red-600">{lang === 'en' ? 'Click "Review" to verify the document and approve' : 'Cliquez sur "Examiner" pour v√©rifier le document et approuver'}</p>
          </div>
          <div className="p-4 space-y-3">
            {bcReviewOrders.map(order => (
              <div key={order.id} className="bg-white rounded-lg p-4 flex items-center justify-between shadow-sm border border-red-100">
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">üìÑ</div>
                  <div>
                    <span className="font-mono font-bold text-amber-600 text-lg">{order.request_number}</span>
                    <p className="font-medium text-gray-800">{order.companies?.name}</p>
                    <p className="text-sm text-gray-500">
                      BC soumis le {order.bc_submitted_at ? new Date(order.bc_submitted_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : new Date(order.updated_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                      {order.bc_signed_by && <span className="ml-2">‚Ä¢ {lang === 'en' ? 'Signed by' : 'Sign√© par'}: {order.bc_signed_by}</span>}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => setBcReviewOrder(order)}
                  className="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium flex items-center gap-2"
                >
                  üîç Examiner
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
      
      {/* NEW REQUESTS SECTION - Prominent like before */}
      {allPending.length > 0 && (!filter || filter === 'pending') && (
        <div className="bg-amber-50 border-2 border-amber-300 rounded-xl shadow-lg">
          <div className="px-6 py-4 border-b border-amber-200 bg-amber-100 rounded-t-xl">
            <h2 className="font-bold text-amber-800 text-lg">{lang === 'en' ? `üìã New Requests (${allPending.length})` : `üìã Nouvelles Demandes (${allPending.length})`}</h2>
            <p className="text-sm text-amber-600">{lang === 'en' ? 'Create a quote for these requests' : 'Cr√©ez un devis pour ces demandes'}</p>
          </div>
          <div className="p-4 space-y-3">
            {allPending.map(order => {
              const needsRevision = order.status === 'quote_revision_requested';
              return (
                <div 
                  key={order.id} 
                  className={`bg-white rounded-lg p-4 flex items-center justify-between shadow-sm border ${needsRevision ? 'border-red-300 bg-red-50' : 'border-amber-100'}`}
                >
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 ${needsRevision ? 'bg-red-500' : 'bg-amber-500'} rounded-lg flex items-center justify-center text-2xl text-white`}>
                      {needsRevision ? 'üî¥' : 'üì¶'}
                    </div>
                    <div>
                      <p className="font-bold text-gray-800">{order.companies?.name}</p>
                      <p className="text-sm text-gray-500">
                        {needsRevision ? (lang === 'en' ? 'Modification requested' : 'Modification demand√©e') : (lang === 'en' ? 'New order' : 'Nouvelle commande')} ‚Ä¢ {new Date(order.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                      </p>
                      {needsRevision && order.revision_notes && (
                        <p className="text-sm text-red-600 mt-1">üí¨ {order.revision_notes.substring(0, 100)}{order.revision_notes.length > 100 ? '...' : ''}</p>
                      )}
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <button 
                      onClick={() => setFullPageOrder(order)}
                      className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium"
                    >
                      Voir
                    </button>
                    <button 
                      onClick={() => setQuoteOrder(order)}
                      className={`px-6 py-2 ${needsRevision ? 'bg-red-500 hover:bg-red-600' : 'bg-[#00A651] hover:bg-[#008f45]'} text-white rounded-lg font-medium`}
                    >
                      üí∞ {needsRevision ? (lang === 'en' ? 'Revise Quote' : 'R√©viser Devis') : (lang === 'en' ? 'Create Quote' : 'Cr√©er Devis')}
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}
      
      {/* Orders Table - Like RMA Dashboard (exclude pending and bc_review from table since they have their own sections) */}
      {showTable && (
        <div className="bg-white rounded-xl shadow-sm">
          <div className="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
            <h2 className="font-bold text-gray-800">
              {filterLabel ? `${filterLabel} (${filteredOrders.length})` : (lang === 'en' ? `Other Orders (${tableOrders.length})` : `Autres Commandes (${tableOrders.length})`)}
            </h2>
          </div>
          
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Order #' : 'N¬∞ Commande'}</th>
                  <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('client')}</th>
                  <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Parts' : 'Pi√®ces'}</th>
                  <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('total')}</th>
                  <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Step' : '√âtape'}</th>
                  <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('date')}</th>
                  <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('actions')}</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {filteredOrders.length === 0 ? (
                  <tr><td colSpan={7} className="px-4 py-8 text-center text-gray-400">{lang === 'en' ? 'No orders' : 'Aucune commande'}</td></tr>
                ) : filteredOrders.map(order => {
                  const style = PARTS_STATUS[order.status] || PARTS_STATUS.submitted;
                  const quoteData = order.quote_data || {};
                  const partsCount = quoteData.parts?.length || 0;
                  const hasBCToReview = order.status === 'bc_review';
                  const needsQuote = order.status === 'submitted' || order.status === 'quote_revision_requested' || (order.quote_rejection_notes && order.status === 'rma_created');
                  
                  return (
                    <tr 
                      key={order.id} 
                      className={`hover:bg-gray-50 cursor-pointer ${hasBCToReview ? 'bg-red-50' : ''} ${order.status === 'quote_revision_requested' ? 'bg-red-50' : ''}`} 
                      onClick={() => !hasBCToReview && setFullPageOrder(order)}
                    >
                      <td className="px-4 py-3">
                        <span className="font-mono font-bold text-amber-600">{order.request_number || '‚Äî'}</span>
                        {order.status === 'quote_revision_requested' && <span className="ml-2 text-red-500 text-xs">üî¥</span>}
                      </td>
                      <td className="px-4 py-3"><p className="font-medium text-gray-800">{order.companies?.name || '‚Äî'}</p></td>
                      <td className="px-4 py-3">
                        {partsCount > 0 ? (
                          <span className="text-sm">{partsCount} {lang === 'en' ? 'part(s)' : 'pi√®ce(s)'}</span>
                        ) : (
                          <span className="text-gray-400 text-sm">{lang === 'en' ? 'To define' : '√Ä d√©finir'}</span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {quoteData.grandTotal ? (
                          <span className="font-medium">{quoteData.grandTotal.toFixed(2)} ‚Ç¨</span>
                        ) : (
                          <span className="text-gray-400">‚Äî</span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${style.bg} ${style.text}`}>{lang === 'en' && style.en ? style.en : style.label}</span>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-500">{new Date(order.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</td>
                      <td className="px-4 py-3">
                        {hasBCToReview ? (
                          <button 
                            onClick={(e) => { e.stopPropagation(); setBcReviewOrder(order); }} 
                            className="px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded"
                          >
                            üîç Examiner BC
                          </button>
                        ) : needsQuote ? (
                          <button 
                            onClick={(e) => { e.stopPropagation(); setQuoteOrder(order); }} 
                            className={`px-3 py-1 text-sm text-white rounded ${order.status === 'quote_revision_requested' ? 'bg-red-500 hover:bg-red-600' : 'bg-[#00A651] hover:bg-[#008f45]'}`}
                          >
                            üí∞ {order.status === 'quote_revision_requested' ? 'R√©viser' : (lang === 'en' ? 'Create Quote' : 'Cr√©er Devis')}
                          </button>
                        ) : (
                          <button 
                            onClick={(e) => { e.stopPropagation(); setFullPageOrder(order); }} 
                            className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded"
                          >
                            Voir ‚Üí
                          </button>
                        )}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      )}
      
      {/* Empty State */}
      {requests.length === 0 && (
        <div className="bg-white rounded-xl shadow-sm p-12 text-center">
          <p className="text-4xl mb-4">üì¶</p>
          <p className="text-gray-500 text-lg">{lang === 'en' ? 'No parts orders' : 'Aucune commande de pi√®ces'}</p>
          <p className="text-gray-400 text-sm mt-2">{lang === 'en' ? 'Client parts orders will appear here' : 'Les commandes de pi√®ces des clients appara√Ætront ici'}</p>
        </div>
      )}
      
      {/* Modals */}
      {selectedOrder && (
        <PartsOrderDetailModal lang={lang} 
          order={selectedOrder} 
          onClose={() => setSelectedOrder(null)} 
          onCreateQuote={() => { setSelectedOrder(null); setQuoteOrder(selectedOrder); }} 
        />
      )}
      {quoteOrder && (
        <PartsQuoteEditor lang={lang} 
          order={quoteOrder} 
          onClose={() => setQuoteOrder(null)} 
          notify={notify} 
          reload={reload} 
          profile={profile} 
        />
      )}
      {bcReviewOrder && (
        <PartsBCReviewModal
          order={bcReviewOrder}
          onClose={() => setBcReviewOrder(null)}
          notify={notify}
          reload={reload}
        />
      )}
      {processOrder && (
        <PartsProcessModal
          order={processOrder}
          onClose={() => setProcessOrder(null)}
          notify={notify}
          reload={reload}
          profile={profile}
        />
      )}
    </div>
  );
}
// ============================================
// PARTS BC REVIEW MODAL (identical to RMA BCReviewModal)
// ============================================
function PartsBCReviewModal({ order, onClose, notify, reload, lang = 'fr' }) {
  const t = k => k;
  const [approving, setApproving] = useState(false);
  const [rejecting, setRejecting] = useState(false);
  const [rejectReason, setRejectReason] = useState('');
  const [bcNumber, setBcNumber] = useState('');
  const [useAutoNumber, setUseAutoNumber] = useState(false);
  const [generatingNumber, setGeneratingNumber] = useState(false);
  const [attachments, setAttachments] = useState([]);
  
  // Fetch attachments
  useEffect(() => {
    const fetchAttachments = async () => {
      const { data } = await supabase
        .from('request_attachments')
        .select('*')
        .eq('request_id', order.id)
        .order('created_at', { ascending: false });
      if (data) {
        setAttachments(data);
        const hasRegularBc = !!order.bc_file_url && order.bc_file_url !== order.signed_quote_url;
        setUseAutoNumber(!hasRegularBc && !order.bc_file_url);
      }
    };
    fetchAttachments();
  }, [order.id]);
  
  // Auto-generate BC number
  useEffect(() => {
    if (useAutoNumber && !bcNumber) {
      generateBCNumber();
    }
  }, [useAutoNumber]);
  
  const generateBCNumber = async () => {
    setGeneratingNumber(true);
    try {
      const { data, error } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'BC' });
      if (!error && data) {
        setBcNumber(data);
      }
    } catch (e) {
      console.error('Could not generate BC number:', e);
    }
    setGeneratingNumber(false);
  };
  
  const approveBC = async () => {
    if (!bcNumber.trim()) {
      notify(lang === 'en' ? 'Please enter a PO number' : 'Veuillez entrer un num√©ro de BC', 'error');
      return;
    }
    setApproving(true);
    const { error } = await supabase
      .from('service_requests')
      .update({ 
        status: 'in_progress',
        bc_approved_at: new Date().toISOString(),
        bc_number: bcNumber
      })
      .eq('id', order.id);
    
    if (error) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
    } else {
      notify(lang === 'en' ? `‚úÖ PO # ${bcNumber} approved! Parts order initiated.` : `‚úÖ BC N¬∞ ${bcNumber} approuv√©! Commande de pi√®ces lanc√©e.`);
      reload();
      onClose();
    }
    setApproving(false);
  };
  
  const rejectBC = async () => {
    if (!rejectReason.trim()) {
      notify(lang === 'en' ? 'Please indicate the rejection reason' : 'Veuillez indiquer la raison du refus', 'error');
      return;
    }
    setRejecting(true);
    const { error } = await supabase
      .from('service_requests')
      .update({ 
        status: 'bc_rejected',
        bc_rejected_at: new Date().toISOString(),
        bc_rejection_reason: rejectReason,
        bc_file_url: null,
        bc_signature_url: null,
        bc_submitted_at: null
      })
      .eq('id', order.id);
    
    if (error) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
    } else {
      notify(lang === 'en' ? 'PO rejected. Client must submit a new PO.' : 'BC refus√©. Le client devra soumettre un nouveau BC.');
      reload();
      onClose();
    }
    setRejecting(false);
  };
  
  const quoteData = order.quote_data || {};
  const parts = quoteData.parts || [];
  
  // Get the document URL - prefer signed_quote_url (generated PDF with signature), then bc_file_url (uploaded BC)
  const documentUrl = order.signed_quote_url || order.bc_file_url;
  const documentType = order.signed_quote_url ? (lang === 'en' ? 'Signed Quote' : 'Devis Sign√©') : 'Bon de Commande';
  
  return (
    <div className="fixed inset-0 z-50 bg-black/80 flex" onClick={onClose}>
      <div className="bg-white w-full h-full max-w-[98vw] max-h-[98vh] m-auto rounded-xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white flex justify-between items-center flex-shrink-0">
          <div>
            <h2 className="text-xl font-bold">{lang === 'en' ? 'Purchase Order Verification' : 'V√©rification du Bon de Commande'}</h2>
            <p className="text-red-100">{order.request_number} ‚Ä¢ {order.companies?.name}</p>
          </div>
          <button onClick={onClose} className="text-white/70 hover:text-white text-3xl">&times;</button>
        </div>
        
        {/* Content */}
        <div className="flex-1 overflow-hidden flex">
          {/* Left: Document Preview - Takes most of the space */}
          <div className="flex-1 flex flex-col bg-gray-800 p-4">
            <div className="flex justify-between items-center mb-3">
              <h3 className="font-bold text-white text-lg">üìÑ {documentType}</h3>
              <div className="flex gap-2">
                {order.signed_quote_url && order.bc_file_url && order.signed_quote_url !== order.bc_file_url && (
                  <a href={order.bc_file_url} target="_blank" rel="noopener noreferrer" className="px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm">
                    BC upload√© ‚Üó
                  </a>
                )}
                {documentUrl && (
                  <a href={documentUrl} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium">
                    Ouvrir dans nouvel onglet ‚Üó
                  </a>
                )}
              </div>
            </div>
            
            {/* Document Preview - Full height PDF viewer */}
            {documentUrl ? (
              <div className="flex-1 rounded-lg overflow-hidden bg-white">
                {documentUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? (
                  <img src={documentUrl} alt="Document" className="w-full h-full object-contain" />
                ) : (
                  <object
                    data={`${documentUrl}#view=Fit`}
                    type="application/pdf"
                    className="w-full h-full"
                    style={{ minHeight: '100%' }}
                  >
                    <iframe 
                      src={`${documentUrl}#view=Fit`} 
                      className="w-full h-full" 
                      title="Document PDF"
                    />
                  </object>
                )}
              </div>
            ) : (
              <div className="flex-1 border-2 border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center text-gray-400">
                <div className="text-4xl mb-4">üìÑ</div>
                <p className="text-lg">{lang === 'en' ? 'No documents available' : 'Aucun document disponible'}</p>
                <p className="text-sm mt-2">{lang === 'en' ? 'Client has not yet submitted a signed PO' : "Le client n'a pas encore soumis de BC sign√©"}</p>
              </div>
            )}
          </div>
          
          {/* Right: Order Details - Sidebar */}
          <div className="w-96 flex-shrink-0 bg-gray-50 overflow-y-auto p-4 space-y-4">
            <h3 className="font-bold text-gray-800 text-lg">{lang === 'en' ? 'üìã Order Details' : 'üìã D√©tails de la Commande'}</h3>
            
            {/* Order Info */}
            <div className="bg-white rounded-lg p-4 border">
              <div className="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <p className="text-gray-500">{lang === 'en' ? 'Order #' : 'N¬∞ Commande'}</p>
                  <p className="font-mono font-bold text-amber-600">{order.request_number}</p>
                </div>
                <div>
                  <p className="text-gray-500">{t('type')}</p>
                  <p className="font-medium">{lang === 'en' ? 'Spare parts' : 'Pi√®ces d√©tach√©es'}</p>
                </div>
                <div>
                  <p className="text-gray-500">{lang === 'en' ? 'PO Submission' : 'Soumission BC'}</p>
                  <p className="font-medium">{order.bc_submitted_at ? new Date(order.bc_submitted_at).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') : '‚Äî'}</p>
                </div>
                <div>
                  <p className="text-gray-500">{t('client')}</p>
                  <p className="font-medium">{order.companies?.name}</p>
                </div>
              </div>
            </div>
            
            {/* Documents Available */}
            <div className="bg-white rounded-lg p-4 border">
              <h4 className="font-medium text-gray-700 mb-2">{lang === 'en' ? 'üìÅ Documents' : 'üìÅ Documents'}</h4>
              <div className="space-y-2 text-sm">
                {order.quote_url && (
                  <a href={order.quote_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-blue-600 hover:underline">
                    üìÑ Devis original ‚Üó
                  </a>
                )}
                {order.signed_quote_url && order.signed_quote_url !== order.quote_url && (
                  <a href={order.signed_quote_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-green-600 hover:underline">
                    ‚úÖ Devis sign√© ‚Üó
                  </a>
                )}
                {order.bc_file_url && order.bc_file_url !== order.signed_quote_url && order.bc_file_url !== order.quote_url && (
                  <a href={order.bc_file_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-purple-600 hover:underline">
                    üìé BC upload√© ‚Üó
                  </a>
                )}
              </div>
            </div>
            
            {/* Signature */}
            {order.bc_signature_url && (
              <div className="bg-white rounded-lg p-4 border">
                <h4 className="font-medium text-gray-700 mb-2">{lang === 'en' ? '‚úçÔ∏è Signature' : '‚úçÔ∏è Signature'}</h4>
                <img src={order.bc_signature_url} alt="Signature" className="max-h-20 mx-auto bg-gray-50 rounded p-2 border" />
                <p className="text-center text-xs text-gray-500 mt-1">
                  {order.bc_signed_by || '‚Äî'} {order.bc_signature_date && `‚Ä¢ ${new Date(order.bc_signature_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}`}
                </p>
              </div>
            )}
            
            {/* Parts */}
            <div className="bg-white rounded-lg p-4 border">
              <h4 className="font-medium text-gray-700 mb-2">üì¶ Pi√®ces ({parts.length})</h4>
              <div className="space-y-2 max-h-40 overflow-y-auto">
                {parts.map((p, i) => (
                  <div key={i} className="bg-gray-50 rounded p-2 text-sm">
                    <p className="font-medium">{p.description}</p>
                    <p className="text-gray-500">{lang === 'en' ? 'Ref' : 'R√©f'}: {p.partNumber || '‚Äî'} ‚Ä¢ {lang === 'en' ? 'Qty' : 'Qt√©'}: {p.quantity}</p>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Quote Info */}
            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
              <h4 className="font-medium text-blue-800 mb-1">{lang === 'en' ? 'üí∞ Quote' : 'üí∞ Devis'}</h4>
              <p className="text-xl font-bold text-blue-700">{(quoteData.grandTotal || 0).toFixed(2)} ‚Ç¨</p>
              {order.quote_url && (
                <a href={order.quote_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline text-sm">
                  Voir le devis ‚Üó
                </a>
              )}
            </div>
            
            {/* BC Number */}
            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
              <h4 className="font-medium text-green-800 mb-2">{lang === 'en' ? 'üìã PO Number' : 'üìã N¬∞ Bon de Commande'}</h4>
              {useAutoNumber ? (
                <div>
                  <div className="flex items-center gap-2 mb-2">
                    <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">{lang === 'en' ? 'Auto-generated' : 'Auto-g√©n√©r√©'}</span>
                    <span className="text-xs text-gray-500">{lang === 'en' ? "Client signed the quote" : "Client a sign√© le devis"}</span>
                  </div>
                  <input
                    type="text"
                    value={generatingNumber ? (lang === 'en' ? 'Generating...' : 'G√©n√©ration...') : bcNumber}
                    onChange={e => setBcNumber(e.target.value)}
                    className="w-full px-3 py-2 border border-green-300 rounded-lg text-center font-mono font-bold bg-white"
                    placeholder="BC-MMYY-NNN"
                  />
                </div>
              ) : (
                <div>
                  <p className="text-xs text-gray-500 mb-2">{lang === 'en' ? "Enter the client PO #" : "Entrez le N¬∞ BC du client"}</p>
                  <input
                    type="text"
                    value={bcNumber}
                    onChange={e => setBcNumber(e.target.value)}
                    className="w-full px-3 py-2 border border-green-300 rounded-lg text-center font-mono font-bold bg-white"
                    placeholder={lang === 'en' ? 'Client PO #...' : 'N¬∞ BC du client...'}
                  />
                  <button
                    onClick={generateBCNumber}
                    disabled={generatingNumber}
                    className="mt-2 w-full text-xs text-green-600 hover:text-green-800 underline"
                  >
                    {generatingNumber ? (lang === 'en' ? 'Generating...' : 'G√©n√©ration...') : (lang === 'en' ? 'Or generate automatic number' : 'Ou g√©n√©rer un num√©ro automatique')}
                  </button>
                </div>
              )}
            </div>
            
            {/* Reject Reason */}
            <div className="bg-red-50 rounded-lg p-4 border border-red-200">
              <h4 className="font-medium text-red-800 mb-2">{lang === 'en' ? 'Reject the PO?' : 'Refuser le BC?'}</h4>
              <textarea
                value={rejectReason}
                onChange={e => setRejectReason(e.target.value)}
                placeholder={lang === 'en' ? 'Rejection reason...' : 'Raison du refus...'}
                className="w-full px-3 py-2 border border-red-300 rounded-lg text-sm h-20 resize-none"
              />
            </div>
            
            {/* Actions */}
            <div className="space-y-2 pt-2">
              <button
                onClick={approveBC}
                disabled={approving}
                className="w-full px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold disabled:opacity-50"
              >
                {approving ? (lang === 'en' ? 'Approving...' : 'Approbation...') : (lang === 'en' ? '‚úÖ Approve PO' : '‚úÖ Approuver BC')}
              </button>
              <button
                onClick={rejectBC}
                disabled={rejecting}
                className="w-full px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium disabled:opacity-50"
              >
                {rejecting ? 'Refus...' : '‚ùå Refuser BC'}
              </button>
              <button onClick={onClose} className="w-full px-6 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
                Annuler
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// PARTS PROCESS MODAL (for approved orders)
// ============================================
function PartsProcessModal({ order, onClose, notify, reload, profile, lang = 'fr' }) {
  const t = k => k;
  const [saving, setSaving] = useState(false);
  const [showShipping, setShowShipping] = useState(false);
  
  const quoteData = order.quote_data || {};
  const parts = quoteData.parts || [];
  
  const updateStatus = async (newStatus, extraFields = {}) => {
    setSaving(true);
    try {
      const { error } = await supabase
        .from('service_requests')
        .update({
          status: newStatus,
          ...extraFields
        })
        .eq('id', order.id);
      
      if (error) throw error;
      
      notify((lang === 'en' ? 'Status updated' : 'Statut mis √† jour'));
      reload();
      if (newStatus !== 'ready_to_ship') onClose();
    } catch (err) {
      notify(lang === 'en' ? `Error: ${err.message}` : `Erreur: ${err.message}`, 'error');
    }
    setSaving(false);
  };
  
  if (showShipping) {
    return (
      <PartsShippingModal
        order={order}
        onClose={() => { setShowShipping(false); onClose(); }}
        notify={notify}
        reload={reload}
        profile={profile}
      />
    );
  }
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
      <div className="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="px-6 py-4 border-b bg-gradient-to-r from-orange-500 to-amber-500 text-white">
          <div className="flex justify-between items-center">
            <div>
              <h2 className="text-xl font-bold">{lang === 'en' ? 'üöÄ Order Processing' : 'üöÄ Traitement Commande'}</h2>
              <p className="text-orange-100">{order.request_number} ‚Ä¢ {order.companies?.name}</p>
            </div>
            <button onClick={onClose} className="text-white/80 hover:text-white text-2xl">&times;</button>
          </div>
        </div>
        
        {/* Progress */}
        <div className="px-6 py-4 border-b bg-gray-50">
          <div className="flex items-center justify-between">
            {[
              { id: 'in_progress', label: lang === 'en' ? 'In progress' : 'En cours', icon: 'üì¶' },
              { id: 'ready_to_ship', label: lang === 'en' ? 'Ready' : 'Pr√™t', icon: 'üöö' },
              { id: 'shipped', label: lang === 'en' ? 'Shipped' : 'Exp√©di√©', icon: '‚úÖ' }
            ].map((step, idx) => {
              const statusOrder = ['in_progress', 'ready_to_ship', 'shipped'];
              const currentIdx = statusOrder.indexOf(order.status);
              const stepIdx = statusOrder.indexOf(step.id);
              const isComplete = currentIdx >= stepIdx;
              const isCurrent = order.status === step.id;
              
              return (
                <div key={step.id} className="flex items-center">
                  <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${
                    isCurrent ? 'bg-orange-500 text-white ring-4 ring-orange-200' :
                    isComplete ? 'bg-green-500 text-white' : 'bg-gray-200'
                  }`}>
                    {isComplete && !isCurrent ? '‚úì' : step.icon}
                  </div>
                  <span className={`ml-2 text-sm ${isCurrent ? 'font-bold text-orange-700' : isComplete ? 'text-green-700' : 'text-gray-400'}`}>
                    {step.label}
                  </span>
                  {idx < 3 && <div className={`w-8 h-1 mx-2 ${isComplete && !isCurrent ? 'bg-green-500' : 'bg-gray-200'}`} />}
                </div>
              );
            })}
          </div>
        </div>
        
        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* Parts List */}
          <div>
            <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'üì¶ Parts to Ship' : 'üì¶ Pi√®ces √† exp√©dier'}</h3>
            <div className="bg-amber-50 rounded-lg p-4 space-y-2">
              {parts.map((part, idx) => (
                <div key={idx} className="flex justify-between items-center bg-white rounded p-2">
                  <div>
                    <span className="font-mono text-sm text-amber-700">{part.partNumber || '‚Äî'}</span>
                    <span className="ml-2 text-gray-600">{part.description}</span>
                  </div>
                  <span className="font-bold">x{part.quantity}</span>
                </div>
              ))}
            </div>
          </div>
          
          {/* Action based on status */}
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
            {order.status === 'in_progress' && (
              <>
                <h4 className="font-bold text-blue-800 mb-2">{lang === 'en' ? 'üì¶ Order being processed' : 'üì¶ Commande en cours de traitement'}</h4>
                <p className="text-blue-600 text-sm mb-4">{lang === 'en' ? 'When parts are ready, mark as ready to ship.' : 'Quand les pi√®ces sont pr√™tes, marquez comme pr√™t √† exp√©dier.'}</p>
                <button
                  onClick={() => updateStatus('ready_to_ship', {})}
                  disabled={saving}
                  className="w-full px-4 py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-bold disabled:opacity-50"
                >
                  {saving ? '...' : (lang === 'en' ? 'üöö Mark Ready to Ship' : 'üöö Marquer Pr√™t √† Exp√©dier')}
                </button>
              </>
            )}
            
            {order.status === 'ready_to_ship' && (
              <>
                <h4 className="font-bold text-blue-800 mb-2">{lang === 'en' ? 'üöö Ready to Ship' : 'üöö Pr√™t √† exp√©dier'}</h4>
                <p className="text-blue-600 text-sm mb-4">{lang === 'en' ? "Create the UPS label and delivery note." : "Cr√©ez l'√©tiquette UPS et le bon de livraison."}</p>
                <button
                  onClick={() => setShowShipping(true)}
                  className="w-full px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold"
                >
                  {lang === 'en' ? 'üì¶ Create Shipment & DN' : 'üì¶ Cr√©er Exp√©dition & BL'}
                </button>
              </>
            )}
          </div>
          
          {/* Documents Section */}
          <div className="bg-gray-50 rounded-lg p-4 border">
            <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'üìÅ Documents' : 'üìÅ Documents'}</h3>
            <div className="grid grid-cols-2 gap-3">
              {order.quote_url && (
                <a href={order.quote_url} target="_blank" rel="noopener noreferrer" 
                  className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-blue-50 hover:border-blue-300 transition-colors">
                  <span className="text-2xl">üìÑ</span>
                  <div>
                    <p className="font-medium text-gray-800">{t('quote')}</p>
                    <p className="text-xs text-gray-500">{lang === 'en' ? 'Original' : 'Original'}</p>
                  </div>
                </a>
              )}
              {order.signed_quote_url && order.signed_quote_url !== order.quote_url && (
                <a href={order.signed_quote_url} target="_blank" rel="noopener noreferrer" 
                  className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-green-50 hover:border-green-300 transition-colors">
                  <span className="text-2xl">‚úÖ</span>
                  <div>
                    <p className="font-medium text-gray-800">{lang === 'en' ? 'Signed Quote' : 'Devis Sign√©'}</p>
                    <p className="text-xs text-gray-500">{lang === 'en' ? 'Approved by client' : 'Approuv√© par client'}</p>
                  </div>
                </a>
              )}
              {order.bc_file_url && order.bc_file_url !== order.signed_quote_url && order.bc_file_url !== order.quote_url && (
                <a href={order.bc_file_url} target="_blank" rel="noopener noreferrer" 
                  className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-purple-50 hover:border-purple-300 transition-colors">
                  <span className="text-2xl">üìé</span>
                  <div>
                    <p className="font-medium text-gray-800">{lang === 'en' ? 'PO Uploaded' : 'BC Upload√©'}</p>
                    <p className="text-xs text-gray-500">{lang === 'en' ? 'Client file' : 'Fichier client'}</p>
                  </div>
                </a>
              )}
              {order.quote_data?.shipping?.upsLabelUrl && (
                <a href={order.quote_data.shipping.upsLabelUrl} target="_blank" rel="noopener noreferrer" 
                  className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-amber-50 hover:border-amber-300 transition-colors">
                  <span className="text-2xl">üè∑Ô∏è</span>
                  <div>
                    <p className="font-medium text-gray-800">{lang === 'en' ? 'UPS Label' : '√âtiquette UPS'}</p>
                    <p className="text-xs text-gray-500">{order.quote_data.shipping.trackingNumber || 'PDF'}</p>
                  </div>
                </a>
              )}
              {order.quote_data?.shipping?.blUrl && (
                <a href={order.quote_data.shipping.blUrl} target="_blank" rel="noopener noreferrer" 
                  className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-indigo-50 hover:border-indigo-300 transition-colors">
                  <span className="text-2xl">üìã</span>
                  <div>
                    <p className="font-medium text-gray-800">{t('deliveryNote')}</p>
                    <p className="text-xs text-gray-500">{order.quote_data.shipping.blNumber || 'PDF'}</p>
                  </div>
                </a>
              )}
              {!order.quote_url && !order.signed_quote_url && !order.bc_file_url && !order.quote_data?.shipping?.upsLabelUrl && !order.quote_data?.shipping?.blUrl && (
                <p className="col-span-2 text-gray-500 text-center py-4">{lang === 'en' ? 'No documents available' : 'Aucun document disponible'}</p>
              )}
            </div>
            
            {/* Tracking Number */}
            {order.quote_data?.shipping?.trackingNumber && (
              <div className="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
                <div className="flex justify-between items-center">
                  <div>
                    <p className="text-sm text-amber-700">{lang === 'en' ? 'UPS Tracking #' : 'N¬∞ Suivi UPS'}</p>
                    <p className="font-mono font-bold text-amber-800">{order.quote_data.shipping.trackingNumber}</p>
                  </div>
                  <a href={`https://www.ups.com/track?tracknum=${order.quote_data.shipping.trackingNumber}`} target="_blank" rel="noopener noreferrer" 
                    className="px-3 py-1 bg-amber-500 hover:bg-amber-600 text-white rounded text-sm font-medium">
                    Suivre ‚Üí
                  </a>
                </div>
              </div>
            )}
          </div>
        </div>
        
        {/* Footer */}
        <div className="px-6 py-4 border-t bg-gray-50">
          <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
            Fermer
          </button>
        </div>
      </div>
    </div>
  );
}

// Parts Order Detail Modal
function PartsOrderDetailModal({ order, onClose, onCreateQuote, lang = 'fr' }) {
  const t = k => k;
  const style = STATUS_STYLES[order.status] || STATUS_STYLES.submitted;
  const isPending = order.status === 'submitted' && !order.request_number;
  const needsRevision = order.status === 'quote_revision_requested';
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={onClose}>
      <div className="bg-white rounded-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
        <div className="px-6 py-4 border-b sticky top-0 bg-white flex justify-between items-center">
          <div>
            <h2 className="text-xl font-bold text-gray-800">
              {order.request_number || (lang === 'en' ? 'New Parts Order' : 'Nouvelle Commande de Pi√®ces')}
            </h2>
            <p className="text-sm text-gray-500">{order.companies?.name}</p>
          </div>
          <div className="flex items-center gap-3">
            <span className={`px-3 py-1 rounded-full text-sm font-medium ${style.bg} ${style.text}`}>
              {lang === 'en' && style.en ? style.en : style.label}
            </span>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
          </div>
        </div>
        
        <div className="p-6 space-y-6">
          {/* Revision Notes */}
          {order.revision_notes && (
            <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4">
              <h3 className="font-bold text-red-800 mb-2">{lang === 'en' ? 'üî¥ Client revision request' : 'üî¥ Demande de modification du client'}</h3>
              <p className="text-red-700 whitespace-pre-wrap">{order.revision_notes}</p>
            </div>
          )}
          
          {/* Requested Parts - Structured Display */}
          <div>
            <h3 className="font-bold text-gray-700 mb-3">{lang === 'en' ? 'üì¶ Requested Parts' : 'üì¶ Pi√®ces demand√©es'}</h3>
            
            {order.parts_data?.parts ? (
              <div className="space-y-4">
                {order.parts_data.parts.map((part, idx) => (
                  <div key={idx} className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                    <div className="flex justify-between items-start mb-2">
                      <span className="font-bold text-amber-900">{lang === 'en' ? 'Part' : 'Pi√®ce'} #{part.num || idx + 1}</span>
                      <span className="text-sm bg-amber-200 px-2 py-0.5 rounded text-amber-800">{lang === 'en' ? 'Qty' : 'Qt√©'}: {part.quantity || 1}</span>
                    </div>
                    
                    <div className="grid md:grid-cols-2 gap-2 text-sm mb-2">
                      {part.device_for && (
                        <div>
                          <span className="text-gray-500">{lang === 'en' ? 'For device:' : 'Pour appareil:'}</span>
                          <span className="ml-2 font-medium">{part.device_for}</span>
                        </div>
                      )}
                      {part.part_number && (
                        <div>
                          <span className="text-gray-500">{lang === 'en' ? 'Part #:' : 'N¬∞ pi√®ce:'}</span>
                          <span className="ml-2 font-mono font-medium text-amber-700">{part.part_number}</span>
                        </div>
                      )}
                    </div>
                    
                    {part.description && (
                      <div className="mt-2 bg-white rounded p-2">
                        <span className="text-gray-500 text-xs">{lang === 'en' ? 'Description:' : 'Description:'}</span>
                        <p className="text-gray-800">{part.description}</p>
                      </div>
                    )}
                    
                    {/* Photos */}
                    {part.photos && part.photos.length > 0 && (
                      <div className="mt-3">
                        <span className="text-gray-500 text-sm">{lang === 'en' ? `üì∑ Photos (${part.photos.length}):` : `üì∑ Photos (${part.photos.length}):`}</span>
                        <div className="flex flex-wrap gap-2 mt-2">
                          {part.photos.map((photoUrl, pIdx) => (
                            <a 
                              key={pIdx} 
                              href={photoUrl} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="block"
                            >
                              <img 
                                src={photoUrl} 
                                alt={`Photo ${pIdx + 1}`}
                                className="w-20 h-20 object-cover rounded-lg border-2 border-amber-300 hover:border-amber-500 transition-colors"
                              />
                            </a>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              /* Fallback to plain text */
              <div className="bg-gray-50 rounded-lg p-4">
                <p className="text-gray-800 whitespace-pre-wrap">{order.problem_description}</p>
              </div>
            )}
          </div>
          
          {/* Shipping Address */}
          {order.shipping_address_id && (
            <div>
              <h3 className="font-bold text-gray-700 mb-3">{lang === 'en' ? 'üìç Shipping address' : 'üìç Adresse de livraison'}</h3>
              <div className="bg-blue-50 rounded-lg p-4">
                <p className="text-gray-600">ID: {order.shipping_address_id}</p>
              </div>
            </div>
          )}
          
          {/* Documents Section */}
          {(order.quote_url || order.signed_quote_url || order.bc_file_url || order.quote_data?.shipping?.upsLabelUrl || order.quote_data?.shipping?.blUrl) && (
            <div>
              <h3 className="font-bold text-gray-700 mb-3">{lang === 'en' ? 'üìÅ Documents' : 'üìÅ Documents'}</h3>
              <div className="bg-gray-50 rounded-lg p-4">
                <div className="grid grid-cols-2 gap-3">
                  {order.quote_url && (
                    <a href={order.quote_url} target="_blank" rel="noopener noreferrer" 
                      className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-blue-50 hover:border-blue-300 transition-colors">
                      <span className="text-xl">üìÑ</span>
                      <div>
                        <p className="font-medium text-gray-800 text-sm">{t('quote')}</p>
                        <p className="text-xs text-gray-500">{lang === 'en' ? 'Original' : 'Original'}</p>
                      </div>
                    </a>
                  )}
                  {order.signed_quote_url && order.signed_quote_url !== order.quote_url && (
                    <a href={order.signed_quote_url} target="_blank" rel="noopener noreferrer" 
                      className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-green-50 hover:border-green-300 transition-colors">
                      <span className="text-xl">‚úÖ</span>
                      <div>
                        <p className="font-medium text-gray-800 text-sm">{lang === 'en' ? 'Signed Quote' : 'Devis Sign√©'}</p>
                        <p className="text-xs text-gray-500">{lang === 'en' ? 'Approved' : 'Approuv√©'}</p>
                      </div>
                    </a>
                  )}
                  {order.bc_file_url && order.bc_file_url !== order.signed_quote_url && order.bc_file_url !== order.quote_url && (
                    <a href={order.bc_file_url} target="_blank" rel="noopener noreferrer" 
                      className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-purple-50 hover:border-purple-300 transition-colors">
                      <span className="text-xl">üìé</span>
                      <div>
                        <p className="font-medium text-gray-800 text-sm">{lang === 'en' ? 'PO Uploaded' : 'BC Upload√©'}</p>
                        <p className="text-xs text-gray-500">{lang === 'en' ? 'Client file' : 'Fichier client'}</p>
                      </div>
                    </a>
                  )}
                  {order.quote_data?.shipping?.upsLabelUrl && (
                    <a href={order.quote_data.shipping.upsLabelUrl} target="_blank" rel="noopener noreferrer" 
                      className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-amber-50 hover:border-amber-300 transition-colors">
                      <span className="text-xl">üè∑Ô∏è</span>
                      <div>
                        <p className="font-medium text-gray-800 text-sm">{lang === 'en' ? 'UPS Label' : '√âtiquette UPS'}</p>
                        <p className="text-xs text-gray-500">{order.quote_data.shipping.trackingNumber || 'PDF'}</p>
                      </div>
                    </a>
                  )}
                  {order.quote_data?.shipping?.blUrl && (
                    <a href={order.quote_data.shipping.blUrl} target="_blank" rel="noopener noreferrer" 
                      className="flex items-center gap-2 p-3 bg-white rounded-lg border hover:bg-indigo-50 hover:border-indigo-300 transition-colors">
                      <span className="text-xl">üìã</span>
                      <div>
                        <p className="font-medium text-gray-800 text-sm">{t('deliveryNote')}</p>
                        <p className="text-xs text-gray-500">{order.quote_data.shipping.blNumber || 'PDF'}</p>
                      </div>
                    </a>
                  )}
                </div>
                
                {/* Tracking Number */}
                {order.quote_data?.shipping?.trackingNumber && (
                  <div className="mt-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="text-xs text-amber-700">{lang === 'en' ? 'UPS Tracking #' : 'N¬∞ Suivi UPS'}</p>
                        <p className="font-mono font-bold text-amber-800">{order.quote_data.shipping.trackingNumber}</p>
                      </div>
                      <a href={`https://www.ups.com/track?tracknum=${order.quote_data.shipping.trackingNumber}`} target="_blank" rel="noopener noreferrer" 
                        className="px-3 py-1 bg-amber-500 hover:bg-amber-600 text-white rounded text-sm font-medium">
                        Suivre ‚Üí
                      </a>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
          
          {/* Order Info */}
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-gray-50 rounded-lg p-4">
              <p className="text-xs text-gray-500 uppercase mb-1">{lang === 'en' ? 'Submitted on' : 'Soumis le'}</p>
              <p className="font-medium">{new Date(order.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR', { dateStyle: 'full' })}</p>
            </div>
            <div className="bg-gray-50 rounded-lg p-4">
              <p className="text-xs text-gray-500 uppercase mb-1">{lang === 'en' ? 'Urgent' : 'Urgence'}</p>
              <p className="font-medium">{order.urgency || 'Normal'}</p>
            </div>
          </div>
        </div>
        
        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between">
          <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{t('close')}</button>
          {(isPending || needsRevision) && (
            <button onClick={onCreateQuote} className={`px-6 py-2 text-white rounded-lg font-medium ${needsRevision ? 'bg-red-500 hover:bg-red-600' : 'bg-[#00A651] hover:bg-[#008f45]'}`}>
              üí∞ {needsRevision ? (lang === 'en' ? 'Revise Quote' : 'R√©viser Devis') : (lang === 'en' ? 'Create Quote' : 'Cr√©er Devis')}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

// ============================================
// PARTS QUOTE EDITOR - Build parts quote
// ============================================
function PartsQuoteEditor({ order, onClose, notify, reload, profile, lang = 'fr' }) {
  const t = k => k;
  const [step, setStep] = useState(1); // 1=Edit Parts, 2=Preview, 3=Confirm
  const [quoteParts, setQuoteParts] = useState([]);
  const [saving, setSaving] = useState(false);
  const [quoteRef, setQuoteRef] = useState('');
  const [partsCache, setPartsCache] = useState({});
  const [partsDescriptionCache, setPartsDescriptionCache] = useState({});
  const [loadingParts, setLoadingParts] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  
  // Shipping
  const [shippingData, setShippingData] = useState({
    unitPrice: 45,
    parcels: 1,
    total: 45
  });
  
  const signatory = profile?.full_name || 'Lighthouse France';
  const today = new Date();
  
  // Generate quote reference
  useEffect(() => {
    const now = new Date();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const yy = String(now.getFullYear()).slice(-2);
    const random = Math.floor(Math.random() * 900) + 100;
    setQuoteRef(`DEV-${mm}${yy}-${random}`);
  }, []);
  
  // Load parts pricing from database
  useEffect(() => {
    const loadParts = async () => {
      setLoadingParts(true);
      try {
        let allParts = [];
        let offset = 0;
        const batchSize = 1000;
        let hasMore = true;
        
        while (hasMore) {
          const { data, error } = await supabase
            .from('parts_pricing')
            .select('part_number, unit_price, description, description_fr')
            .range(offset, offset + batchSize - 1);
          
          if (error) break;
          if (data && data.length > 0) {
            allParts = [...allParts, ...data];
            offset += batchSize;
            hasMore = data.length === batchSize;
          } else {
            hasMore = false;
          }
        }
        
        const cache = {};
        const descCache = {};
        allParts.forEach(p => {
          cache[p.part_number] = p.unit_price;
          descCache[p.part_number] = p.description_fr || p.description || p.part_number;
        });
        
        setPartsCache(cache);
        setPartsDescriptionCache(descCache);
        
        // Get shipping price
        if (cache['Shipping1']) {
          setShippingData(prev => ({ ...prev, unitPrice: cache['Shipping1'], total: cache['Shipping1'] * prev.parcels }));
        }
      } catch (err) {
        console.error('Parts load error:', err);
      }
      setLoadingParts(false);
    };
    loadParts();
  }, []);
  
  // DON'T auto-add customer request as quote lines - admin builds quote from scratch
  // Quote starts empty, admin adds parts based on what customer requested
  // BUT if this is a correction (admin sent back), restore the previously submitted parts
  useEffect(() => {
    if (order.quote_rejection_notes && order.quote_data?.parts?.length > 0) {
      const savedParts = order.quote_data.parts.map((p, i) => ({
        id: `part_${Date.now()}_${i}`,
        partNumber: p.partNumber || '',
        description: p.description || '',
        quantity: p.quantity || 1,
        unitPrice: p.unitPrice || 0,
        isFromRequest: false
      }));
      setQuoteParts(savedParts);
      // Restore shipping if saved
      if (order.quote_data.shipping) {
        setShippingData(prev => ({
          ...prev,
          unitPrice: order.quote_data.shipping.unitPrice || prev.unitPrice,
          parcels: order.quote_data.shipping.parcels || prev.parcels,
          total: order.quote_data.shipping.total || prev.total
        }));
      }
    }
  }, []);
  
  // Search parts
  const handleSearch = (term) => {
    setSearchTerm(term);
    if (term.length < 2) {
      setSearchResults([]);
      return;
    }
    const lowerTerm = term.toLowerCase();
    const results = Object.entries(partsDescriptionCache)
      .filter(([pn, desc]) => 
        pn.toLowerCase().includes(lowerTerm) || 
        (desc && desc.toLowerCase().includes(lowerTerm))
      )
      .slice(0, 20)
      .map(([pn, desc]) => ({
        partNumber: pn,
        description: desc,
        unitPrice: partsCache[pn] || 0
      }));
    setSearchResults(results);
  };
  
  // Add part from search
  const addPart = (part) => {
    setQuoteParts([...quoteParts, {
      id: `part_${Date.now()}`,
      partNumber: part.partNumber,
      description: part.description,
      quantity: 1,
      unitPrice: part.unitPrice,
      isFromRequest: false
    }]);
    setSearchTerm('');
    setSearchResults([]);
  };
  
  // Add blank part
  const addBlankPart = () => {
    setQuoteParts([...quoteParts, {
      id: `part_${Date.now()}`,
      partNumber: '',
      description: '',
      quantity: 1,
      unitPrice: 0,
      isFromRequest: false
    }]);
  };
  
  // Update part
  const updatePart = (id, field, value) => {
    setQuoteParts(quoteParts.map(p => {
      if (p.id !== id) return p;
      const updated = { ...p, [field]: value };
      // Auto-fill price if part number matches
      if (field === 'partNumber' && partsCache[value]) {
        updated.unitPrice = partsCache[value];
        updated.description = partsDescriptionCache[value] || updated.description;
      }
      return updated;
    }));
  };
  
  // Remove part
  const removePart = (id) => {
    setQuoteParts(quoteParts.filter(p => p.id !== id));
  };
  
  // Calculate totals
  const partsTotal = quoteParts.reduce((sum, p) => sum + (p.quantity * p.unitPrice), 0);
  const grandTotal = partsTotal + shippingData.total;
  
  // Send quote
  const sendQuote = async () => {
    if (quoteParts.length === 0) {
      notify(lang === 'en' ? 'Add at least one part to the quote' : 'Ajoutez au moins une pi√®ce au devis', 'error');
      return;
    }
    
    setSaving(true);
    try {
      // Generate Parts Order number if not exists (PO-MMYY-NNN format)
      let poNumber = order.request_number;
      if (!poNumber) {
        try {
          const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'PO' });
          if (!docNumError && docNumData) {
            poNumber = docNumData;
          }
        } catch (e) {
          console.error('Could not generate PO number:', e);
        }
        // Fallback if RPC fails
        if (!poNumber) {
          const now = new Date();
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          const yy = String(now.getFullYear()).slice(-2);
          poNumber = `PO-${mm}${yy}-001`;
        }
      }
      
      // Get next document number for quote (DEV-MMYY-NNN)
      let quoteNumber = null;
      try {
        const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'DEV' });
        if (!docNumError && docNumData) {
          quoteNumber = docNumData;
        }
      } catch (e) {
        console.error('Could not generate document number:', e);
      }
      
      // Build quote_data
      const quoteData = {
        parts: quoteParts.map(p => ({
          partNumber: p.partNumber,
          description: p.description,
          quantity: p.quantity,
          unitPrice: p.unitPrice,
          lineTotal: p.quantity * p.unitPrice
        })),
        shipping: shippingData,
        partsTotal,
        grandTotal,
        quoteRef: quoteNumber || quoteRef,
        createdBy: signatory,
        createdAt: new Date().toISOString()
      };
      
      // === QUOTE REVIEW: Submit for review ===
      try {
        const partsSummary = quoteParts.map(p => `${p.description} x${p.quantity}`).join(', ');
        
        await submitForQuoteReview({
          serviceRequestId: order.id,
          quoteType: 'parts',
          quoteData: {
            ...quoteData,
            poNumber,
            quoteNumber: quoteNumber || quoteRef,
            signatory
          },
          quoteNumber: quoteNumber || quoteRef,
          rmaNumber: poNumber,
          clientName: order.companies?.name || 'Client inconnu',
          totalAmount: grandTotal,
          deviceSummary: partsSummary,
          previousStatus: order.status,
          serviceRequestUpdate: {
            request_number: poNumber,
            quote_number: quoteNumber,
            quote_data: quoteData,
            quoted_at: new Date().toISOString(),
            revision_notes: null
          },
          profile
        });
        
        notify(lang === 'en' 
          ? `üìã Parts quote submitted for review! ${quoteNumber || quoteRef}` 
          : `üìã Devis pi√®ces soumis pour v√©rification ! ${quoteNumber || quoteRef}`);
        reload();
        onClose();
      } catch (err) {
        notify(lang === 'en' ? `Error: ${err.message}` : `Erreur: ${err.message}`, 'error');
      }
      setSaving(false);
      return;
      // === END QUOTE REVIEW ===
      
      // Generate quote PDF
      let quoteUrl = null;
      try {
        const pdfBlob = await generatePartsQuotePDF(order, { ...quoteData, quoteRef: quoteNumber || quoteRef });
        const pdfFileName = `quotes/parts/${order.request_number}/devis_pieces_${poNumber}_${Date.now()}.pdf`;
        
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('documents')
          .upload(pdfFileName, pdfBlob, { contentType: 'application/pdf' });
        
        if (!uploadError) {
          const { data: urlData } = supabase.storage
            .from('documents')
            .getPublicUrl(pdfFileName);
          quoteUrl = urlData?.publicUrl;
        } else {
          console.error('Quote PDF upload error:', uploadError);
        }
      } catch (e) {
        console.error('Quote PDF generation error:', e);
      }
      
      // Update order with quote data
      const { error } = await supabase
        .from('service_requests')
        .update({
          request_number: poNumber,
          quote_number: quoteNumber,
          status: 'quote_sent',
          quote_sent_at: new Date().toISOString(),
          quote_data: quoteData,
          quote_url: quoteUrl,
          revision_notes: null
        })
        .eq('id', order.id);
      
      if (error) throw error;
      
      notify(lang === 'en' ? `Quote ${quoteNumber || quoteRef} sent for ${order.companies?.name}` : `Devis ${quoteNumber || quoteRef} envoy√© pour ${order.companies?.name}`);
      reload();
      onClose();
    } catch (err) {
      notify(lang === 'en' ? `Error: ${err.message}` : `Erreur: ${err.message}`, 'error');
    }
    setSaving(false);
  };

  if (loadingParts) {
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div className="bg-white rounded-xl p-8 text-center">
          <div className="w-12 h-12 border-4 border-[#00A651] border-t-transparent rounded-full animate-spin mx-auto mb-4" />
          <p className="text-gray-600">{lang === 'en' ? 'Loading parts...' : 'Chargement des pi√®ces...'}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
      <div className="bg-white rounded-xl w-full max-w-5xl max-h-[95vh] flex flex-col">
        {/* Header */}
        <div className="px-6 py-4 border-b bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-t-xl flex justify-between items-center">
          <div>
            <h2 className="text-xl font-bold">{lang === 'en' ? 'üî© Parts Quote' : 'üî© Devis Pi√®ces D√©tach√©es'}</h2>
            <p className="text-amber-100">{order.companies?.name} ‚Ä¢ {quoteRef}</p>
          </div>
          <div className="flex items-center gap-4">
            <div className="flex gap-1">
              {[1, 2, 3].map(s => (
                <div key={s} className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${step >= s ? 'bg-white text-amber-600' : 'bg-amber-400/50 text-white'}`}>
                  {s}
                </div>
              ))}
            </div>
            <button onClick={onClose} className="text-white/80 hover:text-white text-2xl">&times;</button>
          </div>
        </div>
        
        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* Step 1: Edit Parts */}
          {step === 1 && (
            <div className="space-y-6">
              {/* Revision Notes Alert */}
              {order.revision_notes && (
                <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                  <h3 className="font-bold text-red-800 mb-2">{lang === 'en' ? 'üî¥ Client requested modifications' : 'üî¥ Modifications demand√©es par le client'}</h3>
                  <p className="text-red-700 whitespace-pre-wrap">{order.revision_notes}</p>
                </div>
              )}
              
              {/* Admin modification request */}
              {order.quote_rejection_notes && (
                <div className="bg-amber-50 border-2 border-amber-300 rounded-lg p-4">
                  <div className="flex items-center gap-3 mb-2">
                    <span className="text-lg">‚úèÔ∏è</span>
                    <span className="font-bold text-amber-800">{lang === 'en' ? 'Admin requested modification' : 'Modification demand√©e par l\'admin'}</span>
                  </div>
                  <div className="ml-9 bg-white rounded-lg p-3 border border-amber-200">
                    <p className="text-amber-900">{order.quote_rejection_notes}</p>
                  </div>
                </div>
              )}
              
              {/* Customer Request - Structured Display */}
              <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <h3 className="font-bold text-amber-800 mb-3">{lang === 'en' ? 'üìã Client request' : 'üìã Demande du client'}</h3>
                
                {/* Check for structured parts_data first */}
                {order.parts_data?.parts ? (
                  <div className="space-y-4">
                    {order.parts_data.parts.map((part, idx) => (
                      <div key={idx} className="bg-white rounded-lg p-4 border border-amber-200">
                        <div className="flex justify-between items-start mb-2">
                          <span className="font-bold text-amber-900">{lang === 'en' ? 'Part' : 'Pi√®ce'} #{part.num || idx + 1}</span>
                          <span className="text-sm text-amber-600">{lang === 'en' ? 'Qty' : 'Qt√©'}: {part.quantity || 1}</span>
                        </div>
                        
                        <div className="grid md:grid-cols-2 gap-3 text-sm">
                          {part.device_for && (
                            <div>
                              <span className="text-gray-500">{lang === 'en' ? 'For device:' : 'Pour appareil:'}</span>
                              <span className="ml-2 font-medium text-gray-800">{part.device_for}</span>
                            </div>
                          )}
                          {part.part_number && (
                            <div>
                              <span className="text-gray-500">{lang === 'en' ? 'Part #:' : 'N¬∞ pi√®ce:'}</span>
                              <span className="ml-2 font-mono font-medium text-amber-700">{part.part_number}</span>
                            </div>
                          )}
                        </div>
                        
                        {part.description && (
                          <div className="mt-2">
                            <span className="text-gray-500 text-sm">{lang === 'en' ? 'Description:' : 'Description:'}</span>
                            <p className="text-gray-800 mt-1">{part.description}</p>
                          </div>
                        )}
                        
                        {/* Photos */}
                        {part.photos && part.photos.length > 0 && (
                          <div className="mt-3">
                            <span className="text-gray-500 text-sm">{lang === 'en' ? 'Photos:' : 'Photos:'}</span>
                            <div className="flex flex-wrap gap-2 mt-2">
                              {part.photos.map((photoUrl, pIdx) => (
                                <a 
                                  key={pIdx} 
                                  href={photoUrl} 
                                  target="_blank" 
                                  rel="noopener noreferrer"
                                  className="block"
                                >
                                  <img 
                                    src={photoUrl} 
                                    alt={`Photo ${pIdx + 1}`}
                                    className="w-24 h-24 object-cover rounded-lg border-2 border-amber-300 hover:border-amber-500 transition-colors"
                                  />
                                </a>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  /* Fallback to plain text description */
                  <p className="text-amber-700 whitespace-pre-wrap text-sm">{order.problem_description}</p>
                )}
              </div>
              
              {/* Parts Search */}
              <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-bold text-gray-700 mb-3">{lang === 'en' ? 'üîç Add parts to quote' : 'üîç Ajouter des pi√®ces au devis'}</h3>
                <div className="relative">
                  <input
                    type="text"
                    value={searchTerm}
                    onChange={(e) => handleSearch(e.target.value)}
                    placeholder={lang === 'en' ? 'Search by reference or description...' : 'Rechercher par r√©f√©rence ou description...'}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                  />
                  {searchResults.length > 0 && (
                    <div className="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                      {searchResults.map((part, i) => (
                        <button
                          key={i}
                          onClick={() => addPart(part)}
                          className="w-full px-4 py-2 text-left hover:bg-amber-50 flex justify-between items-center"
                        >
                          <div>
                            <span className="font-mono text-sm text-amber-600">{part.partNumber}</span>
                            <span className="text-gray-600 ml-2">{part.description}</span>
                          </div>
                          <span className="font-medium">{part.unitPrice.toFixed(2)} ‚Ç¨</span>
                        </button>
                      ))}
                    </div>
                  )}
                </div>
                <button
                  onClick={addBlankPart}
                  className="mt-3 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm"
                >
                  + Ajouter ligne vide
                </button>
              </div>
              
              {/* Parts List */}
              <div>
                <h3 className="font-bold text-gray-700 mb-3">{lang === 'en' ? 'üì¶ Quote Parts' : 'üì¶ Pi√®ces du devis'}</h3>
                <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-3 py-2 text-left text-xs font-bold text-gray-600 w-32">{lang === 'en' ? 'Reference' : 'R√©f√©rence'}</th>
                        <th className="px-3 py-2 text-left text-xs font-bold text-gray-600">{t('description')}</th>
                        <th className="px-3 py-2 text-center text-xs font-bold text-gray-600 w-20">{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
                        <th className="px-3 py-2 text-right text-xs font-bold text-gray-600 w-24">{lang === 'en' ? 'Unit Price' : 'Prix Unit.'}</th>
                        <th className="px-3 py-2 text-right text-xs font-bold text-gray-600 w-24">{t('total')}</th>
                        <th className="px-3 py-2 w-12"></th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                      {quoteParts.map((part, idx) => (
                        <tr key={part.id} className="hover:bg-gray-50">
                          <td className="px-3 py-2">
                            <input
                              type="text"
                              value={part.partNumber}
                              onChange={(e) => updatePart(part.id, 'partNumber', e.target.value)}
                              className="w-full px-2 py-1 border border-gray-200 rounded text-sm font-mono"
                              placeholder={lang === 'en' ? 'Ref...' : 'R√©f...'}
                            />
                          </td>
                          <td className="px-3 py-2">
                            <input
                              type="text"
                              value={part.description}
                              onChange={(e) => updatePart(part.id, 'description', e.target.value)}
                              className="w-full px-2 py-1 border border-gray-200 rounded text-sm"
                              placeholder="Description..."
                            />
                          </td>
                          <td className="px-3 py-2">
                            <input
                              type="number"
                              min="1"
                              value={part.quantity}
                              onChange={(e) => updatePart(part.id, 'quantity', parseInt(e.target.value) || 1)}
                              className="w-full px-2 py-1 border border-gray-200 rounded text-sm text-center"
                            />
                          </td>
                          <td className="px-3 py-2">
                            <input
                              type="number"
                              step="0.01"
                              min="0"
                              value={part.unitPrice}
                              onChange={(e) => updatePart(part.id, 'unitPrice', parseFloat(e.target.value) || 0)}
                              className="w-full px-2 py-1 border border-gray-200 rounded text-sm text-right"
                            />
                          </td>
                          <td className="px-3 py-2 text-right font-medium text-sm">
                            {(part.quantity * part.unitPrice).toFixed(2)} ‚Ç¨
                          </td>
                          <td className="px-3 py-2">
                            <button
                              onClick={() => removePart(part.id)}
                              className="text-red-500 hover:text-red-700"
                            >
                              ‚úï
                            </button>
                          </td>
                        </tr>
                      ))}
                      {quoteParts.length === 0 && (
                        <tr>
                          <td colSpan={6} className="px-4 py-8 text-center text-gray-400">
                            {lang === 'en' ? 'No parts added. Use the search above.' : 'Aucune pi√®ce ajout√©e. Utilisez la recherche ci-dessus.'}
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
              
              {/* Shipping */}
              <div className="bg-blue-50 rounded-lg p-4">
                <h3 className="font-bold text-blue-800 mb-3">{lang === 'en' ? 'üöö Shipping fees' : 'üöö Frais de port'}</h3>
                <div className="flex items-center gap-4">
                  <div>
                    <label className="text-sm text-blue-600">{lang === 'en' ? 'Number of parcels' : 'Nombre de colis'}</label>
                    <input
                      type="number"
                      min="0"
                      value={shippingData.parcels}
                      onChange={(e) => {
                        const p = parseInt(e.target.value) || 0;
                        setShippingData({ ...shippingData, parcels: p, total: p * shippingData.unitPrice });
                      }}
                      className="w-20 px-3 py-2 border border-blue-200 rounded-lg text-center ml-2"
                    />
                  </div>
                  <div>
                    <label className="text-sm text-blue-600">{t('unitPrice')}</label>
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      value={shippingData.unitPrice}
                      onChange={(e) => {
                        const u = parseFloat(e.target.value) || 0;
                        setShippingData({ ...shippingData, unitPrice: u, total: u * shippingData.parcels });
                      }}
                      className="w-24 px-3 py-2 border border-blue-200 rounded-lg text-right ml-2"
                    />
                  </div>
                  <div className="text-right flex-1">
                    <span className="text-blue-600">{lang === 'en' ? 'Total shipping:' : 'Total port:'}</span>
                    <span className="font-bold text-blue-800 ml-2">{shippingData.total.toFixed(2)} ‚Ç¨</span>
                  </div>
                </div>
              </div>
              
              {/* Totals */}
              <div className="bg-gray-100 rounded-lg p-4">
                <div className="flex justify-between text-lg">
                  <span>{lang === 'en' ? 'Parts subtotal:' : 'Sous-total pi√®ces:'}</span>
                  <span className="font-medium">{partsTotal.toFixed(2)} ‚Ç¨</span>
                </div>
                <div className="flex justify-between text-lg">
                  <span>{lang === 'en' ? 'Shipping:' : 'Frais de port:'}</span>
                  <span className="font-medium">{shippingData.total.toFixed(2)} ‚Ç¨</span>
                </div>
                <div className="flex justify-between text-xl font-bold text-[#2D5A7B] mt-2 pt-2 border-t border-gray-300">
                  <span>{lang === 'en' ? 'TOTAL excl. VAT:' : 'TOTAL HT:'}</span>
                  <span>{grandTotal.toFixed(2)} ‚Ç¨</span>
                </div>
              </div>
            </div>
          )}
          
          {/* Step 2: Preview */}
          {step === 2 && (
            <div className="bg-gray-200 p-6 rounded-lg">
              <div className="bg-white shadow-lg mx-auto flex flex-col" style={{ width: '210mm', minHeight: '297mm' }}>
                {/* PDF Preview Header */}
                <div className="border-b-4 border-[#2D5A7B] p-6">
                  <div className="flex justify-between items-start">
                    <div>
                      <img 
                        src="/images/logos/Lighthouse-color-logo.jpg" 
                        alt="Lighthouse France" 
                        className="h-24 w-auto"
                        onError={(e) => {
                          e.target.style.display = 'none';
                          e.target.nextSibling.style.display = 'block';
                        }}
                      />
                      <div style={{ display: 'none' }}>
                        <h1 className="text-2xl font-bold text-[#1a1a2e]">LIGHTHOUSE</h1>
                        <p className="text-gray-500">France</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="text-xl font-bold text-[#2D5A7B]">{lang === 'en' ? 'PARTS QUOTE' : 'DEVIS PI√àCES'}</p>
                      <p className="text-sm font-bold text-[#2D5A7B]">N¬∞ {order.quote_number || quoteRef}</p>
                      <p className="text-xs text-gray-500">R√©f: {order.request_number}</p>
                    </div>
                  </div>
                </div>
                
                {/* Info Bar */}
                <div className="bg-gray-100 px-6 py-3 flex justify-between text-sm">
                  <div>
                    <span className="text-gray-500">{lang === 'en' ? 'Date: ' : 'Date: '}</span>
                    <span className="font-medium">{today.toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</span>
                  </div>
                  <div>
                    <span className="text-gray-500">{lang === 'en' ? 'Validity: ' : 'Validit√©: '}</span>
                    <span className="font-medium">{lang === 'en' ? '30 days' : '30 jours'}</span>
                  </div>
                </div>
                
                {/* Client Info */}
                <div className="px-6 py-4 border-b">
                  <p className="text-xs text-gray-500 uppercase">{t('client')}</p>
                  <p className="font-bold text-lg">{order.companies?.name}</p>
                  {order.companies?.billing_address && <p className="text-gray-600">{order.companies.billing_address}</p>}
                  <p className="text-gray-600">{order.companies?.billing_postal_code} {order.companies?.billing_city}</p>
                </div>
                
                {/* Parts Table - flex-1 to push footer down */}
                <div className="px-6 py-4 flex-1">
                  <h3 className="font-bold text-[#1a1a2e] mb-3">{lang === 'en' ? 'Parts Summary' : 'R√©capitulatif des Pi√®ces'}</h3>
                  <table className="w-full">
                    <thead>
                      <tr className="bg-[#1a1a2e] text-white">
                        <th className="px-3 py-2 text-left text-sm w-12">{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
                        <th className="px-3 py-2 text-left text-sm">{lang === 'en' ? 'Reference' : 'R√©f√©rence'}</th>
                        <th className="px-3 py-2 text-left text-sm">{lang === 'en' ? 'Description' : 'D√©signation'}</th>
                        <th className="px-3 py-2 text-right text-sm w-20">{lang === 'en' ? 'Unit Price' : 'Prix Unit.'}</th>
                        <th className="px-3 py-2 text-right text-sm w-20">{t('totalHT')}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {quoteParts.map((part, idx) => (
                        <tr key={idx} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                          <td className="px-3 py-2 text-center">{part.quantity}</td>
                          <td className="px-3 py-2 font-mono text-sm">{part.partNumber || '‚Äî'}</td>
                          <td className="px-3 py-2 text-sm">{part.description}</td>
                          <td className="px-3 py-2 text-right whitespace-nowrap">{part.unitPrice.toFixed(2)} ‚Ç¨</td>
                          <td className="px-3 py-2 text-right font-medium whitespace-nowrap">{(part.quantity * part.unitPrice).toFixed(2)} ‚Ç¨</td>
                        </tr>
                      ))}
                      {shippingData.total > 0 && (
                        <tr className="bg-blue-50">
                          <td className="px-3 py-2 text-center">{shippingData.parcels}</td>
                          <td className="px-3 py-2 font-mono text-sm">Shipping1</td>
                          <td className="px-3 py-2 text-sm text-blue-800">Frais de port ({shippingData.parcels} colis)</td>
                          <td className="px-3 py-2 text-right whitespace-nowrap">{shippingData.unitPrice.toFixed(2)} ‚Ç¨</td>
                          <td className="px-3 py-2 text-right font-medium whitespace-nowrap">{shippingData.total.toFixed(2)} ‚Ç¨</td>
                        </tr>
                      )}
                      <tr className="bg-[#2D5A7B] text-white">
                        <td colSpan={4} className="px-3 py-2 text-right font-bold whitespace-nowrap">{lang === 'en' ? 'TOTAL excl. VAT' : 'TOTAL HT'}</td>
                        <td className="px-3 py-2 text-right font-bold whitespace-nowrap">{grandTotal.toFixed(2)} ‚Ç¨</td>
                      </tr>
                    </tbody>
                  </table>
                  
                  {/* Signature - moved inside flex-1 area */}
                  <div className="mt-12 pt-6 border-t">
                    <div className="flex justify-between items-end">
                      <div>
                        <p className="text-xs text-gray-500 uppercase mb-1">{lang === 'en' ? 'Prepared by' : '√âtabli par'}</p>
                        <p className="font-bold text-lg">{signatory}</p>
                        <p className="text-gray-500">Lighthouse France</p>
                      </div>
                      <div className="text-center">
                        <p className="text-xs text-gray-500 uppercase mb-1">{lang === 'en' ? 'Approved for agreement' : 'Bon pour accord'}</p>
                        <div className="w-44 h-16 border-2 border-dashed border-gray-300 rounded"></div>
                        <p className="text-xs text-gray-400 mt-1">{lang === 'en' ? 'Signature and stamp' : 'Signature et cachet'}</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                {/* Footer - at bottom */}
                <div className="bg-[#1a1a2e] text-white px-6 py-3 text-center text-xs">
                  <p className="font-medium">Lighthouse France SAS</p>
                  <p>16, rue Paul S√©journ√© ‚Ä¢ 94000 CR√âTEIL ‚Ä¢ T√©l. 01 43 77 28 07</p>
                </div>
              </div>
            </div>
          )}
          
          {/* Step 3: Confirm */}
          {step === 3 && (
            <div className="text-center py-12">
              <p className="text-6xl mb-4">üìß</p>
              <h3 className="text-2xl font-bold text-gray-800 mb-2">{lang === 'en' ? 'Ready to send' : 'Pr√™t √† envoyer'}</h3>
              <p className="text-gray-600 mb-6">
                {lang === 'en' ? `The quote will be sent to client ${order.companies?.name}.` : `Le devis sera envoy√© au client ${order.companies?.name}.`}
                <br />
                Montant total: <strong className="text-[#2D5A7B]">{grandTotal.toFixed(2)} ‚Ç¨ HT</strong>
              </p>
              <div className="bg-gray-50 rounded-lg p-4 max-w-md mx-auto text-left">
                <p className="text-sm text-gray-600"><strong>{lang === 'en' ? 'Reference:' : 'R√©f√©rence:'}</strong> {quoteRef}</p>
                <p className="text-sm text-gray-600"><strong>{lang === 'en' ? 'Parts:' : 'Pi√®ces:'}</strong> {quoteParts.length}</p>
                <p className="text-sm text-gray-600"><strong>{lang === 'en' ? 'Shipping:' : 'Port:'}</strong> {shippingData.total.toFixed(2)} ‚Ç¨</p>
              </div>
            </div>
          )}
        </div>
        
        {/* Footer Actions */}
        <div className="px-6 py-4 bg-gray-50 border-t flex justify-between rounded-b-xl">
          <div>
            {step > 1 && (
              <button onClick={() => setStep(step - 1)} className="px-4 py-2 text-gray-600 hover:text-gray-800">
                ‚Üê Retour
              </button>
            )}
          </div>
          <div className="flex gap-3">
            <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
              Annuler
            </button>
            {step < 3 ? (
              <button
                onClick={() => setStep(step + 1)}
                disabled={step === 1 && quoteParts.length === 0}
                className="px-6 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium disabled:opacity-50"
              >
                {step === 1 ? (lang === 'en' ? 'Preview ‚Üí' : 'Aper√ßu ‚Üí') : 'Confirmer ‚Üí'}
              </button>
            ) : (
              <button
                onClick={sendQuote}
                disabled={saving}
                className="px-6 py-2 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-medium disabled:opacity-50"
              >
                {saving ? (lang === 'en' ? 'Submitting...' : 'Envoi...') : (lang === 'en' ? 'üìã Submit for Review' : 'üìã Soumettre pour V√©rification')}
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


// ============================================
// PARTS ORDER SHIPPING MODAL - 3 Steps like RMA
// ============================================
function PartsShippingModal({ order, onClose, notify, reload, profile, businessSettings, lang = 'fr' }) {
  const t = k => k;
  const [step, setStep] = useState(1);
  const [saving, setSaving] = useState(false);
  const [shipment, setShipment] = useState(null);
  const [labelsPrinted, setLabelsPrinted] = useState({});
  const [blsPrinted, setBlsPrinted] = useState({});
  const [loading, setLoading] = useState(true);
  
  // State for UPS API
  const [upsLoading, setUpsLoading] = useState(false);
  const [upsLabels, setUpsLabels] = useState({}); // Store PDF labels by package index
  
  const quoteData = order.quote_data || {};
  const parts = quoteData.parts || [];
  
  // Fetch shipping address on mount and initialize shipment
  useEffect(() => {
    const initShipment = async () => {
      let address = {
        company_name: order.companies?.name || 'Client',
        attention: '',
        address_line1: order.companies?.billing_address || '',
        city: order.companies?.billing_city || '',
        postal_code: order.companies?.billing_postal_code || '',
        country: 'France',
        phone: order.companies?.phone || ''
      };
      
      // If order has a shipping_address_id, fetch it
      if (order.shipping_address_id) {
        const { data: shippingAddr } = await supabase
          .from('shipping_addresses')
          .select('*')
          .eq('id', order.shipping_address_id)
          .single();
        
        if (shippingAddr) {
          address = {
            company_name: shippingAddr.company_name || shippingAddr.label || order.companies?.name,
            attention: shippingAddr.attention || '',
            address_line1: shippingAddr.address_line1 || '',
            city: shippingAddr.city || '',
            postal_code: shippingAddr.postal_code || '',
            country: shippingAddr.country || 'France',
            phone: shippingAddr.phone || ''
          };
        }
      }
      
      setShipment({
        address,
        parcels: 1,
        weight: '1.0',
        trackingNumber: '',
        notes: '',
        packageLabels: []
      });
      
      setLoading(false);
    };
    
    initShipment();
  }, []);
  
  const updateAddress = (field, value) => {
    setShipment(prev => ({
      ...prev,
      address: { ...prev.address, [field]: value }
    }));
  };
  
  const updateShipmentField = (field, value) => {
    setShipment(prev => ({ ...prev, [field]: value }));
  };
  
  // Preview BL number format (actual number generated on save)
  const generateBLNumber = () => {
    const now = new Date();
    const mmyy = `${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getFullYear()).slice(-2)}`;
    return `BL-${mmyy}-XXX`; // Placeholder - actual number generated on save
  };
  
  // Create REAL UPS Labels via Edge Function
  const createUPSLabels = async () => {
    if (!shipment.address.company_name || !shipment.address.address_line1) {
      notify(lang === 'en' ? 'Please complete the shipping address' : "Veuillez compl√©ter l'adresse de livraison", 'error');
      return;
    }
    
    setUpsLoading(true);
    try {
      const address = shipment.address || {};
      
      // Build packages array - one per parcel count
      const packagesList = [];
      for (let p = 0; p < (shipment.parcels || 1); p++) {
        packagesList.push({
          weight: parseFloat(shipment.weight) || 1,
          length: 30,
          width: 30,
          height: 20,
          description: `${order.request_number} - Pi√®ces - Colis ${p + 1}/${shipment.parcels || 1}`
        });
      }
      
      // Call UPS Edge Function to create shipment with multiple packages
      const { data, error } = await supabase.functions.invoke('ups-shipping', {
        body: {
          action: 'create_shipment',
          shipTo: {
            name: address.attention || address.company_name || 'Customer',
            company: address.company_name || 'Customer',
            attentionName: address.attention || address.company_name || 'Customer',
            phone: address.phone || '0100000000',
            addressLine1: address.address_line1 || '',
            city: address.city || '',
            postalCode: address.postal_code || '',
            countryCode: address.country === 'France' ? 'FR' : (address.country_code || 'FR')
          },
          packages: packagesList,
          serviceCode: '11', // UPS Standard
          description: `${order.request_number} - ${parts.length} ${lang === 'en' ? 'part(s)' : 'pi√®ce(s)'}`,
          isReturn: false
        }
      });
      
      if (error) throw error;
      if (!data.success) throw new Error(data.error || 'UPS API error');
      
      // Store label PDF data for each package
      const newLabels = {};
      if (data.packages) {
        data.packages.forEach((pkg, pkgIndex) => {
          if (pkg.labelData) {
            newLabels[pkgIndex] = pkg.labelData;
          }
        });
      }
      
      setUpsLabels(newLabels);
      setShipment(prev => ({
        ...prev,
        trackingNumber: data.trackingNumber,
        upsResponse: data,
        packageLabels: data.packages || []
      }));
      
      notify(lang === 'en' ? `‚úÖ ${data.packages?.length || 1} UPS label(s) created: ${data.trackingNumber}` : `‚úÖ ${data.packages?.length || 1} √©tiquette(s) UPS cr√©√©e(s): ${data.trackingNumber}`);
      setStep(2);
    } catch (err) {
      console.error('UPS Label creation error:', err);
      notify(lang === 'en' ? '‚ùå UPS Error: ' : '‚ùå Erreur UPS: ' + (err.message || 'Erreur inconnue'), 'error');
    }
    setUpsLoading(false);
  };
  
  // French month names for written date
  const frenchMonths = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
  const getFrenchDate = () => {
    const d = new Date();
    return `${d.getDate()} ${frenchMonths[d.getMonth()]} ${d.getFullYear()}`;
  };
  
  const generateBLContent = () => ({
    blNumber: generateBLNumber(),
    date: getFrenchDate(),
    orderNumber: order.bc_number || order.request_number,
    client: { 
      name: shipment.address.company_name, 
      attention: shipment.address.attention, 
      street: shipment.address.address_line1, 
      city: `${shipment.address.postal_code} ${shipment.address.city}`, 
      country: shipment.address.country || 'France' 
    },
    parts: parts.map(p => ({ 
      quantity: p.quantity, 
      partNumber: p.partNumber || '‚Äî', 
      description: p.description 
    })),
    shipping: { 
      carrier: 'UPS', 
      tracking: shipment.trackingNumber, 
      parcels: shipment.parcels, 
      weight: shipment.weight 
    }
  });
  
  const printLabel = (pkgIndex) => {
    const labelData = upsLabels[pkgIndex];
    
    if (labelData) {
      // Download real UPS PDF label
      try {
        const byteCharacters = atob(labelData);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // Open in new tab for printing
        const w = window.open(url, '_blank');
        if (!w) {
          // Fallback: download the file
          const a = document.createElement('a');
          a.href = url;
          a.download = `UPS-Label-${shipment.trackingNumber}-${pkgIndex + 1}.pdf`;
          a.click();
        }
        
        setLabelsPrinted(prev => ({ ...prev, [pkgIndex]: true }));
        notify(lang === 'en' ? 'üìÑ UPS label opened' : 'üìÑ √âtiquette UPS ouverte');
      } catch (err) {
        console.error('Error opening label:', err);
        notify(lang === 'en' ? 'Error opening label' : 'Erreur ouverture √©tiquette', 'error');
      }
    } else {
      // Fallback to generated label if no real PDF
      const s = shipment;
      const w = window.open('', '_blank');
      if (!w) { notify(lang === 'en' ? 'Popup blocked' : 'Popup bloqu√©', 'error'); return; }
      w.document.write(`<html><head><title>UPS Label</title><style>body{font-family:Arial;padding:20px}.label{border:3px solid #351C15;padding:20px;max-width:400px;margin:0 auto}.ups{font-size:32px;font-weight:bold;color:#351C15;text-align:center}.tracking{font-size:18px;font-family:monospace;text-align:center;margin:20px 0;padding:10px;background:#f5f5f5}.addr{margin:15px 0;padding:15px;border:1px solid #ddd}</style></head><body><div class="label"><div class="ups">UPS</div><div class="tracking">${s.trackingNumber}</div><div class="addr"><small>${lang === 'en' ? 'RECIPIENT:' : 'DESTINATAIRE:'}</small><br><strong>${s.address.company_name}</strong><br>${s.address.attention ? '√Ä l\'att. de: ' + s.address.attention + '<br>' : ''}${s.address.address_line1}<br>${s.address.postal_code} ${s.address.city}<br>${s.address.country}</div><div class="addr"><small>${lang === 'en' ? 'SENDER:' : 'EXP√âDITEUR:'}</small><br><strong>LIGHTHOUSE FRANCE</strong><br>16 rue Paul Sejourne<br>94000 Cr√©teil<br>France</div><p style="text-align:center;font-size:20px;font-weight:bold">${s.parcels} COLIS - ${s.weight} KG</p><p style="text-align:center;color:#666">${order.request_number}</p></div><script>window.print()</script></body></html>`);
      w.document.close();
      setLabelsPrinted(prev => ({ ...prev, [pkgIndex]: true }));
    }
  };
  
  const printBL = () => {
    const bl = generateBLContent();
    const employeeName = profile?.full_name || 'Lighthouse France';
    const biz = businessSettings || {};
    const w = window.open('', '_blank');
    if (!w) { notify(lang === 'en' ? 'Popup blocked' : 'Popup bloqu√©', 'error'); return; }
    w.document.write(`<!DOCTYPE html>
<html>
<head>
  <title>BL - ${bl.blNumber}</title>
  <style>
    @page { 
      margin: 15mm; 
      size: A4;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body { font-family: Arial, sans-serif; font-size: 11pt; color: #333; }
    .page { 
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 15px 25px;
      position: relative;
    }
    
    /* Watermark - on top of everything */
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.12;
      pointer-events: none;
      z-index: 999;
    }
    .watermark img { width: 500px; height: auto; }
    
    .content { flex: 1 0 auto; }
    .header { margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #333; display: flex; justify-content: space-between; align-items: flex-start; }
    .header img { height: 50px; }
    .header-right { text-align: right; }
    .doc-title { font-size: 18pt; font-weight: bold; color: #2D5A7B; margin: 0; }
    .doc-number { font-size: 12pt; font-weight: bold; color: #2D5A7B; margin-top: 4px; }
    .doc-ref { font-size: 9pt; color: #666; margin-top: 2px; }
    .info-row { display: flex; justify-content: space-between; margin: 12px 0; }
    .client-box { background: rgba(248,249,250,0.85); border: 1px solid #ddd; padding: 15px; margin: 12px 0; }
    .client-label { font-size: 9pt; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
    .client-name { font-size: 12pt; font-weight: bold; margin-bottom: 5px; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th { background: rgba(51,51,51,0.35); color: #333; padding: 10px 12px; text-align: left; font-size: 10pt; font-weight: bold; border-bottom: 2px solid #333; }
    td { padding: 10px 12px; border-bottom: 1px solid #ddd; font-size: 10pt; background: rgba(255,255,255,0.9); }
    tr:nth-child(even) td { background: rgba(249,249,249,0.9); }
    .shipping-section { margin: 15px 0; }
    .shipping-title { font-weight: bold; font-size: 11pt; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
    .shipping-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .shipping-item { display: flex; padding: 6px 0; }
    .shipping-label { color: #666; width: 130px; }
    .shipping-value { font-weight: 600; }
    .prepared-by { font-size: 10pt; margin-top: 12px; color: #666; }
    .prepared-by strong { color: #333; }
    
    .footer-section { 
      flex-shrink: 0;
      margin-top: auto;
      padding-top: 12px; 
      border-top: 1px solid #ccc;
    }
    .footer-content { position: relative; }
    .footer-logo { position: absolute; left: 10px; top: 0; }
    .footer-logo img { height: 75px; }
    .footer-info { font-size: 8pt; color: #555; text-align: center; line-height: 1.8; }
    .footer-info strong { color: #333; font-size: 8pt; }
    
    @media print { 
      @page { margin: 15mm; }
      .page { min-height: 100%; padding: 10px 20px; }
      .watermark { position: fixed; }
      /* Make backgrounds print */
      th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      td { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body onload="window.print()">
  <div class="page">
    <!-- Watermark - shows through everything -->
    <div class="watermark">
      <img src="/images/logos/Lighthouse-Square-logo.png" alt="" onerror="this.parentElement.innerHTML='<div style=\\'font-size:150px;font-weight:bold;color:#000;opacity:0.5\\'>LWS</div>'">
    </div>
    
    <div class="content">
      <div class="header">
        <img src="/images/logos/lighthouse-logo.png" alt="Lighthouse" onerror="this.outerHTML='<div style=\\'font-size:24px;font-weight:bold;color:#333\\'>LIGHTHOUSE<div style=\\'font-size:10px;color:#666\\'>FRANCE</div></div>'">
        <div class="header-right">
          <div class="doc-title">{lang === 'en' ? 'DELIVERY NOTE' : 'BON DE LIVRAISON'}</div>
          <div class="doc-number">N¬∞ ${bl.blNumber}</div>
          <div class="doc-ref">R√©f: ${bl.orderNumber}</div>
        </div>
      </div>

      <div class="info-row">
        <div><span style="color:#666">${biz.city || 'Cr√©teil'}, le</span> <strong>${bl.date}</strong></div>
      </div>

      <div class="client-box">
        <div class="client-label">{lang === 'en' ? 'Recipient' : 'Destinataire'}</div>
        <div class="client-name">${bl.client.name}</div>
        ${bl.client.attention ? `<div>${lang === 'en' ? "Attention: " : "√Ä l'attention de: "}<strong>${bl.client.attention}</strong></div>` : ''}
        <div>${bl.client.street}</div>
        <div>${bl.client.city}</div>
        <div>${bl.client.country}</div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:50px">{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
            <th style="width:120px">{lang === 'en' ? 'Reference' : 'R√©f√©rence'}</th>
            <th>{lang === 'en' ? 'Description' : 'D√©signation'}</th>
          </tr>
        </thead>
        <tbody>
          ${bl.parts.map(p => `
            <tr>
              <td style="text-align:center;font-weight:600">${p.quantity}</td>
              <td style="font-family:monospace;font-size:9pt">${p.partNumber}</td>
              <td>${p.description}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <div class="shipping-section">
        <div class="shipping-title">{lang === 'en' ? 'Shipping Information' : "Informations d'exp√©dition"}</div>
        <div class="shipping-grid">
          <div class="shipping-item"><span class="shipping-label">{lang === 'en' ? 'Carrier:' : 'Transporteur:'}</span><span class="shipping-value">${bl.shipping.carrier}</span></div>
          <div class="shipping-item"><span class="shipping-label">{lang === 'en' ? 'Tracking #:' : 'N¬∞ de suivi:'}</span><span class="shipping-value" style="font-family:monospace">${bl.shipping.tracking}</span></div>
          <div class="shipping-item"><span class="shipping-label">{lang === 'en' ? 'Number of parcels:' : 'Nombre de colis:'}</span><span class="shipping-value">${bl.shipping.parcels}</span></div>
          <div class="shipping-item"><span class="shipping-label">{lang === 'en' ? 'Weight:' : 'Poids:'}</span><span class="shipping-value">${bl.shipping.weight} kg</span></div>
        </div>
      </div>

      <div class="prepared-by">
        Pr√©par√© par: <strong>${employeeName}</strong>
      </div>
    </div>

    <div class="footer-section">
      <div class="footer-content">
        <div class="footer-logo">
          <img src="/images/logos/capcert-logo.png" alt="CAPCERT" onerror="this.outerHTML='<div style=\\'font-size:18px;color:#333;border:2px solid #333;padding:18px 24px;border-radius:6px;text-align:center\\'><strong>CAPCERT</strong><br>ISO 9001</div>'">
        </div>
        <div class="footer-info">
          <strong>${biz.company_name || 'Lighthouse France SAS'}</strong> au capital de ${biz.capital || '10 000'} ‚Ç¨<br>
          ${biz.address || '16 rue Paul S√©journ√©'}, ${biz.postal_code || '94000'} ${biz.city || 'CR√âTEIL'} | T√©l. ${biz.phone || '01 43 77 28 07'}<br>
          SIRET ${biz.siret || '50178134800013'} | TVA ${biz.tva || 'FR 86501781348'}<br>
          ${biz.email || 'France@golighthouse.com'} | ${biz.website || 'www.golighthouse.fr'}
        </div>
      </div>
    </div>
  </div>

</body>
</html>`);
    w.document.close();
    setBlsPrinted(prev => ({ ...prev, [0]: true }));
  };
  
  // Mark as shipped - saves all documents
  const markAsShipped = async () => {
    setSaving(true);
    try {
      // Get BL number from database
      let blNumber = null;
      try {
        const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'BL' });
        if (!docNumError && docNumData) {
          blNumber = docNumData;
        }
      } catch (e) {
        console.error('Could not generate BL number:', e);
        // Fallback to old method
        const poNum = order.request_number?.replace('PO-', '') || '00000';
        const date = new Date();
        const dateStr = `${String(date.getDate()).padStart(2, '0')}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getFullYear()).slice(-2)}`;
        blNumber = `BL-${poNum}-${dateStr}`;
      }
      
      let upsLabelUrl = null;
      let blUrl = null;
      
      // Save UPS label PDF if we have it
      const labelData = upsLabels[0];
      if (labelData) {
        try {
          const byteCharacters = atob(labelData);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const upsPdfBlob = new Blob([byteArray], { type: 'application/pdf' });
          
          const safeTracking = (shipment.trackingNumber || 'label').replace(/[^a-zA-Z0-9-_]/g, '');
          const upsFileName = `${order.request_number}_UPS_${safeTracking}_${Date.now()}.pdf`;
          upsLabelUrl = await uploadPDFToStorage(upsPdfBlob, `shipping/${order.request_number}`, upsFileName);
          console.log('UPS label uploaded:', upsLabelUrl);
        } catch (err) {
          console.error('Error saving UPS label:', err);
        }
      }
      
      // Generate BL PDF by capturing the visible preview element
      try {
        // Load html2canvas if not already loaded
        if (!window.html2canvas) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        
        // Capture the visible BL preview element
        const element = document.getElementById('bl-preview-parts');
        if (element) {
          // Update the BL number display element
          const numberEl = element.querySelector('[data-bl-number]');
          if (numberEl) numberEl.textContent = 'N¬∞ ' + blNumber;
          
          const canvas = await window.html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
          const jsPDF = await loadJsPDF();
          const pdf = new jsPDF('p', 'mm', 'a4');
          const imgData = canvas.toDataURL('image/jpeg', 0.95);
          // Always stretch to full A4
          pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
          
          const blPdfBlob = pdf.output('blob');
          const safeBLNumber = blNumber.replace(/[^a-zA-Z0-9-_]/g, '');
          const blFileName = `${order.request_number}_BL_${safeBLNumber}_${Date.now()}.pdf`;
          blUrl = await uploadPDFToStorage(blPdfBlob, `shipping/${order.request_number}`, blFileName);
          console.log('BL uploaded:', blUrl);
        } else {
          console.error('BL preview element not found');
        }
      } catch (err) {
        console.error('Error saving BL:', err);
      }
      
      // Update service_request - store shipping data in quote_data JSON field
      const existingQuoteData = order.quote_data || {};
      const updatedQuoteData = {
        ...existingQuoteData,
        shipping: {
          trackingNumber: shipment.trackingNumber,
          blNumber: blNumber,
          parcels: shipment.parcels,
          weight: shipment.weight,
          shippedAt: new Date().toISOString(),
          shippedBy: profile?.full_name || 'Admin',
          upsLabelUrl: upsLabelUrl || null,
          blUrl: blUrl || null
        }
      };
      
      const { error: updateError } = await supabase
        .from('service_requests')
        .update({
          status: 'shipped',
          shipped_at: new Date().toISOString(),
          quote_data: updatedQuoteData
        })
        .eq('id', order.id);
      
      if (updateError) throw updateError;
      
      // Also save as attachments for easy access (errors are non-critical)
      if (upsLabelUrl) {
        const { error: attErr1 } = await supabase.from('request_attachments').insert({
          request_id: order.id,
          file_name: `UPS-Label-${shipment.trackingNumber}.pdf`,
          file_url: upsLabelUrl,
          file_type: 'ups_label',
          uploaded_by: profile?.id || null
        });
        if (attErr1) console.error('UPS label attachment error:', attErr1);
      }
      
      if (blUrl) {
        const { error: attErr2 } = await supabase.from('request_attachments').insert({
          request_id: order.id,
          file_name: `${blNumber}.pdf`,
          file_url: blUrl,
          file_type: 'bl',
          uploaded_by: profile?.id || null
        });
        if (attErr2) console.error('BL attachment error:', attErr2);
      }
      
      notify(lang === 'en' ? 'üöö Order shipped! Documents saved.' : 'üöö Commande exp√©di√©e! Documents sauvegard√©s.');
      reload();
      onClose();
    } catch (err) {
      notify(lang === 'en' ? `Error: ${err.message}` : `Erreur: ${err.message}`, 'error');
    }
    setSaving(false);
  };
  
  const stepLabels = [(lang === 'en' ? 'Verification' : 'V√©rification'), (lang === 'en' ? 'UPS Label' : '√âtiquette UPS'), (lang === 'en' ? 'Delivery Note' : 'Bon de Livraison')];
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={onClose}>
      <div className="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="px-6 py-4 border-b bg-gradient-to-r from-green-600 to-emerald-600 text-white">
          <div className="flex justify-between items-center">
            <div>
              <h2 className="text-xl font-bold">üöö Exp√©dition - {order.request_number}</h2>
              <p className="text-green-100 text-sm">{parts.length} {lang === 'en' ? 'part(s)' : 'pi√®ce(s)'}</p>
            </div>
            <button onClick={onClose} className="text-white/70 hover:text-white text-2xl">&times;</button>
          </div>
          <div className="flex items-center gap-1 mt-4">
            {stepLabels.map((label, idx) => (
              <div key={idx} className="flex items-center flex-1">
                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${step > idx + 1 ? 'bg-white text-green-600' : step === idx + 1 ? 'bg-white text-green-600' : 'bg-green-500 text-green-200'}`}>
                  {step > idx + 1 ? '‚úì' : idx + 1}
                </div>
                <span className={`ml-2 text-xs hidden sm:inline ${step === idx + 1 ? 'text-white font-medium' : 'text-green-200'}`}>{label}</span>
                {idx < 2 && <div className="flex-1 h-0.5 bg-green-500 mx-2" />}
              </div>
            ))}
          </div>
        </div>
        
        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* Loading State */}
          {loading && (
            <div className="flex items-center justify-center py-12">
              <div className="text-center">
                <div className="text-4xl mb-4">‚è≥</div>
                <p className="text-gray-500">{lang === 'en' ? 'Loading information...' : 'Chargement des informations...'}</p>
              </div>
            </div>
          )}
          
          {/* Step 1: Review */}
          {!loading && step === 1 && shipment && (
            <div className="space-y-6">
              {/* Address Section */}
              <div className="bg-white border-2 border-gray-200 rounded-xl">
                <div className="bg-amber-50 px-4 py-3 border-b">
                  <h3 className="font-bold text-amber-800">{lang === 'en' ? 'üìç Shipping address' : 'üìç Adresse de livraison'}</h3>
                </div>
                <div className="p-4 grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Company *' : 'Soci√©t√© *'}</label>
                    <input type="text" value={shipment.address.company_name} onChange={e => updateAddress('company_name', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? "Attention" : "√Ä l'attention de"}</label>
                    <input type="text" value={shipment.address.attention} onChange={e => updateAddress('attention', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder={lang === 'en' ? 'Contact name' : 'Nom du contact'} />
                  </div>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Address *' : 'Adresse *'}</label>
                    <input type="text" value={shipment.address.address_line1} onChange={e => updateAddress('address_line1', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Postal code *' : 'Code postal *'}</label>
                    <input type="text" value={shipment.address.postal_code} onChange={e => updateAddress('postal_code', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'City *' : 'Ville *'}</label>
                    <input type="text" value={shipment.address.city} onChange={e => updateAddress('city', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('country')}</label>
                    <input type="text" value={shipment.address.country} onChange={e => updateAddress('country', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('phone')}</label>
                    <input type="text" value={shipment.address.phone || ''} onChange={e => updateAddress('phone', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="+33..." />
                  </div>
                </div>
              </div>
              
              {/* Parts Section */}
              <div className="bg-white border-2 border-gray-200 rounded-xl">
                <div className="bg-blue-50 px-4 py-3 border-b">
                  <h3 className="font-bold text-blue-800">{lang === 'en' ? `üì¶ Parts to ship (${parts.length})` : `üì¶ Pi√®ces √† exp√©dier (${parts.length})`}</h3>
                </div>
                <div className="p-4">
                  <div className="space-y-2">
                    {parts.map((part, idx) => (
                      <div key={idx} className="flex items-center gap-3 p-3 rounded-lg border-2 border-gray-200 bg-gray-50">
                        <div className="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center font-bold text-amber-700">
                          {part.quantity}
                        </div>
                        <div className="flex-1">
                          <div className="font-medium">{part.description}</div>
                          <div className="text-sm text-gray-500 font-mono">{part.partNumber || '‚Äî'}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              
              {/* Shipping Details */}
              <div className="bg-white border-2 border-gray-200 rounded-xl">
                <div className="bg-green-50 px-4 py-3 border-b flex justify-between items-center">
                  <h3 className="font-bold text-green-800">{lang === 'en' ? "üöö Shipping Details" : "üöö D√©tails d'exp√©dition"}</h3>
                  <span className="text-xs text-green-600">{lang === 'en' ? 'üí° UPS creates 1 label per package' : 'üí° UPS cr√©e 1 √©tiquette par colis'}</span>
                </div>
                <div className="p-4 grid md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Number of parcels' : 'Nombre de colis'}</label>
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={() => updateShipmentField('parcels', Math.max(1, (shipment.parcels || 1) - 1))}
                        className="w-10 h-10 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-lg"
                      >-</button>
                      <input 
                        type="number" 
                        min="1" 
                        value={shipment.parcels} 
                        onChange={e => updateShipmentField('parcels', parseInt(e.target.value) || 1)} 
                        className="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center font-bold text-lg" 
                      />
                      <button 
                        onClick={() => updateShipmentField('parcels', (shipment.parcels || 1) + 1)}
                        className="w-10 h-10 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold text-lg"
                      >+</button>
                    </div>
                    {shipment.parcels > 1 && (
                      <p className="text-xs text-green-600 mt-1">üì¶ {lang === 'en' ? `${shipment.parcels} labels will be created` : `${shipment.parcels} √©tiquettes seront cr√©√©es`}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Total weight (kg)' : 'Poids total (kg)'}</label>
                    <input type="text" value={shipment.weight} onChange={e => updateShipmentField('weight', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'DN #' : 'BL #'}</label>
                    <input type="text" value={generateBLNumber()} disabled className="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 font-mono" />
                  </div>
                  <div className="md:col-span-3">
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Internal notes' : 'Notes internes'}</label>
                    <textarea value={shipment.notes || ''} onChange={e => updateShipmentField('notes', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" rows={2} placeholder={lang === 'en' ? 'Shipping notes...' : "Notes pour l'exp√©dition..."} />
                  </div>
                </div>
              </div>
              
              {/* Order Summary */}
              <div className="bg-gray-50 rounded-xl p-4">
                <h4 className="font-bold text-gray-700 mb-2">{lang === 'en' ? 'üìã Order Summary' : 'üìã R√©capitulatif Commande'}</h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                  <div><span className="text-gray-500">{lang === 'en' ? 'No.:' : 'N¬∞:'}</span> <span className="font-mono font-bold text-amber-600">{order.request_number}</span></div>
                  <div><span className="text-gray-500">{lang === 'en' ? 'Client:' : 'Client:'}</span> <span className="font-medium">{order.companies?.name}</span></div>
                  <div><span className="text-gray-500">{lang === 'en' ? 'Parts:' : 'Pi√®ces:'}</span> <span className="font-medium">{parts.length}</span></div>
                  <div><span className="text-gray-500">{lang === 'en' ? 'Date:' : 'Date:'}</span> <span className="font-medium">{new Date().toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</span></div>
                </div>
              </div>
            </div>
          )}
          
          {/* Step 2: UPS Labels */}
          {step === 2 && shipment && (
            <div className="bg-white border-2 rounded-xl p-6 mb-4">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h3 className="font-bold text-lg">{lang === 'en' ? 'Parts Shipping' : 'Exp√©dition Pi√®ces'}</h3>
                  <p className="text-gray-500">{shipment.address.postal_code} {shipment.address.city}</p>
                </div>
                <div className="text-right">
                  <p className="font-mono text-lg font-bold text-amber-600">{shipment.trackingNumber}</p>
                  <a href={`https://www.ups.com/track?tracknum=${shipment.trackingNumber}`} target="_blank" rel="noopener noreferrer" className="text-sm text-blue-500 hover:underline">{lang === 'en' ? 'Track ‚Üí' : 'Suivre ‚Üí'}</a>
                </div>
              </div>
              
              {/* Show all package labels */}
              <div className="space-y-4">
                {(shipment.packageLabels || [{ trackingNumber: shipment.trackingNumber }]).map((pkg, pkgIdx) => (
                  <div key={pkgIdx} className="bg-gray-50 rounded-lg p-4 border">
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="text-2xl font-bold text-[#351C15]">UPS</div>
                        <div className="font-mono text-sm">{pkg.trackingNumber || shipment.trackingNumber}</div>
                        <div className="text-sm text-gray-500 mt-1">
                          Colis {pkgIdx + 1} / {shipment.parcels || 1}
                        </div>
                      </div>
                      <div className="flex items-center gap-3">
                        <span className={labelsPrinted[pkgIdx] ? 'text-green-600 font-medium text-sm' : 'text-gray-400 text-sm'}>
                          {labelsPrinted[pkgIdx] ? (lang === 'en' ? '‚úì Printed' : '‚úì Imprim√©') : ''}
                        </span>
                        <button 
                          onClick={() => printLabel(pkgIdx)} 
                          className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium text-sm"
                        >
                          üñ®Ô∏è Imprimer
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              
              {/* Summary */}
              <div className="mt-4 pt-4 border-t flex justify-between items-center text-sm text-gray-600">
                <span>{shipment.address.company_name} ‚Ä¢ {shipment.parcels || 1} {lang === 'en' ? 'parcels' : 'colis'} ‚Ä¢ {shipment.weight} kg</span>
                <span className="text-gray-400">{order.request_number}</span>
              </div>
            </div>
          )}
          
          {/* Step 3: BL Preview */}
          {step === 3 && shipment && (() => {
            const bl = generateBLContent();
            const employeeName = profile?.full_name || 'Lighthouse France';
            const biz = businessSettings || {};
            return (
              <div className="mb-4">
                {/* Controls bar */}
                <div className="bg-gray-100 px-4 py-3 rounded-t-xl flex justify-between items-center">
                  <div>
                    <h3 className="font-bold">{bl.blNumber}</h3>
                    <p className="text-sm text-gray-500">{bl.parts.length} {lang === 'en' ? 'part(s)' : 'pi√®ce(s)'}</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className={blsPrinted[0] ? 'text-green-600 font-medium' : 'text-gray-400'}>{blsPrinted[0] ? (lang === 'en' ? '‚úì Printed' : '‚úì Imprim√©') : ''}</span>
                    <button onClick={() => setStep(1)} className="px-3 py-1 bg-white hover:bg-gray-50 border rounded text-sm">{lang === 'en' ? '‚úèÔ∏è Edit' : '‚úèÔ∏è Modifier'}</button>
                    <button onClick={printBL} className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">{lang === 'en' ? 'üñ®Ô∏è Print DN' : 'üñ®Ô∏è Imprimer BL'}</button>
                  </div>
                </div>
                
                {/* Clean PDF Preview with Watermark */}
                <div className="bg-white border-2 border-t-0 rounded-b-xl overflow-hidden shadow-lg">
                  <div id="bl-preview-parts" style={{ fontFamily: 'Arial, sans-serif', fontSize: '11pt', color: '#333', padding: '25px 30px', maxWidth: '210mm', margin: '0 auto', background: 'white', height: '297mm', position: 'relative', overflow: 'hidden' }}>
                    {/* Watermark - on top of everything */}
                    <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', opacity: 0.12, pointerEvents: 'none', zIndex: 999 }}>
                      <img src="/images/logos/Lighthouse-Square-logo.png" alt="" style={{ width: '500px', height: 'auto' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:150px;font-weight:bold;color:#000">LWS</div>'; }} />
                    </div>
                    
                    {/* Content area */}
                    <div>
                      {/* Header */}
                      <div style={{ marginBottom: '15px', paddingBottom: '12px', borderBottom: '2px solid #333', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <img src="/images/logos/lighthouse-logo.png" alt="Lighthouse" style={{ height: '50px' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:24px;font-weight:bold;color:#333">LIGHTHOUSE<div style="font-size:10px;color:#666">FRANCE</div></div>'; }} />
                        <div style={{ textAlign: 'right' }}>
                          <div style={{ fontSize: '18pt', fontWeight: 'bold', color: '#2D5A7B' }}>{lang === 'en' ? 'DELIVERY NOTE' : 'BON DE LIVRAISON'}</div>
                          <div data-bl-number="true" style={{ fontSize: '12pt', fontWeight: 'bold', color: '#2D5A7B', marginTop: '4px' }}>N¬∞ {bl.blNumber}</div>
                          <div style={{ fontSize: '9pt', color: '#666', marginTop: '4px' }}>{lang === 'en' ? 'Ref:' : 'R√©f:'} {bl.orderNumber}</div>
                        </div>
                      </div>

                      {/* Info row */}
                      <div style={{ display: 'flex', justifyContent: 'space-between', margin: '12px 0' }}>
                        <div><span style={{ color: '#666' }}>{biz.city || 'Cr√©teil'}, le</span> <strong>{bl.date}</strong></div>
                      </div>

                      {/* Two column layout: Client + R√©f√©rences */}
                      <div style={{ display: 'flex', gap: '15px', margin: '12px 0' }}>
                        {/* Client box */}
                        <div style={{ flex: '1.5', background: 'rgba(248,249,250,0.85)', border: '1px solid #ddd', padding: '15px' }}>
                          <div style={{ fontSize: '9pt', color: '#666', textTransform: 'uppercase', fontWeight: '600', marginBottom: '5px' }}>{lang === 'en' ? 'Recipient' : 'Destinataire'}</div>
                          <div style={{ fontSize: '12pt', fontWeight: 'bold', marginBottom: '5px' }}>{bl.client.name}</div>
                          {bl.client.attention && <div>{lang === 'en' ? "Attention: " : "√Ä l'attention de: "}<strong>{bl.client.attention}</strong></div>}
                          <div>{bl.client.street}</div>
                          <div>{bl.client.city}</div>
                          <div>{bl.client.country}</div>
                        </div>
                        {/* R√©f√©rences box */}
                        <div style={{ flex: '1', background: 'rgba(248,249,250,0.85)', border: '1px solid #ddd', padding: '15px' }}>
                          <div style={{ fontSize: '9pt', color: '#666', textTransform: 'uppercase', fontWeight: '600', marginBottom: '5px' }}>{lang === 'en' ? 'Order References' : 'R√©f√©rences Commande'}</div>
                          <div style={{ fontSize: '11pt', fontWeight: 'bold', color: '#2D5A7B' }}>{bl.orderNumber}</div>
                        </div>
                      </div>

                      {/* Table - semi-transparent header */}
                      <table style={{ width: '100%', borderCollapse: 'collapse', margin: '12px 0' }}>
                        <thead>
                          <tr style={{ background: 'rgba(51,51,51,0.35)' }}>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', width: '50px', fontWeight: 'bold' }}>{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', width: '120px', fontWeight: 'bold' }}>{lang === 'en' ? 'Reference' : 'R√©f√©rence'}</th>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', fontWeight: 'bold' }}>{lang === 'en' ? 'Description' : 'D√©signation'}</th>
                          </tr>
                        </thead>
                        <tbody>
                          {bl.parts.map((p, i) => (
                            <tr key={i}>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', textAlign: 'center', fontWeight: '600', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>{p.quantity}</td>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '9pt', fontFamily: 'monospace', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>{p.partNumber}</td>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>{p.description}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>

                      {/* Shipping section */}
                      <div style={{ margin: '15px 0' }}>
                        <div style={{ fontWeight: 'bold', fontSize: '11pt', marginBottom: '10px', borderBottom: '1px solid #333', paddingBottom: '5px' }}>{lang === 'en' ? 'Shipping Information' : "Informations d'exp√©dition"}</div>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>{lang === 'en' ? 'Carrier:' : 'Transporteur:'}</span><span style={{ fontWeight: '600' }}>{bl.shipping.carrier}</span></div>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>{lang === 'en' ? 'Tracking #:' : 'N¬∞ de suivi:'}</span><span style={{ fontWeight: '600', fontFamily: 'monospace' }}>{bl.shipping.tracking}</span></div>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>{lang === 'en' ? 'Number of parcels:' : 'Nombre de colis:'}</span><span style={{ fontWeight: '600' }}>{bl.shipping.parcels}</span></div>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>{lang === 'en' ? 'Weight:' : 'Poids:'}</span><span style={{ fontWeight: '600' }}>{bl.shipping.weight} kg</span></div>
                        </div>
                      </div>

                      {/* Prepared by */}
                      <div style={{ fontSize: '10pt', marginTop: '12px', color: '#666' }}>
                        {lang === 'en' ? 'Prepared by:' : 'Pr√©par√© par:'} <strong style={{ color: '#333' }}>{employeeName}</strong>
                      </div>
                    </div>

                    {/* Footer - ABSOLUTE positioned at bottom */}
                    <div style={{ position: 'absolute', bottom: '15px', left: '30px', right: '30px', paddingTop: '12px', borderTop: '1px solid #ccc' }}>
                      <div style={{ position: 'relative' }}>
                        <div style={{ position: 'absolute', left: '10px', top: '0' }}>
                          <img src="/images/logos/capcert-logo.png" alt="CAPCERT" style={{ height: '75px' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:14px;color:#333;border:2px solid #333;padding:12px 16px;border-radius:6px;text-align:center"><strong>CAPCERT</strong><br/>ISO 9001</div>'; }} />
                        </div>
                        <div style={{ fontSize: '8pt', color: '#555', textAlign: 'center', lineHeight: '1.8' }}>
                          <strong style={{ color: '#333', fontSize: '8pt' }}>{biz.company_name || 'Lighthouse France SAS'}</strong> au capital de {biz.capital || '10 000'} ‚Ç¨<br/>
                          {biz.address || '16 rue Paul S√©journ√©'}, {biz.postal_code || '94000'} {biz.city || 'CR√âTEIL'} | T√©l. {biz.phone || '01 43 77 28 07'}<br/>
                          SIRET {biz.siret || '50178134800013'} | TVA {biz.tva || 'FR 86501781348'}<br/>
                          {biz.email || 'France@golighthouse.com'} | {biz.website || 'www.golighthouse.fr'}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })()}
        </div>
        
        {/* Footer */}
        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between">
          {step === 1 && (
            <>
              <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{t('cancel')}</button>
              <button 
                onClick={createUPSLabels} 
                disabled={upsLoading || !shipment?.address?.company_name || !shipment?.address?.address_line1}
                className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
              >
                {upsLoading ? (
                  <>
                    <span className="animate-spin">‚è≥</span> {lang === 'en' ? 'Creating UPS label...' : 'Cr√©ation √©tiquette UPS...'}
                  </>
                ) : (
                  <>{lang === 'en' ? 'üì¶ Create UPS Label ‚Üí' : 'üì¶ Cr√©er √âtiquette UPS ‚Üí'}</>
                )}
              </button>
            </>
          )}
          {step === 2 && (
            <>
              <button onClick={() => setStep(1)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
              <button onClick={() => setStep(3)} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">{lang === 'en' ? 'Continue to DN ‚Üí' : 'Continuer vers BL ‚Üí'}</button>
            </>
          )}
          {step === 3 && (
            <>
              <button onClick={() => setStep(2)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
              <button onClick={markAsShipped} disabled={saving} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50">{saving ? (lang === 'en' ? '‚è≥ Processing...' : '‚è≥ Traitement...') : (lang === 'en' ? 'üöö Mark Shipped' : 'üöö Marquer Exp√©di√©')}</button>
            </>
          )}
        </div>
      </div>
    </div>
  );
}


// ============================================
// INTERNAL SHIPPING MODAL - Ship to other Lighthouse offices
// ============================================
const LIGHTHOUSE_OFFICES = {
  hollande: {
    label: 'Hollande (Netherlands)',
    company_name: 'Lighthouse Worldwide Solutions BV',
    attention: 'Rene Van Boxtel',
    address_line1: 'Van Heemstraweg 19A',
    city: 'Bowen Leeuwen',
    postal_code: '6657 KD',
    country: 'Nederland',
    country_code: 'NL',
    phone: '+31 79 362 9060'
  },
  usa: {
    label: 'USA (White City, OR)',
    company_name: 'Lighthouse Worldwide Solutions Inc.',
    attention: '',
    address_line1: '3 Terri Lane, Suite 10',
    city: 'White City',
    state: 'OR',
    postal_code: '97503',
    country: 'United States',
    country_code: 'US',
    phone: '+1 (541) 770-5020'
  }
};

function InternalShippingModal({ rma, devices, onClose, notify, reload, profile, businessSettings, lang = 'fr' }) {
  const t = k => k;
  // Steps: 1=Config, 2=UPS Label Created + BL Preview, 3=Saved
  const [step, setStep] = useState(1);
  const [saving, setSaving] = useState(false);
  const [selectedDeviceIds, setSelectedDeviceIds] = useState(new Set());
  const [destination, setDestination] = useState('hollande');
  const [deviceServices, setDeviceServices] = useState({});
  const [deviceNotes, setDeviceNotes] = useState({}); // { deviceId: 'note text' }
  const [notes, setNotes] = useState('');
  const [parcels, setParcels] = useState(1);
  const [weight, setWeight] = useState('5');
  const [generatedBL, setGeneratedBL] = useState(null);
  
  // UPS API state
  const [upsLoading, setUpsLoading] = useState(false);
  const [upsLabel, setUpsLabel] = useState(null); // base64 PDF label data
  const [trackingNumber, setTrackingNumber] = useState('');

  const biz = businessSettings || {};
  const destOffice = LIGHTHOUSE_OFFICES[destination];
  const employeeName = profile?.full_name || 'Lighthouse France';

  // Initialize all devices with calibration default
  useEffect(() => {
    const defaults = {};
    devices.forEach(d => { defaults[d.id] = 'calibration'; });
    setDeviceServices(defaults);
  }, [devices]);

  const toggleDevice = (id) => {
    setSelectedDeviceIds(prev => {
      const n = new Set(prev);
      n.has(id) ? n.delete(id) : n.add(id);
      return n;
    });
  };

  const toggleAll = () => {
    if (selectedDeviceIds.size === devices.length) {
      setSelectedDeviceIds(new Set());
    } else {
      setSelectedDeviceIds(new Set(devices.map(d => d.id)));
    }
  };

  const setDeviceService = (deviceId, service) => {
    setDeviceServices(prev => ({ ...prev, [deviceId]: service }));
  };

  const selectedDevices = devices.filter(d => selectedDeviceIds.has(d.id));

  // ===== Step 1 ‚Üí 2: Create UPS Label via API =====
  const createUPSLabel = async () => {
    if (selectedDeviceIds.size === 0) {
      notify('Please select at least one device', 'error');
      return;
    }
    
    setUpsLoading(true);
    try {
      const addr = destOffice;
      
      // Build packages
      const packagesList = [];
      for (let p = 0; p < (parcels || 1); p++) {
        packagesList.push({
          weight: parseFloat(weight) || 5,
          length: 40,
          width: 30,
          height: 30,
          description: `RMA ${rma.request_number} - Internal Transfer - Colis ${p + 1}/${parcels || 1}`
        });
      }
      
      // Call UPS Edge Function
      const { data, error } = await supabase.functions.invoke('ups-shipping', {
        body: {
          action: 'create_shipment',
          shipTo: {
            name: addr.attention || addr.company_name,
            company: addr.company_name,
            attentionName: addr.attention || addr.company_name,
            phone: addr.phone || '0000000000',
            addressLine1: addr.address_line1 || '',
            city: addr.city || '',
            stateProvinceCode: addr.state || '',
            postalCode: addr.postal_code || '',
            countryCode: addr.country_code || 'FR'
          },
          packages: packagesList,
          serviceCode: '11', // UPS Standard
          description: `RMA ${rma.request_number} - Internal Transfer to ${destination === 'hollande' ? 'NL' : 'US'}`,
          isReturn: false
        }
      });
      
      if (error) throw error;
      if (!data.success) throw new Error(data.error || 'UPS API error');
      
      // Store label data
      const labelData = data.packages?.[0]?.labelData || null;
      setUpsLabel(labelData);
      setTrackingNumber(data.trackingNumber || '');
      
      notify(`‚úÖ UPS label created: ${data.trackingNumber}`);
      setStep(2);
    } catch (err) {
      console.error('UPS Label creation error:', err);
      notify('‚ùå UPS Error: ' + (err.message || 'Unknown error'), 'error');
    }
    setUpsLoading(false);
  };

  // Print/view real UPS label
  const printUPSLabel = () => {
    if (upsLabel) {
      try {
        const byteCharacters = atob(upsLabel);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
      } catch (e) {
        console.error('Error opening label:', e);
      }
    }
  };

  // ===== Step 2 ‚Üí 3: Save BL + UPS label as internal docs =====
  const handleSave = async () => {
    setSaving(true);
    try {
      const destLabel = destination === 'hollande' ? 'Hollande' : 'USA';
      
      // Get BL number from database
      let blNumber = null;
      try {
        const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'BL' });
        if (!docNumError && docNumData) blNumber = docNumData;
      } catch (e) {
        const now = new Date();
        const mmyy = String(now.getMonth() + 1).padStart(2, '0') + String(now.getFullYear()).slice(-2);
        blNumber = `BL-${mmyy}-INT`;
      }

      // Capture BL preview as PDF
      let blUrl = null;
      try {
        if (!window.html2canvas) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        
        const element = document.getElementById('internal-bl-preview');
        if (element) {
          const numberEl = element.querySelector('[data-bl-number]');
          if (numberEl) numberEl.textContent = destLabel + ' ' + blNumber;
          
          const canvas = await window.html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
          const jsPDF = await loadJsPDF();
          const pdf = new jsPDF('p', 'mm', 'a4');
          const imgData = canvas.toDataURL('image/jpeg', 0.95);
          pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
          
          const blPdfBlob = pdf.output('blob');
          const safeNum = (blNumber || 'BL').replace(/[^a-zA-Z0-9-_]/g, '');
          const blFileName = `${destLabel}_BL_${safeNum}_${Date.now()}.pdf`;
          blUrl = await uploadPDFToStorage(blPdfBlob, `shipping/${rma.request_number}`, blFileName);
        }
      } catch (e) {
        console.error('Internal BL PDF error:', e);
      }

      // Save real UPS label PDF
      let upsLabelUrl = null;
      if (upsLabel && trackingNumber) {
        try {
          const byteCharacters = atob(upsLabel);
          const byteNumbers = new Array(byteCharacters.length);
          for (let j = 0; j < byteCharacters.length; j++) {
            byteNumbers[j] = byteCharacters.charCodeAt(j);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const upsPdfBlob = new Blob([byteArray], { type: 'application/pdf' });
          const safeTracking = trackingNumber.replace(/[^a-zA-Z0-9-_]/g, '');
          const upsFileName = `${destLabel}_UPS_${safeTracking}_${Date.now()}.pdf`;
          upsLabelUrl = await uploadPDFToStorage(upsPdfBlob, `shipping/${rma.request_number}`, upsFileName);
        } catch (e) {
          console.error('Internal UPS label save error:', e);
        }
      }

      // Save as INTERNAL attachments (not visible to customer)
      if (blUrl) {
        await supabase.from('request_attachments').insert({
          request_id: rma.id,
          file_name: `${destLabel}-${blNumber}.pdf`,
          file_url: blUrl,
          file_type: 'bl',
          category: 'internal_bl_intersite',
          device_serial: selectedDevices.map(d => d.serial_number).join(', ')
        });
      }
      if (upsLabelUrl) {
        await supabase.from('request_attachments').insert({
          request_id: rma.id,
          file_name: `UPS-${destLabel}-${trackingNumber}.pdf`,
          file_url: upsLabelUrl,
          file_type: 'ups_label',
          category: 'internal_ups_intersite',
          device_serial: selectedDevices.map(d => d.serial_number).join(', ')
        });
      }

      setGeneratedBL({ blNumber, blUrl, upsLabelUrl, destLabel, trackingNumber });
      setStep(3);
      notify(`Internal shipment to ${destLabel} saved!`);
      // Refresh parent so docs appear in Documents tab
      if (reload) reload();
    } catch (err) {
      console.error('Internal shipping save error:', err);
      notify('Error saving shipment: ' + (err.message || 'Unknown error'));
    }
    setSaving(false);
  };

  const getFrenchDateShort = () => {
    const d = new Date();
    const months = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={(e) => e.target === e.currentTarget && onClose()}>
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        {/* Header */}
        <div className="px-6 py-4 border-b bg-gradient-to-r from-indigo-600 to-purple-600 rounded-t-2xl">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-xl font-bold text-white flex items-center gap-2">
                üåç Internal Shipment ‚Äî Inter-Site Transfer
              </h2>
              <p className="text-indigo-200 text-sm">RMA: {rma.request_number} ‚Ä¢ Internal documents only</p>
            </div>
            <div className="flex items-center gap-3">
              <div className="flex items-center gap-1">
                {[1, 2, 3].map(s => (
                  <div key={s} className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                    s < step ? 'bg-white text-indigo-600' : s === step ? 'bg-white/30 text-white ring-2 ring-white' : 'bg-white/10 text-white/50'
                  }`}>{s < step ? '‚úì' : s}</div>
                ))}
              </div>
              <button onClick={onClose} className="text-white/70 hover:text-white text-2xl leading-none">√ó</button>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* ===== STEP 1: Configuration ===== */}
          {step === 1 && (
            <div className="space-y-6">
              {/* Destination */}
              <div>
                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">{lang === 'en' ? 'üìç Destination' : 'üìç Destination'}</h3>
                <div className="grid grid-cols-2 gap-3">
                  {Object.entries(LIGHTHOUSE_OFFICES).map(([key, office]) => (
                    <button
                      key={key}
                      onClick={() => setDestination(key)}
                      className={`p-4 rounded-xl border-2 text-left transition-all ${
                        destination === key 
                          ? 'border-indigo-500 bg-indigo-50 shadow-md' 
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <p className="font-bold text-lg">{key === 'hollande' ? 'üá≥üá±' : 'üá∫üá∏'} {office.label}</p>
                      <p className="text-sm text-gray-600 mt-1">{office.company_name}</p>
                      <p className="text-xs text-gray-400">{office.address_line1}, {office.postal_code} {office.city}</p>
                      {office.attention && <p className="text-xs text-gray-500 mt-1">Attn: {office.attention}</p>}
                    </button>
                  ))}
                </div>
              </div>

              {/* Device selection with per-device service */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-bold text-gray-800 flex items-center gap-2">{lang === 'en' ? 'üì¶ Devices & Service' : 'üì¶ Devices & Service'}</h3>
                  <button onClick={toggleAll} className="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                    {selectedDeviceIds.size === devices.length ? 'Deselect All' : 'Select All'}
                  </button>
                </div>
                <div className="space-y-2">
                  {devices.map(d => (
                    <div key={d.id} className={`rounded-lg border transition-all ${
                      selectedDeviceIds.has(d.id) ? 'border-indigo-300 bg-indigo-50' : 'border-gray-200 hover:bg-gray-50'
                    }`}>
                      <div className="flex items-center gap-3 p-3">
                        <input 
                          type="checkbox" 
                          checked={selectedDeviceIds.has(d.id)}
                          onChange={() => toggleDevice(d.id)}
                          className="w-5 h-5 text-indigo-600 rounded cursor-pointer"
                        />
                        <div className="flex-1 min-w-0">
                          <p className="font-medium flex items-center gap-2">{getDeviceImageUrl(d.model_name || d.model) && <img src={getDeviceImageUrl(d.model_name || d.model)} alt="" className="w-4 h-4 object-contain" />}{d.model_name || d.model || 'Device'}</p>
                          <p className="text-sm text-gray-500 font-mono">SN: {d.serial_number}</p>
                        </div>
                        {selectedDeviceIds.has(d.id) && (
                          <div className="flex items-center gap-2 shrink-0">
                            <button
                              onClick={() => setDeviceService(d.id, 'calibration')}
                              className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                deviceServices[d.id] === 'calibration' 
                                  ? 'bg-blue-500 text-white shadow-sm' 
                                  : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                              }`}
                            >üî¨ Calibration</button>
                            <button
                              onClick={() => setDeviceService(d.id, 'repair')}
                              className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                deviceServices[d.id] === 'repair' 
                                  ? 'bg-orange-500 text-white shadow-sm' 
                                  : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                              }`}
                            >üîß Repair</button>
                          </div>
                        )}
                      </div>
                      {selectedDeviceIds.has(d.id) && (
                        <div className="px-3 pb-3 pt-0 ml-8">
                          <input
                            type="text"
                            value={deviceNotes[d.id] || ''}
                            onChange={(e) => setDeviceNotes(prev => ({ ...prev, [d.id]: e.target.value }))}
                            placeholder={`Note for ${d.serial_number} (optional)...`}
                            className="w-full px-2 py-1.5 border rounded text-xs bg-white"
                          />
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Shipping details */}
              <div>
                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">üöö Shipping</h3>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-600 mb-1">Parcels</label>
                    <input type="number" value={parcels} onChange={(e) => setParcels(parseInt(e.target.value) || 1)} min="1" className="w-full px-3 py-2 border rounded-lg text-sm" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-600 mb-1">Weight per parcel (kg)</label>
                    <input type="text" value={weight} onChange={(e) => setWeight(e.target.value)} className="w-full px-3 py-2 border rounded-lg text-sm" />
                  </div>
                </div>
              </div>

              {/* Notes */}
              <div>
                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">{lang === 'en' ? 'üìù Notes / Instructions' : 'üìù Notes / Instructions'}</h3>
                <textarea
                  value={notes}
                  onChange={(e) => setNotes(e.target.value)}
                  placeholder="e.g. Please calibrate per ISO 21501-4. Return to Lighthouse France when complete..."
                  rows={4}
                  className="w-full px-3 py-2 border rounded-lg text-sm"
                />
              </div>
            </div>
          )}

          {/* ===== STEP 2: UPS Label Created + BL Preview ===== */}
          {step === 2 && (
            <div className="space-y-6">
              {/* UPS Label section */}
              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-bold text-gray-800">üè∑Ô∏è UPS Label ‚Äî {trackingNumber}</h3>
                  {upsLabel && (
                    <button onClick={printUPSLabel} className="px-4 py-2 bg-[#351C15] text-white rounded-lg text-sm font-medium hover:bg-[#4a2a20] flex items-center gap-2">
                      üñ®Ô∏è Print / View Label
                    </button>
                  )}
                </div>
                <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-center gap-4">
                  <div className="text-3xl">üì¶</div>
                  <div>
                    <p className="font-bold text-amber-900">UPS Shipping Label Created</p>
                    <p className="text-amber-700 font-mono text-sm">{trackingNumber}</p>
                    <p className="text-amber-600 text-xs mt-1">{parcels} parcel(s) ‚Ä¢ {weight} kg each ‚Ä¢ To: {destOffice.company_name}, {destOffice.city}</p>
                  </div>
                </div>
              </div>

              {/* BL Preview */}
              <h3 className="font-bold text-gray-800">{lang === 'en' ? 'üìÑ Delivery Note Preview' : 'üìÑ Bon de Livraison Preview'}</h3>
              <div className="border rounded-xl overflow-hidden bg-white shadow-sm">
                <div id="internal-bl-preview" style={{ fontFamily: 'Arial, sans-serif', fontSize: '11pt', color: '#333', padding: '25px 30px', maxWidth: '210mm', margin: '0 auto', background: 'white', height: '297mm', position: 'relative', overflow: 'hidden' }}>
                  {/* Watermark */}
                  <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', opacity: 0.12, pointerEvents: 'none', zIndex: 999 }}>
                    <img src="/images/logos/Lighthouse-Square-logo.png" alt="" style={{ width: '500px', height: 'auto' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:150px;font-weight:bold;color:#000">LWS</div>'; }} />
                  </div>
                  
                  <div>
                    {/* Header - Logo left, Title + BL/RMA right */}
                    <div style={{ marginBottom: '15px', paddingBottom: '12px', borderBottom: '2px solid #333', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                      <img src="/images/logos/lighthouse-logo.png" alt="Lighthouse" style={{ height: '50px' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:24px;font-weight:bold;color:#333">LIGHTHOUSE<div style="font-size:10px;color:#666">WORLDWIDE SOLUTIONS</div></div>'; }} />
                      <div style={{ textAlign: 'right' }}>
                        <div style={{ fontSize: '18pt', fontWeight: 'bold', color: '#2D5A7B' }}>{lang === 'en' ? 'DELIVERY NOTE' : 'BON DE LIVRAISON'}</div>
                        <div style={{ fontSize: '10pt', color: '#888', fontStyle: 'italic' }}>Internal Transfer ‚Äî {destination === 'hollande' ? 'Hollande' : 'USA'}</div>
                        <div data-bl-number="true" style={{ fontSize: '12pt', fontWeight: 'bold', color: '#2D5A7B', marginTop: '4px' }}>N¬∞ {destination === 'hollande' ? 'Hollande' : 'USA'} BL-XXXX-XXX</div>
                        <div style={{ fontSize: '9pt', color: '#666', marginTop: '2px' }}>RMA: {rma.request_number}</div>
                      </div>
                    </div>

                    {/* Date */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', margin: '12px 0' }}>
                      <div><span style={{ color: '#666' }}>{biz.city || 'Cr√©teil'}, le</span> <strong>{getFrenchDateShort()}</strong></div>
                    </div>

                    {/* Two column: EXP√âDITEUR (FROM) + DESTINATAIRE (TO) */}
                    <div style={{ display: 'flex', gap: '15px', margin: '12px 0' }}>
                      {/* FROM */}
                      <div style={{ flex: '1', background: 'rgba(248,249,250,0.85)', border: '1px solid #ddd', padding: '15px' }}>
                        <div style={{ fontSize: '9pt', color: '#666', textTransform: 'uppercase', fontWeight: '600', marginBottom: '5px' }}>{lang === 'en' ? 'Sender / From' : 'Exp√©diteur / From'}</div>
                        <div style={{ fontSize: '12pt', fontWeight: 'bold', marginBottom: '5px' }}>{biz.company_name || 'Lighthouse France SAS'}</div>
                        <div>{biz.address || '16 rue Paul S√©journ√©'}</div>
                        <div>{biz.postal_code || '94000'} {biz.city || 'Cr√©teil'}</div>
                        <div>France</div>
                        <div style={{ marginTop: '4px', fontSize: '9pt', color: '#666' }}>{lang === 'en' ? 'Tel:' : 'T√©l:'} {biz.phone || '01 43 77 28 07'}</div>
                      </div>
                      {/* TO */}
                      <div style={{ flex: '1', background: 'rgba(248,249,250,0.85)', border: '1px solid #ddd', padding: '15px' }}>
                        <div style={{ fontSize: '9pt', color: '#666', textTransform: 'uppercase', fontWeight: '600', marginBottom: '5px' }}>{lang === 'en' ? 'Recipient / To' : 'Destinataire / To'}</div>
                        <div style={{ fontSize: '12pt', fontWeight: 'bold', marginBottom: '5px' }}>{destOffice.company_name}</div>
                        {destOffice.attention && <div>{lang === 'en' ? 'Attn: ' : 'Attn: '}<strong>{destOffice.attention}</strong></div>}
                        <div>{destOffice.address_line1}</div>
                        <div>{destOffice.postal_code} {destOffice.city}</div>
                        <div>{destOffice.country}</div>
                        {destOffice.phone && <div style={{ marginTop: '4px', fontSize: '9pt', color: '#666' }}>Tel: {destOffice.phone}</div>}
                      </div>
                    </div>

                    {/* Client reference row */}
                    <div style={{ margin: '8px 0', padding: '5px 0', borderTop: '1px solid #ccc', borderBottom: '1px solid #ccc', fontSize: '10pt', color: '#666' }}>
                      Client: <strong style={{ color: '#333' }}>{rma.companies?.name || '‚Äî'}</strong>
                    </div>

                    {/* Devices table with per-device notes */}
                    <table style={{ width: '100%', borderCollapse: 'collapse', margin: '12px 0' }}>
                      <thead>
                        <tr style={{ background: 'rgba(51,51,51,0.35)' }}>
                          <th style={{ color: '#333', padding: '8px 10px', textAlign: 'left', fontSize: '9pt', width: '35px', fontWeight: 'bold', borderBottom: '2px solid #333' }}>Qty</th>
                          <th style={{ color: '#333', padding: '8px 10px', textAlign: 'left', fontSize: '9pt', fontWeight: 'bold', borderBottom: '2px solid #333' }}>{t('description')}</th>
                          <th style={{ color: '#333', padding: '8px 10px', textAlign: 'left', fontSize: '9pt', width: '110px', fontWeight: 'bold', borderBottom: '2px solid #333' }}>{lang === 'en' ? 'SN' : 'SN'}</th>
                          <th style={{ color: '#333', padding: '8px 10px', textAlign: 'center', fontSize: '9pt', width: '80px', fontWeight: 'bold', borderBottom: '2px solid #333' }}>Calibration</th>
                          <th style={{ color: '#333', padding: '8px 10px', textAlign: 'center', fontSize: '9pt', width: '70px', fontWeight: 'bold', borderBottom: '2px solid #333' }}>Repair</th>
                        </tr>
                      </thead>
                      <tbody>
                        {selectedDevices.map((d, i) => {
                          const svc = deviceServices[d.id] || 'calibration';
                          const dNote = deviceNotes[d.id] || '';
                          return (
                            <Fragment key={i}>
                              <tr>
                                <td style={{ padding: '8px 10px', borderBottom: dNote ? 'none' : '1px solid #ddd', fontSize: '10pt', textAlign: 'center', fontWeight: '600' }}>1</td>
                                <td style={{ padding: '8px 10px', borderBottom: dNote ? 'none' : '1px solid #ddd', fontSize: '10pt' }}>Lighthouse {d.model_name || d.model}</td>
                                <td style={{ padding: '8px 10px', borderBottom: dNote ? 'none' : '1px solid #ddd', fontSize: '10pt', fontFamily: 'monospace' }}>{d.serial_number}</td>
                                <td style={{ padding: '8px 10px', borderBottom: dNote ? 'none' : '1px solid #ddd', fontSize: '10pt', textAlign: 'center' }}>{svc === 'calibration' ? '‚úì' : ''}</td>
                                <td style={{ padding: '8px 10px', borderBottom: dNote ? 'none' : '1px solid #ddd', fontSize: '10pt', textAlign: 'center' }}>{svc === 'repair' ? '‚úì' : ''}</td>
                              </tr>
                              {dNote && (
                                <tr>
                                  <td colSpan="5" style={{ padding: '2px 10px 8px 40px', borderBottom: '1px solid #ddd', fontSize: '9pt', color: '#555', fontStyle: 'italic' }}>
                                    ‚Ü≥ {dNote}
                                  </td>
                                </tr>
                              )}
                            </Fragment>
                          );
                        })}
                      </tbody>
                    </table>

                    {/* Shipping info */}
                    <div style={{ margin: '12px 0' }}>
                      <div style={{ fontWeight: 'bold', fontSize: '11pt', marginBottom: '8px', borderBottom: '1px solid #333', paddingBottom: '5px' }}>Shipping Information</div>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px', fontSize: '10pt' }}>
                        <div><span style={{ color: '#666' }}>Carrier:</span> <strong>UPS</strong></div>
                        <div><span style={{ color: '#666' }}>Tracking #:</span> <strong style={{ fontFamily: 'monospace' }}>{trackingNumber || '‚Äî'}</strong></div>
                        <div><span style={{ color: '#666' }}>Parcels:</span> <strong>{parcels}</strong></div>
                        <div><span style={{ color: '#666' }}>Weight:</span> <strong>{weight} kg</strong></div>
                      </div>
                    </div>

                    {/* General notes */}
                    {notes && (
                      <div style={{ margin: '12px 0', padding: '10px 15px', background: '#F9FAFB', border: '1px solid #E5E7EB', borderRadius: '6px' }}>
                        <div style={{ fontWeight: 'bold', fontSize: '10pt', marginBottom: '4px' }}>{lang === 'en' ? 'Notes / Instructions:' : 'Notes / Instructions:'}</div>
                        <div style={{ fontSize: '10pt', color: '#4B5563', whiteSpace: 'pre-wrap' }}>{notes}</div>
                      </div>
                    )}

                    {/* Prepared by */}
                    <div style={{ fontSize: '10pt', marginTop: '12px', color: '#666' }}>
                      Prepared by: <strong style={{ color: '#333' }}>{employeeName}</strong>
                    </div>
                  </div>

                  {/* Footer */}
                  <div style={{ position: 'absolute', bottom: '15px', left: '30px', right: '30px', paddingTop: '12px', borderTop: '1px solid #ccc' }}>
                    <div style={{ position: 'relative' }}>
                      <div style={{ position: 'absolute', left: '10px', top: '0' }}>
                        <img src="/images/logos/capcert-logo.png" alt="CAPCERT" style={{ height: '75px' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:14px;color:#333;border:2px solid #333;padding:12px 16px;border-radius:6px;text-align:center"><strong>CAPCERT</strong><br/>ISO 9001</div>'; }} />
                      </div>
                      <div style={{ fontSize: '8pt', color: '#555', textAlign: 'center', lineHeight: '1.8' }}>
                        <strong style={{ color: '#333', fontSize: '8pt' }}>{biz.company_name || 'Lighthouse France SAS'}</strong> au capital de {biz.capital || '10 000'} ‚Ç¨<br/>
                        {biz.address || '16 rue Paul S√©journ√©'}, {biz.postal_code || '94000'} {biz.city || 'CR√âTEIL'} | T√©l. {biz.phone || '01 43 77 28 07'}<br/>
                        SIRET {biz.siret || '50178134800013'} | TVA {biz.tva || 'FR 86501781348'}<br/>
                        {biz.email || 'France@golighthouse.com'} | {biz.website || 'www.golighthouse.fr'}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ===== STEP 3: Saved ===== */}
          {step === 3 && generatedBL && (
            <div className="text-center py-8">
              <div className="text-6xl mb-4">‚úÖ</div>
              <h3 className="text-2xl font-bold text-green-700 mb-2">Internal Shipment Saved!</h3>
              <p className="text-gray-600 mb-2">BL and UPS label saved as internal documents (not visible to customer).</p>
              <p className="text-gray-400 text-sm mb-6">Destination: {generatedBL.destLabel}</p>
              <div className="bg-gray-50 rounded-xl p-6 max-w-md mx-auto space-y-3">
                <div className="flex items-center justify-between p-3 bg-white rounded-lg border">
                  <span className="font-mono font-medium text-sm">üìÑ {generatedBL.destLabel} {generatedBL.blNumber}</span>
                  {generatedBL.blUrl && (
                    <a href={generatedBL.blUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-sm">View BL</a>
                  )}
                </div>
                {generatedBL.trackingNumber && (
                  <div className="flex items-center justify-between p-3 bg-white rounded-lg border">
                    <span className="font-mono font-medium text-sm">üè∑Ô∏è UPS {generatedBL.destLabel} {generatedBL.trackingNumber}</span>
                    <div className="flex items-center gap-2">
                      {generatedBL.upsLabelUrl && (
                        <a href={generatedBL.upsLabelUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-sm">View Label</a>
                      )}
                      <a href={`https://www.ups.com/track?tracknum=${generatedBL.trackingNumber}`} target="_blank" rel="noopener noreferrer" className="text-amber-600 hover:underline text-sm">Track</a>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Footer buttons */}
        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between rounded-b-2xl">
          {step === 1 && (
            <>
              <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">Cancel</button>
              <button 
                onClick={createUPSLabel} 
                disabled={selectedDeviceIds.size === 0 || upsLoading}
                className="px-6 py-2 bg-[#351C15] hover:bg-[#4a2a20] text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
              >
                {upsLoading ? (
                  <><span className="animate-spin">‚è≥</span> Creating UPS Label...</>
                ) : (
                  <>üè∑Ô∏è Create UPS Label & Continue ‚Üí</>
                )}
              </button>
            </>
          )}
          {step === 2 && (
            <>
              <button onClick={() => setStep(1)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">‚Üê Back</button>
              <button 
                onClick={handleSave} 
                disabled={saving}
                className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50"
              >
                {saving ? '‚è≥ Saving...' : 'üíæ Save Internal Shipment'}
              </button>
            </>
          )}
          {step === 3 && (
            <div className="ml-auto">
              <button onClick={onClose} className="px-6 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-medium">Close</button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}


// ============================================
// SHIPPING MODAL - Full shipping workflow v26
// ============================================
function ShippingModal({ rma, devices, onClose, notify, reload, profile, businessSettings, lang = 'fr' }) {
  const t = k => k;
  const [step, setStep] = useState(1);
  const [saving, setSaving] = useState(false);
  const [shipments, setShipments] = useState([]);
  const [generatedBLs, setGeneratedBLs] = useState([]);
  const [labelsPrinted, setLabelsPrinted] = useState({});
  const [blsPrinted, setBlsPrinted] = useState({});
  const [loading, setLoading] = useState(true);
  
  // Device selection for partial shipments
  const [selectedDeviceIds, setSelectedDeviceIds] = useState(new Set());
  
  // Resolved address per device for display
  const [deviceAddressMap, setDeviceAddressMap] = useState({}); // { deviceId: { address, isDifferent } }
  
  // Categorize devices by status
  const readyDevices = devices.filter(d => 
    ['ready_to_ship', 'ready', 'pr√™t', 'calibrated', 'repaired', 'qc_passed'].includes(d.status?.toLowerCase()) || d.qc_complete
  );
  const notReadyDevices = devices.filter(d => 
    !['ready_to_ship', 'ready', 'pr√™t', 'calibrated', 'repaired', 'qc_passed', 'shipped'].includes(d.status?.toLowerCase()) && !d.qc_complete
  );
  const alreadyShippedDevices = devices.filter(d => d.status === 'shipped');
  
  // Toggle device selection
  const toggleDevice = (deviceId) => {
    setSelectedDeviceIds(prev => {
      const newSet = new Set(prev);
      if (newSet.has(deviceId)) {
        newSet.delete(deviceId);
      } else {
        newSet.add(deviceId);
      }
      return newSet;
    });
  };
  
  // Select/deselect all ready devices
  const toggleAllReady = () => {
    if (selectedDeviceIds.size === readyDevices.length) {
      setSelectedDeviceIds(new Set());
    } else {
      setSelectedDeviceIds(new Set(readyDevices.map(d => d.id)));
    }
  };
  
  // Fetch shipping address on mount and initialize shipments - AUTO-GROUP by address
  useEffect(() => {
    const initShipments = async () => {
      try {
      const company = rma.companies || {};
      
      // 1. Build default RMA-level address
      let rmaAddress = {
        company_name: company.name || 'Client',
        attention: '',
        address_line1: company.billing_address || '',
        city: company.billing_city || '',
        postal_code: company.billing_postal_code || '',
        country: 'France',
        phone: ''
      };
      
      if (rma.shipping_address_id) {
        try {
          const { data: shippingAddr } = await supabase
            .from('shipping_addresses')
            .select('*')
            .eq('id', rma.shipping_address_id)
            .single();
          if (shippingAddr) {
            rmaAddress = {
              company_name: shippingAddr.company_name || shippingAddr.label || company.name,
              attention: shippingAddr.attention || '',
              address_line1: shippingAddr.address_line1 || '',
              city: shippingAddr.city || '',
              postal_code: shippingAddr.postal_code || '',
              country: shippingAddr.country || 'France',
              phone: shippingAddr.phone || '',
              _addressId: rma.shipping_address_id
            };
          }
        } catch (e) {}
      }
      
      // 2. Collect unique device-level shipping_address_ids
      const deviceAddrIds = [...new Set(
        devices.filter(d => d.shipping_address_id && d.shipping_address_id !== rma.shipping_address_id)
          .map(d => d.shipping_address_id)
      )];
      
      // 3. Batch fetch device-specific addresses
      let deviceAddrMap = {};
      if (deviceAddrIds.length > 0) {
        try {
          const { data } = await supabase.from('shipping_addresses').select('*').in('id', deviceAddrIds);
          if (data) data.forEach(a => { deviceAddrMap[a.id] = a; });
        } catch (e) {}
      }
      
      // 4. Group devices by their resolved address key
      // Key = shipping_address_id or 'rma_default'
      const groups = {};
      devices.forEach(d => {
        const addrKey = (d.shipping_address_id && d.shipping_address_id !== rma.shipping_address_id && deviceAddrMap[d.shipping_address_id]) 
          ? d.shipping_address_id 
          : 'rma_default';
        if (!groups[addrKey]) groups[addrKey] = [];
        groups[addrKey].push(d);
      });
      
      // 5. Build shipments array - one per unique address
      const shipmentsArr = [];
      
      // RMA default group first (if any)
      if (groups['rma_default']) {
        shipmentsArr.push({
          address: { ...rmaAddress },
          addressId: rma.shipping_address_id || null,
          devices: groups['rma_default'],
          parcels: 1,
          weight: '2.0',
          trackingNumber: '',
          notes: ''
        });
      }
      
      // Then device-specific address groups
      Object.keys(groups).filter(k => k !== 'rma_default').forEach(addrId => {
        const addr = deviceAddrMap[addrId];
        if (addr) {
          shipmentsArr.push({
            address: {
              company_name: addr.company_name || addr.label || company.name,
              attention: addr.attention || '',
              address_line1: addr.address_line1 || '',
              city: addr.city || '',
              postal_code: addr.postal_code || '',
              country: addr.country || 'France',
              phone: addr.phone || '',
              _addressId: addrId
            },
            addressId: addrId,
            devices: groups[addrId],
            parcels: 1,
            weight: '2.0',
            trackingNumber: '',
            notes: ''
          });
        }
      });
      
      // If no devices at all (shouldn't happen), create one empty shipment
      if (shipmentsArr.length === 0) {
        shipmentsArr.push({
          address: { ...rmaAddress },
          addressId: rma.shipping_address_id || null,
          devices: devices,
          parcels: 1,
          weight: '2.0',
          trackingNumber: '',
          notes: ''
        });
      }
      
      setShipments(shipmentsArr);
      
      // Build device address map for display in selection UI
      const addrMap = {};
      devices.forEach(d => {
        const hasDifferent = d.shipping_address_id && d.shipping_address_id !== rma.shipping_address_id && deviceAddrMap[d.shipping_address_id];
        const resolved = hasDifferent ? deviceAddrMap[d.shipping_address_id] : (rmaAddress || {
          company_name: company.name || '‚Äî',
          address_line1: company.billing_address || '',
          city: company.billing_city || '',
          postal_code: company.billing_postal_code || '',
          country: company.country || 'France'
        });
        addrMap[d.id] = { address: resolved, isDifferent: !!hasDifferent };
      });
      setDeviceAddressMap(addrMap);
      
      // Auto-select all ready devices (or all if none have specific ready status)
      const ready = devices.filter(d => 
        ['ready_to_ship', 'ready', 'pr√™t', 'calibrated', 'repaired', 'qc_passed'].includes(d.status?.toLowerCase()) || d.qc_complete
      );
      if (ready.length > 0) {
        setSelectedDeviceIds(new Set(ready.map(d => d.id)));
      } else {
        setSelectedDeviceIds(new Set(devices.filter(d => d.status !== 'shipped').map(d => d.id)));
      }
      
      setLoading(false);
      } catch (err) {
        console.error('initShipments error:', err);
        // Fallback: create single shipment with company billing address
        const co = rma.companies || {};
        setShipments([{
          address: {
            company_name: co.name || 'Client',
            attention: '',
            address_line1: co.billing_address || '',
            city: co.billing_city || '',
            postal_code: co.billing_postal_code || '',
            country: 'France',
            phone: ''
          },
          addressId: null,
          devices: devices,
          parcels: 1,
          weight: '2.0',
          trackingNumber: '',
          notes: ''
        }]);
        setSelectedDeviceIds(new Set(devices.filter(d => d.status !== 'shipped').map(d => d.id)));
        setLoading(false);
      }
    };
    
    if (devices.length > 0) {
      initShipments();
    } else {
      setLoading(false);
    }
  }, []);
  
  const updateAddress = (index, field, value) => {
    setShipments(prev => {
      const updated = [...prev];
      updated[index] = { ...updated[index], address: { ...updated[index].address, [field]: value }};
      return updated;
    });
  };
  
  const updateShipment = (index, field, value) => {
    setShipments(prev => {
      const updated = [...prev];
      updated[index] = { ...updated[index], [field]: value };
      return updated;
    });
  };
  
  const generateBLNumber = (index) => {
    const now = new Date();
    const mmyy = `${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getFullYear()).slice(-2)}`;
    return `BL-${mmyy}-XXX`; // Placeholder - actual number generated on save
  };
  
  // State for UPS API
  const [upsLoading, setUpsLoading] = useState(false);
  const [upsLabels, setUpsLabels] = useState({}); // Store PDF labels by "shipmentIndex-packageIndex"
  
  // Non-metro shipping mode
  const [shippingMode, setShippingMode] = useState('ups'); // 'ups' or 'bl_only'
  const [upsOverrideText, setUpsOverrideText] = useState('');
  const upsOverrideConfirmed = upsOverrideText.toUpperCase() === 'OVERRIDE';
  
  // Detect if any shipment is non-metro
  const hasNonMetroShipment = shipments.some(s => {
    const pc = s.address?.postal_code || '';
    const country = (s.address?.country || '').toLowerCase();
    // Non-metro if: not a valid French metro postal code, or country is not France
    if (country && country !== 'france' && country !== 'fr') return true;
    return pc && !isFranceMetropolitan(pc);
  });
  
  // Auto-set mode when shipments change
  useEffect(() => {
    if (hasNonMetroShipment) {
      setShippingMode('bl_only');
    }
  }, [hasNonMetroShipment]);
  
  // BL-only flow: skip UPS, go straight to BL preview
  const proceedBLOnly = () => {
    // Filter shipments to only include selected devices
    const selectedDevices = devices.filter(d => selectedDeviceIds.has(d.id));
    if (selectedDevices.length === 0) {
      notify(lang === 'en' ? '‚ö†Ô∏è Select at least one device' : '‚ö†Ô∏è S√©lectionnez au moins un appareil', 'error');
      return;
    }
    // Update shipments to only contain selected devices
    const updatedShipments = shipments.map(s => ({
      ...s,
      devices: s.devices.filter(d => selectedDeviceIds.has(d.id)),
      trackingNumber: shippingMode === 'bl_only' ? 'N/A - Client' : s.trackingNumber
    })).filter(s => s.devices.length > 0);
    setShipments(updatedShipments);
    setStep(3); // Skip UPS step, go to BL
  };
  
  // Create REAL UPS Labels via Edge Function
  const createUPSLabels = async () => {
    // First, validate that at least one device is selected
    if (selectedDeviceIds.size === 0) {
      notify(lang === 'en' ? 'Please select at least one device to ship' : 'Veuillez s√©lectionner au moins un appareil √† exp√©dier', 'error');
      return;
    }
    
    // Filter each shipment to only include selected devices from that group
    const updatedShipmentsWithDevices = shipments.map(s => ({
      ...s,
      devices: s.devices.filter(d => selectedDeviceIds.has(d.id))
    })).filter(s => s.devices.length > 0); // Remove empty shipments
    
    if (updatedShipmentsWithDevices.length === 0) {
      notify(lang === 'en' ? 'No devices selected in the shipping groups' : 'Aucun appareil s√©lectionn√© dans les groupes d\'exp√©dition', 'error');
      return;
    }
    
    setShipments(updatedShipmentsWithDevices);
    
    setUpsLoading(true);
    try {
      const updatedShipments = [...updatedShipmentsWithDevices];
      const newLabels = {};
      
      for (let i = 0; i < updatedShipments.length; i++) {
        const s = updatedShipments[i];
        const address = s.address || {};
        
        // Build packages array - one per parcel count
        const packagesList = [];
        for (let p = 0; p < (s.parcels || 1); p++) {
          packagesList.push({
            weight: parseFloat(s.weight) || 2,
            length: 30,
            width: 30,
            height: 30,
            description: `RMA ${rma.request_number} - Colis ${p + 1}/${s.parcels || 1}`
          });
        }
        
        // Call UPS Edge Function to create shipment with multiple packages
        const { data, error } = await supabase.functions.invoke('ups-shipping', {
          body: {
            action: 'create_shipment',
            shipTo: {
              name: address.attention || address.company_name || 'Customer',
              company: address.company_name || 'Customer',
              attentionName: address.attention || address.company_name || 'Customer',
              phone: address.phone || '0100000000',
              addressLine1: address.address_line1 || '',
              city: address.city || '',
              postalCode: address.postal_code || '',
              countryCode: address.country === 'France' ? 'FR' : (address.country_code || 'FR')
            },
            packages: packagesList,
            serviceCode: '11', // UPS Standard
            description: `RMA ${rma.request_number} - ${s.devices.length} appareil(s)`,
            isReturn: false
          }
        });
        
        if (error) throw error;
        if (!data.success) throw new Error(data.error || 'UPS API error');
        
        // Update shipment with real tracking number
        updatedShipments[i] = {
          ...s,
          trackingNumber: data.trackingNumber,
          upsResponse: data,
          packageLabels: data.packages || [] // Store all package labels
        };
        
        // Store label PDF data for each package
        if (data.packages) {
          data.packages.forEach((pkg, pkgIndex) => {
            if (pkg.labelData) {
              newLabels[`${i}-${pkgIndex}`] = pkg.labelData;
            }
          });
          // Also store first label as main label for backward compatibility
          if (data.packages[0]?.labelData) {
            newLabels[i] = data.packages[0].labelData;
          }
        }
        
        notify(lang === 'en' ? `‚úÖ ${data.packages?.length || 1} UPS label(s) created: ${data.trackingNumber}` : `‚úÖ ${data.packages?.length || 1} √©tiquette(s) UPS cr√©√©e(s): ${data.trackingNumber}`);
      }
      
      setUpsLabels(prev => ({ ...prev, ...newLabels }));
      setShipments(updatedShipments);
      setStep(2);
    } catch (err) {
      console.error('UPS Label creation error:', err);
      notify(lang === 'en' ? '‚ùå UPS Error: ' : '‚ùå Erreur UPS: ' + (err.message || 'Erreur inconnue'), 'error');
    }
    setUpsLoading(false);
  };
  
  // French month names for written date
  const frenchMonths = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
  const getFrenchDate = () => {
    const d = new Date();
    return `${d.getDate()} ${frenchMonths[d.getMonth()]} ${d.getFullYear()}`;
  };
  
  // Collect all BC numbers for this RMA
  const getAllBcNumbers = () => {
    const bcList = [];
    if (rma.bc_number) bcList.push(rma.bc_number);
    if (rma.supplement_bc_number && rma.supplement_bc_number !== rma.bc_number) bcList.push(rma.supplement_bc_number);
    return bcList;
  };
  
  const generateBLContent = (shipment, index) => ({
    blNumber: generateBLNumber(index),
    bcNumbers: getAllBcNumbers(),
    bcNumber: rma.bc_number || null, // Keep for backwards compatibility
    date: getFrenchDate(),
    rmaNumber: rma.request_number,
    client: { name: shipment.address.company_name, attention: shipment.address.attention, street: shipment.address.address_line1, city: `${shipment.address.postal_code} ${shipment.address.city}`, country: shipment.address.country || 'France' },
    devices: shipment.devices.map(d => ({ model: d.model_name, serial: d.serial_number, service: d.service_type === 'repair' ? (lang === 'en' ? 'Repair' : 'R√©paration') : (lang === 'en' ? 'Calibration' : '√âtalonnage') })),
    shipping: { carrier: shippingMode === 'bl_only' ? 'Client' : 'UPS', tracking: shipment.trackingNumber || (shippingMode === 'bl_only' ? 'N/A - Enl√®vement client' : 'N/A'), parcels: shipment.parcels, weight: shipment.weight }
  });
  
  const printLabel = (index) => {
    const s = shipments[index];
    const labelData = upsLabels[index];
    
    if (labelData) {
      // Download real UPS PDF label
      try {
        const byteCharacters = atob(labelData);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // Open in new tab for printing
        const w = window.open(url, '_blank');
        if (!w) {
          // Fallback: download the file
          const a = document.createElement('a');
          a.href = url;
          a.download = `UPS-Label-${s.trackingNumber}.pdf`;
          a.click();
        }
        
        setLabelsPrinted(prev => ({ ...prev, [index]: true }));
        notify(lang === 'en' ? 'üìÑ UPS label opened' : 'üìÑ √âtiquette UPS ouverte');
      } catch (err) {
        console.error('Error opening label:', err);
        notify(lang === 'en' ? 'Error opening label' : 'Erreur ouverture √©tiquette', 'error');
      }
    } else {
      // Fallback to generated label if no real PDF
      const w = window.open('', '_blank');
      if (!w) { notify(lang === 'en' ? 'Popup blocked' : 'Popup bloqu√©', 'error'); return; }
      w.document.write(`<html><head><title>UPS Label</title><style>body{font-family:Arial;padding:20px}.label{border:3px solid #351C15;padding:20px;max-width:400px;margin:0 auto}.ups{font-size:32px;font-weight:bold;color:#351C15;text-align:center}.tracking{font-size:18px;font-family:monospace;text-align:center;margin:20px 0;padding:10px;background:#f5f5f5}.addr{margin:15px 0;padding:15px;border:1px solid #ddd}</style></head><body><div class="label"><div class="ups">UPS</div><div class="tracking">${s.trackingNumber}</div><div class="addr"><small>${lang === 'en' ? 'RECIPIENT:' : 'DESTINATAIRE:'}</small><br><strong>${s.address.company_name}</strong><br>${s.address.attention ? '√Ä l att. de: ' + s.address.attention + '<br>' : ''}${s.address.address_line1}<br>${s.address.postal_code} ${s.address.city}<br>${s.address.country}</div><div class="addr"><small>${lang === 'en' ? 'SENDER:' : 'EXP√âDITEUR:'}</small><br><strong>LIGHTHOUSE FRANCE</strong><br>16 rue Paul Sejourne<br>94000 Cr√©teil<br>France</div><p style="text-align:center;font-size:20px;font-weight:bold">${s.parcels} COLIS - ${s.weight} KG</p><p style="text-align:center;color:#666">${rma.request_number}</p></div><script>window.print()</script></body></html>`);
      w.document.close();
      setLabelsPrinted(prev => ({ ...prev, [index]: true }));
    }
  };
  
  const printBL = (index) => {
    const s = shipments[index], bl = generateBLContent(s, index);
    const employeeName = profile?.full_name || 'Lighthouse France';
    const biz = businessSettings || {};
    const w = window.open('', '_blank');
    if (!w) { notify(lang === 'en' ? 'Popup blocked' : 'Popup bloqu√©', 'error'); return; }
    w.document.write(`<!DOCTYPE html>
<html>
<head>
  <title>BL - ${bl.blNumber}</title>
  <style>
    @page { 
      margin: 15mm; 
      size: A4;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body { font-family: Arial, sans-serif; font-size: 11pt; color: #333; }
    .page { 
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 15px 25px;
      position: relative;
    }
    
    /* Watermark - on top of everything */
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.12;
      pointer-events: none;
      z-index: 999;
    }
    .watermark img { width: 500px; height: auto; }
    
    .content { flex: 1 0 auto; }
    .header { margin-bottom: 15px; padding-bottom: 12px; border-bottom: 2px solid #333; display: flex; justify-content: space-between; align-items: flex-start; }
    .header img { height: 50px; }
    .header-right { text-align: right; }
    .doc-title { font-size: 18pt; font-weight: bold; color: #2D5A7B; margin: 0; }
    .doc-number { font-size: 12pt; font-weight: bold; color: #2D5A7B; margin-top: 4px; }
    .doc-ref { font-size: 9pt; color: #666; margin-top: 2px; }
    .info-row { display: flex; justify-content: space-between; margin: 12px 0; }
    .client-box { background: rgba(248,249,250,0.85); border: 1px solid #ddd; padding: 15px; margin: 12px 0; }
    .client-label { font-size: 9pt; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
    .client-name { font-size: 12pt; font-weight: bold; margin-bottom: 5px; }
    table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    th { background: rgba(51,51,51,0.35); color: #333; padding: 10px 12px; text-align: left; font-size: 10pt; font-weight: bold; border-bottom: 2px solid #333; }
    td { padding: 10px 12px; border-bottom: 1px solid #ddd; font-size: 10pt; background: rgba(255,255,255,0.9); }
    tr:nth-child(even) td { background: rgba(249,249,249,0.9); }
    .shipping-section { margin: 15px 0; }
    .shipping-title { font-weight: bold; font-size: 11pt; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
    .shipping-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .shipping-item { display: flex; padding: 6px 0; }
    .shipping-label { color: #666; width: 130px; }
    .shipping-value { font-weight: 600; }
    .prepared-by { font-size: 10pt; margin-top: 12px; color: #666; }
    .prepared-by strong { color: #333; }
    
    .footer-section { 
      flex-shrink: 0;
      margin-top: auto;
      padding-top: 12px; 
      border-top: 1px solid #ccc;
    }
    .footer-content { position: relative; }
    .footer-logo { position: absolute; left: 10px; top: 0; }
    .footer-logo img { height: 75px; }
    .footer-info { font-size: 8pt; color: #555; text-align: center; line-height: 1.8; }
    .footer-info strong { color: #333; font-size: 8pt; }
    
    @media print { 
      @page { margin: 15mm; }
      .page { min-height: 100%; padding: 10px 20px; }
      .watermark { position: fixed; }
      /* Make backgrounds print */
      th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      td { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body onload="window.print()">
  <div class="page">
    <!-- Watermark - shows through everything -->
    <div class="watermark">
      <img src="/images/logos/Lighthouse-Square-logo.png" alt="" onerror="this.parentElement.innerHTML='<div style=\\'font-size:150px;font-weight:bold;color:#000;opacity:0.5\\'>LWS</div>'">
    </div>
    
    <div class="content">
      <div class="header">
        <img src="/images/logos/lighthouse-logo.png" alt="Lighthouse" onerror="this.outerHTML='<div style=\\'font-size:24px;font-weight:bold;color:#333\\'>LIGHTHOUSE<div style=\\'font-size:10px;color:#666\\'>FRANCE</div></div>'">
        <div class="header-right">
          <div class="doc-title">{lang === 'en' ? 'DELIVERY NOTE' : 'BON DE LIVRAISON'}</div>
          <div class="doc-number">N¬∞ ${bl.blNumber}</div>
          ${bl.bcNumbers && bl.bcNumbers.length > 0 ? `<div class="doc-ref">${bl.bcNumbers.length === 1 ? 'Commande: ' : 'Commandes: '}${bl.bcNumbers.join(', ')}</div>` : ''}
          <div class="doc-ref">RMA: ${bl.rmaNumber}</div>
        </div>
      </div>

      <div class="info-row">
        <div><span style="color:#666">${biz.city || 'Cr√©teil'}, le</span> <strong>${bl.date}</strong></div>
      </div>

      <div class="client-box">
        <div class="client-label">{lang === 'en' ? 'Recipient' : 'Destinataire'}</div>
        <div class="client-name">${bl.client.name}</div>
        ${bl.client.attention ? `<div>${lang === 'en' ? "Attention: " : "√Ä l'attention de: "}<strong>${bl.client.attention}</strong></div>` : ''}
        <div>${bl.client.street}</div>
        <div>${bl.client.city}</div>
        <div>${bl.client.country}</div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:50px">{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
            <th>{lang === 'en' ? 'Description' : 'D√©signation'}</th>
            <th style="width:120px">{t('serialNumber')}</th>
            <th style="width:100px">{lang === 'en' ? 'Service' : 'Service'}</th>
          </tr>
        </thead>
        <tbody>
          ${bl.devices.map(d => `
            <tr>
              <td style="text-align:center;font-weight:600">1</td>
              <td>Compteur de particules LIGHTHOUSE ${d.model}</td>
              <td style="font-family:monospace">${d.serial}</td>
              <td>${d.service}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <div class="shipping-section">
        <div class="shipping-title">{lang === 'en' ? 'Shipping Information' : "Informations d'exp√©dition"}</div>
        <div class="shipping-grid">
          <div class="shipping-item"><span class="shipping-label">{lang === 'en' ? 'Carrier:' : 'Transporteur:'}</span><span class="shipping-value">${bl.shipping.carrier}</span></div>
          ${bl.shipping.carrier !== 'Client' 
            ? `<div class="shipping-item"><span class="shipping-label">{lang === 'en' ? 'Tracking #:' : 'N¬∞ de suivi:'}</span><span class="shipping-value" style="font-family:monospace">${bl.shipping.tracking}</span></div>`
            : `<div class="shipping-item"><span class="shipping-label">Mode:</span><span class="shipping-value" style="color:#2563eb">{lang === 'en' ? 'Client pickup' : 'Enl√®vement client'}</span></div>`}
          <div class="shipping-item"><span class="shipping-label">{lang === 'en' ? 'Number of parcels:' : 'Nombre de colis:'}</span><span class="shipping-value">${bl.shipping.parcels}</span></div>
          <div class="shipping-item"><span class="shipping-label">{lang === 'en' ? 'Weight:' : 'Poids:'}</span><span class="shipping-value">${bl.shipping.weight} kg</span></div>
        </div>
      </div>

      <div class="prepared-by">
        Pr√©par√© par: <strong>${employeeName}</strong>
      </div>
    </div>

    <div class="footer-section">
      <div class="footer-content">
        <div class="footer-logo">
          <img src="/images/logos/capcert-logo.png" alt="CAPCERT" onerror="this.outerHTML='<div style=\\'font-size:18px;color:#333;border:2px solid #333;padding:18px 24px;border-radius:6px;text-align:center\\'><strong>CAPCERT</strong><br>ISO 9001</div>'">
        </div>
        <div class="footer-info">
          <strong>${biz.company_name || 'Lighthouse France SAS'}</strong> au capital de ${biz.capital || '10 000'} ‚Ç¨<br>
          ${biz.address || '16 rue Paul S√©journ√©'}, ${biz.postal_code || '94000'} ${biz.city || 'CR√âTEIL'} | T√©l. ${biz.phone || '01 43 77 28 07'}<br>
          SIRET ${biz.siret || '50178134800013'} | TVA ${biz.tva || 'FR 86501781348'}<br>
          ${biz.email || 'France@golighthouse.com'} | ${biz.website || 'www.golighthouse.fr'}
        </div>
      </div>
    </div>
  </div>

</body>
</html>`);
    w.document.close();
    setBlsPrinted(prev => ({ ...prev, [index]: true }));
  };
  
  // Save shipping documents (BL, UPS labels) but don't mark as shipped yet
  const saveShippingDocs = async () => {
    setSaving(true);
    try {
      const blData = [];
      const employeeName = profile?.full_name || 'Lighthouse France';
      
      for (let i = 0; i < shipments.length; i++) {
        const s = shipments[i];
        
        // Get BL number from database
        let blNumber = null;
        try {
          const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'BL' });
          if (!docNumError && docNumData) {
            blNumber = docNumData;
          }
        } catch (e) {
          console.error('Could not generate BL number:', e);
          // Fallback to old method
          const rmaNum = rma.request_number?.replace('FR-', '') || '00000';
          const date = new Date();
          const dateStr = `${String(date.getDate()).padStart(2, '0')}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getFullYear()).slice(-2)}`;
          blNumber = `BL-${rmaNum}-${dateStr}${shipments.length > 1 ? `-${i + 1}` : ''}`;
        }
        
        // Collect all BC numbers for this RMA
        const bcList = [];
        if (rma.bc_number) bcList.push(rma.bc_number);
        if (rma.supplement_bc_number && rma.supplement_bc_number !== rma.bc_number) bcList.push(rma.supplement_bc_number);
        
        // Generate BL content with database number
        const bl = {
          blNumber: blNumber,
          bcNumbers: bcList,
          bcNumber: rma.bc_number || null, // Keep for backwards compatibility
          date: getFrenchDate(),
          rmaNumber: rma.request_number,
          client: { 
            name: s.address.company_name, 
            attention: s.address.attention, 
            street: s.address.address_line1, 
            city: `${s.address.postal_code} ${s.address.city}`, 
            country: s.address.country || 'France' 
          },
          devices: s.devices.map(d => ({ 
            model: d.model_name, 
            serial: d.serial_number,
            calType: d.calibration_type || d.device_type
          })),
          shipping: { carrier: shippingMode === 'bl_only' ? 'Client' : 'UPS', tracking: s.trackingNumber || 'N/A', parcels: s.parcels, weight: s.weight }
        };
        
        blData.push(bl);
        
        // Generate BL PDF by capturing the visible preview element
        let blUrl = null;
        try {
          // Load html2canvas if needed
          if (!window.html2canvas) {
            await new Promise((resolve, reject) => {
              const script = document.createElement('script');
              script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
              script.onload = resolve;
              script.onerror = reject;
              document.head.appendChild(script);
            });
          }
          
          // Capture the visible BL preview element
          const element = document.getElementById(`bl-preview-${i}`);
          if (element) {
            // Update the BL number display element (find the specific N¬∞ element)
            const numberEl = element.querySelector('[data-bl-number]');
            if (numberEl) numberEl.textContent = 'N¬∞ ' + blNumber;
            
            const canvas = await window.html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
            const jsPDF = await loadJsPDF();
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            // Always stretch to full A4
            pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
            
            const blPdfBlob = pdf.output('blob');
            const safeBLNumber = (bl.blNumber || 'BL').replace(/[^a-zA-Z0-9-_]/g, '');
            const blFileName = `${rma.request_number}_BL_${safeBLNumber}_${Date.now()}.pdf`;
            blUrl = await uploadPDFToStorage(blPdfBlob, `shipping/${rma.request_number}`, blFileName);
          }
        } catch (pdfErr) {
          console.error('BL PDF generation error:', pdfErr);
        }
        
        // Generate UPS Label PDF - only in UPS mode
        let upsLabelUrl = null;
        if (shippingMode !== 'bl_only') {
          try {
            console.log('Saving UPS label for shipment:', i, s.trackingNumber);
            const realLabelData = upsLabels[i];
            
            if (realLabelData) {
              const byteCharacters = atob(realLabelData);
              const byteNumbers = new Array(byteCharacters.length);
              for (let j = 0; j < byteCharacters.length; j++) {
                byteNumbers[j] = byteCharacters.charCodeAt(j);
              }
              const byteArray = new Uint8Array(byteNumbers);
              const upsPdfBlob = new Blob([byteArray], { type: 'application/pdf' });
              const safeTracking = (s.trackingNumber || String(i)).replace(/[^a-zA-Z0-9-_]/g, '');
              const upsFileName = `${rma.request_number}_UPS_${safeTracking}_${Date.now()}.pdf`;
              upsLabelUrl = await uploadPDFToStorage(upsPdfBlob, `shipping/${rma.request_number}`, upsFileName);
            } else {
              const upsPdfBlob = await generateUPSLabelPDF(rma, s);
              const safeTracking = (s.trackingNumber || String(i)).replace(/[^a-zA-Z0-9-_]/g, '');
              const upsFileName = `${rma.request_number}_UPS_${safeTracking}_${Date.now()}.pdf`;
              upsLabelUrl = await uploadPDFToStorage(upsPdfBlob, `shipping/${rma.request_number}`, upsFileName);
            }
          } catch (pdfErr) {
            console.error('UPS Label PDF save error:', pdfErr);
          }
        }
        
        // Update devices with tracking info AND PDF URLs
        for (const d of s.devices) {
          await supabase.from('request_devices').update({ 
            tracking_number: shippingMode === 'bl_only' ? 'Client pickup' : (s.trackingNumber || null), 
            bl_number: bl.blNumber,
            bl_url: blUrl || null,
            ups_label_url: upsLabelUrl || null
          }).eq('id', d.id);
        }
      }
      
      setGeneratedBLs(blData);
      setStep(4); // Move to final step
      notify(lang === 'en' ? '‚úÖ Shipping documents saved! Ready for UPS scan.' : "‚úÖ Documents d'exp√©dition enregistr√©s! Pr√™t pour scan UPS.");
      reload();
    } catch (err) { 
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + (err.message || 'Error'), 'error'); 
    }
    setSaving(false);
  };
  
  // Mark as shipped - closes the RMA (will be triggered by barcode scan later)
  const markAsShipped = async () => {
    setSaving(true);
    try {
      // Update all devices to shipped
      for (const device of devices) {
        await supabase.from('request_devices').update({ 
          status: 'shipped', 
          shipped_at: new Date().toISOString()
        }).eq('id', device.id);
      }
      
      // Update RMA to shipped (closes it)
      await supabase.from('service_requests').update({ 
        status: 'shipped', 
        shipped_at: new Date().toISOString(), 
        updated_at: new Date().toISOString() 
      }).eq('id', rma.id);
      
      notify(lang === 'en' ? 'üöö RMA marked as shipped and closed!' : 'üöö RMA marqu√© comme exp√©di√© et ferm√©!');
      reload();
      onClose(); // Close modal, reload will update the view
    } catch (err) { 
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + (err.message || 'Error'), 'error'); 
    }
    setSaving(false);
  };
  
  const stepLabels = shippingMode === 'bl_only' 
    ? [(lang === 'en' ? 'Verification' : 'V√©rification'), (lang === 'en' ? 'Delivery Note' : 'Bon de Livraison'), (lang === 'en' ? 'Ship' : 'Exp√©dier')]
    : [(lang === 'en' ? 'Verification' : 'V√©rification'), (lang === 'en' ? 'UPS Label' : '√âtiquette UPS'), (lang === 'en' ? 'Delivery Note' : 'Bon de Livraison'), (lang === 'en' ? 'Ship' : 'Exp√©dier')];
  // Map internal steps to display for bl_only mode
  const displayStep = shippingMode === 'bl_only' ? (step === 1 ? 1 : step === 3 ? 2 : step === 4 ? 3 : step) : step;
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={onClose}>
      <div className="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="px-6 py-4 border-b bg-gradient-to-r from-green-600 to-emerald-600 text-white">
          <div className="flex justify-between items-center">
            <div>
              <h2 className="text-xl font-bold">üöö Exp√©dition - {rma.request_number}</h2>
              <p className="text-green-100 text-sm">{devices.length} appareil(s)</p>
            </div>
            <button onClick={onClose} className="text-white/70 hover:text-white text-2xl">&times;</button>
          </div>
          <div className="flex items-center gap-1 mt-4">
            {stepLabels.map((label, idx) => (
              <div key={idx} className="flex items-center flex-1">
                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${displayStep > idx + 1 ? 'bg-white text-green-600' : displayStep === idx + 1 ? 'bg-white text-green-600' : 'bg-green-500 text-green-200'}`}>
                  {displayStep > idx + 1 ? '‚úì' : idx + 1}
                </div>
                <span className={`ml-2 text-xs hidden sm:inline ${displayStep === idx + 1 ? 'text-white font-medium' : 'text-green-200'}`}>{label}</span>
                {idx < stepLabels.length - 1 && <div className="flex-1 h-0.5 bg-green-500 mx-2" />}
              </div>
            ))}
          </div>
        </div>
        
        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* Loading State */}
          {loading && (
            <div className="flex items-center justify-center py-12">
              <div className="text-center">
                <div className="text-4xl mb-4">‚è≥</div>
                <p className="text-gray-500">{lang === 'en' ? 'Loading information...' : 'Chargement des informations...'}</p>
              </div>
            </div>
          )}
          
          {/* Step 1: Review */}
          {!loading && step === 1 && (
            <div className="space-y-6">
              {/* Non-Metro Shipping Mode Banner */}
              {hasNonMetroShipment && (
                <div className={`border-2 rounded-xl p-4 ${shippingMode === 'bl_only' ? 'bg-blue-50 border-blue-300' : 'bg-amber-50 border-amber-300'}`}>
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">{shippingMode === 'bl_only' ? 'üåç' : 'üì¶'}</span>
                    <div className="flex-1">
                      <h4 className="font-bold text-gray-800">
                        {lang === 'en' ? 'Destination outside France Metropolitan' : 'Destination hors France m√©tropolitaine'}
                      </h4>
                      <p className="text-sm text-gray-600 mt-1">
                        {shippingMode === 'bl_only' 
                          ? (lang === 'en' 
                            ? 'BL-only mode: A delivery note will be generated without UPS shipping. The client manages their own transport.'
                            : 'Mode BL uniquement : Un bon de livraison sera cr√©√© sans exp√©dition UPS. Le client g√®re son propre transport.')
                          : (lang === 'en'
                            ? 'UPS override active ‚Äî shipping will be created via UPS.'
                            : 'D√©rogation UPS active ‚Äî l\'exp√©dition sera cr√©√©e via UPS.')}
                      </p>
                      
                      {shippingMode === 'bl_only' ? (
                        <div className="mt-3 p-3 bg-white rounded-lg border border-gray-200">
                          <p className="text-xs text-gray-500 mb-2">{lang === 'en' ? 'Need to ship via UPS anyway? Type OVERRIDE to unlock:' : 'Besoin d\'exp√©dier via UPS quand m√™me ? Tapez OVERRIDE pour d√©bloquer :'}</p>
                          <div className="flex items-center gap-2">
                            <input
                              type="text"
                              value={upsOverrideText}
                              onChange={e => setUpsOverrideText(e.target.value)}
                              placeholder="OVERRIDE"
                              className="px-3 py-1.5 border border-gray-300 rounded-lg text-sm font-mono w-36"
                            />
                            {upsOverrideConfirmed && (
                              <button 
                                onClick={() => { setShippingMode('ups'); setUpsOverrideText(''); }}
                                className="px-3 py-1.5 bg-amber-500 text-white rounded-lg text-sm font-medium hover:bg-amber-600"
                              >
                                üîì {lang === 'en' ? 'Switch to UPS' : 'Passer en UPS'}
                              </button>
                            )}
                          </div>
                        </div>
                      ) : (
                        <button 
                          onClick={() => setShippingMode('bl_only')}
                          className="mt-2 text-sm text-blue-600 hover:underline"
                        >
                          ‚Üê {lang === 'en' ? 'Switch back to BL-only mode' : 'Revenir en mode BL uniquement'}
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {/* Multi-address banner */}
              {shipments.length > 1 && (
                <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">üì¶</span>
                    <div>
                      <h4 className="font-bold text-amber-800">{lang === 'en' ? 'Multi-address Shipping' : 'Exp√©dition multi-adresses'}</h4>
                      <p className="text-sm text-amber-700">{lang === 'en' ? `Devices have different return addresses. ${shipments.length} separate shipments will be created, each with its own DN and UPS label.` : `Les appareils ont des adresses de retour diff√©rentes. ${shipments.length} envois s√©par√©s seront cr√©√©s, chacun avec son propre BL et √©tiquette UPS.`}</p>
                    </div>
                  </div>
                </div>
              )}
              
              {shipments.map((shipment, idx) => (
                <div key={idx} className="space-y-4">
                  {/* Shipment group header */}
                  {shipments.length > 1 && (
                    <div className="bg-gradient-to-r from-[#1a1a2e] to-[#2d2d44] text-white rounded-t-xl px-4 py-3 flex justify-between items-center">
                      <h3 className="font-bold">{lang === 'en' ? 'Shipment' : 'Envoi'} {idx + 1} / {shipments.length}</h3>
                      <span className="text-sm text-gray-300">{shipment.devices.length} {lang === 'en' ? 'device(s)' : 'appareil(s)'} ‚Üí {shipment.address.city || '?'}</span>
                    </div>
                  )}
                  
                  {/* Devices in this shipment group */}
                  {shipments.length > 1 && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                      <p className="text-xs text-blue-600 font-medium uppercase mb-2">{lang === 'en' ? 'Devices in this shipment:' : 'Appareils dans cet envoi:'}</p>
                      <div className="flex flex-wrap gap-2">
                        {shipment.devices.map(d => (
                          <span key={d.id} className="px-2 py-1 bg-white border rounded text-xs font-mono">{d.model_name} - {d.serial_number}</span>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* Address Section */}
                  <div className="bg-white border-2 border-gray-200 rounded-xl">
                    <div className="bg-amber-50 px-4 py-3 border-b">
                      <h3 className="font-bold text-amber-800">{lang === 'en' ? `üìç Shipping address${shipments.length > 1 ? ` (Shipment ${idx + 1})` : ''}` : `üìç Adresse de livraison${shipments.length > 1 ? ` (Envoi ${idx + 1})` : ''}`}</h3>
                    </div>
                    <div className="p-4 grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Company *' : 'Soci√©t√© *'}</label>
                        <input type="text" value={shipment.address.company_name} onChange={e => updateAddress(idx, 'company_name', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? "Attention" : "√Ä l'attention de"}</label>
                        <input type="text" value={shipment.address.attention} onChange={e => updateAddress(idx, 'attention', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder={lang === 'en' ? 'Contact name' : 'Nom du contact'} />
                      </div>
                      <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Address *' : 'Adresse *'}</label>
                        <input type="text" value={shipment.address.address_line1} onChange={e => updateAddress(idx, 'address_line1', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Postal code *' : 'Code postal *'}</label>
                        <input type="text" value={shipment.address.postal_code} onChange={e => updateAddress(idx, 'postal_code', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'City *' : 'Ville *'}</label>
                        <input type="text" value={shipment.address.city} onChange={e => updateAddress(idx, 'city', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{t('country')}</label>
                        <input type="text" value={shipment.address.country} onChange={e => updateAddress(idx, 'country', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{t('phone')}</label>
                        <input type="text" value={shipment.address.phone || ''} onChange={e => updateAddress(idx, 'phone', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="+33..." />
                      </div>
                    </div>
                  </div>
                  
                  {/* Shipping Details per shipment */}
                  <div className="bg-white border-2 border-gray-200 rounded-xl">
                    <div className="bg-green-50 px-4 py-3 border-b flex justify-between items-center">
                      <h3 className="font-bold text-green-800">{lang === 'en' ? `üöö Shipping details${shipments.length > 1 ? ` (Shipment ${idx + 1})` : ''}` : `üöö D√©tails d'exp√©dition${shipments.length > 1 ? ` (Envoi ${idx + 1})` : ''}`}</h3>
                      <span className="text-xs text-green-600">{lang === 'en' ? 'üí° UPS creates 1 label per package' : 'üí° UPS cr√©e 1 √©tiquette par colis'}</span>
                    </div>
                    <div className="p-4 grid md:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Number of parcels' : 'Nombre de colis'}</label>
                        <div className="flex items-center gap-2">
                          <button 
                            onClick={() => updateShipment(idx, 'parcels', Math.max(1, (shipment.parcels || 1) - 1))}
                            className="w-10 h-10 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-lg"
                          >-</button>
                          <input 
                            type="number" 
                            min="1" 
                            value={shipment.parcels} 
                            onChange={e => updateShipment(idx, 'parcels', parseInt(e.target.value) || 1)} 
                            className="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center font-bold text-lg" 
                          />
                          <button 
                            onClick={() => updateShipment(idx, 'parcels', (shipment.parcels || 1) + 1)}
                            className="w-10 h-10 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold text-lg"
                          >+</button>
                        </div>
                        {shipment.parcels > 1 && (
                          <p className="text-xs text-green-600 mt-1">üì¶ {lang === 'en' ? `${shipment.parcels} labels will be created` : `${shipment.parcels} √©tiquettes seront cr√©√©es`}</p>
                        )}
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Total weight (kg)' : 'Poids total (kg)'}</label>
                        <input type="text" value={shipment.weight} onChange={e => updateShipment(idx, 'weight', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'DN #' : 'BL #'}</label>
                        <input type="text" value={generateBLNumber(idx)} disabled className="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 font-mono" />
                      </div>
                      <div className="md:col-span-3">
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Internal notes' : 'Notes internes'}</label>
                        <textarea value={shipment.notes || ''} onChange={e => updateShipment(idx, 'notes', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" rows={2} placeholder={lang === 'en' ? 'Shipping notes...' : "Notes pour l'exp√©dition..."} />
                      </div>
                    </div>
                  </div>
                </div>
              ))}
              
              {/* Already Shipped Info - shown once */}
              {alreadyShippedDevices.length > 0 && (
                <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">‚úàÔ∏è</span>
                    <div>
                      <h4 className="font-bold text-blue-800">{lang === 'en' ? 'Devices already shipped' : 'Appareils d√©j√† exp√©di√©s'}</h4>
                      <div className="text-sm text-blue-700 mt-1">
                        {alreadyShippedDevices.map(d => (
                          <div key={d.id} className="flex items-center gap-2">
                            <span>‚Ä¢ {d.model_name} - {d.serial_number}</span>
                            {d.tracking_number && <span className="text-blue-500 font-mono text-xs">{d.tracking_number}</span>}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Not Ready Warning - shown once */}
              {notReadyDevices.length > 0 && (
                <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">‚ö†Ô∏è</span>
                    <div>
                      <h4 className="font-bold text-amber-800">{lang === 'en' ? 'Devices not ready' : 'Appareils non pr√™ts'}</h4>
                      <p className="text-sm text-amber-700 mb-2">{lang === 'en' ? 'These devices are not marked "ready":' : 'Ces appareils ne sont pas marqu√©s "pr√™t" :'}</p>
                      <div className="text-sm text-amber-700">
                        {notReadyDevices.map(d => (
                          <div key={d.id} className="flex items-center gap-2">
                            <span>‚Ä¢ {d.model_name} - {d.serial_number}</span>
                            <span className="px-2 py-0.5 bg-amber-200 rounded text-xs">{d.status || 'En cours'}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Devices Selection Section - shown once, global */}
              <div className="bg-white border-2 border-gray-200 rounded-xl">
                <div className="bg-blue-50 px-4 py-3 border-b flex justify-between items-center">
                  <h3 className="font-bold text-blue-800">{lang === 'en' ? 'üì¶ Select devices to ship' : 'üì¶ S√©lectionner les appareils √† exp√©dier'}</h3>
                  <div className="flex items-center gap-3">
                    <span className="text-sm text-blue-600">{selectedDeviceIds.size} / {devices.filter(d => d.status !== 'shipped').length} {lang === 'en' ? 'selected' : 's√©lectionn√©(s)'}</span>
                    {devices.filter(d => d.status !== 'shipped').length > 1 && (
                      <button 
                        onClick={toggleAllReady}
                        className="text-xs px-2 py-1 bg-blue-100 hover:bg-blue-200 rounded text-blue-700"
                      >
                        {selectedDeviceIds.size === readyDevices.length && readyDevices.length > 0 ? (lang === 'en' ? 'Deselect' : 'D√©s√©lectionner') : (lang === 'en' ? 'Select all' : 'Tout s√©lectionner')}
                      </button>
                    )}
                  </div>
                </div>
                <div className="p-4">
                  {devices.filter(d => d.status !== 'shipped').length === 0 ? (
                    <p className="text-gray-500 text-center py-4">{lang === 'en' ? 'All devices have already been shipped' : 'Tous les appareils ont d√©j√† √©t√© exp√©di√©s'}</p>
                  ) : (
                    <div className="space-y-2">
                      {devices.filter(d => d.status !== 'shipped').map(device => {
                        const isReady = ['ready_to_ship', 'ready', 'pr√™t', 'calibrated', 'repaired', 'qc_passed'].includes(device.status?.toLowerCase()) || device.qc_complete;
                        const addrInfo = deviceAddressMap[device.id];
                        const addr = addrInfo?.address;
                        return (
                          <label 
                            key={device.id} 
                            className={`block p-3 rounded-lg border-2 cursor-pointer transition-all ${
                              selectedDeviceIds.has(device.id) 
                                ? 'border-green-500 bg-green-50' 
                                : 'border-gray-200 hover:border-gray-300'
                            }`}
                          >
                            <div className="flex items-center gap-3">
                              <input
                                type="checkbox"
                                checked={selectedDeviceIds.has(device.id)}
                                onChange={() => toggleDevice(device.id)}
                                className="w-5 h-5 text-green-600 rounded"
                              />
                              <div className="flex-1">
                                <div className="font-medium flex items-center gap-2">{getDeviceImageUrl(device.model_name) && <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-4 h-4 object-contain" />}{device.model_name}</div>
                                <div className="text-sm text-gray-500 font-mono">{device.serial_number}</div>
                              </div>
                              <span className={`px-2 py-1 rounded text-xs font-medium ${device.service_type === 'repair' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                                {device.service_type === 'repair' ? (lang === 'en' ? 'üîß Repair' : 'üîß R√©paration') : 'üî¨ √âtalonnage'}
                              </span>
                              {device.calibration_certificate_url && (
                                <a href={device.calibration_certificate_url} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-sm" onClick={e => e.stopPropagation()}>üìÑ</a>
                              )}
                              <span className={`px-2 py-1 rounded text-xs font-medium ${isReady ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
                                {isReady ? (lang === 'en' ? '‚úì Ready' : '‚úì Pr√™t') : device.status || (lang === 'en' ? 'In progress' : 'En cours')}
                              </span>
                            </div>
                            {/* Return address for this device */}
                            {addr && (
                              <div className="mt-2 ml-8 flex items-center gap-2">
                                <span className="text-xs text-gray-400">{lang === 'en' ? 'üìç Return:' : 'üìç Retour:'}</span>
                                <span className="text-xs text-gray-600">{addr.company_name || addr.label || '‚Äî'}, {addr.address_line1 || ''}, {addr.postal_code || ''} {addr.city || ''}</span>
                                {addrInfo.isDifferent && (
                                  <span className="px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded text-[10px] font-medium">{lang === 'en' ? 'Specific address' : 'Adresse sp√©cifique'}</span>
                                )}
                              </div>
                            )}
                          </label>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
              
              {/* RMA Summary */}
              <div className="bg-gray-50 rounded-xl p-4">
                <h4 className="font-bold text-gray-700 mb-2">{lang === 'en' ? 'üìã RMA Summary' : 'üìã R√©capitulatif RMA'}</h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                  <div><span className="text-gray-500">{lang === 'en' ? 'RMA:' : 'RMA:'}</span> <span className="font-mono font-bold text-[#00A651]">{rma.request_number}</span></div>
                  <div><span className="text-gray-500">{lang === 'en' ? 'Client:' : 'Client:'}</span> <span className="font-medium">{rma.companies?.name}</span></div>
                  <div><span className="text-gray-500">{lang === 'en' ? 'Devices:' : 'Appareils:'}</span> <span className="font-medium">{devices.length}</span></div>
                  <div><span className="text-gray-500">{lang === 'en' ? 'Date:' : 'Date:'}</span> <span className="font-medium">{new Date().toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</span></div>
                </div>
              </div>
            </div>
          )}
          
          {/* Step 2: UPS Labels */}
          {step === 2 && shipments.map((shipment, idx) => (
            <div key={idx} className="bg-white border-2 rounded-xl p-6 mb-4">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h3 className="font-bold text-lg">{lang === 'en' ? 'Shipment' : 'Exp√©dition'} #{idx + 1}</h3>
                  <p className="text-gray-500">{shipment.address.postal_code} {shipment.address.city}</p>
                </div>
                <div className="text-right">
                  <p className="font-mono text-lg font-bold text-amber-600">{shipment.trackingNumber}</p>
                  <a href={`https://www.ups.com/track?tracknum=${shipment.trackingNumber}`} target="_blank" rel="noopener noreferrer" className="text-sm text-blue-500 hover:underline">{lang === 'en' ? 'Track ‚Üí' : 'Suivre ‚Üí'}</a>
                </div>
              </div>
              
              {/* Show all package labels */}
              <div className="space-y-4">
                {(shipment.packageLabels || [{ trackingNumber: shipment.trackingNumber }]).map((pkg, pkgIdx) => (
                  <div key={pkgIdx} className="bg-gray-50 rounded-lg p-4 border">
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="text-2xl font-bold text-[#351C15]">UPS</div>
                        <div className="font-mono text-sm">{pkg.trackingNumber || shipment.trackingNumber}</div>
                        <div className="text-sm text-gray-500 mt-1">
                          Colis {pkgIdx + 1} / {shipment.parcels || 1}
                        </div>
                      </div>
                      <div className="flex items-center gap-3">
                        <span className={labelsPrinted[`${idx}-${pkgIdx}`] ? 'text-green-600 font-medium text-sm' : 'text-gray-400 text-sm'}>
                          {labelsPrinted[`${idx}-${pkgIdx}`] ? (lang === 'en' ? '‚úì Printed' : '‚úì Imprim√©') : ''}
                        </span>
                        <button 
                          onClick={() => {
                            const labelData = upsLabels[`${idx}-${pkgIdx}`] || upsLabels[idx];
                            if (labelData) {
                              const byteCharacters = atob(labelData);
                              const byteNumbers = new Array(byteCharacters.length);
                              for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                              }
                              const byteArray = new Uint8Array(byteNumbers);
                              const blob = new Blob([byteArray], { type: 'application/pdf' });
                              const url = URL.createObjectURL(blob);
                              window.open(url, '_blank');
                              setLabelsPrinted(prev => ({ ...prev, [`${idx}-${pkgIdx}`]: true }));
                            } else {
                              printLabel(idx);
                            }
                          }} 
                          className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium text-sm"
                        >
                          üñ®Ô∏è Imprimer
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              
              {/* Summary */}
              <div className="mt-4 pt-4 border-t flex justify-between items-center text-sm text-gray-600">
                <span>{shipment.address.company_name} ‚Ä¢ {shipment.parcels || 1} {lang === 'en' ? 'parcels' : 'colis'} ‚Ä¢ {shipment.weight} kg</span>
                <span className="text-gray-400">{rma.request_number}</span>
              </div>
            </div>
          ))}
          
          {/* Step 3: BL Preview */}
          {step === 3 && shipments.map((shipment, idx) => {
            const bl = generateBLContent(shipment, idx);
            const employeeName = profile?.full_name || 'Lighthouse France';
            const biz = businessSettings || {};
            return (
              <div key={idx} className="mb-4">
                {/* Controls bar */}
                <div className="bg-gray-100 px-4 py-3 rounded-t-xl flex justify-between items-center">
                  <div>
                    <h3 className="font-bold">{bl.blNumber}</h3>
                    <p className="text-sm text-gray-500">{bl.devices.length} appareil(s)</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className={blsPrinted[idx] ? 'text-green-600 font-medium' : 'text-gray-400'}>{blsPrinted[idx] ? (lang === 'en' ? '‚úì Printed' : '‚úì Imprim√©') : ''}</span>
                    <button onClick={() => setStep(1)} className="px-3 py-1 bg-white hover:bg-gray-50 border rounded text-sm">{lang === 'en' ? '‚úèÔ∏è Edit' : '‚úèÔ∏è Modifier'}</button>
                    <button onClick={() => printBL(idx)} className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">{lang === 'en' ? 'üñ®Ô∏è Print DN' : 'üñ®Ô∏è Imprimer BL'}</button>
                  </div>
                </div>
                
                {/* Clean PDF Preview with Watermark */}
                <div className="bg-white border-2 border-t-0 rounded-b-xl overflow-hidden shadow-lg">
                  <div id={`bl-preview-${idx}`} style={{ fontFamily: 'Arial, sans-serif', fontSize: '11pt', color: '#333', padding: '25px 30px', maxWidth: '210mm', margin: '0 auto', background: 'white', height: '297mm', position: 'relative', overflow: 'hidden' }}>
                    {/* Watermark - on top of everything */}
                    <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', opacity: 0.12, pointerEvents: 'none', zIndex: 999 }}>
                      <img src="/images/logos/Lighthouse-Square-logo.png" alt="" style={{ width: '500px', height: 'auto' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:150px;font-weight:bold;color:#000">LWS</div>'; }} />
                    </div>
                    
                    {/* Content area */}
                    <div>
                      {/* Header */}
                      <div style={{ marginBottom: '15px', paddingBottom: '12px', borderBottom: '2px solid #333', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <img src="/images/logos/lighthouse-logo.png" alt="Lighthouse" style={{ height: '50px' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:24px;font-weight:bold;color:#333">LIGHTHOUSE<div style="font-size:10px;color:#666">FRANCE</div></div>'; }} />
                        <div style={{ textAlign: 'right' }}>
                          <div style={{ fontSize: '18pt', fontWeight: 'bold', color: '#2D5A7B' }}>{lang === 'en' ? 'DELIVERY NOTE' : 'BON DE LIVRAISON'}</div>
                          <div data-bl-number="true" style={{ fontSize: '12pt', fontWeight: 'bold', color: '#2D5A7B', marginTop: '4px' }}>N¬∞ {bl.blNumber}</div>
                          <div style={{ fontSize: '9pt', color: '#666', marginTop: '2px' }}>RMA: {bl.rmaNumber}</div>
                        </div>
                      </div>

                      {/* Info row */}
                      <div style={{ display: 'flex', justifyContent: 'space-between', margin: '12px 0' }}>
                        <div><span style={{ color: '#666' }}>{biz.city || 'Cr√©teil'}, le</span> <strong>{bl.date}</strong></div>
                      </div>

                      {/* Two column layout: Client + R√©f√©rences */}
                      <div style={{ display: 'flex', gap: '15px', margin: '12px 0' }}>
                        {/* Client box */}
                        <div style={{ flex: '1.5', background: 'rgba(248,249,250,0.85)', border: '1px solid #ddd', padding: '15px' }}>
                          <div style={{ fontSize: '9pt', color: '#666', textTransform: 'uppercase', fontWeight: '600', marginBottom: '5px' }}>{lang === 'en' ? 'Recipient' : 'Destinataire'}</div>
                          <div style={{ fontSize: '12pt', fontWeight: 'bold', marginBottom: '5px' }}>{bl.client.name}</div>
                          {bl.client.attention && <div>{lang === 'en' ? "Attention: " : "√Ä l'attention de: "}<strong>{bl.client.attention}</strong></div>}
                          <div>{bl.client.street}</div>
                          <div>{bl.client.city}</div>
                          <div>{bl.client.country}</div>
                        </div>
                        {/* R√©f√©rences box */}
                        <div style={{ flex: '1', background: 'rgba(248,249,250,0.85)', border: '1px solid #ddd', padding: '15px' }}>
                          <div style={{ fontSize: '9pt', color: '#666', textTransform: 'uppercase', fontWeight: '600', marginBottom: '5px' }}>{lang === 'en' ? 'Order References' : 'R√©f√©rences Commande'}</div>
                          {bl.bcNumbers && bl.bcNumbers.length > 0 ? (
                            bl.bcNumbers.map((bc, i) => (
                              <div key={i} style={{ fontSize: '11pt', fontWeight: 'bold', color: '#2D5A7B' }}>{bc}</div>
                            ))
                          ) : (
                            <div style={{ fontSize: '11pt', color: '#999' }}>‚Äî</div>
                          )}
                        </div>
                      </div>

                      {/* Table - semi-transparent header */}
                      <table style={{ width: '100%', borderCollapse: 'collapse', margin: '12px 0' }}>
                        <thead>
                          <tr style={{ background: 'rgba(51,51,51,0.35)' }}>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', width: '50px', fontWeight: 'bold' }}>{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', fontWeight: 'bold' }}>{lang === 'en' ? 'Description' : 'D√©signation'}</th>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', width: '120px', fontWeight: 'bold' }}>{t('serialNumber')}</th>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', width: '100px', fontWeight: 'bold' }}>{lang === 'en' ? 'Service' : 'Service'}</th>
                          </tr>
                        </thead>
                        <tbody>
                          {bl.devices.map((d, i) => (
                            <tr key={i}>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', textAlign: 'center', fontWeight: '600', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>1</td>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>Compteur de particules LIGHTHOUSE {d.model}</td>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', fontFamily: 'monospace', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>{d.serial}</td>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>{d.service}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>

                      {/* Shipping section */}
                      <div style={{ margin: '15px 0' }}>
                        <div style={{ fontWeight: 'bold', fontSize: '11pt', marginBottom: '10px', borderBottom: '1px solid #333', paddingBottom: '5px' }}>{lang === 'en' ? 'Shipping Information' : "Informations d'exp√©dition"}</div>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>{lang === 'en' ? 'Carrier:' : 'Transporteur:'}</span><span style={{ fontWeight: '600' }}>{bl.shipping.carrier}</span></div>
                          {bl.shipping.carrier !== 'Client' ? (
                            <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>{lang === 'en' ? 'Tracking #:' : 'N¬∞ de suivi:'}</span><span style={{ fontWeight: '600', fontFamily: 'monospace' }}>{bl.shipping.tracking}</span></div>
                          ) : (
                            <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>Mode:</span><span style={{ fontWeight: '600', color: '#2563eb' }}>{lang === 'en' ? 'Client pickup' : 'Enl√®vement client'}</span></div>
                          )}
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>{lang === 'en' ? 'Number of parcels:' : 'Nombre de colis:'}</span><span style={{ fontWeight: '600' }}>{bl.shipping.parcels}</span></div>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>{lang === 'en' ? 'Weight:' : 'Poids:'}</span><span style={{ fontWeight: '600' }}>{bl.shipping.weight} kg</span></div>
                        </div>
                      </div>

                      {/* Prepared by */}
                      <div style={{ fontSize: '10pt', marginTop: '12px', color: '#666' }}>
                        {lang === 'en' ? 'Prepared by:' : 'Pr√©par√© par:'} <strong style={{ color: '#333' }}>{employeeName}</strong>
                      </div>
                    </div>

                    {/* Footer - ABSOLUTE positioned at bottom */}
                    <div style={{ position: 'absolute', bottom: '15px', left: '30px', right: '30px', paddingTop: '12px', borderTop: '1px solid #ccc' }}>
                      <div style={{ position: 'relative' }}>
                        <div style={{ position: 'absolute', left: '10px', top: '0' }}>
                          <img src="/images/logos/capcert-logo.png" alt="CAPCERT" style={{ height: '75px' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:14px;color:#333;border:2px solid #333;padding:12px 16px;border-radius:6px;text-align:center"><strong>CAPCERT</strong><br/>ISO 9001</div>'; }} />
                        </div>
                        <div style={{ fontSize: '8pt', color: '#555', textAlign: 'center', lineHeight: '1.8' }}>
                          <strong style={{ color: '#333', fontSize: '8pt' }}>{biz.company_name || 'Lighthouse France SAS'}</strong> au capital de {biz.capital || '10 000'} ‚Ç¨<br/>
                          {biz.address || '16 rue Paul S√©journ√©'}, {biz.postal_code || '94000'} {biz.city || 'CR√âTEIL'} | T√©l. {biz.phone || '01 43 77 28 07'}<br/>
                          SIRET {biz.siret || '50178134800013'} | TVA {biz.tva || 'FR 86501781348'}<br/>
                          {biz.email || 'France@golighthouse.com'} | {biz.website || 'www.golighthouse.fr'}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
          
          {/* Step 4: Complete */}
          {step === 4 && (
            <div className="text-center py-8">
              <div className="text-6xl mb-4">‚úÖ</div>
              <h3 className="text-2xl font-bold text-green-700 mb-2">{lang === 'en' ? 'Shipping Complete!' : 'Exp√©dition Termin√©e!'}</h3>
              <p className="text-gray-600 mb-2">{lang === 'en' ? 'Devices have been marked as shipped.' : 'Les appareils ont √©t√© marqu√©s comme exp√©di√©s.'}</p>
              <p className="text-gray-500 text-sm mb-6">{lang === 'en' ? 'Close this window to see the completed RMA details.' : 'Fermez cette fen√™tre pour voir le d√©tail du RMA compl√©t√©.'}</p>
              <div className="bg-gray-50 rounded-xl p-6 max-w-md mx-auto">
                {generatedBLs.map((bl, idx) => (
                  <div key={idx} className="flex items-center justify-between p-3 bg-white rounded-lg mb-2 border">
                    <span className="font-mono font-medium">üìÑ {bl.blNumber}</span>
                    <a href={`https://www.ups.com/track?tracknum=${bl.shipping.tracking}`} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-sm">{bl.shipping.tracking}</a>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
        
        {/* Footer */}
        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between">
          {step === 1 && (
            <>
              <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{lang === 'en' ? 'Cancel' : 'Annuler'}</button>
              {shippingMode === 'bl_only' ? (
                <button 
                  onClick={proceedBLOnly} 
                  disabled={selectedDeviceIds.size === 0}
                  className="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
                >
                  {lang === 'en' ? `üìÑ Create Delivery Note (${selectedDeviceIds.size} device${selectedDeviceIds.size > 1 ? 's' : ''}) ‚Üí` : `üìÑ Cr√©er Bon de Livraison (${selectedDeviceIds.size} appareil${selectedDeviceIds.size > 1 ? 's' : ''}) ‚Üí`}
                </button>
              ) : (
                <button 
                  onClick={createUPSLabels} 
                  disabled={upsLoading || selectedDeviceIds.size === 0 || !shipments[0]?.address?.company_name || !shipments[0]?.address?.address_line1}
                  className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
                >
                  {upsLoading ? (
                    <>
                      <span className="animate-spin">‚è≥</span> {lang === 'en' ? 'Creating UPS label...' : 'Cr√©ation √©tiquette UPS...'}
                    </>
                  ) : (
                    <>{lang === 'en' ? `üì¶ Create UPS Label (${selectedDeviceIds.size} device${selectedDeviceIds.size > 1 ? 's' : ''}) ‚Üí` : `üì¶ Cr√©er √âtiquette UPS (${selectedDeviceIds.size} appareil${selectedDeviceIds.size > 1 ? 's' : ''}) ‚Üí`}</>
                  )}
                </button>
              )}
            </>
          )}
          {step === 2 && (
            <>
              <button onClick={() => setStep(1)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
              <button onClick={() => setStep(3)} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">{lang === 'en' ? 'Continue to DN ‚Üí' : 'Continuer vers BL ‚Üí'}</button>
            </>
          )}
          {step === 3 && (
            <>
              <button onClick={() => setStep(shippingMode === 'bl_only' ? 1 : 2)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
              <button onClick={saveShippingDocs} disabled={saving} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50">{saving ? (lang === 'en' ? '‚è≥ Processing...' : '‚è≥ Traitement...') : (lang === 'en' ? 'üíæ Save Documents' : 'üíæ Enregistrer Documents')}</button>
            </>
          )}
          {step === 4 && (
            <div className="flex gap-3 ml-auto">
              <button onClick={onClose} className="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">{lang === 'en' ? 'üìã View RMA' : 'üìã Voir le RMA'}</button>
              <button onClick={markAsShipped} disabled={saving} className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold disabled:opacity-50">
                {saving ? '‚è≥...' : (lang === 'en' ? 'üöö Mark Shipped (Close RMA)' : 'üöö Marquer Exp√©di√© (Fermer RMA)')}
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ============================================
// MESSAGES SHEET - All chats with clients
// ============================================

function MessagesSheet({ requests, notify, reload, onSelectRMA, t = k=>k, lang = 'fr' }) {
  const [selectedRMA, setSelectedRMA] = useState(null);
  const [messages, setMessages] = useState([]);
  const [sendingMessage, setSendingMessage] = useState(false);
  const [filter, setFilter] = useState('open');
  const [search, setSearch] = useState('');
  const [profile, setProfile] = useState(null);
  const [englishMode, setEnglishMode] = useState(true);
  const [englishInput, setEnglishInput] = useState('');
  const [frenchOutput, setFrenchOutput] = useState('');
  const [processingMessage, setProcessingMessage] = useState(false);
  const [aiSuggestions, setAiSuggestions] = useState([]);
  const [loadingSuggestions, setLoadingSuggestions] = useState(false);
  const [translatedMessages, setTranslatedMessages] = useState({});
  const [translatingMessages, setTranslatingMessages] = useState({});
  const [showRMASidebar, setShowRMASidebar] = useState(false);
  const [uploadingFile, setUploadingFile] = useState(false);
  const [showEnglishConfirm, setShowEnglishConfirm] = useState(false);
  
  const badWords = ['fuck', 'shit', 'bitch', 'ass', 'crap'];
  
  useEffect(() => {
    const loadProfile = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if (data) setProfile(data);
      }
    };
    loadProfile();
  }, []);
  
  const getUserSignature = () => {
    if (!profile?.full_name) return 'Lighthouse France';
    const names = profile.full_name.split(' ');
    if (names.length >= 2) {
      return `${names[0]} ${names[1].charAt(0)}. - Lighthouse France`;
    }
    return `${profile.full_name} - Lighthouse France`;
  };
  
  const isWithin48Hours = (dateStr) => {
    const msgDate = new Date(dateStr);
    const now = new Date();
    return (now - msgDate) / (1000 * 60 * 60) <= 48;
  };
  
  const filteredRMAs = requests.filter(r => {
    const hasUnread = (r.unread_admin_count || 0) > 0;
    const isOpen = r.chat_status === 'open';
    if (filter === 'open' && !isOpen && !hasUnread) return false;
    if (filter === 'closed' && (isOpen || hasUnread)) return false;
    if (search.trim()) {
      const s = search.toLowerCase();
      if (r.request_number?.toLowerCase().includes(s)) return true;
      if (r.companies?.name?.toLowerCase().includes(s)) return true;
      return false;
    }
    return true;
  }).sort((a, b) => {
    const aOpen = a.chat_status === 'open' || (a.unread_admin_count || 0) > 0;
    const bOpen = b.chat_status === 'open' || (b.unread_admin_count || 0) > 0;
    if (aOpen && !bOpen) return -1;
    if (bOpen && !aOpen) return 1;
    if (aOpen && bOpen) return new Date(a.last_message_at || a.updated_at) - new Date(b.last_message_at || b.updated_at);
    return new Date(b.updated_at) - new Date(a.updated_at);
  });
  
  useEffect(() => {
    if (!selectedRMA) { setMessages([]); setAiSuggestions([]); return; }
    const load = async () => {
      const { data } = await supabase.from('messages').select('*').eq('request_id', selectedRMA.id).order('created_at', { ascending: true });
      if (data) {
        setMessages(data);
        if (englishMode) {
          data.filter(m => m.sender_type === 'customer' && isWithin48Hours(m.created_at)).forEach(m => translateMsg(m.id, m.content));
        }
        generateSuggestions(data);
      }
      if (selectedRMA.unread_admin_count > 0) {
        await supabase.from('messages').update({ is_read: true }).eq('request_id', selectedRMA.id).eq('sender_type', 'customer');
        await supabase.from('service_requests').update({ unread_admin_count: 0 }).eq('id', selectedRMA.id);
        reload();
      }
    };
    load();
    setEnglishInput(''); setFrenchOutput('');
  }, [selectedRMA?.id]);
  
  const translateMsg = async (id, text) => {
    if (translatedMessages[id] || translatingMessages[id]) return;
    setTranslatingMessages(p => ({ ...p, [id]: true }));
    try {
      const res = await fetch('/api/translate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text, direction: 'fr-to-en' }) });
      if (res.ok) { const d = await res.json(); setTranslatedMessages(p => ({ ...p, [id]: d.translation })); }
    } catch (e) { console.error(e); }
    setTranslatingMessages(p => ({ ...p, [id]: false }));
  };
  
  const generateSuggestions = async (msgs) => {
    if (!selectedRMA) return;
    setLoadingSuggestions(true);
    try {
      const res = await fetch('/api/chat-suggest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
        rma: { request_number: selectedRMA.request_number, status: selectedRMA.status, requested_service: selectedRMA.requested_service, company_name: selectedRMA.companies?.name, devices: selectedRMA.request_devices?.map(d => ({ model: d.model_name, serial: d.serial_number, status: d.status })) },
        messages: msgs.slice(-10).map(m => ({ sender: m.sender_type, content: m.content }))
      })});
      if (res.ok) { const d = await res.json(); if (d.french) setAiSuggestions([d]); }
    } catch (e) { console.error(e); }
    setLoadingSuggestions(false);
  };
  
  const processAndTranslate = async () => {
    if (!englishInput.trim()) return;
    if (badWords.some(w => englishInput.toLowerCase().includes(w))) { notify('‚ö†Ô∏è Please remove inappropriate language.', 'error'); return; }
    setProcessingMessage(true);
    try {
      const res = await fetch('/api/translate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: `Improve this English message for professional business communication, fix any grammar or spelling errors, then translate it to French. Only return the French translation, nothing else. Message: ${englishInput}`, direction: 'en-to-fr' }) });
      if (res.ok) { const d = await res.json(); setFrenchOutput(d.translation); }
    } catch (e) { notify('Translation error', 'error'); }
    setProcessingMessage(false);
  };
  
  const sendMessage = async () => {
    if (!frenchOutput.trim() || sendingMessage || !selectedRMA) return;
    const frW = ['le','la','les','de','est','sont','nous','vous'];
    const enW = ['the','is','are','we','you','your','have','will'];
    const lm = frenchOutput.toLowerCase();
    const frC = frW.filter(w => lm.includes(` ${w} `)).length;
    const enC = enW.filter(w => lm.includes(` ${w} `)).length;
    if (enC > frC && !showEnglishConfirm) { setShowEnglishConfirm(true); return; }
    setShowEnglishConfirm(false);
    setSendingMessage(true);
    try {
      const { data, error } = await supabase.from('messages').insert({ request_id: selectedRMA.id, sender_id: profile?.id, sender_type: 'admin', sender_name: profile?.full_name || 'Admin', content: frenchOutput.trim() }).select().single();
      if (error) throw error;
      setMessages(p => [...p, data]);
      setEnglishInput(''); setFrenchOutput('');
      if (selectedRMA.chat_status !== 'open') {
        await supabase.from('service_requests').update({ chat_status: 'open' }).eq('id', selectedRMA.id);
        setSelectedRMA(p => ({ ...p, chat_status: 'open' }));
      }
      notify('‚úÖ Sent!');
      reload();
    } catch (e) { notify('Error: ' + e.message, 'error'); }
    setSendingMessage(false);
  };
  
  const toggleChat = async () => {
    if (!selectedRMA) return;
    const ns = selectedRMA.chat_status === 'open' ? 'closed' : 'open';
    await supabase.from('service_requests').update({ chat_status: ns }).eq('id', selectedRMA.id);
    setSelectedRMA(p => ({ ...p, chat_status: ns }));
    notify(ns === 'open' ? 'üîî Opened' : '‚úÖ Closed');
    reload();
  };
  
  const handleFile = async (e) => {
    const file = e.target.files?.[0];
    if (!file || !selectedRMA) return;
    setUploadingFile(true);
    try {
      const path = `chat/${selectedRMA.id}/${Date.now()}_${file.name}`;
      const { error: ue } = await supabase.storage.from('documents').upload(path, file);
      if (ue) throw ue;
      const { data: { publicUrl } } = supabase.storage.from('documents').getPublicUrl(path);
      const { data } = await supabase.from('messages').insert({ request_id: selectedRMA.id, sender_id: profile?.id, sender_type: 'admin', sender_name: profile?.full_name, content: `üìé ${file.name}`, attachment_url: publicUrl, attachment_name: file.name }).select().single();
      if (data) setMessages(p => [...p, data]);
      notify('‚úÖ Uploaded!');
    } catch (e) { notify('Error: ' + e.message, 'error'); }
    setUploadingFile(false);
    e.target.value = '';
  };
  
  const totalUnread = requests.reduce((s, r) => s + (r.unread_admin_count || 0), 0);
  const openCount = requests.filter(r => r.chat_status === 'open' || (r.unread_admin_count || 0) > 0).length;
  
  return (
    <div className="p-6">
      <div className="flex gap-4 h-[calc(100vh-180px)]">
        {/* Chat List */}
        <div className="w-72 bg-white rounded-xl shadow-sm border flex flex-col flex-shrink-0">
          <div className="p-3 border-b bg-gray-50">
            <div className="flex items-center justify-between mb-2">
              <span className="font-bold text-gray-800">{lang === 'en' ? 'üí¨ Messages' : 'üí¨ Messages'}</span>
              {totalUnread > 0 && <span className="px-2 py-0.5 bg-red-500 text-white rounded-full text-xs font-bold">{totalUnread}</span>}
            </div>
            <input value={search} onChange={e => setSearch(e.target.value)} placeholder="üîç Search..." className="w-full px-3 py-1.5 border rounded text-sm mb-2" />
            <div className="flex gap-1">
              {[{id:'open',l:'Open',c:openCount},{id:'closed',l:'Closed'},{id:'all',l:'All'}].map(f => (
                <button key={f.id} onClick={() => setFilter(f.id)} className={`flex-1 py-1 rounded text-xs font-medium ${filter === f.id ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}>
                  {f.l}{f.c > 0 ? ` (${f.c})` : ''}
                </button>
              ))}
            </div>
          </div>
          <div className="flex-1 overflow-y-auto divide-y">
            {filteredRMAs.map(rma => (
              <div key={rma.id} onClick={() => setSelectedRMA(rma)} className={`p-3 cursor-pointer ${selectedRMA?.id === rma.id ? 'bg-blue-50 border-l-4 border-blue-500' : (rma.unread_admin_count || 0) > 0 ? 'bg-amber-50' : 'hover:bg-gray-50'}`}>
                <div className="flex justify-between mb-1">
                  <span className="font-mono text-xs font-bold text-[#00A651]">{rma.request_number}</span>
                  {(rma.unread_admin_count || 0) > 0 && <span className="px-1.5 bg-red-500 text-white rounded-full text-xs">{rma.unread_admin_count}</span>}
                </div>
                <p className="text-sm font-medium truncate">{rma.companies?.name}</p>
              </div>
            ))}
          </div>
        </div>
        
        {/* Chat Area */}
        <div className="flex-1 bg-white rounded-xl shadow-sm border flex flex-col">
          {!selectedRMA ? (
            <div className="flex-1 flex items-center justify-center text-gray-400">
              <div className="text-center"><p className="text-4xl mb-2">üí¨</p><p>Select a conversation</p></div>
            </div>
          ) : (
            <>
              {/* Header */}
              <div className={`p-3 border-b flex justify-between items-center ${selectedRMA.chat_status === 'open' ? 'bg-amber-50' : 'bg-gray-50'}`}>
                <div>
                  <span className="font-mono font-bold text-[#00A651]">{selectedRMA.request_number}</span>
                  <span className="text-sm text-gray-500 ml-2">{selectedRMA.companies?.name}</span>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setEnglishMode(!englishMode)} className={`px-2 py-1 rounded text-xs font-medium ${englishMode ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}>
                    {englishMode ? 'üá¨üáß EN' : 'üá´üá∑ FR'}
                  </button>
                  <button onClick={() => setShowRMASidebar(!showRMASidebar)} className={`px-2 py-1 rounded text-xs font-medium ${showRMASidebar ? 'bg-purple-500 text-white' : 'bg-purple-100'}`}>{lang === 'en' ? 'üìã RMA' : 'üìã RMA'}</button>
                  <button onClick={toggleChat} className={`px-2 py-1 rounded text-xs font-medium ${selectedRMA.chat_status === 'open' ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'}`}>
                    {selectedRMA.chat_status === 'open' ? '‚úì Close' : '+ Open'}
                  </button>
                </div>
              </div>
              
              <div className="flex-1 flex overflow-hidden">
                {/* Messages */}
                <div className="flex-1 flex flex-col">
                  <div className="flex-1 overflow-y-auto p-4 space-y-3">
                    {messages.map(msg => {
                      const isAdmin = msg.sender_type === 'admin';
                      const trans = translatedMessages[msg.id];
                      const recent = isWithin48Hours(msg.created_at);
                      return (
                        <div key={msg.id} className={`flex ${isAdmin ? 'justify-end' : 'justify-start'}`}>
                          <div className={`max-w-[70%] p-3 rounded-lg ${isAdmin ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}>
                            <div className="flex justify-between text-xs mb-1 gap-2">
                              <span className={isAdmin ? 'text-blue-200' : 'text-gray-500'}>{msg.sender_name || (isAdmin ? 'Admin' : 'Client')}</span>
                              <span className={isAdmin ? 'text-blue-200' : 'text-gray-400'}>{new Date(msg.created_at).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}</span>
                            </div>
                            {englishMode && !isAdmin && trans ? (
                              <><p className="text-sm">{trans}</p><p className="text-xs mt-1 pt-1 border-t border-gray-200 text-gray-400 italic">üá´üá∑ {msg.content}</p></>
                            ) : englishMode && !isAdmin && recent && translatingMessages[msg.id] ? (
                              <p className="text-sm text-gray-400 italic">Translating...</p>
                            ) : (
                              <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
                            )}
                            {englishMode && !isAdmin && !recent && !trans && (
                              <button onClick={() => translateMsg(msg.id, msg.content)} className="text-xs text-blue-500 mt-1">üá¨üáß Translate</button>
                            )}
                            {msg.attachment_url && (
                              <a href={msg.attachment_url} target="_blank" className={`text-xs mt-2 block ${isAdmin ? 'text-blue-200' : 'text-blue-600'}`}>üìé {msg.attachment_name || 'Download'}</a>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* AI Suggestions */}
                  {(loadingSuggestions || aiSuggestions.length > 0) && (
                    <div className="border-t bg-purple-50 p-2">
                      <div className="flex items-center justify-between mb-1">
                        <span className="text-xs font-medium text-purple-700">ü§ñ AI Suggestion</span>
                        <button onClick={() => generateSuggestions(messages)} className="text-xs text-purple-600">üîÑ Refresh</button>
                      </div>
                      {loadingSuggestions ? <p className="text-xs text-purple-500">Loading...</p> : aiSuggestions.map((s, i) => (
                        <div key={i} onClick={() => { setEnglishInput(s.english); setFrenchOutput(s.french); }} className="p-2 bg-white rounded border border-purple-200 cursor-pointer hover:border-purple-400 text-xs">
                          <p className="text-gray-600">{englishMode ? s.english : s.french}</p>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* Input */}
                  <div className="border-t bg-gray-50 p-3">
                    {englishMode ? (
                      <div className="space-y-2">
                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="text-xs text-gray-500 mb-1 block">üá¨üáß Your message (English)</label>
                            <textarea value={englishInput} onChange={e => setEnglishInput(e.target.value)} placeholder="Type in English..." className="w-full px-2 py-1.5 border rounded text-sm h-16 resize-none" />
                          </div>
                          <div>
                            <label className="text-xs text-gray-500 mb-1 block">üá´üá∑ French (will be sent)</label>
                            <textarea value={frenchOutput} onChange={e => setFrenchOutput(e.target.value)} placeholder="French here..." className="w-full px-2 py-1.5 border rounded text-sm h-16 resize-none bg-white" />
                          </div>
                        </div>
                        <div className="flex justify-between">
                          <div className="flex gap-2">
                            <button onClick={processAndTranslate} disabled={processingMessage || !englishInput.trim()} className="px-3 py-1.5 bg-purple-500 text-white rounded text-xs font-medium disabled:opacity-50">
                              {processingMessage ? '‚è≥...' : 'üîÑ Translate'}
                            </button>
                            <label className="px-3 py-1.5 bg-gray-200 rounded text-xs font-medium cursor-pointer">
                              üìé File<input type="file" className="hidden" onChange={handleFile} disabled={uploadingFile} />
                            </label>
                          </div>
                          <button onClick={sendMessage} disabled={sendingMessage || !frenchOutput.trim()} className="px-4 py-1.5 bg-green-500 text-white rounded text-xs font-medium disabled:opacity-50">
                            {sendingMessage ? '‚è≥...' : 'üì§ Send French'}
                          </button>
                        </div>
                      </div>
                    ) : (
                      <div className="flex gap-2">
                        <textarea value={frenchOutput} onChange={e => setFrenchOutput(e.target.value)} placeholder={lang === 'en' ? 'Message in French...' : 'Message en fran√ßais...'} className="flex-1 px-2 py-1.5 border rounded text-sm resize-none" rows={2} />
                        <div className="flex flex-col gap-1">
                          <label className="px-2 py-1.5 bg-gray-200 rounded text-xs cursor-pointer text-center">üìé<input type="file" className="hidden" onChange={handleFile} /></label>
                          <button onClick={sendMessage} disabled={sendingMessage || !frenchOutput.trim()} className="px-3 py-1.5 bg-blue-500 text-white rounded text-xs disabled:opacity-50">üì§</button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
                
                {/* RMA Sidebar */}
                {showRMASidebar && (
                  <div className="w-72 border-l bg-gray-50 p-3 overflow-y-auto flex-shrink-0">
                    <h3 className="font-bold text-gray-700 mb-3">{lang === 'en' ? 'üìã RMA Info' : 'üìã RMA Info'}</h3>
                    <div className="space-y-2 text-sm">
                      <div className="bg-white p-2 rounded border"><span className="text-gray-500 text-xs">RMA</span><p className="font-mono font-bold text-[#00A651]">{selectedRMA.request_number}</p></div>
                      <div className="bg-white p-2 rounded border"><span className="text-gray-500 text-xs">Status</span><p>{selectedRMA.status}</p></div>
                      <div className="bg-white p-2 rounded border"><span className="text-gray-500 text-xs">{lang === 'en' ? 'Service' : 'Service'}</span><p>{selectedRMA.requested_service}</p></div>
                      <div className="bg-white p-2 rounded border"><span className="text-gray-500 text-xs">Company</span><p>{selectedRMA.companies?.name}</p></div>
                      <div className="bg-white p-2 rounded border">
                        <span className="text-gray-500 text-xs">Devices ({selectedRMA.request_devices?.length || 0})</span>
                        {selectedRMA.request_devices?.map((d, i) => (
                          <div key={i} className="mt-1 pt-1 border-t text-xs">
                            <p className="font-medium flex items-center gap-2">{getDeviceImageUrl(d.model_name) && <img src={getDeviceImageUrl(d.model_name)} alt="" className="w-4 h-4 object-contain" />}{d.model_name}</p>
                            <p className="text-gray-400">SN: {d.serial_number}</p>
                          </div>
                        ))}
                      </div>
                      <button onClick={() => onSelectRMA(selectedRMA)} className="w-full py-2 bg-blue-500 text-white rounded text-sm font-medium">Open Full RMA ‚Üí</button>
                    </div>
                  </div>
                )}
              </div>
            </>
          )}
        </div>
      </div>
      
      {/* English Confirm Modal */}
      {showEnglishConfirm && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl p-6 max-w-md">
            <h3 className="font-bold text-lg mb-2">‚ö†Ô∏è Message appears to be in English</h3>
            <p className="text-gray-600 mb-4">Are you sure you want to send this? It looks like English, not French.</p>
            <div className="flex gap-3">
              <button onClick={() => setShowEnglishConfirm(false)} className="flex-1 py-2 bg-gray-200 rounded font-medium">Cancel</button>
              <button onClick={sendMessage} className="flex-1 py-2 bg-amber-500 text-white rounded font-medium">Send Anyway</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function ClientsSheet({ clients, requests, equipment, notify, reload, isAdmin, businessSettings, profile, onSelectRMA, onSelectDevice, t = k=>k, lang = 'fr' }) {
  const [selectedClient, setSelectedClient] = useState(null);
  const [search, setSearch] = useState('');
  const [searchResults, setSearchResults] = useState(null); // null = show clients, object = show search results
  
  // Determine what kind of search this is
  const searchType = (() => {
    const s = search.trim().toUpperCase();
    if (s.startsWith('FR-') || s.startsWith('FR')) return 'rma';
    if (s.length >= 3 && /^\d+$/.test(s)) return 'serial'; // Numeric string = likely serial
    if (s.length >= 2) return 'all'; // Search everything
    return 'none';
  })();
  
  // Perform search when search changes
  useEffect(() => {
    if (!search.trim() || search.trim().length < 2) {
      setSearchResults(null);
      return;
    }
    
    const s = search.trim().toLowerCase();
    const sUpper = search.trim().toUpperCase();
    
    // Search for RMAs by number
    const rmaMatches = requests.filter(r => 
      r.request_number?.toUpperCase().includes(sUpper)
    );
    
    // Search for devices by serial number across all RMAs
    const serialMatches = [];
    requests.forEach(rma => {
      (rma.request_devices || []).forEach(device => {
        if (device.serial_number?.toLowerCase().includes(s)) {
          serialMatches.push({ device, rma });
        }
      });
    });
    
    // Also search equipment table for serial numbers
    const equipmentMatches = equipment.filter(eq => 
      eq.serial_number?.toLowerCase().includes(s)
    );
    
    // Search clients by name/email
    const clientMatches = clients.filter(c => 
      c.name?.toLowerCase().includes(s) || 
      c.profiles?.some(p => p.email?.toLowerCase().includes(s))
    );
    
    // If we have RMA or serial matches, show those results
    if (rmaMatches.length > 0 || serialMatches.length > 0) {
      setSearchResults({
        type: rmaMatches.length > 0 ? 'rma' : 'serial',
        rmas: rmaMatches,
        serialDevices: serialMatches,
        equipment: equipmentMatches,
        clients: clientMatches
      });
    } else if (clientMatches.length > 0 || equipmentMatches.length > 0) {
      setSearchResults({
        type: 'client',
        rmas: [],
        serialDevices: [],
        equipment: equipmentMatches,
        clients: clientMatches
      });
    } else {
      setSearchResults({
        type: 'none',
        rmas: [],
        serialDevices: [],
        equipment: [],
        clients: []
      });
    }
  }, [search, requests, equipment, clients]);
  
  const filteredClients = clients.filter(c => 
    c.name?.toLowerCase().includes(search.toLowerCase()) || 
    c.profiles?.some(p => p.email?.toLowerCase().includes(search.toLowerCase()))
  );
  
  const getClientStats = (clientId) => { 
    const clientRequests = requests.filter(r => r.company_id === clientId); 
    const rmas = clientRequests.filter(r => r.request_type !== 'parts');
    const pos = clientRequests.filter(r => r.request_type === 'parts');
    return { 
      total: clientRequests.length, 
      rmas: rmas.length,
      pos: pos.length,
      active: clientRequests.filter(r => !['completed', 'cancelled', 'shipped'].includes(r.status) && r.request_number).length 
    }; 
  };
  
  // Get all RMAs for a serial number
  const getSerialHistory = (serialNumber) => {
    const history = [];
    requests.forEach(rma => {
      (rma.request_devices || []).forEach(device => {
        if (device.serial_number === serialNumber) {
          history.push({ rma, device });
        }
      });
    });
    return history.sort((a, b) => new Date(b.rma.created_at) - new Date(a.rma.created_at));
  };
  
  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">Clients ({clients.length})</h1>
        <div className="relative">
          <input 
            type="text" 
            placeholder={lang === 'en' ? 'üîç Client, Serial #, or RMA...' : 'üîç Client, N¬∞ s√©rie, ou RMA...'} 
            value={search} 
            onChange={e => setSearch(e.target.value)} 
            className="px-4 py-2 border border-gray-300 rounded-lg w-96" 
          />
          {search && (
            <button 
              onClick={() => setSearch('')}
              className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
            >
              ‚úï
            </button>
          )}
        </div>
      </div>
      
      {/* Search Results */}
      {searchResults && search.trim().length >= 2 ? (
        <div className="space-y-6">
          {/* RMA Results (non-parts) */}
          {searchResults.rmas.filter(r => r.request_type !== 'parts').length > 0 && (
            <div className="bg-white rounded-xl shadow-sm">
              <div className="px-6 py-4 border-b border-gray-100 bg-blue-50">
                <h2 className="font-bold text-blue-800">{lang === 'en' ? 'üìã RMAs found' : 'üìã RMAs trouv√©s'} ({searchResults.rmas.filter(r => r.request_type !== 'parts').length})</h2>
              </div>
              <div className="divide-y divide-gray-100">
                {searchResults.rmas.filter(r => r.request_type !== 'parts').map(rma => {
                  const style = STATUS_STYLES[rma.status] || STATUS_STYLES.submitted;
                  const devices = rma.request_devices || [];
                  return (
                    <div 
                      key={rma.id} 
                      className="p-4 hover:bg-blue-50 cursor-pointer transition-colors"
                      onClick={() => onSelectRMA(rma)}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <div className="flex items-center gap-3">
                            <span className="font-mono font-bold text-[#00A651] text-lg">{rma.request_number}</span>
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${style.bg} ${style.text}`}>{lang === 'en' && style.en ? style.en : style.label}</span>
                            <span className="text-xs text-blue-500">{lang === 'en' ? 'Click to open ‚Üí' : 'Cliquez pour ouvrir ‚Üí'}</span>
                          </div>
                          <p className="text-gray-600 mt-1">{rma.companies?.name}</p>
                          <p className="text-sm text-gray-400">{new Date(rma.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
                        </div>
                        <div className="text-right">
                          <p className="text-sm text-gray-500">{devices.length} appareil(s)</p>
                          {devices.slice(0, 3).map((d, i) => (
                            <p key={i} className="text-xs text-gray-400">{d.model_name} - {d.serial_number}</p>
                          ))}
                          {devices.length > 3 && <p className="text-xs text-gray-400">+{devices.length - 3} {lang === 'en' ? 'more' : 'autres'}</p>}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          
          {/* Parts Order Results */}
          {searchResults.rmas.filter(r => r.request_type === 'parts').length > 0 && (
            <div className="bg-white rounded-xl shadow-sm">
              <div className="px-6 py-4 border-b border-gray-100 bg-amber-50">
                <h2 className="font-bold text-amber-800">{lang === 'en' ? 'üî© Parts Orders' : 'üî© Commandes Pi√®ces'} ({searchResults.rmas.filter(r => r.request_type === 'parts').length})</h2>
              </div>
              <div className="divide-y divide-gray-100">
                {searchResults.rmas.filter(r => r.request_type === 'parts').map(po => {
                  const poStyles = {
                    submitted: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'New' : 'Nouvelle' },
                    quote_sent: { bg: 'bg-purple-100', text: 'text-purple-700', label: lang === 'en' ? 'Quote Sent' : 'Devis envoy√©' },
    pending_quote_review: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'Quote Under Review' : 'Devis en v√©rification' },
                    quote_revision_requested: { bg: 'bg-red-100', text: 'text-red-700', label: lang === 'en' ? 'Revision' : 'R√©vision' },
                    bc_review: { bg: 'bg-blue-100', text: 'text-blue-700', label: lang === 'en' ? 'PO to Review' : 'BC √† v√©rifier' },
                    in_progress: { bg: 'bg-orange-100', text: 'text-orange-700', label: lang === 'en' ? 'In progress' : 'En cours' },
                    ready_to_ship: { bg: 'bg-indigo-100', text: 'text-indigo-700', label: lang === 'en' ? 'Ready' : 'Pr√™t' },
                    shipped: { bg: 'bg-green-100', text: 'text-green-700', label: t('stShipped') },
                    delivered: { bg: 'bg-emerald-100', text: 'text-emerald-700', label: lang === 'en' ? 'Delivered' : 'Livr√©' },
                    completed: { bg: 'bg-gray-100', text: 'text-gray-700', label: lang === 'en' ? 'Completed' : 'Termin√©' }
                  };
                  const style = poStyles[po.status] || { bg: 'bg-gray-100', text: 'text-gray-700', label: po.status };
                  const parts = po.quote_data?.parts || [];
                  const total = po.quote_data?.grandTotal || 0;
                  const shipping = po.quote_data?.shipping || {};
                  
                  return (
                    <div 
                      key={po.id} 
                      className="p-4 hover:bg-amber-50 cursor-pointer transition-colors"
                      onClick={() => onSelectRMA(po)}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <div className="flex items-center gap-3">
                            <span className="font-mono font-bold text-amber-600 text-lg">{po.request_number}</span>
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${style.bg} ${style.text}`}>{lang === 'en' && style.en ? style.en : style.label}</span>
                            {po.bc_number && <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-mono">{po.bc_number}</span>}
                            <span className="text-xs text-amber-500">{lang === 'en' ? 'Click to open ‚Üí' : 'Cliquez pour ouvrir ‚Üí'}</span>
                          </div>
                          <p className="text-gray-600 mt-1">{po.companies?.name}</p>
                          <p className="text-sm text-gray-400">{new Date(po.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
                        </div>
                        <div className="text-right">
                          <p className="text-sm text-gray-500">{parts.length} {lang === 'en' ? 'part(s)' : 'pi√®ce(s)'}</p>
                          {total > 0 && <p className="text-sm font-bold text-gray-700">{total.toFixed(2)} ‚Ç¨</p>}
                          {shipping.trackingNumber && <p className="text-xs text-blue-500 font-mono mt-1">üöö {shipping.trackingNumber}</p>}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          
          {/* Serial Number Results */}
          {searchResults.serialDevices.length > 0 && (
            <div className="bg-white rounded-xl shadow-sm">
              <div className="px-6 py-4 border-b border-gray-100 bg-green-50">
                <h2 className="font-bold text-green-800">{lang === 'en' ? `üîß Serial # History (${searchResults.serialDevices.length} RMA(s))` : `üîß Historique N¬∞ S√©rie (${searchResults.serialDevices.length} RMA(s))`}</h2>
              </div>
              <div className="divide-y divide-gray-100">
                {/* Group by serial number */}
                {(() => {
                  const bySerial = {};
                  searchResults.serialDevices.forEach(({ device, rma }) => {
                    if (!bySerial[device.serial_number]) {
                      bySerial[device.serial_number] = { device, rmas: [] };
                    }
                    bySerial[device.serial_number].rmas.push({ rma, device });
                  });
                  
                  return Object.entries(bySerial).map(([serial, data]) => (
                    <div key={serial} className="p-4">
                      <div className="flex items-center gap-3 mb-3">
                        <span className="font-mono font-bold text-gray-800 text-lg">{serial}</span>
                        <span className="text-gray-500">{data.device.model_name}</span>
                        <span className="px-2 py-0.5 bg-gray-100 rounded text-xs text-gray-600">{data.rmas.length} intervention(s)</span>
                      </div>
                      <div className="ml-4 space-y-2">
                        {data.rmas.sort((a, b) => new Date(b.rma.created_at) - new Date(a.rma.created_at)).map(({ rma, device }) => {
                          const style = STATUS_STYLES[rma.status] || STATUS_STYLES.submitted;
                          return (
                            <div 
                              key={rma.id} 
                              className="flex items-center justify-between bg-gray-50 hover:bg-green-50 rounded-lg p-3 cursor-pointer transition-colors"
                              onClick={() => onSelectDevice ? onSelectDevice(device, rma) : onSelectRMA(rma)}
                            >
                              <div className="flex items-center gap-3">
                                <span className="font-mono text-[#00A651] font-medium">{rma.request_number}</span>
                                <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${style.bg} ${style.text}`}>{lang === 'en' && style.en ? style.en : style.label}</span>
                                <span className="text-sm text-gray-500">{device.service_type === 'repair' ? (lang === 'en' ? 'üîß Repair' : 'üîß R√©paration') : 'üî¨ √âtalonnage'}</span>
                              </div>
                              <div className="flex items-center gap-4">
                                <div className="text-right">
                                  <p className="text-sm text-gray-600">{rma.companies?.name}</p>
                                  <p className="text-xs text-gray-400">{new Date(rma.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
                                </div>
                                <span className="text-green-500 text-sm">{lang === 'en' ? 'View device ‚Üí' : 'Voir appareil ‚Üí'}</span>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ));
                })()}
              </div>
            </div>
          )}
          
          {/* Equipment matches (devices registered but maybe no RMA yet) */}
          {searchResults.equipment.length > 0 && searchResults.serialDevices.length === 0 && (
            <div className="bg-white rounded-xl shadow-sm">
              <div className="px-6 py-4 border-b border-gray-100 bg-amber-50">
                <h2 className="font-bold text-amber-800">{lang === 'en' ? `üì¶ Registered Devices (${searchResults.equipment.length})` : `üì¶ Appareils enregistr√©s (${searchResults.equipment.length})`}</h2>
              </div>
              <div className="divide-y divide-gray-100">
                {searchResults.equipment.map(eq => (
                  <div key={eq.id} className={`p-4 flex justify-between items-center ${eq.hidden_by_customer ? 'bg-orange-50' : ''}`}>
                    <div>
                      <p className="font-medium flex items-center gap-2">
                        {getDeviceImageUrl(eq.model_name) && <img src={getDeviceImageUrl(eq.model_name)} alt="" className="w-5 h-5 object-contain" />}
                        {eq.model_name}
                        {eq.hidden_by_customer && <span className="ml-2 text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">{lang === 'en' ? 'üì¶ Archived' : 'üì¶ Archiv√©'}</span>}
                      </p>
                      <p className="font-mono text-sm text-gray-600">SN: {eq.serial_number}</p>
                    </div>
                    <div className="text-right">
                      <p className="text-sm text-gray-600">{eq.companies?.name || 'Client inconnu'}</p>
                      <p className="text-xs text-gray-400">{eq.brand}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          {/* Client matches */}
          {searchResults.clients.length > 0 && searchResults.rmas.length === 0 && searchResults.serialDevices.length === 0 && (
            <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
              <div className="px-6 py-4 border-b border-gray-100">
                <h2 className="font-bold text-gray-800">üë• Clients ({searchResults.clients.length})</h2>
              </div>
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Company' : 'Entreprise'}</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Primary contact' : 'Contact principal'}</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('city')}</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'RMAs' : 'RMAs'}</th>
                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('actions')}</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {searchResults.clients.map(client => { 
                    const stats = getClientStats(client.id); 
                    const mainContact = client.profiles?.find(p => p.role === 'admin' && p.invitation_status === 'active') || client.profiles?.find(p => p.invitation_status === 'active') || client.profiles?.[0]; 
                    return (
                      <tr key={client.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => setSelectedClient(client)}>
                        <td className="px-4 py-3"><p className="font-medium text-gray-800">{client.name}</p></td>
                        <td className="px-4 py-3">{mainContact ? <div><p className={`text-sm ${mainContact.invitation_status === 'gdpr_erased' ? 'text-red-400' : ''}`}>{mainContact.full_name} {mainContact.invitation_status === 'gdpr_erased' ? 'üóë' : ''}</p><p className="text-xs text-gray-400">{mainContact.invitation_status !== 'gdpr_erased' ? mainContact.email : ''}</p></div> : <span className="text-gray-400">‚Äî</span>}</td>
                        <td className="px-4 py-3 text-sm text-gray-600">{client.billing_city || '‚Äî'}</td>
                        <td className="px-4 py-3"><span className="text-sm">{stats.rmas} RMA{stats.pos > 0 && <span className="ml-2 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded-full text-xs">{stats.pos} PO</span>}{stats.active > 0 && <span className="ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs">{stats.active} actif</span>}</span></td>
                        <td className="px-4 py-3"><button onClick={e => { e.stopPropagation(); setSelectedClient(client); }} className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded">{lang === 'en' ? 'View ‚Üí' : 'Voir ‚Üí'}</button></td>
                      </tr>
                    ); 
                  })}
                </tbody>
              </table>
            </div>
          )}
          
          {/* No results */}
          {searchResults.type === 'none' && (
            <div className="bg-white rounded-xl shadow-sm p-8 text-center">
              <p className="text-5xl mb-4">üîç</p>
              <p className="text-gray-500">Aucun r√©sultat pour "{search}"</p>
              <p className="text-sm text-gray-400 mt-2">{lang === 'en' ? 'Try a serial number, RMA number, or client name' : 'Essayez un num√©ro de s√©rie, un num√©ro RMA, ou un nom de client'}</p>
            </div>
          )}
        </div>
      ) : (
        /* Default: Show all clients */
        <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Company' : 'Entreprise'}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Primary contact' : 'Contact principal'}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('city')}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'RMAs' : 'RMAs'}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('actions')}</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {(search ? filteredClients : clients).map(client => { 
                const stats = getClientStats(client.id); 
                const mainContact = client.profiles?.find(p => p.role === 'admin' && p.invitation_status === 'active') || client.profiles?.find(p => p.invitation_status === 'active') || client.profiles?.[0]; 
                return (
                  <tr key={client.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => setSelectedClient(client)}>
                    <td className="px-4 py-3"><p className="font-medium text-gray-800">{client.name}</p></td>
                    <td className="px-4 py-3">{mainContact ? <div><p className={`text-sm ${mainContact.invitation_status === 'gdpr_erased' ? 'text-red-400' : ''}`}>{mainContact.full_name} {mainContact.invitation_status === 'gdpr_erased' ? 'üóë' : ''}</p><p className="text-xs text-gray-400">{mainContact.invitation_status !== 'gdpr_erased' ? mainContact.email : ''}</p></div> : <span className="text-gray-400">‚Äî</span>}</td>
                    <td className="px-4 py-3 text-sm text-gray-600">{client.billing_city || '‚Äî'}</td>
                    <td className="px-4 py-3"><span className="text-sm">{stats.rmas} RMA{stats.pos > 0 && <span className="ml-2 px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded-full text-xs">{stats.pos} PO</span>}{stats.active > 0 && <span className="ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs">{stats.active} actif</span>}</span></td>
                    <td className="px-4 py-3"><button onClick={e => { e.stopPropagation(); setSelectedClient(client); }} className="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded">{lang === 'en' ? 'View ‚Üí' : 'Voir ‚Üí'}</button></td>
                  </tr>
                ); 
              })}
            </tbody>
          </table>
        </div>
      )}
      
      {selectedClient && <ClientDetailModal client={selectedClient} requests={requests.filter(r => r.company_id === selectedClient.id && r.request_type !== 'parts')} partsOrders={requests.filter(r => r.company_id === selectedClient.id && r.request_type === 'parts')} equipment={equipment.filter(e => e.company_id === selectedClient.id)} onClose={() => setSelectedClient(null)} notify={notify} reload={reload} isAdmin={isAdmin} businessSettings={businessSettings} profile={profile} onSelectRMA={onSelectRMA} onSelectDevice={onSelectDevice} lang={lang} />}
    </div>
  );
}

function ClientDetailModal({ client, requests, partsOrders, equipment, onClose, notify, reload, isAdmin, businessSettings, profile, onSelectRMA, onSelectDevice, lang = 'fr' }) {
  const t = k => k;
  const [activeTab, setActiveTab] = useState('rmas');
  const [editing, setEditing] = useState(false);
  const [editData, setEditData] = useState({ name: client.name || '', billing_address: client.billing_address || '', billing_city: client.billing_city || '', billing_postal_code: client.billing_postal_code || '', siret: client.siret || '', tva_number: client.tva_number || '' });
  const [saving, setSaving] = useState(false);
  const [selectedEquipment, setSelectedEquipment] = useState(null);
  const [clientContracts, setClientContracts] = useState([]);
  const [clientLocations, setClientLocations] = useState([]);
  const [selectedContract, setSelectedContract] = useState(null);
  const [clientRentals, setClientRentals] = useState([]);
  const [selectedRental, setSelectedRental] = useState(null);
  
  const partsOrdersList = partsOrders || [];

  const loadContracts = async () => {
    try {
      const { data } = await supabase.from('contracts').select('*, contract_devices(*)').eq('company_id', client.id).order('created_at', { ascending: false });
      if (data) setClientContracts(data);
    } catch (e) {}
  };
  const loadLocations = async () => {
    try {
      const { data } = await supabase.from('shipping_addresses').select('*').eq('company_id', client.id).order('label');
      if (data) setClientLocations(data);
    } catch (e) {}
  };
  const loadRentals = async () => {
    try {
      const { data } = await supabase.from('rental_requests')
        .select('*, companies(*), rental_request_items(*), shipping_address:shipping_addresses!shipping_address_id(*)')
        .eq('company_id', client.id)
        .order('created_at', { ascending: false });
      if (data) setClientRentals(data);
    } catch (e) {}
  };
  
  const switchTab = (tabId) => {
    setActiveTab(tabId);
    setSelectedEquipment(null);
    if (tabId === 'contracts' && clientContracts.length === 0) loadContracts();
    if (tabId === 'sites' && clientLocations.length === 0) loadLocations();
    if (tabId === 'rentals' && clientRentals.length === 0) loadRentals();
  };

  const saveClient = async () => { setSaving(true); const { error } = await supabase.from('companies').update(editData).eq('id', client.id); if (error) notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error'); else { notify((lang === 'en' ? 'Client updated!' : 'Client mis √† jour!')); setEditing(false); reload(); } setSaving(false); };
  
  const handleSelectItem = (item) => { onClose(); if (onSelectRMA) onSelectRMA(item); };
  
  const getDeviceRMAHistory = (serialNumber) => {
    return requests.filter(r => r.request_devices?.some(d => d.serial_number === serialNumber))
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  };

  const tabDefs = [
    { id: 'rmas', label: 'RMAs', icon: 'üìã', count: requests.length },
    { id: 'parts', label: lang === 'en' ? 'Parts' : 'Pi√®ces', icon: 'üî©', count: partsOrdersList.length },
    { id: 'rentals', label: lang === 'en' ? 'Rentals' : 'Locations', icon: 'üìÖ' },
    { id: 'contracts', label: lang === 'en' ? 'Contracts' : 'Contrats', icon: 'üìë' },
    { id: 'devices', label: lang === 'en' ? 'Devices' : 'Appareils', icon: 'üîß', count: equipment.length, badge: equipment.filter(e => e.hidden_by_customer).length > 0 ? equipment.filter(e => e.hidden_by_customer).length + ' üì¶' : null },
    { id: 'sites', label: lang === 'en' ? 'Sites' : 'Sites', icon: 'üìç' },
    { id: 'info', label: 'Info', icon: '‚ÑπÔ∏è' },
    { id: 'contacts', label: lang === 'en' ? 'Contacts' : 'Contacts', icon: 'üë§', count: client.profiles?.filter(p => p.invitation_status !== 'gdpr_erased').length || 0 }
  ];
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={onClose}>
      <div className="bg-white rounded-xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
        {/* HEADER */}
        <div className="px-6 py-4 border-b bg-gradient-to-r from-[#1a1a2e] to-[#2d2d44] text-white flex justify-between items-center shrink-0">
          <div>
            <h2 className="text-xl font-bold">{client.name}</h2>
            <p className="text-sm text-gray-300">{client.billing_city}</p>
          </div>
          <button onClick={onClose} className="text-white/70 hover:text-white text-2xl">&times;</button>
        </div>
        
        {/* TAB BAR - always visible */}
        <div className="border-b bg-gray-50 px-2 flex overflow-x-auto shrink-0" style={{minHeight: '48px'}}>
          {tabDefs.map(tab => (
            <button 
              key={tab.id} 
              onClick={() => switchTab(tab.id)} 
              className={'px-4 py-3 font-medium flex items-center gap-1.5 border-b-2 whitespace-nowrap text-sm ' + (activeTab === tab.id ? 'border-[#00A651] text-[#00A651] bg-white' : 'border-transparent text-gray-500 hover:text-gray-700')}
            >
              <span>{tab.icon}</span>
              {tab.label}
              {tab.count > 0 ? <span className="px-1.5 py-0.5 bg-gray-200 rounded-full text-xs">{tab.count}</span> : null}
              {tab.badge && <span className="px-1.5 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs">{tab.badge}</span>}
            </button>
          ))}
        </div>
        
        {/* TAB CONTENT */}
        <div className="flex-1 overflow-y-auto p-6">
        
          {/* === RMAs === */}
          {activeTab === 'rmas' && (
            <div className="space-y-3">
              {requests.length === 0 ? <p className="text-center text-gray-400 py-8">{lang === 'en' ? 'No RMAs' : 'Aucun RMA'}</p> : requests.map(req => { 
                const style = STATUS_STYLES[req.status] || STATUS_STYLES.submitted; 
                return (
                  <div key={req.id} onClick={() => handleSelectItem(req)} className="bg-gray-50 rounded-lg p-4 flex justify-between items-center hover:bg-gray-100 cursor-pointer transition-colors">
                    <div className="flex items-center gap-4">
                      <span className="font-mono font-bold text-[#00A651]">{req.request_number || 'En attente'}</span>
                      <div>
                        <p className="font-medium">{req.requested_service}</p>
                        <p className="text-sm text-gray-500">{req.request_devices?.length || 1} {lang === 'en' ? 'device(s)' : 'appareil(s)'}</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <span className={'px-2 py-1 rounded-full text-xs font-medium ' + style.bg + ' ' + style.text}>{lang === 'en' && style.en ? style.en : style.label}</span>
                      <p className="text-xs text-gray-400 mt-1">{new Date(req.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
                    </div>
                  </div>
                ); 
              })}
            </div>
          )}
          
          {/* === Parts Orders === */}
          {activeTab === 'parts' && (
            <div className="space-y-3">
              {partsOrdersList.length === 0 ? <p className="text-center text-gray-400 py-8">{lang === 'en' ? 'No parts orders' : 'Aucune commande de pi√®ces'}</p> : partsOrdersList.map(po => {
                const poS = { submitted:'Nouvelle', quote_sent:'Devis envoy√©', bc_review:'BC √† v√©rifier', in_progress:'En cours', ready_to_ship:'Pr√™t', shipped:'Exp√©di√©', delivered:'Livr√©', completed:'Termin√©', cancelled:(lang === 'en' ? 'Cancelled' : 'Annul√©e') };
                const parts = po.quote_data?.parts || [];
                const total = po.quote_data?.grandTotal || 0;
                return (
                  <div key={po.id} onClick={() => handleSelectItem(po)} className="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-colors">
                    <div className="flex justify-between items-start">
                      <div>
                        <span className="font-mono font-bold text-amber-600">{po.request_number || '‚Äî'}</span>
                        <p className="text-sm text-gray-600 mt-1">{parts.length} {lang === 'en' ? 'part(s)' : 'pi√®ce(s)'}</p>
                        {po.bc_number && <p className="text-xs text-green-600 font-mono">BC: {po.bc_number}</p>}
                      </div>
                      <div className="text-right">
                        <span className="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">{poS[po.status] || po.status}</span>
                        <p className="text-xs text-gray-400 mt-1">{new Date(po.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
                        {total > 0 && <p className="text-sm font-bold text-gray-700">{total.toFixed(2)} ‚Ç¨</p>}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
          
          {/* === Contracts === */}
          {activeTab === 'contracts' && !selectedContract && (
            <div className="space-y-3">
              {clientContracts.length === 0 ? <p className="text-center text-gray-400 py-8">{lang === 'en' ? 'No contracts' : 'Aucun contrat'}</p> : clientContracts.map(c => (
                <div key={c.id} onClick={() => setSelectedContract(c)} className="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-colors">
                  <div className="flex justify-between items-start">
                    <div>
                      <span className="font-mono font-bold text-purple-600">{c.contract_number || '‚Äî'}</span>
                      <p className="text-sm text-gray-600 mt-1">{c.contract_type || '‚Äî'}</p>
                    </div>
                    <div className="text-right">
                      <span className="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">{c.status}</span>
                      <p className="text-xs text-blue-500 mt-1">{lang === 'en' ? 'View details ‚Üí' : 'Voir d√©tails ‚Üí'}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
          {activeTab === 'contracts' && selectedContract && (
            <div>
              <button onClick={() => setSelectedContract(null)} className="text-sm text-blue-600 hover:underline mb-4">{lang === 'en' ? '‚Üê Back to contracts' : '‚Üê Retour aux contrats'}</button>
              <ContractDetailView lang={lang} 
                contract={selectedContract}
                clients={[client]}
                notify={notify}
                onClose={() => setSelectedContract(null)}
                onUpdate={() => { loadContracts(); setSelectedContract(null); }}
              />
            </div>
          )}
          
          {/* === Locations (Rentals) === */}
          {activeTab === 'rentals' && !selectedRental && (
            <div className="space-y-3">
              {clientRentals.length === 0 ? <p className="text-center text-gray-400 py-8">{lang === 'en' ? 'No rentals' : 'Aucune location'}</p> : clientRentals.map(rental => {
                const rStyles = lang === 'en' ? { requested:'New', quote_sent:'Quote Sent', waiting_bc:'Awaiting PO', bc_review:'PO to Review', bc_approved:'PO Approved', shipped:'Shipped', in_rental:'On Rental', return_pending:'Return Expected', returned:'Returned', completed:'Completed', cancelled:'Cancelled' } : { requested:'Nouvelle', quote_sent:'Devis envoy√©', waiting_bc:'Attente BC', bc_review:'BC √† v√©rifier', bc_approved:'BC approuv√©', shipped:'Exp√©di√©', in_rental:'En location', return_pending:'Retour attendu', returned:'Retourn√©', completed:'Termin√©', cancelled:'Annul√©' };
                const rColors = { requested:'bg-amber-100 text-amber-700', quote_sent:'bg-blue-100 text-blue-700', bc_review:'bg-orange-100 text-orange-700', bc_approved:'bg-green-100 text-green-700', shipped:'bg-cyan-100 text-cyan-700', in_rental:'bg-purple-100 text-purple-700', return_pending:'bg-orange-100 text-orange-700', returned:'bg-teal-100 text-teal-700', completed:'bg-green-100 text-green-700', cancelled:'bg-red-100 text-red-700' };
                const items = rental.rental_request_items || [];
                return (
                  <div key={rental.id} onClick={() => setSelectedRental(rental)} className="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-colors">
                    <div className="flex justify-between items-start">
                      <div>
                        <span className="font-mono font-bold text-purple-600">{rental.rental_number || '‚Äî'}</span>
                        <p className="text-sm text-gray-600 mt-1">{items.length} {lang === 'en' ? 'device(s)' : 'appareil(s)'}</p>
                        {rental.start_date && (
                          <p className="text-xs text-gray-500 mt-0.5">
                            {new Date(rental.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} ‚Üí {rental.end_date ? new Date(rental.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : '‚Äî'}
                          </p>
                        )}
                      </div>
                      <div className="text-right">
                        <span className={'px-2 py-1 rounded-full text-xs font-medium ' + (rColors[rental.status] || 'bg-gray-100 text-gray-700')}>{rStyles[rental.status] || rental.status}</span>
                        <p className="text-xs text-gray-400 mt-1">{new Date(rental.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
                        {(rental.quote_data?.totalHT || rental.quote_total) > 0 && <p className="text-sm font-bold text-gray-700 mt-1">{parseFloat(rental.quote_data?.totalHT || rental.quote_total).toFixed(2)} ‚Ç¨</p>}
                        <p className="text-xs text-blue-500 mt-1">{lang === 'en' ? 'View details ‚Üí' : 'Voir d√©tails ‚Üí'}</p>
                      </div>
                    </div>
                    {items.length > 0 && (
                      <div className="mt-2 pt-2 border-t border-gray-200 flex flex-wrap gap-1">
                        {items.map((item, i) => (
                          <span key={i} className="px-2 py-0.5 bg-white rounded text-xs text-gray-600 border">{item.model_name || item.device_type || item.item_name || '‚Äî'} x{item.quantity || 1}</span>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
          {activeTab === 'rentals' && selectedRental && (
            <RentalFullPage 
              rental={selectedRental} 
              inventory={[]} 
              onBack={() => setSelectedRental(null)} 
              notify={notify} 
              reload={() => { loadRentals(); if (reload) reload(); }} 
              businessSettings={businessSettings || {}} 
              profile={profile || {}} 
              lang={lang} 
            />
          )}
          
          {/* === Sites (Shipping Addresses) === */}
          {activeTab === 'sites' && (
            <div className="space-y-6">
              {/* Billing Addresses */}
              <div>
                <h3 className="font-medium text-[#1E3A5F] mb-3 flex items-center gap-2">üí≥ {lang === 'en' ? 'Billing Addresses' : 'Adresses de facturation'}</h3>
                <div className="space-y-2">
                  {/* Company billing address */}
                  {(client.billing_address || client.billing_city) && (
                    <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="text-xs bg-amber-200 text-amber-800 px-2 py-0.5 rounded-full font-medium">{lang === 'en' ? 'Primary' : 'Principale'}</span>
                      </div>
                      <p className="font-medium">{client.name}</p>
                      <p className="text-sm text-gray-600">{client.billing_address || '‚Äî'}</p>
                      <p className="text-sm text-gray-600">{client.billing_postal_code} {client.billing_city}</p>
                    </div>
                  )}
                  {/* Additional billing addresses from shipping_addresses where is_billing = true */}
                  {clientLocations.filter(loc => loc.is_billing).map(loc => (
                    <div key={loc.id} className="bg-amber-50/50 rounded-lg p-4 border border-amber-100">
                      <p className="font-medium">{loc.label || loc.attention || (lang === 'en' ? 'Billing address' : 'Adresse de facturation')}</p>
                      {loc.attention && loc.label && <p className="text-sm text-gray-500">{loc.attention}</p>}
                      <p className="text-sm text-gray-600">{loc.address_line1}</p>
                      {loc.address_line2 && <p className="text-sm text-gray-600">{loc.address_line2}</p>}
                      <p className="text-sm text-gray-600">{loc.postal_code} {loc.city}</p>
                      {loc.country && loc.country !== 'France' && <p className="text-sm text-gray-500">{loc.country}</p>}
                    </div>
                  ))}
                  {!client.billing_address && !client.billing_city && clientLocations.filter(l => l.is_billing).length === 0 && (
                    <p className="text-gray-400 text-sm py-2">{lang === 'en' ? 'No billing address' : 'Aucune adresse de facturation'}</p>
                  )}
                </div>
              </div>

              {/* Shipping Addresses */}
              <div>
                <h3 className="font-medium text-[#1E3A5F] mb-3 flex items-center gap-2">üì¶ {lang === 'en' ? 'Shipping Addresses' : 'Adresses de livraison'}</h3>
                <div className="space-y-2">
                  {clientLocations.filter(loc => !loc.is_billing).length === 0 ? (
                    <p className="text-gray-400 text-sm py-2">{lang === 'en' ? 'No shipping addresses' : 'Aucune adresse de livraison'}</p>
                  ) : clientLocations.filter(loc => !loc.is_billing).map(loc => (
                    <div key={loc.id} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                      <div className="flex items-center gap-2 mb-1">
                        <p className="font-medium">{loc.label || (lang === 'en' ? 'Site' : 'Site')}</p>
                        {loc.is_default && <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">{lang === 'en' ? 'Default' : 'Par d√©faut'}</span>}
                      </div>
                      {loc.attention && <p className="text-sm text-gray-500">√Ä l'att. de: {loc.attention}</p>}
                      <p className="text-sm text-gray-600">{loc.address_line1}</p>
                      {loc.address_line2 && <p className="text-sm text-gray-600">{loc.address_line2}</p>}
                      <p className="text-sm text-gray-600">{loc.postal_code} {loc.city}</p>
                      {loc.country && loc.country !== 'France' && <p className="text-sm text-gray-500">{loc.country}</p>}
                      {loc.phone && <p className="text-sm text-gray-400 mt-1">üìû {loc.phone}</p>}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
          
          {/* === Devices === */}
          {activeTab === 'devices' && !selectedEquipment && (
            <div className="space-y-3">
              {equipment.length === 0 ? <p className="text-center text-gray-400 py-8">{lang === 'en' ? 'No devices' : 'Aucun appareil'}</p> : equipment.map(eq => { 
                const rmaCount = getDeviceRMAHistory(eq.serial_number).length;
                const isArchived = eq.hidden_by_customer === true;
                return (
                  <div key={eq.id} onClick={() => setSelectedEquipment(eq)} className={`rounded-lg p-4 flex justify-between items-center hover:bg-gray-100 cursor-pointer transition-colors ${isArchived ? 'bg-orange-50 border border-orange-200' : 'bg-gray-50'}`}>
                    <div>
                      <p className="font-medium flex items-center gap-2">
                        {getDeviceImageUrl(eq.model_name) && <img src={getDeviceImageUrl(eq.model_name)} alt="" className="w-5 h-5 object-contain" />}
                        {eq.model_name}
                        {isArchived && <span className="ml-2 text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">{lang === 'en' ? 'üì¶ Archived by client' : 'üì¶ Archiv√© par le client'}</span>}
                      </p>
                      <p className="text-sm text-gray-500">SN: {eq.serial_number}</p>
                    </div>
                    <div className="text-right">
                      <span className="text-sm text-gray-400">{eq.brand}</span>
                      {rmaCount > 0 && <p className="text-xs text-blue-600 mt-1">{rmaCount} RMA(s)</p>}
                    </div>
                  </div>
                ); 
              })}
            </div>
          )}
          
          {activeTab === 'devices' && selectedEquipment && (
            <div className="space-y-4">
              <button onClick={() => setSelectedEquipment(null)} className="text-sm text-blue-600 hover:underline">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
              <div className={`rounded-lg p-4 border ${selectedEquipment.hidden_by_customer ? 'bg-orange-50 border-orange-200' : 'bg-blue-50 border-blue-200'}`}>
                <div className="flex items-center gap-2">
                  <h3 className={`font-bold flex items-center gap-2 ${selectedEquipment.hidden_by_customer ? 'text-orange-800' : 'text-blue-800'}`}>{getDeviceImageUrl(selectedEquipment.model_name) && <img src={getDeviceImageUrl(selectedEquipment.model_name)} alt="" className="w-6 h-6 object-contain" />}{selectedEquipment.model_name}</h3>
                  {selectedEquipment.hidden_by_customer && <span className="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">{lang === 'en' ? 'üì¶ Archived by client' : 'üì¶ Archiv√© par le client'}</span>}
                </div>
                <p className={`text-sm ${selectedEquipment.hidden_by_customer ? 'text-orange-600' : 'text-blue-600'}`}>SN: {selectedEquipment.serial_number}</p>
                {selectedEquipment.brand && <p className="text-sm text-gray-500 mt-1">{selectedEquipment.brand}</p>}
              </div>
              <h4 className="font-medium text-gray-700">{lang === 'en' ? 'RMA History:' : 'Historique RMAs:'}</h4>
              <div className="space-y-3">
                {getDeviceRMAHistory(selectedEquipment.serial_number).map(rma => {
                  const style = STATUS_STYLES[rma.status] || STATUS_STYLES.submitted;
                  return (
                    <div key={rma.id} onClick={() => handleSelectItem(rma)} className="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-colors">
                      <div className="flex justify-between items-start">
                        <span className="font-mono font-bold text-[#00A651]">{rma.request_number}</span>
                        <span className={'px-2 py-1 rounded-full text-xs font-medium ' + style.bg + ' ' + style.text}>{lang === 'en' && style.en ? style.en : style.label}</span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          
          {/* === Info === */}
          {activeTab === 'info' && (
            <div className="space-y-4">
              {editing ? (
                <div className="space-y-4 max-w-lg">
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Name' : 'Nom'}</label><input type="text" value={editData.name} onChange={e => setEditData({...editData, name: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('address')}</label><input type="text" value={editData.billing_address} onChange={e => setEditData({...editData, billing_address: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div>
                  <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Postal code' : 'Code postal'}</label><input type="text" value={editData.billing_postal_code} onChange={e => setEditData({...editData, billing_postal_code: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('city')}</label><input type="text" value={editData.billing_city} onChange={e => setEditData({...editData, billing_city: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'SIRET' : 'SIRET'}</label><input type="text" value={editData.siret} onChange={e => setEditData({...editData, siret: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'VAT #' : 'N¬∞ TVA'}</label><input type="text" value={editData.tva_number} onChange={e => setEditData({...editData, tva_number: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" /></div>
                  </div>
                  <div className="flex gap-2 pt-2">
                    <button onClick={() => setEditing(false)} className="px-4 py-2 bg-gray-200 rounded-lg">{t('cancel')}</button>
                    <button onClick={saveClient} disabled={saving} className="px-4 py-2 bg-[#00A651] text-white rounded-lg disabled:opacity-50">{saving ? '...' : t('save')}</button>
                  </div>
                </div>
              ) : (
                <div className="space-y-4">
                  {isAdmin && <button onClick={() => setEditing(true)} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">{t('edit')}</button>}
                  <div className="grid md:grid-cols-2 gap-4">
                    <div className="bg-gray-50 rounded-lg p-4"><p className="text-sm text-gray-500">{lang === 'en' ? 'Name' : 'Nom'}</p><p className="font-medium">{client.name}</p></div>
                    <div className="bg-gray-50 rounded-lg p-4"><p className="text-sm text-gray-500">{t('address')}</p><p className="font-medium">{client.billing_address || '‚Äî'}</p><p className="text-sm text-gray-600">{client.billing_postal_code} {client.billing_city}</p></div>
                    <div className="bg-gray-50 rounded-lg p-4"><p className="text-sm text-gray-500">{lang === 'en' ? 'SIRET' : 'SIRET'}</p><p className="font-medium">{client.siret || '‚Äî'}</p></div>
                    <div className="bg-gray-50 rounded-lg p-4"><p className="text-sm text-gray-500">{lang === 'en' ? 'VAT #' : 'N¬∞ TVA'}</p><p className="font-medium">{client.tva_number || '‚Äî'}</p></div>
                  </div>
                </div>
              )}
            </div>
          )}
          
          {/* === Contacts === */}
          {activeTab === 'contacts' && (
            <div className="space-y-3">
              {(client.profiles || []).map(contact => {
                const isErased = contact.invitation_status === 'gdpr_erased';
                const isDeactivated = contact.invitation_status === 'deactivated';
                return (
                <div key={contact.id} className={`rounded-lg p-4 flex justify-between items-center ${isErased ? 'bg-red-50 border border-red-100' : isDeactivated ? 'bg-gray-100' : 'bg-gray-50'}`}>
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${isErased ? 'bg-red-200 text-red-600' : isDeactivated ? 'bg-gray-300 text-gray-500' : 'bg-[#1a1a2e] text-white'}`}>
                      {isErased ? 'üóë' : contact.full_name?.charAt(0)?.toUpperCase()}
                    </div>
                    <div>
                      <p className={`font-medium ${isErased || isDeactivated ? 'text-gray-400' : ''}`}>
                        {contact.full_name}
                        {contact.role === 'admin' && <span className="ml-2 text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">Admin</span>}
                        {isErased && <span className="ml-2 text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">RGPD supprim√©</span>}
                        {isDeactivated && <span className="ml-2 text-xs bg-gray-200 text-gray-500 px-2 py-0.5 rounded-full">D√©sactiv√©</span>}
                      </p>
                      <p className={`text-sm ${isErased ? 'text-red-300' : 'text-gray-500'}`}>{contact.email}</p>
                      {contact.phone && !isErased && <p className="text-sm text-gray-400">{contact.phone}</p>}
                      {isErased && contact.gdpr_erased_at && (
                        <p className="text-xs text-red-400 mt-1">Donn√©es anonymis√©es le {new Date(contact.gdpr_erased_at).toLocaleDateString('fr-FR')}</p>
                      )}
                      {!isErased && !isDeactivated && (
                        <div className="flex gap-1 mt-1">
                          {contact.can_view && <span className="text-xs bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded">üëÅÔ∏è</span>}
                          {contact.can_request && <span className="text-xs bg-green-50 text-green-600 px-1.5 py-0.5 rounded">üìã</span>}
                          {contact.can_invoice && <span className="text-xs bg-amber-50 text-amber-600 px-1.5 py-0.5 rounded">üí≥</span>}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
                );
              })}
            </div>
          )}
          
        </div>
      </div>
    </div>
  );
}

// QC Review Modal - View report, certificate, then approve
function QCReviewModal({ device, rma, onBack, notify, profile, lang = 'fr' }) {
  const t = k => k;
  const [saving, setSaving] = useState(false);
  const [step, setStep] = useState(1); // 1: Report, 2: Certificate, 3: Approve
  const [qcNotes, setQcNotes] = useState(device.qc_notes || '');
  const [savedReportUrl, setSavedReportUrl] = useState(device.report_url || null);
  const [showRejectModal, setShowRejectModal] = useState(false);
  const [rejectionReason, setRejectionReason] = useState('');
  const today = new Date().toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR');
  
  // Get checklist from device
  const checklist = device.work_checklist || {};
  const defaultChecklist = [
    { id: 'visual', label: lang === 'en' ? 'Visual inspection performed' : 'Inspection visuelle effectu√©e', checked: checklist.visual !== false },
    { id: 'cleaning', label: lang === 'en' ? 'Cleaning performed' : 'Nettoyage effectu√©', checked: checklist.cleaning !== false },
    { id: 'calibration', label: lang === 'en' ? 'Calibration performed per procedure' : '√âtalonnage r√©alis√© selon proc√©dure', checked: checklist.calibration !== false },
    { id: 'results', label: lang === 'en' ? 'Results within specifications' : 'R√©sultats dans les sp√©cifications', checked: checklist.results !== false },
    { id: 'certificate', label: lang === 'en' ? 'Calibration certificate generated' : 'Certificat d\'√©talonnage g√©n√©r√©', checked: checklist.certificate !== false }
  ];
  
  const serviceTypeText = device.service_type === 'calibration' ? (lang === 'en' ? 'Calibration' : '√âtalonnage') : device.service_type === 'repair' ? (lang === 'en' ? 'Repair' : 'R√©paration') : (lang === 'en' ? 'Calibration and Repair' : '√âtalonnage et R√©paration');
  const motifText = device.notes ? `${serviceTypeText} - ${device.notes}` : serviceTypeText;
  
  const showCalType = device.cal_type && device.cal_type !== 'none';
  const showReceptionResult = device.reception_result && device.reception_result !== 'none';
  
  // Reject QC - send back to tech with notes
  const rejectQC = async () => {
    if (!rejectionReason.trim()) {
      notify(lang === 'en' ? 'Please indicate the rejection reason' : 'Veuillez indiquer la raison du rejet', 'error');
      return;
    }
    setSaving(true);
    try {
      // Delete existing report PDF if any (will be regenerated after fixes)
      if (savedReportUrl) {
        try {
          const path = savedReportUrl.split('/documents/')[1];
          if (path) await supabase.storage.from('documents').remove([path]);
        } catch (e) { console.error('Could not delete old PDF:', e); }
      }
      
      await supabase.from('request_devices').update({
        status: 'qc_rejected',
        qc_rejected: true,
        qc_rejected_at: new Date().toISOString(),
        qc_rejected_by: profile?.id,
        qc_rejection_reason: rejectionReason,
        report_url: null // Clear the report URL since it needs to be redone
      }).eq('id', device.id);
      
      notify(lang === 'en' ? '‚ùå QC rejected - Sent back to technician' : '‚ùå QC rejet√© - Renvoy√© au technicien');
      setShowRejectModal(false);
      onBack();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setSaving(false);
  };
  
  // Save report PDF by capturing the visible preview
  const saveReportPDF = async () => {
    try {
      if (!window.html2canvas) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      
      const element = document.getElementById('qc-report-preview');
      if (!element) { notify('Element not found!', 'error'); return null; }
      
      notify(lang === 'en' ? 'Generating PDF...' : 'G√©n√©ration du PDF...');
      const canvas = await window.html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
      const jsPDF = await loadJsPDF();
      const pdf = new jsPDF('p', 'mm', 'a4');
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pdfWidth = 210;
      const imgRatio = canvas.height / canvas.width;
      const imgHeight = pdfWidth * imgRatio;
      pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, Math.min(imgHeight, 297));
      
      const pdfBlob = pdf.output('blob');
      const safeSerial = (device.serial_number || 'unknown').replace(/[^a-zA-Z0-9-_]/g, '');
      const fileName = `${rma.request_number}_${safeSerial}_rapport_${Date.now()}.pdf`;
      const reportUrl = await uploadPDFToStorage(pdfBlob, `reports/${rma.request_number}`, fileName);
      
      if (reportUrl) {
        await supabase.from('request_devices').update({ report_url: reportUrl }).eq('id', device.id);
        setSavedReportUrl(reportUrl);
        notify(lang === 'en' ? '‚úì PDF report saved!' : '‚úì Rapport PDF enregistr√©!');
        return reportUrl;
      } else {
        notify(lang === 'en' ? 'Upload error' : 'Erreur upload', 'error');
        return null;
      }
    } catch (err) {
      console.error(err);
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
      return null;
    }
  };
  
  const approveQC = async () => {
    setSaving(true);
    try {
      // Always save report PDF by capturing the preview element (always in DOM now)
      let reportUrl = savedReportUrl;
      if (!reportUrl) {
        reportUrl = await saveReportPDF();
      }
      
      const updateData = {
        qc_complete: true,
        qc_completed_at: new Date().toISOString(),
        qc_completed_by: profile?.id,
        qc_notes: qcNotes,
        status: 'ready_to_ship'
      };
      
      if (reportUrl) updateData.report_url = reportUrl;
      
      const { error } = await supabase.from('request_devices').update(updateData).eq('id', device.id);
      if (error) throw error;
      
      const allDevices = rma.request_devices || [];
      const otherDevices = allDevices.filter(d => d.id !== device.id);
      const allOthersReady = otherDevices.every(d => d.qc_complete || d.status === 'ready_to_ship');
      
      if (allOthersReady) {
        await supabase.from('service_requests').update({
          status: 'ready_to_ship',
          updated_at: new Date().toISOString()
        }).eq('id', rma.id);
      }
      
      notify(reportUrl ? (lang === 'en' ? '‚úì QC passed + Report saved!' : '‚úì QC valid√© + Rapport enregistr√©!') : (lang === 'en' ? '‚úì QC passed' : '‚úì QC valid√©'));
      onBack();
    } catch (err) {
      console.error('approveQC error:', err);
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setSaving(false);
  };
  
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg text-gray-600">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
          <div>
            <h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? 'QUALITY CHECK' : 'CONTR√îLE QUALIT√â'}</h1>
            <p className="text-gray-500">{device.model_name} ‚Ä¢ SN: {device.serial_number} ‚Ä¢ {rma.request_number}</p>
          </div>
        </div>
        {device.qc_complete && (
          <span className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-medium">{lang === 'en' ? '‚úì Already validated' : '‚úì D√©j√† valid√©'}</span>
        )}
      </div>
      
      {/* Progress Steps */}
      <div className="bg-white rounded-xl shadow-sm border p-4">
        <div className="flex items-center justify-between">
          <button 
            onClick={() => setStep(1)}
            className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-lg font-medium ${step === 1 ? 'bg-blue-500 text-white' : step > 1 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}
          >
            {step > 1 ? '‚úì' : '1.'} {lang === 'en' ? 'Service Report' : 'Rapport de Service'}
          </button>
          <div className="w-8 h-0.5 bg-gray-300"></div>
          <button 
            onClick={() => setStep(2)}
            className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-lg font-medium ${step === 2 ? 'bg-blue-500 text-white' : step > 2 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}
          >
            {step > 2 ? '‚úì' : '2.'} {lang === 'en' ? 'Certificate' : 'Certificat'}
          </button>
          <div className="w-8 h-0.5 bg-gray-300"></div>
          <button 
            onClick={() => setStep(3)}
            className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-lg font-medium ${step === 3 ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-500'}`}
          >
            3. Validation
          </button>
        </div>
      </div>
      
      {/* Step 1: Service Report - Preview always rendered for PDF capture */}
      <div style={step === 1 ? {} : { position: 'absolute', left: '-9999px', top: 0 }}>
        <div className="space-y-4">
        <div className="bg-gray-400 p-8 min-h-full flex justify-center">
          <div id="qc-report-preview" className="bg-white shadow-2xl w-full max-w-3xl relative" style={{ fontFamily: 'Arial, sans-serif', padding: '40px 50px', minHeight: '297mm', display: 'flex', flexDirection: 'column' }}>
            
            {/* Watermark */}
            <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', opacity: 0.08, pointerEvents: 'none', zIndex: 1 }}>
              <img src="/images/logos/Lighthouse-Square-logo.png" alt="" style={{ width: '400px', height: 'auto' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:120px;font-weight:bold;color:#000">LWS</div>'; }} />
            </div>
            
            {/* Content wrapper - above watermark */}
            <div style={{ position: 'relative', zIndex: 2, display: 'flex', flexDirection: 'column', flex: 1 }}>
            
            {/* Logo */}
            <div className="mb-4">
              <img src="/images/logos/Lighthouse-color-logo.jpg" alt="Lighthouse" className="h-24 w-auto" onError={(e) => { e.target.style.display = 'none'; }} />
              </div>

              {/* Info Table */}
              <table className="w-full text-sm mb-6" style={{ borderCollapse: 'collapse', tableLayout: 'fixed' }}>
                <colgroup>
                  <col style={{ width: '150px' }} />
                  <col style={{ width: '200px' }} />
                  <col />
                </colgroup>
                <tbody>
                  <tr>
                    <td className="py-1 font-bold text-[#003366] whitespace-nowrap">Date d'ach√®vement</td>
                    <td className="py-1 text-gray-800">{device.report_completed_at ? new Date(device.report_completed_at).toLocaleDateString('fr-FR') : today}</td>
                    <td className="py-1 text-gray-800"><span className="font-bold text-[#003366]">RMA # </span>{rma.request_number}</td>
                  </tr>
                  <tr>
                    <td className="py-1 font-bold text-[#003366] whitespace-nowrap">Client</td>
                    <td className="py-1 text-gray-800" colSpan="2">{rma.companies?.name}</td>
                  </tr>
                  <tr>
                    <td className="py-1 font-bold text-[#003366] whitespace-nowrap">Adresse</td>
                    <td className="py-1 text-gray-800" colSpan="2">{rma.companies?.billing_address || '‚Äî'}</td>
                  </tr>
                  <tr>
                    <td className="py-1 font-bold text-[#003366] whitespace-nowrap">Code postal / Ville</td>
                    <td className="py-1 text-gray-800">{rma.companies?.billing_postal_code} {rma.companies?.billing_city}</td>
                    <td className="py-1 text-gray-800"><span className="font-bold text-[#003366]">Contact </span>{rma.companies?.contact_name || '‚Äî'}</td>
                  </tr>
                  <tr>
                    <td className="py-1 font-bold text-[#003366] whitespace-nowrap">T√©l√©phone</td>
                    <td className="py-1 text-gray-800">{rma.companies?.phone || '‚Äî'}</td>
                    <td className="py-1 text-gray-800"><span className="font-bold text-[#003366]">Technicien(ne) de service</span></td>
                  </tr>
                  <tr>
                    <td className="py-1 font-bold text-[#003366] whitespace-nowrap">Mod√®le#</td>
                    <td className="py-1 text-gray-800">{device.model_name}</td>
                    <td className="py-1 text-gray-800">{device.technician_name || 'Lighthouse France'}</td>
                  </tr>
                  <tr>
                    <td className="py-1 font-bold text-[#003366] whitespace-nowrap">Num√©ro de s√©rie</td>
                    <td className="py-1 text-gray-800" colSpan="2">{device.serial_number}</td>
                  </tr>
                </tbody>
              </table>

              {/* Content */}
              <div className="flex-grow">
                <table className="w-full text-sm" style={{ borderCollapse: 'collapse', tableLayout: 'fixed' }}>
                  <colgroup>
                    <col style={{ width: '170px' }} />
                    <col />
                  </colgroup>
                  <tbody>
                    <tr>
                      <td className="pt-6 pb-2 font-bold text-[#003366] whitespace-nowrap align-top">Motif de retour</td>
                      <td className="pt-6 pb-2 text-gray-800">{motifText}</td>
                    </tr>
                    {showCalType && (
                      <tr>
                        <td className="py-2 font-bold text-[#003366] whitespace-nowrap align-top">√âtalonnage effectu√©</td>
                        <td className="py-2 text-gray-800">{device.cal_type}</td>
                      </tr>
                    )}
                    {showReceptionResult && (
                      <tr>
                        <td className="py-2 font-bold text-[#003366] whitespace-nowrap align-top">R√©sultats √† la r√©ception</td>
                        <td className="py-2 text-gray-800">{device.reception_result}</td>
                      </tr>
                    )}
                    <tr>
                      <td className="pt-10 pb-2 font-bold text-[#003366] whitespace-nowrap align-top">Constatations</td>
                      <td className="pt-10 pb-2 text-gray-800 whitespace-pre-wrap">{device.service_findings || '‚Äî'}</td>
                    </tr>
                    <tr>
                      <td className="pt-8 pb-2 font-bold text-[#003366] whitespace-nowrap align-top">Actions effectu√©es</td>
                      <td className="pt-8 pb-2 text-gray-800 whitespace-pre-wrap">{device.work_completed || '‚Äî'}</td>
                    </tr>
                    <tr>
                      <td style={{ paddingTop: '150px' }} className="pb-2 font-bold text-[#003366] whitespace-nowrap align-top">Travaux r√©alis√©s</td>
                      <td style={{ paddingTop: '150px' }} className="pb-2">
                        <div className="space-y-1">
                          {defaultChecklist.filter(item => item.checked).map(item => (
                            <div key={item.id} className="flex items-center gap-2">
                              <span className="text-[#003366]">‚òë</span>
                              <span className="text-gray-800">{item.label}</span>
                            </div>
                          ))}
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              {/* Footer */}
              <div className="text-center text-sm text-gray-600 mt-auto pt-8">
                <p className="font-bold text-[#003366]">Lighthouse Worldwide Solutions France</p>
                <p>16 Rue Paul S√©journ√© 94000 Cr√©teil France</p>
                <p>01 43 77 28 07</p>
              </div>
            </div>
            </div>
          </div>
          
        <div className="flex justify-between items-center">
            <div className="flex items-center gap-3">
              <button 
                onClick={() => setShowRejectModal(true)}
                className="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium"
              >
                ‚ùå Rejeter
              </button>
              <button 
                onClick={saveReportPDF}
                className={`px-6 py-3 rounded-lg font-medium ${savedReportUrl ? 'bg-green-100 text-green-700' : 'bg-green-600 hover:bg-green-700 text-white'}`}
              >
                {savedReportUrl ? (lang === 'en' ? '‚úì Report saved' : '‚úì Rapport enregistr√©') : (lang === 'en' ? 'üíæ Save Report PDF' : 'üíæ Enregistrer le Rapport PDF')}
              </button>
              {savedReportUrl && (
                <a href={savedReportUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline text-sm">{lang === 'en' ? 'üìÑ View PDF' : 'üìÑ Voir PDF'}</a>
              )}
            </div>
            <button onClick={() => setStep(2)} className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
              Rapport OK ‚Üí Voir Certificat
            </button>
          </div>
        </div>
      </div>
      
      {/* Step 2: Certificate */}
      {step === 2 && (
        <div className="space-y-4">
          <div className="bg-white rounded-xl shadow-sm border p-8">
            <div className="text-center mb-6">
              <p className="text-6xl mb-4">üìú</p>
              <h2 className="text-xl font-bold text-gray-800 mb-2">
                {device.service_type === 'repair' ? (lang === 'en' ? 'Repair Documents' : 'Documents de R√©paration') : (lang === 'en' ? 'Calibration Certificate' : 'Certificat d\'√âtalonnage')}
              </h2>
              <p className="text-gray-500">{lang === 'en' ? 'Verify the document is correct and complete' : 'V√©rifiez que le document est correct et complet'}</p>
            </div>
            
            {device.calibration_certificate_url ? (
              <div className="space-y-4">
                {/* PDF Embed */}
                <div className="bg-gray-100 rounded-xl overflow-hidden" style={{ height: '600px' }}>
                  <iframe 
                    src={device.calibration_certificate_url} 
                    className="w-full h-full"
                    title={lang === 'en' ? 'Calibration certificate' : "Certificat d'√©talonnage"}
                  />
                </div>
                <div className="text-center">
                  <a href={device.calibration_certificate_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline text-sm">
                    üìÑ Ouvrir dans un nouvel onglet
                  </a>
                </div>
              </div>
            ) : device.service_type === 'repair' ? (
              <div className="bg-gray-100 rounded-xl p-12 text-center">
                <p className="text-gray-600">{lang === 'en' ? "Repair - no calibration certificate required" : "R√©paration - pas de certificat d'√©talonnage requis"}</p>
                <p className="text-sm text-gray-400 mt-2">{lang === 'en' ? "Check the service report in the previous step" : "V√©rifiez le rapport de service √† l'√©tape pr√©c√©dente"}</p>
              </div>
            ) : (
              <div className="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
                <p className="text-red-600 font-medium">{lang === 'en' ? '‚ö†Ô∏è Certificate not uploaded' : '‚ö†Ô∏è Certificat non t√©l√©charg√©'}</p>
                <p className="text-sm text-red-500 mt-2">{lang === 'en' ? 'Technician must upload certificate before QC validation' : 'Le technicien doit t√©l√©charger le certificat avant validation QC'}</p>
              </div>
            )}
            
            <p className="text-sm text-gray-500 mt-4 text-center">
              {lang === 'en' ? 'Check: Client name, Serial #, Date, Tolerances, Signatures' : 'V√©rifiez: Nom client, N¬∞ s√©rie, Date, Tol√©rances, Signatures'}
            </p>
          </div>
          
          <div className="flex justify-between">
            <div className="flex items-center gap-3">
              <button onClick={() => setStep(1)} className="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
                ‚Üê Retour au Rapport
              </button>
              <button 
                onClick={() => setShowRejectModal(true)}
                className="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium"
              >
                ‚ùå Rejeter
              </button>
            </div>
            <button onClick={() => setStep(3)} className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
              {device.calibration_certificate_url || device.service_type === 'repair' ? (lang === 'en' ? 'Document OK ‚Üí Validation' : 'Document OK ‚Üí Validation') : (lang === 'en' ? 'Continue ‚Üí' : 'Continuer ‚Üí')}
            </button>
          </div>
        </div>
      )}
      
      {/* Step 3: Approve */}
      {step === 3 && (
        <div className="space-y-4">
          <div className="bg-white rounded-xl shadow-sm border p-8">
            <div className="text-center mb-8">
              <p className="text-6xl mb-4">‚úÖ</p>
              <h2 className="text-xl font-bold text-gray-800 mb-2">{lang === 'en' ? 'Final Validation' : 'Validation Finale'}</h2>
              <p className="text-gray-500">{lang === 'en' ? 'Confirm all documents are correct' : 'Confirmez que tous les documents sont corrects'}</p>
            </div>
            
            {/* Summary */}
            <div className="bg-gray-50 rounded-xl p-6 mb-6">
              <h3 className="font-bold text-gray-700 mb-4">{lang === 'en' ? 'Summary' : 'R√©sum√©'}</h3>
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div><span className="text-gray-500">{lang === 'en' ? 'Client:' : 'Client:'}</span> <span className="font-medium">{rma.companies?.name}</span></div>
                <div><span className="text-gray-500">{lang === 'en' ? 'RMA:' : 'RMA:'}</span> <span className="font-medium text-blue-600">{rma.request_number}</span></div>
                <div><span className="text-gray-500">{lang === 'en' ? 'Device:' : 'Appareil:'}</span> <span className="font-medium">{device.model_name}</span></div>
                <div><span className="text-gray-500">{lang === 'en' ? 'Serial #:' : 'N¬∞ S√©rie:'}</span> <span className="font-medium font-mono">{device.serial_number}</span></div>
                <div><span className="text-gray-500">{lang === 'en' ? 'Service:' : 'Service:'}</span> <span className="font-medium">{serviceTypeText}</span></div>
                <div><span className="text-gray-500">{lang === 'en' ? 'Technician:' : 'Technicien:'}</span> <span className="font-medium">{device.technician_name || '‚Äî'}</span></div>
              </div>
            </div>
            
            {/* Notes */}
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'en' ? 'QC notes (optional)' : 'Notes QC (optionnel)'}</label>
              <textarea 
                value={qcNotes}
                onChange={e => setQcNotes(e.target.value)}
                placeholder={lang === 'en' ? 'Remarks or observations...' : 'Remarques ou observations...'}
                className="w-full px-4 py-3 border rounded-xl h-20 resize-none"
              />
            </div>
            
            {/* Checkmarks */}
            <div className="space-y-3 mb-8">
              <div className="flex items-center gap-3 text-green-700">
                <span className="text-xl">‚úì</span>
                <span>{lang === 'en' ? "Service report verified" : "Rapport de service v√©rifi√©"}</span>
              </div>
              <div className="flex items-center gap-3 text-green-700">
                <span className="text-xl">‚úì</span>
                <span>{lang === 'en' ? "Calibration certificate verified" : "Certificat d'√©talonnage v√©rifi√©"}</span>
              </div>
            </div>
          </div>
          
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-3">
              <button onClick={() => setStep(2)} className="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
                ‚Üê Retour
              </button>
              <button 
                onClick={() => setShowRejectModal(true)}
                className="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium"
              >
                ‚ùå Rejeter
              </button>
            </div>
            {!device.qc_complete ? (
              <button 
                onClick={approveQC} 
                disabled={saving}
                className="px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-lg disabled:opacity-50"
              >
                {saving ? (lang === 'en' ? 'Validating...' : 'Validation...') : (lang === 'en' ? "‚úì I approve - Ready for shipment" : "‚úì J'approuve - Pr√™t pour exp√©dition")}
              </button>
            ) : (
              <span className="px-6 py-3 bg-green-100 text-green-700 rounded-lg font-medium">{lang === 'en' ? '‚úì Already validated' : '‚úì D√©j√† valid√©'}</span>
            )}
          </div>
        </div>
      )}
      
      {/* Rejection Modal */}
      {showRejectModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
            <h3 className="text-xl font-bold text-gray-800 mb-4">{lang === 'en' ? '‚ùå Reject Quality Check' : '‚ùå Rejeter le Contr√¥le Qualit√©'}</h3>
            <p className="text-gray-600 mb-4">
              {lang === 'en' ? 'Indicate the reason for rejection. The technician will see these notes and will need to correct the issue.' : 'Indiquez la raison du rejet. Le technicien verra ces notes et devra corriger le probl√®me.'}
            </p>
            <textarea 
              value={rejectionReason}
              onChange={(e) => setRejectionReason(e.target.value)}
              placeholder={lang === 'en' ? 'Describe the issues to fix...' : 'D√©crivez les probl√®mes √† corriger...'}
              className="w-full border rounded-lg p-3 h-32 mb-4"
            />
            <div className="flex justify-end gap-3">
              <button 
                onClick={() => { setShowRejectModal(false); setRejectionReason(''); }}
                className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg"
              >
                Annuler
              </button>
              <button 
                onClick={rejectQC}
                disabled={saving || !rejectionReason.trim()}
                className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg disabled:opacity-50"
              >
                {saving ? (lang === 'en' ? 'Rejecting...' : 'Rejet...') : (lang === 'en' ? 'Confirm Rejection' : 'Confirmer le Rejet')}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================
// CONTRACTS SHEET - Full Implementation
// ============================================
function ContractsSheet({ clients, notify, profile, reloadMain, t = k=>k, lang = 'fr' }) {
  const [contracts, setContracts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedContract, setSelectedContract] = useState(null);
  const [quoteContract, setQuoteContract] = useState(null); // For opening quote editor
  const [reviewingContractBC, setReviewingContractBC] = useState(null); // For BC review modal
  const [filter, setFilter] = useState('all');
  const [showCreateModal, setShowCreateModal] = useState(false);

  const loadContracts = useCallback(async () => {
    setLoading(true);
    const { data, error } = await supabase
      .from('contracts')
      .select('*, companies(*), contract_devices(*)')
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('Error loading contracts:', error);
      notify(lang === 'en' ? 'Error loading contracts' : 'Erreur de chargement des contrats', 'error');
    } else {
      setContracts(data || []);
    }
    setLoading(false);
  }, [notify]);

  useEffect(() => {
    loadContracts();
  }, [loadContracts]);

  const CONTRACT_STATUS_STYLES = {
    requested: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'üÜï New request' : 'üÜï Nouvelle demande' },
    pending_quote_review: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? '‚è≥ Quote Under Review' : '‚è≥ Devis en v√©rification' },
    modification_requested: { bg: 'bg-orange-100', text: 'text-orange-700', label: lang === 'en' ? '‚úèÔ∏è Modification requested' : '‚úèÔ∏è Modification demand√©e' },
    refused: { bg: 'bg-red-100', text: 'text-red-700', label: lang === 'en' ? '‚ùå Rejected' : '‚ùå Refus√©' },
    quote_sent: { bg: 'bg-blue-100', text: 'text-blue-700', label: lang === 'en' ? 'üìß Quote sent' : 'üìß Devis envoy√©' },
    quote_approved: { bg: 'bg-purple-100', text: 'text-purple-700', label: lang === 'en' ? '‚úÖ Quote approved' : '‚úÖ Devis approuv√©' },
    bc_pending: { bg: 'bg-orange-100', text: 'text-orange-700', label: lang === 'en' ? 'üìÑ Awaiting PO' : 'üìÑ Attente BC' },
    active: { bg: 'bg-green-100', text: 'text-green-700', label: lang === 'en' ? '‚úÖ Active' : '‚úÖ Actif' },
    expired: { bg: 'bg-gray-100', text: 'text-gray-600', label: lang === 'en' ? '‚è∞ Expired' : '‚è∞ Expir√©' },
    cancelled: { bg: 'bg-red-100', text: 'text-red-700', label: lang === 'en' ? '‚ùå Cancelled' : '‚ùå Annul√©' }
  };

  const getStatusBadge = (status) => {
    const style = CONTRACT_STATUS_STYLES[status] || CONTRACT_STATUS_STYLES.requested;
    return <span className={`px-2 py-1 rounded-full text-xs font-medium ${style.bg} ${style.text}`}>{lang === 'en' && style.en ? style.en : style.label}</span>;
  };

  // Separate new requests from processed contracts
  // Only 'requested' shows in the new requests queue
  // modification_requested and refused go to processed section
  const newRequests = contracts.filter(c => c.status === 'requested');
  const processedContracts = contracts.filter(c => c.status !== 'requested');
  
  // Filter processed contracts
  const filteredContracts = processedContracts.filter(c => {
    if (filter === 'all') return true;
    if (filter === 'active') return c.status === 'active';
    if (filter === 'pending') return ['pending_quote_review', 'quote_sent', 'quote_approved', 'bc_pending', 'modification_requested', 'refused'].includes(c.status);
    if (filter === 'expired') return c.status === 'expired';
    return true;
  });

  const stats = {
    pending: processedContracts.filter(c => ['pending_quote_review', 'quote_sent', 'quote_approved', 'bc_pending', 'modification_requested', 'refused'].includes(c.status)).length,
    active: processedContracts.filter(c => c.status === 'active').length,
    expired: processedContracts.filter(c => c.status === 'expired').length
  };

  if (loading) {
    return (
      <div className="flex justify-center py-12">
        <div className="w-8 h-8 border-4 border-[#00A651] border-t-transparent rounded-full animate-spin"></div>
      </div>
    );
  }

  // Contract Detail View
  if (selectedContract) {
    return (
      <ContractDetailView lang={lang} 
        contract={selectedContract}
        clients={clients}
        notify={notify}
        onClose={() => setSelectedContract(null)}
        onUpdate={() => { loadContracts(); if (reloadMain) reloadMain(); }}
      />
    );
  }
  
  // Contract Quote Editor
  if (quoteContract) {
    return (
      <ContractQuoteEditor
        contract={quoteContract}
        profile={profile}
        notify={notify}
        onClose={() => setQuoteContract(null)}
        onSent={() => { setQuoteContract(null); loadContracts(); if (reloadMain) reloadMain(); }}
      />
    );
  }
  
  // Contract BC Review Modal - render on top of main view
  const contractBCModal = reviewingContractBC && (
    <ContractBCReviewModal lang={lang} 
      contract={reviewingContractBC}
      onClose={() => setReviewingContractBC(null)}
      notify={notify}
      reload={() => { loadContracts(); if (reloadMain) reloadMain(); }}
    />
  );
  
  // Manual Contract Creation
  if (showCreateModal) {
    return (
      <CreateContractModal
        clients={clients}
        notify={notify}
        onClose={() => setShowCreateModal(false)}
        onCreated={() => { setShowCreateModal(false); loadContracts(); if (reloadMain) reloadMain(); }}
      />
    );
  }

  return (
    <div className="space-y-6">
      {/* BC Review Modal - renders on top */}
      {contractBCModal}
      
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? "Calibration Contracts" : "Contrats d'√âtalonnage"}</h1>
        <button
          onClick={() => setShowCreateModal(true)}
          className="px-4 py-2 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-medium flex items-center gap-2"
        >
          <span>+</span> Cr√©er Contrat Manuellement
        </button>
      </div>
      
      {/* ============================================ */}
      {/* BC √Ä V√âRIFIER - Top Priority */}
      {/* ============================================ */}
      {(() => {
        const bcPendingContracts = contracts.filter(c => c.status === 'bc_pending');
        if (bcPendingContracts.length === 0) return null;
        return (
          <div className="bg-red-50 border-2 border-red-300 rounded-xl shadow-lg">
            <div className="px-6 py-4 border-b border-red-200 bg-red-100 rounded-t-xl">
              <h2 className="font-bold text-red-800 text-lg">{lang === 'en' ? `‚ö†Ô∏è Contract POs to Review (${bcPendingContracts.length})` : `‚ö†Ô∏è BC Contrats √† V√©rifier (${bcPendingContracts.length})`}</h2>
              <p className="text-sm text-red-600">{lang === 'en' ? 'Review PO and activate contract' : 'V√©rifiez le BC et activez le contrat'}</p>
            </div>
            <div className="p-4 space-y-3">
              {bcPendingContracts.map(contract => (
                <div key={contract.id} className="bg-white rounded-lg p-4 flex items-center justify-between shadow-sm border border-red-100">
                  <div className="flex items-center gap-4">
                    <div className="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">üìÑ</div>
                    <div>
                      <span className="font-mono font-bold text-[#00A651]">{contract.contract_number}</span>
                      <p className="font-medium text-gray-800">{contract.companies?.name || contract.company_name_manual}</p>
                      <p className="text-sm text-gray-500">
                        BC soumis le {contract.bc_submitted_at ? new Date(contract.bc_submitted_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : '‚Äî'}
                        {contract.bc_signed_by && <span className="ml-2">‚Ä¢ {lang === 'en' ? 'Signed by' : 'Sign√© par'}: {contract.bc_signed_by}</span>}
                      </p>
                    </div>
                  </div>
                  <button
                    onClick={() => setReviewingContractBC(contract)}
                    className="px-6 py-3 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-bold"
                  >
                    üìã V√©rifier BC & Activer
                  </button>
                </div>
              ))}
            </div>
          </div>
        );
      })()}
      
      {/* ============================================ */}
      {/* NOUVELLES DEMANDES DE CONTRAT - Top Priority */}
      {/* ============================================ */}
      {newRequests.length > 0 && (
        <div className="bg-amber-50 border-2 border-amber-300 rounded-xl shadow-lg">
          <div className="px-6 py-4 border-b border-amber-200 bg-amber-100 rounded-t-xl">
            <h2 className="font-bold text-amber-800 text-lg">üÜï Nouvelles Demandes de Contrat ({newRequests.length})</h2>
            <p className="text-sm text-amber-600">{lang === 'en' ? 'Click "Create Contract Quote" to prepare the quote' : 'Cliquez sur "Cr√©er Devis Contrat" pour √©tablir le devis'}</p>
          </div>
          <div className="p-4 space-y-3">
            {newRequests.map(contract => {
              const devices = contract.contract_devices || [];
              return (
                <div key={contract.id} className={`bg-white rounded-lg p-4 flex items-center justify-between shadow-sm border ${contract.quote_rejection_notes ? 'border-amber-300 bg-amber-50/50' : 'border-amber-100'}`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-2xl ${contract.quote_rejection_notes ? 'bg-amber-200' : 'bg-amber-100'}`}>{contract.quote_rejection_notes ? '‚úèÔ∏è' : 'üìã'}</div>
                    <div>
                      <p className="font-medium text-gray-800">{contract.companies?.name || 'Client'}</p>
                      <p className="text-sm text-gray-500">
                        {devices.length} {lang === 'en' ? 'device(s) ‚Ä¢ Requested on' : 'appareil(s) ‚Ä¢ Demand√© le'} {new Date(contract.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                      </p>
                      <p className="text-xs text-gray-400">
                        {lang === 'en' ? 'Desired period:' : 'P√©riode souhait√©e:'} {new Date(contract.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} - {new Date(contract.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                      </p>
                      {contract.quote_rejection_notes && (
                        <div className="mt-1 px-2 py-1 bg-amber-100 border border-amber-200 rounded text-xs text-amber-800">
                          ‚úèÔ∏è <strong>{lang === 'en' ? 'Correction:' : 'Correction :'}</strong> {contract.quote_rejection_notes}
                        </div>
                      )}
                    </div>
                  </div>
                  <button
                    onClick={() => setQuoteContract(contract)}
                    className={`px-4 py-2 ${contract.quote_rejection_notes ? 'bg-amber-500 hover:bg-amber-600' : 'bg-[#00A651] hover:bg-[#008f45]'} text-white rounded-lg font-medium`}
                  >
                    {contract.quote_rejection_notes ? '‚úèÔ∏è Corriger Devis' : 'üí∞ Cr√©er Devis Contrat'}
                  </button>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Stats Cards */}
      <div className="grid grid-cols-4 gap-4">
        <div 
          onClick={() => setFilter('pending')}
          className={`bg-white rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-shadow ${filter === 'pending' ? 'ring-2 ring-blue-400' : ''}`}
        >
          <div className="text-3xl font-bold text-blue-600">{stats.pending}</div>
          <div className="text-sm text-gray-600">{lang === 'en' ? 'In progress' : 'En cours'}</div>
        </div>
        <div 
          onClick={() => setFilter('active')}
          className={`bg-white rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-shadow ${filter === 'active' ? 'ring-2 ring-green-400' : ''}`}
        >
          <div className="text-3xl font-bold text-green-600">{stats.active}</div>
          <div className="text-sm text-gray-600">{lang === 'en' ? 'Active' : 'Actifs'}</div>
        </div>
        <div 
          onClick={() => setFilter('expired')}
          className={`bg-white rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-shadow ${filter === 'expired' ? 'ring-2 ring-gray-400' : ''}`}
        >
          <div className="text-3xl font-bold text-gray-600">{stats.expired}</div>
          <div className="text-sm text-gray-600">{lang === 'en' ? 'Expired' : 'Expir√©s'}</div>
        </div>
        <div 
          onClick={() => setFilter('all')}
          className={`bg-white rounded-lg p-4 shadow-sm cursor-pointer hover:shadow-md transition-shadow ${filter === 'all' ? 'ring-2 ring-purple-400' : ''}`}
        >
          <div className="text-3xl font-bold text-purple-600">{processedContracts.length}</div>
          <div className="text-sm text-gray-600">{t('total')}</div>
        </div>
      </div>

      {/* Contracts Table */}
      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        <div className="px-6 py-4 border-b flex justify-between items-center">
          <h2 className="font-bold text-gray-800">
            {filter === 'all' ? (lang === 'en' ? 'All contracts' : 'Tous les contrats') : 
             filter === 'pending' ? (lang === 'en' ? 'In progress' : 'En cours de traitement') :
             filter === 'active' ? (lang === 'en' ? 'Active contracts' : 'Contrats actifs') : (lang === 'en' ? 'Expired contracts' : 'Contrats expir√©s')}
          </h2>
          {filter !== 'all' && (
            <button onClick={() => setFilter('all')} className="text-sm text-gray-500 hover:text-gray-700">
              {lang === 'en' ? 'View all' : 'Voir tout'}
            </button>
          )}
        </div>
        
        {filteredContracts.length === 0 ? (
          <div className="p-8 text-center text-gray-400">
            <p className="text-4xl mb-2">üìÑ</p>
            <p>{lang === 'en' ? 'No contracts found' : 'Aucun contrat trouv√©'}</p>
          </div>
        ) : (
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600">{lang === 'en' ? 'Contract #' : 'N¬∞ Contrat'}</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600">{t('client')}</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600">{lang === 'en' ? 'Period' : 'P√©riode'}</th>
                <th className="px-6 py-3 text-center text-xs font-bold text-gray-600">{t('devices')}</th>
                <th className="px-6 py-3 text-center text-xs font-bold text-gray-600">{lang === 'en' ? 'Tokens' : 'Tokens'}</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600">{t('status')}</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600">{t('actions')}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {filteredContracts.map(contract => {
                const devices = contract.contract_devices || [];
                const totalTokens = devices.reduce((sum, d) => sum + (d.tokens_total || 0), 0);
                const usedTokens = devices.reduce((sum, d) => sum + (d.tokens_used || 0), 0);
                
                return (
                  <tr key={contract.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4">
                      <span className="font-mono font-bold text-[#2D5A7B]">{contract.contract_number || '‚Äî'}</span>
                    </td>
                    <td className="px-6 py-4">
                      <div className="font-medium">{contract.companies?.name || contract.company_name_manual || 'N/A'}</div>
                    </td>
                    <td className="px-6 py-4 text-sm">
                      {new Date(contract.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} - {new Date(contract.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                    </td>
                    <td className="px-6 py-4 text-center">
                      <span className="font-bold">{devices.length}</span>
                    </td>
                    <td className="px-6 py-4 text-center">
                      <span className={`font-bold ${usedTokens >= totalTokens ? 'text-red-600' : 'text-green-600'}`}>
                        {totalTokens - usedTokens}/{totalTokens}
                      </span>
                    </td>
                    <td className="px-6 py-4">{getStatusBadge(contract.status)}</td>
                    <td className="px-6 py-4">
                      <button
                        onClick={() => setSelectedContract(contract)}
                        className="px-3 py-1 bg-[#3B7AB4] text-white text-sm rounded hover:bg-[#2D5A7B]"
                      >
                        Voir
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}


// ============================================
// CONTRACT QUOTE EDITOR - Matches RMA Quote Style
// ============================================
function ContractQuoteEditor({ contract, profile, notify, onClose, onSent, lang = 'fr' }) {
  const t = k => k;
  const [step, setStep] = useState(1); // 1=Edit, 2=Preview, 3=Confirm
  const [saving, setSaving] = useState(false);
  const [quoteRef, setQuoteRef] = useState('');
  const today = new Date();
  
  const signatory = profile?.full_name || 'Lighthouse France';
  
  // Contract dates
  const [contractDates, setContractDates] = useState({
    start_date: contract.start_date || new Date().toISOString().split('T')[0],
    end_date: contract.end_date || new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0]
  });
  
  // Shipping data (same as RMA)
  const [shippingData, setShippingData] = useState({
    parcels: 1,
    unitPrice: 45,
    total: 45,
    partNumber: '1200199-1'
  });
  
  // Initialize pricing for each device - matching RMA structure
  const [devicePricing, setDevicePricing] = useState(
    (contract.contract_devices || []).map(d => {
      const isParticleCounter = (d.device_type || 'particle_counter') === 'particle_counter';
      return {
        id: d.id,
        serial: d.serial_number,
        model: d.model_name || '',
        deviceType: d.device_type || 'particle_counter',
        tokens_total: d.tokens_total || 1,
        needsCalibration: true,
        calibrationPrice: d.unit_price || 350,
        calibrationQty: 1,
        needsNettoyage: isParticleCounter,
        nettoyagePrice: isParticleCounter ? 150 : 0,
        nettoyageQty: 1,
        additionalParts: [],
        isContractCovered: false
      };
    })
  );

  useEffect(() => {
    const year = today.getFullYear().toString().slice(-2);
    const month = String(today.getMonth() + 1).padStart(2, '0');
    setQuoteRef(`CTR/${year}${month}/XXX`);
  }, []);

  // Update shipping total when parcels change
  useEffect(() => {
    setShippingData(prev => ({ ...prev, total: prev.parcels * prev.unitPrice }));
  }, [shippingData.parcels]);

  const updateDevice = (id, field, value) => {
    setDevicePricing(prev => prev.map(d => d.id === id ? { ...d, [field]: value } : d));
  };

  // Calculate totals like RMA
  const getDeviceTotal = (d) => {
    let total = 0;
    if (d.needsCalibration) total += (d.calibrationQty || 1) * (d.calibrationPrice || 0);
    if (d.needsNettoyage) total += (d.nettoyageQty || 1) * (d.nettoyagePrice || 0);
    return total;
  };
  
  const servicesSubtotal = devicePricing.reduce((sum, d) => sum + getDeviceTotal(d), 0);
  const shippingTotal = shippingData.total;
  const grandTotal = servicesSubtotal + shippingTotal;
  const totalTokens = devicePricing.reduce((sum, d) => sum + (parseInt(d.tokens_total) || 0), 0);
  const hasNettoyage = devicePricing.some(d => d.needsNettoyage && d.nettoyagePrice > 0);

  const getDeviceTypeLabel = (type) => {
    const labels = {
      particle_counter: lang === 'en' ? 'Airborne Particle Counter' : 'Compteur Particules A√©roport√©es',
      bio_collector: lang === 'en' ? 'Bio Collector' : 'Bio Collecteur',
      liquid_counter: lang === 'en' ? 'Liquid Particle Counter' : 'Compteur Particules Liquide',
      temp_humidity: lang === 'en' ? 'Temp/Humidity Sensor' : 'Capteur Temp/Humidit√©',
      other: lang === 'en' ? 'Other Equipment' : 'Autre √âquipement'
    };
    return labels[type] || type;
  };

  const sendQuote = async () => {
    setSaving(true);
    try {
      // Generate contract number if not exists
      let contractNumber = contract.contract_number;
      if (!contractNumber) {
        // Try to use database function first
        try {
          const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'CTR' });
          if (!docNumError && docNumData) {
            contractNumber = docNumData;
          }
        } catch (e) {
          console.error('Could not use get_next_doc_number for CTR:', e);
        }
        
        // Fallback to old method if function doesn't exist
        if (!contractNumber) {
          const year = new Date().getFullYear();
          const { data: existing } = await supabase
            .from('contracts')
            .select('contract_number')
            .like('contract_number', `CTR-${year}-%`)
            .order('contract_number', { ascending: false })
            .limit(1);
          const lastNum = existing?.[0]?.contract_number 
            ? parseInt(existing[0].contract_number.split('-')[2]) 
            : 0;
          contractNumber = `CTR-${year}-${String(lastNum + 1).padStart(3, '0')}`;
        }
      }

      // Build quote_data in same format as RMA
      const quoteData = {
        devices: devicePricing.map(d => ({
          id: d.id,
          serial: d.serial,
          model: d.model,
          deviceType: d.deviceType,
          tokens_total: d.tokens_total,
          needsCalibration: d.needsCalibration,
          calibrationPrice: d.calibrationPrice,
          calibrationQty: d.calibrationQty || 1,
          needsNettoyage: d.needsNettoyage,
          nettoyagePrice: d.nettoyagePrice,
          nettoyageQty: d.nettoyageQty || 1,
          additionalParts: d.additionalParts || [],
          isContractCovered: false
        })),
        shipping: shippingData,
        servicesSubtotal: servicesSubtotal,
        shippingTotal: shippingTotal,
        grandTotal: grandTotal,
        totalTokens: totalTokens,
        contractDates: contractDates,
        createdBy: signatory,
        createdAt: new Date().toISOString()
      };

      // Save quote data to contract (but don't send yet)
      await supabase.from('contracts').update({
        contract_number: contractNumber,
        start_date: contractDates.start_date,
        end_date: contractDates.end_date,
        quote_subtotal: servicesSubtotal,
        quote_shipping: shippingTotal,
        quote_total: grandTotal,
        quote_data: quoteData
      }).eq('id', contract.id);

      // Update device pricing in contract_devices
      for (const d of devicePricing) {
        await supabase.from('contract_devices').update({
          tokens_total: d.tokens_total,
          unit_price: d.calibrationPrice
        }).eq('id', d.id);
      }

      // === QUOTE REVIEW: Submit for review ===
      const deviceSummary = devicePricing.map(d => `${d.model} (${d.serial})`).join(', ');
      const previousStatus = contract.status || 'draft';
      
      const { data: review, error: reviewError } = await supabase
        .from('quote_reviews')
        .insert({
          contract_id: contract.id,
          quote_type: 'contract',
          quote_data: { ...quoteData, contractNumber, contractId: contract.id },
          quote_number: contractNumber,
          rma_number: contractNumber,
          client_name: contract.companies?.name || contract.client_name || 'Client inconnu',
          total_amount: grandTotal,
          device_summary: deviceSummary,
          submitted_by: profile?.id,
          submitted_by_name: profile?.full_name || profile?.email || 'Unknown',
          previous_status: previousStatus
        })
        .select()
        .single();
      
      if (reviewError) throw reviewError;
      
      // Set contract to pending review
      await supabase.from('contracts').update({
        status: 'pending_quote_review',
        quote_review_id: review.id,
        quote_rejection_notes: null
      }).eq('id', contract.id);

      notify(lang === 'en' ? `‚úÖ Contract quote submitted for review! # ${contractNumber}` : `‚úÖ Devis contrat envoy√© en v√©rification! N¬∞ ${contractNumber}`);
      onSent();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setSaving(false);
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <button onClick={onClose} className="text-gray-500 hover:text-gray-700">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
        <h1 className="text-2xl font-bold text-gray-800">{contract.quote_rejection_notes ? (lang === 'en' ? '‚úèÔ∏è Correct Contract Quote' : '‚úèÔ∏è Corriger Devis Contrat') : (lang === 'en' ? 'Create Contract Quote' : 'Cr√©er Devis Contrat')}</h1>
        <div className="flex gap-1 ml-4">
          {[1,2,3].map(s => (
            <div key={s} className={`w-8 h-2 rounded-full ${step >= s ? 'bg-[#00A651]' : 'bg-gray-300'}`} />
          ))}
        </div>
      </div>

      {/* Correction notes from reviewer */}
      {contract.quote_rejection_notes && (
        <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4">
          <div className="flex items-center gap-3 mb-2">
            <span className="text-lg">‚úèÔ∏è</span>
            <span className="font-bold text-amber-800">{lang === 'en' ? 'Reviewer requested correction' : 'Le v√©rificateur demande une correction'}</span>
          </div>
          <div className="ml-9 bg-white rounded-lg p-3 border border-amber-200">
            <p className="text-amber-900">{contract.quote_rejection_notes}</p>
          </div>
        </div>
      )}

      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        {/* Header */}
        <div className="px-6 py-4 bg-[#1a1a2e] text-white flex justify-between items-center">
          <div>
            <h2 className="text-xl font-bold">
              {step === 1 && (lang === 'en' ? 'Contract Pricing' : 'Tarification du Contrat')}
              {step === 2 && (lang === 'en' ? 'Quote Preview' : 'Aper√ßu du Devis')}
              {step === 3 && (lang === 'en' ? 'Confirm send' : "Confirmer l'envoi")}
            </h2>
            <p className="text-gray-300">{contract.companies?.name} ‚Ä¢ {devicePricing.length} {lang === 'en' ? 'device(s)' : 'appareil(s)'}</p>
          </div>
          <div className="text-right">
            <p className="text-xs text-gray-400">{t('totalHT')}</p>
            <p className="text-2xl font-bold text-[#00A651]">{grandTotal.toFixed(2)} ‚Ç¨</p>
          </div>
        </div>

        {/* Step 1: Pricing - RMA Style */}
        {step === 1 && (
          <div className="p-6 space-y-6">
            {/* Client Info - Full Details */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div className="flex justify-between items-start">
                <div>
                  <p className="text-xs text-blue-600 uppercase font-medium">{t('client')}</p>
                  <p className="font-bold text-xl text-[#1a1a2e]">{contract.companies?.name}</p>
                  {contract.companies?.contact_name && (
                    <p className="text-gray-600">Contact: {contract.companies.contact_name}</p>
                  )}
                  {(contract.companies?.billing_address || contract.companies?.address) && (
                    <p className="text-gray-600 text-sm">{contract.companies.billing_address || contract.companies.address}</p>
                  )}
                  {(contract.companies?.billing_postal_code || contract.companies?.postal_code || contract.companies?.billing_city || contract.companies?.city) && (
                    <p className="text-gray-600 text-sm">
                      {contract.companies?.billing_postal_code || contract.companies?.postal_code} {contract.companies?.billing_city || contract.companies?.city}
                    </p>
                  )}
                  {contract.companies?.phone && (
                    <p className="text-gray-600 text-sm">{lang === 'en' ? 'Tel' : 'T√©l'}: {contract.companies.phone}</p>
                  )}
                  {contract.companies?.email && (
                    <p className="text-gray-600 text-sm">{contract.companies.email}</p>
                  )}
                </div>
                <div className="text-right">
                  <p className="text-xs text-gray-500">{lang === 'en' ? 'Requested on' : 'Demand√© le'}</p>
                  <p className="font-medium">{new Date(contract.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
                </div>
              </div>
            </div>

            {/* Contract Dates */}
            <div className="grid md:grid-cols-2 gap-4">
              <div className="bg-gray-50 rounded-lg p-4">
                <label className="text-sm text-gray-500 block mb-1">{lang === 'en' ? 'Contract start date' : 'Date d√©but contrat'}</label>
                <input
                  type="date"
                  value={contractDates.start_date}
                  onChange={e => setContractDates({...contractDates, start_date: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
              <div className="bg-gray-50 rounded-lg p-4">
                <label className="text-sm text-gray-500 block mb-1">{lang === 'en' ? 'Contract end date' : 'Date fin contrat'}</label>
                <input
                  type="date"
                  value={contractDates.end_date}
                  onChange={e => setContractDates({...contractDates, end_date: e.target.value})}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
            </div>

            {/* Devices Pricing - RMA Style with Nettoyage */}
            <div>
              <h3 className="font-bold text-gray-800 mb-4">{lang === 'en' ? 'Pricing by Device' : 'Tarification par Appareil'}</h3>
              <div className="space-y-4">
                {devicePricing.map((device, index) => (
                  <div key={device.id} className="bg-gray-50 rounded-lg p-4 border">
                    {/* Device Header */}
                    <div className="flex items-center gap-3 mb-4 pb-3 border-b">
                      <span className="bg-[#1a1a2e] text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">{index + 1}</span>
                      <div>
                        <p className="font-bold">{device.model || (lang === 'en' ? 'Device' : 'Appareil')}</p>
                        <p className="text-sm text-gray-500">SN: {device.serial} ‚Ä¢ {getDeviceTypeLabel(device.deviceType)}</p>
                      </div>
                      <div className="ml-auto text-right">
                        <p className="text-xs text-gray-500">{t('subtotal')}</p>
                        <p className="font-bold text-[#00A651]">{getDeviceTotal(device).toFixed(2)} ‚Ç¨</p>
                      </div>
                    </div>

                    {/* Calibration Row */}
                    <div className="grid grid-cols-4 gap-4 items-center mb-3">
                      <div className="col-span-2">
                        <label className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={device.needsCalibration}
                            onChange={e => updateDevice(device.id, 'needsCalibration', e.target.checked)}
                            className="w-4 h-4"
                          />
                          <span className="font-medium">{t('calibration')}</span>
                        </label>
                      </div>
                      <div>
                        <label className="text-xs text-gray-500">{lang === 'en' ? 'Qty/yr' : 'Qt√©/an'}</label>
                        <input
                          type="number"
                          value={device.tokens_total}
                          onChange={e => {
                            updateDevice(device.id, 'tokens_total', parseInt(e.target.value) || 1);
                            updateDevice(device.id, 'calibrationQty', parseInt(e.target.value) || 1);
                          }}
                          className="w-full px-3 py-2 border rounded-lg"
                          min="1"
                          disabled={!device.needsCalibration}
                        />
                      </div>
                      <div>
                        <label className="text-xs text-gray-500">{lang === 'en' ? 'Price ‚Ç¨ excl. VAT' : 'Prix ‚Ç¨ HT'}</label>
                        <input
                          type="number"
                          value={device.calibrationPrice}
                          onChange={e => updateDevice(device.id, 'calibrationPrice', parseFloat(e.target.value) || 0)}
                          className="w-full px-3 py-2 border rounded-lg"
                          min="0"
                          step="0.01"
                          disabled={!device.needsCalibration}
                        />
                      </div>
                    </div>

                    {/* Nettoyage Row - Only for particle counters */}
                    {device.deviceType === 'particle_counter' && (
                      <div className="grid grid-cols-4 gap-4 items-center bg-amber-50 rounded-lg p-3 -mx-1">
                        <div className="col-span-2">
                          <label className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={device.needsNettoyage}
                              onChange={e => updateDevice(device.id, 'needsNettoyage', e.target.checked)}
                              className="w-4 h-4"
                            />
                            <span className="font-medium text-amber-800">{lang === 'en' ? 'Cell cleaning' : 'Nettoyage cellule'}</span>
                            <span className="text-xs text-amber-600">{lang === 'en' ? '(if required based on condition)' : '(si requis selon √©tat)'}</span>
                          </label>
                        </div>
                        <div>
                          <input
                            type="number"
                            value={device.nettoyageQty}
                            onChange={e => updateDevice(device.id, 'nettoyageQty', parseInt(e.target.value) || 1)}
                            className="w-full px-3 py-2 border rounded-lg bg-white"
                            min="1"
                            disabled={!device.needsNettoyage}
                          />
                        </div>
                        <div>
                          <input
                            type="number"
                            value={device.nettoyagePrice}
                            onChange={e => updateDevice(device.id, 'nettoyagePrice', parseFloat(e.target.value) || 0)}
                            className="w-full px-3 py-2 border rounded-lg bg-white"
                            min="0"
                            step="0.01"
                            disabled={!device.needsNettoyage}
                          />
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>

            {/* Shipping - Same as RMA */}
            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
              <h3 className="font-bold text-blue-800 mb-3">{lang === 'en' ? 'üì¶ Shipping Fees' : 'üì¶ Frais de Port'}</h3>
              <div className="grid grid-cols-4 gap-4 items-center">
                <div className="col-span-2">
                  <p className="text-sm text-blue-700">{lang === 'en' ? 'Round-trip shipping mainland France' : 'Transport aller-retour France m√©tropolitaine'}</p>
                </div>
                <div>
                  <label className="text-xs text-gray-500">{lang === 'en' ? 'Nb parcels' : 'Nb colis'}</label>
                  <input
                    type="number"
                    value={shippingData.parcels}
                    onChange={e => setShippingData({...shippingData, parcels: parseInt(e.target.value) || 1})}
                    className="w-full px-3 py-2 border rounded-lg"
                    min="1"
                  />
                </div>
                <div>
                  <label className="text-xs text-gray-500">{lang === 'en' ? 'Price/parcel' : 'Prix/colis'}</label>
                  <input
                    type="number"
                    value={shippingData.unitPrice}
                    onChange={e => setShippingData({...shippingData, unitPrice: parseFloat(e.target.value) || 0})}
                    className="w-full px-3 py-2 border rounded-lg"
                    min="0"
                    step="0.01"
                  />
                </div>
              </div>
              <div className="text-right mt-2">
                <span className="text-blue-800 font-bold">{shippingTotal.toFixed(2)} ‚Ç¨ HT</span>
              </div>
            </div>

            {/* Grand Total Summary */}
            <div className="bg-emerald-50 rounded-lg p-4 border border-emerald-200">
              <div className="flex justify-between items-center">
                <div>
                  <span className="text-emerald-800 font-medium">{devicePricing.length} {lang === 'en' ? 'device(s)' : 'appareil(s)'}</span>
                  <span className="text-emerald-600 mx-3">‚Ä¢</span>
                  <span className="text-emerald-800">{totalTokens} {lang === 'en' ? 'calibration(s)/yr' : '√©talonnage(s)/an'}</span>
                  {hasNettoyage && (
                    <>
                      <span className="text-emerald-600 mx-3">‚Ä¢</span>
                      <span className="text-amber-700">{lang === 'en' ? '+ Cleaning' : '+ Nettoyage'}</span>
                    </>
                  )}
                </div>
                <div className="text-right">
                  <p className="text-sm text-emerald-600">{t('totalHT')}</p>
                  <p className="text-2xl font-bold text-emerald-800">{grandTotal.toFixed(2)} ‚Ç¨</p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Step 2: Preview - Multi-Page A4 Layout */}
        {step === 2 && (() => {
          // Get unique device types for service description blocks
          const deviceTypes = [...new Set(devicePricing.map(d => d.deviceType))];
          
          // Service description templates
          const CAL_TEMPLATES = {
            particle_counter: {
              title: "√âtalonnage Compteur de Particules A√©roport√©es",
              icon: "üî¨",
              prestations: [
                "V√©rification des fonctionnalit√©s du compteur",
                "V√©rification et r√©glage du d√©bit",
                "V√©rification de la cellule de mesure",
                "Contr√¥le et r√©glage des seuils granulom√©triques √† l'aide de sph√®res de latex calibr√©es",
                "V√©rification en nombre par comparaison √† un √©talon ISO 17025 / ISO 21501-4",
                "Fourniture d'un rapport de test et de calibration"
              ]
            },
            bio_collector: {
              title: "√âtalonnage Bio Collecteur",
              icon: "üß´",
              prestations: [
                "V√©rification des fonctionnalit√©s de l'appareil",
                "V√©rification et r√©glage du d√©bit",
                "V√©rification de la cellule d'impaction",
                "Contr√¥le des param√®tres de collecte",
                "Fourniture d'un rapport de test et de calibration"
              ]
            },
            liquid_counter: {
              title: "√âtalonnage Compteur Particules Liquide",
              icon: "üíß",
              prestations: [
                "V√©rification des fonctionnalit√©s du compteur",
                "V√©rification et r√©glage du d√©bit",
                "V√©rification de la cellule de mesure optique",
                "Contr√¥le et r√©glage des seuils granulom√©triques",
                "V√©rification en nombre par comparaison √† un √©talon",
                "Fourniture d'un rapport de test et de calibration"
              ]
            },
            temp_humidity: {
              title: "√âtalonnage Capteur Temp√©rature/Humidit√©",
              icon: "üå°Ô∏è",
              prestations: [
                "V√©rification des fonctionnalit√©s du capteur",
                "√âtalonnage temp√©rature sur points de r√©f√©rence certifi√©s",
                "√âtalonnage humidit√© relative",
                "V√©rification de la stabilit√© des mesures",
                "Fourniture d'un certificat d'√©talonnage"
              ]
            },
            other: {
              title: "√âtalonnage √âquipement",
              icon: "üì¶",
              prestations: [
                "V√©rification des fonctionnalit√©s de l'appareil",
                "√âtalonnage selon les sp√©cifications du fabricant",
                "Tests de fonctionnement",
                "Fourniture d'un rapport de test"
              ]
            }
          };

          // Build content blocks for pagination
          const contentBlocks = [];
          
          // Block: Client Info - Full details
          contentBlocks.push({
            type: 'client',
            height: 100,
            render: () => (
              <div className="px-6 py-4 mt-2 border-b">
                <p className="text-xs text-gray-500 uppercase">{t('client')}</p>
                <p className="font-bold text-lg text-[#1a1a2e]">{contract.companies?.name}</p>
                {contract.companies?.contact_name && (
                  <p className="text-gray-700 text-sm">√Ä l'attention de: {contract.companies.contact_name}</p>
                )}
                {(contract.companies?.billing_address || contract.companies?.address) && (
                  <p className="text-gray-600 text-sm">{contract.companies.billing_address || contract.companies.address}</p>
                )}
                {(contract.companies?.billing_postal_code || contract.companies?.postal_code || contract.companies?.billing_city || contract.companies?.city) && (
                  <p className="text-gray-600 text-sm">
                    {contract.companies?.billing_postal_code || contract.companies?.postal_code} {contract.companies?.billing_city || contract.companies?.city}
                  </p>
                )}
                {contract.companies?.country && (
                  <p className="text-gray-600 text-sm">{contract.companies.country}</p>
                )}
                {contract.companies?.phone && (
                  <p className="text-gray-600 text-sm">{lang === 'en' ? 'Tel' : 'T√©l'}: {contract.companies.phone}</p>
                )}
                {contract.companies?.email && (
                  <p className="text-gray-600 text-sm">{contract.companies.email}</p>
                )}
              </div>
            )
          });

          // Block: Service descriptions
          deviceTypes.forEach(type => {
            const template = CAL_TEMPLATES[type] || CAL_TEMPLATES.particle_counter;
            contentBlocks.push({
              type: 'service',
              deviceType: type,
              height: 120,
              render: () => (
                <div className="px-6 py-3 border-b">
                  <div className="flex items-start gap-2">
                    <div className="w-1 bg-blue-500 self-stretch rounded" style={{minHeight: '80px'}}></div>
                    <div className="flex-1">
                      <h3 className="font-bold text-[#1a1a2e] mb-1 text-sm flex items-center gap-2">
                        <span>{template.icon}</span>
                        {template.title}
                      </h3>
                      <ul className="text-xs text-gray-600 space-y-0.5">
                        {template.prestations.map((p, i) => (
                          <li key={i} className="flex items-start gap-1">
                            <span className="text-gray-400">-</span>
                            <span>{p}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  </div>
                </div>
              )
            });
          });

          // Block: Combined Conditions (standard + contract)
          contentBlocks.push({
            type: 'conditions',
            height: 80,
            render: () => (
              <div className="px-6 py-3 border-b bg-gray-50">
                <p className="text-xs text-gray-500 uppercase mb-1">{lang === 'en' ? 'Terms' : 'Conditions'}</p>
                <ul className="text-xs text-gray-600 space-y-0.5">
                  <li>‚Ä¢ P√©riode du contrat: {new Date(contractDates.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} au {new Date(contractDates.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</li>
                  <li>‚Ä¢ {lang === 'en' ? `${totalTokens} calibration(s) included during the contract period` : `${totalTokens} √©talonnage(s) inclus pendant la p√©riode contractuelle`}</li>
                  <li>{lang === 'en' ? '‚Ä¢ Additional calibrations billed at standard rate' : '‚Ä¢ √âtalonnages suppl√©mentaires factur√©s au tarif standard'}</li>
                  <li>{lang === 'en' ? "‚Ä¢ This offer does not include repair or replacement of non-consumable parts" : "‚Ä¢ Cette offre n'inclut pas la r√©paration ou l'√©change de pi√®ces non consommables"}</li>
                  <li>{lang === 'en' ? '‚Ä¢ A supplementary quote will be issued if defective parts are found' : '‚Ä¢ Un devis compl√©mentaire sera √©tabli si des pi√®ces sont trouv√©es d√©fectueuses'}</li>
                  <li>{lang === 'en' ? '‚Ä¢ Payment 30 days from invoice date' : '‚Ä¢ Paiement √† 30 jours date de facture'}</li>
                </ul>
              </div>
            )
          });

          // Block: Table header
          contentBlocks.push({
            type: 'table_header',
            height: 45,
            render: () => (
              <div className="px-6 pt-4">
                <h3 className="font-bold text-[#1a1a2e] mb-2 text-sm">{lang === 'en' ? 'Price Summary' : 'R√©capitulatif des Prix'}</h3>
                <table className="w-full">
                  <thead>
                    <tr className="bg-[#1a1a2e] text-white">
                      <th className="px-3 py-2 text-left text-xs font-bold w-12">{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
                      <th className="px-3 py-2 text-left text-xs font-bold">{lang === 'en' ? 'Description' : 'D√©signation'}</th>
                      <th className="px-3 py-2 text-right text-xs font-bold w-20">{lang === 'en' ? 'Unit Price' : 'Prix Unit.'}</th>
                      <th className="px-3 py-2 text-right text-xs font-bold w-20">{t('totalHT')}</th>
                    </tr>
                  </thead>
                </table>
              </div>
            )
          });

          // Block: Device rows (each device + its nettoyage as one block)
          devicePricing.forEach((device, idx) => {
            contentBlocks.push({
              type: 'device',
              device: device,
              index: idx,
              height: device.needsNettoyage && device.nettoyagePrice > 0 ? 60 : 32,
              render: () => (
                <div className="px-6">
                  <table className="w-full">
                    <tbody>
                      {device.needsCalibration && (
                        <tr className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                          <td className="px-3 py-2 text-center text-sm w-12">{device.tokens_total}</td>
                          <td className="px-3 py-2 text-sm">
                            <span className="font-medium">{lang === 'en' ? 'Calibration' : '√âtalonnage'} {device.model}</span>
                            <span className="text-gray-500 text-xs ml-1">(SN: {device.serial})</span>
                          </td>
                          <td className="px-3 py-2 text-right text-sm w-20">{device.calibrationPrice.toFixed(2)} ‚Ç¨</td>
                          <td className="px-3 py-2 text-right text-sm font-medium w-20">{(device.tokens_total * device.calibrationPrice).toFixed(2)} ‚Ç¨</td>
                        </tr>
                      )}
                      {device.needsNettoyage && device.nettoyagePrice > 0 && (
                        <tr className="bg-amber-50">
                          <td className="px-3 py-2 text-center text-sm w-12">{device.nettoyageQty}</td>
                          <td className="px-3 py-2 text-sm">
                            <span className="font-medium text-amber-800">{lang === 'en' ? 'Cell cleaning' : 'Nettoyage cellule'}</span>
                            <span className="text-amber-600 text-xs ml-1">- si requis ({device.model})</span>
                          </td>
                          <td className="px-3 py-2 text-right text-sm w-20">{device.nettoyagePrice.toFixed(2)} ‚Ç¨</td>
                          <td className="px-3 py-2 text-right text-sm font-medium w-20">{(device.nettoyageQty * device.nettoyagePrice).toFixed(2)} ‚Ç¨</td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              )
            });
          });

          // Block: Shipping
          contentBlocks.push({
            type: 'shipping',
            height: 32,
            render: () => (
              <div className="px-6">
                <table className="w-full">
                  <tbody>
                    <tr className="bg-blue-50">
                      <td className="px-3 py-2 text-center text-sm w-12">{shippingData.parcels}</td>
                      <td className="px-3 py-2 text-sm">
                        <span className="font-medium text-blue-800">{lang === 'en' ? 'Shipping fees' : 'Frais de port'}</span>
                        <span className="text-blue-600 text-xs ml-1">({shippingData.parcels} colis)</span>
                      </td>
                      <td className="px-3 py-2 text-right text-sm w-20">{shippingData.unitPrice.toFixed(2)} ‚Ç¨</td>
                      <td className="px-3 py-2 text-right text-sm font-medium w-20">{shippingTotal.toFixed(2)} ‚Ç¨</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            )
          });

          // Block: Total
          contentBlocks.push({
            type: 'total',
            height: 35,
            render: () => (
              <div className="px-6 pb-4">
                <table className="w-full">
                  <tbody>
                    <tr className="bg-[#00A651] text-white">
                      <td className="px-3 py-2 w-12"></td>
                      <td className="px-3 py-2"></td>
                      <td className="px-3 py-2 text-right font-bold text-sm w-20">{lang === 'en' ? 'TOTAL excl. VAT' : 'TOTAL HT'}</td>
                      <td className="px-3 py-2 text-right font-bold text-sm w-20">{grandTotal.toFixed(2)} ‚Ç¨</td>
                    </tr>
                  </tbody>
                </table>
                {hasNettoyage && (
                  <p className="mt-2 text-xs text-amber-700 bg-amber-50 p-2 rounded">
                    * Le nettoyage sera effectu√© si n√©cessaire selon l'√©tat du capteur.
                  </p>
                )}
              </div>
            )
          });

          // Block: Signature (always last) - with larger Capcert logo
          contentBlocks.push({
            type: 'signature',
            height: 120,
            alwaysLast: true,
            render: () => (
              <div className="px-6 py-6 border-t">
                <div className="flex justify-between items-end">
                  <div className="flex items-end gap-6">
                    <div>
                      <p className="text-xs text-gray-500 uppercase mb-1">{lang === 'en' ? 'Prepared by' : '√âtabli par'}</p>
                      <p className="font-bold text-lg">{signatory}</p>
                      <p className="text-gray-500 text-sm">Lighthouse France</p>
                    </div>
                    <img 
                      src="/images/logos/capcert-logo.png" 
                      alt="Capcert" 
                      className="h-24 w-auto"
                      onError={(e) => { e.target.style.display = 'none'; }}
                    />
                  </div>
                  <div className="text-center">
                    <p className="text-xs text-gray-500 uppercase mb-1">{lang === 'en' ? 'Approved for agreement' : 'Bon pour accord'}</p>
                    <div className="w-44 h-16 border-2 border-dashed border-gray-300 rounded"></div>
                    <p className="text-xs text-gray-400 mt-1">{lang === 'en' ? 'Signature and stamp' : 'Signature et cachet'}</p>
                  </div>
                </div>
              </div>
            )
          });

          // Paginate content - A4 page height ~1050px usable (excluding header/footer)
          const PAGE_CONTENT_HEIGHT = 680; // px available per page for content
          const pages = [];
          let currentPage = { blocks: [], usedHeight: 0 };
          
          // Separate signature block (always goes last)
          const signatureBlock = contentBlocks.find(b => b.type === 'signature');
          const otherBlocks = contentBlocks.filter(b => b.type !== 'signature');
          
          otherBlocks.forEach(block => {
            if (currentPage.usedHeight + block.height > PAGE_CONTENT_HEIGHT) {
              // Start new page
              pages.push(currentPage);
              currentPage = { blocks: [], usedHeight: 0 };
            }
            currentPage.blocks.push(block);
            currentPage.usedHeight += block.height;
          });
          
          // Add signature to last page (or new page if no room)
          if (signatureBlock) {
            if (currentPage.usedHeight + signatureBlock.height > PAGE_CONTENT_HEIGHT) {
              pages.push(currentPage);
              currentPage = { blocks: [signatureBlock], usedHeight: signatureBlock.height };
            } else {
              currentPage.blocks.push(signatureBlock);
            }
          }
          pages.push(currentPage);
          
          const totalPages = pages.length;

          // Page Header Component - with more spacing after
          const PageHeader = ({ pageNum }) => (
            <div className="border-b-4 border-[#00A651] mb-4">
              <div className="px-6 py-4 flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <img 
                    src="/images/logos/Lighthouse-color-logo.jpg" 
                    alt="Lighthouse" 
                    className="h-24 w-auto"
                    onError={(e) => {
                      e.target.style.display = 'none';
                      e.target.nextSibling.style.display = 'block';
                    }}
                  />
                  <div className="hidden">
                    <span className="text-xl font-bold text-[#1a1a2e]">LIGHTHOUSE</span>
                  </div>
                </div>
                <div className="text-right">
                  <p className="text-lg font-bold text-[#00A651]">{lang === 'en' ? 'CONTRACT QUOTE' : 'DEVIS CONTRAT'}</p>
                  <p className="text-sm font-bold text-[#2D5A7B]">N¬∞ {contract.contract_number || (lang === 'en' ? '(Generated on send)' : "(G√©n√©r√© √† l'envoi)")}</p>
                </div>
              </div>
              {pageNum === 1 && (
                <div className="bg-gray-100 px-6 py-2 flex justify-between text-xs border-t">
                  <div>
                    <span className="text-gray-500">{lang === 'en' ? 'Date: ' : 'Date: '}</span>
                    <span className="font-medium">{today.toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</span>
                  </div>
                  <div>
                    <span className="text-gray-500">{lang === 'en' ? 'Period: ' : 'P√©riode: '}</span>
                    <span className="font-medium">{new Date(contractDates.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} - {new Date(contractDates.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</span>
                  </div>
                  <div>
                    <span className="text-gray-500">{lang === 'en' ? 'Validity: ' : 'Validit√©: '}</span>
                    <span className="font-medium">{lang === 'en' ? '30 days' : '30 jours'}</span>
                  </div>
                </div>
              )}
            </div>
          );

          // Page Footer Component - centered
          const PageFooter = ({ pageNum, totalPages }) => (
            <div className="bg-[#1a1a2e] text-white px-6 py-3 text-center text-xs">
              <p>Lighthouse France SAS ‚Ä¢ 16, rue Paul S√©journ√© ‚Ä¢ 94000 CR√âTEIL ‚Ä¢ T√©l. 01 43 77 28 07</p>
              <p className="font-medium mt-1">Page {pageNum}/{totalPages}</p>
            </div>
          );

          return (
            <div className="p-6 bg-gray-300 min-h-full">
              <div className="space-y-8">
                {pages.map((page, pageIdx) => (
                  <div 
                    key={pageIdx} 
                    className="bg-white shadow-xl mx-auto"
                    style={{ 
                      width: '210mm', 
                      minHeight: '297mm',
                      display: 'flex',
                      flexDirection: 'column'
                    }}
                  >
                    {/* Page Header */}
                    <PageHeader pageNum={pageIdx + 1} />
                    
                    {/* Page Content */}
                    <div className="flex-1">
                      {page.blocks.map((block, blockIdx) => (
                        <div key={blockIdx}>
                          {block.render()}
                        </div>
                      ))}
                    </div>
                    
                    {/* Page Footer */}
                    <PageFooter pageNum={pageIdx + 1} totalPages={totalPages} />
                  </div>
                ))}
              </div>
            </div>
          );
        })()}

        {/* Step 3: Confirm */}
        {step === 3 && (
          <div className="p-6 text-center">
            <div className="max-w-md mx-auto">
              <p className="text-6xl mb-4">üìß</p>
              <h3 className="text-xl font-bold text-gray-800 mb-2">{lang === 'en' ? 'Ready to send' : 'Pr√™t √† envoyer'}</h3>
              <p className="text-gray-600 mb-6">
                {lang === 'en' ? `The contract quote will be sent to client ${contract.companies?.name}.` : `Le devis de contrat sera envoy√© au client ${contract.companies?.name}.`}
                <br />{lang === 'en' ? 'Total amount: ' : 'Montant total: '}<strong className="text-[#00A651]">{grandTotal.toFixed(2)} ‚Ç¨ HT</strong>
              </p>
              <div className="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                <p className="text-sm text-gray-600">
                  <strong>{lang === 'en' ? 'Period:' : 'P√©riode:'}</strong> {new Date(contractDates.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} - {new Date(contractDates.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                </p>
                <p className="text-sm text-gray-600">
                  <strong>{lang === 'en' ? 'Devices:' : 'Appareils:'}</strong> {devicePricing.length}
                </p>
                <p className="text-sm text-gray-600">
                  <strong>{lang === 'en' ? 'Calibrations included:' : '√âtalonnages inclus:'}</strong> {totalTokens}
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Footer Actions */}
        <div className="px-6 py-4 bg-gray-50 border-t flex justify-between">
          <div className="flex gap-2">
            {step > 1 && (
              <button
                onClick={() => setStep(step - 1)}
                className="px-4 py-2 text-gray-600 hover:text-gray-800"
              >
                ‚Üê Retour
              </button>
            )}
            {step === 1 && (
              <>
                {/* Refuse/Modification/Delete buttons only on step 1 */}
                <button
                  onClick={async () => {
                    const reason = window.prompt(lang === 'en' ? 'Reason for modification request:\n(This message will be visible to the client)' : 'Raison de la demande de modification:\n(Ce message sera visible par le client)');
                    if (reason && reason.trim()) {
                      setSaving(true);
                      try {
                        const { error } = await supabase.from('contracts').update({
                          status: 'modification_requested',
                          admin_notes: reason.trim(),
                          updated_at: new Date().toISOString()
                        }).eq('id', contract.id);
                        
                        if (error) throw error;
                        
                        notify(lang === 'en' ? '‚úÖ Modification request sent to client' : '‚úÖ Demande de modification envoy√©e au client', 'success');
                        if (onSent) onSent();
                        onClose();
                      } catch (err) {
                        console.error('Error updating contract:', err);
                        notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
                      }
                      setSaving(false);
                    }
                  }}
                  disabled={saving}
                  className="px-3 py-2 border border-amber-500 text-amber-600 rounded-lg hover:bg-amber-50 text-sm"
                >
                  ‚úèÔ∏è Demander modif
                </button>
                <button
                  onClick={async () => {
                    const reason = window.prompt(lang === 'en' ? 'Reason for rejection:\n(This message will be visible to the client)' : 'Raison du refus:\n(Ce message sera visible par le client)');
                    if (reason && reason.trim()) {
                      setSaving(true);
                      try {
                        const { error } = await supabase.from('contracts').update({
                          status: 'refused',
                          admin_notes: reason.trim(),
                          updated_at: new Date().toISOString()
                        }).eq('id', contract.id);
                        
                        if (error) throw error;
                        
                        notify(lang === 'en' ? '‚ùå Contract request declined' : '‚ùå Demande de contrat refus√©e', 'success');
                        if (onSent) onSent();
                        onClose();
                      } catch (err) {
                        console.error('Error updating contract:', err);
                        notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
                      }
                      setSaving(false);
                    }
                  }}
                  disabled={saving}
                  className="px-3 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 text-sm"
                >
                  ‚ùå Refuser
                </button>
                <button
                  onClick={async () => {
                    const confirmation = window.prompt(lang === 'en' ? '‚ö†Ô∏è DELETE this contract request?\n\nType "DELETE" to confirm:' : '‚ö†Ô∏è SUPPRIMER cette demande de contrat?\n\nTapez "SUPPRIMER" pour confirmer:');
                    if (confirmation === (lang === 'en' ? 'DELETE' : 'SUPPRIMER')) {
                      setSaving(true);
                      try {
                        // Get contract device IDs
                        const { data: contractDevices } = await supabase
                          .from('contract_devices')
                          .select('id')
                          .eq('contract_id', contract.id);
                        
                        const contractDeviceIds = (contractDevices || []).map(d => d.id);
                        
                        // Clear references
                        if (contractDeviceIds.length > 0) {
                          await supabase
                            .from('request_devices')
                            .update({ contract_device_id: null })
                            .in('contract_device_id', contractDeviceIds);
                        }
                        await supabase
                          .from('service_requests')
                          .update({ contract_id: null })
                          .eq('contract_id', contract.id);
                        
                        // Delete devices and contract
                        await supabase.from('contract_devices').delete().eq('contract_id', contract.id);
                        const { error } = await supabase.from('contracts').delete().eq('id', contract.id);
                        
                        if (error) throw error;
                        
                        notify(lang === 'en' ? 'üóëÔ∏è Request deleted' : 'üóëÔ∏è Demande supprim√©e', 'success');
                        if (onSent) onSent();
                        onClose();
                      } catch (err) {
                        console.error('Error deleting contract:', err);
                        notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
                      }
                      setSaving(false);
                    }
                  }}
                  disabled={saving}
                  className="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm"
                >
                  üóëÔ∏è Supprimer
                </button>
              </>
            )}
          </div>
          
          <div className="flex gap-3">
            <button onClick={onClose} className="px-4 py-2 text-gray-600 hover:text-gray-800">
              Annuler
            </button>
            {step < 3 && (
              <button
                onClick={() => setStep(step + 1)}
                className="px-6 py-2 bg-[#00A651] text-white rounded-lg font-medium hover:bg-[#008f45]"
              >
                {step === 1 ? (lang === 'en' ? 'Preview ‚Üí' : 'Aper√ßu ‚Üí') : 'Confirmer ‚Üí'}
              </button>
            )}
            {step === 3 && (
              <button
                onClick={sendQuote}
                disabled={saving}
                className="px-6 py-2 bg-[#00A651] text-white rounded-lg font-medium hover:bg-[#008f45] disabled:opacity-50"
              >
                {saving ? (lang === 'en' ? 'Sending...' : 'Envoi...') : (lang === 'en' ? '‚úÖ Send Quote' : '‚úÖ Envoyer le Devis')}
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


// ============================================
// CONTRACT DETAIL VIEW
// ============================================
function ContractDetailView({ contract, clients, notify, onClose, onUpdate, lang = 'fr' }) {
  const t = k => k;
  const [editMode, setEditMode] = useState(contract.status === 'requested');
  const [saving, setSaving] = useState(false);
  const [devices, setDevices] = useState(contract.contract_devices || []);
  const [contractData, setContractData] = useState({
    start_date: contract.start_date || new Date().toISOString().split('T')[0],
    end_date: contract.end_date || new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
    internal_notes: contract.internal_notes || ''
  });
  const [showQuoteModal, setShowQuoteModal] = useState(false);

  // Check for existing active contracts for this client
  const [existingContracts, setExistingContracts] = useState([]);
  
  useEffect(() => {
    const checkExisting = async () => {
      if (!contract.company_id) return;
      const { data } = await supabase
        .from('contracts')
        .select('id, contract_number, start_date, end_date, status')
        .eq('company_id', contract.company_id)
        .eq('status', 'active')
        .neq('id', contract.id);
      setExistingContracts(data || []);
    };
    checkExisting();
  }, [contract.company_id, contract.id]);

  const updateDevice = (deviceId, field, value) => {
    setDevices(devices.map(d => d.id === deviceId ? { ...d, [field]: value } : d));
  };

  const saveDeviceChanges = async () => {
    setSaving(true);
    try {
      // Update contract dates and notes
      const { error: contractError } = await supabase
        .from('contracts')
        .update({
          start_date: contractData.start_date,
          end_date: contractData.end_date,
          internal_notes: contractData.internal_notes
        })
        .eq('id', contract.id);

      if (contractError) throw contractError;

      // Update each device
      for (const device of devices) {
        const { error } = await supabase
          .from('contract_devices')
          .update({
            tokens_total: device.tokens_total,
            unit_price: device.unit_price
          })
          .eq('id', device.id);
        
        if (error) throw error;
      }

      notify(lang === 'en' ? 'Changes saved' : 'Modifications enregistr√©es', 'success');
      setEditMode(false);
      onUpdate();
    } catch (err) {
      console.error('Error saving:', err);
      notify(lang === 'en' ? 'Error saving' : 'Erreur lors de la sauvegarde', 'error');
    } finally {
      setSaving(false);
    }
  };

  const updateContractStatus = async (newStatus) => {
    setSaving(true);
    try {
      const updates = { status: newStatus };
      
      if (newStatus === 'active') {
        updates.bc_approved_at = new Date().toISOString();
      }

      const { error } = await supabase
        .from('contracts')
        .update(updates)
        .eq('id', contract.id);

      if (error) throw error;

      notify(lang === 'en' ? `Status updated: ${newStatus}` : `Statut mis √† jour: ${newStatus}`, 'success');
      onUpdate();
      onClose();
    } catch (err) {
      console.error('Error updating status:', err);
      notify(lang === 'en' ? 'Error updating' : 'Erreur lors de la mise √† jour', 'error');
    } finally {
      setSaving(false);
    }
  };

  const totalPrice = devices.reduce((sum, d) => sum + (parseFloat(d.unit_price) || 0), 0);
  const totalTokens = devices.reduce((sum, d) => sum + (parseInt(d.tokens_total) || 0), 0);

  const CONTRACT_STATUS_STYLES = {
    requested: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'üÜï New request' : 'üÜï Nouvelle demande' },
    pending_quote_review: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? '‚è≥ Quote Under Review' : '‚è≥ Devis en v√©rification' },
    quote_sent: { bg: 'bg-blue-100', text: 'text-blue-700', label: lang === 'en' ? 'üìß Quote sent' : 'üìß Devis envoy√©' },
    quote_approved: { bg: 'bg-purple-100', text: 'text-purple-700', label: lang === 'en' ? '‚úÖ Quote approved' : '‚úÖ Devis approuv√©' },
    bc_pending: { bg: 'bg-orange-100', text: 'text-orange-700', label: lang === 'en' ? 'üìÑ Awaiting PO' : 'üìÑ Attente BC' },
    active: { bg: 'bg-green-100', text: 'text-green-700', label: lang === 'en' ? '‚úÖ Active' : '‚úÖ Actif' },
    expired: { bg: 'bg-gray-100', text: 'text-gray-600', label: lang === 'en' ? '‚è∞ Expired' : '‚è∞ Expir√©' },
    cancelled: { bg: 'bg-red-100', text: 'text-red-700', label: lang === 'en' ? '‚ùå Cancelled' : '‚ùå Annul√©' }
  };

  const getStatusBadge = (status) => {
    const style = CONTRACT_STATUS_STYLES[status] || CONTRACT_STATUS_STYLES.requested;
    return (
      <span className={`px-3 py-1 rounded-full text-sm font-medium ${style.bg} ${style.text}`}>
        {lang === 'en' && style.en ? style.en : style.label}
      </span>
    );
  };

  return (
    <div className="space-y-6">
      <button 
        onClick={onClose}
        className="text-gray-500 hover:text-gray-700 flex items-center gap-2"
      >
        ‚Üê Retour aux contrats
      </button>

      {/* Warning for existing active contracts */}
      {existingContracts.length > 0 && (
        <div className="bg-amber-50 border-l-4 border-amber-400 p-4 rounded">
          <div className="flex items-start gap-3">
            <span className="text-2xl">‚ö†Ô∏è</span>
            <div>
              <h3 className="font-bold text-amber-800">{lang === 'en' ? "Existing contract detected" : "Contrat existant d√©tect√©"}</h3>
              <p className="text-sm text-amber-700">
                {lang === 'en' ? `This client already has ${existingContracts.length} active contract(s):` : `Ce client a d√©j√† ${existingContracts.length} contrat(s) actif(s):`}
              </p>
              <ul className="text-sm text-amber-700 mt-1">
                {existingContracts.map(c => (
                  <li key={c.id}>‚Ä¢ {c.contract_number} ({new Date(c.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} - {new Date(c.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')})</li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      )}

      {/* BC REVIEW SECTION - Shows when client has submitted BC */}
      {contract.status === 'bc_pending' && (
        <div className="bg-orange-50 border-2 border-orange-300 rounded-xl p-6">
          <div className="flex items-start gap-4 mb-4">
            <div className="w-14 h-14 bg-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
              <span className="text-white text-2xl">üìÑ</span>
            </div>
            <div>
              <h2 className="text-xl font-bold text-orange-800">{lang === 'en' ? 'Purchase Order to Review' : 'Bon de Commande √† V√©rifier'}</h2>
              <p className="text-orange-700">
                {lang === 'en' ? 'Client submitted their purchase order. Review documents and activate the contract.' : 'Le client a soumis son bon de commande. V√©rifiez les documents et activez le contrat.'}
              </p>
              {contract.bc_submitted_at && (
                <p className="text-sm text-orange-600 mt-1">
                  {lang === 'en' ? 'Submitted on' : 'Soumis le'} {new Date(contract.bc_submitted_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} √† {new Date(contract.bc_submitted_at).toLocaleTimeString(lang === 'en' ? 'en-US' : 'fr-FR', { hour: '2-digit', minute: '2-digit' })}
                  {contract.bc_signed_by && ` par ${contract.bc_signed_by}`}
                </p>
              )}
            </div>
          </div>
          
          {/* Documents */}
          <div className="grid md:grid-cols-2 gap-4 mb-4">
            {/* Signed Quote PDF */}
            {contract.signed_quote_url && (
              <div className="bg-white rounded-lg p-4 border border-green-200">
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <span className="text-green-600">‚úÖ</span>
                  </div>
                  <div>
                    <p className="font-bold text-green-800">{lang === 'en' ? 'Signed Quote' : 'Devis Sign√©'}</p>
                    <p className="text-xs text-green-600">{lang === 'en' ? 'PDF with client signature' : 'PDF avec signature client'}</p>
                  </div>
                </div>
                <a
                  href={contract.signed_quote_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="block w-full px-4 py-2 bg-green-600 text-white rounded-lg text-center font-medium hover:bg-green-700"
                >
                  üì• Voir le Devis Sign√©
                </a>
              </div>
            )}
            
            {/* BC File */}
            {contract.bc_file_url && (
              <div className="bg-white rounded-lg p-4 border border-purple-200">
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                    <span className="text-purple-600">üìã</span>
                  </div>
                  <div>
                    <p className="font-bold text-purple-800">{t('purchaseOrder')}</p>
                    <p className="text-xs text-purple-600">{lang === 'en' ? "Document uploaded by client" : "Document upload√© par le client"}</p>
                  </div>
                </div>
                <a
                  href={contract.bc_file_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="block w-full px-4 py-2 bg-purple-600 text-white rounded-lg text-center font-medium hover:bg-purple-700"
                >
                  üì• Voir le BC
                </a>
              </div>
            )}
            
            {/* No documents */}
            {!contract.signed_quote_url && !contract.bc_file_url && (
              <div className="col-span-2 bg-white rounded-lg p-4 border border-gray-200 text-center text-gray-500">
                <p>{lang === 'en' ? 'No document attached' : 'Aucun document attach√©'} (signature √©lectronique uniquement)</p>
              </div>
            )}
          </div>
          
          {/* Action Buttons */}
          <div className="flex gap-3">
            <button
              onClick={() => updateContractStatus('active')}
              disabled={saving}
              className="flex-1 px-6 py-3 bg-[#00A651] text-white rounded-lg font-bold hover:bg-[#008c44] disabled:opacity-50"
            >
              ‚úÖ Approuver et Activer le Contrat
            </button>
            <button
              onClick={() => {
                const reason = window.prompt(lang === 'en' ? 'Reason for rejection:' : 'Raison du rejet:');
                if (reason) {
                  // Update with rejection
                  supabase.from('contracts').update({
                    status: 'bc_rejected',
                    bc_rejection_reason: reason
                  }).eq('id', contract.id).then(() => {
                    notify(lang === 'en' ? 'PO rejected' : 'BC rejet√©', 'success');
                    onUpdate();
                  });
                }
              }}
              disabled={saving}
              className="px-6 py-3 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 disabled:opacity-50"
            >
              ‚ùå Rejeter
            </button>
          </div>
        </div>
      )}

      {/* Header */}
      <div className="bg-white rounded-xl shadow-sm p-6">
        <div className="flex justify-between items-start mb-4">
          <div>
            <h1 className="text-2xl font-bold text-[#2D5A7B]">
              Contrat {contract.contract_number || (lang === 'en' ? '(Pending)' : '(En attente)')}
            </h1>
            <p className="text-gray-600">{contract.companies?.name}</p>
          </div>
          {getStatusBadge(contract.status)}
        </div>

        {/* Correction notes from reviewer */}
        {contract.quote_rejection_notes && contract.status === 'requested' && (
          <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4 mb-4">
            <div className="flex items-center gap-3 mb-2">
              <span className="text-lg">‚úèÔ∏è</span>
              <span className="font-bold text-amber-800">{lang === 'en' ? 'Reviewer requested correction' : 'Le v√©rificateur demande une correction'}</span>
            </div>
            <div className="ml-9 bg-white rounded-lg p-3 border border-amber-200">
              <p className="text-amber-900">{contract.quote_rejection_notes}</p>
            </div>
          </div>
        )}

        {/* Contract Period */}
        <div className="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">{lang === 'en' ? 'Start date' : 'Date de d√©but'}</label>
            {editMode ? (
              <input
                type="date"
                value={contractData.start_date}
                onChange={e => setContractData({...contractData, start_date: e.target.value})}
                className="w-full px-3 py-2 border rounded-lg"
              />
            ) : (
              <p className="text-gray-900">{new Date(contract.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">{lang === 'en' ? 'End date' : 'Date de fin'}</label>
            {editMode ? (
              <input
                type="date"
                value={contractData.end_date}
                onChange={e => setContractData({...contractData, end_date: e.target.value})}
                className="w-full px-3 py-2 border rounded-lg"
              />
            ) : (
              <p className="text-gray-900">{new Date(contract.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">{lang === 'en' ? 'Duration' : 'Dur√©e'}</label>
            <p className="text-gray-900">
              {Math.round((new Date(contractData.end_date) - new Date(contractData.start_date)) / (1000 * 60 * 60 * 24 * 30))} mois
            </p>
          </div>
        </div>

        {/* Customer Notes */}
        {contract.customer_notes && (
          <div className="mb-4 p-3 bg-blue-50 rounded-lg">
            <h4 className="font-bold text-blue-800 text-sm mb-1">{lang === 'en' ? 'Client notes:' : 'Notes du client:'}</h4>
            <p className="text-sm text-blue-700">{contract.customer_notes}</p>
          </div>
        )}

        {/* Internal Notes */}
        <div className="mb-4">
          <label className="block text-sm font-bold text-gray-700 mb-1">{lang === 'en' ? 'Internal notes' : 'Notes internes'}</label>
          {editMode ? (
            <textarea
              value={contractData.internal_notes}
              onChange={e => setContractData({...contractData, internal_notes: e.target.value})}
              rows={2}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder={lang === 'en' ? 'Notes visible only to the team...' : "Notes visibles uniquement par l'√©quipe..."}
            />
          ) : (
            <p className="text-gray-600 text-sm">{contract.internal_notes || '‚Äî'}</p>
          )}
        </div>

        {/* Summary Stats */}
        <div className="grid grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
          <div className="text-center">
            <div className="text-2xl font-bold text-[#2D5A7B]">{devices.length}</div>
            <div className="text-sm text-gray-600">{t('devices')}</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-green-600">{totalTokens}</div>
            <div className="text-sm text-gray-600">{lang === 'en' ? 'Calibrations included' : '√âtalonnages inclus'}</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-[#3B7AB4]">{totalPrice.toFixed(2)} ‚Ç¨</div>
            <div className="text-sm text-gray-600">{t('totalHT')}</div>
          </div>
        </div>
      </div>

      {/* Devices Table */}
      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        <div className="px-6 py-4 border-b flex justify-between items-center">
          <h2 className="font-bold text-gray-800">{lang === 'en' ? `Devices (${devices.length})` : `Appareils (${devices.length})`}</h2>
          {!editMode && contract.status !== 'active' && (
            <button
              onClick={() => setEditMode(true)}
              className="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50"
            >
              ‚úèÔ∏è Modifier
            </button>
          )}
        </div>
        
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">{lang === 'en' ? '#' : '#'}</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">{lang === 'en' ? 'Nickname' : 'Surnom'}</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">{t('serialNumber')}</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">{t('model')}</th>
                <th className="px-4 py-3 text-left text-xs font-bold text-gray-600">{t('type')}</th>
                <th className="px-4 py-3 text-center text-xs font-bold text-gray-600">{lang === 'en' ? 'Tokens' : 'Tokens'}</th>
                <th className="px-4 py-3 text-right text-xs font-bold text-gray-600">{t('unitPrice')}</th>
                {contract.status === 'active' && (
                  <th className="px-4 py-3 text-center text-xs font-bold text-gray-600">{lang === 'en' ? 'Used' : 'Utilis√©s'}</th>
                )}
              </tr>
            </thead>
            <tbody className="divide-y">
              {devices.map((device, idx) => (
                <tr key={device.id} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                  <td className="px-4 py-3 text-sm text-gray-500">{idx + 1}</td>
                  <td className="px-4 py-3 text-sm">{device.nickname || '‚Äî'}</td>
                  <td className="px-4 py-3 text-sm font-mono">{device.serial_number}</td>
                  <td className="px-4 py-3 text-sm font-medium"><div className="flex items-center gap-2">{getDeviceImageUrl(device.model_name) && <img src={getDeviceImageUrl(device.model_name)} alt="" className="w-5 h-5 object-contain" />}{device.model_name}</div></td>
                  <td className="px-4 py-3 text-sm">
                    {device.device_type === 'particle_counter' && (lang === 'en' ? 'üî¨ Air Counter' : 'üî¨ Compteur Air')}
                    {device.device_type === 'bio_collector' && (lang === 'en' ? 'üß´ Bio Collector' : 'üß´ Bio Collecteur')}
                    {device.device_type === 'liquid_counter' && (lang === 'en' ? 'üíß Liquid Counter' : 'üíß Compteur Liquide')}
                    {device.device_type === 'temp_humidity' && (lang === 'en' ? 'üå°Ô∏è Temp/Humidity' : 'üå°Ô∏è Temp/Humidit√©')}
                    {device.device_type === 'other' && (lang === 'en' ? 'üì¶ Other' : 'üì¶ Autre')}
                    {!device.device_type && '‚Äî'}
                  </td>
                  <td className="px-4 py-3 text-center">
                    {editMode ? (
                      <input
                        type="number"
                        min="1"
                        value={device.tokens_total || 2}
                        onChange={e => updateDevice(device.id, 'tokens_total', parseInt(e.target.value) || 2)}
                        className="w-16 px-2 py-1 border rounded text-center"
                      />
                    ) : (
                      <span className="font-bold">{device.tokens_total || 2}</span>
                    )}
                  </td>
                  <td className="px-4 py-3 text-right">
                    {editMode ? (
                      <input
                        type="number"
                        step="0.01"
                        min="0"
                        value={device.unit_price || ''}
                        onChange={e => updateDevice(device.id, 'unit_price', e.target.value)}
                        className="w-24 px-2 py-1 border rounded text-right"
                        placeholder="0.00"
                      />
                    ) : (
                      <span className="font-medium">{device.unit_price ? `${parseFloat(device.unit_price).toFixed(2)} ‚Ç¨` : '‚Äî'}</span>
                    )}
                  </td>
                  {contract.status === 'active' && (
                    <td className="px-4 py-3 text-center">
                      <span className={`font-bold ${(device.tokens_used || 0) >= (device.tokens_total || 2) ? 'text-red-600' : 'text-green-600'}`}>
                        {device.tokens_used || 0}/{device.tokens_total || 2}
                      </span>
                    </td>
                  )}
                </tr>
              ))}
            </tbody>
            <tfoot className="bg-gray-100">
              <tr>
                <td colSpan={5} className="px-4 py-3 text-right font-bold">{lang === 'en' ? 'Total:' : 'Total:'}</td>
                <td className="px-4 py-3 text-center font-bold text-green-600">{totalTokens}</td>
                <td className="px-4 py-3 text-right font-bold text-[#2D5A7B]">{totalPrice.toFixed(2)} ‚Ç¨</td>
                {contract.status === 'active' && <td></td>}
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      {/* Action Buttons */}
      <div className="bg-white rounded-xl shadow-sm p-6">
        <div className="flex flex-wrap gap-3">
          {editMode && (
            <>
              <button
                onClick={() => setEditMode(false)}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                Annuler
              </button>
              <button
                onClick={saveDeviceChanges}
                disabled={saving}
                className="px-4 py-2 bg-[#00A651] text-white rounded-lg hover:bg-[#008c44] disabled:opacity-50"
              >
                {saving ? (lang === 'en' ? 'Saving...' : 'Enregistrement...') : (lang === 'en' ? 'Save changes' : 'Enregistrer les modifications')}
              </button>
            </>
          )}

          {!editMode && contract.status === 'requested' && (
            <>
              <button
                onClick={() => setEditMode(true)}
                className="px-4 py-2 border border-[#3B7AB4] text-[#3B7AB4] rounded-lg hover:bg-blue-50"
              >
                ‚úèÔ∏è D√©finir les prix et tokens
              </button>
              <button
                onClick={() => setShowQuoteModal(true)}
                className="px-4 py-2 bg-[#3B7AB4] text-white rounded-lg hover:bg-[#2D5A7B]"
              >
                üìß Cr√©er le devis
              </button>
              <button
                onClick={async () => {
                  const reason = window.prompt(lang === 'en' ? 'Reason for modification request:\n(This message will be visible to the client)' : 'Raison de la demande de modification:\n(Ce message sera visible par le client)');
                  if (reason) {
                    setSaving(true);
                    try {
                      await supabase.from('contracts').update({
                        status: 'modification_requested',
                        admin_notes: reason,
                        updated_at: new Date().toISOString()
                      }).eq('id', contract.id);
                      notify(lang === 'en' ? 'Modification request sent to client' : 'Demande de modification envoy√©e au client', 'success');
                      onUpdate();
                    } catch (err) {
                      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
                    }
                    setSaving(false);
                  }
                }}
                disabled={saving}
                className="px-4 py-2 border border-amber-500 text-amber-600 rounded-lg hover:bg-amber-50"
              >
                ‚úèÔ∏è Demander modification
              </button>
              <button
                onClick={async () => {
                  const reason = window.prompt(lang === 'en' ? 'Reason for rejection:\n(This message will be visible to the client)' : 'Raison du refus:\n(Ce message sera visible par le client)');
                  if (reason) {
                    setSaving(true);
                    try {
                      await supabase.from('contracts').update({
                        status: 'refused',
                        admin_notes: reason,
                        updated_at: new Date().toISOString()
                      }).eq('id', contract.id);
                      notify(lang === 'en' ? 'Contract request declined' : 'Demande de contrat refus√©e', 'success');
                      onUpdate();
                    } catch (err) {
                      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
                    }
                    setSaving(false);
                  }
                }}
                disabled={saving}
                className="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50"
              >
                ‚ùå Refuser la demande
              </button>
            </>
          )}

          {contract.status === 'modification_requested' && (
            <div className="w-full bg-amber-50 border border-amber-200 rounded-lg p-4 mb-2">
              <p className="text-amber-800 font-medium">{lang === 'en' ? '‚è≥ Awaiting client modification' : '‚è≥ En attente de modification par le client'}</p>
              {contract.admin_notes && (
                <p className="text-amber-700 text-sm mt-1">Message: "{contract.admin_notes}"</p>
              )}
            </div>
          )}

          {contract.status === 'refused' && (
            <div className="w-full bg-red-50 border border-red-200 rounded-lg p-4 mb-2">
              <p className="text-red-800 font-medium">{lang === 'en' ? '‚ùå Request declined' : '‚ùå Demande refus√©e'}</p>
              {contract.admin_notes && (
                <p className="text-red-700 text-sm mt-1">Raison: "{contract.admin_notes}"</p>
              )}
            </div>
          )}

          {contract.status === 'quote_sent' && (
            <button
              onClick={() => updateContractStatus('quote_approved')}
              disabled={saving}
              className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50"
            >
              ‚úÖ Marquer devis approuv√©
            </button>
          )}

          {contract.status === 'quote_approved' && (
            <button
              onClick={() => updateContractStatus('bc_pending')}
              disabled={saving}
              className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 disabled:opacity-50"
            >
              üìÑ En attente du BC
            </button>
          )}

          {contract.status === 'bc_pending' && (
            <button
              onClick={() => updateContractStatus('active')}
              disabled={saving}
              className="px-4 py-2 bg-[#00A651] text-white rounded-lg hover:bg-[#008c44] disabled:opacity-50"
            >
              ‚úÖ Activer le contrat
            </button>
          )}

          {contract.status !== 'cancelled' && contract.status !== 'active' && !editMode && (
            <button
              onClick={() => {
                if (window.confirm(lang === 'en' ? 'Are you sure you want to cancel this contract? Type "cancel contract" to confirm.' : '√ätes-vous s√ªr de vouloir annuler ce contrat? Tapez "annuler contrat" pour confirmer.')) {
                  const confirmation = window.prompt(lang === 'en' ? 'Type "cancel contract" to confirm:' : 'Tapez "annuler contrat" pour confirmer:');
                  if (confirmation?.toLowerCase() === 'annuler contrat') {
                    updateContractStatus('cancelled');
                  }
                }
              }}
              disabled={saving}
              className="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 disabled:opacity-50"
            >
              ‚ùå Annuler Contrat
            </button>
          )}

          {/* Delete Contract - Admin only, for any status */}
          <button
            onClick={async () => {
              const confirmation = window.prompt((lang === 'en' ? '‚ö†Ô∏è WARNING: This action is irreversible!\n\nType "DELETE" to confirm permanent deletion of contract ' : '‚ö†Ô∏è ATTENTION: Cette action est irr√©versible!\n\nTapez "SUPPRIMER" pour confirmer la suppression d√©finitive du contrat ') + + (contract.contract_number || contract.id) + ':');
              if (confirmation === (lang === 'en' ? 'DELETE' : 'SUPPRIMER')) {
                setSaving(true);
                try {
                  // First, get all contract device IDs from database
                  const { data: contractDevices } = await supabase
                    .from('contract_devices')
                    .select('id')
                    .eq('contract_id', contract.id);
                  
                  const contractDeviceIds = (contractDevices || []).map(d => d.id);
                  console.log('Contract device IDs to clear:', contractDeviceIds);
                  
                  // Clear any references in request_devices
                  if (contractDeviceIds.length > 0) {
                    await supabase
                      .from('request_devices')
                      .update({ contract_device_id: null })
                      .in('contract_device_id', contractDeviceIds);
                  }
                  
                  // Clear any references in service_requests (contract_id column if exists)
                  await supabase
                    .from('service_requests')
                    .update({ contract_id: null })
                    .eq('contract_id', contract.id);
                  
                  // Delete contract devices
                  const { error: devicesError } = await supabase
                    .from('contract_devices')
                    .delete()
                    .eq('contract_id', contract.id);
                  
                  if (devicesError) {
                    console.error('Error deleting contract_devices:', devicesError);
                  }
                  
                  // Then delete the contract
                  const { error: contractError } = await supabase
                    .from('contracts')
                    .delete()
                    .eq('id', contract.id);
                  
                  if (contractError) {
                    console.error('Error deleting contract:', contractError);
                    throw contractError;
                  }
                  
                  notify(lang === 'en' ? 'Contract permanently deleted' : 'Contrat supprim√© d√©finitivement', 'success');
                  onClose();
                  onUpdate();
                } catch (err) {
                  notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
                }
                setSaving(false);
              }
            }}
            disabled={saving}
            className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50"
          >
            üóëÔ∏è Supprimer D√©finitivement
          </button>
        </div>
      </div>
    </div>
  );
}

// ============================================
// CREATE CONTRACT MODAL - Manual Contract Creation
// ============================================
// ============================================
// BC FILE UPLOADER (Admin side)
// ============================================
function BCFileUploader({ onUploaded, currentUrl, lang = 'fr', folder = 'bons-commande/manual' }) {
  const t = k => k;
  const [uploading, setUploading] = useState(false);
  const [urlMode, setUrlMode] = useState(false);
  const [urlInput, setUrlInput] = useState(currentUrl || '');

  const handleFileUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    setUploading(true);
    try {
      const fileExt = file.name.split('.').pop();
      const filePath = `${folder}/bc_${Date.now()}.${fileExt}`;
      
      const { error: uploadError } = await supabase.storage
        .from('documents')
        .upload(filePath, file);
      
      if (uploadError) throw uploadError;
      
      const { data: { publicUrl } } = supabase.storage
        .from('documents')
        .getPublicUrl(filePath);
      
      onUploaded(publicUrl);
    } catch (err) {
      console.error('Upload error:', err);
      alert(lang === 'en' ? 'Upload error: ' : 'Erreur upload: ' + err.message);
    }
    setUploading(false);
  };

  const handleUrlSubmit = () => {
    if (urlInput.trim()) {
      onUploaded(urlInput.trim());
    }
  };

  if (currentUrl) {
    return (
      <div className="flex items-center gap-2">
        <span className="text-green-600 text-sm">{lang === 'en' ? '‚úÖ PO added' : '‚úÖ BC ajout√©'}</span>
        <a href={currentUrl} target="_blank" rel="noopener noreferrer" className="text-blue-500 text-sm hover:underline">{t('view')}</a>
        <button 
          onClick={() => onUploaded('')} 
          className="text-red-500 text-sm hover:underline"
        >
          Supprimer
        </button>
      </div>
    );
  }

  return (
    <div className="space-y-2">
      <div className="flex gap-2">
        <button
          type="button"
          onClick={() => setUrlMode(false)}
          className={`px-3 py-1 text-xs rounded ${!urlMode ? 'bg-[#00A651] text-white' : 'bg-gray-200 text-gray-700'}`}
        >
          üìÑ Fichier
        </button>
        <button
          type="button"
          onClick={() => setUrlMode(true)}
          className={`px-3 py-1 text-xs rounded ${urlMode ? 'bg-[#00A651] text-white' : 'bg-gray-200 text-gray-700'}`}
        >
          üîó Lien
        </button>
      </div>
      
      {urlMode ? (
        <div className="flex gap-2">
          <input
            type="url"
            value={urlInput}
            onChange={e => setUrlInput(e.target.value)}
            placeholder="https://drive.google.com/..."
            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
          />
          <button
            type="button"
            onClick={handleUrlSubmit}
            className="px-3 py-2 bg-[#00A651] text-white rounded-lg text-sm"
          >
            OK
          </button>
        </div>
      ) : (
        <label className="block cursor-pointer">
          <input
            type="file"
            accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"
            onChange={handleFileUpload}
            disabled={uploading}
            className="hidden"
          />
          <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-[#00A651] hover:bg-green-50 transition-colors">
            {uploading ? (
              <div className="flex items-center justify-center gap-2">
                <div className="w-4 h-4 border-2 border-[#00A651] border-t-transparent rounded-full animate-spin"></div>
                <span className="text-sm text-gray-600">Upload...</span>
              </div>
            ) : (
              <>
                <div className="text-2xl mb-1">üìÑ</div>
                <p className="text-xs text-gray-600">{lang === 'en' ? 'Click to select' : 'Cliquez pour s√©lectionner'}</p>
                <p className="text-xs text-gray-400">{lang === 'en' ? 'PDF, DOC, Image' : 'PDF, DOC, Image'}</p>
              </>
            )}
          </div>
        </label>
      )}
    </div>
  );
}

function CreateContractModal({ clients, notify, onClose, onCreated, lang = 'fr' }) {
  const t = k => k;
  const [step, setStep] = useState(1);
  const [saving, setSaving] = useState(false);
  const [contractData, setContractData] = useState({
    company_id: '',
    company_name: '', // For display when no company selected
    contract_number: '',
    start_date: new Date().toISOString().split('T')[0],
    end_date: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
    status: 'active',
    internal_notes: '',
    bc_url: ''
  });
  const [devices, setDevices] = useState([
    { id: Date.now(), serial_number: '', model_name: '', device_type: 'particle_counter', nickname: '', tokens_total: 1, unit_price: 0 }
  ]);

  const addDevice = () => {
    setDevices([...devices, { id: Date.now(), serial_number: '', model_name: '', device_type: 'particle_counter', nickname: '', tokens_total: 1, unit_price: 0 }]);
  };

  const removeDevice = (id) => {
    if (devices.length > 1) {
      setDevices(devices.filter(d => d.id !== id));
    }
  };

  const updateDevice = (id, field, value) => {
    setDevices(devices.map(d => d.id === id ? { ...d, [field]: value } : d));
  };

  const generateContractNumber = () => {
    const year = new Date().getFullYear();
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `CTR-${year}-${random}`;
  };

  useEffect(() => {
    if (!contractData.contract_number) {
      setContractData(prev => ({ ...prev, contract_number: generateContractNumber() }));
    }
  }, []);

  const handleSubmit = async () => {
    // Validate
    if (!contractData.company_id && !contractData.company_name) {
      notify(lang === 'en' ? 'Please select a client or enter a name' : 'Veuillez s√©lectionner un client ou entrer un nom', 'error');
      return;
    }
    if (devices.length === 0 || !devices.some(d => d.serial_number)) {
      notify(lang === 'en' ? 'Please add at least one device with a serial number' : 'Veuillez ajouter au moins un appareil avec un num√©ro de s√©rie', 'error');
      return;
    }

    setSaving(true);
    try {
      // Check for overlapping contracts with same serial numbers
      const serialNumbers = devices.filter(d => d.serial_number).map(d => d.serial_number.trim().toUpperCase());
      
      // Get all active/quote_sent contracts that overlap with this date range
      const { data: overlappingContracts } = await supabase
        .from('contracts')
        .select('id, contract_number, start_date, end_date, contract_devices(serial_number)')
        .in('status', ['active', 'quote_sent', 'bc_pending'])
        .or(`and(start_date.lte.${contractData.end_date},end_date.gte.${contractData.start_date})`);
      
      // Check if any serial numbers conflict
      const conflicts = [];
      for (const existingContract of (overlappingContracts || [])) {
        for (const cd of (existingContract.contract_devices || [])) {
          const existingSerial = (cd.serial_number || '').trim().toUpperCase();
          if (serialNumbers.includes(existingSerial)) {
            conflicts.push({
              serial: cd.serial_number,
              contractNumber: existingContract.contract_number,
              period: `${new Date(existingContract.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')} - ${new Date(existingContract.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}`
            });
          }
        }
      }
      
      if (conflicts.length > 0) {
        const conflictMsg = conflicts.map(c => 
          `‚Ä¢ ${c.serial} d√©j√† dans contrat ${c.contractNumber} (${c.period})`
        ).join('\n');
        notify(lang === 'en' ? `‚ùå Serial number conflict detected:\n${conflictMsg}` : `‚ùå Conflit de num√©ros de s√©rie d√©tect√©:\n${conflictMsg}`, 'error');
        setSaving(false);
        return;
      }

      // Create contract
      const { data: contract, error: contractError } = await supabase
        .from('contracts')
        .insert({
          company_id: contractData.company_id || null,
          company_name_manual: contractData.company_id ? null : contractData.company_name,
          contract_number: contractData.contract_number,
          start_date: contractData.start_date,
          end_date: contractData.end_date,
          status: contractData.status,
          internal_notes: contractData.internal_notes,
          bc_url: contractData.bc_url || null
        })
        .select()
        .single();

      if (contractError) throw contractError;

      // Add devices
      const deviceInserts = devices.filter(d => d.serial_number).map(d => ({
        contract_id: contract.id,
        serial_number: d.serial_number,
        model_name: d.model_name,
        device_type: d.device_type,
        nickname: d.nickname,
        tokens_total: d.tokens_total || 2,
        tokens_used: 0,
        unit_price: d.unit_price || 0
      }));

      const { error: devicesError } = await supabase
        .from('contract_devices')
        .insert(deviceInserts);

      if (devicesError) throw devicesError;

      notify(lang === 'en' ? '‚úÖ Contract created successfully!' : '‚úÖ Contrat cr√©√© avec succ√®s!');
      onCreated();
    } catch (err) {
      console.error('Error creating contract:', err);
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    } finally {
      setSaving(false);
    }
  };

  const totalPrice = devices.reduce((sum, d) => sum + (parseFloat(d.unit_price) || 0), 0);
  const totalTokens = devices.reduce((sum, d) => sum + (parseInt(d.tokens_total) || 0), 0);

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">{lang === 'en' ? '‚Üê Back' : '‚Üê Retour'}</button>
          <h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? 'Create Contract Manually' : 'Cr√©er un Contrat Manuellement'}</h1>
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        {/* Header */}
        <div className="px-6 py-4 bg-[#1a1a2e] text-white">
          <h2 className="text-xl font-bold">{lang === 'en' ? "New Calibration Contract" : "Nouveau Contrat d'√âtalonnage"}</h2>
          <p className="text-gray-300 text-sm">{lang === 'en' ? 'For existing contracts not created by client' : 'Pour les contrats existants non cr√©√©s par le client'}</p>
        </div>

        <div className="p-6 space-y-6">
          {/* Client Selection */}
          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'en' ? 'Existing client' : 'Client existant'}</label>
              <select
                value={contractData.company_id}
                onChange={e => setContractData({ ...contractData, company_id: e.target.value, company_name: '' })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
              >
                <option value="">{lang === 'en' ? '‚Äî Select a client ‚Äî' : '‚Äî S√©lectionner un client ‚Äî'}</option>
                {clients.map(c => (
                  <option key={c.id} value={c.id}>{c.name}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'en' ? 'Or client name (if no account)' : 'Ou nom du client (si pas de compte)'}</label>
              <input
                type="text"
                value={contractData.company_name}
                onChange={e => setContractData({ ...contractData, company_name: e.target.value, company_id: '' })}
                placeholder={lang === 'en' ? 'Company name...' : "Nom de l'entreprise..."}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
                disabled={!!contractData.company_id}
              />
              <p className="text-xs text-gray-500 mt-1">{lang === 'en' ? 'You can link the contract to an account later' : 'Vous pourrez lier le contrat √† un compte plus tard'}</p>
            </div>
          </div>

          {/* Contract Details */}
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'en' ? 'Contract #' : 'N¬∞ Contrat'}</label>
              <input
                type="text"
                value={contractData.contract_number}
                onChange={e => setContractData({ ...contractData, contract_number: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'en' ? 'Start date' : 'Date d√©but'}</label>
              <input
                type="date"
                value={contractData.start_date}
                onChange={e => setContractData({ ...contractData, start_date: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'en' ? 'End date' : 'Date fin'}</label>
              <input
                type="date"
                value={contractData.end_date}
                onChange={e => setContractData({ ...contractData, end_date: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
              />
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{t('status')}</label>
              <select
                value={contractData.status}
                onChange={e => setContractData({ ...contractData, status: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg"
              >
                <option value="active">{lang === 'en' ? '‚úÖ Active' : '‚úÖ Actif'}</option>
                <option value="bc_pending">{lang === 'en' ? 'üìÑ Awaiting PO' : 'üìÑ Attente BC'}</option>
                <option value="quote_approved">{lang === 'en' ? '‚úÖ Quote approved' : '‚úÖ Devis approuv√©'}</option>
                <option value="expired">{lang === 'en' ? '‚è∞ Expired' : '‚è∞ Expir√©'}</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'en' ? 'Purchase Order (optional)' : 'Bon de Commande (optionnel)'}</label>
              <BCFileUploader lang={lang} 
                onUploaded={(url) => setContractData({ ...contractData, bc_url: url })}
                currentUrl={contractData.bc_url}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'en' ? 'Internal notes' : 'Notes internes'}</label>
            <textarea
              value={contractData.internal_notes}
              onChange={e => setContractData({ ...contractData, internal_notes: e.target.value })}
              rows={2}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg"
              placeholder={lang === 'en' ? 'Notes on this contract...' : 'Notes sur ce contrat...'}
            />
          </div>

          {/* Devices Section */}
          <div className="border-t pt-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-gray-800">{lang === 'en' ? `Devices under contract (${devices.length})` : `Appareils sous contrat (${devices.length})`}</h3>
              <button
                onClick={addDevice}
                className="px-4 py-2 bg-[#00A651] text-white rounded-lg text-sm hover:bg-[#008f45]"
              >
                + Ajouter appareil
              </button>
            </div>

            <div className="space-y-3">
              {devices.map((device, index) => (
                <div key={device.id} className="bg-gray-50 rounded-lg p-4 border">
                  <div className="flex items-start gap-4">
                    <span className="bg-[#1a1a2e] text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">{index + 1}</span>
                    <div className="flex-1 grid md:grid-cols-6 gap-3">
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">{lang === 'en' ? 'Serial # *' : 'N¬∞ S√©rie *'}</label>
                        <input
                          type="text"
                          value={device.serial_number}
                          onChange={e => updateDevice(device.id, 'serial_number', e.target.value)}
                          className="w-full px-3 py-2 border rounded-lg text-sm"
                          placeholder="SN..."
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">{t('model')}</label>
                        <input
                          type="text"
                          value={device.model_name}
                          onChange={e => updateDevice(device.id, 'model_name', e.target.value)}
                          className="w-full px-3 py-2 border rounded-lg text-sm"
                          placeholder={lang === 'en' ? 'Model...' : 'Mod√®le...'}
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">{t('type')}</label>
                        <select
                          value={device.device_type}
                          onChange={e => updateDevice(device.id, 'device_type', e.target.value)}
                          className="w-full px-3 py-2 border rounded-lg text-sm"
                        >
                          <option value="particle_counter">{lang === 'en' ? 'Particle counter' : 'Compteur particules'}</option>
                          <option value="bio_collector">{lang === 'en' ? 'Bio collector' : 'Bio collecteur'}</option>
                          <option value="liquid_counter">{lang === 'en' ? 'Liquid counter' : 'Compteur liquide'}</option>
                          <option value="temp_humidity">{lang === 'en' ? "Temp/Humidity" : "Temp/Humidit√©"}</option>
                          <option value="other">{lang === 'en' ? 'Other' : 'Autre'}</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">{lang === 'en' ? 'Tokens/yr' : 'Tokens/an'}</label>
                        <input
                          type="number"
                          value={device.tokens_total}
                          onChange={e => updateDevice(device.id, 'tokens_total', parseInt(e.target.value) || 2)}
                          className="w-full px-3 py-2 border rounded-lg text-sm"
                          min="1"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-500 mb-1">{lang === 'en' ? 'Price ‚Ç¨' : 'Prix ‚Ç¨'}</label>
                        <input
                          type="number"
                          value={device.unit_price}
                          onChange={e => updateDevice(device.id, 'unit_price', parseFloat(e.target.value) || 0)}
                          className="w-full px-3 py-2 border rounded-lg text-sm"
                          min="0"
                          step="0.01"
                        />
                      </div>
                      <div className="flex items-end">
                        {devices.length > 1 && (
                          <button
                            onClick={() => removeDevice(device.id)}
                            className="px-3 py-2 text-red-500 hover:bg-red-50 rounded-lg text-sm"
                          >
                            üóëÔ∏è
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {/* Summary */}
            <div className="mt-4 bg-emerald-50 rounded-lg p-4 flex justify-between items-center">
              <div>
                <span className="text-emerald-800 font-medium">{devices.filter(d => d.serial_number).length} appareil(s)</span>
                <span className="text-emerald-600 mx-3">‚Ä¢</span>
                <span className="text-emerald-800">{totalTokens} tokens total</span>
              </div>
              <div className="text-right">
                <span className="text-emerald-800 font-bold text-xl">{totalPrice.toFixed(2)} ‚Ç¨</span>
                <span className="text-emerald-600 text-sm ml-2">{lang === 'en' ? 'excl. VAT' : 'HT'}</span>
              </div>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 bg-gray-100 border-t flex justify-between">
          <button onClick={onClose} className="px-6 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
            Annuler
          </button>
          <button
            onClick={handleSubmit}
            disabled={saving}
            className="px-8 py-2 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-bold disabled:opacity-50"
          >
            {saving ? (lang === 'en' ? 'Creating...' : 'Cr√©ation...') : (lang === 'en' ? '‚úÖ Create Contract' : '‚úÖ Cr√©er le Contrat')}
          </button>
        </div>
      </div>
    </div>
  );
}

// ============================================
// PENDING ARRIVALS SHEET - Scanner-first device reception tracking
// ============================================
function PendingArrivalsSheet({ clients = [], requests = [], notify, reload, profile, t = k=>k, lang = 'fr' }) {
  const [arrivals, setArrivals] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('active');
  const [searchTerm, setSearchTerm] = useState('');
  const [expandedId, setExpandedId] = useState(null);
  
  // Scanner input mode
  const [scanInput, setScanInput] = useState('');
  const [scanResult, setScanResult] = useState(null); // { type: 'no_rma' | 'awaiting_approval' | 'normal', rma, device, company }
  const [scanning, setScanning] = useState(false);
  const [scanProcessed, setScanProcessed] = useState(false);
  
  // Follow-up editing
  const [editingId, setEditingId] = useState(null);
  const [editForm, setEditForm] = useState({});
  
  // RMA linking
  const [showRMALinker, setShowRMALinker] = useState(null);
  const [rmaSearch, setRmaSearch] = useState('');
  
  // Notes editing
  const [editingNotes, setEditingNotes] = useState(null);
  const [notesText, setNotesText] = useState('');
  
  // Status config
  const statusConfig = {
    no_rma: { label: lang === 'en' ? 'No RMA' : 'Pas de RMA', color: 'bg-red-100 text-red-700', icon: '‚ö†Ô∏è' },
    needs_contact: { label: lang === 'en' ? 'Needs contact info' : 'Info contact requise', color: 'bg-amber-100 text-amber-700', icon: 'üìù' },
    followup_active: { label: lang === 'en' ? 'Follow-up active' : 'Suivi en cours', color: 'bg-orange-100 text-orange-700', icon: 'üìß' },
    awaiting_rma: { label: lang === 'en' ? 'Awaiting RMA creation' : 'Attente cr√©ation RMA', color: 'bg-blue-100 text-blue-700', icon: '‚è≥' },
    awaiting_approval: { label: lang === 'en' ? 'Awaiting quote approval' : 'Attente approbation devis', color: 'bg-purple-100 text-purple-700', icon: 'üî¥' },
    resolved: { label: lang === 'en' ? 'Resolved' : 'R√©solu', color: 'bg-green-100 text-green-700', icon: '‚úÖ' }
  };
  
  // Reminder frequency options
  const reminderOptions = [
    { value: 'daily', label: lang === 'en' ? 'Daily' : 'Quotidien' },
    { value: 'every_3_days', label: lang === 'en' ? 'Every 3 days' : 'Tous les 3 jours' },
    { value: 'weekly', label: lang === 'en' ? 'Weekly' : 'Hebdomadaire' }
  ];
  
  // Load arrivals
  const loadArrivals = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from('pending_arrivals')
        .select('*, companies(id, name, email)')
        .order('arrived_at', { ascending: false });
      if (error) throw error;
      setArrivals(data || []);
    } catch (err) {
      console.error('Error loading pending arrivals:', err);
    }
    setLoading(false);
  };
  
  useEffect(() => { loadArrivals(); }, []);
  
  // Auto-check for resolved tickets (RMA created or quote approved)
  useEffect(() => {
    if (arrivals.length === 0 || requests.length === 0) return;
    const unresolvedWithRMA = arrivals.filter(a => a.status !== 'resolved' && a.linked_rma_id);
    unresolvedWithRMA.forEach(a => {
      const rma = requests.find(r => r.id === a.linked_rma_id);
      if (!rma) return;
      // If RMA quote is approved, resolve this ticket
      if (['quote_approved', 'waiting_device', 'received', 'in_service', 'calibration', 'repair', 'qc_check', 'ready_to_ship', 'shipped', 'completed'].includes(rma.status)) {
        supabase.from('pending_arrivals').update({ 
          status: 'resolved', 
          resolved_at: new Date().toISOString(),
          notes: (a.notes || '') + '\n[Auto-resolved: RMA ' + rma.request_number + ' approved]'
        }).eq('id', a.id).then(() => loadArrivals());
      }
    });
    // Also check unlinked tickets ‚Äî if serial now matches an approved RMA
    const unresolvedNoRMA = arrivals.filter(a => a.status !== 'resolved' && !a.linked_rma_id && a.serial_number);
    unresolvedNoRMA.forEach(a => {
      const matchingRMA = requests.find(r => 
        r.request_type !== 'parts' && 
        r.request_devices?.some(d => d.serial_number?.toLowerCase() === a.serial_number?.toLowerCase()) &&
        !['cancelled', 'archived'].includes(r.status)
      );
      if (matchingRMA) {
        const isApproved = ['quote_approved', 'waiting_device', 'received', 'in_service', 'calibration', 'repair', 'qc_check', 'ready_to_ship', 'shipped', 'completed'].includes(matchingRMA.status);
        supabase.from('pending_arrivals').update({ 
          linked_rma_id: matchingRMA.id,
          status: isApproved ? 'resolved' : 'awaiting_approval',
          ...(isApproved ? { resolved_at: new Date().toISOString() } : {}),
          notes: (a.notes || '') + '\n[Auto-linked to ' + matchingRMA.request_number + ']'
        }).eq('id', a.id).then(() => loadArrivals());
      }
    });
  }, [arrivals.length, requests]);
  
  // ==================== SCANNER FLOW ====================
  const processScan = async (serial) => {
    if (!serial || serial.trim().length < 2) return;
    const cleanSerial = serial.trim();
    setScanning(true);
    setScanResult(null);
    setScanProcessed(false);
    
    try {
      // Check request_devices for active RMAs
      const { data: deviceMatches } = await supabase
        .from('request_devices')
        .select('*, service_requests!inner(id, request_number, status, quote_total, quote_number, companies(id, name, email))')
        .ilike('serial_number', cleanSerial)
        .order('created_at', { ascending: false });
      
      // Filter to active RMAs only
      const activeMatches = (deviceMatches || []).filter(d => 
        !['completed', 'cancelled', 'archived', 'shipped'].includes(d.service_requests?.status)
      );
      
      if (activeMatches.length > 0) {
        const match = activeMatches[0];
        const rma = match.service_requests;
        const rmaStatus = rma.status;
        
        // Is quote approved?
        const approvedStatuses = ['quote_approved', 'waiting_device', 'received', 'in_service', 'calibration', 'repair', 'qc_check', 'ready_to_ship'];
        
        if (approvedStatuses.includes(rmaStatus)) {
          // Result C: Normal flow ‚Äî just mark received
          setScanResult({ 
            type: 'normal', 
            rma, 
            device: match, 
            company: rma.companies,
            message: lang === 'en' 
              ? `‚úÖ RMA ${rma.request_number} found ‚Äî quote approved. Device marked as received.`
              : `‚úÖ RMA ${rma.request_number} trouv√© ‚Äî devis approuv√©. Appareil marqu√© comme re√ßu.`
          });
          // Auto-update received_at on RMA
          await supabase.from('service_requests').update({ 
            received_at: new Date().toISOString(),
            status: rmaStatus === 'waiting_device' ? 'received' : rmaStatus
          }).eq('id', rma.id);
          // Update device status
          await supabase.from('request_devices').update({ 
            status: 'received'
          }).eq('id', match.id).eq('status', 'pending');
          setScanProcessed(true);
          
        } else {
          // Result B: RMA exists but quote not approved
          setScanResult({ 
            type: 'awaiting_approval', 
            rma, 
            device: match, 
            company: rma.companies,
            message: lang === 'en'
              ? `üî¥ RMA ${rma.request_number} found but quote NOT approved (status: ${rmaStatus}). Ticket created.`
              : `üî¥ RMA ${rma.request_number} trouv√© mais devis NON approuv√© (statut: ${rmaStatus}). Ticket cr√©√©.`
          });
          // Create pending arrival ticket
          await supabase.from('pending_arrivals').insert({
            arrived_at: new Date().toISOString().split('T')[0],
            company_id: rma.companies?.id || null,
            serial_number: cleanSerial,
            model_name: match.model_name || null,
            linked_rma_id: rma.id,
            status: 'awaiting_approval',
            logged_by: profile?.id || null,
            notes: 'Scanned: RMA ' + rma.request_number + ' exists, awaiting quote approval'
          });
          // Mark device as received on the RMA
          await supabase.from('service_requests').update({ 
            received_at: new Date().toISOString()
          }).eq('id', rma.id).is('received_at', null);
          await supabase.from('request_devices').update({ 
            status: 'received'
          }).eq('id', match.id);
          setScanProcessed(true);
          loadArrivals();
          if (reload) reload();
        }
      } else {
        // Also check equipment table for company info
        let companyInfo = null;
        const { data: equipMatch } = await supabase
          .from('equipment')
          .select('*, companies(id, name, email)')
          .ilike('serial_number', `%${cleanSerial}%`)
          .limit(1);
        if (equipMatch?.[0]?.companies) {
          companyInfo = equipMatch[0].companies;
        }
        
        // Result A: No active RMA
        setScanResult({ 
          type: 'no_rma', 
          company: companyInfo,
          message: lang === 'en'
            ? `‚ö†Ô∏è No active RMA found for SN: ${cleanSerial}. Ticket created ‚Äî add contact info to start follow-up.`
            : `‚ö†Ô∏è Aucun RMA actif trouv√© pour SN : ${cleanSerial}. Ticket cr√©√© ‚Äî ajoutez les coordonn√©es pour d√©marrer le suivi.`
        });
        // Create pending arrival ticket
        await supabase.from('pending_arrivals').insert({
          arrived_at: new Date().toISOString().split('T')[0],
          company_id: companyInfo?.id || null,
          serial_number: cleanSerial,
          status: companyInfo ? 'needs_contact' : 'no_rma',
          logged_by: profile?.id || null,
          notes: 'Scanned: No active RMA found' + (companyInfo ? ' (company identified: ' + companyInfo.name + ')' : '')
        });
        setScanProcessed(true);
        loadArrivals();
        if (reload) reload();
      }
    } catch (err) {
      console.error('Scan error:', err);
      notify('‚ùå ' + (err.message || 'Scan error'), 'error');
    }
    setScanning(false);
  };
  
  // Handle scan input (Enter key or button)
  const handleScanSubmit = (e) => {
    if (e) e.preventDefault();
    processScan(scanInput);
  };
  
  // ==================== FOLLOW-UP ACTIONS ====================
  
  // Start follow-up (from computer ‚Äî after adding email)
  const startFollowUp = async (arrival) => {
    const company = arrival.companies;
    const email = editForm.followup_email || company?.email || '';
    if (!email) { notify(lang === 'en' ? '‚ö†Ô∏è Email address required' : '‚ö†Ô∏è Adresse email requise', 'error'); return; }
    
    // Update the ticket
    await supabase.from('pending_arrivals').update({ 
      status: 'followup_active',
      followup_email: email,
      reminder_frequency: editForm.reminder_frequency || 'weekly',
      last_reminder_at: new Date().toISOString(),
      reminder_count: 1,
      notes: (arrival.notes || '') + '\nFollow-up started ' + new Date().toLocaleDateString('fr-FR') + ' ‚Üí ' + email
    }).eq('id', arrival.id);
    
    // Compose and open the first email
    const serial = arrival.serial_number ? ` (SN: ${arrival.serial_number})` : '';
    const model = arrival.model_name ? ` ${arrival.model_name}` : '';
    
    if (arrival.status === 'awaiting_approval' || arrival.linked_rma_id) {
      const linkedRMA = requests.find(r => r.id === arrival.linked_rma_id);
      const rmaNum = linkedRMA?.request_number || 'N/A';
      const subject = encodeURIComponent(`Lighthouse France - En attente de votre approbation - ${rmaNum}`);
      const body = encodeURIComponent(
`Bonjour,

Nous avons r√©ceptionn√© votre √©quipement${model}${serial} le ${new Date(arrival.arrived_at).toLocaleDateString('fr-FR')} dans nos locaux de Cr√©teil.

Un devis vous a √©t√© transmis sous la r√©f√©rence ${rmaNum}. Nous sommes en attente de votre approbation pour pouvoir d√©buter l'intervention.

Vous pouvez approuver le devis directement via votre espace client ou nous retourner un bon de commande.

Cordialement,
Service France
Lighthouse France`
      );
      window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');
    } else {
      const subject = encodeURIComponent(`Lighthouse France - R√©ception de votre √©quipement${serial}`);
      const body = encodeURIComponent(
`Bonjour,

Nous avons r√©ceptionn√© le ${new Date(arrival.arrived_at).toLocaleDateString('fr-FR')} un √©quipement${model}${serial} dans nos locaux de Cr√©teil.

Cependant, nous n'avons pas de demande de service (RMA) associ√©e √† cet envoi.

Pourriez-vous nous confirmer la nature de l'intervention souhait√©e en cr√©ant une demande sur notre portail client, ou en nous contactant directement ?

Dans l'attente de votre retour, votre √©quipement est conserv√© en s√©curit√© dans nos installations.

Cordialement,
Service France
Lighthouse France`
      );
      window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');
    }
    
    setEditingId(null);
    setEditForm({});
    notify(lang === 'en' ? '‚úÖ Follow-up started!' : '‚úÖ Suivi d√©marr√© !');
    loadArrivals();
  };
  
  // Send reminder
  const sendReminder = async (arrival) => {
    const email = arrival.followup_email || arrival.companies?.email;
    if (!email) return;
    
    const count = (arrival.reminder_count || 0) + 1;
    const serial = arrival.serial_number ? ` (SN: ${arrival.serial_number})` : '';
    const model = arrival.model_name ? ` ${arrival.model_name}` : '';
    
    const subject = encodeURIComponent(`[Rappel ${count}] Lighthouse France - Votre √©quipement${serial} en attente`);
    const body = encodeURIComponent(
`Bonjour,

Ceci est un rappel concernant votre √©quipement${model}${serial} r√©ceptionn√© le ${new Date(arrival.arrived_at).toLocaleDateString('fr-FR')} dans nos locaux.

${arrival.linked_rma_id ? "Nous sommes toujours en attente de votre approbation du devis pour pouvoir d√©marrer le service." : "Nous attendons toujours une demande de service (RMA) pour cet √©quipement."}

Merci de nous contacter ou de vous connecter sur votre espace client d√®s que possible.

Cordialement,
Service France
Lighthouse France`
    );
    window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');
    
    await supabase.from('pending_arrivals').update({
      last_reminder_at: new Date().toISOString(),
      reminder_count: count,
      notes: (arrival.notes || '') + '\nReminder #' + count + ' sent ' + new Date().toLocaleDateString('fr-FR')
    }).eq('id', arrival.id);
    
    notify(`üìß Rappel #${count} envoy√©`);
    loadArrivals();
  };
  
  // Update status
  const updateStatus = async (id, newStatus) => {
    const updates = { status: newStatus, updated_at: new Date().toISOString() };
    if (newStatus === 'resolved') updates.resolved_at = new Date().toISOString();
    await supabase.from('pending_arrivals').update(updates).eq('id', id);
    notify('‚úÖ ' + (lang === 'en' ? 'Updated' : 'Mis √† jour'));
    loadArrivals();
    if (reload) reload();
  };
  
  // Link to RMA
  const linkToRMA = async (arrivalId, rmaId) => {
    const arrival = arrivals.find(a => a.id === arrivalId);
    const rma = requests.find(r => r.id === rmaId);
    const isApproved = rma && ['quote_approved', 'received', 'in_service', 'calibration', 'repair', 'qc_check', 'ready_to_ship', 'shipped', 'completed'].includes(rma.status);
    
    await supabase.from('pending_arrivals').update({ 
      linked_rma_id: rmaId,
      status: isApproved ? 'resolved' : 'awaiting_approval',
      ...(isApproved ? { resolved_at: new Date().toISOString() } : {}),
      notes: (arrival?.notes || '') + '\nLinked to ' + (rma?.request_number || rmaId)
    }).eq('id', arrivalId);
    
    // Copy arrived_at to RMA
    if (arrival?.arrived_at) {
      await supabase.from('service_requests').update({ received_at: arrival.arrived_at }).eq('id', rmaId).is('received_at', null);
    }
    
    notify(lang === 'en' ? '‚úÖ Linked!' : '‚úÖ Li√© !');
    setShowRMALinker(null);
    setRmaSearch('');
    loadArrivals();
    if (reload) reload();
  };
  
  // Delete
  const deleteArrival = async (id) => {
    if (!window.confirm(lang === 'en' ? 'Delete this record?' : 'Supprimer cet enregistrement ?')) return;
    await supabase.from('pending_arrivals').delete().eq('id', id);
    notify(lang === 'en' ? 'üóëÔ∏è Deleted' : 'üóëÔ∏è Supprim√©');
    loadArrivals();
    if (reload) reload();
  };
  
  // Save notes
  const saveNotes = async (id) => {
    await supabase.from('pending_arrivals').update({ notes: notesText }).eq('id', id);
    setEditingNotes(null);
    loadArrivals();
  };
  
  // Days since
  const daysSince = (dateStr) => {
    if (!dateStr) return 0;
    return Math.floor((Date.now() - new Date(dateStr).getTime()) / (1000 * 60 * 60 * 24));
  };
  
  // Days since last reminder
  const daysSinceReminder = (arrival) => {
    if (!arrival.last_reminder_at) return Infinity;
    return Math.floor((Date.now() - new Date(arrival.last_reminder_at).getTime()) / (1000 * 60 * 60 * 24));
  };
  
  // Check if reminder is due
  const isReminderDue = (arrival) => {
    if (arrival.status !== 'followup_active') return false;
    const days = daysSinceReminder(arrival);
    const freq = arrival.reminder_frequency || 'weekly';
    if (freq === 'daily') return days >= 1;
    if (freq === 'every_3_days') return days >= 3;
    if (freq === 'weekly') return days >= 7;
    return false;
  };
  
  // Filter
  const filtered = arrivals.filter(a => {
    if (filter === 'active' && a.status === 'resolved') return false;
    if (filter === 'resolved' && a.status !== 'resolved') return false;
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      return (a.serial_number?.toLowerCase().includes(term) || a.model_name?.toLowerCase().includes(term) || a.companies?.name?.toLowerCase().includes(term) || a.contact_info?.toLowerCase().includes(term));
    }
    return true;
  });
  
  // Active RMAs for linking
  const activeRMAs = requests.filter(r => r.request_type !== 'parts' && !['completed', 'cancelled', 'archived'].includes(r.status));
  const filteredRMAs = rmaSearch.length >= 2 
    ? activeRMAs.filter(r => r.request_number?.toLowerCase().includes(rmaSearch.toLowerCase()) || r.companies?.name?.toLowerCase().includes(rmaSearch.toLowerCase()) || r.request_devices?.some(d => d.serial_number?.toLowerCase().includes(rmaSearch.toLowerCase()))).slice(0, 10)
    : activeRMAs.slice(0, 10);
  
  // Count reminders due
  const remindersDueCount = arrivals.filter(a => isReminderDue(a)).length;

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-gray-800">‚ö†Ô∏è {lang === 'en' ? 'Pending Arrivals' : 'R√©ceptions en attente'}</h2>
          <p className="text-sm text-gray-500">{lang === 'en' ? 'Track devices received without RMA or awaiting quote approval' : 'Suivi des appareils re√ßus sans RMA ou en attente d\'approbation de devis'}</p>
        </div>
        {remindersDueCount > 0 && (
          <div className="px-4 py-2 bg-orange-100 border border-orange-300 rounded-lg text-sm font-medium text-orange-700">
            üìß {remindersDueCount} {lang === 'en' ? 'reminder(s) due' : 'rappel(s) √† envoyer'}
          </div>
        )}
      </div>
      
      {/* ==================== SERIAL NUMBER ENTRY ==================== */}
      <div className="bg-white rounded-xl border-2 border-gray-200 p-4">
        <form onSubmit={handleScanSubmit} className="flex items-center gap-3">
          <span className="text-xl">üîç</span>
          <input
            type="text"
            value={scanInput}
            onChange={e => { setScanInput(e.target.value); setScanResult(null); setScanProcessed(false); }}
            placeholder={lang === 'en' ? 'Enter serial number...' : 'Entrer N¬∞ de s√©rie...'}
            className="flex-1 px-4 py-2.5 border rounded-lg font-mono text-base focus:border-[#00A651] focus:ring-1 focus:ring-[#00A651] outline-none"
          />
          <button 
            type="submit"
            disabled={scanning || !scanInput.trim()}
            className="px-5 py-2.5 bg-[#00A651] hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50 shrink-0"
          >
            {scanning ? '‚è≥...' : (lang === 'en' ? 'Check' : 'V√©rifier')}
          </button>
        </form>
        
        {/* Result */}
        {scanResult && (
          <div className={`mt-3 p-3 rounded-lg ${
            scanResult.type === 'normal' ? 'bg-green-50 border border-green-300 text-green-800' :
            scanResult.type === 'awaiting_approval' ? 'bg-purple-50 border border-purple-300 text-purple-800' :
            'bg-red-50 border border-red-300 text-red-800'
          }`}>
            <p className="font-medium text-sm">{scanResult.message}</p>
            {scanResult.company && (
              <p className="text-xs mt-1 opacity-75">{lang === 'en' ? 'Company:' : 'Soci√©t√© :'} {scanResult.company.name}</p>
            )}
            {scanProcessed && (
              <button 
                onClick={() => { setScanInput(''); setScanResult(null); setScanProcessed(false); }}
                className="mt-2 text-xs underline opacity-75 hover:opacity-100"
              >
                {lang === 'en' ? '+ Enter another' : '+ Entrer un autre'}
              </button>
            )}
          </div>
        )}
      </div>
      
      {/* ==================== FILTERS ==================== */}
      <div className="flex items-center gap-3">
        <div className="flex bg-gray-100 rounded-lg p-1">
          {[
            { id: 'active', label: lang === 'en' ? 'Active' : 'Actifs', count: arrivals.filter(a => a.status !== 'resolved').length },
            { id: 'resolved', label: lang === 'en' ? 'Resolved' : 'R√©solus' },
            { id: 'all', label: lang === 'en' ? 'All' : 'Tous' }
          ].map(f => (
            <button key={f.id} onClick={() => setFilter(f.id)} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${filter === f.id ? 'bg-white shadow text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}>
              {f.label} {f.count ? `(${f.count})` : ''}
            </button>
          ))}
        </div>
        <input 
          type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
          placeholder={`üîç ${lang === 'en' ? 'Search...' : 'Rechercher...'}`}
          className="flex-1 px-3 py-2 border rounded-lg text-sm"
        />
      </div>
      
      {/* ==================== LOADING ==================== */}
      {loading && (
        <div className="flex items-center justify-center py-12">
          <div className="w-8 h-8 border-2 border-[#00A651] border-t-transparent rounded-full animate-spin" />
        </div>
      )}
      
      {/* ==================== EMPTY STATE ==================== */}
      {!loading && filtered.length === 0 && (
        <div className="text-center py-12 bg-white rounded-xl border">
          <p className="text-4xl mb-3">{filter === 'resolved' ? '‚úÖ' : 'üì¶'}</p>
          <p className="text-gray-500">{filter === 'resolved' ? (lang === 'en' ? 'No resolved arrivals' : 'Aucune r√©ception r√©solue') : (lang === 'en' ? 'No pending arrivals ‚Äî all clear!' : 'Aucune r√©ception en attente !')}</p>
        </div>
      )}
      
      {/* ==================== ARRIVALS LIST ==================== */}
      {!loading && filtered.length > 0 && (
        <div className="space-y-3">
          {filtered.map(arrival => {
            const sc = statusConfig[arrival.status] || statusConfig.no_rma;
            const days = daysSince(arrival.arrived_at);
            const isUrgent = days > 7 && arrival.status !== 'resolved';
            const isExpanded = expandedId === arrival.id;
            const linkedRMA = arrival.linked_rma_id ? requests.find(r => r.id === arrival.linked_rma_id) : null;
            const reminderDue = isReminderDue(arrival);
            const isEditing = editingId === arrival.id;
            
            return (
              <div key={arrival.id} className={`bg-white rounded-xl border-2 overflow-hidden transition-all ${reminderDue ? 'border-orange-400 shadow-orange-100 shadow-md' : isUrgent ? 'border-red-300' : 'border-gray-200'}`}>
                {/* Main Row */}
                <div className="p-4 flex items-center gap-4 cursor-pointer hover:bg-gray-50" onClick={() => setExpandedId(isExpanded ? null : arrival.id)}>
                  {/* Urgency */}
                  {(isUrgent || reminderDue) && <div className={`w-2 h-12 rounded-full shrink-0 ${reminderDue ? 'bg-orange-500 animate-pulse' : 'bg-red-500'}`} />}
                  
                  {/* Date */}
                  <div className="w-24 shrink-0 text-center">
                    <p className="text-lg font-bold text-gray-800">{new Date(arrival.arrived_at).toLocaleDateString(lang === 'en' ? 'en-GB' : 'fr-FR', { day: '2-digit', month: 'short' })}</p>
                    <p className="text-xs text-gray-400">{days === 0 ? (lang === 'en' ? 'Today' : "Aujourd'hui") : days === 1 ? (lang === 'en' ? 'Yesterday' : 'Hier') : `${days}j`}</p>
                  </div>
                  
                  {/* Device */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2">
                      {arrival.serial_number && <span className="font-mono font-bold text-gray-800">{arrival.serial_number}</span>}
                      {arrival.model_name && <span className="text-sm text-gray-500">{arrival.model_name}</span>}
                    </div>
                    <div className="flex items-center gap-2 mt-1">
                      {arrival.companies?.name ? (
                        <span className="text-sm text-[#2D5A7B] font-medium">{arrival.companies.name}</span>
                      ) : (
                        <span className="text-sm text-red-500 italic">{lang === 'en' ? 'Unknown sender' : 'Exp√©diteur inconnu'}</span>
                      )}
                      {linkedRMA && <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-mono">‚Üí {linkedRMA.request_number}</span>}
                      {arrival.followup_email && <span className="text-xs text-gray-400">üìß {arrival.followup_email}</span>}
                      {arrival.reminder_count > 0 && <span className="text-xs text-orange-500">{arrival.reminder_count} rappel(s)</span>}
                    </div>
                  </div>
                  
                  {/* Reminder due badge */}
                  {reminderDue && (
                    <span className="px-2 py-1 bg-orange-500 text-white rounded-full text-xs font-bold animate-pulse shrink-0">
                      üìß {lang === 'en' ? 'REMINDER DUE' : 'RAPPEL √Ä ENVOYER'}
                    </span>
                  )}
                  
                  {/* Status */}
                  <span className={`px-3 py-1 rounded-full text-xs font-medium shrink-0 ${sc.color}`}>{sc.icon} {sc.label}</span>
                  
                  <svg className={`w-5 h-5 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                </div>
                
                {/* ==================== EXPANDED ==================== */}
                {isExpanded && (
                  <div className="border-t bg-gray-50 p-4">
                    {/* Info grid */}
                    <div className="grid grid-cols-4 gap-3 mb-4 text-sm">
                      <div><p className="text-xs text-gray-500">{lang === 'en' ? 'Arrived' : 'Arriv√©'}</p><p className="font-medium">{new Date(arrival.arrived_at).toLocaleDateString('fr-FR')}</p></div>
                      <div><p className="text-xs text-gray-500">{lang === 'en' ? 'Logged' : 'Enregistr√©'}</p><p>{new Date(arrival.created_at).toLocaleDateString('fr-FR')}</p></div>
                      {arrival.last_reminder_at && <div><p className="text-xs text-gray-500">{lang === 'en' ? 'Last reminder' : 'Dernier rappel'}</p><p>{new Date(arrival.last_reminder_at).toLocaleDateString('fr-FR')} ({daysSinceReminder(arrival)}j)</p></div>}
                      {arrival.reminder_frequency && <div><p className="text-xs text-gray-500">{lang === 'en' ? 'Frequency' : 'Fr√©quence'}</p><p>{reminderOptions.find(o => o.value === arrival.reminder_frequency)?.label || arrival.reminder_frequency}</p></div>}
                    </div>
                    
                    {/* Notes */}
                    <div className="mb-4">
                      <p className="text-xs text-gray-500 mb-1">Notes</p>
                      {editingNotes === arrival.id ? (
                        <div className="flex gap-2">
                          <textarea value={notesText} onChange={e => setNotesText(e.target.value)} className="flex-1 px-3 py-2 border rounded-lg text-sm" rows={3} />
                          <div className="flex flex-col gap-1">
                            <button onClick={() => saveNotes(arrival.id)} className="px-3 py-1 bg-green-500 text-white rounded text-xs">‚úì</button>
                            <button onClick={() => setEditingNotes(null)} className="px-3 py-1 bg-gray-200 rounded text-xs">‚úï</button>
                          </div>
                        </div>
                      ) : (
                        <p className="text-sm text-gray-600 cursor-pointer hover:bg-white p-2 rounded whitespace-pre-wrap" onClick={() => { setEditingNotes(arrival.id); setNotesText(arrival.notes || ''); }}>
                          {arrival.notes || <span className="italic text-gray-400">{lang === 'en' ? 'Click to add notes...' : 'Cliquer pour ajouter...'}</span>}
                        </p>
                      )}
                    </div>
                    
                    {/* ===== FOLLOW-UP SETUP (Phase 2 ‚Äî from computer) ===== */}
                    {arrival.status !== 'resolved' && arrival.status !== 'followup_active' && (
                      <div className="mb-4 p-4 bg-white rounded-lg border border-dashed border-gray-300">
                        {isEditing ? (
                          <div>
                            <h4 className="font-bold text-sm text-gray-700 mb-3">üìß {lang === 'en' ? 'Setup Follow-up' : 'Configurer le suivi'}</h4>
                            <div className="flex items-end gap-3">
                              <div className="flex-1">
                                <label className="block text-xs text-gray-500 mb-1">{lang === 'en' ? 'Email address *' : 'Adresse email *'}</label>
                                <input 
                                  type="email" 
                                  value={editForm.followup_email || arrival.companies?.email || ''} 
                                  onChange={e => setEditForm(prev => ({ ...prev, followup_email: e.target.value }))}
                                  placeholder="client@example.com"
                                  className="w-full px-3 py-2 border rounded-lg text-sm"
                                />
                              </div>
                              <div className="w-44">
                                <label className="block text-xs text-gray-500 mb-1">{lang === 'en' ? 'Reminder frequency' : 'Fr√©quence rappels'}</label>
                                <select 
                                  value={editForm.reminder_frequency || 'weekly'} 
                                  onChange={e => setEditForm(prev => ({ ...prev, reminder_frequency: e.target.value }))}
                                  className="w-full px-3 py-2 border rounded-lg text-sm"
                                >
                                  {reminderOptions.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                                </select>
                              </div>
                              <button onClick={() => startFollowUp(arrival)} className="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm font-bold shrink-0">
                                üöÄ {lang === 'en' ? 'Start Follow-up' : 'D√©marrer le suivi'}
                              </button>
                              <button onClick={() => { setEditingId(null); setEditForm({}); }} className="px-3 py-2 bg-gray-200 rounded-lg text-sm">‚úï</button>
                            </div>
                          </div>
                        ) : (
                          <button onClick={() => { setEditingId(arrival.id); setEditForm({ followup_email: arrival.companies?.email || '', reminder_frequency: 'weekly' }); }} className="w-full text-center py-2 text-sm text-gray-500 hover:text-orange-600 font-medium">
                            üìß {lang === 'en' ? 'Click to add contact info & start follow-up' : 'Cliquer pour ajouter les coordonn√©es & d√©marrer le suivi'}
                          </button>
                        )}
                      </div>
                    )}
                    
                    {/* ===== ACTIONS ===== */}
                    <div className="flex flex-wrap items-center gap-2">
                      {/* Send reminder (when follow-up is active) */}
                      {arrival.status === 'followup_active' && (
                        <button onClick={() => sendReminder(arrival)} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${reminderDue ? 'bg-orange-500 text-white hover:bg-orange-600 animate-pulse' : 'bg-orange-100 text-orange-700 hover:bg-orange-200'}`}>
                          üìß {lang === 'en' ? `Send Reminder #${(arrival.reminder_count || 0) + 1}` : `Envoyer Rappel #${(arrival.reminder_count || 0) + 1}`}
                        </button>
                      )}
                      
                      {/* Link to RMA */}
                      {arrival.status !== 'resolved' && !arrival.linked_rma_id && (
                        <>
                          {showRMALinker === arrival.id ? (
                            <div className="flex-1 min-w-64">
                              <div className="flex items-center gap-2 bg-white p-2 rounded-lg border">
                                <input type="text" value={rmaSearch} onChange={e => setRmaSearch(e.target.value)} placeholder={lang === 'en' ? 'Search RMA...' : 'Rechercher RMA...'} className="flex-1 px-2 py-1 border rounded text-sm" autoFocus />
                                <button onClick={() => { setShowRMALinker(null); setRmaSearch(''); }} className="text-gray-400 hover:text-gray-600">‚úï</button>
                              </div>
                              {filteredRMAs.length > 0 && (
                                <div className="mt-1 bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                  {filteredRMAs.map(r => (
                                    <button key={r.id} onClick={() => linkToRMA(arrival.id, r.id)} className="w-full text-left px-3 py-2 hover:bg-green-50 text-sm border-b last:border-b-0">
                                      <span className="font-mono font-bold text-[#2D5A7B]">{r.request_number}</span>
                                      <span className="text-gray-500 ml-2">{r.companies?.name}</span>
                                      <span className="text-xs text-gray-400 float-right">{r.status}</span>
                                    </button>
                                  ))}
                                </div>
                              )}
                            </div>
                          ) : (
                            <button onClick={() => setShowRMALinker(arrival.id)} className="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm font-medium hover:bg-green-200">üîó {lang === 'en' ? 'Link to RMA' : 'Lier √† un RMA'}</button>
                          )}
                        </>
                      )}
                      
                      {/* Resolve */}
                      {arrival.status !== 'resolved' && (
                        <button onClick={() => updateStatus(arrival.id, 'resolved')} className="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm font-medium hover:bg-green-200">‚úÖ {lang === 'en' ? 'Resolve' : 'R√©soudre'}</button>
                      )}
                      {arrival.status === 'resolved' && (
                        <button onClick={() => updateStatus(arrival.id, 'no_rma')} className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-200">‚Ü© {lang === 'en' ? 'Reopen' : 'Rouvrir'}</button>
                      )}
                      
                      {/* Delete */}
                      <button onClick={() => deleteArrival(arrival.id)} className="px-3 py-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg text-sm ml-auto">üóëÔ∏è</button>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// ============================================
// INVOICES SHEET - Full invoicing workflow v1
// ============================================
function InvoicesSheet({ requests, clients, notify, reload, profile, businessSettings, t = k=>k, lang = 'fr' }) {
  const [activeTab, setActiveTab] = useState('to_create');
  const [invoices, setInvoices] = useState([]);
  const [loading, setLoading] = useState(true);
  const [creatingFor, setCreatingFor] = useState(null);
  const [viewingInvoice, setViewingInvoice] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  
  // Export date range state
  const [exportFrom, setExportFrom] = useState('');
  const [exportTo, setExportTo] = useState('');
  const [exporting, setExporting] = useState(false);

  const biz = businessSettings || {};

  // Load invoices
  const loadInvoices = async () => {
    setLoading(true);
    const { data } = await supabase
      .from('invoices')
      .select('*, companies(name, email), service_requests(request_number, status, quote_data, quote_total, quote_number, bc_number, request_devices(*)), invoice_lines(*)')
      .order('created_at', { ascending: false });
    if (data) setInvoices(data);
    setLoading(false);
  };

  useEffect(() => { loadInvoices(); }, []);

  // RMAs ready for invoicing: all devices shipped, no invoice yet
  const invoicedRequestIds = new Set(invoices.map(inv => inv.request_id).filter(Boolean));
  
  const rmasToInvoice = (requests || []).filter(r => {
    if (!r.request_number || r.request_type === 'parts') return false;
    if (invoicedRequestIds.has(r.id)) return false;
    const devices = r.request_devices || [];
    if (devices.length === 0) return false;
    const allShipped = devices.every(d => ['shipped', 'completed', 'delivered'].includes(d.status));
    return allShipped || ['shipped', 'completed'].includes(r.status);
  });

  // Filter by search
  const filterItems = (items) => {
    if (!searchTerm) return items;
    const s = searchTerm.toLowerCase();
    return items.filter(i => 
      (i.invoice_number || '').toLowerCase().includes(s) ||
      (i.companies?.name || '').toLowerCase().includes(s) ||
      (i.service_requests?.request_number || '').toLowerCase().includes(s)
    );
  };

  const filterRMAs = (items) => {
    if (!searchTerm) return items;
    const s = searchTerm.toLowerCase();
    return items.filter(r =>
      (r.request_number || '').toLowerCase().includes(s) ||
      (r.companies?.name || '').toLowerCase().includes(s)
    );
  };

  const frenchDate = (dateStr) => {
    if (!dateStr) return '‚Äî';
    const d = new Date(dateStr);
    const months = lang === 'en' ? ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] : ['jan.', 'f√©v.', 'mars', 'avr.', 'mai', 'juin', 'juil.', 'ao√ªt', 'sept.', 'oct.', 'nov.', 'd√©c.'];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
  };

  // Filter invoices by date range for display and export
  const getFilteredInvoices = () => {
    let filtered = filterItems(invoices);
    if (exportFrom) {
      const fromDate = new Date(exportFrom);
      fromDate.setHours(0, 0, 0, 0);
      filtered = filtered.filter(inv => new Date(inv.created_at) >= fromDate);
    }
    if (exportTo) {
      const toDate = new Date(exportTo);
      toDate.setHours(23, 59, 59, 999);
      filtered = filtered.filter(inv => new Date(inv.created_at) <= toDate);
    }
    return filtered;
  };

  // Export invoices as ZIP (PDFs + Excel summary)
  const exportInvoices = async () => {
    const toExport = getFilteredInvoices();
    if (toExport.length === 0) {
      notify(lang === 'en' ? 'No invoices to export for this period' : 'Aucune facture √† exporter pour cette p√©riode', 'error');
      return;
    }
    
    setExporting(true);
    try {
      // Load JSZip
      if (!window.JSZip) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      
      // Load SheetJS for Excel
      if (!window.XLSX) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      
      const zip = new window.JSZip();
      const pdfFolder = zip.folder('factures');
      
      // Build Excel summary data
      const summaryData = [];
      let pdfCount = 0;
      
      for (const inv of toExport) {
        // Add to summary
        summaryData.push({
          [lang === 'en' ? 'Invoice #' : 'N¬∞ Facture']: inv.invoice_number || '',
          [lang === 'en' ? 'Created Date' : 'Date Cr√©ation']: inv.created_at ? new Date(inv.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : '',
          [lang === 'en' ? 'Invoice Date' : 'Date Facture']: inv.invoice_date ? new Date(inv.invoice_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR') : '',
          [lang === 'en' ? 'Client' : 'Client']: inv.companies?.name || '',
          [lang === 'en' ? 'RMA #' : 'N¬∞ RMA']: inv.service_requests?.request_number || '',
          [lang === 'en' ? 'Total excl. tax' : 'Total HT']: parseFloat(inv.total_ht || 0).toFixed(2),
          [lang === 'en' ? 'VAT' : 'TVA']: parseFloat(inv.total_tva || 0).toFixed(2),
          [lang === 'en' ? 'Total incl. tax' : 'Total TTC']: parseFloat(inv.total_ttc || 0).toFixed(2),
          [lang === 'en' ? 'Status' : 'Statut']: inv.status || ''
        });
        
        // Try to fetch PDF
        if (inv.pdf_url) {
          try {
            const response = await fetch(inv.pdf_url);
            if (response.ok) {
              const blob = await response.blob();
              const fileName = `${inv.invoice_number || 'facture'}.pdf`;
              pdfFolder.file(fileName, blob);
              pdfCount++;
            }
          } catch (e) {
            console.error('PDF fetch error:', inv.invoice_number, e);
          }
        }
      }
      
      // Create Excel summary
      const ws = window.XLSX.utils.json_to_sheet(summaryData);
      const wb = window.XLSX.utils.book_new();
      window.XLSX.utils.book_append_sheet(wb, ws, (lang === 'en' ? 'Invoices' : 'Factures'));
      
      // Set column widths
      ws['!cols'] = [
        { wch: 15 }, // N¬∞ Facture
        { wch: 12 }, // Date Cr√©ation
        { wch: 12 }, // Date Facture
        { wch: 25 }, // Client
        { wch: 12 }, // N¬∞ RMA
        { wch: 12 }, // Total HT
        { wch: 10 }, // TVA
        { wch: 12 }, // Total TTC
        { wch: 10 }  // Statut
      ];
      
      const excelBuffer = window.XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      zip.file('resume_factures.xlsx', excelBuffer);
      
      // Generate ZIP and download
      const dateRange = exportFrom && exportTo 
        ? `${exportFrom}_au_${exportTo}` 
        : exportFrom 
        ? `depuis_${exportFrom}` 
        : exportTo 
        ? `jusqua_${exportTo}` 
        : new Date().toISOString().split('T')[0];
      
      const zipBlob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(zipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `factures_${dateRange}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      notify(lang === 'en' ? `‚úÖ Export complete: ${toExport.length} invoice(s), ${pdfCount} PDF(s)` : `‚úÖ Export termin√©: ${toExport.length} facture(s), ${pdfCount} PDF(s)`);
    } catch (err) {
      console.error('Export error:', err);
      notify((lang === 'en' ? 'Export error: ' : "Erreur lors de l'export: ") + (err.message || 'Error'), 'error');
    }
    setExporting(false);
  };

  const tabs = [
    { id: 'to_create', label: lang === 'en' ? 'To Invoice' : '√Ä Facturer', icon: 'üîî', count: rmasToInvoice.length, color: 'amber' },
    { id: 'invoices', label: lang === 'en' ? 'Invoices' : 'Factures', icon: 'üìÑ', count: invoices.length, color: 'blue' }
  ];

  // Stats
  const totalInvoiced = invoices.reduce((s, i) => s + (parseFloat(i.total_ttc) || 0), 0);
  const filteredInvoices = getFilteredInvoices();
  const filteredTotal = filteredInvoices.reduce((s, i) => s + (parseFloat(i.total_ttc) || 0), 0);

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-3">
            <span className="w-10 h-10 bg-[#00A651] rounded-xl flex items-center justify-center text-white">üí∂</span>
            Facturation
          </h1>
          <p className="text-gray-500 mt-1">{lang === 'en' ? 'Create and manage invoices' : 'Cr√©er et g√©rer les factures'}</p>
        </div>
        <div className="flex items-center gap-3">
          <input
            type="text"
            placeholder={lang === 'en' ? 'üîç Search...' : 'üîç Rechercher...'}
            value={searchTerm}
            onChange={e => setSearchTerm(e.target.value)}
            className="px-4 py-2 border border-gray-300 rounded-lg w-64"
          />
        </div>
      </div>

      {/* Quick Stats */}
      <div className="grid grid-cols-3 gap-4">
        <div className="bg-white rounded-xl shadow-sm p-4 border-l-4 border-amber-400">
          <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'To invoice' : '√Ä facturer'}</p>
          <p className="text-2xl font-bold text-amber-600">{rmasToInvoice.length}</p>
        </div>
        <div className="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-400">
          <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Invoices created' : 'Factures cr√©√©es'}</p>
          <p className="text-2xl font-bold text-blue-600">{invoices.length}</p>
        </div>
        <div className="bg-white rounded-xl shadow-sm p-4 border-l-4 border-green-400">
          <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Total invoiced' : 'Total factur√©'}</p>
          <p className="text-2xl font-bold text-green-600">{totalInvoiced.toFixed(0)} ‚Ç¨</p>
        </div>
      </div>

      {/* Tabs */}
      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        <div className="border-b flex">
          {tabs.map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)}
              className={`px-6 py-3 font-medium flex items-center gap-2 border-b-2 -mb-px transition-colors ${
                activeTab === tab.id ? 'border-[#00A651] text-[#00A651]' : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}>
              <span>{tab.icon}</span> {tab.label}
              {tab.count > 0 && (
                <span className={`ml-1 px-2 py-0.5 rounded-full text-xs font-bold ${
                  tab.color === 'amber' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'
                }`}>{tab.count}</span>
              )}
            </button>
          ))}
        </div>

        <div className="p-4">
          {loading ? (
            <div className="text-center py-12 text-gray-400">
              <div className="animate-spin text-3xl mb-2">‚è≥</div>{lang === 'en' ? 'Loading...' : 'Chargement...'}
            </div>
          ) : (
            <>
              {/* ========== TAB 1: √Ä Facturer ========== */}
              {activeTab === 'to_create' && (
                <div className="space-y-3">
                  {filterRMAs(rmasToInvoice).length === 0 ? (
                    <div className="text-center py-12 text-gray-400">
                      <div className="text-4xl mb-2">‚úÖ</div>
                      <p>{lang === 'en' ? 'No RMAs awaiting invoicing' : 'Aucune RMA en attente de facturation'}</p>
                    </div>
                  ) : (
                    filterRMAs(rmasToInvoice).map(rma => {
                      const devices = rma.request_devices || [];
                      const total = rma.quote_total || devices.reduce((s, d) => s + (parseFloat(d.quoted_price) || parseFloat(d.unit_price) || 0), 0);
                      const supplementTotal = devices.reduce((s, d) => {
                        if (!d.additional_work_needed || !d.additional_work_items) return s;
                        return s + d.additional_work_items.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
                      }, 0);
                      return (
                        <div key={rma.id} className="flex items-center gap-4 p-4 border rounded-xl hover:bg-amber-50 hover:border-amber-200 transition-all group">
                          <div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-700 font-bold text-sm shrink-0">‚Ç¨</div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <span className="font-bold text-[#00A651]">{rma.request_number}</span>
                              <span className="text-gray-400">‚Äî</span>
                              <span className="font-medium text-gray-700">{rma.companies?.name}</span>
                            </div>
                            <div className="text-sm text-gray-500">
                              {devices.length} {lang === 'en' ? 'device(s) ‚Ä¢ Shipped:' : 'appareil(s) ‚Ä¢ Exp√©di√©:'} {frenchDate(rma.shipped_at || rma.updated_at)}
                            </div>
                          </div>
                          <div className="text-right shrink-0">
                            <p className="font-bold text-gray-800">{total.toFixed(2)} ‚Ç¨ HT</p>
                            {supplementTotal > 0 && (
                              <p className="text-xs text-orange-600">+ {supplementTotal.toFixed(2)} ‚Ç¨ suppl√©ment</p>
                            )}
                          </div>
                          <button onClick={() => setCreatingFor(rma)}
                            className="px-4 py-2 bg-[#00A651] hover:bg-[#008a43] text-white rounded-lg font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                            üí∂ Cr√©er Facture
                          </button>
                        </div>
                      );
                    })
                  )}
                </div>
              )}

              {/* ========== TAB 2: Toutes les Factures ========== */}
              {activeTab === 'invoices' && (
                <div className="space-y-4">
                  {/* Date range filter + Export */}
                  <div className="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                    <div className="flex items-center gap-2">
                      <label className="text-sm text-gray-600 font-medium">{lang === 'en' ? 'From:' : 'Du:'}</label>
                      <input
                        type="date"
                        value={exportFrom}
                        onChange={e => setExportFrom(e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                      />
                    </div>
                    <div className="flex items-center gap-2">
                      <label className="text-sm text-gray-600 font-medium">{lang === 'en' ? 'To:' : 'Au:'}</label>
                      <input
                        type="date"
                        value={exportTo}
                        onChange={e => setExportTo(e.target.value)}
                        className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                      />
                    </div>
                    {(exportFrom || exportTo) && (
                      <button
                        onClick={() => { setExportFrom(''); setExportTo(''); }}
                        className="px-3 py-2 text-gray-500 hover:text-gray-700 text-sm"
                      >
                        ‚úï Effacer
                      </button>
                    )}
                    <div className="flex-1" />
                    <div className="text-sm text-gray-600">
                      <span className="font-medium">{filteredInvoices.length}</span> {lang === 'en' ? 'invoice(s) ‚Ä¢ ' : 'facture(s) ‚Ä¢ '}
                      <span className="font-medium text-green-600 ml-1">{filteredTotal.toFixed(2)} ‚Ç¨</span>
                    </div>
                    <button
                      onClick={exportInvoices}
                      disabled={exporting || filteredInvoices.length === 0}
                      className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
                    >
                      {exporting ? (
                        <><span className="animate-spin">‚è≥</span> Export en cours...</>
                      ) : (
                        <>{lang === 'en' ? 'üì• Export ZIP' : 'üì• Exporter ZIP'}</>
                      )}
                    </button>
                  </div>

                  {/* Invoice list */}
                  {filteredInvoices.length === 0 ? (
                    <div className="text-center py-12 text-gray-400">
                      <div className="text-4xl mb-2">üìÇ</div>
                      <p>{lang === 'en' ? `No invoices ${(exportFrom || exportTo) ? 'for this period' : ''}` : `Aucune facture ${(exportFrom || exportTo) ? 'pour cette p√©riode' : ''}`}</p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {filteredInvoices.map(inv => (
                        <div key={inv.id} onClick={() => setViewingInvoice(inv)}
                          className="flex items-center gap-3 p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all">
                          <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 shrink-0">üìÑ</div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <span className="font-bold text-gray-800">{inv.invoice_number}</span>
                              <span className="text-gray-400">‚Äî</span>
                              <span className="font-medium text-gray-700">{inv.companies?.name || 'Client'}</span>
                              {inv.service_requests?.request_number && (
                                <span className="text-xs text-gray-400">RMA {inv.service_requests.request_number}</span>
                              )}
                            </div>
                            <div className="flex items-center gap-3 text-xs text-gray-500 mt-1">
                              <span>{lang === 'en' ? 'Created:' : 'Cr√©√©e:'} {frenchDate(inv.created_at)}</span>
                              <span>{lang === 'en' ? 'Invoice date:' : 'Date facture:'} {frenchDate(inv.invoice_date)}</span>
                            </div>
                          </div>
                          <div className="text-right shrink-0 w-28">
                            <p className="font-bold text-gray-800">{parseFloat(inv.total_ttc || 0).toFixed(2)} ‚Ç¨</p>
                            <p className="text-xs text-gray-400">{lang === 'en' ? 'incl. VAT' : 'TTC'}</p>
                          </div>
                          {inv.pdf_url && (
                            <a href={inv.pdf_url} target="_blank" rel="noopener noreferrer"
                              onClick={e => e.stopPropagation()}
                              className="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm">
                              üìÑ PDF
                            </a>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </>
          )}
        </div>
      </div>

      {/* Invoice Creation Modal */}
      {creatingFor && (
        <InvoiceCreationModal lang={lang} rma={creatingFor} onClose={() => setCreatingFor(null)} notify={notify}
          reload={() => { loadInvoices(); if (reload) reload(); }} profile={profile} businessSettings={businessSettings} t={t} lang={lang} />
      )}

      {/* Invoice Detail Modal */}
      {viewingInvoice && (
        <InvoiceDetailModal lang={lang} invoice={viewingInvoice} onClose={() => { setViewingInvoice(null); loadInvoices(); }}
          notify={notify} reload={() => { loadInvoices(); if (reload) reload(); }} businessSettings={businessSettings} t={t} lang={lang} />
      )}
    </div>
  );
}


// ============================================
// INVOICE DETAIL MODAL - View/manage invoice
// ============================================
function InvoiceDetailModal({ invoice, onClose, notify, reload, businessSettings, lang = 'fr' }) {
  const t = k => k;
  const [inv, setInv] = useState(invoice);
  const [showPayment, setShowPayment] = useState(false);
  const [paymentAmount, setPaymentAmount] = useState('');
  const [paymentRef, setPaymentRef] = useState('');
  const [paymentDate, setPaymentDate] = useState(new Date().toISOString().split('T')[0]);

  const invoiceLines = inv.invoice_lines || [];
  const company = inv.companies || {};
  const rma = inv.service_requests || {};
  
  const isOverdue = inv.due_date && !['paid', 'cancelled'].includes(inv.status) && new Date(inv.due_date) < new Date();
  const daysPastDue = inv.due_date ? Math.max(0, Math.floor((new Date() - new Date(inv.due_date)) / (1000 * 60 * 60 * 24))) : 0;
  const remaining = (parseFloat(inv.total_ttc) || 0) - (parseFloat(inv.paid_amount) || 0);

  const frenchDate = (dateStr) => {
    if (!dateStr) return '‚Äî';
    const d = new Date(dateStr);
    const months = lang === 'en' ? ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] : ['jan.', 'f√©v.', 'mars', 'avr.', 'mai', 'juin', 'juil.', 'ao√ªt', 'sept.', 'oct.', 'nov.', 'd√©c.'];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
  };

  const getStatusBadge = () => {
    if (inv.status === 'paid') return <span className="px-3 py-1.5 bg-green-100 text-green-700 rounded-full text-sm font-bold">{lang === 'en' ? '‚úÖ Paid' : '‚úÖ Pay√©e'}</span>;
    if (inv.status === 'cancelled') return <span className="px-3 py-1.5 bg-gray-100 text-gray-500 rounded-full text-sm font-bold">{lang === 'en' ? 'Cancelled' : 'Annul√©e'}</span>;
    if (inv.status === 'partially_paid') return <span className="px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold">{lang === 'en' ? '‚ö†Ô∏è Partial payment' : '‚ö†Ô∏è Paiement partiel'}</span>;
    if (isOverdue) return <span className="px-3 py-1.5 bg-red-100 text-red-700 rounded-full text-sm font-bold animate-pulse">{lang === 'en' ? 'üî¥ Overdue' : 'üî¥ En retard'} ({daysPastDue}{lang === 'en' ? 'd' : 'j'})</span>;
    if (inv.status === 'sent') return <span className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm font-bold">{lang === 'en' ? 'üì§ Sent' : 'üì§ Envoy√©e'}</span>;
    if (inv.status === 'created' || inv.status === 'draft') return <span className="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-full text-sm font-bold">{lang === 'en' ? 'üìÑ Created' : 'üìÑ Cr√©√©e'}</span>;
    return <span className="px-3 py-1.5 bg-blue-100 text-blue-600 rounded-full text-sm font-bold">{lang === 'en' ? 'üìã In progress' : 'üìã En cours'}</span>;
  };

  const markAsSent = async () => {
    const { error } = await supabase.from('invoices').update({ status: 'sent', sent_at: new Date().toISOString() }).eq('id', inv.id);
    if (!error) { setInv({ ...inv, status: 'sent', sent_at: new Date().toISOString() }); notify(lang === 'en' ? '‚úÖ Invoice marked as sent' : '‚úÖ Facture marqu√©e comme envoy√©e'); if (reload) reload(); }
  };

  const recordPayment = async () => {
    const amount = parseFloat(paymentAmount);
    if (!amount || amount <= 0) { notify('Montant invalide', 'error'); return; }
    const prevPaid = parseFloat(inv.paid_amount) || 0;
    const newPaid = prevPaid + amount;
    const totalDue = parseFloat(inv.total_ttc) || 0;
    const isFullyPaid = newPaid >= totalDue - 0.02;
    const updates = {
      paid_amount: Math.min(newPaid, totalDue),
      payment_reference: [inv.payment_reference, paymentRef].filter(Boolean).join(', '),
      paid_at: paymentDate || new Date().toISOString().split('T')[0],
      status: isFullyPaid ? 'paid' : 'partially_paid'
    };
    const { error } = await supabase.from('invoices').update(updates).eq('id', inv.id);
    if (!error) {
      setInv({ ...inv, ...updates });
      setShowPayment(false); setPaymentAmount(''); setPaymentRef('');
      notify(isFullyPaid ? (lang === 'en' ? '‚úÖ Invoice fully paid!' : '‚úÖ Facture pay√©e en totalit√©!') : (lang === 'en' ? `‚úÖ Payment of ${amount.toFixed(2)} ‚Ç¨ recorded` : `‚úÖ Paiement de ${amount.toFixed(2)} ‚Ç¨ enregistr√©`));
      if (reload) reload();
    }
  };

  const cancelInvoice = async () => {
    if (!confirm(lang === 'en' ? `Cancel invoice ${inv.invoice_number}? This action is irreversible.` : `Annuler la facture ${inv.invoice_number} ? Cette action est irr√©versible.`)) return;
    const { error } = await supabase.from('invoices').update({ status: 'cancelled' }).eq('id', inv.id);
    if (!error) { notify(lang === 'en' ? 'Invoice cancelled' : 'Facture annul√©e'); if (reload) reload(); onClose(); }
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
      <div className="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="px-6 py-4 bg-gradient-to-r from-[#2D5A7B] to-[#2a5490] text-white flex items-center justify-between">
          <div>
            <h2 className="text-xl font-bold">{inv.invoice_number}</h2>
            <p className="text-sm text-white/70">{company.name || 'Client'} {rma.request_number ? `‚Ä¢ RMA ${rma.request_number}` : ''}</p>
          </div>
          <div className="flex items-center gap-3">
            {getStatusBadge()}
            <button onClick={onClose} className="text-white/80 hover:text-white text-2xl">√ó</button>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* Overdue Alert */}
          {isOverdue && (
            <div className="bg-red-50 border border-red-200 rounded-lg p-3 flex items-center gap-3">
              <span className="text-red-500 text-xl animate-pulse">üî¥</span>
              <div>
                <p className="text-red-800 font-bold">{lang === 'en' ? `Invoice overdue ‚Äî ${daysPastDue} day${daysPastDue > 1 ? 's' : ''}` : `Facture en retard ‚Äî ${daysPastDue} jour${daysPastDue > 1 ? 's' : ''}`}</p>
                <p className="text-red-600 text-sm">{lang === 'en' ? 'Due:' : '√âch√©ance:'} {frenchDate(inv.due_date)} ‚Ä¢ {lang === 'en' ? 'Remaining:' : 'Reste d√ª:'} {remaining.toFixed(2)} ‚Ç¨</p>
              </div>
            </div>
          )}

          {/* Info Grid */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-gray-50 rounded-lg p-3">
              <p className="text-xs text-gray-500">{lang === 'en' ? 'Issue date' : 'Date √©mission'}</p>
              <p className="font-medium">{frenchDate(inv.invoice_date)}</p>
            </div>
            <div className="bg-gray-50 rounded-lg p-3">
              <p className="text-xs text-gray-500">{lang === 'en' ? 'Due date' : '√âch√©ance'}</p>
              <p className={`font-medium ${isOverdue ? 'text-red-600' : ''}`}>{frenchDate(inv.due_date)}</p>
            </div>
            <div className="bg-gray-50 rounded-lg p-3">
              <p className="text-xs text-gray-500">{t('totalTTC')}</p>
              <p className="font-bold text-lg">{parseFloat(inv.total_ttc || 0).toFixed(2)} ‚Ç¨</p>
            </div>
            <div className={`rounded-lg p-3 ${remaining <= 0.01 ? 'bg-green-50' : 'bg-amber-50'}`}>
              <p className="text-xs text-gray-500">{lang === 'en' ? 'Remaining due' : 'Reste d√ª'}</p>
              <p className={`font-bold text-lg ${remaining <= 0.01 ? 'text-green-700' : 'text-amber-700'}`}>
                {remaining > 0.01 ? remaining.toFixed(2) + ' ‚Ç¨' : '0.00 ‚Ç¨ ‚úÖ'}
              </p>
            </div>
          </div>

          {/* References */}
          <div className="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
            {inv.client_ref && <div><span className="text-gray-500">{lang === 'en' ? 'Your ref:' : 'Vos r√©f:'}</span> <span className="font-medium">{inv.client_ref}</span></div>}
            {rma.request_number && <div><span className="text-gray-500">{lang === 'en' ? 'RMA:' : 'RMA:'}</span> <span className="font-medium">{rma.request_number}</span></div>}
            {rma.quote_number && <div><span className="text-gray-500">{lang === 'en' ? 'Quote:' : 'Devis:'}</span> <span className="font-medium">{rma.quote_number}</span></div>}
            {rma.bc_number && <div><span className="text-gray-500">{lang === 'en' ? 'PO:' : 'BC:'}</span> <span className="font-medium">{rma.bc_number}</span></div>}
            {inv.sent_at && <div><span className="text-gray-500">{lang === 'en' ? 'Sent:' : 'Envoy√©e:'}</span> <span className="font-medium">{frenchDate(inv.sent_at)}</span></div>}
            {inv.paid_at && <div><span className="text-gray-500">{lang === 'en' ? 'Paid on:' : 'Pay√©e le:'}</span> <span className="font-medium text-green-700">{frenchDate(inv.paid_at)}</span></div>}
            {inv.payment_reference && <div className="col-span-2"><span className="text-gray-500">{lang === 'en' ? 'Payment ref:' : 'R√©f. paiement:'}</span> <span className="font-medium">{inv.payment_reference}</span></div>}
          </div>

          {/* Line Items */}
          <div>
            <h4 className="font-medium text-gray-700 mb-2 text-sm">{lang === 'en' ? 'Invoice lines' : 'Lignes de facturation'}</h4>
            <div className="border rounded-lg overflow-hidden">
              <table className="w-full text-sm">
                <thead className="bg-[#2D5A7B] text-white">
                  <tr>
                    <th className="text-left p-2 text-xs">{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
                    <th className="text-left p-2 text-xs">{lang === 'en' ? 'Description' : 'D√©signation'}</th>
                    <th className="text-right p-2 text-xs">{lang === 'en' ? 'U.P. excl.' : 'P.U. HT'}</th>
                    <th className="text-right p-2 text-xs">{t('totalHT')}</th>
                  </tr>
                </thead>
                <tbody>
                  {invoiceLines.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0)).map((line, idx) => (
                    <tr key={idx} className={line.line_type === 'device_header' ? 'bg-blue-50 font-bold' : idx % 2 === 0 ? 'bg-gray-50' : ''}>
                      <td className="p-2 text-xs">{line.line_type === 'device_header' ? '' : (line.quantity || 1)}</td>
                      <td className="p-2 text-xs">{line.description}</td>
                      <td className="p-2 text-xs text-right">{line.line_type === 'device_header' ? '' : (parseFloat(line.unit_price_ht || 0).toFixed(2) + ' ‚Ç¨')}</td>
                      <td className="p-2 text-xs text-right font-medium">{line.line_type === 'device_header' ? '' : (parseFloat(line.total_ht || 0).toFixed(2) + ' ‚Ç¨')}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="border-t bg-gray-50 p-3 space-y-1">
                <div className="flex justify-between text-sm">
                  <span className="text-gray-500">{t('totalHT')}</span>
                  <span className="font-medium">{parseFloat(inv.subtotal_ht || 0).toFixed(2)} ‚Ç¨</span>
                </div>
                <div className="flex justify-between text-sm">
                  <span className="text-gray-500">{inv.is_tva_exonerated ? (lang === 'en' ? 'VAT (exempt)' : 'TVA (exon√©r√©e)') : `TVA ${inv.tva_rate || 20}%`}</span>
                  <span className="font-medium">{inv.is_tva_exonerated ? (lang === 'en' ? 'EXEMPT' : 'EXON√âR√â') : (parseFloat(inv.tva_amount || 0).toFixed(2) + ' ‚Ç¨')}</span>
                </div>
                <div className="flex justify-between pt-1 border-t">
                  <span className="font-bold text-[#2D5A7B]">{t('totalTTC')}</span>
                  <span className="font-bold text-lg text-[#2D5A7B]">{parseFloat(inv.total_ttc || 0).toFixed(2)} ‚Ç¨</span>
                </div>
                {parseFloat(inv.paid_amount) > 0 && (
                  <div className="flex justify-between text-green-700"><span>{t('paid')}</span><span className="font-bold">-{parseFloat(inv.paid_amount).toFixed(2)} ‚Ç¨</span></div>
                )}
                {remaining > 0.01 && inv.status !== 'cancelled' && (
                  <div className="flex justify-between text-amber-700 font-bold"><span>{lang === 'en' ? 'Remaining due' : 'Reste d√ª'}</span><span>{remaining.toFixed(2)} ‚Ç¨</span></div>
                )}
              </div>
            </div>
          </div>

          {/* Payment Recording */}
          {showPayment && (
            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
              <h4 className="font-bold text-green-800 mb-3">{lang === 'en' ? 'üí∞ Record a payment' : 'üí∞ Enregistrer un paiement'}</h4>
              <div className="grid grid-cols-3 gap-3">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">{lang === 'en' ? 'Amount (‚Ç¨)' : 'Montant (‚Ç¨)'}</label>
                  <input type="number" step="0.01" value={paymentAmount} onChange={e => setPaymentAmount(e.target.value)}
                    placeholder={remaining.toFixed(2)} className="w-full px-3 py-2 border rounded-lg text-lg font-bold" autoFocus />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">{lang === 'en' ? 'Payment date' : 'Date du paiement'}</label>
                  <input type="date" value={paymentDate} onChange={e => setPaymentDate(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">{lang === 'en' ? 'Payment ref' : 'R√©f. paiement'}</label>
                  <input type="text" value={paymentRef} onChange={e => setPaymentRef(e.target.value)} placeholder={lang === 'en' ? 'Wire transfer, check #...' : 'Virement, ch√®que n¬∞...'} className="w-full px-3 py-2 border rounded-lg" />
                </div>
              </div>
              <div className="flex gap-2 mt-3">
                <button onClick={recordPayment} className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">{lang === 'en' ? '‚úÖ Save' : '‚úÖ Enregistrer'}</button>
                <button onClick={() => setPaymentAmount(remaining.toFixed(2))} className="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-800 rounded-lg text-sm font-medium">Solder ({remaining.toFixed(2)} ‚Ç¨)</button>
                <button onClick={() => setShowPayment(false)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">{t('cancel')}</button>
              </div>
            </div>
          )}

          {inv.notes && (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
              <p className="text-sm text-yellow-800"><strong>{lang === 'en' ? 'Notes:' : 'Notes:'}</strong> {inv.notes}</p>
            </div>
          )}
        </div>

        {/* Footer Actions */}
        <div className="px-6 py-4 border-t bg-gray-50 flex items-center justify-between rounded-b-2xl">
          <div className="flex items-center gap-2">
            {inv.pdf_url && (
              <a href={inv.pdf_url} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-[#2D5A7B] hover:bg-[#2a5490] text-white rounded-lg font-medium text-sm flex items-center gap-1">{lang === 'en' ? 'üìÑ PDF' : 'üìÑ PDF'}</a>
            )}
            {inv.status !== 'paid' && inv.status !== 'cancelled' && (
              <button onClick={cancelInvoice} className="px-4 py-2 bg-gray-200 hover:bg-red-100 text-gray-600 hover:text-red-600 rounded-lg text-sm font-medium">{lang === 'en' ? 'üóëÔ∏è Cancel' : 'üóëÔ∏è Annuler'}</button>
            )}
          </div>
          <div className="flex items-center gap-2">
            {(inv.status === 'created' || inv.status === 'draft') && (
              <button onClick={markAsSent} className="px-5 py-2 bg-[#00A651] hover:bg-[#008a43] text-white rounded-lg font-medium text-sm">{lang === 'en' ? 'üì§ Send to client' : 'üì§ Envoyer au client'}</button>
            )}
            {inv.status !== 'paid' && inv.status !== 'cancelled' && (
              <button onClick={() => { setShowPayment(true); setPaymentAmount(remaining.toFixed(2)); }} className="px-5 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium text-sm">{lang === 'en' ? 'üí∞ Record payment' : 'üí∞ Enregistrer paiement'}</button>
            )}
            <button onClick={onClose} className="px-5 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium text-sm">{t('close')}</button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// INVOICE CREATION MODAL
// ============================================
function InvoiceCreationModal({ rma, onClose, notify, reload, profile, businessSettings, lang = 'fr' }) {
  const t = k => k;
  const [step, setStep] = useState(1); // 1=Edit lines, 2=Preview, 3=Saved
  const [lines, setLines] = useState([]);
  const [saving, setSaving] = useState(false);
  const [clientRef, setClientRef] = useState('');
  const [clientTVA, setClientTVA] = useState('');
  const [isExonerated, setIsExonerated] = useState(false);
  const [paymentTermsDays, setPaymentTermsDays] = useState(businessSettings?.payment_terms_days || 30);
  const [notes, setNotes] = useState('');
  const [savedInvoice, setSavedInvoice] = useState(null);
  const [shippingPrice, setShippingPrice] = useState(0);

  const biz = businessSettings || {};
  const company = rma.companies || {};
  const devices = rma.request_devices || [];
  const quoteData = rma.quote_data || {};

  // Build initial line items from quote_data + supplement data
  useEffect(() => {
    const newLines = [];
    let sortOrder = 0;

    // Get quoted devices from quote_data
    const quotedDevices = quoteData.devices || [];

    devices.forEach(device => {
      const qd = quotedDevices.find(q => q.serial === device.serial_number) || {};
      
      // Device header
      newLines.push({
        id: `hdr-${device.id}`,
        deviceId: device.id,
        lineType: 'device_header',
        description: `${device.model_name || device.model || (lang === 'en' ? 'Device' : 'Appareil')} ‚Äî SN: ${device.serial_number}`,
        quantity: null,
        unitPrice: null,
        total: null,
        isDevice: true,
        sortOrder: sortOrder++
      });

      // Calibration
      if (qd.needsCalibration || (device.service_type || '').includes('calibration')) {
        const price = parseFloat(qd.calibrationPrice) || parseFloat(device.quoted_price) || 0;
        newLines.push({
          id: `cal-${device.id}`,
          deviceId: device.id,
          lineType: 'calibration',
          description: `${lang === 'en' ? 'Calibration' : '√âtalonnage'}${qd.calPartNumber ? ' (' + qd.calPartNumber + ')' : ''}`,
          quantity: 1,
          unitPrice: price,
          total: price,
          sortOrder: sortOrder++
        });
      }

      // Repair
      if (qd.needsRepair || (device.service_type || '').includes('repair')) {
        const price = parseFloat(qd.repairPrice) || 0;
        if (price > 0) {
          newLines.push({
            id: `rep-${device.id}`,
            deviceId: device.id,
            lineType: 'repair',
            description: `${lang === 'en' ? 'Repair' : 'R√©paration'}${qd.repairPartNumber ? ' (' + qd.repairPartNumber + ')' : ''}`,
            quantity: 1,
            unitPrice: price,
            total: price,
            sortOrder: sortOrder++
          });
        }
      }

      // Cleaning (nettoyage)
      if (qd.needsNettoyage && qd.nettoyagePrice > 0) {
        newLines.push({
          id: `net-${device.id}`,
          deviceId: device.id,
          lineType: 'cleaning',
          description: `Nettoyage cellule${qd.nettoyagePartNumber ? ' (' + qd.nettoyagePartNumber + ')' : ''}`,
          quantity: 1,
          unitPrice: parseFloat(qd.nettoyagePrice),
          total: parseFloat(qd.nettoyagePrice),
          sortOrder: sortOrder++
        });
      }

      // Additional parts from quote
      if (qd.additionalParts && qd.additionalParts.length > 0) {
        qd.additionalParts.forEach((part, pi) => {
          const partTotal = (parseFloat(part.price) || 0) * (parseInt(part.quantity) || 1);
          newLines.push({
            id: `part-${device.id}-${pi}`,
            deviceId: device.id,
            lineType: 'parts',
            description: `${part.name || part.partNumber || (lang === 'en' ? 'Part' : 'Pi√®ce')} (${part.partNumber || ''})`,
            quantity: parseInt(part.quantity) || 1,
            unitPrice: parseFloat(part.price) || 0,
            total: partTotal,
            sortOrder: sortOrder++
          });
        });
      }

      // Supplement / additional work items
      if (device.additional_work_needed && device.additional_work_items) {
        device.additional_work_items.forEach((item, wi) => {
          newLines.push({
            id: `supp-${device.id}-${wi}`,
            deviceId: device.id,
            lineType: 'other',
            description: `${item.description || item.name || (lang === 'en' ? 'Additional work' : 'Travaux suppl√©mentaires')}`,
            quantity: parseInt(item.quantity) || 1,
            unitPrice: parseFloat(item.price) || 0,
            total: (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1),
            sortOrder: sortOrder++
          });
        });
      }
    });

    // Shipping from quote_data
    const shippingTotal = parseFloat(quoteData.shippingTotal || quoteData.shipping?.total) || 0;
    if (shippingTotal > 0) {
      setShippingPrice(shippingTotal);
      newLines.push({
        id: 'shipping',
        lineType: 'shipping',
        description: `Frais de port (${quoteData.shipping?.parcels || 1} colis)`,
        quantity: 1,
        unitPrice: shippingTotal,
        total: shippingTotal,
        sortOrder: sortOrder++
      });
    }

    setLines(newLines);

    // Check if client is outside EU for TVA exoneration
    const clientCountry = company.billing_country || company.country || '';
    if (clientCountry && !['France', 'FR', ''].includes(clientCountry)) {
      // Could be exonerated ‚Äî user decides
    }
  }, []);

  // Update line item
  const updateLine = (id, field, value) => {
    setLines(prev => prev.map(l => {
      if (l.id !== id) return l;
      const updated = { ...l, [field]: value };
      if (field === 'quantity' || field === 'unitPrice') {
        updated.total = (parseFloat(updated.quantity) || 0) * (parseFloat(updated.unitPrice) || 0);
      }
      return updated;
    }));
  };

  // Remove line
  const removeLine = (id) => {
    setLines(prev => prev.filter(l => l.id !== id));
  };

  // Add custom line
  const addLine = () => {
    setLines(prev => [...prev, {
      id: `custom-${Date.now()}`,
      lineType: 'other',
      description: '',
      quantity: 1,
      unitPrice: 0,
      total: 0,
      sortOrder: prev.length
    }]);
  };

  // Totals
  const serviceLines = lines.filter(l => l.lineType !== 'device_header');
  const subtotalHT = serviceLines.reduce((s, l) => s + (parseFloat(l.total) || 0), 0);
  const tvaRate = isExonerated ? 0 : 20;
  const tvaAmount = isExonerated ? 0 : subtotalHT * 0.20;
  const totalTTC = subtotalHT + tvaAmount;

  // Generate and save
  const handleSave = async () => {
    setSaving(true);
    try {
      // Get invoice number
      let invoiceNumber = null;
      try {
        const { data: docNum } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'FAC' });
        if (docNum) invoiceNumber = docNum;
      } catch (e) {
        const now = new Date();
        const mmyy = String(now.getMonth() + 1).padStart(2, '0') + String(now.getFullYear()).slice(-2);
        invoiceNumber = `FAC-${mmyy}-001`;
      }

      const invoiceDate = new Date().toISOString();
      const dueDate = new Date(Date.now() + paymentTermsDays * 24 * 60 * 60 * 1000).toISOString();

      // Build invoice data for PDF
      const pdfLines = lines.map(l => ({
        description: l.description,
        quantity: l.lineType === 'device_header' ? null : l.quantity,
        unitPrice: l.lineType === 'device_header' ? null : l.unitPrice,
        total: l.lineType === 'device_header' ? null : l.total,
        isDevice: l.lineType === 'device_header'
      }));

      // Generate PDF
      let pdfUrl = null;
      try {
        const pdfBlob = await generateInvoicePDF({
          invoiceNumber,
          invoiceDate,
          dueDate,
          company: {
            name: company.name,
            attention: company.billing_contact || company.contact_name || '',
            address: company.billing_address || company.address || '',
            postal_code: company.billing_postal_code || company.postal_code || '',
            city: company.billing_city || company.city || '',
            country: company.billing_country || company.country || 'France',
            tva_number: clientTVA || company.tva_number || ''
          },
          clientRef,
          rmaNumber: rma.request_number,
          quoteNumber: rma.quote_number,
          bcNumber: rma.bc_number,
          supplementNumber: rma.supplement_number || null,
          supplementBCNumber: rma.supplement_bc_number || null,
          lines: pdfLines,
          subtotalHT,
          tvaRate,
          tvaAmount,
          totalTTC,
          isExonerated,
          paymentTermsDays,
          notes
        }, businessSettings);

        const fileName = `Facture_${invoiceNumber.replace(/[^a-zA-Z0-9-]/g, '_')}_${Date.now()}.pdf`;
        pdfUrl = await uploadPDFToStorage(pdfBlob, `invoices/${rma.request_number}`, fileName);
      } catch (pdfErr) {
        console.error('Invoice PDF error:', pdfErr);
      }

      // Save to database
      const { data: newInvoice, error } = await supabase
        .from('invoices')
        .insert({
          invoice_number: invoiceNumber,
          request_id: rma.id,
          company_id: company.id,
          status: 'created',
          invoice_date: invoiceDate,
          due_date: dueDate,
          payment_terms_days: paymentTermsDays,
          subtotal_ht: subtotalHT,
          tva_rate: tvaRate,
          tva_amount: tvaAmount,
          total_ttc: totalTTC,
          is_tva_exonerated: isExonerated,
          client_ref: clientRef,
          client_tva_number: clientTVA,
          pdf_url: pdfUrl,
          notes,
          created_by: profile?.id
        })
        .select()
        .single();

      if (error) throw error;

      // Save line items
      if (newInvoice) {
        const lineInserts = serviceLines.map((l, idx) => ({
          invoice_id: newInvoice.id,
          device_id: l.deviceId || null,
          line_type: l.lineType,
          description: l.description,
          quantity: parseInt(l.quantity) || 1,
          unit_price_ht: parseFloat(l.unitPrice) || 0,
          total_ht: parseFloat(l.total) || 0,
          sort_order: idx
        }));
        await supabase.from('invoice_lines').insert(lineInserts);
      }

      setSavedInvoice({ ...newInvoice, pdf_url: pdfUrl, invoice_number: invoiceNumber });
      setStep(3);
      notify(lang === 'en' ? `‚úÖ Invoice ${invoiceNumber} created!` : `‚úÖ Facture ${invoiceNumber} cr√©√©e!`);
      if (reload) reload();
    } catch (err) {
      console.error('Invoice save error:', err);
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + (err.message || 'Error'), 'error');
    }
    setSaving(false);
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={(e) => e.target === e.currentTarget && onClose()}>
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        {/* Header */}
        <div className="px-6 py-4 border-b bg-gradient-to-r from-amber-500 to-orange-500 rounded-t-2xl">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-xl font-bold text-white">{lang === 'en' ? 'Create Invoice' : 'Cr√©er Facture'}</h2>
              <p className="text-amber-100 text-sm">{rma.request_number} ‚Äî {company.name}</p>
            </div>
            <div className="flex items-center gap-3">
              <div className="flex items-center gap-1">
                {[1, 2, 3].map(s => (
                  <div key={s} className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                    s < step ? 'bg-white text-amber-600' : s === step ? 'bg-white/30 text-white ring-2 ring-white' : 'bg-white/10 text-white/50'
                  }`}>{s < step ? '‚úì' : s}</div>
                ))}
              </div>
              <button onClick={onClose} className="text-white/70 hover:text-white text-2xl">√ó</button>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* STEP 1: Edit Lines */}
          {step === 1 && (
            <div className="space-y-6">
              {/* Invoice settings row */}
              <div className="grid grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">{lang === 'en' ? 'Your client ref.' : 'Vos r√©f. client'}</label>
                  <input type="text" value={clientRef} onChange={e => setClientRef(e.target.value)} placeholder={lang === 'en' ? 'Client reference...' : 'R√©f√©rence client...'} className="w-full px-3 py-2 border rounded-lg text-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">{lang === 'en' ? 'Client VAT #' : 'N¬∞ TVA client'}</label>
                  <input type="text" value={clientTVA} onChange={e => setClientTVA(e.target.value)} placeholder="FR..." className="w-full px-3 py-2 border rounded-lg text-sm font-mono" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">{lang === 'en' ? 'Payment terms' : 'D√©lai paiement'}</label>
                  <div className="flex items-center gap-2">
                    <input type="number" value={paymentTermsDays} onChange={e => setPaymentTermsDays(parseInt(e.target.value) || 30)} className="w-20 px-3 py-2 border rounded-lg text-sm" />
                    <span className="text-sm text-gray-500">{lang === 'en' ? 'days' : 'jours'}</span>
                  </div>
                </div>
              </div>

              {/* TVA Exoneration toggle */}
              <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked={isExonerated} onChange={e => setIsExonerated(e.target.checked)} className="w-4 h-4 text-blue-600 rounded" />
                  <span className="text-sm font-medium text-gray-700">{lang === 'en' ? "VAT exemption (Art. 262-I CGI ‚Äî Export outside EU)" : "Exon√©ration TVA (Art. 262-I du CGI ‚Äî Export hors UE)"}</span>
                </label>
              </div>

              {/* Line items table */}
              <div>
                <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'Invoice lines' : 'Lignes de facture'}</h3>
                <div className="border rounded-xl overflow-hidden">
                  <table className="w-full">
                    <thead>
                      <tr className="bg-gray-50 text-left">
                        <th className="px-3 py-2 text-xs font-bold text-gray-500 w-12">{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
                        <th className="px-3 py-2 text-xs font-bold text-gray-500">{lang === 'en' ? 'Description' : 'D√©signation'}</th>
                        <th className="px-3 py-2 text-xs font-bold text-gray-500 w-28 text-right">{lang === 'en' ? 'U.P. excl.' : 'P.U. HT'}</th>
                        <th className="px-3 py-2 text-xs font-bold text-gray-500 w-28 text-right">{t('totalHT')}</th>
                        <th className="px-3 py-2 w-10"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {lines.map(line => (
                        <tr key={line.id} className={`border-t ${
                          line.lineType === 'device_header' ? 'bg-blue-50' : 'hover:bg-gray-50'
                        }`}>
                          {line.lineType === 'device_header' ? (
                            <>
                              <td colSpan="4" className="px-3 py-2">
                                <span className="font-bold text-blue-800 text-sm">üîπ {line.description}</span>
                              </td>
                              <td className="px-1">
                                <button onClick={() => removeLine(line.id)} className="text-gray-300 hover:text-red-400 text-sm">√ó</button>
                              </td>
                            </>
                          ) : (
                            <>
                              <td className="px-3 py-1.5">
                                <input type="number" value={line.quantity || ''} onChange={e => updateLine(line.id, 'quantity', e.target.value)} className="w-12 px-1 py-1 border rounded text-sm text-center" min="1" />
                              </td>
                              <td className="px-3 py-1.5">
                                <input type="text" value={line.description} onChange={e => updateLine(line.id, 'description', e.target.value)} className="w-full px-2 py-1 border rounded text-sm" />
                              </td>
                              <td className="px-3 py-1.5 text-right">
                                <input type="number" value={line.unitPrice || ''} onChange={e => updateLine(line.id, 'unitPrice', e.target.value)} step="0.01" className="w-24 px-2 py-1 border rounded text-sm text-right" />
                              </td>
                              <td className="px-3 py-1.5 text-right font-medium text-sm">
                                {(parseFloat(line.total) || 0).toFixed(2)} ‚Ç¨
                              </td>
                              <td className="px-1">
                                <button onClick={() => removeLine(line.id)} className="text-gray-300 hover:text-red-400 text-lg leading-none">√ó</button>
                              </td>
                            </>
                          )}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <button onClick={addLine} className="mt-2 px-3 py-1.5 text-sm text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg font-medium">
                  + Ajouter une ligne
                </button>
              </div>

              {/* Totals */}
              <div className="flex justify-end">
                <div className="w-64 space-y-2">
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-500">{t('totalHT')}</span>
                    <span className="font-medium">{subtotalHT.toFixed(2)} ‚Ç¨</span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-500">{lang === 'en' ? 'VAT' : 'TVA'} {isExonerated ? (lang === 'en' ? '(exempt)' : '(exon√©r√©)') : '20%'}</span>
                    <span className="font-medium">{isExonerated ? (lang === 'en' ? 'EXEMPT' : 'EXON√âR√â') : tvaAmount.toFixed(2) + ' ‚Ç¨'}</span>
                  </div>
                  <div className="flex justify-between text-lg font-bold border-t pt-2">
                    <span>{t('totalTTC')}</span>
                    <span className="text-[#2D5A7B]">{totalTTC.toFixed(2)} ‚Ç¨</span>
                  </div>
                </div>
              </div>

              {/* Notes */}
              <div>
                <label className="block text-sm font-medium text-gray-600 mb-1">{lang === 'en' ? 'Internal notes' : 'Notes internes'}</label>
                <textarea value={notes} onChange={e => setNotes(e.target.value)} placeholder={lang === 'en' ? 'Internal notes (not visible on invoice)...' : 'Notes internes (non visibles sur la facture)...'} rows={2} className="w-full px-3 py-2 border rounded-lg text-sm" />
              </div>
            </div>
          )}

          {/* STEP 3: Saved */}
          {step === 3 && savedInvoice && (
            <div className="text-center py-8">
              <div className="text-6xl mb-4">‚úÖ</div>
              <h3 className="text-2xl font-bold text-green-700 mb-2">{lang === 'en' ? 'Invoice Created!' : 'Facture Cr√©√©e!'}</h3>
              <p className="text-lg font-mono text-gray-700 mb-1">{savedInvoice.invoice_number}</p>
              <p className="text-gray-500 mb-6">{company.name} ‚Äî {totalTTC.toFixed(2)} ‚Ç¨ TTC</p>
              <div className="flex items-center justify-center gap-3">
                {savedInvoice.pdf_url && (
                  <a href={savedInvoice.pdf_url} target="_blank" rel="noopener noreferrer" className="px-5 py-2.5 bg-[#2D5A7B] hover:bg-[#2a4f7a] text-white rounded-lg font-medium flex items-center gap-2">
                    üìÑ Voir Facture PDF
                  </a>
                )}
                <button onClick={async () => { 
                  await supabase.from('invoices').update({ status: 'sent', sent_at: new Date().toISOString() }).eq('id', savedInvoice.id);
                  notify(lang === 'en' ? '‚úÖ Invoice sent!' : '‚úÖ Facture envoy√©e!');
                  if (reload) reload();
                  onClose(); 
                }} className="px-5 py-2.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium flex items-center gap-2">
                  üì§ Envoyer au client
                </button>
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between rounded-b-2xl">
          {step === 1 && (
            <>
              <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">{t('cancel')}</button>
              <button
                onClick={handleSave}
                disabled={saving || serviceLines.length === 0}
                className="px-6 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
              >
                {saving ? (lang === 'en' ? '‚è≥ Generating...' : '‚è≥ G√©n√©ration...') : (lang === 'en' ? 'Generate Invoice PDF & Save' : 'G√©n√©rer Facture PDF & Enregistrer')}
              </button>
            </>
          )}
          {step === 3 && (
            <div className="ml-auto">
              <button onClick={onClose} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">{t('close')}</button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}


function SettingsSheet({ profile, staffMembers, notify, reload, t, lang, setLang }) {
  const [activeTab, setActiveTab] = useState('team');
  const [documentTypes, setDocumentTypes] = useState([]);
  const [counters, setCounters] = useState([]);
  const [loadingCounters, setLoadingCounters] = useState(false);
  const [editingCounter, setEditingCounter] = useState(null);
  const [newValue, setNewValue] = useState('');
  const [saving, setSaving] = useState(false);
  
  // Get current MMYY
  const currentYearMonth = (() => {
    const now = new Date();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const yy = String(now.getFullYear()).slice(-2);
    return mm + yy;
  })();
  
  // Load document types and counters
  const loadCounters = async () => {
    setLoadingCounters(true);
    
    // Load document types
    const { data: types } = await supabase
      .from('document_types')
      .select('*')
      .order('sort_order');
    if (types) setDocumentTypes(types);
    
    // Load all counters
    const { data: ctrs } = await supabase
      .from('document_counters')
      .select('*')
      .order('year_month', { ascending: false });
    if (ctrs) setCounters(ctrs);
    
    setLoadingCounters(false);
  };
  
  useEffect(() => {
    if (activeTab === 'documents') {
      loadCounters();
    }
  }, [activeTab]);
  
  // Save counter value
  const saveCounter = async (docType, yearMonth, value) => {
    setSaving(true);
    try {
      const numValue = parseInt(value) || 0;
      
      // Use RPC to call the set_doc_counter function
      const { data, error } = await supabase.rpc('set_doc_counter', {
        p_doc_type: docType,
        p_year_month: yearMonth,
        p_value: numValue
      });
      
      if (error) throw error;
      
      notify(lang === 'en' ? 'Counter updated' : 'Compteur mis √† jour', 'success');
      loadCounters();
      setEditingCounter(null);
      setNewValue('');
    } catch (err) {
      console.error('Error saving counter:', err);
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setSaving(false);
  };
  
  // Get counter for specific doc type and month
  const getCounter = (docType, yearMonth) => {
    return counters.find(c => c.doc_type === docType && c.year_month === yearMonth);
  };
  
  // Format year_month for display
  const formatYearMonth = (ym) => {
    if (!ym || ym.length !== 4) return ym;
    const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', (lang === 'en' ? 'Aug' : 'Ao√ª'), 'Sep', 'Oct', 'Nov', 'D√©c'];
    const mm = parseInt(ym.slice(0, 2)) - 1;
    const yy = ym.slice(2);
    return `${months[mm]} 20${yy}`;
  };

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold text-gray-800">{t('settings')}</h1>
      
      {/* Tabs */}
      <div className="bg-white rounded-xl shadow-sm">
        <div className="border-b flex">
          <button
            onClick={() => setActiveTab('team')}
            className={`px-6 py-3 font-medium border-b-2 -mb-px transition-colors ${
              activeTab === 'team' 
                ? 'border-[#00A651] text-[#00A651]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            üë• {t('team')}
          </button>
          <button
            onClick={() => setActiveTab('documents')}
            className={`px-6 py-3 font-medium border-b-2 -mb-px transition-colors ${
              activeTab === 'documents' 
                ? 'border-[#00A651] text-[#00A651]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            üìÑ {t('docNumbering')}
          </button>
          <button
            onClick={() => setActiveTab('language')}
            className={`px-6 py-3 font-medium border-b-2 -mb-px transition-colors ${
              activeTab === 'language' 
                ? 'border-[#00A651] text-[#00A651]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            üåê {t('language')}
          </button>
        </div>
        
        {/* Team Tab */}
        {activeTab === 'team' && (
          <div className="p-6 space-y-3">
            {staffMembers.map(member => (
              <div key={member.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-[#00A651] text-white flex items-center justify-center font-bold">
                    {member.full_name?.charAt(0)?.toUpperCase()}
                  </div>
                  <div>
                    <p className="font-medium">{member.full_name}</p>
                    <p className="text-sm text-gray-500">{member.email}</p>
                  </div>
                </div>
                <span className={`px-3 py-1 rounded-full text-sm ${
                  member.role === 'lh_admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'
                }`}>
                  {member.role === 'lh_admin' ? 'üëë Admin' : (lang === 'en' ? 'üë§ Employee' : 'üë§ Employ√©')}
                </span>
              </div>
            ))}
          </div>
        )}
        
        {/* Documents Tab */}
        {activeTab === 'documents' && (
          <div className="p-6">
            {loadingCounters ? (
              <div className="text-center py-8 text-gray-500">{t('loading')}</div>
            ) : (
              <div className="space-y-6">
                {/* RMA Counter - Special (doesn't reset monthly) */}
                {(() => {
                  const rmaType = documentTypes.find(d => d.doc_type === 'RMA');
                  if (!rmaType) return null;
                  
                  const rmaCounter = getCounter('RMA', 'RMA');
                  const rmaCurrentNum = rmaCounter?.current_number || 0;
                  const rmaNextNum = rmaCurrentNum + 1;
                  const isEditingRMA = editingCounter === 'RMA-GLOBAL';
                  
                  return (
                    <div>
                      <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <span className="text-lg">üî¢</span>
                        {lang === 'en' ? 'RMA Number (FR-XXXXX)' : 'Num√©ro RMA (FR-XXXXX)'}
                      </h3>
                      <p className="text-sm text-gray-500 mb-4">
                        {lang === 'en' ? 'RMA number is sequential and does not reset each month.' : 'Le num√©ro RMA est s√©quentiel et ne se r√©initialise pas chaque mois.'}
                      </p>
                      
                      <div className="bg-[#00A651]/10 rounded-xl p-4 border border-[#00A651]/30 max-w-xs">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-xs font-medium text-gray-500">RMA</span>
                          <span className="text-xs bg-[#00A651] text-white px-2 py-0.5 rounded font-mono">{lang === 'en' ? 'FR' : 'FR'}</span>
                        </div>
                        
                        {isEditingRMA ? (
                          <div className="space-y-2">
                            <input
                              type="number"
                              value={newValue}
                              onChange={e => setNewValue(e.target.value)}
                              className="w-full px-3 py-2 border rounded-lg text-center font-mono"
                              placeholder={lang === 'en' ? 'Current value' : 'Valeur actuelle'}
                              min="0"
                            />
                            <div className="flex gap-2">
                              <button
                                onClick={() => { setEditingCounter(null); setNewValue(''); }}
                                className="flex-1 px-3 py-1.5 bg-gray-200 rounded-lg text-sm"
                              >
                                Annuler
                              </button>
                              <button
                                onClick={() => saveCounter('RMA', 'RMA', newValue)}
                                disabled={saving}
                                className="flex-1 px-3 py-1.5 bg-[#00A651] text-white rounded-lg text-sm disabled:opacity-50"
                              >
                                {saving ? '...' : 'OK'}
                              </button>
                            </div>
                          </div>
                        ) : (
                          <>
                            <div className="text-center mb-2">
                              <p className="text-2xl font-bold text-[#00A651] font-mono">
                                {String(rmaCurrentNum).padStart(5, '0')}
                              </p>
                              <p className="text-xs text-gray-400">{lang === 'en' ? 'last used' : 'dernier utilis√©'}</p>
                            </div>
                            <div className="flex items-center justify-between text-xs">
                              <span className="text-gray-500">
                                Prochain: <span className="font-mono font-medium text-[#00A651]">FR-{String(rmaNextNum).padStart(5, '0')}</span>
                              </span>
                              <button
                                onClick={() => { setEditingCounter('RMA-GLOBAL'); setNewValue(String(rmaCurrentNum)); }}
                                className="text-blue-600 hover:text-blue-800"
                              >
                                ‚úèÔ∏è
                              </button>
                            </div>
                          </>
                        )}
                      </div>
                    </div>
                  );
                })()}
                
                {/* Current Month Overview - Monthly counters */}
                <div>
                  <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <span className="text-lg">üìä</span>
                    Compteurs du mois actuel ({formatYearMonth(currentYearMonth)})
                  </h3>
                  <p className="text-sm text-gray-500 mb-4">
                    {lang === 'en' ? 'Format: PREFIX-MMYY-NNN (e.g. DEV-0226-001). Counters reset each month.' : 'Format: PREFIX-MMYY-NNN (ex: DEV-0226-001). Les compteurs se r√©initialisent chaque mois.'}
                  </p>
                  
                  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    {documentTypes.filter(dt => dt.doc_type !== 'RMA').map(docType => {
                      const counter = getCounter(docType.doc_type, currentYearMonth);
                      const currentNum = counter?.current_number || 0;
                      const nextNum = currentNum + 1;
                      const isEditing = editingCounter === `${docType.doc_type}-${currentYearMonth}`;
                      
                      return (
                        <div key={docType.doc_type} className="bg-gray-50 rounded-xl p-4 border">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-xs font-medium text-gray-500">{docType.description_fr}</span>
                            <span className="text-xs bg-gray-200 px-2 py-0.5 rounded font-mono">{docType.prefix}</span>
                          </div>
                          
                          {isEditing ? (
                            <div className="space-y-2">
                              <input
                                type="number"
                                value={newValue}
                                onChange={e => setNewValue(e.target.value)}
                                className="w-full px-3 py-2 border rounded-lg text-center font-mono"
                                placeholder={lang === 'en' ? 'Current value' : 'Valeur actuelle'}
                                min="0"
                              />
                              <div className="flex gap-2">
                                <button
                                  onClick={() => { setEditingCounter(null); setNewValue(''); }}
                                  className="flex-1 px-3 py-1.5 bg-gray-200 rounded-lg text-sm"
                                >
                                  Annuler
                                </button>
                                <button
                                  onClick={() => saveCounter(docType.doc_type, currentYearMonth, newValue)}
                                  disabled={saving}
                                  className="flex-1 px-3 py-1.5 bg-[#00A651] text-white rounded-lg text-sm disabled:opacity-50"
                                >
                                  {saving ? '...' : 'OK'}
                                </button>
                              </div>
                            </div>
                          ) : (
                            <>
                              <div className="text-center mb-2">
                                <p className="text-2xl font-bold text-[#2D5A7B] font-mono">
                                  {String(currentNum).padStart(3, '0')}
                                </p>
                                <p className="text-xs text-gray-400">{lang === 'en' ? 'last used' : 'dernier utilis√©'}</p>
                              </div>
                              <div className="flex items-center justify-between text-xs">
                                <span className="text-gray-500">
                                  Prochain: <span className="font-mono font-medium text-green-600">{docType.prefix}-{currentYearMonth}-{String(nextNum).padStart(3, '0')}</span>
                                </span>
                                <button
                                  onClick={() => { setEditingCounter(`${docType.doc_type}-${currentYearMonth}`); setNewValue(String(currentNum)); }}
                                  className="text-blue-600 hover:text-blue-800"
                                >
                                  ‚úèÔ∏è
                                </button>
                              </div>
                            </>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
                
                {/* History */}
                {counters.filter(c => c.year_month !== 'RMA').length > 0 && (
                  <div>
                    <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                      <span className="text-lg">üìú</span>
                      Historique des compteurs
                    </h3>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="border-b">
                            <th className="text-left py-2 px-3">{lang === 'en' ? 'Period' : 'P√©riode'}</th>
                            {documentTypes.filter(dt => dt.doc_type !== 'RMA').map(dt => (
                              <th key={dt.doc_type} className="text-center py-2 px-3">{dt.prefix}</th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {/* Group counters by year_month - exclude GLOBAL (RMA) */}
                          {[...new Set(counters.filter(c => c.year_month !== 'RMA').map(c => c.year_month))].slice(0, 6).map(ym => (
                            <tr key={ym} className="border-b hover:bg-gray-50">
                              <td className="py-2 px-3 font-medium">{formatYearMonth(ym)}</td>
                              {documentTypes.filter(dt => dt.doc_type !== 'RMA').map(dt => {
                                const c = getCounter(dt.doc_type, ym);
                                return (
                                  <td key={dt.doc_type} className="text-center py-2 px-3 font-mono text-gray-600">
                                    {c ? String(c.current_number).padStart(3, '0') : '‚Äî'}
                                  </td>
                                );
                              })}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
                
                {/* Help */}
                <div className="bg-blue-50 rounded-xl p-4 border border-blue-100">
                  <h4 className="font-medium text-blue-800 mb-2">{lang === 'en' ? 'üí° How it works' : 'üí° Comment √ßa marche'}</h4>
                  <ul className="text-sm text-blue-700 space-y-1">
                    <li>‚Ä¢ <strong>{lang === 'en' ? 'RMA (FR-XXXXX)' : 'RMA (FR-XXXXX)'}</strong>{lang === 'en' ? ': Sequential number, does not reset' : ': Num√©ro s√©quentiel continu, ne se r√©initialise pas'}</li>
                    <li>‚Ä¢ <strong>{lang === 'en' ? 'Documents (DEV, PO, DN, INV, CTR, SUP)' : 'Documents (DEV, BC, BL, FAC, CTR, SUP)'}</strong>{lang === 'en' ? ': Format PREFIX-MMYY-NNN, resets monthly' : ': Format PREFIX-MMYY-NNN, r√©initialisation mensuelle'}</li>
                    <li>{lang === 'en' ? '‚Ä¢ PO can be the client number (if provided) or auto-generated' : '‚Ä¢ Le BC peut √™tre le num√©ro du client (si fourni) ou auto-g√©n√©r√©'}</li>
                    <li>{lang === 'en' ? '‚Ä¢ PO number is referenced on the Delivery Note (DN)' : '‚Ä¢ Le num√©ro BC est r√©f√©renc√© sur le Bon de Livraison (BL)'}</li>
                    <li>{lang === 'en' ? '‚Ä¢ Use the ‚úèÔ∏è button to correct a counter if needed' : '‚Ä¢ Utilisez le bouton ‚úèÔ∏è pour corriger un compteur si n√©cessaire'}</li>
                  </ul>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Language Tab */}
        {activeTab === 'language' && (
          <div className="p-6">
            <div className="mb-4">
              <h2 className="text-lg font-bold text-gray-800">{t('languagePreference')}</h2>
              <p className="text-sm text-gray-500">{t('languageDesc')}</p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button
                onClick={async () => {
                  setLang('fr');
                  const { error } = await supabase.from('profiles').update({ preferred_language: 'fr' }).eq('id', profile.id);
                  if (!error) notify(t('langUpdatedFr'), 'success');
                  else notify(lang === 'en' ? 'Error' : 'Erreur', 'error');
                }}
                className={`p-6 rounded-xl border-2 transition-all text-left ${
                  lang === 'fr' 
                    ? 'border-[#00A651] bg-green-50 ring-2 ring-[#00A651]/20' 
                    : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                }`}
              >
                <div className="flex items-center gap-4">
                  <span className="text-4xl">üá´üá∑</span>
                  <div className="flex-1">
                    <p className="font-bold text-lg text-gray-800">Fran√ßais</p>
                    <p className="text-sm text-gray-500">{t('displayInFrench')}</p>
                  </div>
                  {lang === 'fr' && (
                    <span className="w-6 h-6 rounded-full bg-[#00A651] flex items-center justify-center text-white text-xs font-bold">‚úì</span>
                  )}
                </div>
              </button>
              <button
                onClick={async () => {
                  setLang('en');
                  const { error } = await supabase.from('profiles').update({ preferred_language: 'en' }).eq('id', profile.id);
                  if (!error) notify(t('langUpdatedEn'), 'success');
                  else notify('Error', 'error');
                }}
                className={`p-6 rounded-xl border-2 transition-all text-left ${
                  lang === 'en' 
                    ? 'border-[#00A651] bg-green-50 ring-2 ring-[#00A651]/20' 
                    : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                }`}
              >
                <div className="flex items-center gap-4">
                  <span className="text-4xl">üá¨üáß</span>
                  <div className="flex-1">
                    <p className="font-bold text-lg text-gray-800">English</p>
                    <p className="text-sm text-gray-500">{t('displayInEnglish')}</p>
                  </div>
                  {lang === 'en' && (
                    <span className="w-6 h-6 rounded-full bg-[#00A651] flex items-center justify-center text-white text-xs font-bold">‚úì</span>
                  )}
                </div>
              </button>
            </div>
            <div className="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
              <p className="text-sm text-amber-800">
                {lang === 'en' 
                  ? '‚ö†Ô∏è Note: This setting only changes the portal interface language. Documents (quotes, invoices, certificates, reports) will remain in French as they are official documents for French clients.'
                  : '‚ö†Ô∏è Note : Ce param√®tre ne change que la langue de l\'interface du portail. Les documents (devis, factures, certificats, rapports) resteront en fran√ßais car ce sont des documents officiels.'
                }
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function AdminSheet({ profile, staffMembers, notify, reload, businessSettings, setBusinessSettings, t = k=>k, lang = 'fr' }) {
  const [editingSettings, setEditingSettings] = useState(false);
  const [tempSettings, setTempSettings] = useState(businessSettings);
  const [saving, setSaving] = useState(false);
  
  const saveSettings = async () => {
    setSaving(true);
    try {
      // Try to update first
      const { error: updateError } = await supabase
        .from('business_settings')
        .upsert({ id: 1, ...tempSettings, updated_at: new Date().toISOString() });
      
      if (updateError) throw updateError;
      
      setBusinessSettings(tempSettings);
      setEditingSettings(false);
      notify(lang === 'en' ? '‚úÖ Settings saved!' : '‚úÖ Param√®tres enregistr√©s!');
    } catch (err) {
      console.error('Settings save error:', err);
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + (err.message || 'Error'), 'error');
    }
    setSaving(false);
  };
  
  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? 'üîê Administration' : 'üîê Administration'}</h1>
      
      {/* Business Settings Card */}
      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        <div className="px-6 py-4 border-b bg-gradient-to-r from-blue-600 to-indigo-600 flex justify-between items-center">
          <div>
            <h2 className="text-lg font-bold text-white">{lang === 'en' ? "üè¢ Company information" : "üè¢ Informations de l'entreprise"}</h2>
            <p className="text-blue-100 text-sm">{lang === 'en' ? 'Used on DN, quotes and invoices' : 'Utilis√©es sur les BL, devis et factures'}</p>
          </div>
          {!editingSettings && (
            <button onClick={() => { setTempSettings(businessSettings); setEditingSettings(true); }} className="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium">
              ‚úèÔ∏è Modifier
            </button>
          )}
        </div>
        
        <div className="p-6">
          {editingSettings ? (
            <div className="space-y-4">
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Company name' : 'Nom de la soci√©t√©'}</label>
                  <input type="text" value={tempSettings.company_name} onChange={e => setTempSettings({...tempSettings, company_name: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Capital' : 'Capital'}</label>
                  <div className="flex">
                    <input type="text" value={tempSettings.capital} onChange={e => setTempSettings({...tempSettings, capital: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-l-lg" />
                    <span className="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg">‚Ç¨</span>
                  </div>
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{t('address')}</label>
                <input type="text" value={tempSettings.address} onChange={e => setTempSettings({...tempSettings, address: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
              </div>
              
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Postal code' : 'Code postal'}</label>
                  <input type="text" value={tempSettings.postal_code} onChange={e => setTempSettings({...tempSettings, postal_code: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">{t('city')}</label>
                  <input type="text" value={tempSettings.city} onChange={e => setTempSettings({...tempSettings, city: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                </div>
              </div>
              
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">{t('phone')}</label>
                  <input type="text" value={tempSettings.phone} onChange={e => setTempSettings({...tempSettings, phone: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">{t('email')}</label>
                  <input type="email" value={tempSettings.email} onChange={e => setTempSettings({...tempSettings, email: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Website' : 'Site web'}</label>
                <input type="text" value={tempSettings.website} onChange={e => setTempSettings({...tempSettings, website: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
              </div>
              
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'SIRET' : 'SIRET'}</label>
                  <input type="text" value={tempSettings.siret} onChange={e => setTempSettings({...tempSettings, siret: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Intra-community VAT' : 'TVA Intracommunautaire'}</label>
                  <input type="text" value={tempSettings.tva} onChange={e => setTempSettings({...tempSettings, tva: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                </div>
              </div>
              
              {/* Bank / Invoice Info Section */}
              <div className="pt-4 mt-4 border-t border-dashed border-gray-300">
                <h4 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">{lang === 'en' ? '‚úçÔ∏è Quote signatory' : '‚úçÔ∏è Signataire des devis'}</h4>
                <div className="grid md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Signatory name' : 'Nom du signataire'}</label>
                    <input type="text" value={tempSettings.quote_signatory || ''} onChange={e => setTempSettings({...tempSettings, quote_signatory: e.target.value})} placeholder="M. Meleney" className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                </div>
              </div>

              {/* Bank / Invoice Info Section */}
              <div className="pt-4 mt-4 border-t border-dashed border-gray-300">
                <h4 className="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">{lang === 'en' ? 'üè¶ Bank Details (invoices)' : 'üè¶ Coordonn√©es bancaires (factures)'}</h4>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Bank' : 'Banque'}</label>
                    <input type="text" value={tempSettings.bank_name || ''} onChange={e => setTempSettings({...tempSettings, bank_name: e.target.value})} placeholder="SOCIETE GENERALE" className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Branch / City' : 'Agence / Ville'}</label>
                    <input type="text" value={tempSettings.bank_branch || ''} onChange={e => setTempSettings({...tempSettings, bank_branch: e.target.value})} placeholder="LAGNY sur Marne" className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                </div>
                <div className="mt-3">
                  <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'IBAN' : 'IBAN'}</label>
                  <input type="text" value={tempSettings.iban || ''} onChange={e => setTempSettings({...tempSettings, iban: e.target.value})} placeholder="FR76 3000 3008 8800 0200 1313 327" className="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono" />
                </div>
                <div className="mt-3">
                  <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'RIB (Bank Code / Branch / Account / Key)' : 'RIB (Code Banque / Guichet / Compte / Cl√©)'}</label>
                  <input type="text" value={tempSettings.rib || ''} onChange={e => setTempSettings({...tempSettings, rib: e.target.value})} placeholder="30003 00888 00020013133 27" className="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono" />
                </div>
                <div className="grid md:grid-cols-2 gap-4 mt-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'BIC / SWIFT' : 'BIC / SWIFT'}</label>
                    <input type="text" value={tempSettings.bic || ''} onChange={e => setTempSettings({...tempSettings, bic: e.target.value})} placeholder="SOGEFRPP" className="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Payment terms (days)' : 'Conditions de paiement (jours)'}</label>
                    <input type="number" value={tempSettings.payment_terms_days || 30} onChange={e => setTempSettings({...tempSettings, payment_terms_days: parseInt(e.target.value) || 30})} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                </div>
                <div className="mt-3">
                  <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Invoice legal notices' : 'Mentions l√©gales factures'}</label>
                  <textarea value={tempSettings.invoice_legal_text || ''} onChange={e => setTempSettings({...tempSettings, invoice_legal_text: e.target.value})} placeholder="En application des articles L441-6 et L441-3 du Code de commerce, en cas de retard de r√®glement :&#10;Indemnit√© forfaitaire pour frais de recouvrement de 40‚Ç¨ ‚Ä¢ P√©nalit√© de retard √† compter du 31√®me jour au taux de 12% l'an&#10;Aucun escompte ne sera accord√© en cas de paiement anticip√©. Tous nos prix sont exprim√©s en euro." rows={3} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-xs" />
                </div>
              </div>
              
              <div className="flex justify-end gap-3 pt-4 border-t">
                <button onClick={() => setEditingSettings(false)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{t('cancel')}</button>
                <button onClick={saveSettings} disabled={saving} className="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium disabled:opacity-50">
                  {saving ? (lang === 'en' ? '‚è≥ Saving...' : '‚è≥ Enregistrement...') : (lang === 'en' ? '‚úÖ Save' : '‚úÖ Enregistrer')}
                </button>
              </div>
            </div>
          ) : (
            <div className="space-y-4">
              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <h3 className="font-bold text-lg text-gray-800 mb-3">{businessSettings.company_name}</h3>
                  <div className="space-y-1 text-gray-600">
                    <p>{businessSettings.address}</p>
                    <p>{businessSettings.postal_code} {businessSettings.city}</p>
                    <p>üìû {businessSettings.phone}</p>
                    <p>‚úâÔ∏è {businessSettings.email}</p>
                    <p>üåê {businessSettings.website}</p>
                  </div>
                </div>
                <div>
                  <h4 className="font-medium text-gray-700 mb-3">{lang === 'en' ? 'Legal Information' : 'Informations l√©gales'}</h4>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between py-2 border-b border-gray-100">
                      <span className="text-gray-500">{lang === 'en' ? 'Capital' : 'Capital'}</span>
                      <span className="font-medium">{businessSettings.capital} ‚Ç¨</span>
                    </div>
                    <div className="flex justify-between py-2 border-b border-gray-100">
                      <span className="text-gray-500">{lang === 'en' ? 'SIRET' : 'SIRET'}</span>
                      <span className="font-mono">{businessSettings.siret}</span>
                    </div>
                    <div className="flex justify-between py-2">
                      <span className="text-gray-500">{t('tva')}</span>
                      <span className="font-mono">{businessSettings.tva}</span>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Bank Info Display */}
              {(businessSettings.iban || businessSettings.bank_name) && (
                <div className="pt-4 mt-2 border-t border-dashed border-gray-200">
                  <h4 className="font-medium text-gray-700 mb-3">{lang === 'en' ? 'üè¶ Bank Details' : 'üè¶ Coordonn√©es bancaires'}</h4>
                  <div className="space-y-2 text-sm">
                    {businessSettings.bank_name && (
                      <div className="flex justify-between py-1">
                        <span className="text-gray-500">{lang === 'en' ? 'Bank' : 'Banque'}</span>
                        <span>{businessSettings.bank_name}{businessSettings.bank_branch ? ` ‚Äî ${businessSettings.bank_branch}` : ''}</span>
                      </div>
                    )}
                    {businessSettings.iban && (
                      <div className="flex justify-between py-1">
                        <span className="text-gray-500">{lang === 'en' ? 'IBAN' : 'IBAN'}</span>
                        <span className="font-mono text-xs">{businessSettings.iban}</span>
                      </div>
                    )}
                    {businessSettings.rib && (
                      <div className="flex justify-between py-1">
                        <span className="text-gray-500">{lang === 'en' ? 'RIB' : 'RIB'}</span>
                        <span className="font-mono text-xs">{businessSettings.rib}</span>
                      </div>
                    )}
                    {businessSettings.bic && (
                      <div className="flex justify-between py-1">
                        <span className="text-gray-500">{lang === 'en' ? 'BIC' : 'BIC'}</span>
                        <span className="font-mono">{businessSettings.bic}</span>
                      </div>
                    )}
                    <div className="flex justify-between py-1">
                      <span className="text-gray-500">{lang === 'en' ? 'Payment terms' : 'Conditions paiement'}</span>
                      <span>{businessSettings.payment_terms_days || 30} jours</span>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Preview how it looks on documents */}
              <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                <p className="text-xs text-gray-500 mb-2">{lang === 'en' ? 'Preview on documents:' : 'Aper√ßu sur les documents:'}</p>
                <p className="text-xs text-gray-600 text-center">
                  <strong>{businessSettings.company_name}</strong> au capital de {businessSettings.capital} ‚Ç¨<br/>
                  {businessSettings.address}, {businessSettings.postal_code} {businessSettings.city} | T√©l. {businessSettings.phone}<br/>
                  SIRET {businessSettings.siret} | TVA {businessSettings.tva}<br/>
                  {businessSettings.email} | {businessSettings.website}
                </p>
              </div>
            </div>
          )}
        </div>
      </div>
      
      {/* Other admin cards */}
      
      {/* ===== QUOTE CONTENT SETTINGS ===== */}
      <QuoteContentSettings businessSettings={businessSettings} setBusinessSettings={setBusinessSettings} notify={notify} lang={lang} />

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div className="bg-white rounded-xl shadow-sm p-6 hover:shadow-md cursor-pointer">
          <div className="text-3xl mb-3">üí∞</div>
          <h3 className="font-bold text-gray-800">{lang === 'en' ? 'Pricing' : 'Tarification'}</h3>
          <p className="text-sm text-gray-500">{lang === 'en' ? 'Manage service pricing' : 'G√©rer les prix des services'}</p>
        </div>
        <div className="bg-white rounded-xl shadow-sm p-6 hover:shadow-md cursor-pointer">
          <div className="text-3xl mb-3">üîë</div>
          <h3 className="font-bold text-gray-800">{lang === 'en' ? 'Permissions' : 'Permissions'}</h3>
          <p className="text-sm text-gray-500">{lang === 'en' ? 'Manage employee access' : 'G√©rer les acc√®s des employ√©s'}</p>
        </div>
        <div className="bg-white rounded-xl shadow-sm p-6 hover:shadow-md cursor-pointer">
          <div className="text-3xl mb-3">‚öôÔ∏è</div>
          <h3 className="font-bold text-gray-800">{lang === 'en' ? 'System' : 'Syst√®me'}</h3>
          <p className="text-sm text-gray-500">{lang === 'en' ? 'Advanced Configuration' : 'Configuration avanc√©e'}</p>
        </div>
      </div>
    </div>
  );
}

// ============================================
// QUOTE CONTENT SETTINGS COMPONENT
// Edit service descriptions, repair text, disclaimers, and signatory for PDF quotes
// ============================================

const QUOTE_DEFAULTS = {
  calibration: {
    particle_counter: {
      title: "Etalonnage Compteur de Particules Aeroportees",
      prestations: [
        "Verification des fonctionnalites du compteur",
        "Verification et reglage du debit",
        "Verification de la cellule de mesure",
        "Controle et reglage des seuils de mesures granulometrique a l'aide de spheres de latex calibrees et certifiees",
        "Verification en nombre par comparaison a un etalon etalonne selon la norme ISO 17025, conformement a la norme ISO 21501-4",
        "Fourniture d'un rapport de test et de calibration"
      ]
    },
    bio_collector: {
      title: "Etalonnage Bio Collecteur",
      prestations: [
        "Verification des fonctionnalites de l'appareil",
        "Verification et reglage du debit",
        "Verification de la cellule d'impaction",
        "Controle des parametres de collecte",
        "Fourniture d'un rapport de test et de calibration"
      ]
    },
    liquid_counter: {
      title: "Etalonnage Compteur de Particules en Milieu Liquide",
      prestations: [
        "Verification des fonctionnalites du compteur",
        "Verification et reglage du debit",
        "Verification de la cellule de mesure optique",
        "Controle et reglage des seuils de mesures granulometrique",
        "Verification en nombre par comparaison a un etalon",
        "Fourniture d'un rapport de test et de calibration"
      ]
    },
    temp_humidity: {
      title: "Etalonnage Capteur Temperature/Humidite",
      prestations: [
        "Verification des fonctionnalites du capteur",
        "Etalonnage temperature sur points de reference certifies",
        "Etalonnage humidite relative",
        "Verification de la stabilite des mesures",
        "Fourniture d'un certificat d'etalonnage"
      ]
    },
    other: {
      title: "Etalonnage Equipement",
      prestations: [
        "Verification des fonctionnalites de l'appareil",
        "Etalonnage selon les specifications du fabricant",
        "Tests de fonctionnement",
        "Fourniture d'un rapport de test"
      ]
    }
  },
  repair: {
    title: "Reparation",
    prestations: [
      "Diagnostic complet de l'appareil",
      "Identification des composants defectueux",
      "Remplacement des pieces defectueuses (pieces facturees en sus)",
      "Tests de fonctionnement complets",
      "Verification d'etalonnage post-reparation si applicable"
    ]
  },
  disclaimers: [
    "Cette offre n'inclut pas la reparation ou l'echange de pieces non consommables.",
    "Un devis complementaire sera etabli si des pieces sont trouvees defectueuses et necessitent un remplacement.",
    "Les mesures stockees dans les appareils seront eventuellement perdues lors des operations de maintenance.",
    "Les equipements envoyes devront etre decontamines de toutes substances chimiques, bacteriennes ou radioactives."
  ],
  signatory_name: "M. Meleney",
  signatory_company: "Lighthouse France"
};

const CAL_TYPE_LABELS = {
  particle_counter: { icon: 'üî¨', label: { en: 'Airborne Particle Counter', fr: 'Compteur de Particules A√©roport√©es' } },
  bio_collector: { icon: 'üß´', label: { en: 'Bio Collector', fr: 'Bio Collecteur' } },
  liquid_counter: { icon: 'üíß', label: { en: 'Liquid Particle Counter', fr: 'Compteur Particules Liquide' } },
  temp_humidity: { icon: 'üå°Ô∏è', label: { en: 'Temp/Humidity Sensor', fr: 'Capteur Temp/Humidit√©' } },
  other: { icon: '‚öôÔ∏è', label: { en: 'Other Equipment', fr: 'Autre √âquipement' } }
};

function QuoteContentSettings({ businessSettings, setBusinessSettings, notify, lang }) {
  const t = k => k;
  const [editing, setEditing] = useState(false);
  const [saving, setSaving] = useState(false);
  const [expandedSection, setExpandedSection] = useState(null);
  
  // Initialize working copy from saved settings or defaults
  const getWorkingCopy = () => {
    const saved = businessSettings.quote_settings;
    if (saved && typeof saved === 'object') {
      // Deep merge with defaults to ensure no missing keys
      return {
        calibration: { ...QUOTE_DEFAULTS.calibration, ...(saved.calibration || {}) },
        repair: saved.repair || QUOTE_DEFAULTS.repair,
        disclaimers: saved.disclaimers || QUOTE_DEFAULTS.disclaimers,
        signatory_name: saved.signatory_name || QUOTE_DEFAULTS.signatory_name,
        signatory_company: saved.signatory_company || QUOTE_DEFAULTS.signatory_company
      };
    }
    return JSON.parse(JSON.stringify(QUOTE_DEFAULTS));
  };
  
  const [draft, setDraft] = useState(getWorkingCopy);

  const toggleSection = (key) => {
    setExpandedSection(expandedSection === key ? null : key);
  };

  // Update a prestation line for a calibration type
  const updateCalPrestation = (calType, idx, value) => {
    const updated = { ...draft };
    const prestations = [...(updated.calibration[calType]?.prestations || [])];
    prestations[idx] = value;
    updated.calibration = { ...updated.calibration, [calType]: { ...updated.calibration[calType], prestations } };
    setDraft(updated);
  };

  const addCalPrestation = (calType) => {
    const updated = { ...draft };
    const prestations = [...(updated.calibration[calType]?.prestations || []), ''];
    updated.calibration = { ...updated.calibration, [calType]: { ...updated.calibration[calType], prestations } };
    setDraft(updated);
  };

  const removeCalPrestation = (calType, idx) => {
    const updated = { ...draft };
    const prestations = (updated.calibration[calType]?.prestations || []).filter((_, i) => i !== idx);
    updated.calibration = { ...updated.calibration, [calType]: { ...updated.calibration[calType], prestations } };
    setDraft(updated);
  };

  const updateCalTitle = (calType, value) => {
    const updated = { ...draft };
    updated.calibration = { ...updated.calibration, [calType]: { ...updated.calibration[calType], title: value } };
    setDraft(updated);
  };

  // Repair prestations
  const updateRepairPrestation = (idx, value) => {
    const updated = { ...draft };
    const prestations = [...updated.repair.prestations];
    prestations[idx] = value;
    updated.repair = { ...updated.repair, prestations };
    setDraft(updated);
  };

  const addRepairPrestation = () => {
    const updated = { ...draft };
    updated.repair = { ...updated.repair, prestations: [...updated.repair.prestations, ''] };
    setDraft(updated);
  };

  const removeRepairPrestation = (idx) => {
    const updated = { ...draft };
    updated.repair = { ...updated.repair, prestations: updated.repair.prestations.filter((_, i) => i !== idx) };
    setDraft(updated);
  };

  // Disclaimers
  const updateDisclaimer = (idx, value) => {
    const updated = { ...draft };
    const disclaimers = [...updated.disclaimers];
    disclaimers[idx] = value;
    updated.disclaimers = disclaimers;
    setDraft(updated);
  };

  const addDisclaimer = () => {
    setDraft({ ...draft, disclaimers: [...draft.disclaimers, ''] });
  };

  const removeDisclaimer = (idx) => {
    setDraft({ ...draft, disclaimers: draft.disclaimers.filter((_, i) => i !== idx) });
  };

  const resetToDefaults = () => {
    if (window.confirm(lang === 'en' ? 'Reset all text to defaults? Unsaved changes will be lost.' : 'Remettre tous les textes par d√©faut ? Les modifications non sauvegard√©es seront perdues.')) {
      setDraft(JSON.parse(JSON.stringify(QUOTE_DEFAULTS)));
    }
  };

  const saveQuoteSettings = async () => {
    setSaving(true);
    try {
      // Filter out empty prestations
      const cleaned = JSON.parse(JSON.stringify(draft));
      for (const key of Object.keys(cleaned.calibration)) {
        cleaned.calibration[key].prestations = cleaned.calibration[key].prestations.filter(p => p.trim());
      }
      cleaned.repair.prestations = cleaned.repair.prestations.filter(p => p.trim());
      cleaned.disclaimers = cleaned.disclaimers.filter(d => d.trim());

      const updatedSettings = { ...businessSettings, quote_settings: cleaned, quote_signatory: cleaned.signatory_name };
      
      const { error } = await supabase
        .from('business_settings')
        .upsert({ id: 1, ...updatedSettings, updated_at: new Date().toISOString() });
      
      if (error) throw error;
      
      setBusinessSettings(updatedSettings);
      setEditing(false);
      notify(lang === 'en' ? '‚úÖ Quote content saved!' : '‚úÖ Contenu des devis enregistr√©!');
    } catch (err) {
      console.error('Quote settings save error:', err);
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + (err.message || 'Error'), 'error');
    }
    setSaving(false);
  };

  // Render a prestations editor for a section
  const renderPrestationsEditor = (prestations, onUpdate, onAdd, onRemove) => (
    <div className="space-y-2">
      {prestations.map((p, idx) => (
        <div key={idx} className="flex gap-2 items-start">
          <span className="text-gray-400 text-xs mt-2.5 w-4 shrink-0">{idx + 1}.</span>
          <input
            type="text"
            value={p}
            onChange={(e) => onUpdate(idx, e.target.value)}
            className="flex-1 px-3 py-1.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent"
            placeholder={lang === 'en' ? 'Service description text...' : 'Texte de la prestation...'}
          />
          <button onClick={() => onRemove(idx)} className="text-red-400 hover:text-red-600 text-lg shrink-0 mt-0.5" title={lang === "en" ? "Delete" : "Supprimer"}>√ó</button>
        </div>
      ))}
      <button onClick={onAdd} className="text-sm text-green-600 hover:text-green-700 font-medium flex items-center gap-1">
        <span>+</span> Ajouter une ligne
      </button>
    </div>
  );

  return (
    <div className="bg-white rounded-xl shadow-sm overflow-hidden">
      <div className="px-6 py-4 border-b bg-gradient-to-r from-green-600 to-emerald-600 flex justify-between items-center">
        <div>
          <h2 className="text-lg font-bold text-white">{lang === 'en' ? 'üìù Quote content' : 'üìù Contenu des devis'}</h2>
          <p className="text-green-100 text-sm">{lang === 'en' ? "Service texts, terms and signatory on quote PDFs" : "Textes des prestations, conditions et signataire sur les PDF de devis"}</p>
        </div>
        {!editing && (
          <button onClick={() => { setDraft(getWorkingCopy()); setEditing(true); }} className="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium">
            ‚úèÔ∏è Modifier
          </button>
        )}
      </div>

      <div className="p-6">
        {editing ? (
          <div className="space-y-4">
            {/* Signatory */}
            <div className="grid md:grid-cols-2 gap-4 pb-4 border-b border-gray-200">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Signatory name (on quote PDF)' : 'Nom du signataire (sur le devis PDF)'}</label>
                <input type="text" value={draft.signatory_name} onChange={e => setDraft({ ...draft, signatory_name: e.target.value })} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="M. Meleney" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? "Signatory company" : "Entreprise du signataire"}</label>
                <input type="text" value={draft.signatory_company} onChange={e => setDraft({ ...draft, signatory_company: e.target.value })} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Lighthouse France" />
              </div>
            </div>

            {/* Calibration Sections */}
            <div>
              <h3 className="font-bold text-gray-700 mb-3 flex items-center gap-2">{lang === 'en' ? "üî¨ Calibration services (by device type)" : "üî¨ Prestations d'√©talonnage (par type d'appareil)"}</h3>
              <div className="space-y-2">
                {Object.entries(CAL_TYPE_LABELS).map(([key, { icon, label }]) => (
                  <div key={key} className="border border-gray-200 rounded-lg overflow-hidden">
                    <button
                      onClick={() => toggleSection('cal_' + key)}
                      className="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 text-left"
                    >
                      <span className="font-medium text-sm">{icon} {label[lang] || label.fr}</span>
                      <span className="text-gray-400 text-lg">{expandedSection === 'cal_' + key ? '‚ñæ' : '‚ñ∏'}</span>
                    </button>
                    {expandedSection === 'cal_' + key && (
                      <div className="p-4 space-y-3">
                        <div>
                          <label className="block text-xs font-medium text-gray-500 mb-1">{lang === 'en' ? 'Section title' : 'Titre de la section'}</label>
                          <input
                            type="text"
                            value={draft.calibration[key]?.title || ''}
                            onChange={(e) => updateCalTitle(key, e.target.value)}
                            className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                          />
                        </div>
                        <div>
                          <label className="block text-xs font-medium text-gray-500 mb-1">{lang === 'en' ? 'Service lines' : 'Lignes de prestation'}</label>
                          {renderPrestationsEditor(
                            draft.calibration[key]?.prestations || [],
                            (idx, val) => updateCalPrestation(key, idx, val),
                            () => addCalPrestation(key),
                            (idx) => removeCalPrestation(key, idx)
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>

            {/* Repair Section */}
            <div className="border border-orange-200 rounded-lg overflow-hidden">
              <button
                onClick={() => toggleSection('repair')}
                className="w-full flex items-center justify-between px-4 py-3 bg-orange-50 hover:bg-orange-100 text-left"
              >
                <span className="font-medium text-sm">{lang === 'en' ? 'üîß Repair services' : 'üîß Prestations de r√©paration'}</span>
                <span className="text-gray-400 text-lg">{expandedSection === 'repair' ? '‚ñæ' : '‚ñ∏'}</span>
              </button>
              {expandedSection === 'repair' && (
                <div className="p-4 space-y-3">
                  <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">{lang === 'en' ? 'Section title' : 'Titre de la section'}</label>
                    <input
                      type="text"
                      value={draft.repair.title}
                      onChange={(e) => setDraft({ ...draft, repair: { ...draft.repair, title: e.target.value } })}
                      className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">{lang === 'en' ? 'Service lines' : 'Lignes de prestation'}</label>
                    {renderPrestationsEditor(draft.repair.prestations, updateRepairPrestation, addRepairPrestation, removeRepairPrestation)}
                  </div>
                </div>
              )}
            </div>

            {/* Disclaimers */}
            <div className="border border-gray-200 rounded-lg overflow-hidden">
              <button
                onClick={() => toggleSection('disclaimers')}
                className="w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100 text-left"
              >
                <span className="font-medium text-sm">{lang === 'en' ? '‚ö†Ô∏è Terms / Disclaimers' : '‚ö†Ô∏è Conditions / Disclaimers'}</span>
                <span className="text-gray-400 text-lg">{expandedSection === 'disclaimers' ? '‚ñæ' : '‚ñ∏'}</span>
              </button>
              {expandedSection === 'disclaimers' && (
                <div className="p-4">
                  <label className="block text-xs font-medium text-gray-500 mb-2">{lang === 'en' ? 'Disclaimer lines (shown at bottom of quote)' : 'Lignes de conditions (affich√©es en bas du devis)'}</label>
                  {renderPrestationsEditor(draft.disclaimers, updateDisclaimer, addDisclaimer, removeDisclaimer)}
                </div>
              )}
            </div>

            {/* Actions */}
            <div className="flex justify-between items-center pt-4 border-t">
              <button onClick={resetToDefaults} className="text-sm text-gray-500 hover:text-red-500 flex items-center gap-1">
                üîÑ Remettre par d√©faut
              </button>
              <div className="flex gap-3">
                <button onClick={() => setEditing(false)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">{t('cancel')}</button>
                <button onClick={saveQuoteSettings} disabled={saving} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50">
                  {saving ? (lang === 'en' ? '‚è≥ Saving...' : '‚è≥ Enregistrement...') : (lang === 'en' ? '‚úÖ Save' : '‚úÖ Enregistrer')}
                </button>
              </div>
            </div>
          </div>
        ) : (
          <div className="space-y-4">
            {/* Read-only summary */}
            <div className="flex items-center gap-4 text-sm">
              <div className="flex items-center gap-2 text-gray-600">
                <span className="font-medium">{lang === 'en' ? 'Signatory:' : 'Signataire:'}</span>
                <span>{businessSettings.quote_settings?.signatory_name || businessSettings.quote_signatory || 'M. Meleney'}</span>
              </div>
            </div>
            
            <div className="grid md:grid-cols-2 gap-3">
              {Object.entries(CAL_TYPE_LABELS).map(([key, { icon, label }]) => {
                const data = businessSettings.quote_settings?.calibration?.[key] || QUOTE_DEFAULTS.calibration[key];
                return (
                  <div key={key} className="bg-gray-50 rounded-lg p-3">
                    <p className="text-xs font-medium text-gray-500 mb-1">{icon} {label[lang] || label.fr}</p>
                    <p className="text-xs text-gray-600">{data?.prestations?.length || 0} lignes de prestation</p>
                  </div>
                );
              })}
              <div className="bg-orange-50 rounded-lg p-3">
                <p className="text-xs font-medium text-orange-600 mb-1">{lang === 'en' ? 'üîß Repair' : 'üîß R√©paration'}</p>
                <p className="text-xs text-gray-600">{(businessSettings.quote_settings?.repair?.prestations || QUOTE_DEFAULTS.repair.prestations).length} lignes</p>
              </div>
              <div className="bg-yellow-50 rounded-lg p-3">
                <p className="text-xs font-medium text-yellow-700 mb-1">{lang === 'en' ? '‚ö†Ô∏è Terms' : '‚ö†Ô∏è Conditions'}</p>
                <p className="text-xs text-gray-600">{(businessSettings.quote_settings?.disclaimers || QUOTE_DEFAULTS.disclaimers).length} lignes</p>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ============================================
// QUOTE TEMPLATES - Calibration by Device Type
// ============================================
const CALIBRATION_TEMPLATES = {
  particle_counter: {
    icon: 'üî¨',
    title: "√âtalonnage Compteur de Particules A√©roport√©es",
    prestations: [
      "V√©rification des fonctionnalit√©s du compteur",
      "V√©rification et r√©glage du d√©bit",
      "V√©rification de la cellule de mesure",
      "Contr√¥le et r√©glage des seuils de mesures granulom√©trique √† l'aide de sph√®res de latex calibr√©es et certifi√©es",
      "V√©rification en nombre par comparaison √† un √©talon √©talonn√© selon la norme ISO 17025, conform√©ment √† la norme ISO 21501-4",
      "Fourniture d'un rapport de test et de calibration"
    ],
    defaultPrice: 630
  },
  bio_collector: {
    icon: 'üß´',
    title: "√âtalonnage Bio Collecteur",
    prestations: [
      "V√©rification des fonctionnalit√©s de l'appareil",
      "V√©rification et r√©glage du d√©bit",
      "V√©rification de la cellule d'impaction",
      "Contr√¥le des param√®tres de collecte",
      "Fourniture d'un rapport de test et de calibration"
    ],
    defaultPrice: 330
  },
  liquid_counter: {
    icon: 'üíß',
    title: "√âtalonnage Compteur de Particules en Milieu Liquide",
    prestations: [
      "V√©rification des fonctionnalit√©s du compteur",
      "V√©rification et r√©glage du d√©bit",
      "V√©rification de la cellule de mesure optique",
      "Contr√¥le et r√©glage des seuils de mesures granulom√©trique √† l'aide de sph√®res de latex calibr√©es et certifi√©es",
      "V√©rification en nombre par comparaison √† un √©talon",
      "Fourniture d'un rapport de test et de calibration"
    ],
    defaultPrice: 750
  },
  temp_humidity: {
    icon: 'üå°Ô∏è',
    title: "√âtalonnage Capteur Temp√©rature/Humidit√©",
    prestations: [
      "V√©rification des fonctionnalit√©s du capteur",
      "√âtalonnage temp√©rature sur points de r√©f√©rence certifi√©s",
      "√âtalonnage humidit√© relative",
      "V√©rification de la stabilit√© des mesures",
      "Fourniture d'un certificat d'√©talonnage"
    ],
    defaultPrice: 280
  },
  other: {
    icon: 'üì¶',
    title: "√âtalonnage √âquipement",
    prestations: [
      "V√©rification des fonctionnalit√©s de l'appareil",
      "√âtalonnage selon les sp√©cifications du fabricant",
      "Tests de fonctionnement",
      "Fourniture d'un rapport de test"
    ],
    defaultPrice: 400
  }
};

// ============================================
// REPAIR TEMPLATE - Same for all device types
// ============================================
const REPAIR_TEMPLATE = {
  icon: 'üîß',
  title: "R√©paration",
  prestations: [
    "Diagnostic complet de l'appareil",
    "Identification des composants d√©fectueux",
    "Remplacement des pi√®ces d√©fectueuses (pi√®ces factur√©es en sus)",
    "Tests de fonctionnement complets",
    "V√©rification d'√©talonnage post-r√©paration si applicable"
  ],
  defaultPrice: 200
};

// ============================================
// NETTOYAGE CELLULE - Air particle counters only
// Cell2 models use LD sensor cleaning (different price)
// ============================================

// Models that require cell2 (LD sensor) cleaning - 180‚Ç¨
const CELL2_MODELS = [
  // Solair 1100 series
  'solair 1100', 's1100', 'solair 1100+', 's1100+', 'solair 1100ld', 's1100ld',
  // Solair 1200
  'solair 1200', 's1200',
  // Remote 1100 series  
  'remote 1100', 'r1100', 'remote 1104', 'r1104', 'remote 1102', 'r1102',
  'remote 1100ld', 'r1100ld', 'remote 1104ld', 'r1104ld',
  // Apex 1100
  'apex 1100', 'apex1100'
];

// Check if a model requires cell2 (LD sensor) cleaning
const isCell2Model = (modelName) => {
  if (!modelName) return false;
  const normalized = modelName.toLowerCase().trim().replace(/[\/\-\s]+/g, ' ');
  return CELL2_MODELS.some(m => normalized.includes(m));
};

// ============================================
// MODEL TO CALIBRATION PART NUMBER MAPPING
// Maps detected model names to Cal-XXX part numbers
// ============================================
const MODEL_TO_CAL_PART = {
  // Bio Collectors
  'ac100': 'Cal-AC100',
  'ac100h': 'Cal-AC100H', 
  'ac90': 'Cal-AC90',
  'aes samplair': 'Cal-AESSamplair',
  'airideal': 'Cal-Airideal',
  'airtest': 'Cal-AirTest',
  'mas100': 'Cal-MAS100',
  'mas-100': 'Cal-MAS100',
  'microflow': 'Cal-Microflow',
  'triobas': 'Cal-Triobas',
  'activecount 25h': 'Cal-ActiveCount25H',
  'activecount25h': 'Cal-ActiveCount25H',
  'activecount 100': 'Cal-ActiveCount100',
  'activecount100': 'Cal-ActiveCount100',
  'activecount 100h': 'Cal-ActiveCount100H',
  'activecount100h': 'Cal-ActiveCount100H',
  'remote active count': 'Cal-RemoteActiveCount',
  'scanair': 'Cal-ScanAir',
  'scanair pro': 'Cal-ScanAir',
  
  // Apex Portables
  'apexp3': 'Cal-ApexP3',
  'apex p3': 'Cal-ApexP3',
  'apexp5': 'Cal-ApexP5',
  'apex p5': 'Cal-ApexP5',
  'apexz3': 'Cal-ApexZ3',
  'apex z3': 'Cal-ApexZ3',
  'apexz5': 'Cal-ApexZ5',
  'apex z5': 'Cal-ApexZ5',
  'apexz30': 'Cal-ApexZ30',
  'apex z30': 'Cal-ApexZ30',
  'apexz50': 'Cal-ApexZ50',
  'apex z50': 'Cal-ApexZ50',
  'apex 1100': 'Cal-Apex1100',
  'apex1100': 'Cal-Apex1100',
  
  // Apex Remotes
  'apexr3': 'Cal-ApexR3',
  'apex r3': 'Cal-ApexR3',
  'apexr5': 'Cal-ApexR5',
  'apex r5': 'Cal-ApexR5',
  'apexr03': 'Cal-ApexR03',
  'apex r03': 'Cal-ApexR03',
  'apexr05': 'Cal-ApexR05',
  'apex r05': 'Cal-ApexR05',
  'apexr02': 'Cal-ApexR02',
  'apex r02': 'Cal-ApexR02',
  
  // Apex Remotes + Pump
  'apexr3p': 'Cal-ApexR3P',
  'apex r3p': 'Cal-ApexR3P',
  'apex r3 p': 'Cal-ApexR3P',
  'apexr5p': 'Cal-ApexR5P',
  'apex r5p': 'Cal-ApexR5P',
  'apex r5 p': 'Cal-ApexR5P',
  'apexr03p': 'Cal-ApexR03P',
  'apex r03p': 'Cal-ApexR03P',
  'apex r03 p': 'Cal-ApexR03P',
  'apexr05p': 'Cal-ApexR05P',
  'apex r05p': 'Cal-ApexR05P',
  'apex r05 p': 'Cal-ApexR05P',
  'apexr02p': 'Cal-ApexR02P',
  'apex r02p': 'Cal-ApexR02P',
  'apex r02 p': 'Cal-ApexR02P',
  
  // Handhelds
  'handheld 2016': 'Cal-HH2016',
  'hh 2016': 'Cal-HH2016',
  'hh2016': 'Cal-HH2016',
  'handheld 3013': 'Cal-HH3013',
  'hh 3013': 'Cal-HH3013',
  'hh3013': 'Cal-HH3013',
  'handheld 3016': 'Cal-HH3016',
  'hh 3016': 'Cal-HH3016',
  'hh3016': 'Cal-HH3016',
  'handheld 5016': 'Cal-HH5016',
  'hh 5016': 'Cal-HH5016',
  'hh5016': 'Cal-HH5016',
  'iaq handheld': 'Cal-IAQHH',
  'iaq': 'Cal-IAQHH',
  
  // Solair Standard
  'solair 3100': 'Cal-S3100',
  'solair 3100+': 'Cal-S3100',
  's3100': 'Cal-S3100',
  'solair 3200': 'Cal-S3200',
  'solair 3200+': 'Cal-S3200',
  's3200': 'Cal-S3200',
  'solair 5100': 'Cal-S5100',
  'solair 5100+': 'Cal-S5100',
  's5100': 'Cal-S5100',
  'solair 5200': 'Cal-S5200',
  'solair 5200+': 'Cal-S5200',
  's5200': 'Cal-S5200',
  'solair 3100rx': 'Cal-S3100Rx',
  's3100rx': 'Cal-S3100Rx',
  'solair 5100rx': 'Cal-S5100Rx',
  's5100rx': 'Cal-S5100Rx',
  'solair 3200rx': 'Cal-S3200Rx',
  's3200rx': 'Cal-S3200Rx',
  'solair 5200rx': 'Cal-S5200Rx',
  's5200rx': 'Cal-S5200Rx',
  'solair 3350': 'Cal-S3350',
  's3350': 'Cal-S3350',
  'solair 3350rx': 'Cal-S3350',
  'solair 5350': 'Cal-S5350',
  's5350': 'Cal-S5350',
  'solair 5350rx': 'Cal-S5350',
  'solair 3010': 'Cal-S3010',
  'solair 3010+': 'Cal-S3010',
  's3010': 'Cal-S3010',
  'solair 2010': 'Cal-S2010',
  'solair 2010+': 'Cal-S2010',
  's2010': 'Cal-S2010',
  'solair 1001': 'Cal-S1001',
  'solair 1001+': 'Cal-S1001',
  's1001': 'Cal-S1001',
  
  // Solair Cell2
  'solair 1100': 'Cal-S1100',
  'solair 1100+': 'Cal-S1100',
  's1100': 'Cal-S1100',
  'solair 1100ld': 'Cal-S1100LD',
  's1100ld': 'Cal-S1100LD',
  'solair 1200': 'Cal-S1200',
  's1200': 'Cal-S1200',
  
  // Remote Standard
  'remote 3014': 'Cal-R3014',
  'r3014': 'Cal-R3014',
  'remote 5014': 'Cal-R5014',
  'r5014': 'Cal-R5014',
  'remote 3012': 'Cal-R3012',
  'r3012': 'Cal-R3012',
  'remote 5012': 'Cal-R5012',
  'r5012': 'Cal-R5012',
  'remote 3016': 'Cal-R3016',
  'r3016': 'Cal-R3016',
  'remote 3102': 'Cal-R3102',
  'r3102': 'Cal-R3102',
  'remote 5102': 'Cal-R5102',
  'r5102': 'Cal-R5102',
  'remote 3104': 'Cal-R3104',
  'r3104': 'Cal-R3104',
  'remote 5104': 'Cal-R5104',
  'r5104': 'Cal-R5104',
  'remote 3010': 'Cal-R3010',
  'r3010': 'Cal-R3010',
  'remote 5010': 'Cal-R5010',
  'r5010': 'Cal-R5010',
  'remote 2010': 'Cal-R2010',
  'r2010': 'Cal-R2010',
  'remote 2012': 'Cal-R2012',
  'r2012': 'Cal-R2012',
  'remote 3014i': 'Cal-R3014i',
  'r3014i': 'Cal-R3014i',
  'remote 5014i': 'Cal-R5014i',
  'r5014i': 'Cal-R5014i',
  'remote 2014i': 'Cal-R2014i',
  'r2014i': 'Cal-R2014i',
  'remote 5104v': 'Cal-R5104V',
  'r5104v': 'Cal-R5104V',
  'remote 3104v': 'Cal-R3104V',
  'r3104v': 'Cal-R3104V',
  'remote 5102v': 'Cal-R5102V',
  'r5102v': 'Cal-R5102V',
  'remote 50104v': 'Cal-R50104V',
  'r50104v': 'Cal-R50104V',
  'remote 50104': 'Cal-R50104',
  'r50104': 'Cal-R50104',
  'remote 5100': 'Cal-R5100',
  'r5100': 'Cal-R5100',
  'remote cems': 'Cal-RCEMS',
  
  // Remote + Pump
  'remote 3014p': 'Cal-R3014P',
  'r3014p': 'Cal-R3014P',
  'remote 5014p': 'Cal-R5014P',
  'r5014p': 'Cal-R5014P',
  'remote 2014p': 'Cal-R2014P',
  'r2014p': 'Cal-R2014P',
  'remote 5104p': 'Cal-R5104P',
  'r5104p': 'Cal-R5104P',
  'remote 3104p': 'Cal-R3104P',
  'r3104p': 'Cal-R3104P',
  
  // Remote Cell2
  'remote 1100': 'Cal-R1100',
  'r1100': 'Cal-R1100',
  'remote 1104': 'Cal-R1104',
  'r1104': 'Cal-R1104',
  'remote 1102': 'Cal-R1102',
  'r1102': 'Cal-R1102',
  'remote 1100ld': 'Cal-R1100LD',
  'r1100ld': 'Cal-R1100LD',
  'remote 1104ld': 'Cal-R1104LD',
  'r1104ld': 'Cal-R1104LD',
  'remote 2014': 'Cal-R2014',
  'r2014': 'Cal-R2014',
  
  // Boulder
  'boulder': 'Cal-Boulder',
  'boulder counter': 'Cal-Boulder',
  
  // Liquid Counters
  'ls-20': 'Cal-LS20',
  'ls20': 'Cal-LS20',
  'ls-60': 'Cal-LS60',
  'ls60': 'Cal-LS60',
  'vertex 50': 'Cal-Vertex50',
  'vertex50': 'Cal-Vertex50',
  'vertex 50c': 'Cal-Vertex50C',
  'vertex50c': 'Cal-Vertex50C',
  'vertex 100': 'Cal-Vertex100',
  'vertex100': 'Cal-Vertex100',
  'nanocount': 'Cal-NanoCount',
  'nc50': 'Cal-NanoCount',
  'nc50+': 'Cal-NanoCount',
  'nc65c': 'Cal-NanoCount',
  'nc65c+': 'Cal-NanoCount',
  'nc25': 'Cal-NanoCount',
  'nc25+': 'Cal-NanoCount',
  'nc30': 'Cal-NanoCount',
  'nc30+': 'Cal-NanoCount',
  'remote lpc': 'Cal-RemoteLPC',
  
  // Temp/Humidity
  'trh sensor': 'Cal-TRHSensor',
  'trh probe': 'Cal-TRHProbe',
  'trh wand': 'Cal-TRHWand',
  
  // Other
  'diluter': 'Cal-Diluter',
  'particle diluter': 'Cal-Diluter',
  'hpc1100': 'Cal-HPC1100',
  'hpc 1100': 'Cal-HPC1100',
  'rac': 'Cal-RAC'
};

// Get calibration part number from model name
const getCalibrationPartNumber = (modelName) => {
  if (!modelName) return null;
  const normalized = modelName.toLowerCase().trim().replace(/[\/\-]+/g, ' ').replace(/\s+/g, ' ');
  
  // Try exact match first
  if (MODEL_TO_CAL_PART[normalized]) {
    return MODEL_TO_CAL_PART[normalized];
  }
  
  // Try partial matches
  for (const [key, partNumber] of Object.entries(MODEL_TO_CAL_PART)) {
    if (normalized.includes(key) || key.includes(normalized)) {
      return partNumber;
    }
  }
  
  return null;
};

// Get cell cleaning part number based on model
const getCellCleaningPartNumber = (modelName) => {
  return isCell2Model(modelName) ? 'cell2' : 'cell1';
};

const NETTOYAGE_TEMPLATE = {
  icon: '‚ú®',
  title: "Nettoyage Cellule de Mesure",
  prestations: [
    "D√©montage de la cellule de mesure optique",
    "Nettoyage des composants optiques (lentilles, miroirs)",
    "Nettoyage du circuit fluidique",
    "V√©rification de l'√©tat des joints et connexions",
    "Remontage et test d'√©tanch√©it√©"
  ],
  // Get cell type for pricing lookup
  getCellType: (modelName) => isCell2Model(modelName) ? 'cell2' : 'cell1',
  getPartNumber: (modelName) => getCellCleaningPartNumber(modelName)
};

// ============================================
// DISCLAIMERS
// ============================================
const QUOTE_DISCLAIMERS = [
  "Cette offre n'inclut pas la r√©paration ou l'√©change de pi√®ces non consommables.",
  "Un devis compl√©mentaire sera √©tabli si des pi√®ces sont trouv√©es d√©fectueuses et n√©cessitent un remplacement.",
  "Les mesures stock√©es dans les appareils seront √©ventuellement perdues lors des op√©rations de maintenance.",
  "Les √©quipements envoy√©s devront √™tre d√©contamin√©s de toutes substances chimiques, bact√©riennes ou radioactives."
];

// France Metropolitan check for shipping
const isFranceMetropolitan = (postalCode) => {
  if (!postalCode) return false;
  const cleaned = postalCode.toString().replace(/\s/g, '');
  if (!/^\d{5}$/.test(cleaned)) return false;
  const dept = parseInt(cleaned.substring(0, 2), 10);
  return dept >= 1 && dept <= 95;
};

// ============================================
// QUOTE EDITOR MODAL
// ============================================
function QuoteEditorModal({ request, onClose, notify, reload, profile, businessSettings, lang = 'fr' }) {
  const t = k => k;
  const [step, setStep] = useState(1); // 1=Edit Pricing, 2=Preview, 3=Confirm
  const [devicePricing, setDevicePricing] = useState([]);
  const [saving, setSaving] = useState(false);
  const [quoteRef, setQuoteRef] = useState('');
  const [contractInfo, setContractInfo] = useState(null); // Active contract data
  const [loadingContract, setLoadingContract] = useState(true);
  const [editingDeviceIndex, setEditingDeviceIndex] = useState(null); // For editing device details
  const [partsCache, setPartsCache] = useState({}); // Cache of part prices
  const [partsDescriptionCache, setPartsDescriptionCache] = useState({}); // Cache of part descriptions
  const [loadingParts, setLoadingParts] = useState(true); // Loading state for parts
  
  // Revision state
  const isRevision = request?.status === 'quote_revision_requested';
  const needsCorrection = !!(request?.quote_rejection_notes && request?.quote_data);
  const existingQuoteData = request?.quote_data || null;
  const clientRevisionNotes = request?.quote_revision_notes || '';
  const currentRevisionCount = request?.quote_revision_count || 0;
  const [declineMode, setDeclineMode] = useState(false);
  const [declineNotes, setDeclineNotes] = useState('');
  
  // Shipping state - based on parcels count from RMA request
  const parcelsCount = request?.parcels_count || 1;
  const [shippingData, setShippingData] = useState({
    partNumber: 'Shipping1',
    unitPrice: 45, // Default, will be updated from parts cache
    parcels: parcelsCount,
    total: 45 * parcelsCount
  });

  // Discount state
  const [discountData, setDiscountData] = useState({
    enabled: false,
    type: 'fixed', // 'fixed' or 'percentage'
    value: 0,
    note: ''
  });

  const devices = request?.request_devices || [];
  const signatory = profile?.full_name || 'Lighthouse France';
  const today = new Date();
  
  // Check if client is in France Metropolitan for shipping
  const clientPostalCode = request?.companies?.billing_postal_code || 
                           request?.companies?.postal_code || 
                           '';
  const isMetro = clientPostalCode ? isFranceMetropolitan(clientPostalCode) : true;
  const defaultShipping = isMetro ? 45 : 0;

  // ============================================
  // LOAD CALIBRATION PARTS PRICES FROM DATABASE
  // ============================================
  useEffect(() => {
    const loadCalibrationParts = async () => {
      setLoadingParts(true);
      try {
        // Load parts in batches to get all of them
        let allCalParts = [];
        let offset = 0;
        const batchSize = 1000;
        let hasMore = true;
        
        while (hasMore) {
          const { data, error } = await supabase
            .from('parts_pricing')
            .select('part_number, unit_price, description, description_fr')
            .range(offset, offset + batchSize - 1);
          
          if (error) {
            console.error('Error loading parts batch:', error);
            break;
          }
          
          if (data && data.length > 0) {
            allCalParts = [...allCalParts, ...data];
            offset += batchSize;
            hasMore = data.length === batchSize;
            console.log(`üì¶ Loaded batch: ${data.length} parts`);
          } else {
            hasMore = false;
          }
        }
        
        // Build cache with price AND description
        const cache = {};
        const descCache = {};
        allCalParts.forEach(p => {
          const pn = p.part_number || '';
          cache[pn] = p.unit_price;
          descCache[pn] = p.description_fr || p.description || '';
        });
        
        setPartsCache(cache);
        setPartsDescriptionCache(descCache);
        
        // Update shipping price if Shipping1 is in the cache
        if (cache['Shipping1']) {
          setShippingData(prev => ({
            ...prev,
            unitPrice: cache['Shipping1'],
            total: cache['Shipping1'] * prev.parcels
          }));
        }
        
        // Filter for Cal- parts for logging
        const calParts = Object.keys(cache).filter(k => k.startsWith('Cal-') || k === 'cell1' || k === 'cell2');
        console.log('üì¶ Total parts loaded:', Object.keys(cache).length);
        console.log('üì¶ Calibration parts:', calParts.length);
        
        // Check specifically for Cal-S3200
        if (cache['Cal-S3200']) {
          console.log('‚úÖ Cal-S3200 found in cache:', cache['Cal-S3200']);
        } else {
          console.log('‚ùå Cal-S3200 NOT found in cache');
          console.log('üìã Available Cal- parts:', calParts);
        }
      } catch (err) {
        console.error('Parts cache error:', err);
      }
      setLoadingParts(false);
    };
    loadCalibrationParts();
  }, []);

  // Helper to get price from parts cache
  const getPartPrice = (partNumber, fallback = 0) => {
    return partsCache[partNumber] ?? fallback;
  };

  // ============================================
  // CONTRACT DETECTION - Match by serial number
  // ============================================
  useEffect(() => {
    const checkContract = async () => {
      // Trim whitespace and normalize serial numbers (case-insensitive)
      const deviceSerials = devices.map(d => (d.serial_number || '').trim().toUpperCase()).filter(Boolean);
      console.log('üîç Checking contracts for serial numbers:', deviceSerials);
      
      if (deviceSerials.length === 0) {
        console.log('‚ùå No serial numbers to check');
        setLoadingContract(false);
        return;
      }
      
      const todayStr = new Date().toISOString().split('T')[0];
      console.log('üìÖ Today:', todayStr);
      
      try {
        // First, get all active contracts (include BC fields for copying to RMA)
        const { data: activeContracts, error: contractError } = await supabase
          .from('contracts')
          .select('id, contract_number, start_date, end_date, company_id, bc_file_url, signed_quote_url, bc_signed_by')
          .eq('status', 'active')
          .lte('start_date', todayStr)
          .gte('end_date', todayStr);
        
        console.log('üìã Active contracts found:', activeContracts?.length || 0, activeContracts);
        if (contractError) console.error('Contract query error:', contractError);
        
        if (contractError) {
          // Log error but don't block - just skip contract detection
          console.warn('Contract query error (continuing without contract check):', contractError);
          setLoadingContract(false);
          return;
        }
        
        if (!activeContracts || activeContracts.length === 0) {
          console.log('‚ÑπÔ∏è No active contracts found for this date range');
          // Also check if there are any active contracts at all (ignoring date)
          const { data: allActive } = await supabase
            .from('contracts')
            .select('id, contract_number, start_date, end_date, status')
            .eq('status', 'active');
          console.log('üìã All active contracts (any date):', allActive);
          setLoadingContract(false);
          return;
        }
        
        // Get contract IDs
        const contractIds = activeContracts.map(c => c.id);
        console.log('üìã Contract IDs:', contractIds);
        
        // Now get contract devices separately
        const { data: contractDevicesData, error: devicesError } = await supabase
          .from('contract_devices')
          .select('*')
          .in('contract_id', contractIds);
        
        console.log('üìã Contract devices found:', contractDevicesData?.length || 0);
        contractDevicesData?.forEach(cd => {
          console.log(`  - Device: ${cd.serial_number} (contract_id: ${cd.contract_id})`);
        });
        
        if (devicesError) {
          console.error('Contract devices query error:', devicesError);
          setLoadingContract(false);
          return;
        }
        
        // Build map of serial numbers to contract devices (case-insensitive)
        const deviceMap = {};
        let matchedContract = null;
        
        for (const cd of (contractDevicesData || [])) {
          const contract = activeContracts.find(c => c.id === cd.contract_id);
          if (!contract) continue;
          
          const tokensRemaining = (cd.tokens_total || 0) - (cd.tokens_used || 0);
          const serialTrimmed = (cd.serial_number || '').trim().toUpperCase();
          
          // Check if this contract device matches any RMA device
          if (deviceSerials.includes(serialTrimmed)) {
            console.log(`‚úÖ MATCH! Serial "${serialTrimmed}" found in contract ${contract.contract_number}`);
            matchedContract = contract;
          }
          
          deviceMap[serialTrimmed] = {
            contract_id: contract.id,
            contract_number: contract.contract_number,
            contract_device_id: cd.id,
            tokens_remaining: tokensRemaining,
            tokens_total: cd.tokens_total || 0,
            unit_price: cd.unit_price || 0
          };
        }
        
        console.log('üìã Device map built:', Object.keys(deviceMap));
        
        // Check which RMA devices are in the map
        let hasMatch = false;
        deviceSerials.forEach(sn => {
          if (deviceMap[sn]) {
            console.log(`‚úÖ RMA device "${sn}" is covered by contract ${deviceMap[sn].contract_number}, tokens remaining: ${deviceMap[sn].tokens_remaining}`);
            hasMatch = true;
          } else {
            console.log(`‚ùå RMA device "${sn}" is NOT in any contract`);
          }
        });
        
        if (hasMatch) {
          setContractInfo({
            contracts: activeContracts,
            primaryContract: matchedContract || activeContracts[0],
            deviceMap
          });
          console.log('‚úÖ Contract info set!');
        } else {
          console.log('‚ùå No matching serial numbers found in contracts');
        }
      } catch (err) {
        console.error('Contract check error:', err);
      }
      
      setLoadingContract(false);
    };
    
    checkContract();
  }, [devices]);

  // Determine which service sections are needed based on CURRENT devicePricing (reactive)
  const getRequiredSections = (pricingData) => {
    const sections = { calibration: new Set(), repair: false, hasAirParticleCounter: false };
    
    pricingData.forEach(d => {
      if (d.needsCalibration) {
        sections.calibration.add(d.deviceType);
        if (d.deviceType === 'particle_counter') {
          sections.hasAirParticleCounter = true;
        }
      }
      if (d.needsRepair) {
        sections.repair = true;
      }
    });
    
    return {
      calibrationTypes: Array.from(sections.calibration),
      hasRepair: sections.repair,
      hasAirParticleCounter: sections.hasAirParticleCounter
    };
  };

  // Compute from devicePricing so it updates when user edits devices
  const requiredSections = getRequiredSections(devicePricing);

  useEffect(() => {
    if (loadingContract || loadingParts) return; // Wait for contract check AND parts loading
    
    console.log('üìä Initializing device pricing, contractInfo:', contractInfo, 'partsCache:', Object.keys(partsCache).length, 'parts');
    
    // Generate quote reference
    const year = today.getFullYear().toString().slice(-2);
    const month = String(today.getMonth() + 1).padStart(2, '0');
    setQuoteRef(`LH/${year}${month}/XXX`);
    
    // Initialize device pricing from request
    if (devices.length > 0) {
      // If this is a revision or correction with saved quote data, restore the previous pricing
      const savedDevices = (isRevision || needsCorrection) && existingQuoteData?.devices;
      
      console.log('üîç QuoteEditor init:', {
        isRevision,
        needsCorrection,
        hasQuoteData: !!request?.quote_data,
        hasRejectionNotes: !!request?.quote_rejection_notes,
        rejectionNotes: request?.quote_rejection_notes,
        savedDevicesCount: savedDevices ? savedDevices.length : 0,
        existingQuoteData: existingQuoteData ? Object.keys(existingQuoteData) : null,
        requestStatus: request?.status
      });
      if (savedDevices) {
        console.log('‚úÖ Restoring saved pricing:', savedDevices.map(sd => `${sd.model} ${sd.serial}: cal=${sd.calibrationPrice} rep=${sd.repairPrice} nett=${sd.nettoyagePrice}`));
      }
      
      setDevicePricing(devices.map((d, i) => {
        const deviceType = d.device_type || 'particle_counter';
        const serviceType = d.service_type || 'calibration';
        const needsCal = serviceType.includes('calibration') || serviceType === 'calibration_repair' || serviceType === 'cal_repair';
        const needsRepair = serviceType.includes('repair') || serviceType === 'calibration_repair' || serviceType === 'cal_repair';
        
        const calTemplate = CALIBRATION_TEMPLATES[deviceType] || CALIBRATION_TEMPLATES.particle_counter;
        const modelName = d.model_name || '';
        const serialTrimmed = (d.serial_number || '').trim();
        
        // Try to find matching saved device data for revision pre-fill
        const savedDevice = savedDevices 
          ? savedDevices.find(sd => sd.serial === serialTrimmed) || savedDevices[i]
          : null;
        
        // Get calibration part number and price from parts database
        const calPartNumber = savedDevice?.calPartNumber || getCalibrationPartNumber(modelName);
        const calPrice = calPartNumber && partsCache[calPartNumber] 
          ? partsCache[calPartNumber] 
          : calTemplate.defaultPrice;
        
        // Determine nettoyage cell type for air particle counters
        const needsNettoyage = savedDevice ? (savedDevice.needsNettoyage ?? (needsCal && deviceType === 'particle_counter')) : (needsCal && deviceType === 'particle_counter');
        const nettoyageCellType = needsNettoyage ? NETTOYAGE_TEMPLATE.getCellType(modelName) : null;
        const nettoyagePartNumber = needsNettoyage ? NETTOYAGE_TEMPLATE.getPartNumber(modelName) : null;
        // Get nettoyage price from parts cache (cell1 or cell2)
        const nettoyagePrice = needsNettoyage 
          ? (partsCache[nettoyagePartNumber] ?? (nettoyageCellType === 'cell2' ? 180 : 150))
          : 0;
        
        // Check contract coverage - trim serial number for matching
        const contractDevice = contractInfo?.deviceMap?.[serialTrimmed];
        const isContractCovered = needsCal && contractDevice && contractDevice.tokens_remaining > 0;
        const tokensExhausted = needsCal && contractDevice && contractDevice.tokens_remaining <= 0;
        
        console.log(`üìä Device ${serialTrimmed}: model="${modelName}", calPart=${calPartNumber}, price=${calPrice}, nettoyage=${nettoyageCellType}${savedDevice ? ' (restored from quote_data)' : ''}`);
        
        return {
          id: d.id || `device-${i}`,
          model: modelName,
          serial: serialTrimmed,
          deviceType: deviceType,
          serviceType: serviceType,
          needsCalibration: needsCal,
          needsRepair: needsRepair,
          customerNotes: d.notes || d.problem_description || '',
          // Contract coverage
          isContractCovered: isContractCovered,
          tokensExhausted: tokensExhausted,
          contractDeviceId: contractDevice?.contract_device_id || null,
          contractId: contractDevice?.contract_id || null,
          tokensRemaining: contractDevice?.tokens_remaining || 0,
          // Calibration part number for reference
          calPartNumber: calPartNumber,
          // Nettoyage cellule (air particle counters only)
          needsNettoyage: needsNettoyage,
          nettoyageCellType: nettoyageCellType,
          nettoyagePartNumber: nettoyagePartNumber,
          nettoyageQty: 1,
          nettoyagePrice: isContractCovered ? 0 : (savedDevice ? (parseFloat(savedDevice.nettoyagePrice) || nettoyagePrice) : nettoyagePrice),
          hideNettoyageOnQuote: false, // Option to hide nettoyage on quote (price still included)
          // Pricing - restore from saved data if revision, otherwise calculate fresh
          calibrationQty: 1,
          calibrationPrice: isContractCovered ? 0 : (savedDevice ? (parseFloat(savedDevice.calibrationPrice) || 0) : (needsCal ? calPrice : 0)),
          repairQty: 1,
          repairPrice: savedDevice ? (parseFloat(savedDevice.repairPrice) || 0) : (needsRepair ? REPAIR_TEMPLATE.defaultPrice : 0),
          repairPartNumber: savedDevice?.repairPartNumber || '',
          additionalParts: savedDevice?.additionalParts || [],
          shippingPartNumber: 'Shipping1',
          shipping: isContractCovered ? 0 : defaultShipping
        };
      }));

      // Also restore shipping data from saved quote if revision or correction
      if (savedDevices && existingQuoteData?.shipping) {
        const savedShipping = existingQuoteData.shipping;
        setShippingData(prev => ({
          ...prev,
          unitPrice: savedShipping.unitPrice || prev.unitPrice,
          parcels: savedShipping.parcels || prev.parcels,
          total: savedShipping.total || prev.total
        }));
      }
      // Restore discount data if saved
      if (existingQuoteData?.discount) {
        setDiscountData(existingQuoteData.discount);
      }
    }
  }, [loadingContract, loadingParts, contractInfo, partsCache]);

  // Update device pricing with automatic recalculation for type/service changes
  const updateDevice = (deviceId, field, value) => {
    setDevicePricing(prev => prev.map(d => {
      if (d.id !== deviceId) return d;
      
      const updated = { ...d, [field]: value };
      
      // Helper to calculate nettoyage price
      const calcNettoyagePrice = (model, deviceType, needsCal, isContractCovered) => {
        if (!needsCal || deviceType !== 'particle_counter') return { needsNettoyage: false, nettoyageCellType: null, nettoyagePartNumber: null, nettoyagePrice: 0 };
        const cellType = NETTOYAGE_TEMPLATE.getCellType(model);
        const partNumber = NETTOYAGE_TEMPLATE.getPartNumber(model);
        const price = isContractCovered ? 0 : (partsCache[partNumber] ?? (cellType === 'cell2' ? 180 : 150));
        return { needsNettoyage: true, nettoyageCellType: cellType, nettoyagePartNumber: partNumber, nettoyagePrice: price };
      };
      
      // Helper to get calibration price from parts cache
      const getCalPrice = (model, deviceType) => {
        const calPartNumber = getCalibrationPartNumber(model);
        if (calPartNumber && partsCache[calPartNumber]) {
          return { calPartNumber, price: partsCache[calPartNumber] };
        }
        const template = CALIBRATION_TEMPLATES[deviceType] || CALIBRATION_TEMPLATES.particle_counter;
        return { calPartNumber, price: template.defaultPrice };
      };
      
      // If device type changed, update calibration and nettoyage pricing
      if (field === 'deviceType') {
        // Only update price if not contract covered
        if (!d.isContractCovered && d.needsCalibration) {
          const { calPartNumber, price } = getCalPrice(d.model, value);
          updated.calPartNumber = calPartNumber;
          updated.calibrationPrice = price;
        }
        // Update nettoyage based on new device type
        const nettoyage = calcNettoyagePrice(d.model, value, d.needsCalibration, d.isContractCovered);
        Object.assign(updated, nettoyage);
      }
      
      // If model changed, update calibration price and nettoyage cell type
      if (field === 'model') {
        if (!d.isContractCovered && d.needsCalibration) {
          const { calPartNumber, price } = getCalPrice(value, d.deviceType);
          updated.calPartNumber = calPartNumber;
          updated.calibrationPrice = price;
        }
        const nettoyage = calcNettoyagePrice(value, d.deviceType, d.needsCalibration, d.isContractCovered);
        Object.assign(updated, nettoyage);
      }
      
      // If service type changed, update needs flags and recalculate prices
      if (field === 'serviceType') {
        const newNeedsCal = value.includes('calibration') || value === 'cal_repair' || value === 'calibration_repair';
        const newNeedsRepair = value.includes('repair') || value === 'cal_repair' || value === 'calibration_repair';
        
        updated.needsCalibration = newNeedsCal;
        updated.needsRepair = newNeedsRepair;
        
        // Update calibration prices
        if (newNeedsCal && !d.needsCalibration && !d.isContractCovered) {
          const { calPartNumber, price } = getCalPrice(d.model, d.deviceType);
          updated.calPartNumber = calPartNumber;
          updated.calibrationPrice = price;
        } else if (!newNeedsCal) {
          updated.calibrationPrice = 0;
        }
        
        // Update repair prices
        if (newNeedsRepair && !d.needsRepair) {
          updated.repairPrice = REPAIR_TEMPLATE.defaultPrice;
        } else if (!newNeedsRepair) {
          updated.repairPrice = 0;
        }
        
        // Update nettoyage based on new service type
        const nettoyage = calcNettoyagePrice(d.model, d.deviceType, newNeedsCal, d.isContractCovered);
        Object.assign(updated, nettoyage);
      }
      
      return updated;
    }));
  };

  // Add part to device
  const addPart = (deviceId) => {
    setDevicePricing(prev => prev.map(d => {
      if (d.id === deviceId) {
        return { ...d, additionalParts: [...d.additionalParts, { id: Date.now(), quantity: 1, partNumber: '', description: '', price: 0 }] };
      }
      return d;
    }));
  };

  // Update part
  const updatePart = (deviceId, partId, field, value) => {
    setDevicePricing(prev => prev.map(d => {
      if (d.id === deviceId) {
        return { ...d, additionalParts: d.additionalParts.map(p => p.id === partId ? { ...p, [field]: value } : p) };
      }
      return d;
    }));
  };

  // Remove part
  const removePart = (deviceId, partId) => {
    setDevicePricing(prev => prev.map(d => {
      if (d.id === deviceId) {
        return { ...d, additionalParts: d.additionalParts.filter(p => p.id !== partId) };
      }
      return d;
    }));
  };

  // Calculate device subtotal (services only, no shipping)
  const getDeviceServiceTotal = (d) => {
    let total = 0;
    if (d.needsCalibration) total += (d.calibrationQty || 1) * d.calibrationPrice;
    if (d.needsNettoyage) total += (d.nettoyageQty || 1) * (d.nettoyagePrice || 0);
    if (d.needsRepair) total += (d.repairQty || 1) * d.repairPrice;
    // Account for quantity in additional parts
    total += d.additionalParts.reduce((sum, p) => sum + ((parseFloat(p.price) || 0) * (parseInt(p.quantity) || 1)), 0);
    return total;
  };

  // Get device type label
  const getDeviceTypeLabel = (type) => {
    const labels = {
      particle_counter: lang === 'en' ? 'Particle Counter (Air)' : 'Compteur Particules (Air)',
      bio_collector: lang === 'en' ? 'Bio Collector' : 'Bio Collecteur',
      liquid_counter: lang === 'en' ? 'Particle Counter (Liquid)' : 'Compteur Particules (Liquide)',
      temp_humidity: lang === 'en' ? 'Temp/Humidity Sensor' : 'Capteur Temp/Humidit√©',
      other: 'Autre'
    };
    return labels[type] || type;
  };

  // Check if fully covered by contract (all calibrations covered, no repairs)
  const isFullyContractCovered = devicePricing.every(d => {
    if (d.needsCalibration && !d.isContractCovered) return false;
    if (d.needsRepair) return false; // Repairs are not covered
    return true;
  }) && devicePricing.some(d => d.isContractCovered);
  
  // Check if any device is contract covered
  const hasContractCoveredDevices = devicePricing.some(d => d.isContractCovered);

  // Calculate totals - shipping is 0 when fully contract covered
  const servicesSubtotal = devicePricing.reduce((sum, d) => sum + getDeviceServiceTotal(d), 0);
  const shippingTotal = isFullyContractCovered ? 0 : shippingData.total;
  const subtotalBeforeDiscount = servicesSubtotal + shippingTotal;
  const discountAmount = discountData.enabled 
    ? (discountData.type === 'percentage' 
        ? Math.round((subtotalBeforeDiscount * (parseFloat(discountData.value) || 0) / 100) * 100) / 100
        : (parseFloat(discountData.value) || 0))
    : 0;
  const grandTotal = Math.max(0, subtotalBeforeDiscount - discountAmount);

  // Send quote (or auto-approve for contract)
  const sendQuote = async () => {
    setSaving(true);
    
    let rmaNumber = request.request_number;
    if (!rmaNumber) {
      // Try to use database function first
      try {
        const { data: rmaData, error: rmaError } = await supabase.rpc('get_next_rma_number');
        if (!rmaError && rmaData) {
          rmaNumber = rmaData;
        }
      } catch (e) {
        console.error('Could not use get_next_rma_number:', e);
      }
      
      // Fallback to old method if function doesn't exist
      if (!rmaNumber) {
        const { data } = await supabase.from('service_requests').select('request_number').like('request_number', 'FR-%').order('request_number', { ascending: false }).limit(1);
        const lastNum = data?.[0]?.request_number ? parseInt(data[0].request_number.replace('FR-', '')) : 0;
        rmaNumber = 'FR-' + String(lastNum + 1).padStart(5, '0');
      }
    }
    
    // For revisions, keep the existing quote number and increment revision count
    // For new quotes, generate a new number
    let quoteNumber = null;
    let newRevisionCount = 0;
    
    if (isRevision && request.quote_number) {
      // Keep same quote number, increment revision
      quoteNumber = request.quote_number;
      newRevisionCount = currentRevisionCount + 1;
    } else {
      // New quote - get next document number
      try {
        const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'DEV' });
        if (!docNumError && docNumData) {
          quoteNumber = docNumData;
        }
      } catch (e) {
        console.error('Could not generate document number:', e);
      }
    }

    // Save complete quote data
    const quoteData = {
      devices: devicePricing.map(d => ({
        model: d.model,
        serial: d.serial,
        deviceType: d.deviceType,
        serviceType: d.serviceType,
        needsCalibration: d.needsCalibration,
        needsRepair: d.needsRepair,
        calPartNumber: d.calPartNumber,
        needsNettoyage: d.needsNettoyage,
        nettoyageCellType: d.nettoyageCellType,
        nettoyagePartNumber: d.nettoyagePartNumber,
        nettoyagePrice: d.nettoyagePrice,
        calibrationPrice: d.calibrationPrice,
        repairPartNumber: d.repairPartNumber,
        repairPrice: d.repairPrice,
        additionalParts: d.additionalParts,
        serviceTotal: getDeviceServiceTotal(d),
        // Contract info
        isContractCovered: d.isContractCovered,
        contractDeviceId: d.contractDeviceId,
        contractNumber: d.isContractCovered ? contractInfo?.primaryContract?.contract_number : null,
        tokensRemaining: d.tokensRemaining
      })),
      shipping: {
        partNumber: shippingData.partNumber,
        parcels: shippingData.parcels,
        unitPrice: shippingData.unitPrice,
        total: shippingData.total
      },
      discount: discountData.enabled ? {
        enabled: true,
        type: discountData.type,
        value: parseFloat(discountData.value) || 0,
        note: discountData.note,
        amount: discountAmount
      } : { enabled: false },
      requiredSections,
      servicesSubtotal,
      shippingTotal,
      discountAmount,
      grandTotal,
      isMetro,
      isContractRMA: hasContractCoveredDevices,
      createdBy: signatory,
      createdAt: new Date().toISOString()
    };

    // === QUOTE REVIEW: Submit for review instead of sending directly ===
    if (!isFullyContractCovered) {
      try {
        const deviceSummary = devicePricing.map(d => `${d.model} (${d.serial})`).join(', ');
        
        await submitForQuoteReview({
          serviceRequestId: request.id,
          quoteType: isRevision ? 'revision' : 'initial',
          quoteData: {
            ...quoteData,
            rmaNumber,
            quoteNumber,
            newRevisionCount: newRevisionCount || 0,
            isRevision: !!isRevision,
            isMetro,
            hasContractCoveredDevices,
            contractInfo: contractInfo ? { primaryContract: { id: contractInfo?.primaryContract?.id, contract_number: contractInfo?.primaryContract?.contract_number } } : null,
            businessSettings: businessSettings || {},
            signatory
          },
          quoteNumber,
          rmaNumber,
          clientName: request.companies?.name || 'Client inconnu',
          totalAmount: grandTotal,
          deviceSummary,
          previousStatus: request.status,
          serviceRequestUpdate: {
            request_number: rmaNumber,
            quote_number: quoteNumber,
            quoted_at: new Date().toISOString(),
            quote_total: grandTotal,
            quote_subtotal: servicesSubtotal,
            quote_shipping: shippingTotal,
            quote_discount: discountAmount,
            quote_data: quoteData,
            quote_revision_notes: null,
            is_contract_rma: hasContractCoveredDevices,
            contract_id: hasContractCoveredDevices ? contractInfo?.primaryContract?.id : null,
            ...(isRevision ? { quote_revision_count: newRevisionCount, bc_file_url: null, bc_submitted_at: null, bc_approved_at: null, bc_signed_by: null, bc_signature_date: null, bc_signature_url: null, signed_quote_url: null, quote_approved_at: null } : {})
          },
          profile
        });
        
        notify(lang === 'en' 
          ? `üìã Quote submitted for review! ${quoteNumber || rmaNumber}` 
          : `üìã Devis soumis pour v√©rification ! ${quoteNumber || rmaNumber}`);
        reload(); 
        onClose();
      } catch (err) {
        notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
      }
      setSaving(false);
      return;
    }
    // === END QUOTE REVIEW ‚Äî below only runs for fully contract-covered RMAs ===

    try {
      // === REVISION: Archive old quote PDF as internal attachment before generating new one ===
      if (isRevision && request.quote_url) {
        try {
          const revLabel = currentRevisionCount > 0 ? `Rev-${currentRevisionCount}` : 'Original';
          const { error: archErr } = await supabase.from('request_attachments').insert({
            request_id: request.id,
            file_url: request.quote_url,
            file_name: `${rmaNumber}_devis_${revLabel}.pdf`,
            category: 'internal_devis_revision',
            notes: `Devis ${revLabel} - archiv√© le ${new Date().toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}`
          });
          if (archErr) {
            console.error('Archive insert error:', archErr);
          } else {
            console.log(`üìÇ Archived old quote as internal_devis_revision (${revLabel})`);
          }
        } catch (archiveErr) {
          console.error('Could not archive old quote:', archiveErr);
          // Continue even if archive fails
        }
      }

      // Generate Quote PDF
      let quoteUrl = null;
      try {
        const rmaForPDF = {
          ...request,
          request_number: rmaNumber,
          companies: request.companies
        };
        
        const pdfBlob = await generateQuotePDF(rmaForPDF, devicePricing, {
          shipping: shippingData,
          devicePricing: devicePricing,
          servicesSubtotal: servicesSubtotal,
          shippingTotal: shippingTotal,
          discount: discountData.enabled ? { ...discountData, amount: discountAmount } : null,
          grandTotal: grandTotal,
          isContractRMA: hasContractCoveredDevices,
          isFullyContractCovered: isFullyContractCovered,
          quoteNumber: quoteNumber,
          revisionNumber: newRevisionCount,
          businessSettings: businessSettings || {},
          quoteSettings: businessSettings?.quote_settings || null
        });
        const revSuffix = newRevisionCount > 0 ? `_rev${newRevisionCount}` : '';
        const fileName = `${rmaNumber}_devis${revSuffix}_${Date.now()}.pdf`;
        quoteUrl = await uploadPDFToStorage(pdfBlob, `quotes/${rmaNumber}`, fileName);
      } catch (pdfErr) {
        console.error('PDF generation error:', pdfErr);
        // Continue without PDF if it fails
      }

      // Determine status and whether to auto-approve
      let newStatus = 'quote_sent';
      let contractBcFileUrl = null;
      let contractSignedQuoteUrl = null;
      let bcSignedBy = null;
      
      // If fully contract covered (calibration only, all covered), auto-approve
      if (isFullyContractCovered) {
        newStatus = 'waiting_device'; // Skip quote approval, go straight to waiting
        // Copy BC from contract - get both bc_file_url and signed_quote_url
        contractBcFileUrl = contractInfo?.primaryContract?.bc_file_url;
        contractSignedQuoteUrl = contractInfo?.primaryContract?.signed_quote_url;
        bcSignedBy = contractInfo?.primaryContract?.bc_signed_by || 'Contrat';
        console.log('üìã Contract BC URL:', contractBcFileUrl);
        console.log('üìã Contract Signed Quote URL:', contractSignedQuoteUrl);
        console.log('üìã Signed by:', bcSignedBy);
      }

      const updateData = {
        request_number: rmaNumber,
        quote_number: quoteNumber,
        status: newStatus,
        quoted_at: new Date().toISOString(),
        quote_total: grandTotal,
        quote_subtotal: servicesSubtotal,
        quote_shipping: shippingTotal,
        quote_discount: discountAmount,
        quote_data: quoteData,
        quote_revision_notes: null,
        // Contract fields
        is_contract_rma: hasContractCoveredDevices,
        contract_id: hasContractCoveredDevices ? contractInfo?.primaryContract?.id : null
      };
      
      // If this is a revision, reset BC/signature fields so client re-signs
      if (isRevision) {
        updateData.quote_revision_count = newRevisionCount;
        updateData.bc_file_url = null;
        updateData.bc_submitted_at = null;
        updateData.bc_approved_at = null;
        updateData.bc_signed_by = null;
        updateData.bc_signature_date = null;
        updateData.bc_signature_url = null;
        updateData.signed_quote_url = null;
        updateData.quote_approved_at = null;
      }
      
      // Add quote PDF URL if generated
      if (quoteUrl) {
        updateData.quote_url = quoteUrl;
      }
      
      // Add BC/signed quote URLs if contract-covered
      if (isFullyContractCovered) {
        // Use BC file if available, otherwise use signed quote as the BC document
        const bcDocUrl = contractBcFileUrl || contractSignedQuoteUrl;
        
        if (bcDocUrl) {
          updateData.bc_file_url = bcDocUrl;
        }
        // If we have BOTH, store the signed quote separately as signature proof
        if (contractBcFileUrl && contractSignedQuoteUrl) {
          updateData.bc_signature_url = contractSignedQuoteUrl;
        }
        // Set BC approval fields
        if (bcDocUrl) {
          updateData.bc_signed_by = bcSignedBy;
          updateData.bc_approved_at = new Date().toISOString();
          updateData.bc_submitted_at = new Date().toISOString();
          updateData.bc_signature_date = new Date().toISOString().split('T')[0];
        }
      }

      const { error } = await supabase.from('service_requests').update(updateData).eq('id', request.id);

      if (error) throw error;

      // Update request_devices with contract info
      for (const d of devicePricing) {
        if (d.id && d.isContractCovered) {
          await supabase.from('request_devices').update({
            contract_device_id: d.contractDeviceId,
            contract_covered: true
          }).eq('id', d.id);
        }
      }

      if (isFullyContractCovered) {
        const bcDocUrl = contractBcFileUrl || contractSignedQuoteUrl;
        const bcCopied = bcDocUrl ? ` (${lang === 'en' ? 'Contract PO/Quote copied' : 'BC/Devis contrat copi√©'})` : ` (‚ö†Ô∏è ${lang === 'en' ? 'Contract PO not found' : 'BC contrat non trouv√©'})`;
        notify(lang === 'en' ? `‚úÖ Contract! RMA ${rmaNumber} created - Awaiting reception${bcCopied}` : `‚úÖ Contrat! RMA ${rmaNumber} cr√©√© - En attente de r√©ception${bcCopied}`);
      } else if (isRevision) {
        notify(lang === 'en' ? `‚úÖ Revised quote sent! ${quoteNumber} Rev-${newRevisionCount} ‚Üí ${request.companies?.name || 'Client'}` : `‚úÖ Devis r√©vis√© envoy√©! ${quoteNumber} Rev-${newRevisionCount} ‚Üí ${request.companies?.name || 'Client'}`);
      } else if (hasContractCoveredDevices) {
        notify(lang === 'en' ? `‚úÖ Quote sent! RMA: ${rmaNumber} (some devices under contract)` : `‚úÖ Devis envoy√©! RMA: ${rmaNumber} (certains appareils sous contrat)`);
      } else {
        notify(lang === 'en' ? '‚úÖ Quote sent! RMA: ' : '‚úÖ Devis envoy√©! RMA: ' + rmaNumber);
      }
      
      reload(); 
      onClose();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    
    setSaving(false);
  };

  // Decline revision request
  const declineRevision = async () => {
    if (!declineNotes.trim()) {
      notify(lang === 'en' ? 'Please indicate the rejection reason.' : 'Veuillez indiquer la raison du refus.', 'error');
      return;
    }
    setSaving(true);
    try {
      const { error } = await supabase.from('service_requests').update({
        status: 'quote_revision_declined',
        admin_decline_notes: declineNotes,
        quote_revision_declined_at: new Date().toISOString()
      }).eq('id', request.id);
      
      if (error) throw error;
      notify(lang === 'en' ? `‚ùå Modification declined - ${request.companies?.name || 'Client'} will be notified` : `‚ùå Modification refus√©e - ${request.companies?.name || 'Client'} sera notifi√©`);
      reload();
      onClose();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setSaving(false);
  };

  return (
    <div className="fixed inset-0 z-50 bg-black/80 flex" onClick={onClose}>
      <div className="bg-white w-full h-full md:w-[98%] md:h-[98%] md:m-auto md:rounded-xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
        
        {/* Header - Always use standard dark theme */}
        <div className="px-6 py-4 text-white flex justify-between items-center shrink-0 bg-[#1a1a2e]">
          <div className="flex items-center gap-6">
            <div>
              <h2 className="text-xl font-bold flex items-center gap-2">
                {step === 1 && (request.quote_rejection_notes ? (lang === 'en' ? '‚úèÔ∏è Correct Quote' : '‚úèÔ∏è Corriger le Devis') : isRevision ? (lang === 'en' ? 'üî¥ Revise Quote' : 'üî¥ R√©viser le Devis') : (lang === 'en' ? 'Create Quote' : 'Cr√©er le Devis'))}
                {step === 2 && (lang === 'en' ? 'Quote Preview' : 'Aper√ßu du Devis')}
                {step === 3 && (isFullyContractCovered ? (lang === 'en' ? 'Confirm Contract RMA' : 'Confirmer RMA Contrat') : (lang === 'en' ? "Confirm send" : "Confirmer l'envoi"))}
              </h2>
              <p className="text-gray-300">
                {request.companies?.name} ‚Ä¢ {devicePricing.length} appareil(s)
                {isRevision && request.quote_number && <span className="ml-2 text-red-300">‚Ä¢ {request.quote_number} ‚Üí Rev-{currentRevisionCount + 1}</span>}
              </p>
            </div>
            <div className="flex gap-1">
              {[1,2,3].map(s => (
                <div key={s} className={`w-8 h-2 rounded-full ${step >= s ? 'bg-[#00A651]' : 'bg-gray-600'}`} />
              ))}
            </div>
          </div>
          <div className="flex items-center gap-4">
            <div className="text-right">
              <p className="text-xs text-gray-300">{t('totalHT')}</p>
              <p className="text-2xl font-bold text-[#00A651]">{grandTotal.toFixed(2)} ‚Ç¨</p>
            </div>
            <button onClick={onClose} className="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto">
          
          {/* Modification requested banner */}
          {request.quote_rejection_notes && (
            <div className="mx-6 mt-4 p-4 bg-amber-50 border-2 border-amber-300 rounded-xl">
              <div className="flex items-center gap-3 mb-2">
                <span className="text-lg">‚úèÔ∏è</span>
                <span className="font-bold text-amber-800">{lang === 'en' ? 'Admin requested modification' : 'Modification demand√©e par l\'admin'}</span>
              </div>
              <div className="ml-9 bg-white rounded-lg p-3 border border-amber-200">
                <p className="text-amber-900">{request.quote_rejection_notes}</p>
              </div>
            </div>
          )}

          {/* Loading Contract & Parts Check */}
          {(loadingContract || loadingParts) && (
            <div className="flex items-center justify-center py-12">
              <div className="flex items-center gap-3">
                <div className="w-6 h-6 border-2 border-[#00A651] border-t-transparent rounded-full animate-spin"></div>
                <span className="text-gray-600">
                  {loadingParts ? (lang === 'en' ? 'Loading prices...' : 'Chargement tarifs...') : (lang === 'en' ? 'Checking contract...' : 'V√©rification contrat en cours...')}
                </span>
              </div>
            </div>
          )}
          
          {/* ==================== STEP 1: PRICING EDITOR ==================== */}
          {step === 1 && !loadingContract && !loadingParts && (
            <div className="flex h-full">
              {/* LEFT SIDE - Customer Info & Devices */}
              <div className="flex-1 p-6 overflow-y-auto">
                
                {/* REVISION BANNER - Client modification request */}
                {isRevision && (
                  <div className="mb-6">
                    <div className="p-4 rounded-xl border-2 border-red-300 bg-red-50">
                      <div className="flex items-start gap-3">
                        <span className="text-3xl">üî¥</span>
                        <div className="flex-1">
                          <p className="font-bold text-red-800 text-lg">{lang === 'en' ? 'Client modification request' : 'Demande de modification du client'}</p>
                          <p className="text-sm text-red-600 mt-1">
                            {request.companies?.name} {lang === 'en' ? 'requested modifications to quote' : 'a demand√© des modifications au devis'} {request.quote_number}
                            {currentRevisionCount > 0 && ` (actuellement Rev-${currentRevisionCount})`}
                          </p>
                          {clientRevisionNotes && (
                            <div className="mt-3 p-3 bg-white rounded-lg border border-red-200">
                              <p className="text-xs font-medium text-gray-500 mb-1">{lang === 'en' ? 'üí¨ Client message:' : 'üí¨ Message du client :'}</p>
                              <p className="text-gray-800 whitespace-pre-wrap">{clientRevisionNotes}</p>
                            </div>
                          )}
                          <div className="mt-3 flex gap-2">
                            <p className="text-xs text-red-500 italic flex-1">
                              {lang === 'en' ? 'Modify prices below then send the revised quote, or reject the modification.' : 'Modifiez les tarifs ci-dessous puis envoyez le devis r√©vis√©, ou refusez la modification.'}
                            </p>
                            {!declineMode ? (
                              <button onClick={() => setDeclineMode(true)} className="px-3 py-1 text-xs bg-white border border-red-300 text-red-600 rounded hover:bg-red-50 font-medium">
                                ‚ùå Refuser la modification
                              </button>
                            ) : (
                              <button onClick={() => setDeclineMode(false)} className="px-3 py-1 text-xs bg-white border border-gray-300 text-gray-600 rounded hover:bg-gray-50 font-medium">
                                ‚Üê Annuler le refus
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Decline mode */}
                    {declineMode && (
                      <div className="mt-3 p-4 rounded-xl border-2 border-orange-300 bg-orange-50">
                        <p className="font-bold text-orange-800 mb-2">{lang === 'en' ? '‚ùå Decline modification' : '‚ùå Refuser la modification'}</p>
                        <p className="text-sm text-orange-600 mb-3">
                          {lang === 'en' ? 'Client will be notified their request was rejected and will receive the reason below. The original quote remains in effect.' : 'Le client sera notifi√© que sa demande a √©t√© refus√©e et recevra le motif ci-dessous. Le devis original reste en vigueur.'}
                        </p>
                        <textarea
                          value={declineNotes}
                          onChange={e => setDeclineNotes(e.target.value)}
                          placeholder={lang === 'en' ? 'Explain to the client why the modification cannot be accepted...' : 'Expliquez au client pourquoi la modification ne peut pas √™tre accept√©e...'}
                          className="w-full p-3 border rounded-lg text-sm resize-none focus:ring-2 focus:ring-orange-300"
                          rows={3}
                        />
                        <div className="mt-3 flex gap-2 justify-end">
                          <button onClick={() => setDeclineMode(false)} className="px-4 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            Annuler
                          </button>
                          <button 
                            onClick={declineRevision} 
                            disabled={saving || !declineNotes.trim()}
                            className="px-4 py-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 font-medium"
                          >
                            {saving ? (lang === 'en' ? 'Sending...' : 'Envoi...') : (lang === 'en' ? '‚ùå Confirm rejection' : '‚ùå Confirmer le refus')}
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* CONTRACT CUSTOMER BANNER */}
                {hasContractCoveredDevices && (
                  <div className="mb-6 p-4 rounded-xl border-2 bg-emerald-50 border-emerald-300">
                    <div className="flex items-start gap-3">
                      <span className="text-3xl">üìã</span>
                      <div className="flex-1">
                        <p className="font-bold text-emerald-800">
                          Contrat d√©tect√©
                        </p>
                        <p className="text-emerald-700 text-sm mt-1">
                          {isFullyContractCovered 
                            ? (lang === 'en' ? 'Calibration(s) covered by contract. RMA will be created directly in "Awaiting Device" with the contract PO.' : '√âtalonnage(s) couvert(s) par contrat. Le RMA sera cr√©√© directement en "Attente Appareil" avec le BC du contrat.')
                            : `${devicePricing.filter(d => d.isContractCovered).length} appareil(s) couvert(s) par contrat. Les r√©parations ou appareils non couverts seront factur√©s normalement.`
                          }
                        </p>
                        {contractInfo?.primaryContract && (
                          <p className="text-xs text-emerald-600 mt-2">
                            Contrat: {contractInfo.primaryContract.contract_number} ‚Ä¢ 
                            Valide jusqu'au {new Date(contractInfo.primaryContract.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Non-Metro Warning */}
                {!isMetro && (
                  <div className="mb-6 p-4 bg-amber-50 border-2 border-amber-300 rounded-xl">
                    <p className="font-bold text-amber-800">{lang === 'en' ? '‚ö†Ô∏è Client outside mainland France' : '‚ö†Ô∏è Client hors France m√©tropolitaine'}</p>
                    <p className="text-amber-700 text-sm">{lang === 'en' ? 'Return fees default to 0‚Ç¨. Client manages their own shipping.' : 'Les frais de retour sont √† 0‚Ç¨ par d√©faut. Le client g√®re son propre transport.'}</p>
                  </div>
                )}

                {/* Customer Info Card */}
                <div className="bg-gray-50 rounded-xl p-4 mb-6">
                  <h3 className="font-bold text-gray-800 mb-3">{t('client')}</h3>
                  <p className="text-lg font-bold text-[#2D5A7B]">{request.companies?.name}</p>
                  {request.companies?.billing_address && (
                    <p className="text-sm text-gray-600">{request.companies?.billing_address}</p>
                  )}
                  <p className="text-sm text-gray-600">{request.companies?.billing_postal_code} {request.companies?.billing_city}</p>
                </div>

                {/* Detected Service Sections */}
                <div className="bg-blue-50 rounded-xl p-4 mb-6">
                  <h3 className="font-bold text-blue-800 mb-2">{lang === 'en' ? "Quote sections (auto-detected)" : "Sections du devis (auto-d√©tect√©es)"}</h3>
                  <div className="flex flex-wrap gap-2">
                    {requiredSections.calibrationTypes.map(type => (
                      <span key={type} className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
                        {CALIBRATION_TEMPLATES[type]?.icon} √âtal. {getDeviceTypeLabel(type)}
                      </span>
                    ))}
                    {requiredSections.hasRepair && (
                      <span className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">
                        üîß R√©paration
                      </span>
                    )}
                  </div>
                </div>

                {/* Device Pricing Cards */}
                <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'Pricing by Device' : 'Tarification par Appareil'}</h3>
                <div className="space-y-4">
                  {devicePricing.map((device, index) => {
                    const calTemplate = CALIBRATION_TEMPLATES[device.deviceType] || CALIBRATION_TEMPLATES.particle_counter;
                    // Get contract number for display
                    const contractNumber = device.isContractCovered && contractInfo?.primaryContract?.contract_number 
                      ? contractInfo.primaryContract.contract_number 
                      : null;
                    const isEditing = editingDeviceIndex === index;
                    return (
                      <div key={device.id} className="border-2 rounded-xl overflow-hidden bg-white border-gray-200">
                        {/* Device Header - Always standard dark */}
                        <div className="px-4 py-3 flex items-center justify-between bg-[#1a1a2e] text-white">
                          <div className="flex items-center gap-3">
                            <span className="bg-white/20 px-2 py-1 rounded text-sm font-bold">#{index + 1}</span>
                            <div>
                              <p className="font-bold">{device.model || (lang === 'en' ? 'Device' : 'Appareil')}</p>
                              <p className="text-sm text-gray-300">SN: {device.serial} ‚Ä¢ {getDeviceTypeLabel(device.deviceType)}</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <button 
                              onClick={() => setEditingDeviceIndex(isEditing ? null : index)}
                              className="bg-white/20 hover:bg-white/30 px-2 py-1 rounded text-xs"
                            >
                              ‚úèÔ∏è Modifier
                            </button>
                            {device.needsCalibration && <span className="bg-blue-500 px-2 py-1 rounded text-xs">üî¨ Cal</span>}
                            {device.needsRepair && <span className="bg-orange-500 px-2 py-1 rounded text-xs">{lang === 'en' ? 'üîß Rep' : 'üîß R√©p'}</span>}
                          </div>
                        </div>

                        {/* Device Edit Form */}
                        {isEditing && (
                          <div className="bg-blue-50 p-4 border-b border-blue-200">
                            <p className="text-sm font-bold text-blue-800 mb-3">{lang === 'en' ? "‚úèÔ∏è Edit device information" : "‚úèÔ∏è Modifier les informations de l'appareil"}</p>
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <label className="block text-xs font-medium text-gray-600 mb-1">{t('model')}</label>
                                <input
                                  type="text"
                                  value={device.model}
                                  onChange={e => updateDevice(device.id, 'model', e.target.value)}
                                  className="w-full px-3 py-2 border rounded-lg text-sm"
                                />
                              </div>
                              <div>
                                <label className="block text-xs font-medium text-gray-600 mb-1">{t('serialNumber')}</label>
                                <input
                                  type="text"
                                  value={device.serial}
                                  onChange={e => updateDevice(device.id, 'serial', e.target.value)}
                                  className="w-full px-3 py-2 border rounded-lg text-sm"
                                />
                              </div>
                              <div>
                                <label className="block text-xs font-medium text-gray-600 mb-1">{lang === 'en' ? "Device type" : "Type d'appareil"}</label>
                                <select
                                  value={device.deviceType}
                                  onChange={e => updateDevice(device.id, 'deviceType', e.target.value)}
                                  className="w-full px-3 py-2 border rounded-lg text-sm"
                                >
                                  <option value="particle_counter">{lang === 'en' ? 'Particle Counter (Air)' : 'Compteur Particules (Air)'}</option>
                                  <option value="liquid_counter">{lang === 'en' ? 'Particle Counter (Liquid)' : 'Compteur Particules (Liquide)'}</option>
                                  <option value="bio_collector">{lang === 'en' ? 'Bio Collector' : 'Bio Collecteur'}</option>
                                  <option value="temp_humidity">{lang === 'en' ? "Temp/Humidity Sensor" : "Capteur Temp/Humidit√©"}</option>
                                  <option value="other">{lang === 'en' ? 'Other' : 'Autre'}</option>
                                </select>
                              </div>
                              <div>
                                <label className="block text-xs font-medium text-gray-600 mb-1">{lang === 'en' ? 'Service type' : 'Type de service'}</label>
                                <select
                                  value={device.serviceType}
                                  onChange={e => {
                                    const newType = e.target.value;
                                    updateDevice(device.id, 'serviceType', newType);
                                    updateDevice(device.id, 'needsCalibration', newType.includes('calibration') || newType === 'cal_repair');
                                    updateDevice(device.id, 'needsRepair', newType.includes('repair') || newType === 'cal_repair');
                                  }}
                                  className="w-full px-3 py-2 border rounded-lg text-sm"
                                >
                                  <option value="calibration">{lang === 'en' ? 'Calibration only' : '√âtalonnage uniquement'}</option>
                                  <option value="repair">{lang === 'en' ? 'Repair only' : 'R√©paration uniquement'}</option>
                                  <option value="calibration_repair">{lang === 'en' ? 'Calibration + Repair' : '√âtalonnage + R√©paration'}</option>
                                </select>
                              </div>
                            </div>
                            <button 
                              onClick={() => setEditingDeviceIndex(null)}
                              className="mt-3 px-4 py-1 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700"
                            >
                              ‚úì Termin√©
                            </button>
                          </div>
                        )}

                        {/* Customer Notes (Internal) */}
                        {device.customerNotes && (
                          <div className="bg-yellow-50 px-4 py-2 border-b border-yellow-200">
                            <p className="text-xs text-yellow-700 font-medium">{lang === 'en' ? 'üí¨ Client note (internal):' : 'üí¨ Note client (interne) :'}</p>
                            <p className="text-sm text-yellow-800">{device.customerNotes}</p>
                          </div>
                        )}
                        
                        {/* Tokens Exhausted Warning */}
                        {device.tokensExhausted && (
                          <div className="bg-amber-100 px-4 py-2 border-b border-amber-200">
                            <p className="text-sm text-amber-800">
                              <span className="font-bold">{lang === 'en' ? '‚ö†Ô∏è Client under contract - 0 tokens remaining for this device' : '‚ö†Ô∏è Client sous contrat - 0 jetons restants pour cet appareil'}</span> - Facturation au tarif normal
                            </p>
                          </div>
                        )}
                        
                        {/* Manual Entry Warning - Device not detected in system */}
                        {device.needsCalibration && !device.calPartNumber && !device.isContractCovered && (
                          <div className="bg-orange-100 px-4 py-2 border-b border-orange-300">
                            <p className="text-sm text-orange-800">
                              <span className="font-bold">{lang === 'en' ? '‚ö†Ô∏è Device not recognized in system' : '‚ö†Ô∏è Appareil non reconnu dans le syst√®me'}</span> - Veuillez v√©rifier et saisir manuellement le tarif d'√©talonnage
                            </p>
                          </div>
                        )}

                        {/* Pricing Inputs */}
                        <div className="p-4 space-y-2">
                          {/* Column Headers */}
                          <div className="flex items-center gap-2 text-xs text-gray-500 font-medium px-1 pb-1 border-b">
                            <div className="w-14 text-center">{lang === 'en' ? 'Qty' : 'Qt√©'}</div>
                            <div className="w-28">{lang === 'en' ? 'Part #' : 'N¬∞ Pi√®ce'}</div>
                            <div className="flex-1">{lang === 'en' ? 'Description' : 'D√©signation'}</div>
                            <div className="w-24 text-right">{lang === 'en' ? 'Unit Price' : 'Prix Unit.'}</div>
                            <div className="w-24 text-right">{t('total')}</div>
                            <div className="w-8"></div>
                          </div>
                          
                          {device.needsCalibration && (
                            <div className={`p-2 rounded-lg ${
                              device.calPartNumber && partsCache[device.calPartNumber] 
                                ? 'bg-blue-50' 
                                : 'bg-orange-50 border-2 border-orange-300'
                            }`}>
                              <div className="flex items-center gap-2">
                                {/* Quantity - editable */}
                                <div className="w-14">
                                  <input
                                    type="number"
                                    min="1"
                                    value={device.calibrationQty || 1}
                                    onChange={e => updateDevice(device.id, 'calibrationQty', Math.max(1, parseInt(e.target.value) || 1))}
                                    className="w-full px-2 py-1.5 border rounded text-sm text-center"
                                    disabled={device.isContractCovered}
                                  />
                                </div>
                                {/* Part Number */}
                                <div className="w-28">
                                  <input
                                    type="text"
                                    value={device.calPartNumber || ''}
                                    onChange={e => {
                                      const pn = e.target.value;
                                      updateDevice(device.id, 'calPartNumber', pn);
                                      if (partsCache[pn]) {
                                        updateDevice(device.id, 'calibrationPrice', partsCache[pn]);
                                      }
                                    }}
                                    placeholder="Cal-XXXX"
                                    className={`w-full px-2 py-1.5 border rounded text-xs font-mono ${
                                      device.calPartNumber && partsCache[device.calPartNumber] 
                                        ? 'border-green-400 bg-green-50' 
                                        : 'border-orange-300'
                                    }`}
                                    disabled={device.isContractCovered}
                                  />
                                </div>
                                {/* Description */}
                                <div className="flex-1">
                                  <span className={`text-sm ${
                                    device.calPartNumber && partsCache[device.calPartNumber] 
                                      ? 'text-blue-800' 
                                      : 'text-orange-800'
                                  }`}>
                                    {lang === 'en' ? 'Calibration' : '√âtalonnage'} {device.model}
                                    {device.calPartNumber && partsCache[device.calPartNumber] && (
                                      <span className="ml-1 text-green-600">‚úì</span>
                                    )}
                                  </span>
                                </div>
                                {/* Unit Price */}
                                {device.isContractCovered ? (
                                  <div className="w-24 text-right">
                                    <span className="px-2 py-1 bg-emerald-600 text-white text-xs rounded">{lang === 'en' ? 'Contract' : 'Contrat'}</span>
                                  </div>
                                ) : (
                                  <div className="w-24">
                                    <input
                                      type="number"
                                      value={device.calibrationPrice}
                                      onChange={e => updateDevice(device.id, 'calibrationPrice', parseFloat(e.target.value) || 0)}
                                      className="w-full px-2 py-1.5 border rounded text-sm text-right"
                                    />
                                  </div>
                                )}
                                {/* Total */}
                                <div className="w-24 text-right font-medium text-sm">
                                  {device.isContractCovered ? '' : `${((device.calibrationQty || 1) * (device.calibrationPrice || 0)).toFixed(2)} ‚Ç¨`}
                                </div>
                                <div className="w-8"></div>
                              </div>
                            </div>
                          )}
                          
                          {/* Nettoyage Cellule - normal editable row */}
                          {device.needsNettoyage && (
                            <div className="bg-gray-50 p-2 rounded-lg">
                              <div className="flex items-center gap-2">
                                {/* Quantity - editable */}
                                <div className="w-14">
                                  <input
                                    type="number"
                                    min="1"
                                    value={device.nettoyageQty || 1}
                                    onChange={e => updateDevice(device.id, 'nettoyageQty', Math.max(1, parseInt(e.target.value) || 1))}
                                    className="w-full px-2 py-1.5 border rounded text-sm text-center"
                                    disabled={device.isContractCovered}
                                  />
                                </div>
                                {/* Part Number */}
                                <div className="w-28">
                                  <input
                                    type="text"
                                    value={device.nettoyagePartNumber || ''}
                                    onChange={e => {
                                      const pn = e.target.value;
                                      updateDevice(device.id, 'nettoyagePartNumber', pn);
                                      if (partsCache[pn]) {
                                        updateDevice(device.id, 'nettoyagePrice', partsCache[pn]);
                                      }
                                    }}
                                    placeholder="cell1/cell2"
                                    className={`w-full px-2 py-1.5 border rounded text-xs font-mono ${
                                      device.nettoyagePartNumber && partsCache[device.nettoyagePartNumber]
                                        ? 'border-green-400 bg-green-50'
                                        : 'border-gray-300'
                                    }`}
                                    disabled={device.isContractCovered}
                                  />
                                </div>
                                {/* Description */}
                                <div className="flex-1">
                                  <span className="text-sm">
                                    Nettoyage cellule - si requis
                                    {device.nettoyagePartNumber && partsCache[device.nettoyagePartNumber] && (
                                      <span className="ml-1 text-green-600">‚úì</span>
                                    )}
                                  </span>
                                </div>
                                {/* Unit Price */}
                                {device.isContractCovered ? (
                                  <div className="w-24 text-right">
                                    <span className="px-2 py-1 bg-emerald-600 text-white text-xs rounded">{lang === 'en' ? 'Contract' : 'Contrat'}</span>
                                  </div>
                                ) : (
                                  <div className="w-24">
                                    <input
                                      type="number"
                                      value={device.nettoyagePrice}
                                      onChange={e => updateDevice(device.id, 'nettoyagePrice', parseFloat(e.target.value) || 0)}
                                      className="w-full px-2 py-1.5 border rounded text-sm text-right"
                                    />
                                  </div>
                                )}
                                {/* Total */}
                                <div className="w-24 text-right font-medium text-sm">
                                  {device.isContractCovered ? '' : `${((device.nettoyageQty || 1) * (device.nettoyagePrice || 0)).toFixed(2)} ‚Ç¨`}
                                </div>
                                <div className="w-8"></div>
                              </div>
                            </div>
                          )}
                          
                          {device.needsRepair && (
                            <div className="bg-orange-50 p-2 rounded-lg">
                              <div className="flex items-center gap-2">
                                {/* Quantity - editable */}
                                <div className="w-14">
                                  <input
                                    type="number"
                                    min="1"
                                    value={device.repairQty || 1}
                                    onChange={e => updateDevice(device.id, 'repairQty', Math.max(1, parseInt(e.target.value) || 1))}
                                    className="w-full px-2 py-1.5 border rounded text-sm text-center"
                                  />
                                </div>
                                {/* Part Number */}
                                <div className="w-28">
                                  <input
                                    type="text"
                                    value={device.repairPartNumber || ''}
                                    onChange={e => {
                                      const pn = e.target.value;
                                      updateDevice(device.id, 'repairPartNumber', pn);
                                      if (partsCache[pn]) {
                                        updateDevice(device.id, 'repairPrice', partsCache[pn]);
                                      }
                                    }}
                                    placeholder="PN"
                                    className="w-full px-2 py-1.5 border rounded text-xs font-mono border-orange-300"
                                  />
                                </div>
                                {/* Description */}
                                <div className="flex-1">
                                  <span className="text-sm text-orange-800">
                                    {lang === 'en' ? 'Repair' : 'R√©paration'} {device.model}
                                    {device.repairPartNumber && partsCache[device.repairPartNumber] && (
                                      <span className="ml-1 text-green-600">‚úì</span>
                                    )}
                                  </span>
                                </div>
                                {/* Unit Price */}
                                <div className="w-24">
                                  <input
                                    type="number"
                                    value={device.repairPrice}
                                    onChange={e => updateDevice(device.id, 'repairPrice', parseFloat(e.target.value) || 0)}
                                    className="w-full px-2 py-1.5 border rounded text-sm text-right"
                                  />
                                </div>
                                {/* Total */}
                                <div className="w-24 text-right font-medium text-sm">
                                  {((device.repairQty || 1) * (device.repairPrice || 0)).toFixed(2)} ‚Ç¨
                                </div>
                                <div className="w-8"></div>
                              </div>
                            </div>
                          )}

                          {/* Additional Parts */}
                          {device.additionalParts.map(part => (
                            <div key={part.id} className="bg-gray-50 p-2 rounded-lg">
                              <div className="flex items-center gap-2">
                                {/* Quantity */}
                                <div className="w-14">
                                  <input
                                    type="number"
                                    min="1"
                                    value={part.quantity || 1}
                                    onChange={e => updatePart(device.id, part.id, 'quantity', Math.max(1, parseInt(e.target.value) || 1))}
                                    className="w-full px-2 py-1.5 border rounded text-sm text-center"
                                  />
                                </div>
                                {/* Part Number */}
                                <div className="w-28">
                                  <input
                                    type="text"
                                    value={part.partNumber || ''}
                                    onChange={e => {
                                      const pn = e.target.value;
                                      updatePart(device.id, part.id, 'partNumber', pn);
                                      if (partsCache[pn]) {
                                        updatePart(device.id, part.id, 'price', partsCache[pn]);
                                      }
                                      if (partsDescriptionCache[pn]) {
                                        updatePart(device.id, part.id, 'description', partsDescriptionCache[pn]);
                                      }
                                    }}
                                    placeholder={lang === 'en' ? 'Part #' : 'N¬∞ pi√®ce'}
                                    className={`w-full px-2 py-1.5 border rounded text-xs font-mono ${
                                      part.partNumber && partsCache[part.partNumber]
                                        ? 'border-green-400 bg-green-50'
                                        : 'border-gray-300'
                                    }`}
                                  />
                                </div>
                                {/* Description */}
                                <div className="flex-1">
                                  <input
                                    type="text"
                                    value={part.description}
                                    onChange={e => updatePart(device.id, part.id, 'description', e.target.value)}
                                    placeholder="Description..."
                                    className="w-full px-2 py-1.5 border rounded text-sm"
                                  />
                                </div>
                                {/* Unit Price */}
                                <div className="w-24">
                                  <input
                                    type="number"
                                    value={part.price}
                                    onChange={e => updatePart(device.id, part.id, 'price', e.target.value)}
                                    className="w-full px-2 py-1.5 border rounded text-sm text-right"
                                    placeholder="0"
                                  />
                                </div>
                                {/* Line Total */}
                                <div className="w-24 text-right font-medium text-sm">
                                  {((parseInt(part.quantity) || 1) * (parseFloat(part.price) || 0)).toFixed(2)} ‚Ç¨
                                </div>
                                <button onClick={() => removePart(device.id, part.id)} className="w-8 text-red-500 hover:text-red-700 text-lg">√ó</button>
                              </div>
                            </div>
                          ))}
                          
                          <button onClick={() => addPart(device.id)} className="text-sm text-[#00A651] font-medium hover:underline ml-16">
                            {lang === 'en' ? '+ Add part/service' : '+ Ajouter pi√®ce/service'}
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
                
                {/* GLOBAL SHIPPING SECTION */}
                <div className="mt-6 p-4 bg-gray-100 rounded-lg border-2 border-gray-300">
                  <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    {lang === 'en' ? 'üì¶ Shipping fees' : 'üì¶ Frais de port'}
                    <span className="text-sm font-normal text-gray-500">
                      ({shippingData.parcels} colis √ó {shippingData.unitPrice.toFixed(2)}‚Ç¨)
                    </span>
                  </h4>
                  <div className="flex items-center gap-3">
                    {/* Part Number */}
                    <div className="w-32">
                      <label className="block text-xs text-gray-500 mb-1">{lang === 'en' ? 'Part #' : 'N¬∞ Pi√®ce'}</label>
                      <input
                        type="text"
                        value={shippingData.partNumber}
                        onChange={e => {
                          const pn = e.target.value;
                          const unitPrice = partsCache[pn] || shippingData.unitPrice;
                          setShippingData(prev => ({
                            ...prev,
                            partNumber: pn,
                            unitPrice: unitPrice,
                            total: unitPrice * prev.parcels
                          }));
                        }}
                        className={`w-full px-2 py-2 border rounded-lg text-sm font-mono ${
                          partsCache[shippingData.partNumber]
                            ? 'border-green-400 bg-green-50'
                            : 'border-gray-300'
                        }`}
                      />
                    </div>
                    {/* Parcels */}
                    <div className="w-24">
                      <label className="block text-xs text-gray-500 mb-1">{lang === 'en' ? 'Nb Parcels' : 'Nb Colis'}</label>
                      <input
                        type="number"
                        min="1"
                        value={shippingData.parcels}
                        onChange={e => {
                          const parcels = Math.max(1, parseInt(e.target.value) || 1);
                          setShippingData(prev => ({
                            ...prev,
                            parcels: parcels,
                            total: prev.unitPrice * parcels
                          }));
                        }}
                        className="w-full px-2 py-2 border rounded-lg text-sm text-center"
                      />
                    </div>
                    {/* Unit Price */}
                    <div className="w-24">
                      <label className="block text-xs text-gray-500 mb-1">{lang === 'en' ? 'Price/parcel' : 'Prix/colis'}</label>
                      <div className="flex items-center gap-1">
                        <input
                          type="number"
                          value={shippingData.unitPrice}
                          onChange={e => {
                            const unitPrice = parseFloat(e.target.value) || 0;
                            setShippingData(prev => ({
                              ...prev,
                              unitPrice: unitPrice,
                              total: unitPrice * prev.parcels
                            }));
                          }}
                          className="w-full px-2 py-2 border rounded-lg text-sm text-right"
                        />
                        <span className="text-gray-500">‚Ç¨</span>
                      </div>
                    </div>
                    {/* Total */}
                    <div className="flex-1 text-right">
                      <label className="block text-xs text-gray-500 mb-1">{lang === 'en' ? 'Total shipping' : 'Total port'}</label>
                      <p className="text-lg font-bold text-[#00A651]">{shippingData.total.toFixed(2)} ‚Ç¨</p>
                    </div>
                  </div>
                  {partsCache[shippingData.partNumber] && (
                    <p className="text-xs text-green-600 mt-2">{lang === 'en' ? '‚úì Price loaded from database' : '‚úì Prix charg√© depuis la base de donn√©es'}</p>
                  )}
                </div>
                
                {/* DISCOUNT SECTION */}
                <div className="mt-4">
                  {!discountData.enabled ? (
                    <button 
                      onClick={() => setDiscountData(prev => ({ ...prev, enabled: true }))}
                      className="flex items-center gap-2 text-sm text-[#2D5A7B] font-medium hover:underline"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>
                      {lang === 'en' ? '+ Add discount' : '+ Ajouter une remise'}
                    </button>
                  ) : (
                    <div className="p-4 bg-amber-50 rounded-lg border-2 border-amber-300">
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="font-bold text-amber-800 flex items-center gap-2">
                          üè∑Ô∏è {lang === 'en' ? 'Discount' : 'Remise'}
                        </h4>
                        <button 
                          onClick={() => setDiscountData({ enabled: false, type: 'fixed', value: 0, note: '' })}
                          className="text-amber-400 hover:text-red-500 text-lg"
                        >√ó</button>
                      </div>
                      <div className="flex items-center gap-3">
                        {/* Type toggle */}
                        <div className="flex border border-amber-300 rounded-lg overflow-hidden shrink-0">
                          <button 
                            onClick={() => setDiscountData(prev => ({ ...prev, type: 'fixed', value: prev.type === 'percentage' ? 0 : prev.value }))}
                            className={`px-3 py-2 text-sm font-medium transition-colors ${discountData.type === 'fixed' ? 'bg-amber-600 text-white' : 'bg-white text-amber-700 hover:bg-amber-100'}`}
                          >‚Ç¨</button>
                          <button 
                            onClick={() => setDiscountData(prev => ({ ...prev, type: 'percentage', value: prev.type === 'fixed' ? 0 : prev.value }))}
                            className={`px-3 py-2 text-sm font-medium transition-colors ${discountData.type === 'percentage' ? 'bg-amber-600 text-white' : 'bg-white text-amber-700 hover:bg-amber-100'}`}
                          >%</button>
                        </div>
                        {/* Value */}
                        <div className="w-28">
                          <div className="flex items-center gap-1">
                            <input
                              type="number"
                              min="0"
                              step={discountData.type === 'percentage' ? '1' : '0.01'}
                              max={discountData.type === 'percentage' ? '100' : undefined}
                              value={discountData.value || ''}
                              onChange={e => setDiscountData(prev => ({ ...prev, value: e.target.value }))}
                              placeholder="0"
                              className="w-full px-2 py-2 border border-amber-300 rounded-lg text-sm text-right bg-white"
                            />
                            <span className="text-amber-700 font-medium">{discountData.type === 'percentage' ? '%' : '‚Ç¨'}</span>
                          </div>
                        </div>
                        {/* Computed amount */}
                        <div className="flex-1 text-right">
                          <p className="text-xs text-amber-600 mb-0.5">{lang === 'en' ? 'Discount' : 'Remise'}</p>
                          <p className="text-lg font-bold text-red-600">-{discountAmount.toFixed(2)} ‚Ç¨</p>
                        </div>
                      </div>
                      {/* Note */}
                      <div className="mt-3">
                        <input
                          type="text"
                          value={discountData.note}
                          onChange={e => setDiscountData(prev => ({ ...prev, note: e.target.value }))}
                          placeholder={lang === 'en' ? 'Discount reason (shown on quote)...' : 'Motif de la remise (affich√© sur le devis)...'}
                          className="w-full px-3 py-2 border border-amber-200 rounded-lg text-sm bg-white placeholder:text-amber-300"
                        />
                      </div>
                      {discountData.type === 'percentage' && discountData.value > 0 && (
                        <p className="text-xs text-amber-600 mt-2">
                          {discountData.value}% {lang === 'en' ? 'of' : 'de'} {subtotalBeforeDiscount.toFixed(2)}‚Ç¨ = -{discountAmount.toFixed(2)}‚Ç¨
                        </p>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* RIGHT SIDE - Pricing Summary */}
              <div className="w-80 bg-gray-50 border-l p-6 overflow-y-auto shrink-0">
                <h3 className="font-bold text-gray-800 mb-4 text-lg">{lang === 'en' ? 'üí∞ Summary' : 'üí∞ R√©capitulatif'}</h3>
                
                {/* Per-device totals */}
                <div className="space-y-3 mb-6">
                  {devicePricing.map((device, i) => {
                    const deviceContractNumber = device.isContractCovered && contractInfo?.primaryContract?.contract_number 
                      ? contractInfo.primaryContract.contract_number 
                      : null;
                    return (
                    <div key={device.id} className="rounded-lg p-3 border bg-white">
                      <div className="flex justify-between items-start">
                        <div>
                          <p className="font-medium text-sm">{device.model}</p>
                          <p className="text-xs text-gray-500">SN: {device.serial}</p>
                        </div>
                        <div className="text-right">
                          {device.isContractCovered && !device.needsRepair ? (
                            <>
                              <p className="font-bold text-emerald-600 text-sm">Contrat N¬∞ {deviceContractNumber}</p>
                              <p className="text-xs text-gray-400">({device.tokensRemaining} jetons restants)</p>
                            </>
                          ) : device.isContractCovered && device.needsRepair ? (
                            <>
                              <p className="font-bold text-[#00A651]">{getDeviceServiceTotal(device).toFixed(2)} ‚Ç¨</p>
                              <p className="text-xs text-emerald-600">{lang === 'en' ? 'Cal: Contract' : 'Cal: Contrat'}</p>
                              <p className="text-xs text-gray-400">{lang === 'en' ? 'Rep' : 'R√©p'}: {device.repairPrice}‚Ç¨</p>
                            </>
                          ) : (
                            <>
                              <p className="font-bold text-[#00A651]">{getDeviceServiceTotal(device).toFixed(2)} ‚Ç¨</p>
                            </>
                          )}
                        </div>
                      </div>
                    </div>
                  )})}
                </div>

                {/* Totals */}
                <div className="border-t pt-4 space-y-2">
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">{lang === 'en' ? 'Services subtotal' : 'Sous-total services'}</span>
                    <span className="font-medium">{servicesSubtotal.toFixed(2)} ‚Ç¨</span>
                  </div>
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">{lang === 'en' ? 'Total shipping fees' : 'Frais de port total'}</span>
                    <span className="font-medium">{shippingTotal.toFixed(2)} ‚Ç¨</span>
                  </div>
                  {discountAmount > 0 && (
                    <div className="flex justify-between text-sm mt-1">
                      <span className="text-red-600">
                        üè∑Ô∏è {lang === 'en' ? 'Discount' : 'Remise'}
                        {discountData.type === 'percentage' ? ` (${discountData.value}%)` : ''}
                      </span>
                      <span className="font-medium text-red-600">-{discountAmount.toFixed(2)} ‚Ç¨</span>
                    </div>
                  )}
                  <div className="flex justify-between items-center bg-[#00A651] text-white px-4 py-3 rounded-lg mt-4">
                    <span className="font-bold">{lang === 'en' ? 'TOTAL excl. VAT' : 'TOTAL HT'}</span>
                    <span className="font-bold text-xl">{grandTotal.toFixed(2)} ‚Ç¨</span>
                  </div>
                </div>

                {/* Signatory */}
                <div className="mt-6 pt-4 border-t">
                  <p className="text-xs text-gray-500 uppercase mb-1">{lang === 'en' ? 'Prepared by' : '√âtabli par'}</p>
                  <p className="font-medium">{signatory}</p>
                </div>
              </div>
            </div>
          )}

          {/* ==================== STEP 2: QUOTE PREVIEW ==================== */}
          {step === 2 && (
            <div className="p-6 bg-gray-200 min-h-full">
              <div className="max-w-4xl mx-auto bg-white shadow-xl" style={{ fontFamily: 'Arial, sans-serif' }}>
                
                {/* Quote Header */}
                <div className="px-8 pt-8 pb-4 border-b-4 border-[#2D5A7B]">
                  <div className="flex justify-between items-start">
                    <div>
                      <img 
                        src="/images/logos/Lighthouse-color-logo.jpg" 
                        alt="Lighthouse France" 
                        className="h-24 w-auto mb-1"
                        onError={(e) => {
                          e.target.style.display = 'none';
                          e.target.nextSibling.style.display = 'block';
                        }}
                      />
                      <div className="hidden">
                        <h1 className="text-3xl font-bold tracking-tight text-[#1a1a2e]">LIGHTHOUSE</h1>
                        <p className="text-gray-500">Worldwide Solutions</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="text-2xl font-bold text-[#2D5A7B]">{lang === 'en' ? 'PRICE QUOTE' : 'OFFRE DE PRIX'}</p>
                      <p className="text-sm font-bold text-[#2D5A7B]">N¬∞ {request.quote_number || (lang === 'en' ? '(Generated on send)' : "(G√©n√©r√© √† l'envoi)")}</p>
                      <p className="text-xs text-gray-500">RMA: {request.request_number}</p>
                    </div>
                  </div>
                </div>

                {/* Info Bar */}
                <div className="bg-gray-100 px-8 py-3 flex justify-between text-sm border-b">
                  <div>
                    <p className="text-xs text-gray-500 uppercase">{t('date')}</p>
                    <p className="font-medium">{today.toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Validity' : 'Validit√©'}</p>
                    <p className="font-medium">{lang === 'en' ? '30 days' : '30 jours'}</p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-500 uppercase">{lang === 'en' ? 'Terms' : 'Conditions'}</p>
                    <p className="font-medium">{lang === 'en' ? 'Upon receipt of invoice' : '√Ä r√©ception de facture'}</p>
                  </div>
                </div>

                {/* Client Info */}
                <div className="px-8 py-4 border-b">
                  <p className="text-xs text-gray-500 uppercase">{t('client')}</p>
                  <p className="font-bold text-xl text-[#1a1a2e]">{request.companies?.name}</p>
                  {request.companies?.billing_address && <p className="text-gray-600">{request.companies?.billing_address}</p>}
                  <p className="text-gray-600">{request.companies?.billing_postal_code} {request.companies?.billing_city}</p>
                </div>

                {/* ===== SERVICE DESCRIPTION SECTIONS ===== */}
                <div className="px-8 py-6 space-y-6">
                  
                  {/* Calibration Sections - One per device type */}
                  {requiredSections.calibrationTypes.map(type => {
                    const template = CALIBRATION_TEMPLATES[type] || CALIBRATION_TEMPLATES.other;
                    return (
                      <div key={type} className="border-l-4 border-blue-500 pl-4">
                        <h3 className="font-bold text-lg text-[#1a1a2e] mb-3 flex items-center gap-2">
                          <span>{template.icon}</span> {template.title}
                        </h3>
                        <ul className="space-y-1">
                          {template.prestations.map((p, i) => (
                            <li key={i} className="text-gray-700 flex items-start gap-2">
                              <span className="text-[#00A651] mt-1">‚ñ∏</span>
                              <span>{p}</span>
                            </li>
                          ))}
                        </ul>
                      </div>
                    );
                  })}

                  {/* Repair Section */}
                  {requiredSections.hasRepair && (
                    <div className="border-l-4 border-orange-500 pl-4">
                      <h3 className="font-bold text-lg text-[#1a1a2e] mb-3 flex items-center gap-2">
                        <span>{REPAIR_TEMPLATE.icon}</span> {REPAIR_TEMPLATE.title}
                      </h3>
                      <ul className="space-y-1">
                        {REPAIR_TEMPLATE.prestations.map((p, i) => (
                          <li key={i} className="text-gray-700 flex items-start gap-2">
                            <span className="text-orange-500 mt-1">‚ñ∏</span>
                            <span>{p}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>

                {/* ===== PRICING BREAKDOWN TABLE ===== */}
                <div className="px-8 py-6 bg-gray-50">
                  <h3 className="font-bold text-lg text-[#1a1a2e] mb-4">{lang === 'en' ? 'Price Summary' : 'R√©capitulatif des Prix'}</h3>
                  
                  <table className="w-full text-sm border-collapse">
                    <thead>
                      <tr className="bg-[#1a1a2e] text-white">
                        <th className="px-4 py-3 text-center w-16">{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
                        <th className="px-4 py-3 text-left">{lang === 'en' ? 'Description' : 'D√©signation'}</th>
                        <th className="px-4 py-3 text-right w-28">{lang === 'en' ? 'Unit Price' : 'Prix Unit.'}</th>
                        <th className="px-4 py-3 text-right w-28">{t('totalHT')}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {devicePricing.map((device, i) => {
                        const rows = [];
                        
                        // Calibration row
                        if (device.needsCalibration) {
                          const qty = device.calibrationQty || 1;
                          const unitPrice = parseFloat(device.calibrationPrice) || 0;
                          const lineTotal = qty * unitPrice;
                          rows.push(
                            <tr key={`${device.id}-cal`} className="border-b">
                              <td className="px-4 py-3 text-center">{qty}</td>
                              <td className="px-4 py-3">
                                {lang === 'en' ? 'Calibration' : '√âtalonnage'} {device.model} (SN: {device.serial})
                                {device.isContractCovered && <span className="ml-2 px-2 py-0.5 bg-emerald-500 text-white text-xs rounded">{lang === 'en' ? 'CONTRACT' : 'CONTRAT'}</span>}
                              </td>
                              <td className="px-4 py-3 text-right whitespace-nowrap">
                                {device.isContractCovered ? <span className="text-emerald-600">{lang === 'en' ? 'Contract' : 'Contrat'}</span> : `${unitPrice.toFixed(2)} ‚Ç¨`}
                              </td>
                              <td className="px-4 py-3 text-right font-medium whitespace-nowrap">
                                {device.isContractCovered ? <span className="text-emerald-600">{lang === 'en' ? 'Contract' : 'Contrat'}</span> : `${lineTotal.toFixed(2)} ‚Ç¨`}
                              </td>
                            </tr>
                          );
                        }
                        
                        // Nettoyage row - normal row like any other part
                        if (device.needsNettoyage && !device.isContractCovered) {
                          const qty = device.nettoyageQty || 1;
                          const unitPrice = parseFloat(device.nettoyagePrice) || 0;
                          const lineTotal = qty * unitPrice;
                          rows.push(
                            <tr key={`${device.id}-nettoyage`} className="border-b">
                              <td className="px-4 py-3 text-center">{qty}</td>
                              <td className="px-4 py-3">{lang === 'en' ? "Cell cleaning - if required based on sensor condition" : "Nettoyage cellule - si requis selon l'√©tat du capteur"}</td>
                              <td className="px-4 py-3 text-right whitespace-nowrap">{unitPrice.toFixed(2)} ‚Ç¨</td>
                              <td className="px-4 py-3 text-right font-medium whitespace-nowrap">{lineTotal.toFixed(2)} ‚Ç¨</td>
                            </tr>
                          );
                        }
                        
                        // Repair row
                        if (device.needsRepair) {
                          const qty = device.repairQty || 1;
                          const unitPrice = parseFloat(device.repairPrice) || 0;
                          const lineTotal = qty * unitPrice;
                          rows.push(
                            <tr key={`${device.id}-repair`} className="border-b">
                              <td className="px-4 py-3 text-center">{qty}</td>
                              <td className="px-4 py-3">{lang === 'en' ? 'Repair' : 'R√©paration'} {device.model} (SN: {device.serial})</td>
                              <td className="px-4 py-3 text-right whitespace-nowrap">{unitPrice.toFixed(2)} ‚Ç¨</td>
                              <td className="px-4 py-3 text-right font-medium whitespace-nowrap">{lineTotal.toFixed(2)} ‚Ç¨</td>
                            </tr>
                          );
                        }
                        
                        // Additional parts
                        device.additionalParts.forEach(part => {
                          const qty = parseInt(part.quantity) || 1;
                          const unitPrice = parseFloat(part.price) || 0;
                          const lineTotal = qty * unitPrice;
                          rows.push(
                            <tr key={`${device.id}-part-${part.id}`} className="border-b">
                              <td className="px-4 py-3 text-center">{qty}</td>
                              <td className="px-4 py-3">
                                {part.partNumber && <span className="text-gray-500 mr-1">[{part.partNumber}]</span>}
                                {part.description || (lang === 'en' ? 'Part/Service' : 'Pi√®ce/Service')}
                              </td>
                              <td className="px-4 py-3 text-right whitespace-nowrap">{unitPrice.toFixed(2)} ‚Ç¨</td>
                              <td className="px-4 py-3 text-right font-medium whitespace-nowrap">{lineTotal.toFixed(2)} ‚Ç¨</td>
                            </tr>
                          );
                        });
                        
                        return rows;
                      })}
                      
                      {/* Shipping row */}
                      <tr className={isFullyContractCovered ? "border-b bg-emerald-50" : "border-b bg-gray-50"}>
                        <td className="px-4 py-3 text-center">{shippingData.parcels}</td>
                        <td className="px-4 py-3">Frais de port ({shippingData.parcels} colis)</td>
                        <td className="px-4 py-3 text-right whitespace-nowrap">
                          {isFullyContractCovered ? <span className="text-emerald-600">{lang === 'en' ? 'Contract' : 'Contrat'}</span> : `${shippingData.unitPrice.toFixed(2)} ‚Ç¨`}
                        </td>
                        <td className="px-4 py-3 text-right font-medium whitespace-nowrap">
                          {isFullyContractCovered ? <span className="text-emerald-600">{lang === 'en' ? 'Contract' : 'Contrat'}</span> : `${shippingTotal.toFixed(2)} ‚Ç¨`}
                        </td>
                      </tr>
                      {/* Discount row */}
                      {discountAmount > 0 && (
                        <tr className="border-b bg-amber-50">
                          <td className="px-4 py-3 text-center">1</td>
                          <td className="px-4 py-3">
                            <span className="font-medium text-red-700">{lang === 'en' ? 'Discount' : 'Remise'}</span>
                            {discountData.type === 'percentage' && <span className="text-red-500 ml-1">({discountData.value}%)</span>}
                            {discountData.note && <span className="text-gray-500 ml-2 text-sm">‚Äî {discountData.note}</span>}
                          </td>
                          <td className="px-4 py-3 text-right whitespace-nowrap text-red-600"></td>
                          <td className="px-4 py-3 text-right font-medium whitespace-nowrap text-red-600">-{discountAmount.toFixed(2)} ‚Ç¨</td>
                        </tr>
                      )}
                    </tbody>
                    <tfoot>
                      <tr className={isFullyContractCovered ? "bg-emerald-600 text-white" : "bg-[#2D5A7B] text-white"}>
                        <td colSpan={2} className="px-4 py-4"></td>
                        <td className="px-4 py-4 text-right font-bold text-lg whitespace-nowrap">{lang === 'en' ? 'TOTAL excl. VAT' : 'TOTAL HT'}</td>
                        <td className="px-4 py-4 text-right font-bold text-xl whitespace-nowrap">
                          {isFullyContractCovered ? 'Contrat' : `${grandTotal.toFixed(2)} ‚Ç¨`}
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                  
                  {/* Nettoyage disclaimer if applicable */}
                  {devicePricing.some(d => d.needsNettoyage && !d.isContractCovered) && (
                    <p className="text-xs text-gray-500 mt-3 italic">
                      * Le nettoyage cellule sera factur√© uniquement si n√©cessaire selon l'√©tat du capteur √† r√©ception.
                    </p>
                  )}
                </div>

                {/* Disclaimers */}
                <div className="px-8 py-4 border-t">
                  <p className="text-xs text-gray-500 uppercase mb-2">{lang === 'en' ? 'Terms' : 'Conditions'}</p>
                  <ul className="text-xs text-gray-600 space-y-1">
                    {QUOTE_DISCLAIMERS.map((d, i) => (
                      <li key={i}>‚Ä¢ {d}</li>
                    ))}
                  </ul>
                </div>

                {/* Signature Section */}
                <div className="px-8 py-6 border-t flex justify-between items-end">
                  <div className="flex items-end gap-6">
                    <div>
                      <p className="text-xs text-gray-500 uppercase mb-1">{lang === 'en' ? 'Prepared by' : 'Etabli par'}</p>
                      <p className="font-bold text-lg">{signatory}</p>
                      <p className="text-gray-600">Lighthouse France</p>
                    </div>
                    {/* Capcert Logo */}
                    <img 
                      src="/images/logos/capcert-logo.png" 
                      alt="Capcert Certification" 
                      className="h-24 w-auto"
                      onError={(e) => { e.target.style.display = 'none'; }}
                    />
                  </div>
                  <div className="text-right">
                    <p className="text-xs text-gray-400 mb-1">{lang === 'en' ? 'Client signature' : 'Signature client'}</p>
                    <div className="w-48 h-20 border-2 border-dashed border-gray-300 rounded"></div>
                    <p className="text-xs text-gray-400 mt-1">{lang === 'en' ? 'Read and approved' : 'Lu et approuve'}</p>
                  </div>
                </div>

                {/* Footer */}
                <div className="bg-[#1a1a2e] text-white px-8 py-4 text-center text-sm">
                  <p className="font-medium">Lighthouse France SAS</p>
                  <p className="text-gray-400">16, rue Paul Sejourne - 94000 CRETEIL - Tel. 01 43 77 28 07</p>
                </div>
              </div>
            </div>
          )}

          {/* ==================== STEP 3: CONFIRM ==================== */}
          {step === 3 && (
            <div className="flex items-center justify-center min-h-full p-8">
              <div className="text-center max-w-lg">
                <div className={`w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 ${isFullyContractCovered ? 'bg-emerald-500' : isRevision ? 'bg-red-500' : 'bg-[#00A651]'}`}>
                  <span className="text-5xl text-white">{isFullyContractCovered ? 'üìã' : isRevision ? 'üîÑ' : 'üìß'}</span>
                </div>
                <h3 className="text-2xl font-bold text-gray-800 mb-2">
                  {isFullyContractCovered ? (lang === 'en' ? 'Create RMA (Contract)' : 'Cr√©er le RMA (Contrat)') : isRevision ? (lang === 'en' ? 'Submit revision for review' : 'Soumettre la r√©vision pour v√©rification') : (lang === 'en' ? 'Submit quote for review' : 'Soumettre le devis pour v√©rification')}
                </h3>
                <p className="text-gray-600 mb-6">
                  {isFullyContractCovered 
                    ? (lang === 'en' ? 'RMA will be created directly in "Awaiting Device" with the contract PO.' : 'Le RMA sera cr√©√© directement en "Attente Appareil" avec le BC du contrat.')
                    : isRevision
                    ? `Le devis ${request.quote_number} Rev-${currentRevisionCount + 1} sera envoy√© au client. L'ancien devis sera archiv√©.`
                    : (lang === 'en' ? 'The quote will be sent to the client and available on their portal.' : 'Le devis sera envoy√© au client et disponible sur son portail.')
                  }
                </p>
                
                <div className={`rounded-xl p-6 mb-6 text-left ${isFullyContractCovered ? 'bg-emerald-50 border border-emerald-200' : isRevision ? 'bg-red-50 border border-red-200' : 'bg-gray-50'}`}>
                  <p className="text-lg font-bold text-gray-800 mb-1">{request.companies?.name}</p>
                  <p className="text-sm text-gray-500 mb-4">
                    {devicePricing.length} appareil(s)
                    {isRevision && <span className="ml-2 text-red-500 font-medium">‚Ä¢ R√©vision {currentRevisionCount + 1}</span>}
                  </p>
                  
                  <div className="space-y-2 text-sm border-t pt-3">
                    {devicePricing.map(d => (
                      <div key={d.id} className="flex justify-between items-center">
                        <span>
                          {d.model} <span className="text-gray-400">({d.serial})</span>
                          {d.isContractCovered && <span className="ml-2 px-2 py-0.5 bg-emerald-200 text-emerald-700 rounded text-xs font-bold">{lang === 'en' ? 'CONTRACT' : 'CONTRAT'}</span>}
                        </span>
                        <span className="font-medium">
                          {d.isContractCovered ? '0,00 ‚Ç¨' : `${(getDeviceServiceTotal(d) + d.shipping).toFixed(2)} ‚Ç¨`}
                        </span>
                      </div>
                    ))}
                    <div className="border-t pt-2 mt-2 flex justify-between font-bold text-lg">
                      <span>{t('totalHT')}</span>
                      <span className={isFullyContractCovered ? 'text-emerald-600' : 'text-[#00A651]'}>
                        {grandTotal.toFixed(2)} ‚Ç¨
                      </span>
                    </div>
                  </div>
                </div>

                {isFullyContractCovered ? (
                  <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4 text-sm text-emerald-800 text-left">
                    <p className="font-medium mb-2">{lang === 'en' ? 'üéØ Contract workflow:' : 'üéØ Workflow contrat :'}</p>
                    <p className="mb-1">{lang === 'en' ? '‚úì An RMA number will be assigned automatically' : '‚úì Un num√©ro RMA sera attribu√© automatiquement'}</p>
                    <p className="mb-1">{lang === 'en' ? '‚úì Contract PO will be copied to RMA' : '‚úì Le BC du contrat sera copi√© dans le RMA'}</p>
                    <p className="mb-1">{lang === 'en' ? '‚úì Status directly set to "Awaiting Device"' : '‚úì Statut directement "Attente Appareil"'}</p>
                    <p>{lang === 'en' ? "‚úì No client approval needed" : "‚úì Pas d'approbation client n√©cessaire"}</p>
                  </div>
                ) : isRevision ? (
                  <div className="bg-red-50 border border-red-200 rounded-xl p-4 text-sm text-red-800 text-left">
                    <p className="font-medium mb-2">{lang === 'en' ? 'üîÑ Quote Revision:' : 'üîÑ R√©vision du devis :'}</p>
                    <p className="mb-1">{lang === 'en' ? "‚úì Previous quote will be archived (admin-only visibility)" : "‚úì L'ancien devis sera archiv√© (visible uniquement par les admins)"}</p>
                    <p className="mb-1">‚úì Le num√©ro reste {request.quote_number} avec mention Rev-{currentRevisionCount + 1}</p>
                    <p className="mb-1">{lang === 'en' ? '‚úì Client will need to approve and re-sign the new quote' : '‚úì Le client devra approuver et re-signer le nouveau devis'}</p>
                    <p>{lang === 'en' ? '‚úì Client will only see the most recent quote' : '‚úì Le client ne verra que le devis le plus r√©cent'}</p>
                  </div>
                ) : (
                  <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm text-blue-800 text-left">
                    <p className="font-medium mb-2">{lang === 'en' ? 'After sending:' : 'Apr√®s envoi :'}</p>
                    <p className="mb-1">{lang === 'en' ? '‚úì An RMA number will be assigned automatically' : '‚úì Un num√©ro RMA sera attribu√© automatiquement'}</p>
                    <p className="mb-1">{lang === 'en' ? '‚úì Client will receive a notification' : '‚úì Le client recevra une notification'}</p>
                    <p>{lang === 'en' ? '‚úì Quote will be available on their portal' : '‚úì Le devis sera disponible sur son portail'}</p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Footer Navigation */}
        <div className="px-6 py-4 bg-gray-100 border-t flex justify-between items-center shrink-0">
          <button onClick={step === 1 ? onClose : () => setStep(step - 1)} className="px-6 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg font-medium">
            {step === 1 ? t('cancel') : '‚Üê Retour'}
          </button>
          <div className="flex gap-3">
            {step < 3 && !loadingContract && !loadingParts && (
              <button onClick={() => setStep(step + 1)} className="px-8 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">
                Suivant ‚Üí
              </button>
            )}
            {step === 3 && (
              <button 
                onClick={sendQuote} 
                disabled={saving} 
                className={`px-10 py-3 text-white rounded-lg font-bold text-lg disabled:opacity-50 ${isFullyContractCovered ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-[#00A651] hover:bg-[#008f45]'}`}
              >
                {saving ? (lang === 'en' ? 'Submitting...' : 'Envoi en cours...') : isFullyContractCovered ? (lang === 'en' ? 'üìã Create Contract RMA' : 'üìã Cr√©er RMA Contrat') : isRevision ? (lang === 'en' ? 'üìã Submit Revision for Review' : 'üìã Soumettre R√©vision pour V√©rification') : (lang === 'en' ? 'üìã Submit for Review' : 'üìã Soumettre pour V√©rification')}
              </button>
            )}
            {(loadingContract || loadingParts) && step === 1 && (
              <div className="px-8 py-2 bg-gray-300 text-gray-500 rounded-lg font-medium">
                Chargement...
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// PRICING SHEET COMPONENT
// ============================================
function PricingSheet({ notify, isAdmin, t = k=>k, lang = 'fr' }) {
  const [parts, setParts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [uploading, setUploading] = useState(false);
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [editingPart, setEditingPart] = useState(null);
  const [showAddModal, setShowAddModal] = useState(false);

  // Load parts from database
  const loadParts = useCallback(async () => {
    setLoading(true);
    
    // Load all parts using pagination (Supabase has 1000 row limit per request)
    let allParts = [];
    let offset = 0;
    const pageSize = 1000;
    let hasMore = true;
    
    while (hasMore) {
      const { data, error } = await supabase
        .from('parts_pricing')
        .select('*')
        .order('part_number', { ascending: true })
        .range(offset, offset + pageSize - 1);
      
      if (error) {
        console.error('Error loading parts:', error);
        notify(lang === 'en' ? 'Error loading parts' : 'Erreur de chargement des pi√®ces', 'error');
        break;
      }
      
      if (data && data.length > 0) {
        allParts = [...allParts, ...data];
        offset += pageSize;
        hasMore = data.length === pageSize; // If we got less than pageSize, we're done
      } else {
        hasMore = false;
      }
    }
    
    setParts(allParts);
    console.log(`Loaded ${allParts.length} parts total`);
    setLoading(false);
  }, [notify]);

  useEffect(() => {
    loadParts();
  }, [loadParts]);

  // Get unique categories for filter
  const categories = [...new Set(parts.map(p => p.category).filter(Boolean))];

  // Filter parts based on search and category
  const filteredParts = parts.filter(part => {
    const matchesSearch = !searchTerm || 
      part.part_number?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      part.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      part.description_fr?.toLowerCase().includes(searchTerm.toLowerCase());
    
    const matchesCategory = categoryFilter === 'all' || part.category === categoryFilter;
    
    return matchesSearch && matchesCategory;
  });

  // Handle Excel file upload
  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setUploading(true);
    
    try {
      // Load SheetJS library dynamically
      if (!window.XLSX) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = window.XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = window.XLSX.utils.sheet_to_json(worksheet);

          if (jsonData.length === 0) {
            notify(lang === 'en' ? 'File is empty' : 'Le fichier est vide', 'error');
            setUploading(false);
            return;
          }

          // OPTIMIZED BULK IMPORT
          const partsToUpsert = [];
          let skipped = 0;

          // Get all column names from first row and normalize them
          const originalColumns = Object.keys(jsonData[0]);
          console.log('=== EXCEL COLUMN DEBUG ===');
          console.log('Raw columns:', originalColumns);
          originalColumns.forEach((col, i) => {
            console.log(`Column ${i}: "${col}" (length: ${col.length}, chars: ${[...col].map(c => c.charCodeAt(0)).join(',')})`);
          });
          console.log('First row values:', jsonData[0]);

          // Create a normalized column map (strip all whitespace, lowercase, remove accents)
          const normalizeKey = (str) => {
            return str.toString()
              .toLowerCase()
              .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
              .replace(/[^a-z0-9]/g, ''); // Remove all non-alphanumeric
          };

          const columnMap = {};
          originalColumns.forEach(col => {
            columnMap[normalizeKey(col)] = col;
          });
          console.log('Normalized column map:', columnMap);

          // Smart column finder - finds best match
          const findColumn = (row, ...searchTerms) => {
            // First: try direct match on original columns
            for (const term of searchTerms) {
              if (row[term] !== undefined && row[term] !== null && row[term] !== '') {
                return row[term];
              }
            }
            // Second: try normalized match
            for (const term of searchTerms) {
              const normalizedTerm = normalizeKey(term);
              const matchedOriginal = columnMap[normalizedTerm];
              if (matchedOriginal && row[matchedOriginal] !== undefined && row[matchedOriginal] !== null && row[matchedOriginal] !== '') {
                return row[matchedOriginal];
              }
            }
            // Third: try partial match (column contains search term)
            const rowKeys = Object.keys(row);
            for (const term of searchTerms) {
              const normalizedTerm = normalizeKey(term);
              for (const key of rowKeys) {
                if (normalizeKey(key).includes(normalizedTerm) || normalizedTerm.includes(normalizeKey(key))) {
                  if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                    return row[key];
                  }
                }
              }
            }
            return null;
          };

          // Parse each row
          for (const row of jsonData) {
            const partNumber = findColumn(row, 'Part Number', 'PartNumber', 'part_number', 'Ref', 'Reference', 'SKU', 'PN', 'Part No', 'Num√©ro', (lang === 'en' ? 'Part #' : 'N¬∞ Pi√®ce'));
            const description = findColumn(row, 'Description', 'Desc', 'Name', 'Nom', (lang === 'en' ? 'Description' : 'D√©signation'), 'Designation', 'Libell√©', 'Libelle', 'Label');
            const descriptionFr = findColumn(row, 'Description FR', 'description_fr', 'Nom FR');
            const category = findColumn(row, 'Category', 'Categorie', (lang === 'en' ? 'Category' : 'Cat√©gorie'), 'Type', 'Cat', 'Famille');
            const rawPrice = findColumn(row, 'Price', 'Prix', 'Unit Price', 'Prix Unitaire', 'Cost', 'Tarif', 'PU', 'Prix HT', 'Montant');
            const rawQuantity = findColumn(row, 'Quantity', 'Stock', 'Qty', 'QTY', 'Qt√©', 'Quantit√©');
            const location = findColumn(row, 'Location', 'Emplacement', 'Loc', 'Lieu');
            const supplier = findColumn(row, 'Supplier', 'Fournisseur', 'Vendor', 'Source');

            if (!partNumber) {
              skipped++;
              continue;
            }

            const price = parseFloat(rawPrice) || null;
            const quantity = parseInt(rawQuantity) || 0;

            partsToUpsert.push({
              part_number: partNumber.toString().trim(),
              description: description ? description.toString().trim() : null,
              description_fr: descriptionFr ? descriptionFr.toString().trim() : null,
              category: category ? category.toString().trim() : null,
              unit_price: price,
              quantity_in_stock: quantity,
              location: location ? location.toString().trim() : null,
              supplier: supplier ? supplier.toString().trim() : null,
              last_price_update: new Date().toISOString()
            });
          }

          // DEDUPLICATE - keep last occurrence of each part number (in case Excel has duplicates)
          const partsMap = new Map();
          for (const part of partsToUpsert) {
            partsMap.set(part.part_number, part); // Later entries overwrite earlier ones
          }
          const uniqueParts = Array.from(partsMap.values());
          const duplicatesRemoved = partsToUpsert.length - uniqueParts.length;
          
          console.log('=== DEDUPLICATION ===');
          console.log(`Original: ${partsToUpsert.length}, Unique: ${uniqueParts.length}, Duplicates removed: ${duplicatesRemoved}`);

          // Log sample
          if (uniqueParts.length > 0) {
            console.log('=== PARSED DATA SAMPLE ===');
            console.log('First part:', uniqueParts[0]);
            console.log('Second part:', uniqueParts[1]);
            const withDesc = uniqueParts.filter(p => p.description);
            console.log(`Parts with description: ${withDesc.length}/${uniqueParts.length}`);
          }

          if (uniqueParts.length === 0) {
            notify(lang === 'en' ? 'No valid parts found in file' : 'Aucune pi√®ce valide trouv√©e dans le fichier', 'error');
            setUploading(false);
            return;
          }
          
          // Replace partsToUpsert with deduplicated list
          const partsToImport = uniqueParts;

          // Step 2: Get ALL existing part numbers
          const { data: existingParts, error: fetchError } = await supabase
            .from('parts_pricing')
            .select('part_number');
          
          if (fetchError) {
            console.error('Error fetching existing parts:', fetchError);
          }
          
          const existingPartNumbers = new Set((existingParts || []).map(p => p.part_number));
          
          // Separate into inserts and updates
          const toInsert = partsToImport.filter(p => !existingPartNumbers.has(p.part_number));
          const toUpdate = partsToImport.filter(p => existingPartNumbers.has(p.part_number));

          console.log(`=== IMPORT PLAN ===`);
          console.log(`Total unique parts: ${partsToImport.length}`);
          console.log(`New (INSERT): ${toInsert.length}`);
          console.log(`Existing (UPDATE): ${toUpdate.length}`);
          console.log(`Skipped (no part number): ${skipped}`);
          console.log(`Duplicates in Excel: ${duplicatesRemoved}`);

          // Step 3: Process inserts in batches
          const batchSize = 200; // Smaller batches for reliability
          let insertErrors = 0;
          let updateErrors = 0;
          
          // INSERT new parts
          for (let i = 0; i < toInsert.length; i += batchSize) {
            const batch = toInsert.slice(i, i + batchSize);
            const batchNum = Math.floor(i / batchSize) + 1;
            const totalBatches = Math.ceil(toInsert.length / batchSize);
            
            console.log(`INSERT batch ${batchNum}/${totalBatches} (${batch.length} parts)`);
            
            const { error } = await supabase
              .from('parts_pricing')
              .insert(batch);
            
            if (error) {
              console.error(`INSERT batch ${batchNum} error:`, error);
              insertErrors += batch.length;
            }
          }

          // UPDATE existing parts (one by one to avoid conflicts)
          let updateCount = 0;
          for (const part of toUpdate) {
            const { error } = await supabase
              .from('parts_pricing')
              .update({
                description: part.description,
                description_fr: part.description_fr,
                category: part.category,
                unit_price: part.unit_price,
                quantity_in_stock: part.quantity_in_stock,
                location: part.location,
                supplier: part.supplier,
                last_price_update: part.last_price_update
              })
              .eq('part_number', part.part_number);
            
            if (error) {
              updateErrors++;
              if (updateErrors <= 3) console.error(`UPDATE error for ${part.part_number}:`, error);
            } else {
              updateCount++;
            }
            
            // Progress log every 100
            if (updateCount % 100 === 0) {
              console.log(`Updated ${updateCount}/${toUpdate.length}...`);
            }
          }

          const totalErrors = insertErrors + updateErrors;
          const message = `${lang === 'en' ? 'Import complete' : 'Import termin√©'}: ${toInsert.length - insertErrors} ${lang === 'en' ? 'created' : 'cr√©√©s'}, ${toUpdate.length - updateErrors} ${lang === 'en' ? 'updated' : 'mis √† jour'}${skipped > 0 ? `, ${skipped} ${lang === 'en' ? 'skipped' : 'ignor√©s'}` : ''}${totalErrors > 0 ? `, ${totalErrors} ${lang === 'en' ? 'errors' : 'erreurs'}` : ''}`;
          
          notify(message, totalErrors > 0 ? 'error' : 'success');
          loadParts();
          setShowUploadModal(false);
        } catch (err) {
          console.error('Parse error:', err);
          notify(lang === 'en' ? 'Error reading Excel file' : 'Erreur lors de la lecture du fichier Excel', 'error');
        }
        setUploading(false);
      };
      reader.readAsArrayBuffer(file);
    } catch (err) {
      console.error('Upload error:', err);
      notify(lang === 'en' ? 'Error loading file' : 'Erreur lors du chargement du fichier', 'error');
      setUploading(false);
    }
  };

  // Save part (create or update)
  const savePart = async (partData) => {
    try {
      if (editingPart?.id) {
        // Update
        const { error } = await supabase
          .from('parts_pricing')
          .update({ ...partData, last_price_update: new Date().toISOString() })
          .eq('id', editingPart.id);
        
        if (error) throw error;
        notify(lang === 'en' ? 'Part updated' : 'Pi√®ce mise √† jour');
      } else {
        // Create
        const { error } = await supabase
          .from('parts_pricing')
          .insert({ ...partData, last_price_update: new Date().toISOString() });
        
        if (error) throw error;
        notify(lang === 'en' ? 'Part created' : 'Pi√®ce cr√©√©e');
      }
      loadParts();
      setEditingPart(null);
      setShowAddModal(false);
    } catch (err) {
      console.error('Save error:', err);
      notify(lang === 'en' ? 'Error saving' : 'Erreur lors de la sauvegarde', 'error');
    }
  };

  // Delete part
  const deletePart = async (id) => {
    if (!confirm(lang === 'en' ? 'Delete this part?' : 'Supprimer cette pi√®ce ?')) return;
    
    const { error } = await supabase.from('parts_pricing').delete().eq('id', id);
    if (error) {
      notify(lang === 'en' ? 'Error deleting' : 'Erreur lors de la suppression', 'error');
    } else {
      notify((lang === 'en' ? 'Part deleted' : 'Pi√®ce supprim√©e'));
      loadParts();
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('pricing')}</h1>
          <p className="text-gray-500">{parts.length} {lang === 'en' ? 'parts in catalog' : 'pi√®ces au catalogue'}</p>
        </div>
        <div className="flex gap-3">
          <button
            onClick={() => setShowUploadModal(true)}
            className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium flex items-center gap-2"
          >
            üì§ Importer Excel
          </button>
          {isAdmin && (
            <button
              onClick={() => { setEditingPart(null); setShowAddModal(true); }}
              className="px-4 py-2 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-medium flex items-center gap-2"
            >
              + Ajouter Pi√®ce
            </button>
          )}
        </div>
      </div>

      {/* Search & Filters */}
      <div className="bg-white rounded-xl shadow-sm p-4 flex flex-col md:flex-row gap-4">
        <div className="flex-1 relative">
          <input
            type="text"
            placeholder={lang === 'en' ? 'Search by part number or description...' : 'Rechercher par num√©ro de pi√®ce ou description...'}
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651] focus:border-transparent"
          />
          <span className="absolute left-3 top-2.5 text-gray-400">üîç</span>
        </div>
        <select
          value={categoryFilter}
          onChange={(e) => setCategoryFilter(e.target.value)}
          className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
        >
          <option value="all">{lang === 'en' ? 'All categories' : 'Toutes cat√©gories'}</option>
          {categories.map(cat => (
            <option key={cat} value={cat}>{cat}</option>
          ))}
        </select>
      </div>

      {/* Parts Table */}
      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        {loading ? (
          <div className="p-12 text-center">
            <div className="w-8 h-8 border-4 border-[#00A651] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p className="text-gray-500">{t('loading')}</p>
          </div>
        ) : filteredParts.length === 0 ? (
          <div className="p-12 text-center">
            <p className="text-4xl mb-4">üì¶</p>
            <p className="text-gray-500">
              {searchTerm || categoryFilter !== 'all' 
                ? (lang === 'en' ? 'No parts match your search' : 'Aucune pi√®ce ne correspond √† votre recherche') 
                : (lang === 'en' ? 'No parts in catalog. Import an Excel file to get started.' : 'Aucune pi√®ce au catalogue. Importez un fichier Excel pour commencer.')}
            </p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">{lang === 'en' ? 'Part #' : 'N¬∞ Pi√®ce'}</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">{t('description')}</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">{lang === 'en' ? 'Category' : 'Cat√©gorie'}</th>
                  <th className="px-4 py-3 text-right text-sm font-semibold text-gray-600">{lang === 'en' ? 'Unit Price' : 'Prix Unit.'}</th>
                  <th className="px-4 py-3 text-center text-sm font-semibold text-gray-600">{lang === 'en' ? 'Stock' : 'Stock'}</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">{lang === 'en' ? 'Location' : 'Emplacement'}</th>
                  <th className="px-4 py-3 text-center text-sm font-semibold text-gray-600">{t('actions')}</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {filteredParts.map(part => (
                  <tr key={part.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3 font-mono text-sm font-medium text-[#1a1a2e]">{part.part_number}</td>
                    <td className="px-4 py-3">
                      <p className="text-sm text-gray-800">{part.description || '-'}</p>
                      {part.description_fr && part.description_fr !== part.description && (
                        <p className="text-xs text-gray-500">{part.description_fr}</p>
                      )}
                    </td>
                    <td className="px-4 py-3">
                      {part.category && (
                        <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">{part.category}</span>
                      )}
                    </td>
                    <td className="px-4 py-3 text-right font-medium text-[#00A651]">
                      {part.unit_price ? `${part.unit_price.toFixed(2)} ‚Ç¨` : '-'}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                        part.quantity_in_stock === 0 ? 'bg-red-100 text-red-700' :
                        part.quantity_in_stock <= (part.reorder_level || 5) ? 'bg-amber-100 text-amber-700' :
                        'bg-green-100 text-green-700'
                      }`}>
                        {part.quantity_in_stock || 0}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-500">{part.location || '-'}</td>
                    <td className="px-4 py-3 text-center">
                      <div className="flex justify-center gap-2">
                        <button
                          onClick={() => { setEditingPart(part); setShowAddModal(true); }}
                          className="p-1 text-blue-500 hover:bg-blue-50 rounded"
                          title={lang === 'en' ? 'Edit' : 'Modifier'}
                        >
                          ‚úèÔ∏è
                        </button>
                        {isAdmin && (
                          <button
                            onClick={() => deletePart(part.id)}
                            className="p-1 text-red-500 hover:bg-red-50 rounded"
                            title={lang === "en" ? "Delete" : "Supprimer"}
                          >
                            üóëÔ∏è
                          </button>
                        )}
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Upload Modal */}
      {showUploadModal && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl max-w-lg w-full p-6">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-xl font-bold">{lang === 'en' ? 'Import Excel file' : 'Importer un fichier Excel'}</h2>
              <button onClick={() => setShowUploadModal(false)} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div className="space-y-4">
              <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center">
                <p className="text-4xl mb-4">üìÅ</p>
                <p className="text-gray-600 mb-4">
                  {lang === 'en' ? 'Drag and drop your Excel file here or' : 'Glissez-d√©posez votre fichier Excel ici ou'}
                </p>
                <label className="cursor-pointer inline-block px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                  S√©lectionner un fichier
                  <input
                    type="file"
                    accept=".xlsx,.xls,.csv"
                    onChange={handleFileUpload}
                    className="hidden"
                    disabled={uploading}
                  />
                </label>
              </div>
              
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm">
                <p className="font-medium text-blue-800 mb-2">{lang === 'en' ? 'Expected columns:' : 'Colonnes attendues :'}</p>
                <ul className="text-blue-700 text-xs space-y-1">
                  <li>‚Ä¢ <strong>Part Number</strong> {lang === 'en' ? '(required) - Unique part number' : '(obligatoire) - Num√©ro de pi√®ce unique'}</li>
                  <li>‚Ä¢ <strong>{t('description')}</strong>{lang === 'en' ? ' - Description in English' : ' - Description en anglais'}</li>
                  <li>‚Ä¢ <strong>{lang === 'en' ? 'Description FR' : 'Description FR'}</strong>{lang === 'en' ? ' - Description in French' : ' - Description en fran√ßais'}</li>
                  <li>‚Ä¢ <strong>Category</strong>{lang === 'en' ? ' - Category (e.g. Filters, Sensors...)' : ' - Cat√©gorie (ex: Filtres, Capteurs...)'}</li>
                  <li>‚Ä¢ <strong>Price</strong>{lang === 'en' ? ' - Unit price excl. VAT' : ' - Prix unitaire HT'}</li>
                  <li>‚Ä¢ <strong>Quantity</strong>{lang === 'en' ? ' - Quantity in stock' : ' - Quantit√© en stock'}</li>
                  <li>‚Ä¢ <strong>{lang === 'en' ? 'Rental' : 'Location'}</strong>{lang === 'en' ? ' - Storage location' : ' - Emplacement de stockage'}</li>
                  <li>‚Ä¢ <strong>Supplier</strong>{lang === 'en' ? ' - Supplier' : ' - Fournisseur'}</li>
                </ul>
              </div>

              {uploading && (
                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-6 h-6 border-4 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                    <span className="text-green-800 font-medium">{lang === 'en' ? 'Importing...' : 'Import en cours...'}</span>
                  </div>
                  <p className="text-green-700 text-sm">
                    {lang === 'en' ? 'Processing in batches of 500 parts. For 3000 parts, expect about 30 seconds to 2 minutes.' : 'Traitement par lots de 500 pi√®ces. Pour 3000 pi√®ces, comptez environ 30 secondes √† 2 minutes.'}
                  </p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Add/Edit Modal */}
      {showAddModal && (
        <PartEditModal
          part={editingPart}
          onSave={savePart}
          onClose={() => { setShowAddModal(false); setEditingPart(null); }}
        />
      )}
    </div>
  );
}

// ============================================
// PART EDIT MODAL
// ============================================
function PartEditModal({ part, onSave, onClose, lang = 'fr' }) {
  const [formData, setFormData] = useState({
    part_number: part?.part_number || '',
    description: part?.description || '',
    description_fr: part?.description_fr || '',
    category: part?.category || '',
    unit_price: part?.unit_price || '',
    quantity_in_stock: part?.quantity_in_stock || 0,
    reorder_level: part?.reorder_level || 5,
    location: part?.location || '',
    supplier: part?.supplier || ''
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.part_number.trim()) {
      alert(lang === 'en' ? 'Part number is required' : 'Le num√©ro de pi√®ce est obligatoire');
      return;
    }
    onSave({
      ...formData,
      unit_price: formData.unit_price ? parseFloat(formData.unit_price) : null,
      quantity_in_stock: parseInt(formData.quantity_in_stock) || 0,
      reorder_level: parseInt(formData.reorder_level) || 5
    });
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="sticky top-0 bg-white px-6 py-4 border-b flex justify-between items-center">
          <h2 className="text-xl font-bold">{part ? 'Modifier la pi√®ce' : (lang === 'en' ? 'Add a part' : 'Ajouter une pi√®ce')}</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Part # *' : 'N¬∞ Pi√®ce *'}</label>
              <input
                type="text"
                value={formData.part_number}
                onChange={(e) => setFormData({ ...formData, part_number: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
                required
                disabled={!!part}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Category' : 'Cat√©gorie'}</label>
              <input
                type="text"
                value={formData.category}
                onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
                placeholder={lang === 'en' ? 'e.g. Filters, Sensors, Pumps...' : 'ex: Filtres, Capteurs, Pompes...'}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Description (EN)' : 'Description (EN)'}</label>
            <input
              type="text"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Description (FR)' : 'Description (FR)'}</label>
            <input
              type="text"
              value={formData.description_fr}
              onChange={(e) => setFormData({ ...formData, description_fr: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
            />
          </div>

          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Unit Price (‚Ç¨)' : 'Prix Unitaire (‚Ç¨)'}</label>
              <input
                type="number"
                step="0.01"
                value={formData.unit_price}
                onChange={(e) => setFormData({ ...formData, unit_price: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
                placeholder="0.00"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Stock' : 'Stock'}</label>
              <input
                type="number"
                value={formData.quantity_in_stock}
                onChange={(e) => setFormData({ ...formData, quantity_in_stock: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Reorder threshold' : 'Seuil r√©approvisionnement'}</label>
              <input
                type="number"
                value={formData.reorder_level}
                onChange={(e) => setFormData({ ...formData, reorder_level: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
              />
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Location' : 'Emplacement'}</label>
              <input
                type="text"
                value={formData.location}
                onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
                placeholder={lang === 'en' ? 'e.g. Shelf A3, Drawer 12...' : 'ex: √âtag√®re A3, Tiroir 12...'}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Supplier' : 'Fournisseur'}</label>
              <input
                type="text"
                value={formData.supplier}
                onChange={(e) => setFormData({ ...formData, supplier: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#00A651]"
              />
            </div>
          </div>

          <div className="flex gap-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium"
            >
              Annuler
            </button>
            <button
              type="submit"
              className="flex-1 py-2 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-medium"
            >
              {part ? t('save') : (lang === 'en' ? 'Create' : 'Cr√©er')}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}

// ============================================
// RENTALS SHEET - Admin Management
// ============================================
// ============================================
// USA ORDERS SHEET - Commandes USA
// ============================================
function USAOrdersSheet({ clients = [], notify, reload, profile, t = k=>k, lang = 'fr' }) {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [filter, setFilter] = useState('all');
  const [search, setSearch] = useState('');
  const [saving, setSaving] = useState(false);

  // Load orders
  const loadOrders = async () => {
    setLoading(true);
    const { data } = await supabase.from('usa_orders')
      .select('*')
      .order('created_at', { ascending: false });
    setOrders(data || []);
    setLoading(false);
  };

  useEffect(() => { loadOrders(); }, []);

  const statusConfig = {
    order_created: { label: lang === 'en' ? 'Order Created' : 'Commande cr√©√©e', bg: 'bg-blue-100', text: 'text-blue-700', icon: 'üì¶' },
    received_france: { label: lang === 'en' ? 'Received at France' : 'Re√ßu en France', bg: 'bg-cyan-100', text: 'text-cyan-700', icon: 'üè≠' },
    qc_complete: { label: lang === 'en' ? 'QC Complete' : 'QC Valid√©', bg: 'bg-purple-100', text: 'text-purple-700', icon: '‚úÖ' },
    shipped: { label: lang === 'en' ? 'Shipped' : 'Exp√©di√©', bg: 'bg-green-100', text: 'text-green-700', icon: 'üöö' }
  };

  const steps = [
    { id: 'order_created', label: lang === 'en' ? 'Ordered' : 'Command√©' },
    { id: 'received_france', label: lang === 'en' ? 'Received' : 'Re√ßu' },
    { id: 'qc_complete', label: lang === 'en' ? 'QC' : 'QC' },
    { id: 'shipped', label: lang === 'en' ? 'Shipped' : 'Exp√©di√©' }
  ];

  const getStepIndex = (status) => {
    const map = { order_created: 0, received_france: 1, qc_complete: 2, shipped: 3 };
    return map[status] ?? 0;
  };

  // Filter orders
  const filtered = orders.filter(o => {
    if (filter !== 'all' && o.status !== filter) return false;
    if (search) {
      const s = search.toLowerCase();
      return (o.po_number || '').toLowerCase().includes(s) ||
             (o.quote_number || '').toLowerCase().includes(s) ||
             (o.customer_name || '').toLowerCase().includes(s) ||
             (o.invoice_number || '').toLowerCase().includes(s);
    }
    return true;
  });

  // Status counts
  const counts = {
    all: orders.length,
    order_created: orders.filter(o => o.status === 'order_created').length,
    received_france: orders.filter(o => o.status === 'received_france').length,
    qc_complete: orders.filter(o => o.status === 'qc_complete').length,
    shipped: orders.filter(o => o.status === 'shipped').length
  };

  // Update order status
  const updateStatus = async (orderId, newStatus) => {
    setSaving(true);
    const update = { status: newStatus };
    const now = new Date().toISOString();
    if (newStatus === 'received_france') update.received_france_at = now;
    if (newStatus === 'qc_complete') update.qc_completed_at = now;
    if (newStatus === 'shipped') update.shipped_at = now;

    const { error } = await supabase.from('usa_orders').update(update).eq('id', orderId);
    if (error) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
    } else {
      notify(lang === 'en' ? '‚úÖ Status updated!' : '‚úÖ Statut mis √† jour !');
      loadOrders();
      if (selectedOrder?.id === orderId) {
        setSelectedOrder(prev => ({ ...prev, ...update }));
      }
    }
    setSaving(false);
  };

  // Delete order
  const deleteOrder = async (orderId) => {
    if (!confirm(lang === 'en' ? 'Delete this order?' : 'Supprimer cette commande ?')) return;
    const { error } = await supabase.from('usa_orders').delete().eq('id', orderId);
    if (error) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + error.message, 'error');
    } else {
      notify(lang === 'en' ? '‚úÖ Order deleted' : '‚úÖ Commande supprim√©e');
      setSelectedOrder(null);
      loadOrders();
    }
  };

  // ---- ORDER DETAIL VIEW ----
  if (selectedOrder) {
    const order = selectedOrder;
    const sc = statusConfig[order.status] || statusConfig.order_created;
    const currentStep = getStepIndex(order.status);
    const items = Array.isArray(order.line_items) ? order.line_items : [];
    const nextStatus = order.status === 'order_created' ? 'received_france' :
                       order.status === 'received_france' ? 'qc_complete' :
                       order.status === 'qc_complete' ? 'shipped' : null;

    return (
      <div className="space-y-6">
        {/* Back + Header */}
        <div className="flex items-center justify-between">
          <button onClick={() => setSelectedOrder(null)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
            ‚Üê {lang === 'en' ? 'Back to Orders' : 'Retour aux commandes'}
          </button>
          <div className="flex items-center gap-3">
            {nextStatus && (
              <button
                onClick={() => updateStatus(order.id, nextStatus)}
                disabled={saving}
                className="px-4 py-2 bg-[#00A651] hover:bg-green-700 text-white rounded-lg font-medium disabled:opacity-50"
              >
                {saving ? '‚è≥' : statusConfig[nextStatus]?.icon} {lang === 'en' ? `Mark as ${statusConfig[nextStatus]?.label}` : `Marquer ${statusConfig[nextStatus]?.label}`}
              </button>
            )}
            <button onClick={() => deleteOrder(order.id)} className="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm">
              üóëÔ∏è
            </button>
          </div>
        </div>

        {/* Progress Bar */}
        <div className="bg-white rounded-xl shadow-sm border p-4">
          <div className="flex w-full">
            {steps.map((step, i) => {
              const isComplete = i < currentStep;
              const isCurrent = i === currentStep;
              return (
                <div key={step.id} className="flex-1 flex flex-col items-center relative">
                  <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold z-10 ${
                    isComplete ? 'bg-[#00A651] text-white' : isCurrent ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-500'
                  }`}>
                    {isComplete ? '‚úì' : i + 1}
                  </div>
                  <span className={`text-xs mt-1 font-medium ${isComplete ? 'text-green-700' : isCurrent ? 'text-blue-700' : 'text-gray-400'}`}>{step.label}</span>
                  {i < steps.length - 1 && (
                    <div className={`absolute top-5 left-[55%] w-[90%] h-0.5 ${isComplete ? 'bg-[#00A651]' : 'bg-gray-200'}`} />
                  )}
                </div>
              );
            })}
          </div>
          <div className="flex justify-between text-xs text-gray-400 mt-3 px-2">
            <span>{order.order_created_at ? new Date(order.order_created_at).toLocaleDateString('fr-FR') : '‚Äî'}</span>
            <span>{order.received_france_at ? new Date(order.received_france_at).toLocaleDateString('fr-FR') : '‚Äî'}</span>
            <span>{order.qc_completed_at ? new Date(order.qc_completed_at).toLocaleDateString('fr-FR') : '‚Äî'}</span>
            <span>{order.shipped_at ? new Date(order.shipped_at).toLocaleDateString('fr-FR') : '‚Äî'}</span>
          </div>
        </div>

        {/* Order Info + Customer */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div className="bg-white rounded-xl shadow-sm border p-5">
            <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'üìã Order Details' : 'üìã D√©tails Commande'}</h3>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between"><span className="text-gray-500">PO #</span><span className="font-mono font-medium">{order.po_number || '‚Äî'}</span></div>
              <div className="flex justify-between"><span className="text-gray-500">{lang === 'en' ? 'Quote #' : 'Devis #'}</span><span className="font-mono font-medium">{order.quote_number || '‚Äî'}</span></div>
              <div className="flex justify-between"><span className="text-gray-500">{lang === 'en' ? 'Status' : 'Statut'}</span><span className={`px-2 py-0.5 rounded-full text-xs font-medium ${sc.bg} ${sc.text}`}>{sc.icon} {sc.label}</span></div>
              <div className="flex justify-between"><span className="text-gray-500">{lang === 'en' ? 'Created' : 'Cr√©√© le'}</span><span>{new Date(order.created_at).toLocaleDateString('fr-FR')}</span></div>
              {order.tracking_number && <div className="flex justify-between"><span className="text-gray-500">Tracking</span><span className="font-mono">{order.tracking_number}</span></div>}
              {order.shipping_carrier && <div className="flex justify-between"><span className="text-gray-500">{lang === 'en' ? 'Carrier' : 'Transporteur'}</span><span>{order.shipping_carrier}</span></div>}
            </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm border p-5">
            <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'üë§ Customer' : 'üë§ Client'}</h3>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between"><span className="text-gray-500">{lang === 'en' ? 'Company' : 'Soci√©t√©'}</span><span className="font-medium">{order.customer_name || '‚Äî'}</span></div>
              <div className="flex justify-between"><span className="text-gray-500">Contact</span><span>{order.customer_contact || '‚Äî'}</span></div>
              <div className="flex justify-between"><span className="text-gray-500">Email</span><span>{order.customer_email || '‚Äî'}</span></div>
              <div className="flex justify-between"><span className="text-gray-500">{lang === 'en' ? 'Phone' : 'T√©l.'}</span><span>{order.customer_phone || '‚Äî'}</span></div>
              {order.customer_address && <div><span className="text-gray-500">{lang === 'en' ? 'Address' : 'Adresse'}</span><p className="mt-1 text-gray-700">{order.customer_address}</p></div>}
            </div>
          </div>
        </div>

        {/* Line Items */}
        <div className="bg-white rounded-xl shadow-sm border p-5">
          <h3 className="font-bold text-gray-800 mb-3">{lang === 'en' ? 'üì¶ Line Items' : 'üì¶ Articles'}</h3>
          {items.length === 0 ? (
            <p className="text-gray-400 text-sm">{lang === 'en' ? 'No items' : 'Aucun article'}</p>
          ) : (
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b text-left text-gray-500">
                  <th className="pb-2">{lang === 'en' ? 'Part #' : 'R√©f.'}</th>
                  <th className="pb-2">Description</th>
                  <th className="pb-2 text-center">{lang === 'en' ? 'Qty' : 'Qt√©'}</th>
                  <th className="pb-2 text-right">{lang === 'en' ? 'Unit Price' : 'Prix unit.'}</th>
                  <th className="pb-2 text-right">Total</th>
                </tr>
              </thead>
              <tbody>
                {items.map((item, i) => (
                  <tr key={i} className="border-b last:border-0">
                    <td className="py-2 font-mono text-xs">{item.part_number || '‚Äî'}</td>
                    <td className="py-2">{item.description || '‚Äî'}</td>
                    <td className="py-2 text-center">{item.quantity || 0}</td>
                    <td className="py-2 text-right">‚Ç¨{(item.unit_price || 0).toFixed(2)}</td>
                    <td className="py-2 text-right font-medium">‚Ç¨{(item.total || 0).toFixed(2)}</td>
                  </tr>
                ))}
              </tbody>
              <tfoot>
                <tr className="border-t-2"><td colSpan="4" className="py-2 text-right font-medium">{lang === 'en' ? 'Subtotal' : 'Sous-total'}</td><td className="py-2 text-right font-bold">‚Ç¨{(order.subtotal || 0).toFixed(2)}</td></tr>
                <tr><td colSpan="4" className="py-1 text-right text-gray-500">TVA ({order.tax_rate || 20}%)</td><td className="py-1 text-right">‚Ç¨{(order.tax_amount || 0).toFixed(2)}</td></tr>
                <tr className="border-t"><td colSpan="4" className="py-2 text-right font-bold text-lg">Total</td><td className="py-2 text-right font-bold text-lg text-[#00A651]">‚Ç¨{(order.total || 0).toFixed(2)}</td></tr>
              </tfoot>
            </table>
          )}
        </div>

        {/* Shipping & Notes */}
        {(order.status === 'qc_complete' || order.status === 'shipped') && (
          <div className="bg-white rounded-xl shadow-sm border p-5">
            <h3 className="font-bold text-gray-800 mb-3">üöö {lang === 'en' ? 'Shipping Details' : 'D√©tails Exp√©dition'}</h3>
            <ShippingEditor order={order} onSave={async (updates) => {
              const { error } = await supabase.from('usa_orders').update(updates).eq('id', order.id);
              if (error) { notify('Erreur: ' + error.message, 'error'); }
              else { notify('‚úÖ Saved!'); setSelectedOrder(prev => ({ ...prev, ...updates })); loadOrders(); }
            }} lang={lang} />
          </div>
        )}

        {/* Notes */}
        <div className="bg-white rounded-xl shadow-sm border p-5">
          <h3 className="font-bold text-gray-800 mb-3">üìù Notes</h3>
          <textarea
            className="w-full border rounded-lg p-3 text-sm"
            rows={3}
            defaultValue={order.notes || ''}
            onBlur={async (e) => {
              if (e.target.value !== (order.notes || '')) {
                await supabase.from('usa_orders').update({ notes: e.target.value }).eq('id', order.id);
                setSelectedOrder(prev => ({ ...prev, notes: e.target.value }));
              }
            }}
            placeholder={lang === 'en' ? 'Add notes...' : 'Ajouter des notes...'}
          />
        </div>
      </div>
    );
  }

  // ---- ORDER LIST VIEW ----
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-gray-800">üá∫üá∏ {lang === 'en' ? 'USA Orders' : 'Commandes USA'}</h1>
        <button
          onClick={() => setShowCreateModal(true)}
          className="px-4 py-2 bg-[#00A651] hover:bg-green-700 text-white rounded-lg font-bold flex items-center gap-2"
        >
          + {lang === 'en' ? 'New Order' : 'Nouvelle Commande'}
        </button>
      </div>

      {/* Status Filter Tabs */}
      <div className="flex flex-wrap gap-2">
        {[
          { id: 'all', label: lang === 'en' ? 'All' : 'Tout', count: counts.all },
          { id: 'order_created', label: lang === 'en' ? 'Ordered' : 'Command√©', count: counts.order_created },
          { id: 'received_france', label: lang === 'en' ? 'Received' : 'Re√ßu', count: counts.received_france },
          { id: 'qc_complete', label: 'QC', count: counts.qc_complete },
          { id: 'shipped', label: lang === 'en' ? 'Shipped' : 'Exp√©di√©', count: counts.shipped }
        ].map(f => (
          <button
            key={f.id}
            onClick={() => setFilter(f.id)}
            className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
              filter === f.id ? 'bg-[#00A651] text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {f.label} ({f.count})
          </button>
        ))}
      </div>

      {/* Search */}
      <input
        type="text"
        value={search}
        onChange={e => setSearch(e.target.value)}
        placeholder={lang === 'en' ? 'üîç Search PO#, quote#, customer...' : 'üîç Rechercher PO#, devis#, client...'}
        className="w-full px-4 py-2 border rounded-lg text-sm"
      />

      {/* Orders List */}
      {loading ? (
        <div className="text-center py-12 text-gray-400">{lang === 'en' ? 'Loading...' : 'Chargement...'}</div>
      ) : filtered.length === 0 ? (
        <div className="text-center py-12 text-gray-400">
          <p className="text-4xl mb-2">üì¶</p>
          <p>{lang === 'en' ? 'No orders found' : 'Aucune commande trouv√©e'}</p>
        </div>
      ) : (
        <div className="space-y-3">
          {filtered.map(order => {
            const sc = statusConfig[order.status] || statusConfig.order_created;
            const items = Array.isArray(order.line_items) ? order.line_items : [];
            const currentStep = getStepIndex(order.status);
            return (
              <div
                key={order.id}
                onClick={() => setSelectedOrder(order)}
                className="bg-white rounded-xl shadow-sm border p-4 hover:shadow-md cursor-pointer transition-shadow"
              >
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <span className="font-bold text-gray-800">{order.po_number || order.quote_number || 'N/A'}</span>
                    <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${sc.bg} ${sc.text}`}>{sc.icon} {sc.label}</span>
                  </div>
                  <div className="text-right text-sm text-gray-500">
                    <span className="font-bold text-[#00A651]">‚Ç¨{(order.total || 0).toFixed(2)}</span>
                    <span className="ml-3">{new Date(order.created_at).toLocaleDateString('fr-FR')}</span>
                  </div>
                </div>

                <div className="flex items-center justify-between">
                  <div className="text-sm text-gray-600">
                    <span className="font-medium">{order.customer_name || (lang === 'en' ? 'No customer' : 'Pas de client')}</span>
                    {items.length > 0 && <span className="ml-2 text-gray-400">‚Ä¢ {items.length} {lang === 'en' ? 'item(s)' : 'article(s)'}</span>}
                  </div>

                  {/* Mini progress */}
                  <div className="flex items-center gap-1">
                    {steps.map((step, i) => (
                      <div key={step.id} className={`w-6 h-1.5 rounded-full ${i <= currentStep ? 'bg-[#00A651]' : 'bg-gray-200'}`} />
                    ))}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Create Order Modal */}
      {showCreateModal && (
        <CreateUSAOrderModal
          onClose={() => setShowCreateModal(false)}
          onSaved={() => { setShowCreateModal(false); loadOrders(); }}
          clients={clients}
          notify={notify}
          profile={profile}
          lang={lang}
        />
      )}
    </div>
  );
}

// Shipping editor sub-component
function ShippingEditor({ order, onSave, lang = 'fr' }) {
  const [carrier, setCarrier] = useState(order.shipping_carrier || '');
  const [tracking, setTracking] = useState(order.tracking_number || '');
  const [address, setAddress] = useState(order.shipping_address || '');

  return (
    <div className="space-y-3">
      <div className="grid grid-cols-2 gap-3">
        <div>
          <label className="text-xs text-gray-500 font-medium">{lang === 'en' ? 'Carrier' : 'Transporteur'}</label>
          <input value={carrier} onChange={e => setCarrier(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm mt-1" placeholder="UPS, DHL, FedEx..." />
        </div>
        <div>
          <label className="text-xs text-gray-500 font-medium">{lang === 'en' ? 'Tracking #' : 'N¬∞ Suivi'}</label>
          <input value={tracking} onChange={e => setTracking(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm mt-1 font-mono" placeholder="1Z..." />
        </div>
      </div>
      <div>
        <label className="text-xs text-gray-500 font-medium">{lang === 'en' ? 'Shipping Address' : 'Adresse de livraison'}</label>
        <textarea value={address} onChange={e => setAddress(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-sm mt-1" rows={2} />
      </div>
      <button
        onClick={() => onSave({ shipping_carrier: carrier, tracking_number: tracking, shipping_address: address })}
        className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium"
      >
        üíæ {lang === 'en' ? 'Save Shipping' : 'Enregistrer'}
      </button>
    </div>
  );
}

// Create USA Order Modal with PDF Upload + OCR
function CreateUSAOrderModal({ onClose, onSaved, clients = [], notify, profile, lang = 'fr' }) {
  const [step, setStep] = useState('input'); // input | review
  const [pdfText, setPdfText] = useState('');
  const [uploading, setUploading] = useState(false);
  const [saving, setSaving] = useState(false);

  // Form state
  const [form, setForm] = useState({
    po_number: '',
    quote_number: '',
    customer_name: '',
    customer_contact: '',
    customer_email: '',
    customer_phone: '',
    customer_address: '',
    notes: ''
  });

  const [lineItems, setLineItems] = useState([
    { part_number: '', description: '', quantity: 1, unit_price: 0, total: 0 }
  ]);

  // Calculate totals
  const subtotal = lineItems.reduce((sum, item) => sum + (item.total || 0), 0);
  const taxRate = 20;
  const taxAmount = subtotal * (taxRate / 100);
  const total = subtotal + taxAmount;

  // Update line item
  const updateItem = (index, field, value) => {
    const newItems = [...lineItems];
    newItems[index] = { ...newItems[index], [field]: value };
    if (field === 'quantity' || field === 'unit_price') {
      newItems[index].total = (parseFloat(newItems[index].quantity) || 0) * (parseFloat(newItems[index].unit_price) || 0);
    }
    setLineItems(newItems);
  };

  const addItem = () => setLineItems([...lineItems, { part_number: '', description: '', quantity: 1, unit_price: 0, total: 0 }]);
  const removeItem = (i) => setLineItems(lineItems.filter((_, idx) => idx !== i));

  // PDF Upload & Extract Text
  const handlePDFUpload = async (file) => {
    if (!file || !file.name.endsWith('.pdf')) {
      notify(lang === 'en' ? 'Please upload a PDF file' : 'Veuillez t√©l√©charger un fichier PDF', 'error');
      return;
    }

    setUploading(true);
    try {
      // Load pdf.js from CDN
      if (!window.pdfjsLib) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }

      // Read PDF
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }

      setPdfText(fullText);

      // Try to auto-extract data from text
      const extracted = parseQuotePDF(fullText);
      if (extracted) {
        setForm(prev => ({
          ...prev,
          ...extracted.form
        }));
        if (extracted.items && extracted.items.length > 0) {
          setLineItems(extracted.items);
        }
        notify(lang === 'en' ? '‚úÖ Data extracted from PDF! Please review.' : '‚úÖ Donn√©es extraites du PDF ! Veuillez v√©rifier.');
      } else {
        notify(lang === 'en' ? 'PDF text extracted. Please fill in details manually.' : 'Texte PDF extrait. Veuillez remplir les d√©tails manuellement.');
      }

      // Upload PDF to storage
      const fileName = `usa-orders/${form.po_number || Date.now()}/${Date.now()}_${file.name}`;
      await supabase.storage.from('documents').upload(fileName, file);
      setForm(prev => ({ ...prev, source_pdf_path: fileName }));

    } catch (err) {
      console.error('PDF extraction error:', err);
      notify((lang === 'en' ? 'PDF extraction failed: ' : 'Erreur extraction PDF: ') + err.message, 'error');
    }
    setUploading(false);
  };

  // Simple PDF text parser for Salesforce quotes
  const parseQuotePDF = (text) => {
    try {
      const result = { form: {}, items: [] };

      // === ORDER / REFERENCE NUMBERS ===
      // Lighthouse format: "Order N¬∞ 4104"
      const orderMatch = text.match(/Order\s+N[¬∞o]\s*(\d+)/i);
      if (orderMatch) result.form.po_number = orderMatch[1].trim();

      // Quote number patterns
      const quoteMatch = text.match(/(?:Quote|Quotation|Devis|QU-|V\.\s*r√©f\.?\s*:)\s*([A-Z0-9-]+)/i);
      if (quoteMatch && quoteMatch[1].trim().length > 1) result.form.quote_number = quoteMatch[1].trim();

      // Customer reference: "Ref. cust : C3018 -C3084"
      const custRefMatch = text.match(/Ref\.?\s*cust\.?\s*:\s*([A-Z0-9][A-Z0-9\s-]*[A-Z0-9])/i);
      if (custRefMatch) result.form.notes = 'Ref. cust: ' + custRefMatch[1].trim();

      // PO / Purchase Order
      const poMatch = text.match(/(?:PO|Purchase Order|P\.O\.?)[\s#:]*([A-Z0-9-]+)/i);
      if (poMatch && !result.form.po_number) result.form.po_number = poMatch[1].trim();

      // === CUSTOMER INFO ===
      // "Invoice and dispatch to:" followed by customer info
      const dispatchMatch = text.match(/(?:Invoice and dispatch to|Ship To|Bill To|Dispatch to)\s*:\s*(.+?)(?:T√©l|Tel|SIRET|Page)/is);
      if (dispatchMatch) {
        const dispatchText = dispatchMatch[1].trim();
        // Try to extract name from dispatch section
        const nameMatch = dispatchText.match(/^([A-Za-z√Ä-√ø\s'-]+?)(?:\d|$)/);
        if (nameMatch) result.form.customer_contact = nameMatch[1].trim();
      }

      // Contact name: look for name pattern before "Invoice and dispatch"
      const contactMatch = text.match(/(\d{2}\/\d{2}\/\d{4})\s+([A-Za-z√Ä-√ø]+\s+[A-Za-z√Ä-√ø]+)\s+(?:Invoice|Facture)/i);
      if (contactMatch) result.form.customer_contact = contactMatch[2].trim();

      // Company name patterns
      const companyPatterns = [
        /(?:Bill To|Ship To|Customer|Client|Sold To)[\s:]*\n?\s*([A-Z][A-Za-z√Ä-√ø\s&.,'-]+)/i,
        /(?:Company|Soci√©t√©|Organisation)[\s:]*([A-Z][A-Za-z√Ä-√ø\s&.,'-]+)/i
      ];
      for (const pattern of companyPatterns) {
        const m = text.match(pattern);
        if (m) { result.form.customer_name = m[1].trim(); break; }
      }

      // Email (skip lighthouse internal emails)
      const emails = text.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g) || [];
      const customerEmail = emails.find(e => !e.includes('golighthouse') && !e.includes('lighthouse'));
      if (customerEmail) result.form.customer_email = customerEmail;

      // Phone: look for customer phone (not Lighthouse's own number)
      const phoneMatch = text.match(/(?:T√©l|Tel|Phone)[\s.:]*([+0-9\s()-]{8,})/i);
      if (phoneMatch) result.form.customer_phone = phoneMatch[1].trim();

      // === LINE ITEMS ===
      // Lighthouse Salesforce format: "$ QTY DESCRIPTION UNIT_PRICE $ TOTAL PART_NUMBER"
      // Example: "$ 1  Gas Sampler Valve Stem - AC 100  33,99  $  33,99  211317177-1"
      const itemPattern = /\$\s*(\d+)\s+(.+?)\s+(\d+[.,]\d{2})\s+\$\s+(\d+[.,]\d{2})\s+(\d{5,}-\d+)/g;
      let match;
      while ((match = itemPattern.exec(text)) !== null) {
        const qty = parseInt(match[1]) || 1;
        const desc = match[2].trim();
        const unitPrice = parseFloat(match[3].replace(',', '.')) || 0;
        const totalPrice = parseFloat(match[4].replace(',', '.')) || 0;
        const partNum = match[5].trim();

        result.items.push({
          part_number: partNum,
          description: desc,
          quantity: qty,
          unit_price: unitPrice,
          total: totalPrice
        });
      }

      // Fallback: try generic line item pattern if Lighthouse format didn't match
      if (result.items.length === 0) {
        const genericPattern = /([A-Z0-9]{2,}[-][A-Z0-9-]+)\s+(.+?)\s+(\d+)\s+[\$‚Ç¨¬£]?([\d,]+\.?\d*)\s+[\$‚Ç¨¬£]?([\d,]+\.?\d*)/g;
        while ((match = genericPattern.exec(text)) !== null) {
          result.items.push({
            part_number: match[1],
            description: match[2].trim(),
            quantity: parseInt(match[3]) || 1,
            unit_price: parseFloat(match[4].replace(',', '.')) || 0,
            total: parseFloat(match[5].replace(',', '.')) || 0
          });
        }
      }

      return (result.form.po_number || result.form.quote_number || result.form.customer_name || result.form.customer_contact || result.items.length > 0) ? result : null;
    } catch {
      return null;
    }
  };

  // Save order
  const saveOrder = async () => {
    if (!form.customer_name && !form.po_number) {
      notify(lang === 'en' ? 'Please enter a customer name or PO number' : 'Veuillez entrer un nom de client ou un num√©ro PO', 'error');
      return;
    }

    setSaving(true);
    try {
      const validItems = lineItems.filter(item => item.part_number || item.description);

      const orderData = {
        ...form,
        line_items: validItems,
        subtotal: subtotal,
        tax_rate: taxRate,
        tax_amount: taxAmount,
        total: total,
        status: 'order_created',
        order_created_at: new Date().toISOString(),
        created_by: profile?.id
      };

      // Try to link to existing client
      if (form.customer_name) {
        const matchedClient = clients.find(c =>
          c.company_name?.toLowerCase().includes(form.customer_name.toLowerCase()) ||
          form.customer_name.toLowerCase().includes(c.company_name?.toLowerCase() || '')
        );
        if (matchedClient) orderData.client_id = matchedClient.id;
      }

      const { error } = await supabase.from('usa_orders').insert(orderData);
      if (error) throw error;

      notify(lang === 'en' ? '‚úÖ Order created!' : '‚úÖ Commande cr√©√©e !');
      onSaved();
    } catch (err) {
      notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error');
    }
    setSaving(false);
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="p-4 border-b bg-blue-50 flex items-center justify-between">
          <h3 className="text-lg font-bold text-gray-800">üá∫üá∏ {lang === 'en' ? 'New USA Order' : 'Nouvelle Commande USA'}</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <div className="flex-1 overflow-y-auto p-5 space-y-5">
          {/* PDF Upload Section */}
          <div className="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center bg-gray-50">
            <p className="text-gray-600 mb-3">{lang === 'en' ? 'üìÑ Upload Salesforce Quote/PO PDF to auto-extract data' : 'üìÑ T√©l√©charger le PDF Devis/PO Salesforce pour extraction automatique'}</p>
            <label className="inline-block px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium cursor-pointer">
              {uploading ? '‚è≥ Extracting...' : (lang === 'en' ? 'üì§ Upload PDF' : 'üì§ T√©l√©charger PDF')}
              <input
                type="file"
                accept=".pdf"
                className="hidden"
                disabled={uploading}
                onChange={e => e.target.files[0] && handlePDFUpload(e.target.files[0])}
              />
            </label>
            {pdfText && (
              <details className="mt-3 text-left">
                <summary className="text-sm text-gray-500 cursor-pointer">{lang === 'en' ? 'View extracted text' : 'Voir le texte extrait'}</summary>
                <pre className="mt-2 p-3 bg-white border rounded text-xs max-h-40 overflow-y-auto whitespace-pre-wrap">{pdfText}</pre>
              </details>
            )}
          </div>

          {/* Customer Info */}
          <div>
            <h4 className="font-bold text-gray-700 mb-2">{lang === 'en' ? 'üë§ Customer Info' : 'üë§ Info Client'}</h4>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-gray-500">{lang === 'en' ? 'Company' : 'Soci√©t√©'} *</label>
                <input value={form.customer_name} onChange={e => setForm({ ...form, customer_name: e.target.value })} className="w-full border rounded-lg px-3 py-2 text-sm mt-1" />
              </div>
              <div>
                <label className="text-xs text-gray-500">Contact</label>
                <input value={form.customer_contact} onChange={e => setForm({ ...form, customer_contact: e.target.value })} className="w-full border rounded-lg px-3 py-2 text-sm mt-1" />
              </div>
              <div>
                <label className="text-xs text-gray-500">Email</label>
                <input value={form.customer_email} onChange={e => setForm({ ...form, customer_email: e.target.value })} className="w-full border rounded-lg px-3 py-2 text-sm mt-1" />
              </div>
              <div>
                <label className="text-xs text-gray-500">{lang === 'en' ? 'Phone' : 'T√©l.'}</label>
                <input value={form.customer_phone} onChange={e => setForm({ ...form, customer_phone: e.target.value })} className="w-full border rounded-lg px-3 py-2 text-sm mt-1" />
              </div>
              <div className="col-span-2">
                <label className="text-xs text-gray-500">{lang === 'en' ? 'Address' : 'Adresse'}</label>
                <input value={form.customer_address} onChange={e => setForm({ ...form, customer_address: e.target.value })} className="w-full border rounded-lg px-3 py-2 text-sm mt-1" />
              </div>
            </div>
          </div>

          {/* Order Reference */}
          <div>
            <h4 className="font-bold text-gray-700 mb-2">{lang === 'en' ? 'üìã Order Reference' : 'üìã R√©f√©rence Commande'}</h4>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-gray-500">PO #</label>
                <input value={form.po_number} onChange={e => setForm({ ...form, po_number: e.target.value })} className="w-full border rounded-lg px-3 py-2 text-sm mt-1 font-mono" />
              </div>
              <div>
                <label className="text-xs text-gray-500">{lang === 'en' ? 'Quote #' : 'Devis #'}</label>
                <input value={form.quote_number} onChange={e => setForm({ ...form, quote_number: e.target.value })} className="w-full border rounded-lg px-3 py-2 text-sm mt-1 font-mono" />
              </div>
            </div>
          </div>

          {/* Line Items */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <h4 className="font-bold text-gray-700">{lang === 'en' ? 'üì¶ Line Items' : 'üì¶ Articles'}</h4>
              <button onClick={addItem} className="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm font-medium">+ {lang === 'en' ? 'Add Item' : 'Ajouter'}</button>
            </div>
            <div className="space-y-2">
              {lineItems.map((item, i) => (
                <div key={i} className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg">
                  <input
                    value={item.part_number}
                    onChange={e => updateItem(i, 'part_number', e.target.value)}
                    placeholder={lang === 'en' ? 'Part #' : 'R√©f.'}
                    className="w-32 border rounded px-2 py-1.5 text-sm font-mono"
                  />
                  <input
                    value={item.description}
                    onChange={e => updateItem(i, 'description', e.target.value)}
                    placeholder="Description"
                    className="flex-1 border rounded px-2 py-1.5 text-sm"
                  />
                  <input
                    type="number"
                    value={item.quantity}
                    onChange={e => updateItem(i, 'quantity', parseInt(e.target.value) || 0)}
                    className="w-16 border rounded px-2 py-1.5 text-sm text-center"
                    min="1"
                  />
                  <input
                    type="number"
                    value={item.unit_price}
                    onChange={e => updateItem(i, 'unit_price', parseFloat(e.target.value) || 0)}
                    className="w-24 border rounded px-2 py-1.5 text-sm text-right"
                    step="0.01"
                    placeholder="‚Ç¨"
                  />
                  <span className="w-24 text-right text-sm font-medium">‚Ç¨{(item.total || 0).toFixed(2)}</span>
                  {lineItems.length > 1 && (
                    <button onClick={() => removeItem(i)} className="text-red-400 hover:text-red-600 text-lg px-1">&times;</button>
                  )}
                </div>
              ))}
            </div>

            {/* Totals */}
            <div className="mt-3 border-t pt-3 text-right space-y-1">
              <p className="text-sm text-gray-500">{lang === 'en' ? 'Subtotal' : 'Sous-total'}: <span className="font-medium text-gray-800">‚Ç¨{subtotal.toFixed(2)}</span></p>
              <p className="text-sm text-gray-500">TVA ({taxRate}%): <span className="font-medium text-gray-800">‚Ç¨{taxAmount.toFixed(2)}</span></p>
              <p className="text-lg font-bold text-[#00A651]">Total: ‚Ç¨{total.toFixed(2)}</p>
            </div>
          </div>

          {/* Notes */}
          <div>
            <label className="text-xs text-gray-500 font-medium">Notes</label>
            <textarea
              value={form.notes}
              onChange={e => setForm({ ...form, notes: e.target.value })}
              className="w-full border rounded-lg px-3 py-2 text-sm mt-1"
              rows={2}
              placeholder={lang === 'en' ? 'Optional notes...' : 'Notes optionnelles...'}
            />
          </div>
        </div>

        {/* Footer */}
        <div className="p-4 border-t bg-gray-50 flex items-center justify-between">
          <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium">
            {lang === 'en' ? 'Cancel' : 'Annuler'}
          </button>
          <button
            onClick={saveOrder}
            disabled={saving}
            className="px-6 py-2 bg-[#00A651] hover:bg-green-700 text-white rounded-lg font-bold disabled:opacity-50 flex items-center gap-2"
          >
            {saving ? '‚è≥...' : '‚úÖ'} {lang === 'en' ? 'Create Order' : 'Cr√©er la Commande'}
          </button>
        </div>
      </div>
    </div>
  );
}

function RentalsSheet({ rentals = [], clients, notify, reload, profile, businessSettings, t = k=>k, lang = 'fr' }) {
  const [activeTab, setActiveTab] = useState('requests'); // 'requests', 'inventory', 'bundles', 'calendar'
  const [fullPageRental, setFullPageRental] = useState(null);
  const [quoteRental, setQuoteRental] = useState(null);
  const [inventory, setInventory] = useState([]);
  const [bundles, setBundles] = useState([]);
  const [bookings, setBookings] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showAddDevice, setShowAddDevice] = useState(false);
  const [showAddBundle, setShowAddBundle] = useState(false);
  const [editingDevice, setEditingDevice] = useState(null);
  const [editingBundle, setEditingBundle] = useState(null);
  const [reviewingRentalBC, setReviewingRentalBC] = useState(null);

  // Keep fullPageRental and quoteRental in sync with reloaded data
  useEffect(() => {
    if (fullPageRental) {
      const updated = rentals.find(r => r.id === fullPageRental.id);
      if (updated) setFullPageRental(updated);
    }
    if (quoteRental) {
      const updated = rentals.find(r => r.id === quoteRental.id);
      if (updated) setQuoteRental(updated);
    }
  }, [rentals]);

  useEffect(() => {
    const loadInventory = async () => {
      setLoading(true);
      const { data: inv, error: invErr } = await supabase.from('rental_inventory').select('*').order('model_name');
      const { data: bun, error: bunErr } = await supabase.from('rental_bundles').select('*, rental_bundle_items(*, rental_inventory(*))').order('bundle_name');
      const { data: book, error: bookErr } = await supabase.from('rental_bookings').select('*, rental_requests(rental_number, companies(name))').order('start_date', { ascending: false });
      console.log('Rental inventory load:', { inv, invErr, bun, bunErr, book, bookErr });
      if (inv) setInventory(inv);
      if (bun) setBundles(bun);
      if (book) setBookings(book);
      setLoading(false);
    };
    loadInventory();
  }, []);

  useEffect(() => {
    console.log('RentalsSheet received rentals:', rentals);
  }, [rentals]);

  // Full page view - like Parts Orders
  if (fullPageRental) {
    return (
      <RentalFullPage
        rental={fullPageRental}
        inventory={inventory}
        onBack={() => setFullPageRental(null)}
        notify={notify}
        reload={reload}
        businessSettings={businessSettings}
        profile={profile}
        onOpenQuoteEditor={(r) => { setFullPageRental(null); setQuoteRental(r); }}
        lang={lang}
      />
    );
  }

  // Quote editor - separate full page
  if (quoteRental) {
    return (
      <RentalQuoteEditor
        rental={quoteRental}
        inventory={inventory}
        profile={profile}
        businessSettings={businessSettings}
        notify={notify}
        reload={reload}
        onBack={() => { setQuoteRental(null); setFullPageRental(quoteRental); }}
        lang={lang}
      />
    );
  }

  const getStatusStyle = (status) => {
    const styles = {
      requested: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'New request' : 'Nouvelle demande' },
      pending_quote_review: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'Quote Under Review' : 'Devis en v√©rification' },
      quote_sent: { bg: 'bg-blue-100', text: 'text-blue-700', label: lang === 'en' ? 'Quote Sent' : 'Devis envoy√©' },
      waiting_bc: { bg: 'bg-amber-100', text: 'text-amber-700', label: lang === 'en' ? 'Awaiting PO' : 'Attente BC' },
      bc_review: { bg: 'bg-orange-100', text: 'text-orange-700', label: lang === 'en' ? '‚ö†Ô∏è PO to review' : '‚ö†Ô∏è BC √† v√©rifier' },
      bc_approved: { bg: 'bg-green-100', text: 'text-green-700', label: lang === 'en' ? 'PO approved' : 'BC approuv√©' },
      shipped: { bg: 'bg-cyan-100', text: 'text-cyan-700', label: t('stShipped') },
      in_rental: { bg: 'bg-purple-100', text: 'text-purple-700', label: lang === 'en' ? 'On rental' : 'En location' },
      return_pending: { bg: 'bg-orange-100', text: 'text-orange-700', label: lang === 'en' ? 'Return expected' : 'Retour attendu' },
      returned: { bg: 'bg-teal-100', text: 'text-teal-700', label: lang === 'en' ? 'Returned' : 'Retourn√©' },
      completed: { bg: 'bg-green-100', text: 'text-green-700', label: lang === 'en' ? 'Completed' : 'Termin√©' },
      cancelled: { bg: 'bg-red-100', text: 'text-red-700', label: lang === 'en' ? 'Cancelled' : 'Annul√©' }
    };
    return styles[status] || { bg: 'bg-gray-100', text: 'text-gray-700', label: status };
  };

  const pendingRequests = rentals.filter(r => ['requested', 'pending_quote_review'].includes(r.status));
  const bcReviewRequests = rentals.filter(r => r.status === 'bc_review');
  const activeRentals = rentals.filter(r => ['bc_approved', 'shipped', 'in_rental', 'return_pending'].includes(r.status));
  const overdueRentals = rentals.filter(r => r.status === 'in_rental' && new Date(r.end_date) < new Date());

  // Save device
  const saveDevice = async (deviceData) => {
    try {
      if (editingDevice) {
        await supabase.from('rental_inventory').update(deviceData).eq('id', editingDevice.id);
        notify(lang === 'en' ? 'Device updated!' : 'Appareil mis √† jour!');
      } else {
        await supabase.from('rental_inventory').insert(deviceData);
        notify(lang === 'en' ? 'Device added!' : 'Appareil ajout√©!');
      }
      const { data } = await supabase.from('rental_inventory').select('*').order('model_name');
      if (data) setInventory(data);
      setShowAddDevice(false);
      setEditingDevice(null);
    } catch (err) { notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error'); }
  };

  // Delete device
  const deleteDevice = async (id) => {
    if (!confirm(lang === 'en' ? 'Delete this device?' : 'Supprimer cet appareil?')) return;
    try {
      await supabase.from('rental_inventory').delete().eq('id', id);
      setInventory(inventory.filter(d => d.id !== id));
      notify(lang === 'en' ? 'Device deleted' : 'Appareil supprim√©');
    } catch (err) { notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error'); }
  };

  // Save bundle
  const saveBundle = async (bundleData, deviceIds) => {
    try {
      let bundleId;
      if (editingBundle) {
        await supabase.from('rental_bundles').update(bundleData).eq('id', editingBundle.id);
        bundleId = editingBundle.id;
        await supabase.from('rental_bundle_items').delete().eq('bundle_id', bundleId);
      } else {
        const { data } = await supabase.from('rental_bundles').insert(bundleData).select().single();
        bundleId = data.id;
      }
      for (const invId of deviceIds) {
        await supabase.from('rental_bundle_items').insert({ bundle_id: bundleId, inventory_id: invId });
      }
      notify(editingBundle ? 'Kit mis √† jour!' : (lang === 'en' ? 'Kit created!' : 'Kit cr√©√©!'));
      const { data: bun } = await supabase.from('rental_bundles').select('*, rental_bundle_items(*, rental_inventory(*))').order('bundle_name');
      if (bun) setBundles(bun);
      setShowAddBundle(false);
      setEditingBundle(null);
    } catch (err) { notify((lang === 'en' ? 'Error: ' : 'Erreur: ') + err.message, 'error'); }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">{lang === 'en' ? 'Rentals' : 'Locations'}</h1>
        <div className="flex gap-2">
          <button onClick={() => setShowAddDevice(true)} className="px-4 py-2 bg-[#8B5CF6] text-white rounded-lg font-medium hover:bg-[#7C3AED]">{lang === 'en' ? '+ Add Device' : '+ Ajouter Appareil'}</button>
          <button onClick={() => setShowAddBundle(true)} className="px-4 py-2 bg-[#8B5CF6]/80 text-white rounded-lg font-medium hover:bg-[#7C3AED]">{lang === 'en' ? '+ Create Kit' : '+ Cr√©er Kit'}</button>
        </div>
      </div>

      {/* Overdue Alert */}
      {overdueRentals.length > 0 && (
        <div className="bg-red-50 border-2 border-red-300 rounded-xl p-4 flex items-center gap-4">
          <span className="text-3xl">üö®</span>
          <div className="flex-1">
            <p className="font-bold text-red-800">{overdueRentals.length} location{overdueRentals.length > 1 ? 's' : ''} en retard de restitution</p>
            <div className="flex flex-wrap gap-2 mt-1">
              {overdueRentals.map(r => {
                const overdueDays = Math.ceil((new Date() - new Date(r.end_date)) / (1000*60*60*24));
                return (
                  <button key={r.id} onClick={() => setFullPageRental(r)} className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full hover:bg-red-200 font-medium">
                    {r.rental_number} ‚Äî {r.companies?.name} ({overdueDays}j de retard)
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      )}

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-6 gap-3">
        <div className="bg-white rounded-xl p-4 shadow-sm border cursor-pointer hover:border-amber-300" onClick={() => setActiveTab('requests')}><p className="text-3xl font-bold text-amber-600">{pendingRequests.length}</p><p className="text-gray-500 text-sm">{lang === 'en' ? 'New requests' : 'Nouvelles demandes'}</p></div>
        <div className="bg-white rounded-xl p-4 shadow-sm border cursor-pointer hover:border-orange-300" onClick={() => setActiveTab('requests')}><p className="text-3xl font-bold text-orange-600">{bcReviewRequests.length}</p><p className="text-gray-500 text-sm">{lang === 'en' ? 'PO to review' : 'BC √† v√©rifier'}</p></div>
        <div className="bg-white rounded-xl p-4 shadow-sm border cursor-pointer hover:border-cyan-300" onClick={() => setActiveTab('requests')}><p className="text-3xl font-bold text-cyan-600">{rentals.filter(r => r.status === 'bc_approved').length}</p><p className="text-gray-500 text-sm">{lang === 'en' ? 'Ready to ship' : '√Ä exp√©dier'}</p></div>
        <div className="bg-white rounded-xl p-4 shadow-sm border cursor-pointer hover:border-purple-300" onClick={() => setActiveTab('requests')}><p className="text-3xl font-bold text-purple-600">{activeRentals.length}</p><p className="text-gray-500 text-sm">{lang === 'en' ? 'Active rentals' : 'Locations actives'}</p></div>
        <div className="bg-white rounded-xl p-4 shadow-sm border cursor-pointer hover:border-teal-300" onClick={() => setActiveTab('requests')}><p className="text-3xl font-bold text-teal-600">{rentals.filter(r => r.status === 'return_pending').length}</p><p className="text-gray-500 text-sm">{lang === 'en' ? 'Returns pending' : 'Retours attendus'}</p></div>
        <div className="bg-white rounded-xl p-4 shadow-sm border"><p className="text-3xl font-bold text-[#8B5CF6]">{inventory.length}</p><p className="text-gray-500 text-sm">{lang === 'en' ? 'Equipment fleet' : 'Appareils en parc'}</p></div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b">
        {[
          { id: 'requests', label: lang === 'en' ? 'Requests' : 'Demandes', badge: pendingRequests.length + bcReviewRequests.length },
          { id: 'inventory', label: lang === 'en' ? 'Inventory' : 'Inventaire', badge: inventory.length },
          { id: 'bundles', label: lang === 'en' ? 'Kits' : 'Kits', badge: bundles.length },
          { id: 'calendar', label: lang === 'en' ? 'Calendar' : 'Calendrier' }
        ].map(tab => (
          <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-4 py-2 font-medium border-b-2 -mb-px transition-colors ${activeTab === tab.id ? 'border-[#8B5CF6] text-[#8B5CF6]' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
            {tab.label} {tab.badge > 0 && <span className="ml-1 px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full">{tab.badge}</span>}
          </button>
        ))}
      </div>

      {/* Requests Tab */}
      {activeTab === 'requests' && (() => {
        const needsBCReview = rentals.filter(r => r.status === 'bc_review');
        return needsBCReview.length > 0 ? (
        <div className="bg-red-50 border-2 border-red-300 rounded-xl shadow-lg mb-4">
          <div className="px-6 py-4 border-b border-red-200 bg-red-100 rounded-t-xl">
            <h2 className="font-bold text-red-800 text-lg">‚ö†Ô∏è {lang === 'en' ? 'Purchase Orders to Review' : 'Bons de Commande √† V√©rifier'} ({needsBCReview.length})</h2>
            <p className="text-sm text-red-600">{lang === 'en' ? 'Click "Review" to verify the document and approve' : 'Cliquez sur "Examiner" pour v√©rifier le document et approuver'}</p>
          </div>
          <div className="p-4 space-y-3">
            {needsBCReview.map(rental => (
              <div key={rental.id} className="bg-white rounded-lg p-4 flex items-center justify-between shadow-sm border border-red-100">
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center text-2xl">üìÑ</div>
                  <div>
                    <span className="font-mono font-bold text-[#8B5CF6] text-lg">{rental.rental_number}</span>
                    <p className="font-medium text-gray-800">{rental.companies?.name}</p>
                    <p className="text-sm text-gray-500">
                      BC soumis le {rental.bc_submitted_at ? new Date(rental.bc_submitted_at).toLocaleDateString('fr-FR') : new Date(rental.updated_at).toLocaleDateString('fr-FR')}
                      {rental.bc_signed_by && <span className="ml-2">‚Ä¢ Sign√© par: {rental.bc_signed_by}</span>}
                    </p>
                  </div>
                </div>
                <button onClick={() => setReviewingRentalBC(rental)} className="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium flex items-center gap-2">üîç Examiner</button>
              </div>
            ))}
          </div>
        </div>
        ) : null;
      })()}

      {activeTab === 'requests' && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase">{lang === 'en' ? 'Rental #' : 'N¬∞ Location'}</th>
                <th className="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase">{t('client')}</th>
                <th className="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase">{lang === 'en' ? 'Period' : 'P√©riode'}</th>
                <th className="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase">{lang === 'en' ? 'Equipment' : '√âquipement'}</th>
                <th className="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase">{lang === 'en' ? 'Tracking' : 'Suivi'}</th>
                <th className="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase">{t('status')}</th>
                <th className="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase">{t('actions')}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {rentals.length === 0 ? (
                <tr><td colSpan={7} className="px-4 py-8 text-center text-gray-400">{lang === 'en' ? 'No rental requests' : 'Aucune demande de location'}</td></tr>
              ) : rentals.map(rental => {
                const style = getStatusStyle(rental.status);
                const days = Math.ceil((new Date(rental.end_date) - new Date(rental.start_date)) / (1000*60*60*24)) + 1;
                const isOverdue = rental.status === 'in_rental' && new Date(rental.end_date) < new Date();
                const daysUntilEnd = rental.status === 'in_rental' ? Math.ceil((new Date(rental.end_date) - new Date()) / (1000*60*60*24)) : null;
                // Progress mini-bar
                const stepMap = { 'requested': 0, 'pending_quote_review': 1, 'quote_sent': 1, 'waiting_bc': 2, 'bc_review': 2, 'bc_approved': 2, 'shipped': 3, 'in_rental': 4, 'return_pending': 5, 'returned': 5, 'completed': 6 };
                const progress = stepMap[rental.status] ?? 0;
                const totalSteps = 6;
                return (
                  <tr key={rental.id} className={`hover:bg-gray-50 cursor-pointer ${isOverdue ? 'bg-red-50' : ''}`} onClick={() => setFullPageRental(rental)}>
                    <td className="px-3 py-3">
                      <span className="font-bold text-[#8B5CF6] cursor-pointer hover:underline" onClick={() => setFullPageRental(rental)}>{rental.rental_number}</span>
                      <p className="text-xs text-gray-400">{new Date(rental.created_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR')}</p>
                      {/* Mini progress bar */}
                      <div className="flex gap-0.5 mt-1">
                        {Array.from({ length: totalSteps }).map((_, i) => (
                          <div key={i} className={`h-1 flex-1 rounded-full ${i < progress ? 'bg-[#8B5CF6]' : i === progress ? 'bg-[#8B5CF6]/50' : 'bg-gray-200'}`} />
                        ))}
                      </div>
                    </td>
                    <td className="px-3 py-3">
                      <span className="font-medium text-sm">{rental.companies?.name}</span>
                      {rental.shipping_address && <p className="text-xs text-gray-400 truncate max-w-[120px]">{rental.shipping_address.city || rental.shipping_address.address_line1}</p>}
                    </td>
                    <td className="px-3 py-3">
                      <span className="text-sm">{new Date(rental.start_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR', { day: '2-digit', month: 'short' })} ‚Üí {new Date(rental.end_date).toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR', { day: '2-digit', month: 'short' })}</span>
                      <p className="text-xs text-gray-400">{days}j</p>
                      {isOverdue && <p className="text-xs text-red-600 font-bold">‚ö†Ô∏è {lang === 'en' ? 'OVERDUE' : 'EN RETARD'}</p>}
                      {daysUntilEnd !== null && !isOverdue && daysUntilEnd <= 3 && <p className="text-xs text-orange-600">‚è∞ {daysUntilEnd}j restants</p>}
                    </td>
                    <td className="px-3 py-3">
                      <span className="text-sm">{rental.rental_request_items?.length || 0} {lang === 'en' ? 'device(s)' : 'appareil(s)'}</span>
                      {rental.rental_request_items?.slice(0, 2).map((item, i) => (
                        <p key={i} className="text-xs text-gray-400 truncate max-w-[130px]">{item.item_name}{item.serial_number ? ` (${item.serial_number})` : ''}</p>
                      ))}
                      {(rental.rental_request_items?.length || 0) > 2 && <p className="text-xs text-gray-300">+{rental.rental_request_items.length - 2} de plus</p>}
                    </td>
                    <td className="px-3 py-3">
                      {(rental.quote_data?.outbound_tracking || rental.outbound_tracking) ? (
                        <div>
                          <a href={'https://www.ups.com/track?tracknum=' + (rental.quote_data?.outbound_tracking || rental.outbound_tracking)} target="_blank" rel="noopener noreferrer" className="text-xs font-mono text-blue-600 hover:underline block truncate max-w-[120px]" title={(rental.quote_data?.outbound_tracking || rental.outbound_tracking)}>üì¶ {(rental.quote_data?.outbound_tracking || rental.outbound_tracking)}</a>
                          {(rental.quote_data?.bl_number || rental.bl_number) && <p className="text-xs text-cyan-600 font-mono">üìã {(rental.quote_data?.bl_number || rental.bl_number)}</p>}
                          {(rental.quote_data?.outbound_shipped_at || rental.outbound_shipped_at) && <p className="text-xs text-gray-400">{new Date((rental.quote_data?.outbound_shipped_at || rental.outbound_shipped_at)).toLocaleDateString('fr-FR')}</p>}
                        </div>
                      ) : rental.status === 'bc_approved' ? (
                        <span className="text-xs text-green-600 font-medium">üü¢ {lang === 'en' ? 'Ready to ship' : 'Pr√™t √† exp√©dier'}</span>
                      ) : ['requested', 'pending_quote_review', 'quote_sent', 'waiting_bc', 'bc_review'].includes(rental.status) ? (
                        <span className="text-xs text-gray-400">‚Äî</span>
                      ) : null}
                      {(rental.quote_data?.return_tracking || rental.return_tracking) && <p className="text-xs text-teal-600 font-mono mt-1">‚Ü©Ô∏è {(rental.quote_data?.return_tracking || rental.return_tracking)}</p>}
                      {(rental.quote_data?.returned_at || rental.returned_at) && <p className="text-xs text-teal-600">üì• Retour {new Date((rental.quote_data?.returned_at || rental.returned_at)).toLocaleDateString('fr-FR')}</p>}
                    </td>
                    <td className="px-3 py-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${style.bg} ${style.text}`}>{lang === 'en' && style.en ? style.en : style.label}</span>
                      {rental.quote_rejection_notes && rental.status === 'requested' && (
                        <p className="text-xs text-amber-600 mt-1 truncate max-w-[120px]" title={rental.quote_rejection_notes}>‚úèÔ∏è Correction</p>
                      )}
                      {rental.quote_revision_notes && rental.status === 'requested' && (
                        <p className="text-xs text-orange-600 mt-1 truncate max-w-[120px]" title={rental.quote_revision_notes}>üîÑ R√©vision client</p>
                      )}
                      {(rental.quote_data?.return_condition || rental.return_condition) === 'damaged' && <p className="text-xs text-red-600 mt-1">‚ö†Ô∏è Endommag√©</p>}
                      {(rental.quote_data?.return_condition || rental.return_condition) === 'missing_items' && <p className="text-xs text-orange-600 mt-1">‚ùì Manquant</p>}
                    </td>
                    <td className="px-3 py-3" onClick={e => e.stopPropagation()}>
                      {rental.status === 'bc_review' ? (
                        <button onClick={() => setReviewingRentalBC(rental)} className="px-3 py-1.5 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 font-medium">üîç Examiner BC</button>
                      ) : (
                        <button onClick={() => setFullPageRental(rental)} className="px-3 py-1.5 bg-[#8B5CF6] text-white text-sm rounded-lg hover:bg-[#7C3AED] font-medium">{lang === 'en' ? 'Manage' : 'G√©rer'}</button>
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}

      {/* Inventory Tab */}
      {activeTab === 'inventory' && (
        <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('model')}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('serialNumber')}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Price/Day' : 'Prix/Jour'}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Price/Week' : 'Prix/Semaine'}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Price/Month' : 'Prix/Mois'}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{lang === 'en' ? 'Retail Value' : 'Valeur neuf'}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('status')}</th>
                <th className="px-4 py-3 text-left text-sm font-bold text-gray-600">{t('actions')}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {inventory.length === 0 ? (
                <tr><td colSpan={8} className="px-4 py-8 text-center text-gray-400">{lang === 'en' ? "No devices in rental inventory" : "Aucun appareil dans l'inventaire de location"}</td></tr>
              ) : inventory.map(device => (
                <tr key={device.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3"><span className="font-medium">{device.model_name}</span><p className="text-xs text-gray-400">{device.device_type}</p></td>
                  <td className="px-4 py-3"><span className="font-mono text-sm">{device.serial_number}</span></td>
                  <td className="px-4 py-3"><span className="font-medium">‚Ç¨{device.price_per_day}</span></td>
                  <td className="px-4 py-3">{device.price_per_week ? `‚Ç¨${device.price_per_week}` : <span className="text-gray-400">‚Äî</span>}</td>
                  <td className="px-4 py-3">{device.price_per_month ? `‚Ç¨${device.price_per_month}` : <span className="text-gray-400">‚Äî</span>}</td>
                  <td className="px-4 py-3">{device.retail_value ? <span className="font-medium">‚Ç¨{parseFloat(device.retail_value).toLocaleString()}</span> : <span className="text-gray-400">‚Äî</span>}</td>
                  <td className="px-4 py-3">{device.is_available ? <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">{lang === 'en' ? 'Available' : 'Disponible'}</span> : <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full">{lang === 'en' ? 'Unavailable' : 'Indisponible'}</span>}</td>
                  <td className="px-4 py-3 flex gap-2">
                    <button onClick={() => { setEditingDevice(device); setShowAddDevice(true); }} className="px-2 py-1 bg-gray-100 text-gray-600 text-sm rounded hover:bg-gray-200">‚úèÔ∏è</button>
                    <button onClick={() => deleteDevice(device.id)} className="px-2 py-1 bg-red-100 text-red-600 text-sm rounded hover:bg-red-200">üóëÔ∏è</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Bundles Tab */}
      {activeTab === 'bundles' && (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {bundles.length === 0 ? (
            <div className="col-span-full bg-white rounded-xl p-8 text-center text-gray-400">{lang === 'en' ? 'No kits created' : 'Aucun kit cr√©√©'}</div>
          ) : bundles.map(bundle => (
            <div key={bundle.id} className="bg-white rounded-xl p-6 shadow-sm border">
              <div className="flex justify-between items-start mb-4">
                <div><h3 className="font-bold text-gray-800">{bundle.bundle_name}</h3><p className="text-sm text-gray-500">{bundle.bundle_code}</p></div>
                <div className="flex gap-1">
                  <button onClick={() => { setEditingBundle(bundle); setShowAddBundle(true); }} className="p-1 hover:bg-gray-100 rounded">‚úèÔ∏è</button>
                </div>
              </div>
              <p className="text-sm text-gray-600 mb-4">{bundle.description_fr || bundle.description || '‚Äî'}</p>
              <div className="text-xs text-gray-400 mb-4">Contient: {bundle.rental_bundle_items?.map(bi => bi.rental_inventory?.model_name).join(', ')}</div>
              <div className="flex justify-between items-end">
                <div><p className="text-2xl font-bold text-[#8B5CF6]">‚Ç¨{bundle.price_per_day}</p><p className="text-xs text-gray-500">{lang === 'en' ? '/day' : '/jour'}</p></div>
                {bundle.is_active ? <span className="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">{lang === 'en' ? 'Active' : 'Actif'}</span> : <span className="px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded-full">{lang === 'en' ? 'Inactive' : 'Inactif'}</span>}
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Calendar Tab */}
      {activeTab === 'calendar' && <RentalCalendarView bookings={bookings} inventory={inventory} lang={lang} />}

      {/* Add/Edit Device Modal */}
      {showAddDevice && <RentalDeviceModal device={editingDevice} onSave={saveDevice} onClose={() => { setShowAddDevice(false); setEditingDevice(null); }} lang={lang} />}

      {/* Add/Edit Bundle Modal */}
      {showAddBundle && <RentalBundleModal bundle={editingBundle} inventory={inventory} onSave={saveBundle} onClose={() => { setShowAddBundle(false); setEditingBundle(null); }} lang={lang} />}

      {/* Rental Detail Modal */}
      {/* Quote editor will be added as a separate feature */}
      {reviewingRentalBC && <RentalBCReviewModal rental={reviewingRentalBC} onClose={() => setReviewingRentalBC(null)} notify={notify} reload={reload} lang={lang} />}
    </div>
  );
}

// Rental Device Modal
function RentalDeviceModal({ device, onSave, onClose, lang = 'fr' }) {
  const t = k => k;
  const [formData, setFormData] = useState({
    serial_number: device?.serial_number || '',
    model_name: device?.model_name || '',
    device_type: device?.device_type || 'particle_counter',
    brand: device?.brand || 'Lighthouse',
    description: device?.description || '',
    description_fr: device?.description_fr || '',
    specs: device?.specs || '',
    retail_value: device?.retail_value || '',
    price_per_day: device?.price_per_day || '',
    price_per_week: device?.price_per_week || '',
    price_per_month: device?.price_per_month || '',
    min_rental_days: device?.min_rental_days || 1,
    is_available: device?.is_available !== false,
    availability_notes: device?.availability_notes || ''
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.serial_number || !formData.model_name || !formData.price_per_day) {
      alert(lang === 'en' ? 'Please fill in required fields (Serial #, Model, Price/Day)' : 'Veuillez remplir les champs obligatoires (N¬∞ S√©rie, Mod√®le, Prix/Jour)');
      return;
    }
    onSave({
      ...formData,
      price_per_day: parseFloat(formData.price_per_day),
      price_per_week: formData.price_per_week ? parseFloat(formData.price_per_week) : null,
      price_per_month: formData.price_per_month ? parseFloat(formData.price_per_month) : null,
      retail_value: formData.retail_value ? parseFloat(formData.retail_value) : null,
      min_rental_days: parseInt(formData.min_rental_days) || 1
    });
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div className="sticky top-0 bg-white px-6 py-4 border-b flex justify-between items-center">
          <h2 className="text-xl font-bold">{device ? (lang === 'en' ? 'Edit device' : "Modifier l'appareil") : (lang === 'en' ? 'Add a device' : 'Ajouter un appareil')}</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Serial # *' : 'N¬∞ S√©rie *'}</label>
              <input type="text" value={formData.serial_number} onChange={e => setFormData({...formData, serial_number: e.target.value})} className="w-full px-3 py-2 border rounded-lg" required disabled={!!device} />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Model *' : 'Mod√®le *'}</label>
              <input type="text" value={formData.model_name} onChange={e => setFormData({...formData, model_name: e.target.value})} className="w-full px-3 py-2 border rounded-lg" required />
            </div>
          </div>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{t('type')}</label>
              <select value={formData.device_type} onChange={e => setFormData({...formData, device_type: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                <option value="particle_counter">{lang === 'en' ? 'Particle counter' : 'Compteur de particules'}</option>
                <option value="bio_collector">{lang === 'en' ? 'Bio collector' : 'Bio collecteur'}</option>
                <option value="liquid_counter">{lang === 'en' ? 'Liquid counter' : 'Compteur liquide'}</option>
                <option value="other">{lang === 'en' ? 'Other' : 'Autre'}</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{t('brand')}</label>
              <input type="text" value={formData.brand} onChange={e => setFormData({...formData, brand: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
            </div>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Description (FR)' : 'Description (FR)'}</label>
            <textarea value={formData.description_fr} onChange={e => setFormData({...formData, description_fr: e.target.value})} className="w-full px-3 py-2 border rounded-lg h-20 resize-none" placeholder={lang === 'en' ? 'Description visible to clients' : 'Description visible par les clients'} />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Technical specs (for quotes)' : 'Sp√©cifications techniques (pour devis)'}</label>
            <textarea value={formData.specs} onChange={e => setFormData({...formData, specs: e.target.value})} className="w-full px-3 py-2 border rounded-lg h-20 resize-none" placeholder="Ex: Compteur de particules 28,3 l/mn, 6 canaux 0.3-10¬µ, √©cran tactile 7''..." />
          </div>
          <div className="grid md:grid-cols-4 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Price/Day (‚Ç¨) *' : 'Prix/Jour (‚Ç¨) *'}</label>
              <input type="number" step="0.01" value={formData.price_per_day} onChange={e => setFormData({...formData, price_per_day: e.target.value})} className="w-full px-3 py-2 border rounded-lg" required />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Price/Week (‚Ç¨)' : 'Prix/Semaine (‚Ç¨)'}</label>
              <input type="number" step="0.01" value={formData.price_per_week} onChange={e => setFormData({...formData, price_per_week: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'en' ? 'Auto: 7x day' : 'Auto: 7x jour'} />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Price/Month (‚Ç¨)' : 'Prix/Mois (‚Ç¨)'}</label>
              <input type="number" step="0.01" value={formData.price_per_month} onChange={e => setFormData({...formData, price_per_month: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'en' ? 'Auto: 30x day' : 'Auto: 30x jour'} />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Retail value (‚Ç¨)' : 'Valeur neuf (‚Ç¨)'}</label>
              <input type="number" step="0.01" value={formData.retail_value} onChange={e => setFormData({...formData, retail_value: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder="Ex: 15500" />
            </div>
          </div>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? "Min. duration (days)" : "Dur√©e min. (jours)"}</label>
              <input type="number" value={formData.min_rental_days} onChange={e => setFormData({...formData, min_rental_days: e.target.value})} className="w-full px-3 py-2 border rounded-lg" min="1" />
            </div>
            <div className="flex items-center gap-2 pt-6">
              <input type="checkbox" id="is_available" checked={formData.is_available} onChange={e => setFormData({...formData, is_available: e.target.checked})} className="w-5 h-5 rounded" />
              <label htmlFor="is_available" className="text-sm font-medium text-gray-700">{lang === 'en' ? "Available for rental" : "Disponible √† la location"}</label>
            </div>
          </div>
          {!formData.is_available && (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? "Unavailability reason" : "Raison d'indisponibilit√©"}</label>
              <input type="text" value={formData.availability_notes} onChange={e => setFormData({...formData, availability_notes: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'en' ? 'Ex: In maintenance until 15/02' : "Ex: En maintenance jusqu'au 15/02"} />
            </div>
          )}
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">{t('cancel')}</button>
            <button type="submit" className="flex-1 py-2 bg-[#8B5CF6] hover:bg-[#7C3AED] text-white rounded-lg font-medium">{device ? t('save') : (lang === 'en' ? 'Create' : 'Cr√©er')}</button>
          </div>
        </form>
      </div>
    </div>
  );
}

// Rental Bundle Modal
function RentalBundleModal({ bundle, inventory, onSave, onClose, lang = 'fr' }) {
  const t = k => k;
  const [formData, setFormData] = useState({
    bundle_name: bundle?.bundle_name || '',
    bundle_code: bundle?.bundle_code || '',
    description: bundle?.description || '',
    description_fr: bundle?.description_fr || '',
    price_per_day: bundle?.price_per_day || '',
    price_per_week: bundle?.price_per_week || '',
    price_per_month: bundle?.price_per_month || '',
    min_rental_days: bundle?.min_rental_days || 1,
    is_active: bundle?.is_active !== false
  });
  const [selectedDevices, setSelectedDevices] = useState(bundle?.rental_bundle_items?.map(bi => bi.inventory_id) || []);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.bundle_name || !formData.price_per_day || selectedDevices.length === 0) {
      alert(lang === 'en' ? 'Please fill in required fields and select at least one device' : 'Veuillez remplir les champs obligatoires et s√©lectionner au moins un appareil');
      return;
    }
    onSave({
      bundle_name: formData.bundle_name,
      bundle_code: formData.bundle_code || null,
      description: formData.description,
      description_fr: formData.description_fr,
      price_per_day: parseFloat(formData.price_per_day),
      price_per_week: formData.price_per_week ? parseFloat(formData.price_per_week) : null,
      price_per_month: formData.price_per_month ? parseFloat(formData.price_per_month) : null,
      min_rental_days: parseInt(formData.min_rental_days) || 1,
      is_active: formData.is_active
    }, selectedDevices);
  };

  const toggleDevice = (id) => {
    setSelectedDevices(prev => prev.includes(id) ? prev.filter(d => d !== id) : [...prev, id]);
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div className="sticky top-0 bg-white px-6 py-4 border-b flex justify-between items-center">
          <h2 className="text-xl font-bold">{bundle ? (lang === 'en' ? 'Edit kit' : 'Modifier le kit') : (lang === 'en' ? 'Create kit' : 'Cr√©er un kit')}</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div className="grid md:grid-cols-2 gap-4">
            <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Kit name *' : 'Nom du kit *'}</label><input type="text" value={formData.bundle_name} onChange={e => setFormData({...formData, bundle_name: e.target.value})} className="w-full px-3 py-2 border rounded-lg" required placeholder={lang === 'en' ? 'Ex: Complete Counting Kit' : 'Ex: Kit Comptage Complet'} /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Code' : 'Code'}</label><input type="text" value={formData.bundle_code} onChange={e => setFormData({...formData, bundle_code: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'en' ? 'Ex: KIT-001' : 'Ex: KIT-001'} /></div>
          </div>
          <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Description (FR)' : 'Description (FR)'}</label><textarea value={formData.description_fr} onChange={e => setFormData({...formData, description_fr: e.target.value})} className="w-full px-3 py-2 border rounded-lg h-20 resize-none" /></div>
          <div className="grid md:grid-cols-3 gap-4">
            <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Price/Day (‚Ç¨) *' : 'Prix/Jour (‚Ç¨) *'}</label><input type="number" step="0.01" value={formData.price_per_day} onChange={e => setFormData({...formData, price_per_day: e.target.value})} className="w-full px-3 py-2 border rounded-lg" required /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Price/Week (‚Ç¨)' : 'Prix/Semaine (‚Ç¨)'}</label><input type="number" step="0.01" value={formData.price_per_week} onChange={e => setFormData({...formData, price_per_week: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'en' ? 'Price/Month (‚Ç¨)' : 'Prix/Mois (‚Ç¨)'}</label><input type="number" step="0.01" value={formData.price_per_month} onChange={e => setFormData({...formData, price_per_month: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'en' ? 'Devices included *' : 'Appareils inclus *'}</label>
            <div className="grid md:grid-cols-2 gap-2 max-h-48 overflow-y-auto border rounded-lg p-3">
              {inventory.map(device => (
                <label key={device.id} className={`flex items-center gap-2 p-2 rounded cursor-pointer ${selectedDevices.includes(device.id) ? 'bg-[#8B5CF6]/10' : 'hover:bg-gray-50'}`}>
                  <input type="checkbox" checked={selectedDevices.includes(device.id)} onChange={() => toggleDevice(device.id)} className="w-4 h-4 rounded" />
                  <span className="text-sm">{device.model_name} <span className="text-gray-400">({device.serial_number})</span></span>
                </label>
              ))}
            </div>
            <p className="text-xs text-gray-500 mt-1">{selectedDevices.length} {lang === 'en' ? 'device(s) selected' : 'appareil(s) s√©lectionn√©(s)'}</p>
          </div>
          <div className="flex items-center gap-2"><input type="checkbox" checked={formData.is_active} onChange={e => setFormData({...formData, is_active: e.target.checked})} className="w-5 h-5 rounded" /><label className="text-sm font-medium text-gray-700">{lang === 'en' ? 'Active kit (visible to clients)' : 'Kit actif (visible par les clients)'}</label></div>
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">{t('cancel')}</button>
            <button type="submit" className="flex-1 py-2 bg-[#8B5CF6] hover:bg-[#7C3AED] text-white rounded-lg font-medium">{bundle ? t('save') : (lang === 'en' ? 'Create' : 'Cr√©er')}</button>
          </div>
        </form>
      </div>
    </div>
  );
}

// Rental Calendar View
function RentalCalendarView({ bookings, inventory, lang = 'fr' }) {
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  const getBookingsForDay = (day) => {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    return bookings.filter(b => b.start_date <= dateStr && b.end_date >= dateStr);
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border p-6">
      <div className="flex items-center justify-between mb-6">
        <button onClick={() => setCurrentMonth(new Date(year, month - 1, 1))} className="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‚Üê</button>
        <h3 className="text-lg font-bold">{currentMonth.toLocaleDateString(lang === 'en' ? 'en-US' : 'fr-FR', { month: 'long', year: 'numeric' })}</h3>
        <button onClick={() => setCurrentMonth(new Date(year, month + 1, 1))} className="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‚Üí</button>
      </div>
      <div className="grid grid-cols-7 gap-1 mb-2">
        {(lang === 'en' ? ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] : ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']).map(d => <div key={d} className="text-center text-sm font-medium text-gray-500 py-2">{d}</div>)}
      </div>
      <div className="grid grid-cols-7 gap-1">
        {Array.from({ length: (new Date(year, month, 1).getDay() + 6) % 7 }, (_, i) => <div key={`pad-${i}`} className="h-24" />)}
        {Array.from({ length: daysInMonth }, (_, i) => {
          const day = i + 1;
          const dayBookings = getBookingsForDay(day);
          return (
            <div key={day} className="h-24 border rounded p-1 text-xs overflow-hidden">
              <div className="font-medium text-gray-700 mb-1">{day}</div>
              {dayBookings.slice(0, 3).map((b, idx) => {
                const device = inventory.find(d => d.id === b.inventory_id);
                return (
                  <div key={idx} className="bg-[#8B5CF6]/20 text-[#8B5CF6] px-1 rounded truncate mb-0.5" title={`${device?.model_name || 'Device'} - ${b.rental_requests?.companies?.name || ''}`}>
                    {device?.model_name?.slice(0, 10) || '?'}
                  </div>
                );
              })}
              {dayBookings.length > 3 && <div className="text-gray-400">+{dayBookings.length - 3}</div>}
            </div>
          );
        })}
      </div>
    </div>
  );
}

// Rental Admin Modal - Full management

function RentalBCReviewModal({ rental, onClose, notify, reload, lang = 'fr' }) {
  const [approving, setApproving] = useState(false);
  const [rejecting, setRejecting] = useState(false);
  const [rejectReason, setRejectReason] = useState('');
  const [bcNumber, setBcNumber] = useState('');
  const [useAutoNumber, setUseAutoNumber] = useState(true);
  const [generatingNumber, setGeneratingNumber] = useState(false);

  const rqd = rental.quote_data || {};
  const rentalBcFileUrl = rqd.bc_file_url || rental.bc_file_url || '';
  const rentalSignedQuoteUrl = rqd.signed_quote_url || rental.signed_quote_url || '';
  const hasCustomerBCFile = !!rentalBcFileUrl && rentalBcFileUrl !== rentalSignedQuoteUrl;

  useEffect(() => {
    if (hasCustomerBCFile) {
      setUseAutoNumber(false);
    } else {
      generateBCNumber();
    }
  }, []);

  const generateBCNumber = async () => {
    setGeneratingNumber(true);
    try {
      const { data, error } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'BC' });
      if (!error && data) setBcNumber(data);
      else {
        // Fallback
        const num = 'BC-' + String(new Date().getMonth() + 1).padStart(2, '0') + String(new Date().getFullYear()).slice(-2) + '-001';
        setBcNumber(num);
      }
    } catch (e) {
      const num = 'BC-' + String(new Date().getMonth() + 1).padStart(2, '0') + String(new Date().getFullYear()).slice(-2) + '-001';
      setBcNumber(num);
    }
    setGeneratingNumber(false);
  };

  const approveBC = async () => {
    if (!bcNumber.trim()) {
      notify('Veuillez entrer un num√©ro de BC', 'error');
      return;
    }
    setApproving(true);
    const updatedQuoteData = { ...(rental.quote_data || {}), bc_number: bcNumber.trim(), bc_approved_at: new Date().toISOString() };
    const { error } = await supabase
      .from('rental_requests')
      .update({
        status: 'bc_approved',
        quote_data: updatedQuoteData
      })
      .eq('id', rental.id);
    if (error) {
      notify('Erreur: ' + error.message, 'error');
    } else {
      notify(`‚úÖ BC N¬∞ ${bcNumber} approuv√©!`);
      reload();
      onClose();
    }
    setApproving(false);
  };

  const rejectBC = async () => {
    if (!rejectReason.trim()) {
      notify('Veuillez indiquer la raison du refus', 'error');
      return;
    }
    setRejecting(true);
    const rejectedQD = { ...(rental.quote_data || {}), bc_rejected_at: new Date().toISOString(), bc_rejection_reason: rejectReason, bc_file_url: null, bc_signature_url: null, bc_submitted_at: null };
    const { error } = await supabase
      .from('rental_requests')
      .update({
        status: 'waiting_bc',
        quote_data: rejectedQD
      })
      .eq('id', rental.id);
    if (error) {
      notify('Erreur: ' + error.message, 'error');
    } else {
      notify('BC refus√©. Le client devra soumettre un nouveau BC.');
      reload();
      onClose();
    }
    setRejecting(false);
  };

  const items = rental.rental_request_items || [];
  const displayUrl = rentalSignedQuoteUrl || rentalBcFileUrl;

  return (
    <div className="fixed inset-0 z-50 bg-black/80 flex" onClick={onClose}>
      <div className="bg-white w-full h-full max-w-[98vw] max-h-[98vh] m-auto rounded-xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white flex justify-between items-center flex-shrink-0">
          <div>
            <h2 className="text-xl font-bold">üìã V√©rification du Bon de Commande ‚Äî Location</h2>
            <p className="text-red-100">{rental.rental_number} ‚Ä¢ {rental.companies?.name}</p>
          </div>
          <button onClick={onClose} className="text-white/70 hover:text-white text-3xl">&times;</button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-hidden flex">
          {/* Left: Document Preview */}
          <div className="flex-1 flex flex-col bg-gray-800 p-4">
            <div className="flex justify-between items-center mb-3">
              <h3 className="font-bold text-white text-lg">üìÑ Document BC</h3>
              <div className="flex gap-2">
                {rentalSignedQuoteUrl && (
                  <a href={rentalSignedQuoteUrl} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm font-medium">üìÑ Devis Sign√© ‚Üó</a>
                )}
                {rentalBcFileUrl && (
                  <a href={rentalBcFileUrl} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium">üìã BC Upload√© ‚Üó</a>
                )}
              </div>
            </div>
            {displayUrl ? (
              <div className="flex-1 rounded-lg overflow-hidden bg-white">
                {displayUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? (
                  <img src={displayUrl} alt="BC Document" className="w-full h-full object-contain" />
                ) : (
                  <object data={`${displayUrl}#view=Fit`} type="application/pdf" className="w-full h-full" style={{ minHeight: '100%' }}>
                    <iframe src={`${displayUrl}#view=Fit`} className="w-full h-full" title="BC PDF" />
                  </object>
                )}
              </div>
            ) : (
              <div className="flex-1 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center text-gray-400 text-lg">Aucun fichier BC upload√©</div>
            )}
          </div>

          {/* Right: Sidebar */}
          <div className="w-96 flex-shrink-0 bg-gray-50 overflow-y-auto p-4 space-y-4">
            <h3 className="font-bold text-gray-800 text-lg">üìã D√©tails de la Location</h3>

            {/* Info */}
            <div className="bg-white rounded-lg p-4 border">
              <div className="grid grid-cols-2 gap-3 text-sm">
                <div><p className="text-gray-500">N¬∞ Location</p><p className="font-mono font-bold text-[#8B5CF6]">{rental.rental_number}</p></div>
                <div><p className="text-gray-500">Client</p><p className="font-medium">{rental.companies?.name}</p></div>
                <div><p className="text-gray-500">Soumission BC</p><p className="font-medium">{rental.bc_submitted_at ? new Date(rental.bc_submitted_at).toLocaleString('fr-FR') : '‚Äî'}</p></div>
                <div><p className="text-gray-500">Sign√© par</p><p className="font-medium">{rental.bc_signed_by || '‚Äî'}</p></div>
              </div>
            </div>

            {/* Signature */}
            {rental.bc_signature_url && (
              <div className="bg-white rounded-lg p-4 border">
                <h4 className="font-medium text-gray-700 mb-2">‚úçÔ∏è Signature</h4>
                <img src={rental.bc_signature_url} alt="Signature" className="max-h-20 mx-auto bg-gray-50 rounded p-2" />
                <p className="text-center text-xs text-gray-500 mt-1">{rental.bc_signed_by || '‚Äî'}</p>
              </div>
            )}

            {/* Equipment */}
            <div className="bg-white rounded-lg p-4 border">
              <h4 className="font-medium text-gray-700 mb-2">üì¶ √âquipement ({items.length})</h4>
              <div className="space-y-2 max-h-40 overflow-y-auto">
                {items.map((d, i) => (
                  <div key={i} className="bg-gray-50 rounded p-2 text-sm">
                    <p className="font-medium">{d.item_name || d.model_name}</p>
                    <p className="text-gray-500">SN: {d.serial_number || '‚Äî'}</p>
                  </div>
                ))}
              </div>
            </div>

            {/* Quote Info */}
            {((rqd.totalHT || rental.quote_total) || (rqd.quote_url || rental.quote_url)) && (
              <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <h4 className="font-medium text-blue-800 mb-1">üí∞ Devis Location</h4>
                {(rqd.totalHT || rental.quote_total) && <p className="text-xl font-bold text-blue-700">{parseFloat((rqd.totalHT || rental.quote_total)).toFixed(2)} ‚Ç¨ HT</p>}
                <p className="text-xs text-blue-500">
                  {rental.start_date && rental.end_date ? `${new Date(rental.start_date).toLocaleDateString('fr-FR')} ‚Üí ${new Date(rental.end_date).toLocaleDateString('fr-FR')}` : ''}
                </p>
              </div>
            )}

            {/* BC Number Input */}
            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
              <h4 className="font-medium text-green-800 mb-2">üìã Num√©ro de Bon de Commande</h4>
              <p className="text-xs text-green-600 mb-3">
                {hasCustomerBCFile
                  ? 'Le client a fourni son propre BC. Entrez le num√©ro du client.'
                  : 'Devis sign√© par le client. Auto-g√©n√©rer ou entrer un num√©ro.'}
              </p>
              {!hasCustomerBCFile && (
                <div className="flex items-center gap-2 mb-3">
                  <button onClick={() => { setUseAutoNumber(true); generateBCNumber(); }} className={`flex-1 px-3 py-1.5 rounded text-sm font-medium transition-colors ${useAutoNumber ? 'bg-green-600 text-white' : 'bg-white border border-green-300 text-green-700'}`}>Auto</button>
                  <button onClick={() => { setUseAutoNumber(false); setBcNumber(''); }} className={`flex-1 px-3 py-1.5 rounded text-sm font-medium transition-colors ${!useAutoNumber ? 'bg-green-600 text-white' : 'bg-white border border-green-300 text-green-700'}`}>Manuel</button>
                </div>
              )}
              <div className="relative">
                <input type="text" value={bcNumber} onChange={e => setBcNumber(e.target.value)} placeholder={hasCustomerBCFile ? "N¬∞ BC du client (requis)" : "BC-0226-001"} className={`w-full px-3 py-2 border rounded-lg font-mono text-center text-lg ${hasCustomerBCFile && !bcNumber ? 'border-red-300 bg-red-50' : 'border-green-300'}`} disabled={generatingNumber} />
                {generatingNumber && <div className="absolute right-3 top-1/2 -translate-y-1/2"><div className="w-4 h-4 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div></div>}
              </div>
              {hasCustomerBCFile && !bcNumber && <p className="text-xs text-red-600 mt-1">‚ö†Ô∏è Num√©ro BC requis pour le Bon de Livraison</p>}
              {useAutoNumber && bcNumber && !hasCustomerBCFile && <p className="text-xs text-green-600 mt-1">‚úì Ce num√©ro sera utilis√© pour le BL</p>}
            </div>

            {/* Reject */}
            <div className="bg-red-50 rounded-lg p-4 border border-red-200">
              <h4 className="font-medium text-red-800 mb-2">Refuser le BC?</h4>
              <textarea value={rejectReason} onChange={e => setRejectReason(e.target.value)} placeholder="Raison du refus..." className="w-full px-3 py-2 border border-red-300 rounded-lg text-sm h-20 resize-none" />
            </div>

            {/* Actions */}
            <div className="space-y-2 pt-2">
              <button onClick={approveBC} disabled={approving} className="w-full px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold disabled:opacity-50">
                {approving ? 'Approbation...' : '‚úÖ Approuver BC'}
              </button>
              <button onClick={rejectBC} disabled={rejecting || !rejectReason.trim()} className="w-full px-6 py-3 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-bold disabled:opacity-50">
                {rejecting ? 'Rejet...' : '‚ùå Rejeter BC'}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}


// ============================================
// RENTAL QUOTE EDITOR - Full page quote creation
// ============================================
function RentalQuoteEditor({ rental, inventory = [], profile, businessSettings, notify, reload, onBack, lang = 'fr' }) {
  const company = rental.companies || {};
  const baseItems = rental.rental_request_items || [];
  const days = Math.ceil((new Date(rental.end_date) - new Date(rental.start_date)) / (1000*60*60*24)) + 1;

  const [saving, setSaving] = useState(false);
  const [quoteShipping, setQuoteShipping] = useState(rental.quote_shipping || 0);
  const [quoteNotes, setQuoteNotes] = useState(rental.quote_notes || '');
  const [discount, setDiscount] = useState(rental.quote_data?.discount || 0);
  const [discountType, setDiscountType] = useState(rental.quote_data?.discountType || 'percent');
  const [buybackClause, setBuybackClause] = useState(rental.quote_data?.buybackClause !== false);
  const [buybackPercent, setBuybackPercent] = useState(rental.quote_data?.buybackPercent || 50);
  const [deliveryTerms, setDeliveryTerms] = useState(rental.quote_data?.deliveryTerms || 'En stock');
  const [paymentTerms, setPaymentTerms] = useState(rental.quote_data?.paymentTerms || '√Ä r√©ception de facture');
  const [quoteItems, setQuoteItems] = useState(() => {
    const savedItems = rental.quote_data?.quoteItems;
    if (savedItems?.length > 0) return savedItems;
    return baseItems.map(item => {
      const invDevice = inventory.find(d => d.serial_number === item.serial_number || d.id === item.inventory_id);
      return {
        id: item.id, item_name: item.item_name || invDevice?.model_name || '',
        serial_number: item.serial_number || invDevice?.serial_number || '',
        description: item.description || invDevice?.description_fr || '',
        rental_days: item.rental_days || days, applied_rate: item.applied_rate || invDevice?.price_per_day || 0,
        rate_type: item.rate_type || 'jour', line_total: item.line_total || 0,
        retail_value: invDevice?.retail_value || 0, specs: invDevice?.specs || invDevice?.description_fr || ''
      };
    });
  });

  const rentalSubtotal = quoteItems.reduce((s, i) => s + (parseFloat(i.line_total) || 0), 0);
  const discountAmount = discountType === 'percent' ? rentalSubtotal * (parseFloat(discount) || 0) / 100 : parseFloat(discount) || 0;
  const subtotalAfterDiscount = rentalSubtotal - discountAmount;
  const totalHT = subtotalAfterDiscount + parseFloat(quoteShipping || 0);
  const totalRetailValue = quoteItems.reduce((s, i) => s + (parseFloat(i.retail_value) || 0), 0);

  const updateItem = (idx, field, value) => {
    const updated = [...quoteItems];
    updated[idx] = { ...updated[idx], [field]: value };
    if (['rental_days', 'applied_rate'].includes(field)) {
      updated[idx].line_total = (parseFloat(updated[idx].rental_days) || 0) * (parseFloat(updated[idx].applied_rate) || 0);
    }
    setQuoteItems(updated);
  };

  const sendQuote = async () => {
    setSaving(true);
    try {
      const quoteData = {
        rentalId: rental.id, rentalNumber: rental.rental_number, quoteItems, items: quoteItems,
        shipping: parseFloat(quoteShipping) || 0, discount: parseFloat(discount) || 0, discountType, discountAmount,
        subtotalBeforeDiscount: rentalSubtotal, subtotalAfterDiscount, totalHT, totalRetailValue,
        notes: quoteNotes, buybackClause, buybackPercent: parseFloat(buybackPercent) || 50,
        deliveryTerms, paymentTerms, rentalPeriod: { start: rental.start_date, end: rental.end_date, days },
        clientName: company.name || 'Client', clientAddress: company.billing_address || company.address || '',
        clientCity: company.billing_city || company.city || '', clientPostalCode: company.billing_postal_code || company.postal_code || '',
        clientCountry: company.country || 'France'
      };
      const mergedQuoteData = {
        ...(rental.quote_data || {}), ...quoteData,
        quoted_at: new Date().toISOString(),
        quote_valid_until: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
        quote_rejection_notes: null, quote_revision_notes: null
      };
      const itemSummary = quoteItems.map(i => `${i.item_name || 'Item'} (${i.rental_days || days}j)`).join(', ');
      const { data: review, error: reviewError } = await supabase.from('quote_reviews').insert({
        rental_request_id: rental.id, quote_type: 'rental', quote_data: quoteData,
        quote_number: rental.rental_number, rma_number: rental.rental_number,
        client_name: company.name || 'Client inconnu', total_amount: totalHT,
        device_summary: itemSummary, submitted_by: profile?.id,
        submitted_by_name: profile?.full_name || profile?.email || 'Unknown', previous_status: rental.status || 'requested'
      }).select().single();
      if (reviewError) console.error('Review insert error:', reviewError);
      if (review?.id) mergedQuoteData.quote_review_id = review.id;
      // Single atomic update: status + quote_data together
      const { error: statusErr } = await supabase.from('rental_requests').update({ status: 'pending_quote_review', quote_data: mergedQuoteData }).eq('id', rental.id);
      if (statusErr) {
        console.error('Status update error:', statusErr);
        notify('Erreur mise √† jour statut: ' + statusErr.message, 'error');
      } else {
        notify('‚úÖ Devis soumis pour v√©rification !');
      }
      reload();
      onBack();
    } catch (err) { notify('Erreur: ' + err.message, 'error'); }
    setSaving(false);
  };

  return (
    <div className="min-h-screen bg-gray-100">
      <div className="sticky top-0 z-10 bg-white border-b shadow-sm">
        <div className="px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-gray-700">
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
            </button>
            <div>
              <h1 className="text-2xl font-bold text-gray-800">üí∞ {rental.quote_rejection_notes || rental.quote_revision_notes ? 'Corriger le Devis' : 'Cr√©er Devis Location'}</h1>
              <p className="text-gray-500">{rental.rental_number} ‚Ä¢ {company.name} ‚Ä¢ {days} jours</p>
            </div>
          </div>
          <button onClick={sendQuote} disabled={saving || rentalSubtotal <= 0} className="px-6 py-2 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-bold disabled:opacity-50">
            {saving ? '‚è≥ Envoi...' : '‚úÖ Soumettre pour v√©rification'}
          </button>
        </div>
      </div>
      <div className="p-6 max-w-5xl mx-auto space-y-6">
        {rental.quote_rejection_notes && (
          <div className="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 flex items-center gap-3">
            <span className="text-2xl">‚úèÔ∏è</span>
            <div><p className="font-bold text-amber-800">Le v√©rificateur demande une correction</p><p className="text-amber-700 text-sm">{rental.quote_rejection_notes}</p></div>
          </div>
        )}
        {rental.quote_revision_notes && (
          <div className="bg-orange-50 border-2 border-orange-300 rounded-lg p-4 flex items-center gap-3">
            <span className="text-2xl">üîÑ</span>
            <div><p className="font-bold text-orange-800">Le client demande des modifications</p><p className="text-orange-700 text-sm">{rental.quote_revision_notes}</p></div>
          </div>
        )}
        <div className="bg-purple-50 border border-purple-200 rounded-xl p-4 flex items-center gap-4">
          <span className="text-3xl">üìÖ</span>
          <div>
            <p className="font-bold text-purple-800">P√©riode de location</p>
            <p className="text-purple-700">{new Date(rental.start_date).toLocaleDateString('fr-FR')} ‚Üí {new Date(rental.end_date).toLocaleDateString('fr-FR')} <span className="px-2 py-0.5 bg-purple-200 text-purple-800 rounded-full text-xs font-bold ml-2">{days} jours</span></p>
          </div>
        </div>
        <div className="space-y-4">
          <h2 className="font-bold text-gray-800 text-lg">üì¶ √âquipements ({quoteItems.length})</h2>
          {quoteItems.map((item, idx) => (
            <div key={item.id || idx} className="bg-white rounded-xl border-2 shadow-sm overflow-hidden">
              <div className="px-4 py-3 bg-[#1a1a2e] text-white flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-lg">üì°</span>
                  <div><p className="font-bold">{item.item_name}</p>{item.serial_number && <p className="text-xs text-gray-300 font-mono">S/N: {item.serial_number}</p>}</div>
                </div>
                <span className="text-lg font-bold text-[#00A651]">{(parseFloat(item.line_total) || 0).toFixed(2)} ‚Ç¨</span>
              </div>
              <div className="p-4">
                <div className="grid grid-cols-4 gap-3">
                  <div><label className="block text-xs font-medium text-gray-500 mb-1">Jours</label><input type="number" value={item.rental_days} onChange={e => updateItem(idx, 'rental_days', e.target.value)} className="w-full px-3 py-2 border rounded-lg text-center font-bold" /></div>
                  <div><label className="block text-xs font-medium text-gray-500 mb-1">Tarif/jour (‚Ç¨)</label><input type="number" step="0.01" value={item.applied_rate} onChange={e => updateItem(idx, 'applied_rate', e.target.value)} className="w-full px-3 py-2 border rounded-lg text-center font-bold" /></div>
                  <div><label className="block text-xs font-medium text-gray-500 mb-1">Valeur assurance (‚Ç¨)</label><input type="number" step="0.01" value={item.retail_value} onChange={e => updateItem(idx, 'retail_value', e.target.value)} className="w-full px-3 py-2 border rounded-lg text-center" /></div>
                  <div><label className="block text-xs font-medium text-gray-500 mb-1">Total ligne</label><div className="w-full px-3 py-2 bg-green-50 border border-green-200 rounded-lg text-center font-bold text-green-700">{(parseFloat(item.line_total) || 0).toFixed(2)} ‚Ç¨</div></div>
                </div>
              </div>
            </div>
          ))}
        </div>
        <div className="grid md:grid-cols-2 gap-6">
          <div className="bg-white rounded-xl border shadow-sm p-5 space-y-4">
            <h3 className="font-bold text-gray-800">‚öôÔ∏è Options du devis</h3>
            <div className="grid grid-cols-2 gap-3">
              <div><label className="block text-xs font-medium text-gray-500 mb-1">Remise ({discountType === 'percent' ? '%' : '‚Ç¨'})</label><div className="flex gap-1"><input type="number" step="0.01" value={discount} onChange={e => setDiscount(e.target.value)} className="flex-1 px-3 py-2 border rounded-lg" /><select value={discountType} onChange={e => setDiscountType(e.target.value)} className="px-2 py-2 border rounded-lg text-sm"><option value="percent">%</option><option value="fixed">‚Ç¨</option></select></div></div>
              <div><label className="block text-xs font-medium text-gray-500 mb-1">Frais port (‚Ç¨ HT)</label><input type="number" step="0.01" value={quoteShipping} onChange={e => setQuoteShipping(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
            </div>
            <div><label className="block text-xs font-medium text-gray-500 mb-1">D√©lai livraison</label><input type="text" value={deliveryTerms} onChange={e => setDeliveryTerms(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
            <div><label className="block text-xs font-medium text-gray-500 mb-1">Conditions paiement</label><input type="text" value={paymentTerms} onChange={e => setPaymentTerms(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
            <div><label className="block text-xs font-medium text-gray-500 mb-1">Notes</label><textarea value={quoteNotes} onChange={e => setQuoteNotes(e.target.value)} rows={3} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Notes visibles sur le devis..." /></div>
          </div>
          <div className="bg-white rounded-xl border-2 border-gray-200 shadow-sm p-5">
            <h3 className="font-bold text-gray-800 mb-4">üí∞ R√©capitulatif</h3>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between"><span className="text-gray-600">Sous-total √©quipements</span><span className="font-bold">{rentalSubtotal.toFixed(2)} ‚Ç¨</span></div>
              {discountAmount > 0 && <div className="flex justify-between text-red-600"><span>Remise {discountType === 'percent' ? `(${discount}%)` : ''}</span><span className="font-bold">-{discountAmount.toFixed(2)} ‚Ç¨</span></div>}
              {parseFloat(quoteShipping) > 0 && <div className="flex justify-between"><span className="text-gray-600">Frais de port</span><span className="font-bold">{parseFloat(quoteShipping).toFixed(2)} ‚Ç¨</span></div>}
              <div className="flex justify-between text-xl font-bold pt-3 border-t-2 mt-3"><span>Total HT</span><span className="text-[#00A651]">{totalHT.toFixed(2)} ‚Ç¨</span></div>
              <div className="flex justify-between text-sm text-gray-500 pt-1"><span>TVA (20%)</span><span>{(totalHT * 0.2).toFixed(2)} ‚Ç¨</span></div>
              <div className="flex justify-between text-lg font-bold pt-1"><span>Total TTC</span><span>{(totalHT * 1.2).toFixed(2)} ‚Ç¨</span></div>
            </div>
            {totalRetailValue > 0 && <div className="mt-4 pt-3 border-t text-sm text-blue-600"><span className="font-medium">Valeur √† assurer:</span> {totalRetailValue.toFixed(2)} ‚Ç¨</div>}
            <button onClick={sendQuote} disabled={saving || rentalSubtotal <= 0} className="w-full mt-6 py-3 bg-[#00A651] hover:bg-[#008f45] text-white rounded-xl font-bold text-lg disabled:opacity-50">{saving ? '‚è≥ Envoi en cours...' : '‚úÖ Soumettre pour v√©rification'}</button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================
// RENTAL SHIPPING WIZARD - Full page shipping workflow
// ============================================
function RentalShippingModal({ rental, company, address, items, days, profile, businessSettings, notify, reload, onClose, lang = 'fr' }) {
  const [step, setStep] = useState(1);
  const [saving, setSaving] = useState(false);
  const [upsLoading, setUpsLoading] = useState(false);

  // Shipping state
  const [shipAddress, setShipAddress] = useState({
    company_name: address.company_name || address.label || company.name || '',
    attention: address.attention || '',
    address_line1: address.address_line1 || '',
    city: address.city || '',
    postal_code: address.postal_code || '',
    country: address.country || 'France',
    phone: address.phone || ''
  });
  const [parcels, setParcels] = useState(1);
  const [weight, setWeight] = useState('2');
  const [notes, setNotes] = useState('');
  const [shippingMode, setShippingMode] = useState('ups'); // 'ups' or 'custom'
  const [customTracking, setCustomTracking] = useState('');

  // Generated data
  const [trackingNumber, setTrackingNumber] = useState('');
  const [upsLabels, setUpsLabels] = useState({}); // { pkgIndex: base64 }
  const [packageLabels, setPackageLabels] = useState([]);
  const [blNumber, setBlNumber] = useState('');
  const [generatedBL, setGeneratedBL] = useState(null);
  const [labelsPrinted, setLabelsPrinted] = useState({});
  const [blPrinted, setBlPrinted] = useState(false);

  const qd = rental.quote_data || {};
  const bcNumber = qd.bc_number || '';
  const biz = businessSettings || {};
  const employeeName = profile?.full_name || 'Lighthouse France';

  const frenchMonths = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
  const getFrenchDate = () => { const d = new Date(); return `${d.getDate()} ${frenchMonths[d.getMonth()]} ${d.getFullYear()}`; };

  // ===== STEP 1 ‚Üí Create UPS Label =====
  const createUPSLabels = async () => {
    if (!shipAddress.company_name || !shipAddress.address_line1) {
      notify('Veuillez remplir l\'adresse de livraison', 'error');
      return;
    }
    setUpsLoading(true);
    try {
      const packagesList = [];
      for (let p = 0; p < parcels; p++) {
        packagesList.push({
          weight: parseFloat(weight) || 2,
          length: 30, width: 30, height: 30,
          description: `Location ${rental.rental_number} - Colis ${p + 1}/${parcels}`
        });
      }

      const { data, error } = await supabase.functions.invoke('ups-shipping', {
        body: {
          action: 'create_shipment',
          shipTo: {
            name: shipAddress.attention || shipAddress.company_name || 'Customer',
            company: shipAddress.company_name || 'Customer',
            attentionName: shipAddress.attention || shipAddress.company_name || 'Customer',
            phone: shipAddress.phone || '0100000000',
            addressLine1: shipAddress.address_line1 || '',
            city: shipAddress.city || '',
            postalCode: shipAddress.postal_code || '',
            countryCode: shipAddress.country === 'France' ? 'FR' : 'FR'
          },
          packages: packagesList,
          serviceCode: '11',
          description: `Location ${rental.rental_number} - ${items.length} appareil(s)`,
          isReturn: false
        }
      });

      if (error) throw error;
      if (!data.success) throw new Error(data.error || 'UPS API error');

      setTrackingNumber(data.trackingNumber);
      setPackageLabels(data.packages || []);

      const newLabels = {};
      if (data.packages) {
        data.packages.forEach((pkg, pkgIndex) => {
          if (pkg.labelData) newLabels[pkgIndex] = pkg.labelData;
        });
      }
      setUpsLabels(newLabels);
      notify(`‚úÖ ${data.packages?.length || 1} √©tiquette(s) UPS cr√©√©e(s): ${data.trackingNumber}`);
      setStep(2);
    } catch (err) {
      console.error('UPS Label creation error:', err);
      notify('‚ùå Erreur UPS: ' + (err.message || 'Erreur inconnue'), 'error');
    }
    setUpsLoading(false);
  };

  // Use custom tracking ‚Üí skip to BL
  const proceedWithCustomTracking = () => {
    if (!customTracking.trim()) {
      notify('Veuillez entrer un num√©ro de suivi', 'error');
      return;
    }
    setTrackingNumber(customTracking.trim());
    setStep(3); // Skip UPS labels, go straight to BL
  };

  // ===== STEP 3 ‚Üí Save Documents =====
  const saveShippingDocs = async () => {
    setSaving(true);
    try {
      // Generate BL number from DB
      let finalBLNumber = null;
      try {
        const { data: docNumData, error: docNumError } = await supabase.rpc('get_next_doc_number', { p_doc_type: 'BL' });
        console.log('üìÑ BL number generation:', { docNumData, docNumError });
        if (!docNumError && docNumData) finalBLNumber = docNumData;
      } catch (e) {
        console.error('Could not generate BL number:', e);
        const dateStr = `${String(new Date().getDate()).padStart(2, '0')}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getFullYear()).slice(-2)}`;
        finalBLNumber = `BL-LOC-${rental.rental_number?.replace('LOC-', '') || '00000'}-${dateStr}`;
      }
      setBlNumber(finalBLNumber);
      console.log('üìÑ BL number:', finalBLNumber);

      // Update BL number in preview before capture
      const numberEl = document.querySelector('[data-rental-bl-number]');
      if (numberEl) numberEl.textContent = 'N¬∞ ' + finalBLNumber;

      // Small delay for DOM update
      await new Promise(r => setTimeout(r, 200));

      // Generate BL PDF via html2canvas
      let blUrl = null;
      try {
        if (!window.html2canvas) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }
        const element = document.getElementById('rental-bl-preview');
        console.log('üìÑ BL preview element found:', !!element);
        if (element) {
          const canvas = await window.html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
          const jsPDF = await loadJsPDF();
          const pdf = new jsPDF('p', 'mm', 'a4');
          const imgData = canvas.toDataURL('image/jpeg', 0.95);
          pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
          const blPdfBlob = pdf.output('blob');
          console.log('üìÑ BL PDF blob size:', blPdfBlob?.size);
          const safeBL = (finalBLNumber || 'BL').replace(/[^a-zA-Z0-9-_]/g, '');
          const blFileName = `${rental.rental_number}_BL_${safeBL}_${Date.now()}.pdf`;
          blUrl = await uploadPDFToStorage(blPdfBlob, `shipping/${rental.rental_number}`, blFileName);
          console.log('üìÑ BL uploaded, URL:', blUrl);
        }
      } catch (pdfErr) {
        console.error('‚ùå BL PDF generation error:', pdfErr);
        notify('‚ö†Ô∏è Erreur g√©n√©ration BL PDF: ' + pdfErr.message, 'warning');
      }

      // Save UPS Label PDF
      let upsLabelUrl = null;
      if (shippingMode === 'ups' && Object.keys(upsLabels).length > 0) {
        try {
          const labelData = upsLabels[0];
          console.log('üìÑ UPS label data present:', !!labelData, 'size:', labelData?.length);
          if (labelData) {
            const byteCharacters = atob(labelData);
            const byteNumbers = new Array(byteCharacters.length);
            for (let j = 0; j < byteCharacters.length; j++) {
              byteNumbers[j] = byteCharacters.charCodeAt(j);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const upsPdfBlob = new Blob([byteArray], { type: 'application/pdf' });
            console.log('üìÑ UPS PDF blob size:', upsPdfBlob?.size);
            const safeTracking = (trackingNumber || 'label').replace(/[^a-zA-Z0-9-_]/g, '');
            const upsFileName = `${rental.rental_number}_UPS_${safeTracking}_${Date.now()}.pdf`;
            upsLabelUrl = await uploadPDFToStorage(upsPdfBlob, `shipping/${rental.rental_number}`, upsFileName);
            console.log('üìÑ UPS label uploaded, URL:', upsLabelUrl);
          }
        } catch (pdfErr) {
          console.error('‚ùå UPS Label PDF save error:', pdfErr);
          notify('‚ö†Ô∏è Erreur sauvegarde √©tiquette UPS: ' + pdfErr.message, 'warning');
        }
      }

      // Save BL as attachment
      if (blUrl) {
        const { error: blAttErr } = await supabase.from('request_attachments').insert({
          rental_request_id: rental.id, file_name: `${finalBLNumber}.pdf`, file_url: blUrl,
          file_type: 'application/pdf', uploaded_by: profile?.id, category: 'bon_livraison'
        });
        if (blAttErr) console.error('‚ùå BL attachment save error:', blAttErr);
        else console.log('‚úÖ BL attachment saved');
      }

      // Save UPS label as attachment
      if (upsLabelUrl) {
        const { error: upsAttErr } = await supabase.from('request_attachments').insert({
          rental_request_id: rental.id, file_name: `UPS_${trackingNumber}.pdf`, file_url: upsLabelUrl,
          file_type: 'application/pdf', uploaded_by: profile?.id, category: 'ups_label'
        });
        if (upsAttErr) console.error('‚ùå UPS attachment save error:', upsAttErr);
        else console.log('‚úÖ UPS attachment saved');
      }

      // Persist shipping info to quote_data (do NOT change status - that's a separate action)
      const shippingInfo = {
        outbound_tracking: trackingNumber,
        bl_number: finalBLNumber,
        bl_url: blUrl || null,
        ups_label_url: upsLabelUrl || null,
        shipped_parcels: parcels,
        shipped_weight: weight || null,
        prepared_by: employeeName,
        prepared_at: new Date().toISOString()
      };
      const updatedQD = { ...(rental.quote_data || {}), shippingInfo, ...shippingInfo };
      const { error: qdErr } = await supabase.from('rental_requests').update({ quote_data: updatedQD }).eq('id', rental.id);
      if (qdErr) console.error('‚ùå quote_data update error:', qdErr);
      else console.log('‚úÖ Shipping info saved to quote_data');

      setGeneratedBL({ blNumber: finalBLNumber, blUrl, upsLabelUrl, trackingNumber });
      setStep(4);
      notify(blUrl || upsLabelUrl ? '‚úÖ Documents d\'exp√©dition enregistr√©s !' : '‚ö†Ô∏è Documents cr√©√©s mais erreur upload');
      reload();
    } catch (err) {
      console.error('‚ùå saveShippingDocs error:', err);
      notify('Erreur: ' + (err.message || 'Erreur'), 'error');
    }
    setSaving(false);
  };

  // Print helpers
  const printLabel = (pkgIdx) => {
    const labelData = upsLabels[pkgIdx];
    if (labelData) {
      const byteCharacters = atob(labelData);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      setLabelsPrinted(prev => ({ ...prev, [pkgIdx]: true }));
    }
  };

  const printBL = () => {
    const element = document.getElementById('rental-bl-preview');
    if (element) {
      const w = window.open('', '_blank');
      w.document.write('<html><head><title>BL</title></head><body style="margin:0">' + element.outerHTML + '</body></html>');
      w.document.close();
      w.print();
      setBlPrinted(true);
    }
  };

  const stepLabels = shippingMode === 'custom'
    ? ['V√©rification', 'Bon de Livraison', 'Exp√©dier']
    : ['V√©rification', '√âtiquette UPS', 'Bon de Livraison', 'Exp√©dier'];
  const displayStep = shippingMode === 'custom' ? (step === 1 ? 1 : step === 3 ? 2 : step === 4 ? 3 : step) : step;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={onClose}>
      <div className="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="px-6 py-4 border-b bg-gradient-to-r from-green-600 to-emerald-600 text-white">
          <div className="flex justify-between items-center">
            <div>
              <h2 className="text-xl font-bold">üöö Pr√©parer l'exp√©dition</h2>
              <p className="text-green-100 text-sm">{rental.rental_number} ‚Ä¢ {company.name} ‚Ä¢ {items.length} appareil(s)</p>
            </div>
            <button onClick={onClose} className="text-white/70 hover:text-white text-2xl">‚úï</button>
          </div>
          {/* Step indicator */}
          <div className="flex items-center gap-2 mt-3">
            {stepLabels.map((label, idx) => (
              <Fragment key={idx}>
                {idx > 0 && <div className={`flex-grow h-0.5 ${displayStep > idx ? 'bg-white' : 'bg-green-500'}`} />}
                <div className={`flex items-center gap-1.5 whitespace-nowrap`}>
                  <div className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${displayStep > idx + 1 ? 'bg-white text-green-600' : displayStep === idx + 1 ? 'bg-white text-green-600' : 'bg-green-500 text-green-200'}`}>
                    {displayStep > idx + 1 ? '‚úì' : idx + 1}
                  </div>
                  <span className={`text-xs hidden sm:inline ${displayStep === idx + 1 ? 'text-white font-medium' : 'text-green-200'}`}>{label}</span>
                </div>
              </Fragment>
            ))}
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* ===== STEP 1: REVIEW ===== */}
          {step === 1 && (
            <div className="space-y-6">
              {/* Address Section */}
              <div className="bg-white border-2 border-gray-200 rounded-xl">
                <div className="bg-amber-50 px-4 py-3 border-b">
                  <h3 className="font-bold text-amber-800">üìç Adresse de livraison</h3>
                </div>
                <div className="p-4 grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Soci√©t√© *</label>
                    <input type="text" value={shipAddress.company_name} onChange={e => setShipAddress(p => ({...p, company_name: e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{"√Ä l'attention de"}</label>
                    <input type="text" value={shipAddress.attention} onChange={e => setShipAddress(p => ({...p, attention: e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Nom du contact" />
                  </div>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Adresse *</label>
                    <input type="text" value={shipAddress.address_line1} onChange={e => setShipAddress(p => ({...p, address_line1: e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Code postal *</label>
                    <input type="text" value={shipAddress.postal_code} onChange={e => setShipAddress(p => ({...p, postal_code: e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Ville *</label>
                    <input type="text" value={shipAddress.city} onChange={e => setShipAddress(p => ({...p, city: e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Pays</label>
                    <input type="text" value={shipAddress.country} onChange={e => setShipAddress(p => ({...p, country: e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">T√©l√©phone</label>
                    <input type="text" value={shipAddress.phone} onChange={e => setShipAddress(p => ({...p, phone: e.target.value}))} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="+33..." />
                  </div>
                </div>
              </div>

              {/* Shipping Details */}
              <div className="bg-white border-2 border-gray-200 rounded-xl">
                <div className="bg-green-50 px-4 py-3 border-b flex justify-between items-center">
                  <h3 className="font-bold text-green-800">üöö {"D√©tails d'exp√©dition"}</h3>
                  <span className="text-xs text-green-600">üí° UPS cr√©e 1 √©tiquette par colis</span>
                </div>
                <div className="p-4 grid md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Nombre de colis</label>
                    <div className="flex items-center gap-2">
                      <button onClick={() => setParcels(Math.max(1, parcels - 1))} className="w-10 h-10 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-lg">-</button>
                      <input type="number" min="1" value={parcels} onChange={e => setParcels(parseInt(e.target.value) || 1)} className="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center font-bold text-lg" />
                      <button onClick={() => setParcels(parcels + 1)} className="w-10 h-10 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold text-lg">+</button>
                    </div>
                    {parcels > 1 && <p className="text-xs text-green-600 mt-1">üì¶ {parcels} √©tiquettes seront cr√©√©es</p>}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Poids total (kg)</label>
                    <input type="text" value={weight} onChange={e => setWeight(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Notes internes</label>
                    <input type="text" value={notes} onChange={e => setNotes(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Notes..." />
                  </div>
                </div>
              </div>

              {/* Shipping Mode Toggle */}
              <div className="bg-white border-2 border-gray-200 rounded-xl">
                <div className="bg-blue-50 px-4 py-3 border-b">
                  <h3 className="font-bold text-blue-800">üì¶ Mode {"d'exp√©dition"}</h3>
                </div>
                <div className="p-4 grid md:grid-cols-2 gap-4">
                  <button
                    onClick={() => setShippingMode('ups')}
                    className={`p-4 rounded-lg border-2 text-left transition-all ${shippingMode === 'ups' ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'}`}
                  >
                    <div className="font-bold text-lg mb-1">üì¶ UPS</div>
                    <p className="text-sm text-gray-600">Cr√©er √©tiquette UPS automatiquement</p>
                  </button>
                  <button
                    onClick={() => setShippingMode('custom')}
                    className={`p-4 rounded-lg border-2 text-left transition-all ${shippingMode === 'custom' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                  >
                    <div className="font-bold text-lg mb-1">‚úàÔ∏è Autre transporteur</div>
                    <p className="text-sm text-gray-600">Entrer un num√©ro de suivi manuellement</p>
                  </button>
                </div>
                {shippingMode === 'custom' && (
                  <div className="px-4 pb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">N¬∞ de suivi *</label>
                    <input type="text" value={customTracking} onChange={e => setCustomTracking(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono" placeholder="Num√©ro de suivi..." />
                  </div>
                )}
              </div>

              {/* Equipment Summary */}
              <div className="bg-gray-50 rounded-xl p-4">
                <h4 className="font-bold text-gray-700 mb-2">üìã R√©capitulatif Location</h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                  <div><span className="text-gray-500">Location:</span> <span className="font-mono font-bold text-[#00A651]">{rental.rental_number}</span></div>
                  <div><span className="text-gray-500">Client:</span> <span className="font-medium">{company.name}</span></div>
                  <div><span className="text-gray-500">Appareils:</span> <span className="font-medium">{items.length}</span></div>
                  <div><span className="text-gray-500">P√©riode:</span> <span className="font-medium">{days}j</span></div>
                </div>
                <div className="mt-3 flex flex-wrap gap-2">
                  {items.map((item, i) => (
                    <span key={i} className="px-2 py-1 bg-white border rounded text-xs font-mono">{item.model_name || item.device_model} ({item.serial_number || 'N/A'})</span>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* ===== STEP 2: UPS LABELS ===== */}
          {step === 2 && (
            <div className="bg-white border-2 rounded-xl p-6">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h3 className="font-bold text-lg">√âtiquettes UPS</h3>
                  <p className="text-gray-500">{shipAddress.postal_code} {shipAddress.city}</p>
                </div>
                <div className="text-right">
                  <p className="font-mono text-lg font-bold text-amber-600">{trackingNumber}</p>
                  <a href={`https://www.ups.com/track?tracknum=${trackingNumber}`} target="_blank" rel="noopener noreferrer" className="text-sm text-blue-500 hover:underline">Suivre ‚Üí</a>
                </div>
              </div>
              <div className="space-y-4">
                {(packageLabels.length > 0 ? packageLabels : [{ trackingNumber }]).map((pkg, pkgIdx) => (
                  <div key={pkgIdx} className="bg-gray-50 rounded-lg p-4 border">
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="text-2xl font-bold text-[#351C15]">UPS</div>
                        <div className="font-mono text-sm">{pkg.trackingNumber || trackingNumber}</div>
                        <div className="text-sm text-gray-500 mt-1">Colis {pkgIdx + 1} / {parcels}</div>
                      </div>
                      <div className="flex items-center gap-3">
                        <span className={labelsPrinted[pkgIdx] ? 'text-green-600 font-medium text-sm' : 'text-gray-400 text-sm'}>
                          {labelsPrinted[pkgIdx] ? '‚úì Imprim√©' : ''}
                        </span>
                        <button
                          onClick={() => printLabel(pkgIdx)}
                          className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium text-sm"
                        >üñ®Ô∏è Imprimer</button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              <div className="mt-4 pt-4 border-t flex justify-between items-center text-sm text-gray-600">
                <span>{shipAddress.company_name} ‚Ä¢ {parcels} colis ‚Ä¢ {weight} kg</span>
                <span className="text-gray-400">{rental.rental_number}</span>
              </div>
            </div>
          )}

          {/* ===== STEP 3: BL PREVIEW ===== */}
          {step === 3 && (() => {
            const blDate = getFrenchDate();
            return (
              <div>
                <div className="bg-gray-100 px-4 py-3 rounded-t-xl flex justify-between items-center">
                  <div>
                    <h3 className="font-bold">Bon de Livraison</h3>
                    <p className="text-sm text-gray-500">{items.length} appareil(s)</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className={blPrinted ? 'text-green-600 font-medium' : 'text-gray-400'}>{blPrinted ? '‚úì Imprim√©' : ''}</span>
                    <button onClick={() => setStep(1)} className="px-3 py-1 bg-white hover:bg-gray-50 border rounded text-sm">‚úèÔ∏è Modifier</button>
                    <button onClick={printBL} className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium">üñ®Ô∏è Imprimer BL</button>
                  </div>
                </div>
                <div className="bg-white border-2 border-t-0 rounded-b-xl overflow-hidden shadow-lg">
                  <div id="rental-bl-preview" style={{ fontFamily: 'Arial, sans-serif', fontSize: '11pt', color: '#333', padding: '25px 30px', maxWidth: '210mm', margin: '0 auto', background: 'white', height: '297mm', position: 'relative', overflow: 'hidden' }}>
                    <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', opacity: 0.12, pointerEvents: 'none', zIndex: 999 }}>
                      <img src="/images/logos/Lighthouse-Square-logo.png" alt="" style={{ width: '500px', height: 'auto' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:150px;font-weight:bold;color:#000">LWS</div>'; }} />
                    </div>
                    <div>
                      <div style={{ marginBottom: '15px', paddingBottom: '12px', borderBottom: '2px solid #333', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <img src="/images/logos/lighthouse-logo.png" alt="Lighthouse" style={{ height: '50px' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:24px;font-weight:bold;color:#333">LIGHTHOUSE<div style="font-size:10px;color:#666">FRANCE</div></div>'; }} />
                        <div style={{ textAlign: 'right' }}>
                          <div style={{ fontSize: '18pt', fontWeight: 'bold', color: '#2D5A7B' }}>BON DE LIVRAISON</div>
                          <div data-rental-bl-number="true" style={{ fontSize: '12pt', fontWeight: 'bold', color: '#2D5A7B', marginTop: '4px' }}>N¬∞ (auto)</div>
                          <div style={{ fontSize: '9pt', color: '#666', marginTop: '2px' }}>Location: {rental.rental_number}</div>
                        </div>
                      </div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', margin: '12px 0' }}>
                        <div><span style={{ color: '#666' }}>{biz.city || 'Cr√©teil'}, le</span> <strong>{blDate}</strong></div>
                      </div>
                      <div style={{ display: 'flex', gap: '15px', margin: '12px 0' }}>
                        <div style={{ flex: '1.5', background: 'rgba(248,249,250,0.85)', border: '1px solid #ddd', padding: '15px' }}>
                          <div style={{ fontSize: '9pt', color: '#666', textTransform: 'uppercase', fontWeight: '600', marginBottom: '5px' }}>Destinataire</div>
                          <div style={{ fontSize: '12pt', fontWeight: 'bold', marginBottom: '5px' }}>{shipAddress.company_name}</div>
                          {shipAddress.attention && <div>{"√Ä l'attention de: "}<strong>{shipAddress.attention}</strong></div>}
                          <div>{shipAddress.address_line1}</div>
                          <div>{shipAddress.postal_code} {shipAddress.city}</div>
                          <div>{shipAddress.country}</div>
                        </div>
                        <div style={{ flex: '1', background: 'rgba(248,249,250,0.85)', border: '1px solid #ddd', padding: '15px' }}>
                          <div style={{ fontSize: '9pt', color: '#666', textTransform: 'uppercase', fontWeight: '600', marginBottom: '5px' }}>R√©f√©rences Commande</div>
                          {bcNumber ? <div style={{ fontSize: '11pt', fontWeight: 'bold', color: '#2D5A7B' }}>{bcNumber}</div> : <div style={{ fontSize: '11pt', color: '#999' }}>‚Äî</div>}
                        </div>
                      </div>
                      <table style={{ width: '100%', borderCollapse: 'collapse', margin: '12px 0' }}>
                        <thead>
                          <tr style={{ background: 'rgba(51,51,51,0.35)' }}>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', width: '50px', fontWeight: 'bold' }}>Qt√©</th>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', fontWeight: 'bold' }}>D√©signation</th>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', width: '120px', fontWeight: 'bold' }}>N¬∞ S√©rie</th>
                            <th style={{ color: '#333', padding: '10px 12px', textAlign: 'left', fontSize: '10pt', width: '100px', fontWeight: 'bold' }}>Type</th>
                          </tr>
                        </thead>
                        <tbody>
                          {items.map((item, i) => (
                            <tr key={i}>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', textAlign: 'center', fontWeight: '600', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>1</td>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>Compteur de particules LIGHTHOUSE {item.model_name || item.device_model}</td>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', fontFamily: 'monospace', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>{item.serial_number || 'N/A'}</td>
                              <td style={{ padding: '10px 12px', borderBottom: '1px solid #ddd', fontSize: '10pt', background: i % 2 === 0 ? 'rgba(255,255,255,0.9)' : 'rgba(249,249,249,0.9)' }}>Location</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      <div style={{ margin: '15px 0' }}>
                        <div style={{ fontWeight: 'bold', fontSize: '11pt', marginBottom: '10px', borderBottom: '1px solid #333', paddingBottom: '5px' }}>{"Informations d'exp√©dition"}</div>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>Transporteur:</span><span style={{ fontWeight: '600' }}>{shippingMode === 'ups' ? 'UPS' : 'Autre'}</span></div>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>N¬∞ de suivi:</span><span style={{ fontWeight: '600', fontFamily: 'monospace' }}>{trackingNumber || 'N/A'}</span></div>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>Nombre de colis:</span><span style={{ fontWeight: '600' }}>{parcels}</span></div>
                          <div style={{ display: 'flex', padding: '6px 0' }}><span style={{ color: '#666', width: '130px' }}>Poids:</span><span style={{ fontWeight: '600' }}>{weight} kg</span></div>
                        </div>
                      </div>
                      <div style={{ fontSize: '10pt', marginTop: '12px', color: '#666' }}>
                        Pr√©par√© par: <strong style={{ color: '#333' }}>{employeeName}</strong>
                      </div>
                    </div>
                    <div style={{ position: 'absolute', bottom: '15px', left: '30px', right: '30px', paddingTop: '12px', borderTop: '1px solid #ccc' }}>
                      <div style={{ position: 'relative' }}>
                        <div style={{ position: 'absolute', left: '10px', top: '0' }}>
                          <img src="/images/logos/capcert-logo.png" alt="CAPCERT" style={{ height: '75px' }} onError={(e) => { e.target.outerHTML = '<div style="font-size:14px;color:#333;border:2px solid #333;padding:12px 16px;border-radius:6px;text-align:center"><strong>CAPCERT</strong><br/>ISO 9001</div>'; }} />
                        </div>
                        <div style={{ fontSize: '8pt', color: '#555', textAlign: 'center', lineHeight: '1.8' }}>
                          <strong style={{ color: '#333', fontSize: '8pt' }}>{biz.company_name || 'Lighthouse France SAS'}</strong> au capital de {biz.capital || '10 000'} ‚Ç¨<br/>
                          {biz.address || '16 rue Paul S√©journ√©'}, {biz.postal_code || '94000'} {biz.city || 'CR√âTEIL'} | T√©l. {biz.phone || '01 43 77 28 07'}<br/>
                          SIRET {biz.siret || '50178134800013'} | TVA {biz.tva || 'FR 86501781348'}<br/>
                          {biz.email || 'France@golighthouse.com'} | {biz.website || 'www.golighthouse.fr'}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })()}

          {/* ===== STEP 4: COMPLETE ===== */}
          {step === 4 && (
            <div className="text-center py-8">
              <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto text-4xl mb-4">‚úÖ</div>
              <h2 className="font-bold text-green-800 text-2xl mb-2">Documents d'exp√©dition cr√©√©s !</h2>
              <p className="text-gray-600 mb-6">√âtiquette UPS et Bon de Livraison enregistr√©s pour {company.name}</p>
              <div className="bg-green-50 rounded-lg p-6 max-w-md mx-auto space-y-3 text-left mb-6">
                {generatedBL?.blNumber && <div className="flex justify-between"><span className="text-gray-600">BL:</span><span className="font-mono font-bold">{generatedBL.blNumber}</span></div>}
                <div className="flex justify-between"><span className="text-gray-600">Suivi:</span><span className="font-mono font-bold">{trackingNumber}</span></div>
                {bcNumber && <div className="flex justify-between"><span className="text-gray-600">BC:</span><span className="font-mono font-bold">{bcNumber}</span></div>}
              </div>
              <div className="flex justify-center gap-3 mb-4">
                {generatedBL?.blUrl && <a href={generatedBL.blUrl} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">üìÑ T√©l√©charger BL</a>}
                {generatedBL?.upsLabelUrl && <a href={generatedBL.upsLabelUrl} target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg">üè∑Ô∏è √âtiquette UPS</a>}
              </div>
              <p className="text-sm text-gray-400 mt-4">üí° Vous pouvez marquer comme exp√©di√© depuis la fiche location</p>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t bg-gray-50 flex justify-between">
          {step === 1 && (
            <>
              <button onClick={onClose} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">Annuler</button>
              {shippingMode === 'custom' ? (
                <button
                  onClick={proceedWithCustomTracking}
                  disabled={!customTracking.trim() || !shipAddress.company_name || !shipAddress.address_line1}
                  className="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium disabled:opacity-50"
                >üìÑ Cr√©er Bon de Livraison ‚Üí</button>
              ) : (
                <button
                  onClick={createUPSLabels}
                  disabled={upsLoading || !shipAddress.company_name || !shipAddress.address_line1}
                  className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50 flex items-center gap-2"
                >
                  {upsLoading ? (
                    <><span className="animate-spin">‚è≥</span> Cr√©ation √©tiquette UPS...</>
                  ) : (
                    <>üì¶ Cr√©er √âtiquette UPS ‚Üí</>
                  )}
                </button>
              )}
            </>
          )}
          {step === 2 && (
            <>
              <button onClick={() => setStep(1)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">‚Üê Retour</button>
              <button onClick={() => setStep(3)} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">Continuer vers BL ‚Üí</button>
            </>
          )}
          {step === 3 && (
            <>
              <button onClick={() => setStep(shippingMode === 'custom' ? 1 : 2)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">‚Üê Retour</button>
              <button onClick={saveShippingDocs} disabled={saving} className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50">
                {saving ? '‚è≥ Traitement...' : 'üíæ Enregistrer Documents'}
              </button>
            </>
          )}
          {step === 4 && (
            <button onClick={onClose} className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold ml-auto">‚úì Fermer</button>
          )}
        </div>
      </div>
    </div>
  );
}

function RentalFullPage({ rental, inventory = [], onBack, notify, reload, businessSettings, profile, onOpenQuoteEditor, lang = 'fr' }) {
  const isAdmin = !!onOpenQuoteEditor;
  const t = k => k;
  const [activeTab, setActiveTab] = useState('overview');
  const [status, setStatus] = useState(rental.status);
  const [saving, setSaving] = useState(false);
  const [showShippingWizard, setShowShippingWizard] = useState(false);
  const [messages, setMessages] = useState([]);
  const [newMsg, setNewMsg] = useState('');
  const [sendingMsg, setSendingMsg] = useState(false);
  const [attachments, setAttachments] = useState([]);

  // Sync status when rental prop updates (after reload)
  useEffect(() => {
    setStatus(rental.status);
  }, [rental.status, rental.id]);
  
  // Return state (for return_pending handling)
  const [returnTracking, setReturnTracking] = useState(rental.return_tracking || '');
  const [returnCondition, setReturnCondition] = useState(rental.return_condition || 'good');
  const [returnNotes, setReturnNotes] = useState(rental.return_notes || '');
  
  const [showBCReview, setShowBCReview] = useState(false);
  const [docUploading, setDocUploading] = useState(false);
  const [showArchived, setShowArchived] = useState(false);

  // Computed values from rental data
  const company = rental.companies || {};
  const items = rental.rental_request_items || [];
  const days = Math.ceil((new Date(rental.end_date) - new Date(rental.start_date)) / (1000*60*60*24)) + 1;
  const qd = rental.quote_data || {};
  const totalHT = rental.quote_total_ht || (qd.totalHT) || items.reduce((s, i) => s + (parseFloat(i.line_total) || 0), 0);
  const totalRetailValue = (qd.quoteItems || items).reduce((s, i) => s + (parseFloat(i.retail_value) || 0), 0);

  // Computed shipping fields (stored in quote_data JSON)
  const shipping = qd.shippingInfo || {};
  const outboundTracking = rental.outbound_tracking || shipping.outbound_tracking || '';
  const blNumber = rental.bl_number || shipping.bl_number || qd.bl_number || '';
  const blUrl = rental.bl_url || shipping.bl_url || qd.bl_url || '';
  const upsLabelUrl = rental.ups_label_url || shipping.ups_label_url || qd.ups_label_url || '';
  const outboundShippedAt = rental.outbound_shipped_at || shipping.outbound_shipped_at || qd.outbound_shipped_at || '';
  const bcNumber = qd.bc_number || rental.bc_number || '';
  const bcApprovedAt = qd.bc_approved_at || rental.bc_approved_at || '';
  const quoteSentAt = qd.quote_sent_at || rental.quote_sent_at || '';
  const quoteUrl = qd.quote_url || rental.quote_url || '';
  const quoteNumber = qd.quote_number || rental.quote_number || '';
  const signedQuoteUrl = qd.signed_quote_url || rental.signed_quote_url || '';
  const bcFileUrl = qd.bc_file_url || rental.bc_file_url || '';
  const bcSignatureUrl = qd.bc_signature_url || rental.bc_signature_url || '';

  // Load messages & attachments
  useEffect(() => {
    const load = async () => {
      const { data: msgs } = await supabase.from('messages').select('*').eq('rental_request_id', rental.id).order('created_at', { ascending: true });
      if (msgs) setMessages(msgs);
      const { data: docs } = await supabase.from('request_attachments').select('*').eq('rental_request_id', rental.id);
      if (docs) setAttachments(docs);
    };
    load();
  }, [rental.id]);

  // ===== ACTIONS =====
  const updateStatus = async (newStatus, additionalData = {}) => {
    setSaving(true);
    try {
      // Separate quote_data fields from real columns
      const { return_condition, return_notes, return_tracking, ...otherData } = additionalData;
      const extraFields = {};
      if (return_condition || return_notes || return_tracking) {
        extraFields.quote_data = {
          ...(rental.quote_data || {}),
          return_condition, return_notes, return_tracking,
          ...(otherData.rental_started_at ? { rental_started_at: otherData.rental_started_at } : {}),
          ...(otherData.rental_ended_at ? { rental_ended_at: otherData.rental_ended_at } : {}),
          ...(otherData.returned_at ? { returned_at: otherData.returned_at } : {}),
          ...(otherData.completed_at ? { completed_at: otherData.completed_at } : {})
        };
      } else if (Object.keys(otherData).length > 0) {
        // Store timestamp data in quote_data too
        extraFields.quote_data = { ...(rental.quote_data || {}), ...otherData };
      }
      await supabase.from('rental_requests').update({ status: newStatus, ...extraFields }).eq('id', rental.id);
      notify('Statut mis √† jour !');
      setStatus(newStatus);
      reload();
    } catch (err) { notify('Erreur: ' + err.message, 'error'); }
    setSaving(false);
  };

  const sendMessage = async (e) => {
    e?.preventDefault();
    if (!newMsg.trim()) return;
    setSendingMsg(true);
    await supabase.from('messages').insert({
      rental_request_id: rental.id, sender_id: profile?.id,
      sender_name: profile?.full_name || (onOpenQuoteEditor ? 'Admin' : 'Client'), sender_type: onOpenQuoteEditor ? 'admin' : 'customer', content: newMsg.trim()
    });
    setNewMsg('');
    setSendingMsg(false);
    const { data: msgs } = await supabase.from('messages').select('*').eq('rental_request_id', rental.id).order('created_at', { ascending: true });
    if (msgs) setMessages(msgs);
  };
  const markInRental = async () => { await updateStatus('in_rental', { rental_started_at: new Date().toISOString() }); };
  const markReturnPending = async () => { await updateStatus('return_pending', { rental_ended_at: new Date().toISOString() }); };
  const markAsShipped = async () => {
    setSaving(true);
    try {
      const shippingInfo = qd.shippingInfo || {};
      const updatedQD = { ...qd, shippingInfo: { ...shippingInfo, outbound_shipped_at: new Date().toISOString(), shipped_by: profile?.full_name || 'Admin' }, outbound_shipped_at: new Date().toISOString() };
      const { error } = await supabase.from('rental_requests').update({ status: 'shipped', quote_data: updatedQD }).eq('id', rental.id);
      if (error) { notify('Erreur: ' + error.message, 'error'); }
      else { notify('üöö Location marqu√©e comme exp√©di√©e !'); setStatus('shipped'); reload(); }
    } catch (err) { notify('Erreur: ' + err.message, 'error'); }
    setSaving(false);
  };
  const markReturned = async () => {
    await updateStatus('returned', { returned_at: new Date().toISOString(), return_condition: returnCondition, return_notes: returnNotes, return_tracking: returnTracking || null });
    await supabase.from('rental_bookings').delete().eq('rental_request_id', rental.id);
  };
  const completeRental = async () => { await updateStatus('completed', { completed_at: new Date().toISOString() }); };

  // Document management (admin only)
  const uploadDocument = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setDocUploading(true);
    try {
      const fileName = `rental_${rental.rental_number}_${Date.now()}_${file.name}`;
      const filePath = `attachments/rentals/${rental.rental_number}/${fileName}`;
      const { error: uploadError } = await supabase.storage.from('documents').upload(filePath, file, { contentType: file.type });
      if (uploadError) throw uploadError;
      const { data: { publicUrl } } = supabase.storage.from('documents').getPublicUrl(filePath);
      await supabase.from('request_attachments').insert({
        rental_request_id: rental.id, file_name: file.name, file_url: publicUrl,
        file_type: file.type, uploaded_by: profile?.id, category: 'other'
      });
      const { data: docs } = await supabase.from('request_attachments').select('*').eq('rental_request_id', rental.id);
      if (docs) setAttachments(docs);
      notify('‚úÖ Document upload√© !');
    } catch (err) { notify('Erreur upload: ' + err.message, 'error'); }
    setDocUploading(false);
    e.target.value = '';
  };

  const archiveAttachment = async (att) => {
    try {
      await supabase.from('request_attachments').update({ category: 'archived_' + (att.category || 'other') }).eq('id', att.id);
      setAttachments(prev => prev.map(a => a.id === att.id ? { ...a, category: 'archived_' + (a.category || 'other') } : a));
      notify('üì¶ Document archiv√©');
    } catch (err) { notify('Erreur: ' + err.message, 'error'); }
  };

  const restoreAttachment = async (att) => {
    try {
      const origCategory = (att.category || '').replace('archived_', '');
      await supabase.from('request_attachments').update({ category: origCategory || 'other' }).eq('id', att.id);
      setAttachments(prev => prev.map(a => a.id === att.id ? { ...a, category: origCategory || 'other' } : a));
      notify('‚úÖ Document restaur√©');
    } catch (err) { notify('Erreur: ' + err.message, 'error'); }
  };

  const deleteAttachment = async (att) => {
    if (!window.confirm('Supprimer d√©finitivement ce document ?')) return;
    try {
      await supabase.from('request_attachments').delete().eq('id', att.id);
      setAttachments(prev => prev.filter(a => a.id !== att.id));
      notify('üóëÔ∏è Document supprim√©');
    } catch (err) { notify('Erreur: ' + err.message, 'error'); }
  };

  // ===== PROGRESS BAR (inline, rental-specific) =====
  const rentalSteps = [
    { id: 'submitted', label: 'Soumis' },
    { id: 'quote', label: 'Devis' },
    { id: 'bc', label: 'BC' },
    { id: 'shipped', label: 'Exp√©di√©' },
    { id: 'in_rental', label: 'En location' },
    { id: 'returned', label: 'Retourn√©' }
  ];
  const stepMap = {
    'requested': 0, 'pending_quote_review': 1, 'quote_sent': 1,
    'waiting_bc': 2, 'bc_review': 2, 'bc_approved': 2,
    'shipped': 3, 'in_rental': 4,
    'return_pending': 5, 'returned': 5, 'completed': 5
  };
  const currentStepIndex = stepMap[status] ?? 0;

  // Status styles
  const getStatusStyle = (s) => {
    const styles = {
      requested: { bg: 'bg-amber-100', text: 'text-amber-700', label: 'Nouvelle demande' },
      pending_quote_review: { bg: 'bg-amber-100', text: 'text-amber-700', label: 'Devis en v√©rification' },
      quote_sent: { bg: 'bg-blue-100', text: 'text-blue-700', label: 'Devis envoy√©' },
      waiting_bc: { bg: 'bg-amber-100', text: 'text-amber-700', label: 'Attente BC' },
      bc_review: { bg: 'bg-orange-100', text: 'text-orange-700', label: 'BC √† v√©rifier' },
      bc_approved: { bg: 'bg-green-100', text: 'text-green-700', label: 'BC approuv√©' },
      shipped: { bg: 'bg-cyan-100', text: 'text-cyan-700', label: 'Exp√©di√©' },
      in_rental: { bg: 'bg-purple-100', text: 'text-purple-700', label: 'En location' },
      return_pending: { bg: 'bg-orange-100', text: 'text-orange-700', label: 'Retour attendu' },
      returned: { bg: 'bg-teal-100', text: 'text-teal-700', label: 'Retourn√©' },
      completed: { bg: 'bg-green-100', text: 'text-green-700', label: 'Termin√©' },
      cancelled: { bg: 'bg-red-100', text: 'text-red-700', label: 'Annul√©' }
    };
    return styles[s] || { bg: 'bg-gray-100', text: 'text-gray-700', label: s };
  };
  const style = getStatusStyle(status);

  // Build timeline events - only progress bar milestones
  const timeline = [];
  if (rental.submitted_at || rental.created_at) timeline.push({ date: rental.submitted_at || rental.created_at, icon: 'üìù', label: 'Demande soumise' });
  if (quoteSentAt) timeline.push({ date: quoteSentAt, icon: 'üì®', label: 'Devis envoy√©' });
  if (rental.quote_approved_at) timeline.push({ date: rental.quote_approved_at, icon: '‚úÖ', label: 'Devis approuv√©' });
  if (bcApprovedAt) timeline.push({ date: bcApprovedAt, icon: 'üìã', label: 'BC approuv√©', detail: bcNumber ? `N¬∞ ${bcNumber}` : undefined });
  if (outboundShippedAt) timeline.push({ date: outboundShippedAt, icon: 'üöö', label: 'Exp√©di√©', detail: blNumber ? `BL: ${blNumber}` : undefined });
  if ((qd.rental_started_at || rental.rental_started_at)) timeline.push({ date: (qd.rental_started_at || rental.rental_started_at), icon: 'üì¶', label: 'En location' });
  if ((qd.returned_at || rental.returned_at)) timeline.push({ date: (qd.returned_at || rental.returned_at), icon: 'üì•', label: 'Retourn√©' });
  if ((qd.completed_at || rental.completed_at)) timeline.push({ date: (qd.completed_at || rental.completed_at), icon: 'üèÅ', label: 'Cl√¥tur√©' });
  timeline.sort((a, b) => new Date(a.date) - new Date(b.date));

  const address = rental.shipping_address || {};

  // Shipping wizard overlay
  return (
    <div className="min-h-screen bg-gray-100">
      {showShippingWizard && (
        <RentalShippingModal
          rental={rental}
          company={company}
          address={address}
          items={items}
          days={days}
          profile={profile}
          businessSettings={businessSettings}
          notify={notify}
          reload={reload}
          onClose={() => setShowShippingWizard(false)}
          lang={lang}
        />
      )}
      {/* ===== STICKY HEADER ===== */}
      <div className="sticky top-0 z-10 bg-white border-b shadow-sm">
        <div className="px-6 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg text-gray-500 hover:text-gray-700 transition-colors">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
              </button>
              <div>
                <div className="flex items-center gap-3">
                  <h1 className="text-2xl font-bold text-gray-800">{rental.rental_number}</h1>
                  <span className={`px-3 py-1 rounded-full text-xs font-bold ${style.bg} ${style.text}`}>{style.label}</span>
                </div>
                <p className="text-gray-500">{company.name} ‚Ä¢ {days} jours de location</p>
              </div>
            </div>

            {/* Header Action Buttons */}
            <div className="flex items-center gap-3">
              {(['requested', 'quote_revision_requested', 'quote_rejected'].includes(status) || (status === 'requested' && rental.quote_rejection_notes)) && (
                <button onClick={() => onOpenQuoteEditor && onOpenQuoteEditor(rental)}
                  className={`px-4 py-2 ${status === 'quote_revision_requested' ? 'bg-red-500 hover:bg-red-600' : 'bg-[#00A651] hover:bg-[#008f45]'} text-white rounded-lg font-medium`}>
                  üí∞ {status === 'quote_revision_requested' ? 'R√©viser Devis' : 'Cr√©er Devis'}
                </button>
              )}
              {status === 'bc_review' && (
                <button onClick={() => setShowBCReview(true)} className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium">üîç Examiner BC</button>
              )}
              {status === 'bc_approved' && !outboundTracking && (
                <button onClick={() => setShowShippingWizard(true)} className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">üì¶ Pr√©parer Exp√©dition</button>
              )}
              {status === 'bc_approved' && outboundTracking && (
                <>
                  <button onClick={markAsShipped} disabled={saving} className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold disabled:opacity-50">{saving ? '‚è≥...' : 'üöö Marquer Exp√©di√©'}</button>
                  <button onClick={() => setShowShippingWizard(true)} className="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm">üì¶ Refaire</button>
                </>
              )}
              {status === 'shipped' && (
                <button onClick={markInRental} disabled={saving} className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium disabled:opacity-50">‚úÖ Confirmer r√©ception</button>
              )}
              {status === 'in_rental' && (
                <button onClick={markReturnPending} disabled={saving} className="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium disabled:opacity-50">üì¶ Fin de p√©riode</button>
              )}
            </div>
          </div>

          {/* Progress Bar */}
          <div className="flex items-center mt-3">
            {rentalSteps.map((step, index) => {
              const isCompleted = index < currentStepIndex;
              const isCurrent = index === currentStepIndex;
              const isLast = index === rentalSteps.length - 1;
              return (
                <div key={step.id} className="flex items-center flex-1">
                  <div className={`relative flex items-center justify-center flex-1 py-1.5 px-1 text-xs font-medium ${isCompleted ? 'bg-[#3B7AB4] text-white' : isCurrent ? 'bg-[#8B5CF6] text-white' : 'bg-gray-200 text-gray-500'} ${index === 0 ? 'rounded-l-md' : ''} ${isLast ? 'rounded-r-md' : ''}`}
                    style={{ clipPath: isLast ? 'polygon(0 0, 100% 0, 100% 100%, 0 100%, 8px 50%)' : index === 0 ? 'polygon(0 0, calc(100% - 8px) 0, 100% 50%, calc(100% - 8px) 100%, 0 100%)' : 'polygon(0 0, calc(100% - 8px) 0, 100% 50%, calc(100% - 8px) 100%, 0 100%, 8px 50%)' }}>
                    <span className="truncate px-1">{step.label}</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* ===== MAIN CONTENT ===== */}
      <div className="p-6">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column - Tabs */}
          <div className="lg:col-span-2 space-y-6">
            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
              {/* Tab Bar */}
              <div className="flex border-b">
                {[
                  { id: 'overview', label: 'Aper√ßu', icon: 'üìã' },
                  { id: 'documents', label: 'Documents', icon: 'üìÑ' },
                  { id: 'messages', label: 'Messages', icon: 'üí¨', badge: messages.filter(m => m.sender_role === 'client').length },
                  { id: 'timeline', label: 'Historique', icon: 'üìú' }
                ].map(tab => (
                  <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                    className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                      activeTab === tab.id ? 'bg-purple-50 text-purple-700 border-b-2 border-purple-500' : 'text-gray-500 hover:bg-gray-50'
                    }`}>
                    <span>{tab.icon}</span> {tab.label}
                    {tab.badge > 0 && <span className="px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full">{tab.badge}</span>}
                  </button>
                ))}
              </div>

              <div className="p-6">
          {/* ===== OVERVIEW TAB ===== */}
          {activeTab === 'overview' && (
            <div className="space-y-6">
              {/* BC Review needed banner */}
              {status === 'bc_review' && (
                <div className="bg-red-50 border-2 border-red-300 rounded-lg p-4 flex items-center gap-4">
                  <div className="w-12 h-12 bg-red-500 rounded-lg flex items-center justify-center text-2xl text-white animate-pulse">‚ö†Ô∏è</div>
                  <div className="flex-1">
                    <p className="font-bold text-red-800 text-lg">Bon de Commande √† V√©rifier</p>
                    <p className="text-red-600">Soumis le {rental.bc_submitted_at ? new Date(rental.bc_submitted_at).toLocaleDateString('fr-FR') : '‚Äî'} par {rental.bc_signed_by || '‚Äî'}</p>
                  </div>
                  <button onClick={() => setActiveTab('documents')} className="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium">üîç Examiner</button>
                </div>
              )}
              {/* Key Info Grid */}
              <div className="grid md:grid-cols-3 gap-4">
                <div className={`rounded-lg p-4 border ${status === 'in_rental' && new Date(rental.end_date) < new Date() ? 'bg-red-50 border-red-300' : 'bg-purple-50 border-purple-200'}`}>
                  <p className="text-xs text-purple-600 uppercase font-medium">P√©riode</p>
                  <p className="font-bold text-purple-800">{new Date(rental.start_date).toLocaleDateString('fr-FR')} ‚Üí {new Date(rental.end_date).toLocaleDateString('fr-FR')}</p>
                  <p className="text-sm text-purple-600">{days} jours</p>
                  {['in_rental', 'shipped'].includes(status) && (() => {
                    const daysLeft = Math.ceil((new Date(rental.end_date) - new Date()) / (1000*60*60*24));
                    const isOverdue = daysLeft < 0;
                    return isOverdue 
                      ? <p className="text-sm font-bold text-red-600 mt-1">üö® {Math.abs(daysLeft)} jour{Math.abs(daysLeft) > 1 ? 's' : ''} de retard !</p>
                      : daysLeft <= 5 
                        ? <p className="text-sm font-bold text-orange-600 mt-1">‚è∞ {daysLeft} jour{daysLeft > 1 ? 's' : ''} restant{daysLeft > 1 ? 's' : ''}</p>
                        : <p className="text-sm text-green-600 mt-1">‚úÖ {daysLeft} jours restants</p>;
                  })()}
                </div>
                <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                  <p className="text-xs text-blue-600 uppercase font-medium">Total HT</p>
                  <p className="text-2xl font-bold text-blue-800">{(rental.quote_total_ht || totalHT || 0).toFixed(2)} ‚Ç¨</p>
                  {totalRetailValue > 0 && <p className="text-xs text-blue-500">Valeur √† assurer: {totalRetailValue.toFixed(2)} ‚Ç¨</p>}
                </div>
                <div className="bg-gray-50 rounded-lg p-4 border">
                  <p className="text-xs text-gray-500 uppercase font-medium">Client</p>
                  <p className="font-bold">{company.name}</p>
                  <p className="text-sm text-gray-500">{company.email}</p>
                </div>
              </div>

              {/* Equipment */}
              <div>
                <h3 className="font-bold text-gray-800 mb-3">üì¶ √âquipements ({items.length})</h3>
                <div className="bg-gray-50 rounded-lg divide-y border">
                  {items.map((item, idx) => (
                    <div key={idx} className="p-3 flex justify-between items-center">
                      <div>
                        <p className="font-medium">{item.item_name}</p>
                        {item.serial_number && !(item.item_name || '').includes(item.serial_number) && <p className="text-xs text-gray-500 font-mono">S/N: {item.serial_number}</p>}
                        <p className="text-xs text-gray-400">{item.rental_days || days}j √ó ‚Ç¨{item.applied_rate} ({item.rate_type})</p>
                      </div>
                      <p className="font-bold text-[#8B5CF6]">{(item.line_total || 0).toFixed(2)} ‚Ç¨</p>
                    </div>
                  ))}
                </div>
              </div>

              {/* Shipping Address */}
              {address.address_line1 && (
                <div className="bg-gray-50 rounded-lg p-4 border">
                  <h3 className="font-bold text-gray-700 mb-2">üìç Adresse de livraison</h3>
                  <p className="text-sm">{address.company_name || company.name}</p>
                  {address.attention && <p className="text-sm text-gray-500">√Ä l'att. {address.attention}</p>}
                  <p className="text-sm">{address.address_line1}</p>
                  <p className="text-sm">{address.postal_code} {address.city}</p>
                  <p className="text-sm text-gray-400">{address.country || 'France'}</p>
                </div>
              )}

              {/* Customer Notes */}
              {rental.customer_notes && (
                <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                  <h3 className="font-bold text-amber-800 mb-1">üìù Notes client</h3>
                  <p className="text-sm text-amber-700">{rental.customer_notes}</p>
                </div>
              )}

              {/* Tracking Info */}
              {outboundTracking && (
                <div className="bg-cyan-50 rounded-lg p-4 border border-cyan-200">
                  <h3 className="font-bold text-cyan-800 mb-2">üöö Exp√©dition</h3>
                  <div className="grid md:grid-cols-3 gap-4 text-sm">
                    <div><p className="text-xs text-gray-500">N¬∞ suivi</p><p className="font-mono font-bold">{outboundTracking}</p></div>
                    {blNumber && <div><p className="text-xs text-gray-500">BL</p><p className="font-mono font-bold">{blNumber}</p></div>}
                    {outboundShippedAt && <div><p className="text-xs text-gray-500">Date</p><p className="font-medium">{new Date(outboundShippedAt).toLocaleDateString('fr-FR')}</p></div>}
                  </div>
                </div>
              )}

              {/* Return Info */}
              {(qd.returned_at || rental.returned_at) && (
                <div className="bg-teal-50 rounded-lg p-4 border border-teal-200">
                  <h3 className="font-bold text-teal-800 mb-2">üì• Retour</h3>
                  <div className="grid md:grid-cols-3 gap-4 text-sm">
                    <div><p className="text-xs text-gray-500">Date retour</p><p className="font-medium">{new Date((qd.returned_at || rental.returned_at)).toLocaleDateString('fr-FR')}</p></div>
                    <div><p className="text-xs text-gray-500">√âtat</p><p className="font-medium">{(qd.return_condition || rental.return_condition) === 'good' ? '‚úÖ Bon √©tat' : (qd.return_condition || rental.return_condition) === 'damaged' ? '‚ö†Ô∏è Endommag√©' : '‚ùì √âl√©ments manquants'}</p></div>
                    {(qd.return_notes || rental.return_notes) && <div><p className="text-xs text-gray-500">Notes</p><p className="text-sm">{(qd.return_notes || rental.return_notes)}</p></div>}
                  </div>
                </div>
              )}
            </div>
          )}


          {/* ===== DOCUMENTS TAB ===== */}
          {activeTab === 'documents' && (() => {
            const activeAttachments = attachments.filter(a => !(a.category || '').startsWith('archived_') && !(a.category || '').startsWith('internal_archived') && !a.archived_at);
            const archivedAttachments = attachments.filter(a => (a.category || '').startsWith('archived_') || (a.category || '').startsWith('internal_archived') || a.archived_at);
            // Filter out system-category docs from "additional" list (they're shown as system docs above)
            const systemCategories = ['bon_commande', 'signed_quote', 'devis_signe', 'bon_livraison', 'ups_label'];
            const additionalDocs = activeAttachments.filter(a => !systemCategories.includes(a.category) && !systemCategories.includes((a.category || '').replace('internal_', '')));

            return (
            <div className="space-y-4">
              {/* BC Review Banner */}
              {isAdmin && status === 'bc_review' && (
                <div className="bg-red-50 border-2 border-red-300 rounded-lg p-4 flex items-center gap-4">
                  <div className="w-12 h-12 bg-red-500 rounded-lg flex items-center justify-center text-2xl text-white animate-pulse">‚ö†Ô∏è</div>
                  <div className="flex-1"><p className="font-bold text-red-800 text-lg">Bon de Commande √† V√©rifier</p></div>
                  <button onClick={() => setShowBCReview(true)} className="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium">üîç Examiner BC</button>
                </div>
              )}

              <h3 className="font-bold text-gray-800">üìÅ Documents</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">

                {/* === 1. DEVIS (Quote PDF) === */}
                {quoteUrl && (
                  <a href={quoteUrl} target="_blank" rel="noopener noreferrer"
                     className="flex items-center gap-4 p-4 border rounded-lg hover:bg-blue-50 transition-colors">
                    <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üí∞</div>
                    <div>
                      <p className="font-medium text-gray-800">Devis Location</p>
                      <p className="text-sm text-blue-600">N¬∞ {quoteNumber || rental.rental_number}</p>
                      {quoteSentAt && <p className="text-xs text-gray-400">Envoy√© le {new Date(quoteSentAt).toLocaleDateString('fr-FR')}</p>}
                    </div>
                  </a>
                )}

                {/* === 2. DEVIS SIGN√â / BON DE COMMANDE === */}
                {signedQuoteUrl && (
                  <a href={signedQuoteUrl} target="_blank" rel="noopener noreferrer"
                     className="flex items-center gap-4 p-4 border rounded-lg hover:bg-green-50 transition-colors border-green-200">
                    <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl shrink-0">‚úÖ</div>
                    <div>
                      <p className="font-medium text-gray-800">Devis Sign√© / BC</p>
                      <p className="text-sm text-green-600">{bcNumber ? `N¬∞ ${bcNumber}` : 'Sign√©'}</p>
                      {bcApprovedAt && <p className="text-xs text-gray-400">Approuv√© le {new Date(bcApprovedAt).toLocaleDateString('fr-FR')}</p>}
                    </div>
                  </a>
                )}

                {/* === 3. BON DE COMMANDE (client uploaded BC, different from signed) === */}
                {bcFileUrl && bcFileUrl !== signedQuoteUrl && (
                  <a href={bcFileUrl} target="_blank" rel="noopener noreferrer"
                     className="flex items-center gap-4 p-4 border rounded-lg hover:bg-purple-50 transition-colors border-purple-200">
                    <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìù</div>
                    <div>
                      <p className="font-medium text-gray-800">Bon de Commande Client</p>
                      <p className="text-sm text-purple-600">{bcNumber ? `N¬∞ ${bcNumber}` : 'BC client'}</p>
                    </div>
                  </a>
                )}

                {/* === 4. BON DE LIVRAISON === */}
                {blUrl && (
                  <a href={blUrl} target="_blank" rel="noopener noreferrer"
                     className="flex items-center gap-4 p-4 border rounded-lg hover:bg-cyan-50 transition-colors">
                    <div className="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üìÑ</div>
                    <div>
                      <p className="font-medium text-gray-800">Bon de Livraison</p>
                      <p className="text-sm text-cyan-600">{blNumber ? `N¬∞ ${blNumber}` : 'BL'}</p>
                    </div>
                  </a>
                )}

                {/* === 5. UPS LABEL === */}
                {upsLabelUrl && (
                  <a href={upsLabelUrl} target="_blank" rel="noopener noreferrer"
                     className="flex items-center gap-4 p-4 border rounded-lg hover:bg-amber-50 transition-colors">
                    <div className="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center text-2xl shrink-0">üè∑Ô∏è</div>
                    <div>
                      <p className="font-medium text-gray-800">√âtiquette UPS</p>
                      <p className="text-sm text-amber-600">{outboundTracking || "Label d'exp√©dition"}</p>
                    </div>
                  </a>
                )}

                {/* === 6. BC Signature Image === */}
                {bcSignatureUrl && (
                  <a href={bcSignatureUrl} target="_blank" rel="noopener noreferrer"
                     className="flex items-center gap-4 p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                    <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-2xl shrink-0">‚úçÔ∏è</div>
                    <div>
                      <p className="font-medium text-gray-800">Signature Client</p>
                      <p className="text-sm text-gray-500">{rental.bc_signed_by || '‚Äî'}</p>
                    </div>
                  </a>
                )}
              </div>

              {/* === ADDITIONAL DOCUMENTS (uploaded by admin) === */}
              {additionalDocs.length > 0 && (
                <div className="mt-4">
                  <h4 className="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2">Documents suppl√©mentaires</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {additionalDocs.map(doc => {
                      const isInternal = (doc.category || '').startsWith('internal_');
                      return (
                        <div key={doc.id} className={`flex items-center gap-3 p-3 border rounded-lg ${isInternal ? 'bg-gray-50 border-gray-300 border-dashed' : 'bg-white'} group`}>
                          <a href={doc.file_url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 flex-1 min-w-0 hover:opacity-80">
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-lg ${isInternal ? 'bg-gray-200' : 'bg-blue-100'}`}>
                              {isInternal ? 'üîí' : 'üìÑ'}
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="font-medium text-gray-800 truncate text-sm">{doc.file_name || 'Document'}</p>
                              <p className="text-xs text-gray-400">
                                {isInternal ? 'üîí Interne' : 'üëÅÔ∏è Visible client'} ‚Ä¢ {new Date(doc.created_at).toLocaleDateString('fr-FR')}
                              </p>
                            </div>
                          </a>
                          {isAdmin && (
                            <div className="flex items-center gap-1 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                              <button
                                onClick={async () => {
                                  const newCat = isInternal ? (doc.category || '').replace('internal_', '') || 'other' : 'internal_' + (doc.category || 'other');
                                  await supabase.from('request_attachments').update({ category: newCat }).eq('id', doc.id);
                                  setAttachments(prev => prev.map(a => a.id === doc.id ? { ...a, category: newCat } : a));
                                  notify(isInternal ? 'üëÅÔ∏è Visible au client' : 'üîí Masqu√© au client');
                                }}
                                className={`p-1.5 rounded-lg transition-colors ${isInternal ? 'text-gray-400 hover:bg-blue-50 hover:text-blue-600' : 'text-blue-500 hover:bg-gray-100 hover:text-gray-600'}`}
                                title={isInternal ? 'Rendre visible au client' : 'Masquer au client'}
                              >
                                {isInternal ? (
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" /></svg>
                                ) : (
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                )}
                              </button>
                              <button onClick={() => archiveAttachment(doc)} className="p-1.5 text-gray-400 hover:text-amber-600 hover:bg-amber-50 rounded" title="Archiver">üì¶</button>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* === ARCHIVED DOCUMENTS === */}
              {isAdmin && archivedAttachments.length > 0 && (
                <div className="mt-4">
                  <button onClick={() => setShowArchived(!showArchived)} className="flex items-center gap-2 text-sm text-gray-400 hover:text-gray-600 transition-colors">
                    <svg className={`w-3 h-3 transition-transform ${showArchived ? 'rotate-90' : ''}`} fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
                    </svg>
                    üì¶ Archives ({archivedAttachments.length})
                  </button>
                  {showArchived && (
                    <div className="mt-2 space-y-2">
                      {archivedAttachments.map(doc => (
                        <div key={doc.id} className="flex items-center gap-3 p-3 border border-dashed border-gray-300 rounded-lg bg-gray-50/50">
                          <div className="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center text-sm">üì¶</div>
                          <a href={doc.file_url} target="_blank" rel="noopener noreferrer" className="flex-1 min-w-0 hover:opacity-80">
                            <p className="text-sm font-medium text-gray-500 truncate">{(doc.file_name || 'Document').replace('[Archiv√©] ', '')}</p>
                            <p className="text-xs text-gray-400">Archiv√© {doc.archived_at ? new Date(doc.archived_at).toLocaleDateString('fr-FR') : ''}</p>
                          </a>
                          <button onClick={() => restoreAttachment(doc)} className="px-3 py-1.5 text-xs font-medium text-amber-700 bg-amber-50 border border-amber-200 rounded-lg hover:bg-amber-100 transition-colors shrink-0">
                            ‚Ü© Restaurer
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Add Document Button */}
              {isAdmin && (
                <div className="mt-4 pt-4 border-t border-gray-200">
                  <label className="flex items-center gap-2 px-4 py-2.5 bg-[#8B5CF6] text-white rounded-lg hover:bg-[#7C3AED] transition-colors font-medium text-sm cursor-pointer w-fit">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                    {docUploading ? '‚è≥ Upload...' : 'üì§ Ajouter un document'}
                    <input type="file" className="hidden" onChange={uploadDocument} disabled={docUploading} />
                  </label>
                </div>
              )}

              {/* No docs at all */}
              {!quoteUrl && !signedQuoteUrl && !bcFileUrl && !blUrl && !upsLabelUrl && additionalDocs.length === 0 && (
                <div className="text-center py-8 text-gray-400"><p className="text-4xl mb-2">üìÑ</p><p>Aucun document</p></div>
              )}
            </div>
            );
          })()}
          {/* ===== MESSAGES TAB ===== */}
          {activeTab === 'messages' && (
            <div>
              <div className="h-[400px] overflow-y-auto mb-4 space-y-3">
                {messages.length === 0 ? (
                  <div className="text-center py-12 text-gray-400"><p className="text-4xl mb-2">üí¨</p><p>Aucun message</p></div>
                ) : messages.map(msg => {
                  const isMe = msg.sender_id === profile?.id;
                  const isAdminMsg = msg.sender_type === 'admin' || msg.sender_role === 'admin';
                  return (
                    <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                      <div className={`max-w-[70%] rounded-lg p-3 ${isMe ? 'bg-[#8B5CF6] text-white' : 'bg-gray-100 text-gray-800'}`}>
                        <p className={`text-xs font-medium mb-1 ${isMe ? 'text-white/70' : 'text-[#8B5CF6]'}`}>{msg.sender_name || (isAdminMsg ? 'Admin' : 'Client')}</p>
                        <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
                        {msg.attachment_url && <a href={msg.attachment_url} target="_blank" rel="noopener noreferrer" className={`text-xs mt-2 block ${isMe ? 'text-white/80' : 'text-blue-600'}`}>üìé {msg.attachment_name || 'Fichier'}</a>}
                        <p className={`text-xs mt-1 ${isMe ? 'text-white/60' : 'text-gray-400'}`}>{new Date(msg.created_at).toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</p>
                      </div>
                    </div>
                  );
                })}
              </div>
              <form onSubmit={sendMessage} className="flex gap-2">
                <input type="text" value={newMsg} onChange={e => setNewMsg(e.target.value)} placeholder="√âcrire un message au client..." className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#8B5CF6]" />
                <button type="submit" disabled={!newMsg.trim() || sendingMsg} className="px-6 py-2 bg-[#8B5CF6] text-white rounded-lg font-medium disabled:opacity-50">{sendingMsg ? '...' : 'Envoyer'}</button>
              </form>
            </div>
          )}

          {/* ===== TIMELINE TAB ===== */}
          {activeTab === 'timeline' && (
            <div>
              <h3 className="font-bold text-gray-800 mb-4">üìú Historique complet</h3>
              {timeline.length === 0 ? (
                <div className="text-center py-8 text-gray-400"><p>Aucun √©v√©nement</p></div>
              ) : (
                <div className="relative">
                  <div className="absolute left-6 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                  <div className="space-y-6">
                    {timeline.map((event, idx) => (
                      <div key={idx} className="flex gap-4 items-start relative">
                        <div className="w-12 h-12 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center text-lg z-10 shrink-0">{event.icon}</div>
                        <div className="flex-1 bg-gray-50 rounded-lg p-3 border">
                          <div className="flex justify-between items-start">
                            <p className="font-bold text-gray-800">{event.label}</p>
                            <p className="text-xs text-gray-400">{new Date(event.date).toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                          </div>
                          {event.detail && <p className="text-sm text-gray-600 mt-1">{event.detail}</p>}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
              </div>
            </div>
          </div>

          {/* Right Column - Client Info & Actions */}
          <div className="space-y-6">
            {/* Client Info Card */}
            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <div className="bg-gradient-to-r from-[#8B5CF6] to-[#7C3AED] px-4 py-3">
                <h3 className="font-bold text-white">üè¢ Client</h3>
              </div>
              <div className="p-4 space-y-3">
                <div>
                  <p className="text-xs text-gray-500 uppercase tracking-wide">Entreprise</p>
                  <p className="font-bold text-gray-800">{company.name || '‚Äî'}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500 uppercase tracking-wide">Contact</p>
                  <p className="font-medium text-gray-700">{company.contact_name || '‚Äî'}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500 uppercase tracking-wide">T√©l√©phone</p>
                  <p className="font-medium text-gray-700">{company.phone || '‚Äî'}</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500 uppercase tracking-wide">Email</p>
                  <p className="font-medium text-gray-700 truncate">{company.email || '‚Äî'}</p>
                </div>
                {address.address_line1 && (
                  <div className="pt-2 border-t">
                    <p className="text-xs text-gray-500 uppercase tracking-wide mb-1">Adresse de livraison</p>
                    <p className="text-sm text-gray-700">
                      {address.company_name || company.name}<br/>
                      {address.attention && <>{address.attention}<br/></>}
                      {address.address_line1}<br/>
                      {address.postal_code} {address.city}
                    </p>
                  </div>
                )}
              </div>
            </div>

            {/* Rental Details Card */}
            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <div className="bg-gradient-to-r from-[#2D5A7B] to-[#2d4a6f] px-4 py-3">
                <h3 className="font-bold text-white">üìã D√©tails location</h3>
              </div>
              <div className="p-4 space-y-3">
                <div>
                  <p className="text-xs text-gray-500 uppercase">P√©riode</p>
                  <p className="font-bold">{new Date(rental.start_date).toLocaleDateString('fr-FR')} ‚Üí {new Date(rental.end_date).toLocaleDateString('fr-FR')}</p>
                  <p className="text-sm text-gray-600">{days} jours</p>
                </div>
                <div>
                  <p className="text-xs text-gray-500 uppercase">Total HT</p>
                  <p className="text-xl font-bold text-[#00A651]">{(rental.quote_total_ht || totalHT || 0).toFixed(2)} ‚Ç¨</p>
                </div>
                {bcNumber && (
                  <div>
                    <p className="text-xs text-gray-500 uppercase">BC N¬∞</p>
                    <p className="font-mono font-bold">{bcNumber}</p>
                  </div>
                )}
                {blNumber && (
                  <div>
                    <p className="text-xs text-gray-500 uppercase">BL N¬∞</p>
                    <p className="font-mono font-bold">{blNumber}</p>
                  </div>
                )}
                {outboundTracking && (
                  <div className="pt-2 border-t">
                    <p className="text-xs text-gray-500 uppercase mb-1">Suivi UPS</p>
                    <p className="font-mono text-sm font-bold">{outboundTracking}</p>
                    <a href={`https://www.ups.com/track?tracknum=${outboundTracking}`} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-600 hover:underline">üìç Suivre le colis ‚Üí</a>
                  </div>
                )}
              </div>
            </div>

            {/* Quick Actions Card */}
            <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
              <div className="bg-[#8B5CF6] px-4 py-3">
                <h3 className="font-bold text-white">‚ö° Actions</h3>
              </div>
              <div className="p-4 space-y-2">
                {(['requested', 'quote_revision_requested'].includes(status)) && (
                  <button onClick={() => onOpenQuoteEditor && onOpenQuoteEditor(rental)}
                    className="w-full px-4 py-2 bg-[#00A651] hover:bg-[#008f45] text-white rounded-lg font-medium">
                    üí∞ {status === 'quote_revision_requested' ? 'R√©viser Devis' : 'Cr√©er Devis'}
                  </button>
                )}
                {status === 'bc_review' && (
                  <button onClick={() => setShowBCReview(true)} className="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium">üîç Examiner BC</button>
                )}
                {status === 'bc_approved' && !outboundTracking && (
                  <button onClick={() => setShowShippingWizard(true)} className="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium">üì¶ Pr√©parer Exp√©dition</button>
                )}
                {status === 'bc_approved' && outboundTracking && (
                  <div className="space-y-2">
                    <button onClick={markAsShipped} disabled={saving} className="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold disabled:opacity-50">{saving ? '‚è≥...' : 'üöö Marquer Exp√©di√©'}</button>
                    <button onClick={() => setShowShippingWizard(true)} className="w-full px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-sm">üì¶ Refaire exp√©dition</button>
                  </div>
                )}
                {status === 'shipped' && (
                  <button onClick={markInRental} disabled={saving} className="w-full px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium disabled:opacity-50">‚úÖ Confirmer r√©ception</button>
                )}
                {status === 'in_rental' && (
                  <button onClick={markReturnPending} disabled={saving} className="w-full px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium disabled:opacity-50">üì¶ Fin de p√©riode</button>
                )}
                {status === 'return_pending' && (
                  <button onClick={markReturned} disabled={saving} className="w-full px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white rounded-lg font-medium disabled:opacity-50">üì• Confirmer retour</button>
                )}
                {status === 'returned' && (
                  <button onClick={completeRental} disabled={saving} className="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium disabled:opacity-50">üèÅ Cl√¥turer</button>
                )}
                {outboundTracking && (
                  <a href={`https://www.ups.com/track?tracknum=${outboundTracking}`} target="_blank" rel="noopener noreferrer"
                    className="block w-full px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium text-center">üìç Suivre colis UPS</a>
                )}
              </div>
            </div>

            {/* Signature Card */}
            {bcSignatureUrl && (
              <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                <div className="bg-green-500 px-4 py-3">
                  <h3 className="font-bold text-white">‚úçÔ∏è Signature</h3>
                </div>
                <div className="p-4">
                  <img src={bcSignatureUrl} alt="Signature" className="max-h-20 mx-auto bg-gray-50 rounded p-2 border" />
                  <p className="text-center text-sm text-gray-500 mt-2">
                    {rental.bc_signed_by || '‚Äî'} {rental.bc_signature_date && `‚Ä¢ ${new Date(rental.bc_signature_date).toLocaleDateString('fr-FR')}`}
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
      {showBCReview && <RentalBCReviewModal rental={rental} onClose={() => { setShowBCReview(false); reload(); }} notify={notify} reload={reload} lang={lang} />}
    </div>
  );
}
